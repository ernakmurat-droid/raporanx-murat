<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RaporanX â€¢ Admin</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>
  <script src="wallet.js"></script>

  <style>
    body{font-family:Arial;background:#0f172a;color:#e5e7eb;margin:0;padding:20px}
    .card{background:#111827;padding:15px;border-radius:14px;margin-bottom:12px}
    .btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .ok{background:#22c55e}
    .warn{background:#f59e0b}
  </style>
</head>

<body>

<h2>ðŸ”§ Admin Panel</h2>
<div id="me">GiriÅŸ bekleniyorâ€¦</div>

<div id="orders"></div>

<script>
const auth = firebase.auth();
const db = firebase.firestore();

const ADMIN_EMAIL = "ernakmurat@gmail.com";

auth.onAuthStateChanged(async user=>{
  if(!user){
    document.getElementById("me").innerHTML = "GiriÅŸ yapmalÄ±sÄ±n.";
    return;
  }

  if(user.email !== ADMIN_EMAIL){
    document.getElementById("me").innerHTML = "â›” Admin deÄŸilsin";
    return;
  }

  document.getElementById("me").innerHTML = "Admin: " + user.email;
  listenOrders();
});

function listenOrders(){
  db.collectionGroup("orders").orderBy("createdAt","desc")
    .onSnapshot(snap=>{
      const el = document.getElementById("orders");
      el.innerHTML = "";

      snap.forEach(doc=>{
        const o = doc.data();
        const uid = doc.ref.parent.parent.id;

        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
          <b>${o.packTitle}</b><br>
          KullanÄ±cÄ±: ${o.userEmail}<br>
          Durum: ${o.status}<br>
          <button class="btn warn" onclick="addLink('${uid}','${o.orderId}')">Link Ekle</button>
          <button class="btn ok" onclick="approve('${uid}','${o.orderId}')">Onayla</button>
        `;
        el.appendChild(div);
      });
    });
}

window.addLink = async (uid, orderId)=>{
  const link = prompt("Ã–deme linki:");
  if(!link) return;
  await Wallet.setPaymentLink(uid, orderId, link);
  alert("Link eklendi");
};

window.approve = async (uid, orderId)=>{
  await Wallet.approveOrder(uid, orderId);
  alert("OnaylandÄ±");
};
</script>

</body>
</html>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');

  // ANAYASA: YANLIŞ YAZIMLARI TEMİZLE VE STANDART ANAHTARI KULLAN
  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  let report = reports[id] || {};
  document.getElementById('propertyName').textContent = report.propertyName || "İsimsiz";

  const fieldsToRemember = [
    'belediye', 'il', 'ilce', 'projeTarihiText',
    'denetimFirma', 'yikimAciklamaInput', 'uyumAciklama',
    'arsivAda', 'arsivParsel'
  ];

  document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && (e.key === 'c' || e.key === 'p' || e.key === 's' || e.key === 'u')) {
      e.preventDefault();
    }
  });

  function uid(prefix="x") {
    return prefix + "-" + Date.now().toString(36) + "-" + Math.random().toString(36).slice(2,8);
  }

  function checkBila() {
    const textVal = document.getElementById('projeTarihiText').value.toLowerCase();
    const dateInput = document.getElementById('projeTarihi');
    if (textVal.includes('bila')) {
      dateInput.disabled = true;
      dateInput.value = '';
    } else {
      dateInput.disabled = false;
    }
  }

  function toggleFarkliParsel() {
    const evet = document.querySelector('input[name="farkliParsel"]:checked').value === "evet";
    document.getElementById('farkliParselDetay').style.display = evet ? 'flex' : 'none';
  }

  function showList(input) {
    input.setAttribute('autocomplete', 'off');
    input.select();
    const val = input.value;
    input.value = '';
    setTimeout(() => { input.value = val; }, 1);
  }

  function formatBelediye(name) {
    if (!name) return "[Belediye]";
    name = name.trim();
    const low = name.toLowerCase();
    if (low.includes('belediyesi') || low.includes('belediye')) return name;
    return name + ' Belediyesi';
  }

  // ✅ FIX: index bazlı radio yerine unique id (silince kayma bitiyor)
  function addRuhsat(data = {}) {
    const list = document.getElementById('ruhsatList');
    const rid = data._rid || uid("rk");

    const item = document.createElement('div');
    item.className = 'dynamic-item';
    item.dataset.rid = rid;

    const kapsamType = data.kapsam_type === 'kismi' ? 'kismi' : 'tam';

    item.innerHTML = `
      <div><strong>Tarih</strong><input type="date" class="r-tarih" value="${data.tarih_raw || ''}"></div>
      <div><strong>No</strong><input type="text" class="r-no" value="${data.no || ''}"></div>
      <div><strong>Amacı</strong><input type="text" class="r-amac" value="${data.amac || ''}"></div>

      <div><strong>Kapsam</strong><br>
        <label><input type="radio" name="${rid}" value="tam" ${kapsamType === 'tam' ? 'checked' : ''}> Tam</label>
        <label><input type="radio" name="${rid}" value="kismi" ${kapsamType === 'kismi' ? 'checked' : ''}> Kısmi</label>
      </div>

      <div class="kismi-box" style="display:${kapsamType === 'kismi' ? 'block' : 'none'}; width:100%;">
        <input type="text" class="r-kismi" placeholder="Kısmi açıklama..." value="${data.kismi_text || ''}">
      </div>

      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
    `;

    list.appendChild(item);

    item.querySelectorAll(`input[type="radio"][name="${rid}"]`).forEach(r => {
      r.onchange = () => {
        const secim = item.querySelector(`input[name="${rid}"]:checked`)?.value;
        item.querySelector('.kismi-box').style.display = (secim === 'kismi') ? 'block' : 'none';
      };
    });
  }

  function addIskan(data = {}) {
    const list = document.getElementById('iskanList');
    const iid = data._iid || uid("ik");

    const item = document.createElement('div');
    item.className = 'dynamic-item';
    item.dataset.iid = iid;

    const kapsamType = data.kapsam_type === 'kismi' ? 'kismi' : 'tam';

    item.innerHTML = `
      <div><strong>Tarih</strong><input type="date" class="i-tarih" value="${data.tarih_raw || ''}"></div>
      <div><strong>No</strong><input type="text" class="i-no" value="${data.no || ''}"></div>
      <div><strong>Amacı</strong><input type="text" class="i-amac" value="${data.amac || 'Yapı Kullanma İzin Belgesi'}"></div>

      <div><strong>Kapsam</strong><br>
        <label><input type="radio" name="${iid}" value="tam" ${kapsamType === 'tam' ? 'checked' : ''}> Tam</label>
        <label><input type="radio" name="${iid}" value="kismi" ${kapsamType === 'kismi' ? 'checked' : ''}> Kısmi</label>
      </div>

      <div class="kismi-box" style="display:${kapsamType === 'kismi' ? 'block' : 'none'}; width:100%;">
        <input type="text" class="i-kismi" placeholder="Kısmi açıklama..." value="${data.kismi_text || ''}">
      </div>

      <button type="button" class="remove-btn" onclick="this.parentElement.remove()">X</button>
    `;

    list.appendChild(item);

    item.querySelectorAll(`input[type="radio"][name="${iid}"]`).forEach(r => {
      r.onchange = () => {
        const secim = item.querySelector(`input[name="${iid}"]:checked`)?.value;
        item.querySelector('.kismi-box').style.display = (secim === 'kismi') ? 'block' : 'none';
      };
    });
  }

  document.querySelectorAll('input[name="iskanVar"]').forEach(r => r.onchange = () => {
    const iskanVar = r.value === 'evet';
    document.getElementById('iskanSection').style.display = iskanVar ? 'block' : 'none';
    document.getElementById('yapiDenetimSection').style.display = iskanVar ? 'none' : 'block';
    if (iskanVar && document.getElementById('iskanList').children.length === 0) addIskan();
  });

  document.querySelectorAll('input[name="denetimDevam"]').forEach(r => r.onchange = () => {
    document.getElementById('denetimEvet').style.display = r.value === 'evet' ? 'block' : 'none';
  });

  document.querySelectorAll('input[name="yikim"]').forEach(r => r.onchange = () => {
    document.getElementById('yikimAciklamaInput').style.display = r.value === 'evet' ? 'block' : 'none';
  });

  document.querySelectorAll('input[name="uyum"]').forEach(r => r.onchange = () => {
    document.getElementById('uyumAciklama').style.display = (r.value === 'hayir' || r.value === 'kismen') ? 'block' : 'none';
  });

  function initAutocomplete() {
    fieldsToRemember.forEach(fid => {
      let h = JSON.parse(localStorage.getItem('h_belgeler_' + fid)) || [];
      const dl = document.getElementById('h_belgeler_' + fid);
      if (dl) dl.innerHTML = h.map(val => `<option value="${val}">`).join('');
    });
  }

  function kaydetVeIsle() {
    const bRaw = document.getElementById('belediye').value;
    const belediyeFormatted = formatBelediye(bRaw);

    const il = document.getElementById('il').value || "...";
    const ilce = document.getElementById('ilce').value || "...";

    const farkliParsel = document.querySelector('input[name="farkliParsel"]:checked').value === "evet";
    const aAda = document.getElementById('arsivAda').value;
    const aParsel = document.getElementById('arsivParsel').value;

    const pTarInput = document.getElementById('projeTarihi').value;
    const pTarText = document.getElementById('projeTarihiText').value;
    const pTar = (pTarText.toLowerCase().includes('bila'))
      ? pTarText
      : (pTarInput ? new Date(pTarInput).toLocaleDateString('tr-TR') : (pTarText || "..."));

    const uyum = document.querySelector('input[name="uyum"]:checked').value;
    const teyit = document.querySelector('input[name="belgeGoruldumu"]:checked').value;

    // ✅ FIX: index kayması yok — dataset.rid ile okunuyor
    const ruhsatlar = Array.from(document.querySelectorAll('#ruhsatList .dynamic-item')).map((el) => {
      const rid = el.dataset.rid;
      const kapsamType = el.querySelector(`input[name="${rid}"]:checked`)?.value || 'tam';
      const kismiText = (el.querySelector('.r-kismi')?.value || '').trim();

      return {
        _rid: rid,
        tarih_raw: el.querySelector('.r-tarih')?.value || '',
        tarih: el.querySelector('.r-tarih')?.value ? new Date(el.querySelector('.r-tarih').value).toLocaleDateString('tr-TR') : '...',
        no: el.querySelector('.r-no')?.value || '...',
        amac: el.querySelector('.r-amac')?.value || '...',
        kapsam_type: kapsamType,
        kismi_text: kismiText,
        kapsam: (kapsamType === 'tam') ? 'binanın tamı için' : (kismiText || '...')
      };
    });

    const iskanVar = document.querySelector('input[name="iskanVar"]:checked')?.value === 'evet';

    const iskanlar = iskanVar
      ? Array.from(document.querySelectorAll('#iskanList .dynamic-item')).map((el) => {
          const iid = el.dataset.iid;
          const kapsamType = el.querySelector(`input[name="${iid}"]:checked`)?.value || 'tam';
          const kismiText = (el.querySelector('.i-kismi')?.value || '').trim();

          return {
            _iid: iid,
            tarih_raw: el.querySelector('.i-tarih')?.value || '',
            tarih: el.querySelector('.i-tarih')?.value ? new Date(el.querySelector('.i-tarih').value).toLocaleDateString('tr-TR') : '...',
            no: el.querySelector('.i-no')?.value || '...',
            amac: el.querySelector('.i-amac')?.value || '...',
            kapsam_type: kapsamType,
            kismi_text: kismiText,
            kapsam: (kapsamType === 'tam') ? 'binanın tamı için' : (kismiText || '...')
          };
        })
      : [];

    const anaAda = report.ada || "...";
    const anaParsel = report.parsel || "...";

    let anaMetin = `Taşınmazın bulunduğu ana taşınmazın konumu imar paftasıyla uyumludur. `;

    if (farkliParsel && aAda && aParsel) {
      anaMetin += `Taşınmazın projesi ve belgeleri, tescilli olduğu ${anaAda} ada ${anaParsel} parselden farklı olarak, ${aAda} ada ${aParsel} parsel üzerinden incelenmiştir. `;
    }

    anaMetin += `${il}/${ilce} Tapu Müdürlüğü ve ${belediyeFormatted}'nde incelenen ${pTar} tarihli projesiyle ${
      uyum === 'evet' ? 'uyumludur' : (uyum === 'hayir' ? 'uyumlu değildir' : 'kısmen uyumludur')
    }. `;

    if (uyum !== 'evet') anaMetin += (document.getElementById('uyumAciklama').value || '') + " ";

    let belgeCumleleri = [];
    ruhsatlar.forEach(r => belgeCumleleri.push(`${r.tarih} tarih ${r.no} sayılı ${r.kapsam} düzenlenmiş ${r.amac} yapı ruhsatı`));
    if (iskanVar) iskanlar.forEach(i => belgeCumleleri.push(`${i.tarih} tarih ${i.no} sayılı ${i.kapsam} düzenlenmiş ${i.amac}`));

    if (belgeCumleleri.length > 0) {
      anaMetin += "Yapı için; " + belgeCumleleri.join(", ") + " " + teyit + ". ";
    }

    if (!iskanVar) {
      anaMetin += "Taşınmazın Yapı Kullanma İzin Belgesi (İskân) bulunmamaktadır. ";
      const denetimDevam = document.querySelector('input[name="denetimDevam"]:checked')?.value === 'evet';
      if (denetimDevam) {
        const firma = document.getElementById('denetimFirma').value || "...";
        const oran = document.getElementById('bitmislikOrani').value || "...";
        anaMetin += `Yapının yapı denetimi ${firma} şirketi tarafından yapı denetime devam edildiği bitmişlik oranının %${oran} olduğu ilgili belediyesinden öğrenilmiştir. `;
      }
    }

    const yikimVar = document.querySelector('input[name="yikim"]:checked').value === 'evet';
    anaMetin += yikimVar
      ? `Belediyesinde ${document.getElementById('yikimAciklamaInput').value} olumsuz karar ve tespit tutanağı olduğu görülmüştür.`
      : "Belediye arşivinde herhangi bir olumsuz karar ve tespit tutanağına rastlanmamıştır.";

    if (farkliParsel && aAda && aParsel) {
      anaMetin += ` Taşınmaz belgeleri ${aAda} ada ${aParsel} parsel için düzenlenmiştir.`;
    }

    let altListe = "\n\nBELGE ÖZETLERİ:\n";
    if (belgeCumleleri.length > 0) {
      altListe += belgeCumleleri.map(c => "- " + c.charAt(0).toUpperCase() + c.slice(1)).join(".\n") + ".";
    }

    const finalMetin = anaMetin + altListe;

    document.getElementById('taslak').innerText = finalMetin;
    document.getElementById('taslak').style.display = 'block';

    // ✅ KAYIT (uyumluluk: hem ham hem formatted + eski anahtarlar)
    report.belgeler = {
      belediye: bRaw,
      belediyeFormatted: belediyeFormatted,

      il: document.getElementById('il').value,
      ilce: document.getElementById('ilce').value,

      farkliParsel: farkliParsel ? 'evet' : 'hayir',
      arsivAda: aAda,
      arsivParsel: aParsel,

      projeTarihi: pTarInput,
      projeTarihiText: pTarText,

      uyum: uyum,
      uyumAciklama: document.getElementById('uyumAciklama').value,

      ruhsatlar: ruhsatlar,

      iskanVar: iskanVar,
      iskanlar: iskanlar,

      denetimDevam: document.querySelector('input[name="denetimDevam"]:checked')?.value,
      denetimFirma: document.getElementById('denetimFirma').value,
      bitmislikOrani: document.getElementById('bitmislikOrani').value,

      teyit: teyit,

      yikim: yikimVar ? 'evet' : 'hayir',
      yikimAciklama: document.getElementById('yikimAciklamaInput').value,

      belgelerMetni: finalMetin
    };

    // Eski anahtarı da destekle (Geriye dönük uyumluluk)
    report.belgelerMetni = finalMetin;

    fieldsToRemember.forEach(fid => {
      const el = document.getElementById(fid);
      if (el) {
        const val = el.value.trim();
        if (val) {
          let h = JSON.parse(localStorage.getItem('h_belgeler_' + fid)) || [];
          if (!h.includes(val)) {
            h.unshift(val);
            localStorage.setItem('h_belgeler_' + fid, JSON.stringify(h.slice(0, 20)));
          }
        }
      }
    });

    reports[id] = report;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    alert("✅ Veriler başarıyla kaydedildi!");
    initAutocomplete();
  }

  function anaMenuyeDon() {
    window.location.href = `rapor-detay.html?id=${id}`;
  }

  window.onload = () => {
    initAutocomplete();

    if (report.belgeler) {
      const b = report.belgeler;

      // belediye: formatted varsa onu göster, yoksa ham
      document.getElementById('belediye').value = b.belediyeFormatted || b.belediye || "";

      document.getElementById('il').value = b.il || "";
      document.getElementById('ilce').value = b.ilce || "";

      if (b.farkliParsel === 'evet') {
        document.querySelector('input[name="farkliParsel"][value="evet"]').checked = true;
        toggleFarkliParsel();
        document.getElementById('arsivAda').value = b.arsivAda || "";
        document.getElementById('arsivParsel').value = b.arsivParsel || "";
      }

      document.getElementById('projeTarihi').value = b.projeTarihi || "";
      document.getElementById('projeTarihiText').value = b.projeTarihiText || "";
      checkBila();

      if (b.uyum) {
        document.querySelector(`input[name="uyum"][value="${b.uyum}"]`).checked = true;
        if (b.uyum !== 'evet') {
          document.getElementById('uyumAciklama').style.display = 'block';
          document.getElementById('uyumAciklama').value = b.uyumAciklama || "";
        }
      }

      if (b.ruhsatlar && b.ruhsatlar.length > 0) {
        b.ruhsatlar.forEach(r => addRuhsat(r));
      } else {
        addRuhsat();
      }

      if (b.iskanVar) {
        document.querySelector('input[name="iskanVar"][value="evet"]').checked = true;
        document.getElementById('iskanSection').style.display = 'block';
        document.getElementById('yapiDenetimSection').style.display = 'none';

        if (b.iskanlar && b.iskanlar.length > 0) {
          b.iskanlar.forEach(i => addIskan(i));
        } else {
          addIskan();
        }
      }

      if (b.denetimDevam) {
        document.querySelector(`input[name="denetimDevam"][value="${b.denetimDevam}"]`).checked = true;
        if (b.denetimDevam === 'evet') {
          document.getElementById('denetimEvet').style.display = 'block';
          document.getElementById('denetimFirma').value = b.denetimFirma || "";
          document.getElementById('bitmislikOrani').value = b.bitmislikOrani || "";
        }
      }

      if (b.teyit) {
        document.querySelector(`input[name="belgeGoruldumu"][value="${b.teyit}"]`).checked = true;
      }

      if (b.yikim === 'evet') {
        document.querySelector('input[name="yikim"][value="evet"]').checked = true;
        document.getElementById('yikimAciklamaInput').style.display = 'block';
        document.getElementById('yikimAciklamaInput').value = b.yikimAciklama || "";
      }

    } else {
      addRuhsat();
    }
  };
</script>

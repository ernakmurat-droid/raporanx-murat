<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İncelenen Belgeler</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding-bottom:100px; }
        .header { background:linear-gradient(135deg,#4a148c,#7c4dff); color:white; padding:20px; text-align:center; position:relative; }
        .back { position:absolute; left:15px; top:18px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; color:white; text-decoration:none; font-weight:bold; }
        .property-name { font-size:18px; margin-top:8px; opacity:0.9; }
        .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin:25px 0; padding:20px; background:#f9f9f9; border-radius:12px; }
        .radio-group { display:flex; gap:20px; flex-wrap:wrap; margin:10px 0; }
        input[type=text], input[type=date], input[type=number], textarea { padding:12px; width:100%; border:1px solid #ccc; border-radius:8px; font-size:16px; box-sizing:border-box; }
        .dynamic-item { display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap; background:#fff; padding:15px; border-radius:8px; border:1px solid #eee; }
        .dynamic-item > div { flex:1; min-width:180px; }
        .remove-btn { background:#d32f2f; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
        .add-btn { background:#2196f3; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; }
        .btn { background:#00c853; color:white; padding:16px; width:100%; border:none; border-radius:12px; font-size:20px; font-weight:bold; cursor:pointer; margin-top:20px; }
        .btn-taslak { background:#2196f3; margin-bottom:10px; }
        .taslak { background:#e8f5e9; padding:30px; border-radius:12px; margin-top:30px; border:3px solid #4caf50; font-size:19px; line-height:1.8; white-space:pre-wrap; user-select:text; }
        .kopyalanabilir { background:#e3f2fd; padding:20px; border-radius:12px; margin:30px 0; border:2px dashed #1976d2; font-family: monospace; font-size:16px; line-height:1.8; user-select:all; }
        .kopyala-buton { background:#1976d2; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:10px; }
        .conditional { display:none; margin-top:15px; padding:15px; background:#fff; border:1px solid #ddd; border-radius:8px; }
        .inline-input { display:inline-block; width:200px; margin-left:10px; }

        /* Kopyala-Yapıştır Kontrolü - YENİ EKLENEN KISIM */
        /* Veri girişi alanlarında serbest */
        input, textarea, select, .radio-group, .dynamic-item {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        /* Otomatik taslak metninde kopyalama yasak */
        .taslak {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            pointer-events: none !important;
        }
        /* Kopyalanabilir tablo serbest (butonla kopyalansın) */
        .kopyalanabilir {
            -webkit-user-select: all !important;
            user-select: all !important;
        }
    </style>
</head>
<body>

<div class="header">
    <a href="#" onclick="history.back()" class="back">← Geri</a>
    <h1>İNCELENEN BELGELER</h1>
    <div id="propertyName" class="property-name">Yükleniyor...</div>
</div>

<div class="container">
    <div class="form-group">
        <strong>1. Taşınmazın Bağlı Olduğu Belediye</strong>
        <input type="text" id="belediye" placeholder="Örn: Kadıköy (otomatik 'Belediyesi' eklenir)">
    </div>

    <div class="form-group">
        <strong>2. İli</strong>
        <input type="text" id="il" placeholder="Örn: İstanbul">
        <strong>3. İlçesi</strong>
        <input type="text" id="ilce" placeholder="Örn: Kadıköy">
    </div>

    <div class="form-group">
        <strong>4. Taşınmaz Proje Tarihi</strong>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="date" id="projeTarihi">
            <input type="text" id="projeTarihiText" class="inline-input" placeholder="Bila / Tarihsiz">
        </div>
        <small>Tarih yoksa yan tarafa yazın</small>
    </div>

    <div class="form-group">
        <strong>5. Proje ile uyumlumu?</strong>
        <div class="radio-group">
            <label><input type="radio" name="uyum" value="evet"> Evet</label>
            <label><input type="radio" name="uyum" value="hayir"> Hayır</label>
            <label><input type="radio" name="uyum" value="kismen"> Kısmen</label>
        </div>
    </div>

    <!-- Ruhsatlar -->
    <div class="form-group">
        <strong>Yapı Ruhsatları</strong>
        <div id="ruhsatList"></div>
        <button type="button" class="add-btn" onclick="addRuhsat()">+ Yeni Ruhsat Ekle</button>
    </div>

    <!-- İskân Var mı? -->
    <div class="form-group">
        <strong>İskân Var mı?</strong>
        <div class="radio-group">
            <label><input type="radio" name="iskanVar" value="evet"> Evet</label>
            <label><input type="radio" name="iskanVar" value="hayir"> Hayır</label>
        </div>
    </div>

    <div id="iskanSection" style="display:none;">
        <div class="form-group">
            <strong>Yapı Kullanma İzin Belgeleri (İskân)</strong>
            <div id="iskanList"></div>
            <button type="button" class="add-btn" onclick="addIskan()">+ Yeni İskân Ekle</button>
        </div>
    </div>

    <!-- Yapı Denetim (sadece iskân yoksa) -->
    <div class="form-group" id="yapiDenetimSection" style="display:none;">
        <strong>Yapı denetim firması denetime devam ediyor mu?</strong>
        <div class="radio-group">
            <label><input type="radio" name="denetimDevam" value="evet"> Evet</label>
            <label><input type="radio" name="denetimDevam" value="hayir"> Hayır</label>
        </div>
        <div id="denetimEvet" class="conditional" style="display:none;">
            <strong>14. Yapı Denetim Firması Adı</strong>
            <input type="text" id="denetimFirma">
            <strong>15. Bitmişlik Oranı (%)</strong>
            <input type="number" id="bitmislikOrani" min="0" max="100">
        </div>
    </div>

    <div class="form-group">
        <strong>12. Taşınmaz belgeler görüldü mü?</strong>
        <div class="radio-group">
            <label><input type="radio" name="belgeGoruldumu" value="Görüldü"> Görüldü</label>
            <label><input type="radio" name="belgeGoruldumu" value="İncelendi"> İncelendi</label>
            <label><input type="radio" name="belgeGoruldumu" value="Elektronik ortamda teyit edildi"> Elektronik ortamda teyit edildi</label>
        </div>
    </div>

    <div class="form-group">
        <strong>Belediyesinde olumsuz karar veya yıkım kararı var mı?</strong>
        <div class="radio-group">
            <label><input type="radio" name="yikimKarari" value="hayir"> Hayır</label>
            <label><input type="radio" name="yikimKarari" value="evet"> Evet</label>
        </div>
        <div id="yikimAciklama" class="conditional" style="display:none;">
            <textarea id="yikimAciklamaText" rows="3" placeholder="Karar türünü yazın (örn: yıkım, para cezası)"></textarea>
            <small>Yukarıya yazdığınız metin otomatik "... hakkında [yazdığınız] kararı vardır." şeklinde eklenecek.</small>
        </div>
    </div>

    <div class="form-group">
        <strong>Belgeler eski ada/parsel üzerine mi düzenlenmiş?</strong>
        <div class="radio-group">
            <label><input type="radio" name="eskiParsel" value="hayir"> Hayır</label>
            <label><input type="radio" name="eskiParsel" value="evet"> Evet</label>
        </div>
        <div id="eskiParselSection" class="conditional" style="display:none;">
            <strong>16. Eski Ada No</strong>
            <input type="number" id="eskiAda">
            <strong>17. Eski Parsel No</strong>
            <input type="number" id="eskiParsel">
        </div>
    </div>

    <button class="btn btn-taslak" onclick="taslakOlustur()">OTOMATİK METİN + KOPYALANABİLİR TABLO OLUŞTUR</button>
    <button class="btn" onclick="kaydet()">KAYDET VE ANA MENÜYE DÖN</button>

    <!-- KOPYALANABİLİR TABLO -->
    <div id="kopyaTablo" class="kopyalanabilir" style="display:none;">
        <strong>Banka / Ekspertiz Raporuna Yapıştırmak İçin:</strong><br>
        <div id="kopyaIcerik"></div>
        <button class="kopyala-buton" onclick="kopyalaMetin()">TÜMÜNÜ KOPYALA</button>
    </div>

    <!-- RAPOR METNİ -->
    <div id="taslak" class="taslak">
        Bilgileri doldurun → "OTOMATİK METİN + KOPYALANABİLİR TABLO OLUŞTUR" butonuna basın...
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const report = reports[id] || {};
    const belgeler = report.belgeler || {};

    document.getElementById('propertyName').textContent = report.propertyName || "İsimsiz Gayrimenkul";

    // Belediye otomatik "Belediyesi"
    function formatBelediye(name) {
        if (!name) return "[Belediye]";
        name = name.trim();
        if (name.toLowerCase().includes('belediyesi') || name.toLowerCase().includes('belediye')) return name;
        return name + ' Belediyesi';
    }

    // Yükleme
    document.getElementById('belediye').value = belgeler.belediyeRaw || '';
    document.getElementById('il').value = belgeler.il || '';
    document.getElementById('ilce').value = belgeler.ilce || '';
    document.getElementById('projeTarihi').value = belgeler.projeTarihi || '';
    document.getElementById('projeTarihiText').value = belgeler.projeTarihiText || '';
    if (belgeler.uyum) document.querySelector(`input[name="uyum"][value="${belgeler.uyum}"]`).checked = true;
    if (belgeler.belgeGoruldumu) document.querySelector(`input[name="belgeGoruldumu"][value="${belgeler.belgeGoruldumu}"]`).checked = true;
    if (belgeler.yikimKarari) document.querySelector(`input[name="yikimKarari"][value="${belgeler.yikimKarari}"]`).checked = true;
    if (belgeler.yikimAciklamaText) document.getElementById('yikimAciklamaText').value = belgeler.yikimAciklamaText;
    if (belgeler.yikimKarari === 'evet') document.getElementById('yikimAciklama').style.display = 'block';
    if (belgeler.denetimDevam) document.querySelector(`input[name="denetimDevam"][value="${belgeler.denetimDevam}"]`).checked = true;
    if (belgeler.denetimDevam === 'evet') document.getElementById('denetimEvet').style.display = 'block';
    document.getElementById('denetimFirma').value = belgeler.denetimFirma || '';
    document.getElementById('bitmislikOrani').value = belgeler.bitmislikOrani || '';
    if (belgeler.eskiParsel === 'evet') {
        document.querySelector('input[name="eskiParsel"][value="evet"]').checked = true;
        document.getElementById('eskiParselSection').style.display = 'block';
    }
    document.getElementById('eskiAda').value = belgeler.eskiAda || '';
    document.getElementById('eskiParsel').value = belgeler.eskiParsel || '';

    // İskân kontrolü
    const iskanVar = belgeler.iskanVar === 'evet';
    if (iskanVar) {
        document.querySelector('input[name="iskanVar"][value="evet"]').checked = true;
        document.getElementById('iskanSection').style.display = 'block';
        document.getElementById('yapiDenetimSection').style.display = 'none';
    } else {
        document.querySelector('input[name="iskanVar"][value="hayir"]').checked = true;
        document.getElementById('yapiDenetimSection').style.display = 'block';
    }

    // Ruhsat ve İskân yükleme
    if (belgeler.ruhsatlar && belgeler.ruhsatlar.length > 0) {
        belgeler.ruhsatlar.forEach(r => addRuhsat(r));
    } else {
        addRuhsat();
    }
    if (iskanVar && belgeler.iskanlar && belgeler.iskanlar.length > 0) {
        belgeler.iskanlar.forEach(i => addIskan(i));
    } else if (iskanVar) {
        addIskan();
    }

    function addRuhsat(data = {}) {
        const list = document.getElementById('ruhsatList');
        const index = list.children.length;
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        item.innerHTML = `
            <div><strong>Tarih</strong><input type="date" class="ruhsat-tarih" value="${data.tarih || ''}"></div>
            <div><strong>Ruhsat No</strong><input type="text" class="ruhsat-no" value="${data.no || ''}"></div>
            <div><strong>Veriliş Amacı</strong><input type="text" class="ruhsat-aciklama" placeholder="Yeni yapı, Tadilat vs." value="${data.aciklama || ''}"></div>
            <div><strong>Kapsam</strong><br>
                <label><input type="radio" name="kapsam-ruhsat-${index}" value="tamami" ${data.kapsam !== 'kismi' ? 'checked' : ''}> Tamamı</label>
                <label><input type="radio" name="kapsam-ruhsat-${index}" value="kismi" ${data.kapsam === 'kismi' ? 'checked' : ''}> Kısmi</label>
            </div>
            <div class="conditional" style="display:${data.kapsam === 'kismi' ? 'block' : 'none'};">
                <strong>Kapsadığı Hacimler</strong><input type="text" class="ruhsat-kismi" value="${data.kismi || ''}">
            </div>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Sil</button>
        `;
        list.appendChild(item);
        item.querySelectorAll('input[type="radio"]').forEach(r => r.onchange = () => {
            item.querySelector('.conditional').style.display = r.value === 'kismi' ? 'block' : 'none';
        });
    }

    function addIskan(data = {}) {
        const list = document.getElementById('iskanList');
        const index = list.children.length;
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        item.innerHTML = `
            <div><strong>Tarih</strong><input type="date" class="iskan-tarih" value="${data.tarih || ''}"></div>
            <div><strong>İskân No</strong><input type="text" class="iskan-no" value="${data.no || ''}"></div>
            <div><strong>Veriliş Amacı</strong><input type="text" class="iskan-aciklama" placeholder="Yeni yapı, Tadilat vs." value="${data.aciklama || ''}"></div>
            <div><strong>Kapsam</strong><br>
                <label><input type="radio" name="kapsam-iskan-${index}" value="tamami" ${data.kapsam !== 'kismi' ? 'checked' : ''}> Tamamı</label>
                <label><input type="radio" name="kapsam-iskan-${index}" value="kismi" ${data.kapsam === 'kismi' ? 'checked' : ''}> Kısmi</label>
            </div>
            <div class="conditional" style="display:${data.kapsam === 'kismi' ? 'block' : 'none'};">
                <strong>Kapsadığı Hacimler</strong><input type="text" class="iskan-kismi" value="${data.kismi || ''}"></div>
            </div>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Sil</button>
        `;
        list.appendChild(item);
        item.querySelectorAll('input[type="radio"]').forEach(r => r.onchange = () => {
            item.querySelector('.conditional').style.display = r.value === 'kismi' ? 'block' : 'none';
        });
    }

    // Toggle'lar
    document.querySelectorAll('input[name="iskanVar"]').forEach(r => r.addEventListener('change', () => {
        const show = r.value === 'evet';
        document.getElementById('iskanSection').style.display = show ? 'block' : 'none';
        document.getElementById('yapiDenetimSection').style.display = show ? 'none' : 'block';
        if (show && document.getElementById('iskanList').children.length === 0) addIskan();
    }));

    document.querySelectorAll('input[name="denetimDevam"]').forEach(r => r.addEventListener('change', () => {
        document.getElementById('denetimEvet').style.display = r.value === 'evet' ? 'block' : 'none';
    }));

    document.querySelectorAll('input[name="yikimKarari"]').forEach(r => r.addEventListener('change', () => {
        document.getElementById('yikimAciklama').style.display = r.value === 'evet' ? 'block' : 'none';
    }));

    document.querySelectorAll('input[name="eskiParsel"]').forEach(r => r.addEventListener('change', () => {
        document.getElementById('eskiParselSection').style.display = r.value === 'evet' ? 'block' : 'none';
    }));

    function taslakOlustur() {
        const belediyeRaw = document.getElementById('belediye').value.trim();
        const belediye = formatBelediye(belediyeRaw);
        const il = document.getElementById('il').value.trim() || "[İl]";
        const ilce = document.getElementById('ilce').value.trim() || "[İlçe]";
        const projeTarihi = document.getElementById('projeTarihi').value;
        const projeTarihiText = document.getElementById('projeTarihiText').value.trim();
        const projeTarihiFmt = projeTarihi ? new Date(projeTarihi).toLocaleDateString('tr-TR') : (projeTarihiText || "[tarih]");

        const uyum = document.querySelector('input[name="uyum"]:checked')?.value || '';
        const uyumText = uyum === 'evet' ? 'uyumludur' : uyum === 'hayir' ? 'uyumlu değildir' : uyum === 'kismen' ? 'kısmen uyumludur' : '[uyum durumu]';

        // Ruhsatlar - Veriliş amacı eklendi
        const ruhsatlar = Array.from(document.querySelectorAll('#ruhsatList .dynamic-item')).map(item => ({
            tarih: item.querySelector('.ruhsat-tarih').value,
            no: item.querySelector('.ruhsat-no').value.trim(),
            aciklama: item.querySelector('.ruhsat-aciklama').value.trim() || 'belirtilmemiş',
            kapsam: item.querySelector('input[name^="kapsam-ruhsat"]:checked')?.value || 'tamami',
            kismi: item.querySelector('.ruhsat-kismi')?.value.trim() || ''
        }));
        const ruhsatText = ruhsatlar.map(r => {
            const kapsamText = r.kapsam === 'tamami' ? 'taşınmazın tamamı için' : r.kismi;
            const tarihFmt = r.tarih ? new Date(r.tarih).toLocaleDateString('tr-TR') : '[tarih]';
            return `${tarihFmt} tarih ve ${r.no || '[no]'} sayılı ${r.aciklama} için ${kapsamText} düzenlenmiş yapı ruhsatı`;
        }).join(', ');

        // İskân - Veriliş amacı eklendi
        const iskanVar = document.querySelector('input[name="iskanVar"]:checked')?.value === 'evet';
        let iskanText = '';
        if (iskanVar) {
            const iskanlar = Array.from(document.querySelectorAll('#iskanList .dynamic-item')).map(item => ({
                tarih: item.querySelector('.iskan-tarih').value,
                no: item.querySelector('.iskan-no').value.trim(),
                aciklama: item.querySelector('.iskan-aciklama').value.trim() || 'belirtilmemiş',
                kapsam: item.querySelector('input[name^="kapsam-iskan"]:checked')?.value || 'tamami',
                kismi: item.querySelector('.iskan-kismi')?.value.trim() || ''
            }));
            iskanText = iskanlar.map(i => {
                const kapsamText = i.kapsam === 'tamami' ? 'taşınmazın tamamı için' : i.kismi;
                const tarihFmt = i.tarih ? new Date(i.tarih).toLocaleDateString('tr-TR') : '[tarih]';
                return `${tarihFmt} tarih ve ${i.no || '[no]'} sayılı ${i.aciklama} için ${kapsamText} düzenlenmiş yapı kullanma izin belgesi`;
            }).join(', ');
        }

        const belgeGoruldumu = document.querySelector('input[name="belgeGoruldumu"]:checked')?.value || '[belge durumu]';

        const yikimKarari = document.querySelector('input[name="yikimKarari"]:checked')?.value;
        let yikimText = 'herhangi olumsuz bir tespit tutanak/yıkım kararının olmadığı tespit edilmiştir';
        if (yikimKarari === 'evet') {
            const aciklama = document.getElementById('yikimAciklamaText').value.trim() || '[karar türü]';
            yikimText = `${aciklama} kararı vardır`;
        }

        let denetimText = '';
        if (!iskanVar) {
            const denetimDevam = document.querySelector('input[name="denetimDevam"]:checked')?.value;
            if (denetimDevam === 'evet') {
                const firma = document.getElementById('denetimFirma').value.trim() || '[firma adı]';
                const oran = document.getElementById('bitmislikOrani').value || '[oran]';
                denetimText = `${firma} Yapı denetim firmasının denetime devam ettiği ${oran}% bitmişlik oranında olduğu öğrenilmiştir.`;
            } else if (denetimDevam === 'hayir') {
                denetimText = 'yapı denetim firması denetimden ayrılmıştır.';
            }
        }

        const eskiParselVar = document.querySelector('input[name="eskiParsel"]:checked')?.value === 'evet';
        const eskiAda = document.getElementById('eskiAda').value || '[ada]';
        const eskiParsel = document.getElementById('eskiParsel').value || '[parsel]';
        const eskiParselText = eskiParselVar ? `Taşınmaz belgeleri eski ada parsel numarası olan ${eskiAda} ada ${eskiParsel} parsel üzerine çıkarılmıştır.` : '';

        // Tam rapor metni
        let rapor = `Taşınmazın bulunduğu ana taşınmazın konumu imar paftasıyla uyumludur. ${il}/${ilce} Tapu Müdürlüğü Web Tapu’da ve ${belediye}'nde bulunan ${projeTarihiFmt} tarihli mimari projesiyle ${uyumText}.`;
        if (ruhsatText) rapor += ` ${ruhsatText},`;
        if (iskanText) rapor += ` ${iskanText}`;
        rapor += ` ${belgeGoruldumu}. ${belediye}'nde yapılan incelemede değerleme konusu taşınmaz hakkında ${yikimText}.`;
        if (denetimText) rapor += ` ${denetimText}`;
        if (eskiParselText) rapor += ` ${eskiParselText}`;

        document.getElementById('taslak').textContent = rapor.trim();

        // KOPYALANABİLİR TABLO
        let kopyaMetin = `PROJE TARİHİ: ${projeTarihiFmt}\n`;
        ruhsatlar.forEach(r => {
            const tarihFmt = r.tarih ? new Date(r.tarih).toLocaleDateString('tr-TR') : '[tarih]';
            kopyaMetin += `RUHSAT: ${tarihFmt} - ${r.no || '[no]'} - ${r.aciklama || 'belirtilmemiş'}\n`;
        });
        if (iskanVar) {
            const iskanlar = Array.from(document.querySelectorAll('#iskanList .dynamic-item')).map(item => ({
                tarih: item.querySelector('.iskan-tarih').value,
                no: item.querySelector('.iskan-no').value.trim(),
                aciklama: item.querySelector('.iskan-aciklama').value.trim() || 'belirtilmemiş'
            }));
            iskanlar.forEach(i => {
                const tarihFmt = i.tarih ? new Date(i.tarih).toLocaleDateString('tr-TR') : '[tarih]';
                kopyaMetin += `İSKÂN: ${tarihFmt} - ${i.no || '[no]'} - ${i.aciklama || 'belirtilmemiş'}\n`;
            });
        }

        document.getElementById('kopyaIcerik').textContent = kopyaMetin.trim();
        document.getElementById('kopyaTablo').style.display = 'block';
    }

    function kopyalaMetin() {
        const text = document.getElementById('kopyaIcerik').textContent;
        navigator.clipboard.writeText(text).then(() => {
            alert("Kopyalandı!");
        }).catch(() => {
            alert("Kopyalama başarısız, metni manuel seçip kopyala.");
        });
    }

    function kaydet() {
        const iskanVar = document.querySelector('input[name="iskanVar"]:checked')?.value === 'evet';
        const ruhsatlar = Array.from(document.querySelectorAll('#ruhsatList .dynamic-item')).map(item => ({
            tarih: item.querySelector('.ruhsat-tarih').value,
            no: item.querySelector('.ruhsat-no').value.trim(),
            aciklama: item.querySelector('.ruhsat-aciklama').value.trim(),
            kapsam: item.querySelector('input[name^="kapsam-ruhsat"]:checked')?.value || 'tamami',
            kismi: item.querySelector('.ruhsat-kismi')?.value.trim() || ''
        }));

        const iskanlar = iskanVar ? Array.from(document.querySelectorAll('#iskanList .dynamic-item')).map(item => ({
            tarih: item.querySelector('.iskan-tarih').value,
            no: item.querySelector('.iskan-no').value.trim(),
            aciklama: item.querySelector('.iskan-aciklama').value.trim(),
            kapsam: item.querySelector('input[name^="kapsam-iskan"]:checked')?.value || 'tamami',
            kismi: item.querySelector('.iskan-kismi')?.value.trim() || ''
        })) : [];

        reports[id].belgeler = {
            belediyeRaw: document.getElementById('belediye').value.trim(),
            belediye: formatBelediye(document.getElementById('belediye').value.trim()),
            il: document.getElementById('il').value.trim(),
            ilce: document.getElementById('ilce').value.trim(),
            projeTarihi: document.getElementById('projeTarihi').value,
            projeTarihiText: document.getElementById('projeTarihiText').value.trim(),
            uyum: document.querySelector('input[name="uyum"]:checked')?.value,
            ruhsatlar,
            iskanVar: document.querySelector('input[name="iskanVar"]:checked')?.value,
            iskanlar,
            belgeGoruldumu: document.querySelector('input[name="belgeGoruldumu"]:checked')?.value,
            yikimKarari: document.querySelector('input[name="yikimKarari"]:checked')?.value,
            yikimAciklamaText: document.getElementById('yikimAciklamaText').value.trim(),
            denetimDevam: !iskanVar ? document.querySelector('input[name="denetimDevam"]:checked')?.value : null,
            denetimFirma: !iskanVar ? document.getElementById('denetimFirma').value.trim() : '',
            bitmislikOrani: !iskanVar ? document.getElementById('bitmislikOrani').value : '',
            eskiParsel: document.querySelector('input[name="eskiParsel"]:checked')?.value,
            eskiAda: document.getElementById('eskiAda').value,
            eskiParsel: document.getElementById('eskiParsel').value
        };

        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
        alert("Belgeler kaydedildi!");
        window.location.href = `rapor-detay.html?id=${id}`;
    }

    // YENİ: Taslak metninde kopyalamayı tamamen engelle
    document.addEventListener('DOMContentLoaded', () => {
        const taslak = document.getElementById('taslak');
        taslak.oncopy = e => e.preventDefault();
        taslak.onpaste = e => e.preventDefault();
        taslak.oncontextmenu = e => e.preventDefault();
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İncelenen Belgeler</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding-bottom:100px; }
        .header { background:linear-gradient(135deg,#4a148c,#7c4dff); color:white; padding:20px; text-align:center; position:relative; }
        .back { position:absolute; left:15px; top:18px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; color:white; text-decoration:none; font-weight:bold; }
        .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin:25px 0; padding:20px; background:#f9f9f9; border-radius:12px; }
        .checkbox-group { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:15px; margin:15px 0; }
        label { display:flex; align-items:center; font-size:16px; }
        input[type=checkbox] { margin-right:10px; transform:scale(1.4); }
        input[type=date] { padding:10px; border:1px solid #ccc; border-radius:6px; width:200px; margin-right:15px; }
        .dynamic-group { margin:15px 0; padding:15px; background:#fff; border:1px solid #ddd; border-radius:8px; display:flex; align-items:center; flex-wrap:wrap; gap:10px; }
        .remove-btn { background:#d32f2f; color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; }
        .add-btn { background:#2196f3; color:white; padding:10px 15px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; }
        .btn { background:#00c853; color:white; padding:16px; width:100%; border:none; border-radius:12px; font-size:20px; font-weight:bold; cursor:pointer; margin-top:20px; }
        .btn-taslak { background:#2196f3; margin-bottom:10px; }
        .kopyalanabilir { background:#e3f2fd; padding:20px; border-radius:12px; margin:30px 0; border:2px dashed #1976d2; font-family: monospace; font-size:16px; line-height:1.8; }
        .kopyala-buton { background:#1976d2; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:10px; }
        .taslak { background:#e8f5e9; padding:30px; border-radius:12px; margin-top:30px; border:3px solid #4caf50; font-size:19px; line-height:1.8; white-space:pre-wrap; }
    </style>
</head>
<body>

<div class="header">
    <button onclick="anaMenuyeDon()" class="back">← Geri</button>
    <h1>İNCELENEN BELGELER</h1>
</div>

<div class="container">

    <!-- Standart Belgeler -->
    <div class="form-group">
        <strong>Diğer Belgeler (Checkbox ile işaretleyin)</strong>
        <div class="checkbox-group">
            <label><input type="checkbox" class="standart" data-id="tapu"> Tapu Senedi</label>
            <label><input type="checkbox" class="standart" data-id="katMulkiyeti"> Kat Mülkiyeti Tapusu</label>
            <label><input type="checkbox" class="standart" data-id="katIrtifaki"> Kat İrtifakı Tapusu</label>
            <label><input type="checkbox" class="standart" data-id="yonetimPlani"> Yönetim Planı</label>
            <label><input type="checkbox" class="standart" data-id="aidatBorc"> Aidat Borcu Yoktur Yazısı</label>
            <label><input type="checkbox" class="standart" data-id="dask"> DASK Sigorta Poliçesi</label>
            <label><input type="checkbox" class="standart" data-id="enerjiKimlik"> Enerji Kimlik Belgesi</label>
            <label><input type="checkbox" class="standart" data-id="otopark"> Otopark Yazısı</label>
            <label><input type="checkbox" class="standart" data-id="kotKesit"> Kot Kesit Belgesi</label>
            <label><input type="checkbox" class="standart" data-id="zeminEtudu"> Zemin Etüd Raporu</label>
            <label><input type="checkbox" class="standart" data-id="proje"> Mimari Proje</label>
            <label><input type="checkbox" class="standart" data-id="riskliYapi"> Riskli Yapı Tespit Raporu</label>
        </div>
    </div>

    <!-- Yapı Ruhsatları -->
    <div class="form-group">
        <strong>Yapı Ruhsatları</strong>
        <div id="ruhsatContainer"></div>
        <button type="button" class="add-btn" onclick="yeniRuhsatEkle()">+ Yeni Ruhsat Ekle</button>
    </div>

    <!-- Yapı Kullanma İzin Belgeleri -->
    <div class="form-group">
        <strong>Yapı Kullanma İzin Belgeleri (İskân)</strong>
        <div id="iskanContainer"></div>
        <button type="button" class="add-btn" onclick="yeniIskanEkle()">+ Yeni İskân Ekle</button>
    </div>

    <button class="btn btn-taslak" onclick="taslakOlustur()">OTOMATİK METİN + KOPYALANABİLİR TABLO OLUŞTUR</button>
    <button class="btn" onclick="kaydet()">KAYDET VE GERİ DÖN</button>

    <div id="kopyaTablo" class="kopyalanabilir" style="display:none;">
        <strong>Bankaya Yapıştırmak İçin:</strong><br>
        <div id="kopyaIcerik"></div>
        <button class="kopyala-buton" onclick="kopyala()">TÜMÜNÜ KOPYALA</button>
    </div>

    <div id="taslak" class="taslak">
        En az bir belge işaretleyin veya ruhsat/iskân ekleyin → butona basın...
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || {};
    const report = reports[id] || {};
    const belgeler = report.belgeler || { standart: {}, ruhsatlar: [], iskanlar: [] };

    // Standart checkbox yükleme
    Object.keys(belgeler.standart || {}).forEach(key => {
        const cb = document.querySelector(`.standart[data-id="${key}"]`);
        if (cb) cb.checked = belgeler.standart[key];
    });

    // Ruhsat yükleme
    (belgeler.ruhsatlar || []).forEach(r => yeniRuhsatEkle(r.tarih || '', r.asli !== false));

    // İskân yükleme
    (belgeler.iskanlar || []).forEach(i => yeniIskanEkle(i.tarih || '', i.asli !== false));

    // Varsayılan olarak birer tane ekle
    if ((belgeler.ruhsatlar || []).length === 0) yeniRuhsatEkle();
    if ((belgeler.iskanlar || []).length === 0) yeniIskanEkle();

    function yeniRuhsatEkle(tarih = "", asli = true) {
        const container = document.getElementById('ruhsatContainer');
        const div = document.createElement('div');
        div.className = 'dynamic-group';
        div.innerHTML = `
            <input type="date" class="ruhsat-tarih" value="${tarih}">
            <label><input type="checkbox" class="ruhsat-asli" ${asli ? 'checked' : ''}> Aslı Gibidir</label>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Sil</button>
        `;
        container.appendChild(div);
    }

    function yeniIskanEkle(tarih = "", asli = true) {
        const container = document.getElementById('iskanContainer');
        const div = document.createElement('div');
        div.className = 'dynamic-group';
        div.innerHTML = `
            <input type="date" class="iskan-tarih" value="${tarih}">
            <label><input type="checkbox" class="iskan-asli" ${asli ? 'checked' : ''}> Aslı Gibidir</label>
            <button type="button" class="remove-btn" onclick="this.parentElement.remove()">Sil</button>
        `;
        container.appendChild(div);
    }

    function taslakOlustur() {
        const standartList = [];
        document.querySelectorAll('.standart:checked').forEach(cb => {
            standartList.push(cb.parentNode.textContent.trim());
        });

        const ruhsatList = [];
        document.querySelectorAll('#ruhsatContainer .dynamic-group').forEach(group => {
            const tarih = group.querySelector('.ruhsat-tarih').value;
            if (tarih) {
                const asli = group.querySelector('.ruhsat-asli').checked;
                const tarihFmt = tarih.replace(/-/g, '.');
                ruhsatList.push(`${tarihFmt} tarihli yapı ruhsatı${asli ? ' (aslı gibidir damgalı)' : ''}`);
            }
        });

        const iskanList = [];
        document.querySelectorAll('#iskanContainer .dynamic-group').forEach(group => {
            const tarih = group.querySelector('.iskan-tarih').value;
            if (tarih) {
                const asli = group.querySelector('.iskan-asli').checked;
                const tarihFmt = tarih.replace(/-/g, '.');
                iskanList.push(`${tarihFmt} tarihli yapı kullanma izin belgesi${asli ? ' (aslı gibidir damgalı)' : ''}`);
            }
        });

        const tumBelgeler = [...standartList, ...ruhsatList, ...iskanList];

        // Kopyalanabilir tablo
        let kopyaMetin = "İNCELENEN BELGELER:\n";
        if (tumBelgeler.length === 0) {
            kopyaMetin += "Herhangi bir belge sunulmamıştır.";
        } else {
            kopyaMetin += tumBelgeler.join("\n");
        }
        document.getElementById('kopyaIcerik').textContent = kopyaMetin;
        document.getElementById('kopyaTablo').style.display = 'block';

        // Rapor metni
        let raporMetni = "Ekspertiz incelemesi sırasında aşağıdaki belgeler sunulmuş ve incelenmiştir:\n\n";
        if (ruhsatList.length > 0) raporMetni += ruhsatList.join("\n") + "\n\n";
        if (iskanList.length > 0) raporMetni += iskanList.join("\n") + "\n\n";
        if (standartList.length > 0) raporMetni += standartList.join(", ") + ".";
        if (tumBelgeler.length === 0) raporMetni = "Herhangi bir belge sunulmamıştır.";

        document.getElementById('taslak').textContent = raporMetni.trim();
    }

    function kopyala() {
        navigator.clipboard.writeText(document.getElementById('kopyaIcerik').textContent).then(() => {
            alert("Kopyalandı!");
        });
    }

    function kaydet() {
        const standart = {};
        document.querySelectorAll('.standart').forEach(cb => {
            standart[cb.dataset.id] = cb.checked;
        });

        const ruhsatlar = [];
        document.querySelectorAll('#ruhsatContainer .dynamic-group').forEach(group => {
            const tarih = group.querySelector('.ruhsat-tarih').value;
            if (tarih) {
                ruhsatlar.push({
                    tarih: tarih,
                    asli: group.querySelector('.ruhsat-asli').checked
                });
            }
        });

        const iskanlar = [];
        document.querySelectorAll('#iskanContainer .dynamic-group').forEach(group => {
            const tarih = group.querySelector('.iskan-tarih').value;
            if (tarih) {
                iskanlar.push({
                    tarih: tarih,
                    asli: group.querySelector('.iskan-asli').checked
                });
            }
        });

        reports[id] = reports[id] || {};
        reports[id].belgeler = { standart, ruhsatlar, iskanlar };
        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

        alert("Belgeler kaydedildi!");
        anaMenuyeDon();
    }

    function anaMenuyeDon() {
        window.location.href = `rapor-detay.html?id=${id}`;
    }
</script>
</body>
</html>

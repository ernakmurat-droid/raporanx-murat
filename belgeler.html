<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İncelenen Belgeler</title>
    <style>
        body { font-family: Arial, sans-serif; background:#f5f7fa; margin:0; padding-bottom:100px; }
        .header { background:linear-gradient(135deg,#4a148c,#7c4dff); color:white; padding:20px; text-align:center; position:relative; }
        .back { position:absolute; left:15px; top:18px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; color:white; text-decoration:none; font-weight:bold; }
        .property-name { font-size:18px; margin-top:8px; opacity:0.9; }
        .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin:25px 0; padding:20px; background:#f9f9f9; border-radius:12px; }
        .radio-group { display:flex; gap:20px; flex-wrap:wrap; margin:10px 0; }
        input[type=text], input[type=date], input[type=number], textarea { padding:12px; width:100%; border:1px solid #ccc; border-radius:8px; font-size:16px; box-sizing:border-box; }
        .dynamic-item { display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap; background:#fff; padding:15px; border-radius:8px; border:1px solid #eee; }
        .dynamic-item > div { flex:1; min-width:180px; }
        .remove-btn { background:#d32f2f; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
        .add-btn { background:#2196f3; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; }
        .btn { background:#00c853; color:white; padding:16px; width:100%; border:none; border-radius:12px; font-size:20px; font-weight:bold; cursor:pointer; margin-top:20px; }
        .btn-taslak { background:#2196f3; margin-bottom:10px; }
        .taslak { background:#e8f5e9; padding:30px; border-radius:12px; margin-top:30px; border:3px solid #4caf50; font-size:19px; line-height:1.8; white-space:pre-wrap; user-select:none; }
        .kopyalanabilir { background:#e3f2fd; padding:20px; border-radius:12px; margin:30px 0; border:2px dashed #1976d2; font-family: monospace; font-size:16px; line-height:1.8; user-select:all; }
        .kopyala-buton { background:#1976d2; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; margin-top:10px; }
        .conditional { display:none; margin-top:15px; padding:15px; background:#fff; border:1px solid #ddd; border-radius:8px; }
        .inline-input { display:inline-block; width:200px; margin-left:10px; }

        /* Veri girişi serbest */
        input, textarea, select, .radio-group, .dynamic-item {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        /* Dinamik listeler kopyalanamaz */
        #ruhsatList, #iskanList, .dynamic-item {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            pointer-events: none !important;
        }
        .dynamic-item button { pointer-events: auto !important; }
        /* Taslak kopyalanamaz */
        .taslak {
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            pointer-events: none !important;
        }
    </style>
</head>
<body>

<div class="header">
    <a href="#" onclick="history.back()" class="back">← Geri</a>
    <h1>İNCELENEN BELGELER</h1>
    <div id="propertyName" class="property-name">Yükleniyor...</div>
</div>

<div class="container">
    <div class="form-group">
        <strong>1. Taşınmazın Bağlı Olduğu Belediye</strong>
        <input type="text" id="belediye" placeholder="Örn: Kadıköy (otomatik 'Belediyesi' eklenir)">
    </div>

    <div class="form-group">
        <strong>2. İli</strong>
        <input type="text" id="il" placeholder="Örn: İstanbul">
        <strong>3. İlçesi</strong>
        <input type="text" id="ilce" placeholder="Örn: Kadıköy">
    </div>

    <div class="form-group">
        <strong>4. Taşınmaz Proje Tarihi</strong>
        <div style="display:flex; gap:10px; align-items:center;">
            <input type="date" id="projeTarihi">
            <input type="text" id="projeTarihiText" class="inline-input" placeholder="Bila / Tarihsiz">
        </div>
        <small>Tarih yoksa yan tarafa yazın</small>
    </div>

    <div class="form-group">
        <strong>5. Proje ile uyumlumu?</strong>
        <div class="radio-group" id="uyum-group">
            <label><input type="radio" name="uyum" value="evet"> Evet</label>
            <label><input type="radio" name="uyum" value="hayir"> Hayır</label>
            <label><input type="radio" name="uyum" value="kismen"> Kısmen</label>
        </div>
    </div>

    <!-- Ruhsatlar -->
    <div class="form-group">
        <strong>Yapı Ruhsatları</strong>
        <div id="ruhsatList"></div>
        <button type="button" class="add-btn" onclick="addRuhsat()">+ Yeni Ruhsat Ekle</button>
    </div>

    <!-- İskân Var mı? -->
    <div class="form-group">
        <strong>İskân Var mı?</strong>
        <div class="radio-group">
            <label><input type="radio" name="iskanVar" value="evet"> Evet</label>
            <label><input type="radio" name="iskanVar" value="hayir"> Hayır</label>
        </div>
    </div>

    <div id="iskanSection" style="display:none;">
        <div class="form-group">
            <strong>Yapı Kullanma İzin Belgeleri (İskân)</strong>
            <div id="iskanList"></div>
            <button type="button" class="add-btn" onclick="addIskan()">+ Yeni İskân Ekle</button>
        </div>
    </div>

    <!-- Yapı Denetim -->
    <div class="form-group" id="yapiDenetimSection" style="display:none;">
        <strong>Yapı denetim firması denetime devam ediyor mu?</strong>
        <div class="radio-group">
            <label><input type="radio" name="denetimDevam" value="evet"> Evet</label>
            <label><input type="radio" name="denetimDevam" value="hayir"> Hayır</label>
        </div>
        <div id="denetimEvet" class="conditional" style="display:none;">
            <strong>14. Yapı Denetim Firması Adı</strong>
            <input type="text" id="denetimFirma">
            <strong>15. Bitmişlik Oranı (%)</strong>
            <input type="number" id="bitmislikOrani" min="0" max="100">
        </div>
    </div>

    <div class="form-group">
        <strong>12. Taşınmaz belgeler görüldü mü?</strong>
        <div class="radio-group">
            <label><input type="radio" name="belgeGoruldumu" value="Görüldü"> Görüldü</label>
            <label><input type="radio" name="belgeGoruldumu" value="İncelendi"> İncelendi</label>
            <label><input type="radio" name="belgeGoruldumu" value="Elektronik ortamda teyit edildi"> Elektronik ortamda teyit edildi</label>
        </div>
    </div>

    <div class="form-group">
        <strong>Belediyesinde olumsuz karar veya yıkım kararı var mı?</strong>
        <div class="radio-group">
            <label><input type="radio" name="yikimKarari" value="hayir"> Hayır</label>
            <label><input type="radio" name="yikimKarari" value="evet"> Evet</label>
        </div>
        <div id="yikimAciklama" class="conditional" style="display:none;">
            <textarea id="yikimAciklamaText" rows="3" placeholder="Karar türünü yazın (örn: yıkım, para cezası)"></textarea>
            <small>Yukarıya yazdığınız metin otomatik "... hakkında [yazdığınız] kararı vardır." şeklinde eklenecek.</small>
        </div>
    </div>

    <div class="form-group">
        <strong>Belgeler eski ada/parsel üzerine mi düzenlenmiş?</strong>
        <div class="radio-group">
            <label><input type="radio" name="eskiParsel" value="hayir"> Hayır</label>
            <label><input type="radio" name="eskiParsel" value="evet"> Evet</label>
        </div>
        <div id="eskiParselSection" class="conditional" style="display:none;">
            <strong>16. Eski Ada No</strong>
            <input type="number" id="eskiAda">
            <strong>17. Eski Parsel No</strong>
            <input type="number" id="eskiParsel">
        </div>
    </div>

    <button class="btn btn-taslak" onclick="taslakOlustur()">OTOMATİK METİN + KOPYALANABİLİR TABLO OLUŞTUR</button>
    <button class="btn" onclick="kaydet()">KAYDET VE ANA MENÜYE DÖN</button>

    <div id="kopyaTablo" class="kopyalanabilir" style="display:none;">
        <strong>Banka / Ekspertiz Raporuna Yapıştırmak İçin:</strong><br>
        <div id="kopyaIcerik"></div>
        <button class="kopyala-buton" onclick="kopyalaMetin()">TÜMÜNÜ KOPYALA</button>
    </div>

    <div id="taslak" class="taslak">
        Bilgileri doldurun → "OTOMATİK METİN + KOPYALANABİLİR TABLO OLUŞTUR" butonuna basın...
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || {};
    let report = reports[id] || {};
    const belgeler = report.belgeler || {};

    document.getElementById('propertyName').textContent = report.adi || report.propertyName || "İsimsiz Gayrimenkul";

    function formatBelediye(name) {
        if (!name) return "[Belediye]";
        name = name.trim();
        if (name.toLowerCase().includes('belediyesi') || name.toLowerCase().includes('belediye')) return name;
        return name + ' Belediyesi';
    }

    // Yükleme (tüm alanlar)
    document.getElementById('belediye').value = belgeler.belediyeRaw || '';
    document.getElementById('il').value = belgeler.il || '';
    document.getElementById('ilce').value = belgeler.ilce || '';
    document.getElementById('projeTarihi').value = belgeler.projeTarihi || '';
    document.getElementById('projeTarihiText').value = belgeler.projeTarihiText || '';
    if (belgeler.uyum) document.querySelector(`input[name="uyum"][value="${belgeler.uyum}"]`).checked = true;
    if (belgeler.belgeGoruldumu) document.querySelector(`input[name="belgeGoruldumu"][value="${belgeler.belgeGoruldumu}"]`).checked = true;
    if (belgeler.yikimKarari) document.querySelector(`input[name="yikimKarari"][value="${belgeler.yikimKarari}"]`).checked = true;
    if (belgeler.yikimAciklamaText) document.getElementById('yikimAciklamaText').value = belgeler.yikimAciklamaText;
    if (belgeler.yikimKarari === 'evet') document.getElementById('yikimAciklama').style.display = 'block';
    if (belgeler.denetimDevam) document.querySelector(`input[name="denetimDevam"][value="${belgeler.denetimDevam}"]`).checked = true;
    if (belgeler.denetimDevam === 'evet') document.getElementById('denetimEvet').style.display = 'block';
    document.getElementById('denetimFirma').value = belgeler.denetimFirma || '';
    document.getElementById('bitmislikOrani').value = belgeler.bitmislikOrani || '';
    if (belgeler.eskiParsel === 'evet') {
        document.querySelector('input[name="eskiParsel"][value="evet"]').checked = true;
        document.getElementById('eskiParselSection').style.display = 'block';
    }
    document.getElementById('eskiAda').value = belgeler.eskiAda || '';
    document.getElementById('eskiParsel').value = belgeler.eskiParsel || '';

    const iskanVar = belgeler.iskanVar === 'evet';
    if (iskanVar) {
        document.querySelector('input[name="iskanVar"][value="evet"]').checked = true;
        document.getElementById('iskanSection').style.display = 'block';
        document.getElementById('yapiDenetimSection').style.display = 'none';
    } else {
        document.querySelector('input[name="iskanVar"][value="hayir"]').checked = true;
        document.getElementById('yapiDenetimSection').style.display = 'block';
    }

    if (belgeler.ruhsatlar && belgeler.ruhsatlar.length > 0) {
        belgeler.ruhsatlar.forEach(r => addRuhsat(r));
    } else {
        addRuhsat(); // En az bir tane olsun
    }
    if (iskanVar && belgeler.iskanlar && belgeler.iskanlar.length > 0) {
        belgeler.iskanlar.forEach(i => addIskan(i));
    } else if (iskanVar) {
        addIskan();
    }

    function addRuhsat(data = {}) { /* aynı kalıyor, önceki kod */ }
    function addIskan(data = {}) { /* aynı kalıyor, önceki kod */ }

    // Toggle'lar (aynı kalıyor)

    // Uyum değiştiğinde otomatik taslak oluştur
    document.getElementById('uyum-group').addEventListener('change', taslakOlustur);

    function taslakOlustur() {
        const belediyeRaw = document.getElementById('belediye').value.trim();
        const belediye = formatBelediye(belediyeRaw);
        const il = document.getElementById('il').value.trim() || "[İl]";
        const ilce = document.getElementById('ilce').value.trim() || "[İlçe]";
        const projeTarihi = document.getElementById('projeTarihi').value;
        const projeTarihiText = document.getElementById('projeTarihiText').value.trim();
        const projeTarihiFmt = projeTarihi ? new Date(projeTarihi).toLocaleDateString('tr-TR') : (projeTarihiText || "[tarih]");

        const uyum = document.querySelector('input[name="uyum"]:checked')?.value || '';
        const uyumText = uyum === 'evet' ? 'uyumludur' : uyum === 'hayir' ? 'uyumlu değildir' : uyum === 'kismen' ? 'kısmen uyumludur' : '[uyum durumu]';

        const ruhsatlar = Array.from(document.querySelectorAll('#ruhsatList .dynamic-item')).filter(item => item.querySelector('.ruhsat-no').value.trim() || item.querySelector('.ruhsat-tarih').value); // Boş satırları filtrele
        let ruhsatText = '';
        if (ruhsatlar.length > 0) {
            ruhsatText = ruhsatlar.map(r => {
                const item = r;
                const tarih = item.querySelector('.ruhsat-tarih').value;
                const no = item.querySelector('.ruhsat-no').value.trim();
                const aciklama = item.querySelector('.ruhsat-aciklama').value.trim() || 'belirtilmemiş';
                const kapsam = item.querySelector('input[name^="kapsam-ruhsat"]:checked')?.value || 'tamami';
                const kismi = item.querySelector('.ruhsat-kismi')?.value.trim() || '';
                const kapsamText = kapsam === 'tamami' ? 'binanın tamamı için' : kismi;
                const tarihFmt = tarih ? new Date(tarih).toLocaleDateString('tr-TR') : '[tarih]';
                return `${tarihFmt} tarih ve ${no || '[no]'} sayılı ${aciklama} için ${kapsamText} düzenlenmiş yapı ruhsatı`;
            }).join(', ');
        } else {
            ruhsatText = 'yapı ruhsatı bulunmamaktadır';
        }

        const iskanVar = document.querySelector('input[name="iskanVar"]:checked')?.value === 'evet';
        let iskanText = '';
        if (iskanVar) {
            const iskanlar = Array.from(document.querySelectorAll('#iskanList .dynamic-item')).filter(item => item.querySelector('.iskan-no').value.trim() || item.querySelector('.iskan-tarih').value);
            if (iskanlar.length > 0) {
                iskanText = iskanlar.map(i => {
                    const item = i;
                    const tarih = item.querySelector('.iskan-tarih').value;
                    const no = item.querySelector('.iskan-no').value.trim();
                    const aciklama = item.querySelector('.iskan-aciklama').value.trim() || 'belirtilmemiş';
                    const kapsam = item.querySelector('input[name^="kapsam-iskan"]:checked')?.value || 'tamami';
                    const kismi = item.querySelector('.iskan-kismi')?.value.trim() || '';
                    const kapsamText = kapsam === 'tamami' ? 'binanın tamamı için' : kismi;
                    const tarihFmt = tarih ? new Date(tarih).toLocaleDateString('tr-TR') : '[tarih]';
                    return `${tarihFmt} tarih ve ${no || '[no]'} sayılı ${aciklama} için ${kapsamText} düzenlenmiş yapı kullanma izin belgesi`;
                }).join(', ');
            } else {
                iskanText = 'yapı kullanma izin belgesi (iskân) bulunmamaktadır';
            }
        } else {
            iskanText = 'yapı kullanma izin belgesi (iskân) bulunmamaktadır';
        }

        const belgeGoruldumu = document.querySelector('input[name="belgeGoruldumu"]:checked')?.value || '[belge durumu]';

        const yikimKarari = document.querySelector('input[name="yikimKarari"]:checked')?.value;
        let yikimText = 'herhangi olumsuz bir tespit tutanak/yıkım kararının olmadığı tespit edilmiştir';
        if (yikimKarari === 'evet') {
            const aciklama = document.getElementById('yikimAciklamaText').value.trim() || '[karar türü]';
            yikimText = `${aciklama} kararı vardır`;
        }

        let denetimText = '';
        if (!iskanVar) {
            const denetimDevam = document.querySelector('input[name="denetimDevam"]:checked')?.value;
            if (denetimDevam === 'evet') {
                const firma = document.getElementById('denetimFirma').value.trim() || '[firma adı]';
                const oran = document.getElementById('bitmislikOrani').value || '[oran]';
                denetimText = `${firma} Yapı denetim firmasının denetime devam ettiği ${oran}% bitmişlik oranında olduğu öğrenilmiştir.`;
            } else if (denetimDevam === 'hayir') {
                denetimText = 'yapı denetim firması denetimden ayrılmıştır.';
            }
        }

        const eskiParselVar = document.querySelector('input[name="eskiParsel"]:checked')?.value === 'evet';
        const eskiAda = document.getElementById('eskiAda').value || '[ada]';
        const eskiParsel = document.getElementById('eskiParsel').value || '[parsel]';
        const eskiParselText = eskiParselVar ? `Taşınmaz belgeleri eski ada parsel numarası olan ${eskiAda} ada ${eskiParsel} parsel üzerine çıkarılmıştır.` : '';

        let rapor = `Taşınmazın bulunduğu ana taşınmazın konumu imar paftasıyla uyumludur. ${il}/${ilce} Tapu Müdürlüğü Web Tapu’da ve ${belediye}'nde bulunan ${projeTarihiFmt} tarihli mimari projesiyle ${uyumText}`;
        if (ruhsatText) rapor += `, ${ruhsatText}`;
        if (iskanText) rapor += `, ${iskanText}`;
        rapor += `. ${belgeGoruldumu}. ${belediye}'nde yapılan incelemede değerleme konusu taşınmaz hakkında ${yikimText}.`;
        if (denetimText) rapor += ` ${denetimText}`;
        if (eskiParselText) rapor += ` ${eskiParselText}`;

        document.getElementById('taslak').textContent = rapor.trim() + '.';

        // Kopyalanabilir tablo (ruhsat/iskân yoksa boş satır ekleme)
        let kopyaMetin = `PROJE TARİHİ: ${projeTarihiFmt}\n`;
        if (ruhsatlar.length > 0) {
            ruhsatlar.forEach(r => {
                const item = r;
                const tarihFmt = item.querySelector('.ruhsat-tarih').value ? new Date(item.querySelector('.ruhsat-tarih').value).toLocaleDateString('tr-TR') : '[tarih]';
                kopyaMetin += `RUHSAT: ${tarihFmt} - ${item.querySelector('.ruhsat-no').value.trim() || '[no]'} - ${item.querySelector('.ruhsat-aciklama').value.trim() || 'belirtilmemiş'}\n`;
            });
        }
        if (iskanVar && iskanlar.length > 0) {
            iskanlar.forEach(i => {
                const item = i;
                const tarihFmt = item.querySelector('.iskan-tarih').value ? new Date(item.querySelector('.iskan-tarih').value).toLocaleDateString('tr-TR') : '[tarih]';
                kopyaMetin += `İSKÂN: ${tarihFmt} - ${item.querySelector('.iskan-no').value.trim() || '[no]'} - ${item.querySelector('.iskan-aciklama').value.trim() || 'belirtilmemiş'}\n`;
            });
        }

        document.getElementById('kopyaIcerik').textContent = kopyaMetin.trim();
        document.getElementById('kopyaTablo').style.display = 'block';
    }

    // Diğer fonksiyonlar (kopyalaMetin, kaydet) aynı kalıyor

    // Kopyalama engeli
    document.addEventListener('DOMContentLoaded', () => {
        const protectedElements = document.querySelectorAll('.taslak, #ruhsatList, #iskanList');
        protectedElements.forEach(el => {
            el.oncopy = e => e.preventDefault();
            el.onpaste = e => e.preventDefault();
            el.oncontextmenu = e => e.preventDefault();
        });
    });
</script>
</body>
</html>

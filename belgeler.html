<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>İncelenen Belgeler - Raporan X</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>

    <style>
        :root { --primary: #1a148c; --secondary: #7c4dff; --success: #00c853; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin:0; padding-bottom:100px; color: #333; }
        .header { background: linear-gradient(135deg,#4a148c,#7c4dff); color:white; padding:20px; text-align:center; position:relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .back { position:absolute; left:15px; top:18px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; color:white; text-decoration:none; font-weight:bold; cursor: pointer; border: none; }
        .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
        .form-group { margin:25px 0; padding:20px; background:#f9f9f9; border-radius:12px; border: 1px solid #eee; }
        .radio-group { display:flex; gap:20px; flex-wrap:wrap; margin:10px 0; }
        input[type=text], input[type=date], input[type=number], textarea { padding:12px; border:1px solid #ccc; border-radius:8px; font-size:16px; box-sizing:border-box; transition: 0.3s; width: 100%; }
        .dynamic-item { display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap; background:#fff; padding:15px; border-radius:8px; border:1px solid #eee; }
        .remove-btn { background:#d32f2f; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
        .add-btn { background:#2196f3; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-weight: bold; }
        .btn-kaydet { background:#00c853; color:white; padding:20px; width:100%; border:none; border-radius:12px; font-size:22px; font-weight:bold; cursor:pointer; margin-top:20px; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
        .btn-geri { background:#6c757d; color:white; padding:15px; width:100%; border:none; border-radius:12px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:10px; text-align:center; text-decoration:none; display:block; }
        .taslak { background:#e8f5e9; padding:30px; border-radius:12px; margin-top:30px; border:3px solid #4caf50; font-size:19px; line-height:1.8; white-space:pre-wrap; }
        .property-name { font-weight: bold; margin-top: 5px; color: #ffd700; }
        .conditional { display:none; margin-top:10px; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="header">
    <button onclick="anaMenuyeDon()" class="back">← Geri</button>
    <h1>İNCELENEN BELGELER</h1>
    <div id="propertyName" class="property-name">Yükleniyor...</div>
</div>

<div class="container">
    <div class="form-group">
        <strong>1. Belediye ve Lokasyon Bilgisi</strong>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <input type="text" id="belediye" placeholder="Belediye">
            <input type="text" id="il" placeholder="İl">
            <input type="text" id="ilce" placeholder="İlçe">
        </div>
    </div>

    <div class="form-group">
        <strong>2. Mimari Proje Tarihi</strong>
        <input type="date" id="projeTarihi" style="margin-top:10px;">
        <div class="radio-group" style="margin-top:10px;">
            <label><input type="radio" name="uyum" value="evet" checked> Projeyle Uyumlu</label>
            <label><input type="radio" name="uyum" value="hayir"> Uyumsuz</label>
        </div>
    </div>

    <div class="form-group">
        <strong>3. Yapı Ruhsatları</strong>
        <div id="ruhsatList"></div>
        <button type="button" class="add-btn" onclick="addRuhsat()">+ Yeni Ruhsat Ekle</button>
    </div>

    <button class="btn-kaydet" onclick="kaydetVeIsle()">KAYDET VE BULUTA MÜHÜRLE</button>
    <button class="btn-geri" onclick="anaMenuyeDon()">GERİ DÖN</button>
    
    <div id="taslak" class="taslak" style="display:none;"></div>
</div>

<script>
    // URL'den Rapor ID'sini Al
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    
    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    let report = reports[id] || {};

    // Sayfa Yüklendiğinde
    window.onload = () => {
        if (!id) {
            alert("Hata: Rapor seçilmedi!");
            window.location.href = "index.html";
            return;
        }
        document.getElementById('propertyName').textContent = report.propertyName || "Bilinmeyen Rapor";
        if (report.belgeler) yukleMevcutVeriler(); else addRuhsat();
    };

    function addRuhsat(data = {}) {
        const list = document.getElementById('ruhsatList');
        const item = document.createElement('div');
        item.className = 'dynamic-item';
        item.innerHTML = `
            <input type="date" class="r-tarih" value="${data.tarih_raw || ''}" style="width:30%">
            <input type="text" class="r-no" value="${data.no || ''}" placeholder="Ruhsat No" style="width:30%">
            <input type="text" class="r-amac" value="${data.amac || ''}" placeholder="Amacı" style="width:30%">
            <button class="remove-btn" onclick="this.parentElement.remove()">X</button>
        `;
        list.appendChild(item);
    }

    async function kaydetVeIsle() {
        const bRaw = document.getElementById('belediye').value;
        const il = document.getElementById('il').value;
        
        // Verileri Rapor Objesine Ekle
        report.belgeler = {
            belediye: bRaw,
            il: il,
            ilce: document.getElementById('ilce').value,
            projeTarihi: document.getElementById('projeTarihi').value
        };

        reports[id] = report;
        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

        // Firebase Firestore'a yedekle
        const user = auth.currentUser;
        if (user) {
            await db.collection("users").doc(user.uid).set({
                gayrimenkul_reports: reports
            }, { merge: true });
        }

        alert("✅ Veriler kaydedildi ve buluta mühürlendi!");
        document.getElementById('taslak').innerText = "Rapor metni başarıyla oluşturuldu.";
        document.getElementById('taslak').style.display = 'block';
    }

    function anaMenuyeDon() {
        window.location.href = `rapor_ana_menu.html?id=${id}`;
    }
</script>
</body>
</html>
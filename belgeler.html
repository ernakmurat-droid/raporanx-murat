<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>İncelenen Belgeler</title>
  <style>
    :root { --primary: #1a148c; --secondary: #7c4dff; --success: #00c853; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin:0; padding-bottom:100px; color: #333; }
    .header { background: linear-gradient(135deg,#4a148c,#7c4dff); color:white; padding:20px; text-align:center; position:relative; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .back { position:absolute; left:15px; top:18px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; color:white; text-decoration:none; font-weight:bold; cursor: pointer; border: none; }
    .container { max-width:900px; margin:20px auto; padding:20px; background:white; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,0.1); }
    .form-group { margin:25px 0; padding:20px; background:#f9f9f9; border-radius:12px; border: 1px solid #eee; }
    .radio-group { display:flex; gap:20px; flex-wrap:wrap; margin:10px 0; }
    input[type=text], input[type=date], input[type=number], textarea { padding:12px; border:1px solid #ccc; border-radius:8px; font-size:16px; box-sizing:border-box; transition: 0.3s; width: 100%; }
    input:focus, textarea:focus { border-color: var(--secondary); outline: none; background: #fdfdfd; }
    input:disabled { background: #e0e0e0; cursor: not-allowed; }
    .dynamic-item { display:flex; gap:10px; margin-bottom:15px; align-items:center; flex-wrap:wrap; background:#fff; padding:15px; border-radius:8px; border:1px solid #eee; }
    .dynamic-item > div { flex:1; min-width:180px; }
    .remove-btn { background:#d32f2f; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .add-btn { background:#2196f3; color:white; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; margin-top:10px; font-weight: bold; }
    .btn-kaydet { background:#00c853; color:white; padding:20px; width:100%; border:none; border-radius:12px; font-size:22px; font-weight:bold; cursor:pointer; margin-top:20px; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
    .btn-geri { background:#6c757d; color:white; padding:15px; width:100%; border:none; border-radius:12px; font-size:18px; font-weight:bold; cursor:pointer; margin-top:10px; text-align:center; text-decoration:none; display:block; }
    .taslak {
      background:#e8f5e9; padding:30px; border-radius:12px; margin-top:30px; border:3px solid #4caf50;
      font-size:19px; line-height:1.8; white-space:pre-wrap;
      -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
      transition: filter 0.3s ease;
    }
    .taslak:not(:hover) { filter: blur(1px); }
    @media print {
      body * { visibility: hidden; }
      .taslak, .taslak * { visibility: visible; }
      .taslak { position: absolute; left: 0; top: 0; width: 100%; }
    }
    .conditional { display:none; margin-top:10px; }
    .property-name { font-weight: bold; margin-top: 5px; color: #ffd700; }
    .checkbox-ilave { margin-top:15px; font-weight:bold; }
  </style>
</head>
<body oncontextmenu="return false;">
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">← Geri</button>
    <h1>İNCELENEN BELGELER</h1>
    <div id="propertyName" class="property-name">Yükleniyor...</div>
  </div>
  <div class="container">
    <div class="form-group">
      <strong>1. Belediye ve Lokasyon Bilgisi</strong>
      <div style="display:flex; gap:10px; margin-top:10px; margin-bottom:15px;">
        <input type="text" id="belediye" placeholder="Belediye" list="h_belgeler_belediye" onfocus="showList(this)">
        <input type="text" id="il" placeholder="İl" list="h_belgeler_il" onfocus="showList(this)">
        <input type="text" id="ilce" placeholder="İlçe" list="h_belgeler_ilce" onfocus="showList(this)">
      </div>
      <label><strong>Belgeler farklı ada/parselde mi?</strong></label>
      <div class="radio-group">
        <label><input type="radio" name="farkliParsel" value="hayir" checked onchange="toggleFarkliParsel()"> Hayır (Aynı)</label>
        <label><input type="radio" name="farkliParsel" value="evet" onchange="toggleFarkliParsel()"> Evet (Farklı)</label>
      </div>
      <div id="farkliParselDetay" class="conditional" style="display:none; gap:10px;">
        <input type="text" id="arsivAda" placeholder="Arşiv Ada No" list="h_belgeler_arsivAda" onfocus="showList(this)">
        <input type="text" id="arsivParsel" placeholder="Arşiv Parsel No" list="h_belgeler_arsivParsel" onfocus="showList(this)">
      </div>
    </div>
    <div class="form-group">
      <strong>2. Mimari Proje Tarihi ve Uyumluluk</strong>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <input type="date" id="projeTarihi">
        <input type="text" id="projeTarihiText" placeholder="Alternatif Tarih (Bila vb.)" list="h_belgeler_projeTarihiText" onfocus="showList(this)" oninput="checkBila()">
      </div>
      <div class="radio-group">
        <label><input type="radio" name="uyum" value="evet" checked onchange="toggleUyumDetay()"> Evet</label>
        <label><input type="radio" name="uyum" value="hayir" onchange="toggleUyumDetay()"> Hayır</label>
        <label><input type="radio" name="uyum" value="kismen" onchange="toggleUyumDetay()"> Kısmen</label>
      </div>
      <textarea id="uyumAciklama" rows="2" placeholder="Uyumsuzluk varsa açıklama..." list="h_belgeler_uyumAciklama" onfocus="showList(this)" style="margin-top:10px; display:none;"></textarea>
      <!-- İlave Alan Checkbox -->
      <div id="uyumIlaveCheckbox" class="conditional checkbox-ilave" style="display:none;">
        <label><input type="checkbox" id="ilaveAlanTik" onchange="toggleIlaveAlan()"> İlave Alan</label>
      </div>
      <!-- İlave Alan Girişi -->
      <div id="ilaveAlanBox" class="conditional" style="display:none; margin-top:10px;">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <div style="flex:1; min-width:200px;">
            <input type="number" id="ilaveAlanM2" placeholder="İlave alan (m²)" min="0" step="0.01" list="h_belgeler_ilaveAlanM2" onfocus="showList(this)">
          </div>
          <div style="flex:2; min-width:240px;">
            <input type="text" id="ilaveAlanNot" placeholder="İlave alan notu (opsiyonel)" list="h_belgeler_ilaveAlanNot" onfocus="showList(this)">
          </div>
        </div>
      </div>
    </div>
    <div class="form-group">
      <strong>3. Yapı Ruhsatları</strong>
      <div id="ruhsatList"></div>
      <button type="button" class="add-btn" onclick="addRuhsat()">+ Yeni Ruhsat Ekle</button>
    </div>
    <div class="form-group">
      <strong>4. İskân (Yapı Kullanma İzin Belgesi) Durumu</strong>
      <div class="radio-group">
        <label><input type="radio" name="iskanVar" value="evet" onchange="toggleIskan(true)"> Evet (Var)</label>
        <label><input type="radio" name="iskanVar" value="hayir" checked onchange="toggleIskan(false)"> Hayır (Yok)</label>
      </div>
      <div id="iskanSection" style="display:none; margin-top:10px;">
        <div id="iskanList"></div>
        <button type="button" class="add-btn" onclick="addIskan()">+ Yeni İskân Ekle</button>
      </div>
    </div>
    <div class="form-group" id="yapiDenetimSection">
      <strong>5. Yapı Denetim Bilgileri (İskân Yoksa)</strong>
      <div class="radio-group">
        <label><input type="radio" name="denetimDevam" value="evet" onchange="toggleDenetim(true)"> Devam Ediyor</label>
        <label><input type="radio" name="denetimDevam" value="hayir" checked onchange="toggleDenetim(false)"> Ayrılmış / Bilgi Yok</label>
      </div>
      <div id="denetimEvet" class="conditional" style="display:none;">
        <input type="text" id="denetimFirma" placeholder="Yapı Denetim Şirketi Adı" list="h_belgeler_denetimFirma" onfocus="showList(this)">
        <input type="number" id="bitmislikOrani" placeholder="Bitmişlik Oranı (%)" min="0" max="100">
      </div>
    </div>
    <div class="form-group">
      <strong>6. Belgeler Nasıl Teyit Edildi?</strong>
      <div class="radio-group">
        <label><input type="radio" name="belgeGoruldumu" value="görüldü" checked> Görüldü</label>
        <label><input type="radio" name="belgeGoruldumu" value="incelendi"> İncelendi</label>
        <label><input type="radio" name="belgeGoruldumu" value="elektronik ortamda teyit edildi"> Elektronik ortamda teyit edildi</label>
      </div>
    </div>
    <div class="form-group">
      <strong>7. Belediye Arşiv Tespitleri</strong>
      <div class="radio-group">
        <label><input type="radio" name="yikim" value="hayir" checked onchange="toggleYikim(false)"> Olumsuzluk Yok</label>
        <label><input type="radio" name="yikim" value="evet" onchange="toggleYikim(true)"> Olumsuz Karar ve Tespit Tutanağı Var</label>
      </div>
      <textarea id="yikimAciklamaInput" rows="2" placeholder="Olumsuz karar ve tespit tutanağı detayları..."
        list="h_belgeler_yikimAciklamaInput" onfocus="showList(this)"
        style="margin-top:10px; display:none;"></textarea>
    </div>
    <button class="btn-kaydet" onclick="kaydetVeIsle()">KAYDET VE METİN ÜRET</button>
    <button class="btn-geri" onclick="anaMenuyeDon()">GERİ DÖN (ÇIK)</button>
    <div id="taslak" class="taslak" style="display:none;" oncopy="return false"></div>
  </div>
  <div id="datalists">
    <datalist id="h_belgeler_belediye"></datalist>
    <datalist id="h_belgeler_il"></datalist>
    <datalist id="h_belgeler_ilce"></datalist>
    <datalist id="h_belgeler_projeTarihiText"></datalist>
    <datalist id="h_belgeler_denetimFirma"></datalist>
    <datalist id="h_belgeler_yikimAciklamaInput"></datalist>
    <datalist id="h_belgeler_uyumAciklama"></datalist>
    <datalist id="h_belgeler_arsivAda"></datalist>
    <datalist id="h_belgeler_arsivParsel"></datalist>
    <datalist id="h_belgeler_ilaveAlanM2"></datalist>
    <datalist id="h_belgeler_ilaveAlanNot"></datalist>
  </div>
<script>
  /* ========= URL & RAPOR ========= */
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');
  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || {}; // OBJE OLARAK DÜZELTİLDİ
  let report = reports[id] || { belgeler: {}, propertyName: "İsimsiz Gayrimenkul" };
  document.getElementById('propertyName').textContent = report.propertyName || "İsimsiz";

  /* ========= HAFIZA (DATALIST) ========= */
  const fieldsToRemember = [
    'belediye','il','ilce','projeTarihiText','denetimFirma',
    'yikimAciklamaInput','uyumAciklama','arsivAda','arsivParsel',
    'ilaveAlanM2','ilaveAlanNot'
  ];
  function normalizeText(v){ return (v ?? "").toString().trim(); }
  function rememberField(field, value, limit=25){
    const v = normalizeText(value);
    if(!v) return;
    const key = "h_belgeler_" + field;
    const arr = JSON.parse(localStorage.getItem(key)) || [];
    const next = [v, ...arr.filter(x => x !== v)].slice(0, limit);
    localStorage.setItem(key, JSON.stringify(next));
  }
  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function initAutocomplete(){
    fieldsToRemember.forEach(f=>{
      const h = JSON.parse(localStorage.getItem("h_belgeler_"+f)) || [];
      const dl = document.getElementById("h_belgeler_"+f);
      if(dl) dl.innerHTML = h.map(v=>`<option value="${escapeHtml(v)}">`).join("");
    });
  }
  /* ========= KISAYOL ENGEL ========= */
  document.addEventListener('keydown', e => {
    if (e.ctrlKey && ['c','p','s','u'].includes(e.key.toLowerCase())) e.preventDefault();
  });
  /* ========= UTIL ========= */
  function uid(p="x"){ return p+"-"+Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,8); }
  function formatBelediye(name){
    if(!name) return "[Belediye]";
    const n=name.trim();
    if(n.toLowerCase().includes("belediye")) return n;
    return n+" Belediyesi";
  }
  function showList(input){
    input.setAttribute("autocomplete","off");
    const v=input.value;
    input.value="";
    setTimeout(()=>input.value=v,1);
  }
  function toggleFarkliParsel(){
    const evet = document.querySelector('input[name="farkliParsel"]:checked')?.value === "evet";
    document.getElementById('farkliParselDetay').style.display = evet ? "flex" : "none";
  }
  function checkBila(){
    const t = (document.getElementById('projeTarihiText').value || "").toLowerCase();
    const d = document.getElementById('projeTarihi');
    const bila = t.includes("bila");
    d.disabled = bila;
    if(bila) d.value = "";
  }
  function toggleUyumDetay() {
    const uyum = document.querySelector('input[name="uyum"]:checked')?.value || "evet";
    const temelAciklama = document.getElementById('uyumAciklama');
    const ilaveCheckboxDiv = document.getElementById('uyumIlaveCheckbox');
    const show = (uyum === 'hayir' || uyum === 'kismen');
    temelAciklama.style.display = show ? 'block' : 'none';
    ilaveCheckboxDiv.style.display = show ? 'block' : 'none';
    if(!show){
      document.getElementById('ilaveAlanTik').checked = false;
      document.getElementById('ilaveAlanBox').style.display = 'none';
      document.getElementById('ilaveAlanM2').value = '';
      document.getElementById('ilaveAlanNot').value = '';
    } else {
      toggleIlaveAlan();
    }
  }
  function toggleIlaveAlan() {
    const tik = document.getElementById('ilaveAlanTik').checked;
    document.getElementById('ilaveAlanBox').style.display = tik ? 'block' : 'none';
    if(!tik){
      document.getElementById('ilaveAlanM2').value = '';
      document.getElementById('ilaveAlanNot').value = '';
    }
  }
  function toggleIskan(show) {
    document.getElementById('iskanSection').style.display = show ? 'block' : 'none';
    document.getElementById('yapiDenetimSection').style.display = show ? 'none' : 'block';
    if (show && document.getElementById('iskanList').children.length === 0) addIskan();
    if (!show) {
      const den = document.querySelector('input[name="denetimDevam"]:checked')?.value || "hayir";
      toggleDenetim(den === "evet");
    }
  }
  function toggleYikim(show) {
    document.getElementById('yikimAciklamaInput').style.display = show ? 'block' : 'none';
    if(!show) document.getElementById('yikimAciklamaInput').value = "";
  }
  function toggleDenetim(show) {
    document.getElementById('denetimEvet').style.display = show ? 'block' : 'none';
    if(!show){
      document.getElementById('denetimFirma').value = "";
      document.getElementById('bitmislikOrani').value = "";
    }
  }
  function formatDateTR(yyyy_mm_dd){
    const v = normalizeText(yyyy_mm_dd);
    if(!v) return "";
    const parts = v.split("-");
    if(parts.length !== 3) return v;
    const [y,m,d] = parts;
    return `${d}.${m}.${y}`;
  }
  function humanProjeTarihi(b){
    const d = normalizeText(b.projeTarihi);
    const t = normalizeText(b.projeTarihiText);
    if(d) return formatDateTR(d);
    if(t) return t;
    return "Belirtilmemiş";
  }
  function uyumCümle(uyum){
    if(uyum === "hayir") return "uyumlu değildir";
    if(uyum === "kismen") return "kısmen uyumludur";
    return "uyumludur";
  }
  /* ========= RUHSAT ========= */
  function addRuhsat(data={}){
    const list=document.getElementById('ruhsatList');
    const rid=data._rid||uid("rk");
    const k=data.kapsam||"tamami";
    const el=document.createElement("div");
    el.className="dynamic-item";
    el.dataset.rid=rid;
    el.innerHTML=`
      <div><strong>Tarih</strong><input type="date" class="r-tarih" value="${escapeHtml(data.tarih||'')}"></div>
      <div><strong>No</strong><input type="text" class="r-no" value="${escapeHtml(data.no||'')}"></div>
      <div><strong>Amacı</strong><input type="text" class="r-amac" value="${escapeHtml(data.amac||'')}"></div>
      <div><strong>Kapsam</strong><br>
        <label><input type="radio" name="${rid}" value="tamami" ${k==="tamami"?"checked":""}> Tam</label>
        <label><input type="radio" name="${rid}" value="kismi" ${k==="kismi"?"checked":""}> Kısmi</label>
      </div>
      <div class="kismi-box" style="display:${k==="kismi"?"block":"none"};width:100%">
        <input type="text" class="r-kismi" placeholder="Kısmi açıklama..." value="${escapeHtml(data.kismi_text||"")}">
      </div>
      <button class="remove-btn" onclick="this.parentElement.remove()">X</button>
    `;
    list.appendChild(el);
    el.querySelectorAll(`input[name="${rid}"]`).forEach(r=>{
      r.onchange=()=>{
        const box = el.querySelector(".kismi-box");
        box.style.display = (r.value==="kismi") ? "block" : "none";
        if(r.value!=="kismi"){
          const inp = el.querySelector(".r-kismi");
          if(inp) inp.value = "";
        }
      };
    });
  }
  /* ========= İSKAN ========= */
  function addIskan(data={}){
    const list=document.getElementById('iskanList');
    const iid=data._iid||uid("ik");
    const k=data.kapsam||"tamami";
    const el=document.createElement("div");
    el.className="dynamic-item";
    el.dataset.iid=iid;
    el.innerHTML=`
      <div><strong>Tarih</strong><input type="date" class="i-tarih" value="${escapeHtml(data.tarih||'')}"></div>
      <div><strong>No</strong><input type="text" class="i-no" value="${escapeHtml(data.no||'')}"></div>
      <div><strong>Amacı</strong><input type="text" class="i-amac" value="${escapeHtml(data.amac||"Yapı Kullanma İzin Belgesi")}"></div>
      <div><strong>Kapsam</strong><br>
        <label><input type="radio" name="${iid}" value="tamami" ${k==="tamami"?"checked":""}> Tam</label>
        <label><input type="radio" name="${iid}" value="kismi" ${k==="kismi"?"checked":""}> Kısmi</label>
      </div>
      <div class="kismi-box" style="display:${k==="kismi"?"block":"none"};width:100%">
        <input type="text" class="i-kismi" placeholder="Kısmi açıklama..." value="${escapeHtml(data.kismi_text||"")}">
      </div>
      <button class="remove-btn" onclick="this.parentElement.remove()">X</button>
    `;
    list.appendChild(el);
    el.querySelectorAll(`input[name="${iid}"]`).forEach(r=>{
      r.onchange=()=>{
        const box = el.querySelector(".kismi-box");
        box.style.display = (r.value==="kismi") ? "block" : "none";
        if(r.value!=="kismi"){
          const inp = el.querySelector(".i-kismi");
          if(inp) inp.value = "";
        }
      };
    });
  }
  /* ========= BELGE ÖZET SATIRI ========= */
  function ruhsatOzetSatiri(r){
    const tarih = r.tarih ? formatDateTR(r.tarih) : "Tarih belirtilmemiş";
    const no = normalizeText(r.no) || "No belirtilmemiş";
    const amac = normalizeText(r.amac) || "Yeni yapı yapı ruhsatı";
    const kapsam = r.kapsam === "kismi"
      ? `kısmi (${normalizeText(r.kismi_text) || "Açıklama yok"})`
      : "binanın tamamı";
    return `${tarih} tarih ${no} sayılı ${kapsam} için düzenlenmiş ${amac}.`;
  }
  function iskanOzetSatiri(i){
    const tarih = i.tarih ? formatDateTR(i.tarih) : "Tarih belirtilmemiş";
    const no = normalizeText(i.no) || "No belirtilmemiş";
    const amac = normalizeText(i.amac) || "Yapı Kullanma İzin Belgesi (İskân)";
    const kapsam = i.kapsam === "kismi"
      ? `kısmi (${normalizeText(i.kismi_text) || "Açıklama yok"})`
      : "binanın tamamı";
    return `${tarih} tarih ${no} sayılı ${kapsam} için düzenlenmiş ${amac}.`;
  }
  function fmtM2(v){
    const n = normalizeText(v);
    if(!n) return "";
    const tr = n.replace(".", ",");
    return `${tr} m²`;
  }
  /* ========= LOAD ========= */
  window.addEventListener('load', () => {
    initAutocomplete();
    toggleUyumDetay();
    toggleFarkliParsel();
    toggleYikim(false);
    checkBila();
    if(report.belgeler){
      const b=report.belgeler;
      document.getElementById('belediye').value=b.belediyeRaw || '';
      document.getElementById('il').value=b.il||"";
      document.getElementById('ilce').value=b.ilce||"";
      document.getElementById('projeTarihi').value=b.projeTarihi || '';
      document.getElementById('projeTarihiText').value=b.projeTarihiText || '';
      checkBila();
      if(b.uyum) {
        const uy = document.querySelector(`input[name="uyum"][value="${b.uyum}"]`);
        if(uy) uy.checked = true;
      }
      toggleUyumDetay();
      document.getElementById('uyumAciklama').value = b.uyumAciklama || '';
      document.getElementById('ilaveAlanTik').checked = !!b.ilaveAlanTik;
      document.getElementById('ilaveAlanM2').value = b.ilaveAlanM2 || '';
      document.getElementById('ilaveAlanNot').value = b.ilaveAlanNot || '';
      toggleIlaveAlan();
      if(b.belgeGoruldumu){
        const bg = document.querySelector(`input[name="belgeGoruldumu"][value="${b.belgeGoruldumu}"]`);
        if(bg) bg.checked = true;
      }
      if(b.yikimKarari){
        const yk = document.querySelector(`input[name="yikim"][value="${b.yikimKarari}"]`);
        if(yk) yk.checked = true;
      }
      document.getElementById('yikimAciklamaInput').value = b.yikimAciklamaInput || '';
      toggleYikim(b.yikimKarari === 'evet');
      if(b.denetimDevam){
        const dd = document.querySelector(`input[name="denetimDevam"][value="${b.denetimDevam}"]`);
        if(dd) dd.checked = true;
      }
      document.getElementById('denetimFirma').value = b.denetimFirma || '';
      document.getElementById('bitmislikOrani').value = b.bitmislikOrani || '';
      if(b.farkliParsel === 'evet') {
        const fp = document.querySelector('input[name="farkliParsel"][value="evet"]`);
        if(fp) fp.checked = true;
      }
      toggleFarkliParsel();
      document.getElementById('arsivAda').value = b.arsivAda || '';
      document.getElementById('arsivParsel').value = b.arsivParsel || '';
      document.getElementById('ruhsatList').innerHTML = "";
      if(b.ruhsatlar?.length) b.ruhsatlar.forEach(addRuhsat);
      else addRuhsat();
      if(b.iskanVar === 'evet') {
        const iv = document.querySelector('input[name="iskanVar"][value="evet"]');
        if(iv) iv.checked = true;
        toggleIskan(true);
        document.getElementById('iskanList').innerHTML = "";
        if(b.iskanlar?.length) b.iskanlar.forEach(addIskan);
        else addIskan();
      } else {
        toggleIskan(false);
      }
    } else {
      addRuhsat();
      toggleIskan(false);
      toggleDenetim(false);
    }
  });
  /* ========= KAYDET VE METİN ÜRET ========= */
  function kaydetVeIsle() {
    const b = {};
    b.belediyeRaw = normalizeText(document.getElementById('belediye').value);
    b.belediye = formatBelediye(b.belediyeRaw);
    b.il = normalizeText(document.getElementById('il').value);
    b.ilce = normalizeText(document.getElementById('ilce').value);
    b.projeTarihi = document.getElementById('projeTarihi').value;
    b.projeTarihiText = normalizeText(document.getElementById('projeTarihiText').value);
    b.uyum = document.querySelector('input[name="uyum"]:checked')?.value || "evet";
    b.uyumAciklama = normalizeText(document.getElementById('uyumAciklama').value);
    b.ilaveAlanTik = !!document.getElementById('ilaveAlanTik').checked;
    b.ilaveAlanM2 = normalizeText(document.getElementById('ilaveAlanM2').value);
    b.ilaveAlanNot = normalizeText(document.getElementById('ilaveAlanNot').value);
    b.belgeGoruldumu = document.querySelector('input[name="belgeGoruldumu"]:checked')?.value || "görüldü";
    b.yikimKarari = document.querySelector('input[name="yikim"]:checked')?.value || "hayir";
    b.yikimAciklamaInput = normalizeText(document.getElementById('yikimAciklamaInput').value);
    b.denetimDevam = document.querySelector('input[name="denetimDevam"]:checked')?.value || "hayir";
    b.denetimFirma = normalizeText(document.getElementById('denetimFirma').value);
    b.bitmislikOrani = normalizeText(document.getElementById('bitmislikOrani').value);
    b.farkliParsel = document.querySelector('input[name="farkliParsel"]:checked')?.value || "hayir";
    b.arsivAda = normalizeText(document.getElementById('arsivAda').value);
    b.arsivParsel = normalizeText(document.getElementById('arsivParsel').value);
    b.iskanVar = document.querySelector('input[name="iskanVar"]:checked')?.value || "hayir";
    b.ruhsatlar = Array.from(document.querySelectorAll('#ruhsatList .dynamic-item')).map(el => ({
      _rid: el.dataset.rid,
      tarih: el.querySelector('.r-tarih')?.value || "",
      no: normalizeText(el.querySelector('.r-no')?.value),
      amac: normalizeText(el.querySelector('.r-amac')?.value),
      kapsam: el.querySelector('input[name="'+el.dataset.rid+'"]:checked')?.value || "tamami",
      kismi_text: normalizeText(el.querySelector('.r-kismi')?.value)
    })).filter(x => x.tarih || x.no || x.amac || x.kismi_text);
    if (b.iskanVar === 'evet') {
      b.iskanlar = Array.from(document.querySelectorAll('#iskanList .dynamic-item')).map(el => ({
        _iid: el.dataset.iid,
        tarih: el.querySelector('.i-tarih')?.value || "",
        no: normalizeText(el.querySelector('.i-no')?.value),
        amac: normalizeText(el.querySelector('.i-amac')?.value) || "Yapı Kullanma İzin Belgesi (İskân)",
        kapsam: el.querySelector('input[name="'+el.dataset.iid+'"]:checked')?.value || "tamami",
        kismi_text: normalizeText(el.querySelector('.i-kismi')?.value)
      })).filter(x => x.tarih || x.no || x.amac || x.kismi_text);
    } else {
      b.iskanlar = [];
    }
    // Hafıza kaydet
    fieldsToRemember.forEach(f => {
      const val = normalizeText(document.getElementById(f === 'belediye' ? 'belediye' : f === 'ilaveAlanM2' ? 'ilaveAlanM2' : f === 'ilaveAlanNot' ? 'ilaveAlanNot' : f)?.value);
      if(val) rememberField(f, val);
    });
    // Rapor kaydet
    report.belgeler = b;
    reports[id] = report; // obje olarak
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    initAutocomplete();
    // Metin üret (orijinal metin mantığı korundu)
    const projeT = humanProjeTarihi(b);
    const uyumTxt = uyumCümle(b.uyum);
    const belediyeKisa = (normalizeText(b.belediyeRaw) || "İlgili");
    const tapuBelediye = `${belediyeKisa} Tapu Müdürlüğü ve ${belediyeKisa} Belediyesi'nde`;
    const parts = [];
    parts.push("Taşınmazın bulunduğu ana taşınmazın konumu imar paftasıyla uyumludur.");
    let uyumCumle = `${tapuBelediye} incelenen ${projeT} tarihli projesiyle ${uyumTxt}.`;
    if((b.uyum === "hayir" || b.uyum === "kismen") && b.uyumAciklama){
      uyumCumle += ` ${b.uyumAciklama}`;
    }
    parts.push(uyumCumle);
    if(b.ilaveAlanTik && normalizeText(b.ilaveAlanM2)){
      const m2 = fmtM2(b.ilaveAlanM2);
      let ilaveCumle = `İlave alan ${m2} olarak beyan edilmiştir.`;
      if(b.ilaveAlanNot) ilaveCumle += ` ${b.ilaveAlanNot}`;
      parts.push(ilaveCumle);
    }
    if(b.ruhsatlar.length){
      const r0 = b.ruhsatlar[0];
      const tarih = r0.tarih ? formatDateTR(r0.tarih) : "Tarih belirtilmemiş";
      const no = normalizeText(r0.no) || "No belirtilmemiş";
      const amac = normalizeText(r0.amac) || "Yeni yapı yapı ruhsatı";
      const kapsamTxt = (r0.kapsam === "kismi") ? "kısmi" : "binanın tamı için";
      parts.push(`Yapı için; ${tarih} tarih ${no} sayılı ${kapsamTxt} düzenlenmiş ${amac} görülmüştür.`);
    } else {
      parts.push("Yapı ruhsatına ilişkin belge sunulmamıştır.");
    }
    if(b.iskanVar === "evet"){
      parts.push("Taşınmazın Yapı Kullanma İzin Belgesi (İskân) bulunmaktadır.");
    } else {
      parts.push("Taşınmazın Yapı Kullanma İzin Belgesi (İskân) bulunmamaktadır.");
      if(b.denetimDevam === "evet"){
        const firma = b.denetimFirma || "ilgili";
        const oran = b.bitmislikOrani ? `%${b.bitmislikOrani}` : "%0";
        parts.push(`Yapının yapı denetimi ${firma} şirketi tarafından yapı denetime devam edildiği, bitmişlik oranının ${oran} olduğu ilgili belediyesinden öğrenilmiştir.`);
      }
    }
    if(b.yikimKarari === "evet"){
      const det = b.yikimAciklamaInput || "Detay belirtilmemiştir.";
      parts.push(`Belediye arşivinde olumsuz karar ve tespit tutanağı bulunduğu görülmüştür. ${det}`);
    } else {
      parts.push("Belediye arşivinde herhangi bir olumsuz karar ve tespit tutanağına rastlanmamıştır.");
    }
    if(b.farkliParsel === "evet"){
      const ada = b.arsivAda || "Belirtilmemiş";
      const parsel = b.arsivParsel || "Belirtilmemiş";
      parts.push(`Belgelerin farklı ada/parsel için düzenlendiği beyan edilmiştir (Arşiv: ${ada}/${parsel}).`);
    }
    const paragraf = parts.join(" ");
    const bullets = [];
    b.ruhsatlar.forEach(r => bullets.push(ruhsatOzetSatiri(r)));
    if(b.iskanVar === "evet") b.iskanlar.forEach(i => bullets.push(iskanOzetSatiri(i)));
    if(!bullets.length) bullets.push("Belge özeti bulunmamaktadır.");
    const metin = `${paragraf}\n\nBELGE ÖZETLERİ:\n- ${bullets.join("\n- ")}`;
    document.getElementById('taslak').textContent = metin;
    document.getElementById('taslak').style.display = 'block';
    alert("Kaydedildi ve metin üretildi!");
  }
  function anaMenuyeDon() {
    window.location.href = `rapor-detay.html?id=${id || ''}`;
  }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tapu KayÄ±t Otomasyonu - Takyidat DetaylÄ±</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body { background-color: #f8f9fa; padding: 25px; font-family: 'Segoe UI', sans-serif; }
    .card { border-radius: 15px; border: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
    .result-body {
      background: white; border: 2px solid #dee2e6; padding: 20px; border-radius: 10px;
      white-space: pre-wrap; font-size: 13px; margin-bottom: 25px;
      filter: blur(2.5px); transition: 0.3s; cursor: text; line-height: 1.6;
    }
    .result-body:hover { filter: blur(0); }
    .engel-evet { background-color: #fff0f0 !important; }
    .btn-geri { background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; }
    .btn-save-final { background: #198754; color: white; padding: 20px; font-size: 1.2rem; font-weight: bold; border-radius: 12px; transition: 0.3s; box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3); border: none; width: 100%; margin-top: 30px; }
    .save-status { display: none; color: #198754; font-weight: bold; margin-top: 10px; text-align: center; border: 1px solid #198754; padding: 10px; border-radius: 8px; background: #e8f5e9; }
    .format-label { font-weight: bold; color: #4a148c; margin-bottom: 5px; display: block; text-decoration: underline; }
  </style>
</head>

<body oncontextmenu="return false;">
<div class="container-fluid">
  <div class="card p-4">
    <div class="mb-3">
      <button onclick="anaMenuyeDon()" class="btn-geri">â† ANA MENÃœYE DÃ–N</button>
    </div>

    <h4 class="text-primary mb-4 border-bottom pb-2 text-center">Tapu KayÄ±t GiriÅŸ EkranÄ±</h4>

    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label fw-bold">Takbis Tarihi</label>
        <input type="date" id="tarihInput" class="form-control border-primary" oninput="guncelle()">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Ä°nceleme Saati</label>
        <input type="time" id="saatInput" class="form-control border-primary" oninput="guncelle()">
      </div>
    </div>

    <h5 class="mt-4">Takyidatlar</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>Takyidat TÃ¼rÃ¼</th>
            <th>AÃ§Ä±klama</th>
            <th>Tarih</th>
            <th>SayÄ±</th>
            <th>Engel mi?</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="tabloGÃ¶vde"></tbody>
      </table>
      <button class="btn btn-dark btn-sm" onclick="takyidatEkle()">+ Yeni Takyidat Ekle</button>
    </div>

    <h5 class="mt-4">Malikler</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-primary">
          <tr>
            <th>Ad Soyad</th>
            <th>Pay / Payda</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="malikGÃ¶vde"></tbody>
      </table>
      <button class="btn btn-primary btn-sm" onclick="malikEkle()">+ Yeni Malik Ekle</button>
    </div>

    <button class="btn btn-save-final" onclick="kaydet()">TAPU VERÄ°LERÄ°NÄ° VE METÄ°NLERÄ° KAYDET</button>
    <div id="saveStatus" class="save-status">âœ… Kaydedildi ve Buluta Senkronize Edildi!</div>
  </div>

  <!-- âœ… Tek Metin (B1+B2) -->
  <span class="format-label">ğŸ“„ TEK METÄ°N (B1 + B2)</span>
  <div class="result-body" id="tek_sonuc"></div>

  <!-- (Ä°stersen kalsÄ±n diye ayrÄ± ayrÄ± da gÃ¶steriyorum) -->
  <span class="format-label">ğŸ“„ BANKA FORMATI B1</span>
  <div class="result-body" id="b1_sonuc"></div>

  <span class="format-label">ğŸ“„ BANKA FORMATI B2</span>
  <div class="result-body" id="b2_sonuc"></div>
</div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + migration ========= */
  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  const legacyId = urlParams.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed = false;
    (arr || []).forEach(r => { if (r && !r.rid) { r.rid = genRid(); changed = true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr || []).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  // legacy id -> rid (geriye dÃ¶nÃ¼k uyum)
  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      window.location.replace("tapu_kayit.html?rid=" + encodeURIComponent(rid));
    }
  }

  const idx = rid ? findIndexByRid(reports, rid) : -1;
  let report = (idx >= 0) ? (reports[idx] || {}) : null;

  auth.onAuthStateChanged((user) => {
    if (!user || !rid || !report) {
      window.location.href = 'index.html';
      return;
    }
    initFromReport();
  });

  /* ========= Buluta gÃ¶nder ========= */
  async function bulutaGonder() {
    const user = auth.currentUser;
    if (user) {
      const tumRaporlar = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
      await db.collection("users").doc(user.uid).set({
        gayrimenkul_reports: tumRaporlar,
        sonGuncelleme: new Date().toISOString()
      }, { merge: true });
    }
  }

  /* ========= Takyidat / Malik ========= */
  function takyidatEkle(v1='', v2='', v3='', v4='', v5='hayir') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="form-control t-tur" value="${v1}" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-acik" value="${v2}" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-tar" value="${v3}" placeholder="GG.AA.YYYY" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-say" value="${v4}" oninput="guncelle()"></td>
      <td>
        <select class="form-select t-engel" onchange="renkGuncelle(this); guncelle();">
          <option value="hayir" ${v5=='hayir'?'selected':''}>HayÄ±r</option>
          <option value="evet" ${v5=='evet'?'selected':''}>Evet</option>
        </select>
      </td>
      <td><button class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); guncelle()">X</button></td>
    `;
    document.getElementById('tabloGÃ¶vde').appendChild(tr);
    renkGuncelle(tr.querySelector('select'));
  }

  function malikEkle(ad='', pay='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="form-control m-ad" value="${ad}" placeholder="Ad Soyad" oninput="guncelle()"></td>
      <td><input type="text" class="form-control m-pay" value="${pay}" readonly></td>
      <td><button class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); payHesapla(); guncelle()">X</button></td>
    `;
    document.getElementById('malikGÃ¶vde').appendChild(tr);
    payHesapla();
  }

  function payHesapla() {
    const rows = document.querySelectorAll('#malikGÃ¶vde tr');
    rows.forEach(row => { row.querySelector('.m-pay').value = `1/${rows.length}`; });
  }

  function renkGuncelle(s) {
    if(s) s.closest('tr').classList.toggle('engel-evet', s.value === 'evet');
  }

  /* ========= Metin Ã¼retim (B1, B2, TEK) ========= */
  function guncelle() {
    const tVal = document.getElementById('tarihInput').value;
    const tarihTakbis = tVal ? tVal.split('-').reverse().join('.') : "....";
    const saatTakbis = document.getElementById('saatInput').value || "....";

    let hayirlar = [];
    let evetler = [];

    document.querySelectorAll('#tabloGÃ¶vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      const acik = row.querySelector('.t-acik').value.trim();
      const tar = row.querySelector('.t-tar').value.trim();
      const say = row.querySelector('.t-say').value.trim();
      const engelMi = row.querySelector('.t-engel').value;

      if(tur || acik) {
        let detay = `${tur} ${acik}`.trim();
        if(tar) detay += ` Tarih: ${tar}`;
        if(say) detay += ` SayÄ±: ${say}`;
        if(engelMi === 'evet') evetler.push(detay); else hayirlar.push(detay);
      }
    });

    let malikMetni = "";
    document.querySelectorAll('#malikGÃ¶vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if(ad) malikMetni += `- ${ad} (Hisse: ${row.querySelector('.m-pay').value})\n`;
    });

    // B1
    let b1 = `YASAL KISITLAMALAR (Åerh, Rehin, Beyan, Ä°potek, Haciz ve DiÄŸer Haklar)\n\n` +
      `TKGM Portal Takbis Sisteminden Takbis Tarihi: ${tarihTakbis} tarihinde Ä°nceleme Saati: ${saatTakbis} itibariyle yapÄ±lan incelemede konu taÅŸÄ±nmazÄ±n tapu kaydÄ± Ã¼zerinde aÅŸaÄŸÄ±daki bilgilere ulaÅŸÄ±lmÄ±ÅŸtÄ±r:\n\n`;

    b1 += (hayirlar.length > 0 ? hayirlar.join(", ") : "Herhangi bir takyidat bulunmamaktadÄ±r.") + ".\n\n";
    b1 += "TaÅŸÄ±nmaz Ã¼zerinde yer alan kayÄ±tlarÄ±n taÅŸÄ±nmazÄ±n satÄ±ÅŸÄ±na engel teÅŸkil etmediÄŸi bilgisi alÄ±nmÄ±ÅŸtÄ±r.";

    if(evetler.length > 0) {
      b1 += `\n\nSATIÅA ENGEL TEÅKÄ°L EDEN DURUMLAR: ${evetler.join(", ")}`;
    }

    b1 += `\n\nMALÄ°K BÄ°LGÄ°LERÄ°:\n${malikMetni || "Girilmedi."}`;

    // B2
    let b2 = `TAPU KAYIT VE TAKYÄ°DAT ANALÄ°ZÄ°\n\n` +
      `Takbis Tarihi: ${tarihTakbis} / Ä°nceleme Saati: ${saatTakbis}\n\n`;

    b2 += `MEVCUT TAKYÄ°DATLAR:\n${hayirlar.map(h => "â€¢ " + h).join("\n") || "- KayÄ±t Yok"}\n\n`;
    if(evetler.length > 0) {
      b2 += `ENGEL TEÅKÄ°L EDEN KAYITLAR:\n${evelterFix(evetler).map(e => "â€¢ " + e).join("\n")}\n\n`;
    }
    b2 += `MÃœLKÄ°YET YAPISI:\n${malikMetni || "- Bilgi Yok"}`;

    // âœ… TEK METÄ°N (B1 + B2)
    const tek = b1 + "\n\n----------------------------------------\n\n" + b2;

    document.getElementById('b1_sonuc').innerText = b1;
    document.getElementById('b2_sonuc').innerText = b2;
    document.getElementById('tek_sonuc').innerText = tek;

    return { b1, b2, tek };
  }

  // kÃ¼Ã§Ã¼k gÃ¼venlik: evetler null gelirse
  function evelterFix(arr){ return Array.isArray(arr) ? arr : []; }

  /* ========= Kaydet ========= */
  async function kaydet() {
    const metinler = guncelle();

    let takyidatData = [];
    let takyidatVar = false;

    document.querySelectorAll('#tabloGÃ¶vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      if(tur.length > 1) takyidatVar = true;

      takyidatData.push({
        tur: tur,
        acik: row.querySelector('.t-acik').value,
        tar: row.querySelector('.t-tar').value,
        say: row.querySelector('.t-say').value,
        engel: row.querySelector('.t-engel').value
      });
    });

    let malikData = [];
    let malikVar = false;

    document.querySelectorAll('#malikGÃ¶vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if(ad.length > 1) malikVar = true;

      malikData.push({
        ad: ad,
        pay: row.querySelector('.m-pay').value
      });
    });

    const tarih = document.getElementById('tarihInput').value;
    const saat  = document.getElementById('saatInput').value;

    const eksik = (!tarih || !saat || !takyidatVar || !malikVar);
    if (eksik) {
      if (!confirm("âš ï¸ BazÄ± teknik alanlar boÅŸ! Yine de 'Eksik KayÄ±t' olarak mÃ¼hÃ¼rlensin mi?")) return;
    }

    // âœ… RIDâ€™li doÄŸru rapora yaz
    reports[idx] = {
      ...reports[idx],
      tapuTarih: tarih,
      tapuSaat: saat,
      tapuTakyidatDizi: takyidatData,
      tapuMalikDizi: malikData,

      // eski alanlar dursun
      tapuMetniB1: metinler.b1,
      tapuMetniB2: metinler.b2,

      // âœ… YENÄ°: tek metin alanÄ±
      tapuMetniTek: metinler.tek,

      tapu_tamamlandi: !eksik
    };

    localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    await bulutaGonder();

    const status = document.getElementById('saveStatus');
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 3000);
  }

  function anaMenuyeDon() {
    window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
  }

  function initFromReport(){
    if(report.tapuTarih) document.getElementById('tarihInput').value = report.tapuTarih;
    if(report.tapuSaat) document.getElementById('saatInput').value = report.tapuSaat;

    // takyidat
    document.getElementById('tabloGÃ¶vde').innerHTML = "";
    if(report.tapuTakyidatDizi && report.tapuTakyidatDizi.length > 0) {
      report.tapuTakyidatDizi.forEach(d => takyidatEkle(d.tur, d.acik, d.tar, d.say, d.engel));
    } else {
      takyidatEkle();
    }

    // malik
    document.getElementById('malikGÃ¶vde').innerHTML = "";
    if(report.tapuMalikDizi && report.tapuMalikDizi.length > 0) {
      report.tapuMalikDizi.forEach(m => malikEkle(m.ad, m.pay));
    } else {
      malikEkle();
    }

    guncelle();
  }
</script>
</body>
</html>

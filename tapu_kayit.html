<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tapu Kayƒ±t Otomasyonu - Takyidat Detaylƒ±</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
  body{
    background-color:#f8f9fa;
    padding:25px;
    font-family:'Segoe UI',sans-serif;
  }

  .card{
    border-radius:15px;
    border:none;
    box-shadow:0 5px 20px rgba(0,0,0,0.1);
    margin-bottom:30px;
  }

  .result-body{
    background:white;
    border:2px solid #dee2e6;
    padding:20px;
    border-radius:10px;
    white-space:pre-wrap;
    font-size:13px;
    margin-bottom:25px;
    filter:blur(2.5px);
    transition:.3s;
    cursor:text;
    line-height:1.6;
    -webkit-user-select:none;
    -moz-user-select:none;
    -ms-user-select:none;
    user-select:none;
  }
  .result-body:hover{ filter:blur(0); }

  .engel-evet{ background-color:#fff0f0 !important; }

  .btn-geri{
    background:#d32f2f;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
  }

  .btn-save-final{
    background:#198754;
    color:white;
    padding:20px;
    font-size:1.2rem;
    font-weight:bold;
    border-radius:12px;
    box-shadow:0 4px 15px rgba(25,135,84,.3);
    border:none;
    width:100%;
    margin-top:30px;
  }

  .save-status{
    display:none;
    color:#198754;
    font-weight:bold;
    margin-top:10px;
    text-align:center;
    border:1px solid #198754;
    padding:10px;
    border-radius:8px;
    background:#e8f5e9;
  }

  .format-label{
    font-weight:bold;
    color:#4a148c;
    margin-bottom:5px;
    display:block;
    text-decoration:underline;
  }

  .engel-aciklama{
    margin-top:6px;
    display:none;
  }
  .engel-aciklama input{ font-size:12.5px; }

  /* ===============================
     üì± MOBƒ∞L GERƒ∞ D√ñN BUTONU
     =============================== */
  .mobile-back-wrap{
    display:none;
    margin-top:25px;
  }

  @media (max-width:768px){
    body{ padding:15px; }

    .mobile-back-wrap{
      display:block;
    }

    .mobile-back-btn{
      width:100%;
      background:#d32f2f;
      color:white;
      border:none;
      padding:14px;
      border-radius:14px;
      font-weight:bold;
      font-size:1.05rem;
      box-shadow:0 4px 15px rgba(211,47,47,.35);
    }
      @media (max-width: 768px){
  #label_b1, #label_b2,
  #b1_sonuc, #b2_sonuc{
    display:none !important;
  }
}

    }

</style>

  <link rel="stylesheet" href="mobil-fix.css">
</head>

<body>
<div class="container-fluid">

  <div class="card p-4">
    <div class="mb-3">
      <button onclick="anaMenuyeDon()" class="btn-geri">‚Üê ANA MEN√úYE D√ñN</button>
    </div>

    <h4 class="text-primary mb-4 border-bottom pb-2 text-center">Tapu Kayƒ±t Giri≈ü Ekranƒ±</h4>

    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label fw-bold">Takbis Tarihi</label>
        <input type="date" id="tarihInput" class="form-control border-primary" oninput="guncelle()">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">ƒ∞nceleme Saati</label>
        <input type="time" id="saatInput" class="form-control border-primary" oninput="guncelle()">
      </div>
    </div>

    <h5 class="mt-4">Takyidatlar</h5>
    
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>Takyidat T√ºr√º</th>
            <th>A√ßƒ±klama</th>
            <th>Tarih</th>
            <th>Sayƒ±</th>
            <th>Engel mi?</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody id="tabloG√∂vde"></tbody>
      </table>
      <button class="btn btn-dark btn-sm" onclick="takyidatEkle()">+ Yeni Takyidat Ekle</button>
    </div>

    <h5 class="mt-4">Malikler</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-primary">
          <tr>
            <th>Ad Soyad</th>
            <th>Pay / Payda</th>
            <th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody id="malikG√∂vde"></tbody>
      </table>
      <button class="btn btn-primary btn-sm" onclick="malikEkle()">+ Yeni Malik Ekle</button>
    </div>

    <button class="btn btn-save-final" onclick="kaydet()">TAPU VERƒ∞LERƒ∞Nƒ∞ VE METƒ∞NLERƒ∞ KAYDET</button>
    <div id="saveStatus" class="save-status">‚úÖ Kaydedildi ve Buluta Senkronize Edildi!</div>
  </div>
<div class="mobile-back-wrap">
  <button class="mobile-back-btn" onclick="anaMenuyeDon()">
    ‚Üê ANA MEN√úYE D√ñN
  </button>
</div>

<span id="label_tek" class="format-label">üìÑ TEK METƒ∞N (B1 + B2)</span>
<div class="result-body" id="tek_sonuc" oncopy="return false"></div>

<span id="label_b1" class="format-label">üìÑ BANKA FORMATI B1</span>
<div class="result-body" id="b1_sonuc" oncopy="return false"></div>

<span id="label_b2" class="format-label">üìÑ BANKA FORMATI B2</span>
<div class="result-body" id="b2_sonuc" oncopy="return false"></div>
</div>


<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + migration ========= */
  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  const legacyId = urlParams.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed = false;
    (arr || []).forEach(r => { if (r && !r.rid) { r.rid = genRid(); changed = true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr || []).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      window.location.replace("tapu_kayit.html?rid=" + encodeURIComponent(rid));
    }
  }

  const idx = rid ? findIndexByRid(reports, rid) : -1;
  let report = (idx >= 0) ? (reports[idx] || {}) : null;

  auth.onAuthStateChanged((user) => {
    if (!user || !rid || !report) { window.location.href = 'index.html'; return; }
    initFromReport();
  });

  document.addEventListener('contextmenu', (e) => {
    const isInput = e.target.closest('input, textarea, select');
    if (isInput) return;
    e.preventDefault();
  });

  async function bulutaGonder() {
    const user = auth.currentUser;
    if (user) {
      const tumRaporlar = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
      await db.collection("users").doc(user.uid).set({
        gayrimenkul_reports: tumRaporlar,
        sonGuncelleme: new Date().toISOString()
      }, { merge: true });
    }
  }

  function escapeHtml(str){
    return (str ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function takyidatEkle(tur='', acik='', tar='', say='', engel='hayir', engelAciklama='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <input type="text" class="form-control t-tur" value="${escapeHtml(tur)}" oninput="guncelle()">
      </td>

      <td>
        <input type="text" class="form-control t-acik" value="${escapeHtml(acik)}" oninput="guncelle()">
        <div class="engel-aciklama">
          <input type="text" class="form-control t-engel-acik" placeholder="Engel a√ßƒ±klamasƒ± (kƒ±sa not)..." value="${escapeHtml(engelAciklama)}" oninput="guncelle()">
        </div>
      </td>

      <td><input type="text" class="form-control t-tar" value="${escapeHtml(tar)}" placeholder="GG.AA.YYYY" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-say" value="${escapeHtml(say)}" oninput="guncelle()"></td>

      <td>
        <select class="form-select t-engel">
          <option value="hayir" ${engel==='hayir'?'selected':''}>Hayƒ±r</option>
          <option value="evet" ${engel==='evet'?'selected':''}>Evet</option>
        </select>
      </td>

      <td>
        <button class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); guncelle()">X</button>
      </td>
    `;

    document.getElementById('tabloG√∂vde').appendChild(tr);

    const sel = tr.querySelector('.t-engel');
    sel.addEventListener('change', () => { toggleEngelUI(tr); guncelle(); });

    toggleEngelUI(tr);
    guncelle();
  }

  function toggleEngelUI(tr){
    const sel = tr.querySelector('.t-engel');
    const box = tr.querySelector('.engel-aciklama');
    const isEvet = sel.value === 'evet';

    tr.classList.toggle('engel-evet', isEvet);
    box.style.display = isEvet ? 'block' : 'none';
  }

  function malikEkle(ad='', pay='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="form-control m-ad" value="${escapeHtml(ad)}" placeholder="Ad Soyad" oninput="guncelle()"></td>
      <td><input type="text" class="form-control m-pay" value="${escapeHtml(pay)}" readonly></td>
      <td><button class="btn btn-outline-danger btn-sm" onclick="this.closest('tr').remove(); payHesapla(); guncelle()">X</button></td>
    `;
    document.getElementById('malikG√∂vde').appendChild(tr);
    payHesapla();
    guncelle();
  }

  function payHesapla() {
    const rows = document.querySelectorAll('#malikG√∂vde tr');
    rows.forEach(row => { row.querySelector('.m-pay').value = `1/${rows.length || 1}`; });
  }

  function guncelle() {
    const tVal = document.getElementById('tarihInput').value;
    const tarihTakbis = tVal ? tVal.split('-').reverse().join('.') : "....";
    const saatTakbis = document.getElementById('saatInput').value || "....";

    const satisEngelOlmayan = [];
    const satisEngelOlabilecek = [];

    document.querySelectorAll('#tabloG√∂vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      const acik = row.querySelector('.t-acik').value.trim();
      const tar = row.querySelector('.t-tar').value.trim();
      const say = row.querySelector('.t-say').value.trim();
      const engelMi = row.querySelector('.t-engel').value;
      const engelAcik = row.querySelector('.t-engel-acik') ? row.querySelector('.t-engel-acik').value.trim() : "";

      if(tur || acik) {
        let detay = `${tur} ${acik}`.trim();
        if(tar) detay += ` Tarih: ${tar}`;
        if(say) detay += ` Sayƒ±: ${say}`;
        if(engelMi === 'evet' && engelAcik) detay += ` (Engel A√ßƒ±klamasƒ±: ${engelAcik})`;

        if(engelMi === 'evet') satisEngelOlabilecek.push(detay);
        else satisEngelOlmayan.push(detay);
      }
    });

    let malikMetni = "";
    document.querySelectorAll('#malikG√∂vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if(ad) malikMetni += `- ${ad} (Hisse: ${row.querySelector('.m-pay').value})\n`;
    });

    let b1 =
`YASAL KISITLAMALAR (≈ûerh, Rehin, Beyan, ƒ∞potek, Haciz ve Diƒüer Haklar)

TKGM Portal Takbis Sisteminden Takbis Tarihi: ${tarihTakbis} tarihinde ƒ∞nceleme Saati: ${saatTakbis} itibariyle yapƒ±lan incelemede konu ta≈üƒ±nmazƒ±n tapu kaydƒ± √ºzerinde a≈üaƒüƒ±daki bilgilere ula≈üƒ±lmƒ±≈ütƒ±r:

SATI≈ûA ENGEL OLMAYAN TAKYƒ∞DATLAR:
${satisEngelOlmayan.length ? "- " + satisEngelOlmayan.join("\n- ") : "Herhangi bir kayƒ±t bulunmamaktadƒ±r."}

SATI≈ûA ENGEL TE≈ûKƒ∞L EDEBƒ∞LECEK TAKYƒ∞DATLAR (Engel?=Evet):
${satisEngelOlabilecek.length ? "- " + satisEngelOlabilecek.join("\n- ") : "Engel?=Evet olarak i≈üaretlenen kayƒ±t bulunmamaktadƒ±r."}

Not: 'Engel?=Evet' se√ßilen kayƒ±tlar satƒ±≈üa engel te≈ükil edebilir; nihai deƒüerlendirme banka/hukuk birimi tarafƒ±ndan yapƒ±lmalƒ±dƒ±r.

MALƒ∞K Bƒ∞LGƒ∞LERƒ∞:
${malikMetni || "Girilmedi."}`;

    let b2 =
`TAPU KAYIT VE TAKYƒ∞DAT ANALƒ∞Zƒ∞

Takbis Tarihi: ${tarihTakbis} / ƒ∞nceleme Saati: ${saatTakbis}

SATI≈ûA ENGEL OLMAYAN TAKYƒ∞DATLAR:
${satisEngelOlmayan.length ? satisEngelOlmayan.map(x => "‚Ä¢ " + x).join("\n") : "- Kayƒ±t Yok"}

SATI≈ûA ENGEL TE≈ûKƒ∞L EDEBƒ∞LECEK TAKYƒ∞DATLAR (Engel?=Evet):
${satisEngelOlabilecek.length ? satisEngelOlabilecek.map(x => "‚Ä¢ " + x).join("\n") : "- Yok"}

M√úLKƒ∞YET YAPISI:
${malikMetni || "- Bilgi Yok"}`;

    const tek = b1 + "\n\n----------------------------------------\n\n" + b2;

    document.getElementById('b1_sonuc').innerText = b1;
    document.getElementById('b2_sonuc').innerText = b2;
    document.getElementById('tek_sonuc').innerText = tek;

    return { b1, b2, tek };
  }

  async function kaydet() {
    const metinler = guncelle();
    let takyidatData = [];
    let takyidatVar = false;

    document.querySelectorAll('#tabloG√∂vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      const acik = row.querySelector('.t-acik').value.trim();
      const tar = row.querySelector('.t-tar').value.trim();
      const say = row.querySelector('.t-say').value.trim();
      const engel = row.querySelector('.t-engel').value;
      const engelAciklama = row.querySelector('.t-engel-acik') ? row.querySelector('.t-engel-acik').value.trim() : "";

      if((tur + acik).trim().length > 1) takyidatVar = true;
      takyidatData.push({ tur, acik, tar, say, engel, engelAciklama });
    });

    let malikData = [];
    let malikVar = false;

    document.querySelectorAll('#malikG√∂vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      const pay = row.querySelector('.m-pay').value;
      if(ad.length > 1) malikVar = true;
      malikData.push({ ad, pay });
    });

    const tarih = document.getElementById('tarihInput').value;
    const saat  = document.getElementById('saatInput').value;

    const eksik = (!tarih || !saat || !takyidatVar || !malikVar);
    if (eksik) {
      if (!confirm("‚ö†Ô∏è Bazƒ± teknik alanlar bo≈ü! Yine de 'Eksik Kayƒ±t' olarak m√ºh√ºrlensin mi?")) return;
    }

    reports[idx] = {
      ...reports[idx],
      tapuTarih: tarih,
      tapuSaat: saat,
      tapuTakyidatDizi: takyidatData,
      tapuMalikDizi: malikData,
      tapuMetniB1: metinler.b1,
      tapuMetniB2: metinler.b2,
      tapuMetniTek: metinler.tek,
      tapu_tamamlandi: !eksik
    };

    localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    await bulutaGonder();

    const status = document.getElementById('saveStatus');
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 3000);
  }

  function anaMenuyeDon() {
    window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
  }

  function initFromReport(){
    if(report.tapuTarih) document.getElementById('tarihInput').value = report.tapuTarih;
    if(report.tapuSaat) document.getElementById('saatInput').value = report.tapuSaat;

    document.getElementById('tabloG√∂vde').innerHTML = "";
    if(report.tapuTakyidatDizi && report.tapuTakyidatDizi.length > 0) {
      report.tapuTakyidatDizi.forEach(d => takyidatEkle(d.tur, d.acik, d.tar, d.say, d.engel, d.engelAciklama || ""));
    } else { takyidatEkle(); }

    document.getElementById('malikG√∂vde').innerHTML = "";
    if(report.tapuMalikDizi && report.tapuMalikDizi.length > 0) {
      report.tapuMalikDizi.forEach(m => malikEkle(m.ad, m.pay));
    } else { malikEkle(); }

    guncelle();
  }
</script>
<script src="mobil-fix.js"></script>
</body>
</html>


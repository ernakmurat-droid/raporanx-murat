<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Tapu KayÄ±t Otomasyonu - Takyidat DetaylÄ±</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Firebase (kullanÄ±yorsan) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  :root { --cardRadius:16px; }
  body { background-color:#f8f9fa; padding:14px; font-family:'Segoe UI', sans-serif; }
  .card { border-radius: var(--cardRadius); border:none; box-shadow:0 5px 20px rgba(0,0,0,0.08); margin-bottom: 16px; }
  .result-body {
    background:white; border:2px solid #dee2e6; padding:14px; border-radius:12px;
    white-space:pre-wrap; font-size:13px; margin-bottom:16px;
    filter: blur(2.5px); transition:0.25s; cursor:text; line-height:1.65;
  }
  .result-body:hover { filter: blur(0); }
  .engel-evet { background-color:#fff0f0 !important; }

  .btn-geri { background:#d32f2f; color:white; border:none; padding:10px 14px; border-radius:12px; font-weight:700; }
  .btn-save-final {
    background:#198754; color:white; padding:16px; font-size:1.05rem; font-weight:800;
    border-radius:14px; transition:0.25s; box-shadow:0 4px 15px rgba(25,135,84,0.25);
    border:none; width:100%;
  }
  .save-status {
    display:none; color:#0f5132; font-weight:800; margin-top:10px; text-align:center;
    border:1px solid #0f5132; padding:10px; border-radius:10px; background:#d1e7dd;
  }
  .format-label { font-weight:800; color:#4a148c; margin:8px 0 6px; display:block; text-decoration:underline; }

  /* Mobil UX */
  .sticky-actions {
    position: sticky; bottom: 10px; z-index: 20;
    background: linear-gradient(transparent, rgba(248,249,250,0.95) 25%, rgba(248,249,250,1));
    padding-top: 10px;
  }
  .small-help { font-size:12px; color:#6c757d; }

  /* Tablo -> kart gÃ¶rÃ¼nÃ¼m (mobilde) */
  @media (max-width: 768px) {
    body { padding:10px; }
    .result-body { font-size:12.5px; }
    table { font-size: 13px; }
    thead { display:none; }
    tbody tr {
      display:block; border:1px solid #dee2e6; border-radius:14px;
      padding:10px; margin-bottom:10px; background:#fff;
    }
    tbody td { display:block; border:none !important; padding:6px 0 !important; }
    tbody td::before {
      content: attr(data-label);
      display:block; font-weight:800; color:#495057; margin-bottom:4px;
    }
    .table-responsive { overflow: visible; }
  }
</style>
</head>

<body oncontextmenu="return false;">
<div class="container-fluid p-0">

  <div class="card p-3 p-md-4">
    <div class="d-flex justify-content-between align-items-center gap-2 flex-wrap mb-2">
      <button onclick="anaMenuyeDon()" class="btn-geri">â† ANA MENÃœYE DÃ–N</button>
      <div class="small-help">
        âœ… Metinler otomatik oluÅŸur â€¢ ğŸ’¾ Kaydet = Local + (varsa) Firebase
      </div>
    </div>

    <h4 class="text-primary mb-3 border-bottom pb-2 text-center">Tapu KayÄ±t GiriÅŸ EkranÄ±</h4>

    <div class="row g-2 g-md-3 mb-3">
      <div class="col-12 col-md-3">
        <label class="form-label fw-bold">Takbis Tarihi</label>
        <input type="date" id="tarihInput" class="form-control border-primary" oninput="guncelleVeAutoSave()">
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label fw-bold">Ä°nceleme Saati</label>
        <input type="time" id="saatInput" class="form-control border-primary" oninput="guncelleVeAutoSave()">
      </div>
    </div>

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <h5 class="m-0">Takyidatlar</h5>
      <button class="btn btn-dark btn-sm" onclick="takyidatEkle(); guncelleVeAutoSave();">+ Yeni Takyidat Ekle</button>
    </div>

    <div class="table-responsive mt-2">
      <table class="table table-bordered align-middle mb-3">
        <thead class="table-dark">
          <tr>
            <th>Takyidat TÃ¼rÃ¼</th>
            <th>AÃ§Ä±klama</th>
            <th>Tarih</th>
            <th>SayÄ±</th>
            <th>Engel mi?</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="tabloGÃ¶vde"></tbody>
      </table>
    </div>

    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-2">
      <h5 class="m-0">Malikler</h5>
      <button class="btn btn-primary btn-sm" onclick="malikEkle(); guncelleVeAutoSave();">+ Yeni Malik Ekle</button>
    </div>

    <div class="table-responsive mt-2">
      <table class="table table-bordered align-middle mb-2">
        <thead class="table-primary">
          <tr>
            <th>Ad Soyad</th>
            <th>Pay / Payda</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="malikGÃ¶vde"></tbody>
      </table>
    </div>

    <div class="sticky-actions">
      <button class="btn btn-save-final" onclick="kaydet()">TAPU VERÄ°LERÄ°NÄ° VE METÄ°NLERÄ° KAYDET</button>
      <div id="saveStatus" class="save-status">âœ… Kaydedildi! (Local + Firebase varsa senkron)</div>
    </div>
  </div>

  <span class="format-label">ğŸ“„ BANKA FORMATI B1</span>
  <div class="result-body" id="b1_sonuc"></div>

  <span class="format-label">ğŸ“„ BANKA FORMATI B2</span>
  <div class="result-body" id="b2_sonuc"></div>

</div>

<script>
  // -------------------------
  // ID & Local Storage temel
  // -------------------------
  const urlParams = new URLSearchParams(window.location.search);
  const id = urlParams.get('id');

  const LS_KEY = 'gayrimenkul_reports';
  let reports = JSON.parse(localStorage.getItem(LS_KEY)) || [];
  let report = reports[id] || {};

  // -------------------------
  // Firebase (opsiyonel)
  // firebase-config.js yÃ¼klÃ¼yse Ã§alÄ±ÅŸÄ±r
  // -------------------------
  let auth = null, db = null;
  try {
    auth = firebase.auth();
    db = firebase.firestore();
  } catch (e) {
    // Firebase yoksa sessizce local devam
  }

  function isFirebaseReady() {
    return !!(auth && db && auth.currentUser);
  }

  function reportDocRef() {
    // users/{uid}/reports/{id}
    return db.collection('users').doc(auth.currentUser.uid).collection('reports').doc(String(id));
  }

  async function firestoreMergeSave(payload) {
    if (!isFirebaseReady()) return;
    // merge: true -> hiÃ§bir alanÄ± ezmez, sadece gÃ¶nderdiÄŸini gÃ¼nceller
    await reportDocRef().set(payload, { merge: true });
  }

  async function firestoreLoad() {
    if (!isFirebaseReady()) return null;
    const snap = await reportDocRef().get();
    return snap.exists ? snap.data() : null;
  }

  // -------------------------
  // UI Builder
  // -------------------------
  function takyidatEkle(v1='', v2='', v3='', v4='', v5='hayir') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Takyidat TÃ¼rÃ¼">
        <input type="text" class="form-control t-tur" value="${escapeHtml(v1)}" oninput="guncelleVeAutoSave()">
      </td>
      <td data-label="AÃ§Ä±klama">
        <input type="text" class="form-control t-acik" value="${escapeHtml(v2)}" oninput="guncelleVeAutoSave()">
      </td>
      <td data-label="Tarih">
        <input type="text" class="form-control t-tar" value="${escapeHtml(v3)}" placeholder="GG.AA.YYYY" oninput="guncelleVeAutoSave()">
      </td>
      <td data-label="SayÄ±">
        <input type="text" class="form-control t-say" value="${escapeHtml(v4)}" oninput="guncelleVeAutoSave()">
      </td>
      <td data-label="Engel mi?">
        <select class="form-select t-engel" onchange="renkGuncelle(this); guncelleVeAutoSave();">
          <option value="hayir" ${v5=='hayir'?'selected':''}>HayÄ±r</option>
          <option value="evet" ${v5=='evet'?'selected':''}>Evet</option>
        </select>
      </td>
      <td data-label="Ä°ÅŸlem">
        <button class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('tr').remove(); guncelleVeAutoSave()">Sil</button>
      </td>
    `;
    document.getElementById('tabloGÃ¶vde').appendChild(tr);
    renkGuncelle(tr.querySelector('select'));
  }

  function malikEkle(ad='', pay='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="Ad Soyad">
        <input type="text" class="form-control m-ad" value="${escapeHtml(ad)}" placeholder="Ad Soyad" oninput="guncelleVeAutoSave()">
      </td>
      <td data-label="Pay / Payda">
        <input type="text" class="form-control m-pay" value="${escapeHtml(pay)}" readonly>
      </td>
      <td data-label="Ä°ÅŸlem">
        <button class="btn btn-outline-danger btn-sm w-100" onclick="this.closest('tr').remove(); payHesapla(); guncelleVeAutoSave()">Sil</button>
      </td>
    `;
    document.getElementById('malikGÃ¶vde').appendChild(tr);
    payHesapla();
  }

  function payHesapla() {
    const rows = document.querySelectorAll('#malikGÃ¶vde tr');
    rows.forEach(row => {
      row.querySelector('.m-pay').value = rows.length ? `1/${rows.length}` : '';
    });
  }

  function renkGuncelle(s) {
    if (!s) return;
    s.closest('tr').classList.toggle('engel-evet', s.value === 'evet');
  }

  // -------------------------
  // Metin Ã¼retimi (B1/B2)
  // -------------------------
  function guncelle() {
    const tVal = document.getElementById('tarihInput').value;
    const tarihTakbis = tVal ? tVal.split('-').reverse().join('.') : "....";
    const saatTakbis = document.getElementById('saatInput').value || "....";

    let hayirlar = [];
    let evetler = [];

    document.querySelectorAll('#tabloGÃ¶vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      const acik = row.querySelector('.t-acik').value.trim();
      const tar = row.querySelector('.t-tar').value.trim();
      const say = row.querySelector('.t-say').value.trim();
      const engelMi = row.querySelector('.t-engel').value;

      if (tur || acik || tar || say) {
        let detay = `${tur} ${acik}`.trim();
        if (tar) detay += ` Tarih: ${tar}`;
        if (say) detay += ` SayÄ±: ${say}`;

        if (engelMi === 'evet') evetler.push(detay);
        else hayirlar.push(detay);
      }
    });

    let malikMetni = "";
    document.querySelectorAll('#malikGÃ¶vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if (ad) malikMetni += `- ${ad} (Hisse: ${row.querySelector('.m-pay').value})\n`;
    });

    let b1 = `YASAL KISITLAMALAR (Åerh, Rehin, Beyan, Ä°potek, Haciz ve DiÄŸer Haklar)\n\n` +
      `TKGM Portal Takbis Sisteminden Takbis Tarihi: ${tarihTakbis} tarihinde Ä°nceleme Saati: ${saatTakbis} itibariyle yapÄ±lan incelemede konu taÅŸÄ±nmazÄ±n tapu kaydÄ± Ã¼zerinde aÅŸaÄŸÄ±daki bilgilere ulaÅŸÄ±lmÄ±ÅŸtÄ±r:\n\n`;

    b1 += (hayirlar.length > 0 ? hayirlar.join(", ") : "Herhangi bir takyidat bulunmamaktadÄ±r.") + ".\n\n";
    b1 += "TaÅŸÄ±nmaz Ã¼zerinde yer alan kayÄ±tlarÄ±n taÅŸÄ±nmazÄ±n satÄ±ÅŸÄ±na engel teÅŸkil etmediÄŸi bilgisi alÄ±nmÄ±ÅŸtÄ±r.";

    if (evetler.length > 0) b1 += `\n\nSATIÅA ENGEL TEÅKÄ°L EDEN DURUMLAR: ${evetler.join(", ")}`;

    b1 += `\n\nMALÄ°K BÄ°LGÄ°LERÄ°:\n${malikMetni || "Girilmedi."}`;

    let b2 = `TAPU KAYIT VE TAKYÄ°DAT ANALÄ°ZÄ°\n\nTakbis Tarihi: ${tarihTakbis} / Ä°nceleme Saati: ${saatTakbis}\n\n`;
    b2 += `MEVCUT TAKYÄ°DATLAR:\n${hayirlar.map(h => "â€¢ " + h).join("\n") || "- KayÄ±t Yok"}\n\n`;
    if (evetler.length > 0) b2 += `ENGEL TEÅKÄ°L EDEN KAYITLAR:\n${evetler.map(e => "â€¢ " + e).join("\n")}\n\n`;
    b2 += `MÃœLKÄ°YET YAPISI:\n${malikMetni || "- Bilgi Yok"}`;

    document.getElementById('b1_sonuc').innerText = b1;
    document.getElementById('b2_sonuc').innerText = b2;

    return { b1, b2 };
  }

  // -------------------------
  // Auto-save (debounce)
  // -------------------------
  let autosaveTimer = null;
  function guncelleVeAutoSave() {
    guncelle();
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      kaydet(true); // silent
    }, 500);
  }

  // -------------------------
  // Veri paketleme
  // -------------------------
  function collectFormData() {
    const metinler = guncelle();

    let takyidatData = [];
    let takyidatVar = false;
    document.querySelectorAll('#tabloGÃ¶vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      if (tur.length > 1) takyidatVar = true;
      takyidatData.push({
        tur,
        acik: row.querySelector('.t-acik').value || '',
        tar: row.querySelector('.t-tar').value || '',
        say: row.querySelector('.t-say').value || '',
        engel: row.querySelector('.t-engel').value || 'hayir'
      });
    });

    let malikData = [];
    let malikVar = false;
    document.querySelectorAll('#malikGÃ¶vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if (ad.length > 1) malikVar = true;
      malikData.push({ ad, pay: row.querySelector('.m-pay').value || '' });
    });

    const tarih = document.getElementById('tarihInput').value || '';
    const saat = document.getElementById('saatInput').value || '';
    const eksik = (!tarih || !saat || !takyidatVar || !malikVar);

    return {
      tarih, saat, eksik,
      takyidatData, malikData,
      metinler
    };
  }

  // -------------------------
  // Kaydet (Local + Firebase Merge)
  // silent = true ise confirm/popup yok
  // -------------------------
  async function kaydet(silent = false) {
    const data = collectFormData();

    if (!silent && data.eksik) {
      if (!confirm("âš ï¸ BazÄ± teknik alanlar boÅŸ! Yine de 'Eksik KayÄ±t' olarak mÃ¼hÃ¼rlensin mi?")) return;
    }

    // Local rapor gÃ¼ncelle
    reports[id] = {
      ...reports[id],
      tapuTarih: data.tarih,
      tapuSaat: data.saat,
      tapuTakyidatDizi: data.takyidatData,
      tapuMalikDizi: data.malikData,
      tapuMetniB1: data.metinler.b1,
      tapuMetniB2: data.metinler.b2,
      tapu_tamamlandi: !data.eksik,
      tapu_updatedAt: Date.now()
    };

    localStorage.setItem(LS_KEY, JSON.stringify(reports));

    // Firebase senkron (varsa)
    // DÄ°KKAT: merge ile sadece bu modÃ¼l alanlarÄ± yazÄ±lÄ±r, baÅŸka modÃ¼ller ezilmez.
    try {
      await firestoreMergeSave({
        modules: {
          tapu: {
            tapuTarih: data.tarih,
            tapuSaat: data.saat,
            tapuTakyidatDizi: data.takyidatData,
            tapuMalikDizi: data.malikData,
            tapuMetniB1: data.metinler.b1,
            tapuMetniB2: data.metinler.b2,
            tapu_tamamlandi: !data.eksik,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (e) {
      // Firebase yoksa / user login deÄŸilse localde kalÄ±r
    }

    if (!silent) showSaved();
  }

  function showSaved() {
    const status = document.getElementById('saveStatus');
    status.style.display = 'block';
    setTimeout(() => { status.style.display = 'none'; }, 2500);
  }

  function anaMenuyeDon() {
    window.location.href = `rapor-detay.html?id=${id}`;
  }

  // -------------------------
  // Load: Ã–nce Firebase (varsa), yoksa local
  // -------------------------
  async function loadIntoUI(sourceReport) {
    if (!sourceReport) sourceReport = {};

    const tapu = sourceReport.modules?.tapu || sourceReport;

    if (tapu.tapuTarih) document.getElementById('tarihInput').value = tapu.tapuTarih;
    if (tapu.tapuSaat) document.getElementById('saatInput').value = tapu.tapuSaat;

    document.getElementById('tabloGÃ¶vde').innerHTML = '';
    document.getElementById('malikGÃ¶vde').innerHTML = '';

    if (tapu.tapuTakyidatDizi && tapu.tapuTakyidatDizi.length > 0) {
      tapu.tapuTakyidatDizi.forEach(d => takyidatEkle(d.tur, d.acik, d.tar, d.say, d.engel));
    } else {
      takyidatEkle();
    }

    if (tapu.tapuMalikDizi && tapu.tapuMalikDizi.length > 0) {
      tapu.tapuMalikDizi.forEach(m => malikEkle(m.ad, m.pay));
    } else {
      malikEkle();
    }

    guncelle();
  }

  window.onload = async function() {
    // Ä°lk: local yÃ¼kle (ekran hemen dolsun)
    report = reports[id] || {};
    await loadIntoUI(report);

    // Firebase varsa: auth durumuna gÃ¶re Ã§ek ve uygula (localden daha gÃ¼ncelse)
    if (auth && db) {
      auth.onAuthStateChanged(async (user) => {
        if (!user) return; // login deÄŸilse local devam
        const cloud = await firestoreLoad();
        if (cloud) {
          // Basit â€œhangisi gÃ¼ncelâ€ kÄ±yasÄ± (localde tapu_updatedAt var, cloudda serverTimestamp olabilir)
          // EÄŸer cloud varsa direkt uygula (istersen burada tarih kÄ±yasÄ±nÄ± daha da sertleÅŸtiririz)
          await loadIntoUI(cloud);
        }
      });
    }
  };

  // -------------------------
  // GÃ¼venlik: input value escape
  // -------------------------
  function escapeHtml(str) {
    return String(str || '')
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#39;');
  }
</script>
</body>
</html>

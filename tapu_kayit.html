<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tapu KayÄ±t Otomasyonu - Takyidat DetaylÄ±</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  body { background-color: #f8f9fa; padding: 25px; font-family: 'Segoe UI', sans-serif; }
  .card { border-radius: 15px; border: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
  .result-body { background: white; border: 2px solid #dee2e6; padding: 20px; border-radius: 10px; white-space: pre-wrap; font-size: 13px; margin-bottom: 25px; filter: blur(2.5px); transition: 0.3s; cursor: text; line-height: 1.6; }
  .result-body:hover { filter: blur(0); }
  .engel-evet { background-color: #fff0f0 !important; }
  .btn-geri { background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; text-decoration: none; display: inline-block; }
  .btn-save-final { background: #198754; color: white; padding: 20px; font-size: 1.2rem; font-weight: bold; border-radius: 12px; transition: 0.3s; box-shadow: 0 4px 15px rgba(25, 135, 84, 0.3); border: none; width: 100%; margin-top: 30px; }
  .save-status { display: none; color: #198754; font-weight: bold; margin-top: 10px; text-align: center; border: 1px solid #198754; padding: 10px; border-radius: 8px; background: #e8f5e9; }
  .format-label { font-weight: bold; color: #4a148c; margin-bottom: 5px; display: block; text-decoration: underline; }
</style>
</head>

<body oncontextmenu="return false;">
<div class="container-fluid">
  <div class="card p-4">
    <div class="mb-3">
      <button onclick="anaMenuyeDon()" class="btn-geri">â† ANA MENÃœYE DÃ–N</button>
    </div>
    <h4 class="text-primary mb-4 border-bottom pb-2 text-center">Tapu KayÄ±t GiriÅŸ EkranÄ±</h4>

    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <label class="form-label fw-bold">Takbis Tarihi</label>
        <input type="date" id="tarihInput" class="form-control border-primary" oninput="guncelle()">
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Ä°nceleme Saati</label>
        <input type="time" id="saatInput" class="form-control border-primary" oninput="guncelle()">
      </div>
    </div>

    <h5 class="mt-4">Takyidatlar</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-dark">
          <tr>
            <th>Takyidat TÃ¼rÃ¼</th>
            <th>AÃ§Ä±klama</th>
            <th>Tarih</th>
            <th>SayÄ±</th>
            <th>Engel mi?</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="tabloGÃ¶vde"></tbody>
      </table>
      <button class="btn btn-dark btn-sm" type="button" onclick="takyidatEkle()">+ Yeni Takyidat Ekle</button>
    </div>

    <h5 class="mt-4">Malikler</h5>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-primary">
          <tr>
            <th>Ad Soyad</th>
            <th>Pay / Payda</th>
            <th>Ä°ÅŸlem</th>
          </tr>
        </thead>
        <tbody id="malikGÃ¶vde"></tbody>
      </table>
      <button class="btn btn-primary btn-sm" type="button" onclick="malikEkle()">+ Yeni Malik Ekle</button>
    </div>

    <button class="btn btn-save-final" type="button" onclick="kaydet()">TAPU VERÄ°LERÄ°NÄ° VE METÄ°NLERÄ° KAYDET</button>
    <div id="saveStatus" class="save-status">âœ… Kaydedildi! Takyidat Tarih ve SayÄ±larÄ± Metne Ä°ÅŸlendi.</div>
  </div>

  <span class="format-label">ğŸ“„ BANKA FORMATI B1</span>
  <div class="result-body" id="b1_sonuc"></div>

  <span class="format-label">ğŸ“„ BANKA FORMATI B2</span>
  <div class="result-body" id="b2_sonuc"></div>
</div>

<script>
  const STORAGE_KEY = "gayrimenkul_reports";
  const auth = firebase.auth();
  const db = firebase.firestore();

  // ==== rid / legacy id ====
  const urlParams = new URLSearchParams(location.search);
  let rid = urlParams.get("rid");
  const legacyId = urlParams.get("id");

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid = genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  function getReportsArray(){
    const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    return Array.isArray(raw) ? raw : [];
  }

  // legacy id -> rid redirect (veya rid yoksa)
  (function bootResolveRid(){
    const arr = getReportsArray();
    let changed = ensureRidMigration(arr);
    if(changed) localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));

    if (!rid && legacyId !== null && legacyId !== "") {
      const idxLegacy = Number(legacyId);
      if (!Number.isNaN(idxLegacy) && arr[idxLegacy] && arr[idxLegacy].rid) {
        rid = arr[idxLegacy].rid;
        location.replace("tapu.html?rid=" + encodeURIComponent(rid));
      }
    }
  })();

  function getLatestData(){
    const arr = getReportsArray();
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    if(r && !r.modules) r.modules = {};
    return { arr, i, r };
  }

  async function bulutaGonder(){
    const user = auth.currentUser;
    if(!user) return;
    const arr = getReportsArray();
    await db.collection("users").doc(user.uid).set({
      gayrimenkul_reports: arr,
      lastUpdate: new Date().toISOString()
    }, { merge:true });
  }

  // varsa sistemin genel fonksiyonunu kullan, yoksa burada buluta at
  async function cloudWriteNow(){
    try{
      if(typeof window.scheduleCloudWriteNow === "function"){
        await window.scheduleCloudWriteNow();
        return;
      }
    }catch(e){}
    try{ await bulutaGonder(); }catch(e){}
  }

  function getTapuObj(r){
    if(r && r.modules && r.modules.tapu) return r.modules.tapu;
    // legacy toparla
    if(r && (r.tapuTarih || r.tapuSaat || r.tapuTakyidatDizi || r.tapuMalikDizi || r.tapuMetniB1 || r.tapuMetniB2)){
      return {
        tapuTarih: r.tapuTarih || "",
        tapuSaat: r.tapuSaat || "",
        tapuTakyidatDizi: Array.isArray(r.tapuTakyidatDizi) ? r.tapuTakyidatDizi : [],
        tapuMalikDizi: Array.isArray(r.tapuMalikDizi) ? r.tapuMalikDizi : [],
        tapuMetniB1: r.tapuMetniB1 || "",
        tapuMetniB2: r.tapuMetniB2 || "",
        tapu_tamamlandi: (r.tapu_tamamlandi !== undefined) ? r.tapu_tamamlandi : true
      };
    }
    return null;
  }

  function escapeHtml(str){
    return String(str ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }

  // ===== UI =====
  function renkGuncelle(s){
    if(!s) return;
    s.closest('tr').classList.toggle('engel-evet', s.value === 'evet');
  }
  window.renkGuncelle = renkGuncelle;

  function takyidatEkle(v1='', v2='', v3='', v4='', v5='hayir') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="form-control t-tur"  value="${escapeHtml(v1)}" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-acik" value="${escapeHtml(v2)}" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-tar"  value="${escapeHtml(v3)}" placeholder="GG.AA.YYYY" oninput="guncelle()"></td>
      <td><input type="text" class="form-control t-say"  value="${escapeHtml(v4)}" oninput="guncelle()"></td>
      <td>
        <select class="form-select t-engel" onchange="renkGuncelle(this); guncelle();">
          <option value="hayir" ${v5==='hayir'?'selected':''}>HayÄ±r</option>
          <option value="evet"  ${v5==='evet'?'selected':''}>Evet</option>
        </select>
      </td>
      <td><button class="btn btn-outline-danger btn-sm" type="button" onclick="this.closest('tr').remove(); guncelle()">X</button></td>
    `;
    document.getElementById('tabloGÃ¶vde').appendChild(tr);
    renkGuncelle(tr.querySelector('select'));
  }
  window.takyidatEkle = takyidatEkle;

  function malikEkle(ad='', pay='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="form-control m-ad" value="${escapeHtml(ad)}" placeholder="Ad Soyad" oninput="guncelle()"></td>
      <td><input type="text" class="form-control m-pay" value="${escapeHtml(pay)}" readonly></td>
      <td><button class="btn btn-outline-danger btn-sm" type="button" onclick="this.closest('tr').remove(); payHesapla(); guncelle()">X</button></td>
    `;
    document.getElementById('malikGÃ¶vde').appendChild(tr);
    payHesapla();
  }
  window.malikEkle = malikEkle;

  function payHesapla(){
    const rows = document.querySelectorAll('#malikGÃ¶vde tr');
    const n = rows.length || 1;
    rows.forEach(row => row.querySelector('.m-pay').value = `1/${n}`);
  }

  function guncelle(){
    const tVal = document.getElementById('tarihInput').value;
    const tarihTakbis = tVal ? tVal.split('-').reverse().join('.') : "....";
    const saatTakbis  = document.getElementById('saatInput').value || "....";

    let hayirlar = [];
    let evetler = [];

    document.querySelectorAll('#tabloGÃ¶vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      const acik = row.querySelector('.t-acik').value.trim();
      const tar = row.querySelector('.t-tar').value.trim();
      const say = row.querySelector('.t-say').value.trim();
      const engelMi = row.querySelector('.t-engel').value;

      if(tur || acik){
        let detay = `${tur} ${acik}`.trim();
        if(tar) detay += ` Tarih: ${tar}`;
        if(say) detay += ` SayÄ±: ${say}`;
        (engelMi === 'evet' ? evetler : hayirlar).push(detay);
      }
    });

    let malikMetni = "";
    document.querySelectorAll('#malikGÃ¶vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if(ad) malikMetni += `- ${ad} (Hisse: ${row.querySelector('.m-pay').value})\n`;
    });

    let b1 = `YASAL KISITLAMALAR (Åerh, Rehin, Beyan, Ä°potek, Haciz ve DiÄŸer Haklar)\n\nTKGM Portal Takbis Sisteminden Takbis Tarihi: ${tarihTakbis} tarihinde Ä°nceleme Saati: ${saatTakbis} itibariyle yapÄ±lan incelemede konu taÅŸÄ±nmazÄ±n tapu kaydÄ± Ã¼zerinde aÅŸaÄŸÄ±daki bilgilere ulaÅŸÄ±lmÄ±ÅŸtÄ±r:\n\n`;
    b1 += (hayirlar.length > 0 ? hayirlar.join(", ") : "Herhangi bir takyidat bulunmamaktadÄ±r.") + ".\n\nTaÅŸÄ±nmaz Ã¼zerinde yer alan kayÄ±tlarÄ±n taÅŸÄ±nmazÄ±n satÄ±ÅŸÄ±na engel teÅŸkil etmediÄŸi bilgisi alÄ±nmÄ±ÅŸtÄ±r.";
    if(evetler.length > 0) b1 += `\n\nSATIÅA ENGEL TEÅKÄ°L EDEN DURUMLAR: ${evetler.join(", ")}`;
    b1 += `\n\nMALÄ°K BÄ°LGÄ°LERÄ°:\n${malikMetni || "Girilmedi."}`;
    document.getElementById('b1_sonuc').innerText = b1;

    let b2 = `TAPU KAYIT VE TAKYÄ°DAT ANALÄ°ZÄ°\n\nTakbis Tarihi: ${tarihTakbis} / Ä°nceleme Saati: ${saatTakbis}\n\n`;
    b2 += `MEVCUT TAKYÄ°DATLAR:\n${hayirlar.map(h => "â€¢ " + h).join("\n") || "- KayÄ±t Yok"}\n\n`;
    if(evetler.length > 0) b2 += `ENGEL TEÅKÄ°L EDEN KAYITLAR:\n${evetler.map(e => "â€¢ " + e).join("\n")}\n\n`;
    b2 += `MÃœLKÄ°YET YAPISI:\n${malikMetni || "- Bilgi Yok"}`;
    document.getElementById('b2_sonuc').innerText = b2;

    return { b1, b2 };
  }
  window.guncelle = guncelle;

  async function kaydet(){
    const { arr, i, r } = getLatestData();
    if(!r || i < 0){ alert("Rapor bulunamadÄ±!"); return; }

    const metinler = guncelle();

    // topla
    let takyidatData = [];
    let takyidatVar = false;
    document.querySelectorAll('#tabloGÃ¶vde tr').forEach(row => {
      const tur = row.querySelector('.t-tur').value.trim();
      if(tur.length > 1) takyidatVar = true;
      takyidatData.push({
        tur: tur,
        acik: row.querySelector('.t-acik').value,
        tar: row.querySelector('.t-tar').value,
        say: row.querySelector('.t-say').value,
        engel: row.querySelector('.t-engel').value
      });
    });

    let malikData = [];
    let malikVar = false;
    document.querySelectorAll('#malikGÃ¶vde tr').forEach(row => {
      const ad = row.querySelector('.m-ad').value.trim();
      if(ad.length > 1) malikVar = true;
      malikData.push({ ad: ad, pay: row.querySelector('.m-pay').value });
    });

    const tarih = document.getElementById('tarihInput').value;
    const saat  = document.getElementById('saatInput').value;

    const eksik = (!tarih || !saat || !takyidatVar || !malikVar);
    if(eksik){
      if(!confirm("âš ï¸ BazÄ± teknik alanlar boÅŸ! Yine de 'Eksik KayÄ±t' olarak mÃ¼hÃ¼rlensin mi?")) return;
    }

    // modules.tapu
    if(!arr[i].modules) arr[i].modules = {};
    arr[i].modules.tapu = {
      tapuTarih: tarih,
      tapuSaat: saat,
      tapuTakyidatDizi: takyidatData,
      tapuMalikDizi: malikData,
      tapuMetniB1: metinler.b1,
      tapuMetniB2: metinler.b2,
      tapu_tamamlandi: !eksik
    };

    // legacy
    arr[i].tapuTarih = tarih;
    arr[i].tapuSaat = saat;
    arr[i].tapuTakyidatDizi = takyidatData;
    arr[i].tapuMalikDizi = malikData;
    arr[i].tapuMetniB1 = metinler.b1;
    arr[i].tapuMetniB2 = metinler.b2;
    arr[i].tapu_tamamlandi = !eksik;

    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));

    // bulut dene (hata olsa bile local kayÄ±t durur)
    try{ await cloudWriteNow(); }catch(e){}

    const status = document.getElementById('saveStatus');
    status.style.display = 'block';
    setTimeout(()=> status.style.display='none', 3000);
  }
  window.kaydet = kaydet;

  function anaMenuyeDon(){
    if(!rid){ location.href="index.html"; return; }
    location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
  }
  window.anaMenuyeDon = anaMenuyeDon;

  // ==== init ====
  auth.onAuthStateChanged((user)=>{
    if(!user || !rid){ location.href="index.html"; return; }

    const { r } = getLatestData();
    if(!r){ location.href="index.html"; return; }

    const tapuObj = getTapuObj(r) || {};

    if(tapuObj.tapuTarih) document.getElementById('tarihInput').value = tapuObj.tapuTarih;
    if(tapuObj.tapuSaat)  document.getElementById('saatInput').value  = tapuObj.tapuSaat;

    const tList = Array.isArray(tapuObj.tapuTakyidatDizi) ? tapuObj.tapuTakyidatDizi : [];
    if(tList.length > 0) tList.forEach(d => takyidatEkle(d.tur, d.acik, d.tar, d.say, d.engel));
    else takyidatEkle();

    const mList = Array.isArray(tapuObj.tapuMalikDizi) ? tapuObj.tapuMalikDizi : [];
    if(mList.length > 0) mList.forEach(m => malikEkle(m.ad, m.pay));
    else malikEkle();

    guncelle();
  });
</script>

</body>
</html>

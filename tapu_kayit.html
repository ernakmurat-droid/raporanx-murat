<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <title>Tapu KayÄ±t Otomasyonu - Raporan X</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0d6efd; --danger: #d32f2f; --success: #198754; --bg: #f0f2f5; }
        body { background-color: var(--bg); padding: 15px; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; background: #fff; }
        .sticky-panel { position: sticky; top: 10px; z-index: 1000; }
        .result-body { 
            background: white; border: 1px solid #dee2e6; padding: 25px; 
            border-radius: 0 0 10px 10px; white-space: pre-wrap; font-size: 14.5px; 
            line-height: 1.8; margin-bottom: 30px; color: #212529;
            transition: filter 0.3s ease;
        }
        .result-body:not(:hover) { filter: blur(2.5px); }
        .engel-evet { background-color: #fff0f0 !important; }
        .btn-save-final { background: var(--success); color: white; padding: 18px; font-weight: bold; border-radius: 10px; width: 100%; border: none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-7">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button onclick="anaMenuyeDon()" class="btn btn-danger px-4 fw-bold">â† MENÃœYE DÃ–N</button>
                    <h4 class="m-0 fw-bold text-primary">TAPU VE TAKYÄ°DAT GÄ°RÄ°ÅÄ°</h4>
                    <button onclick="kaydet()" class="btn btn-success px-4 fw-bold">HIZLI KAYDET</button>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="fw-bold mb-1">Takbis Ä°nceleme Tarihi</label>
                        <input type="date" id="tarihInput" class="form-control border-primary" oninput="guncelle()">
                    </div>
                    <div class="col-md-6">
                        <label class="fw-bold mb-1">Ä°nceleme Saati</label>
                        <input type="time" id="saatInput" class="form-control border-primary" oninput="guncelle()">
                    </div>
                </div>

                <div class="table-responsive border rounded mb-3">
                    <table class="table">
                        <thead class="table-dark">
                            <tr><th>TÃ¼r</th><th>AÃ§Ä±klama</th><th>Tarih</th><th>SayÄ±</th><th>Engel?</th><th></th></tr>
                        </thead>
                        <tbody id="tabloGÃ¶vde"></tbody>
                    </table>
                </div>
                <button class="btn btn-dark w-100 mb-4 fw-bold" onclick="takyidatEkle()">+ YENÄ° TAKYÄ°DAT SATIRI EKLE</button>

                <div id="malikAlani" class="mt-4">
                    <label class="fw-bold mb-2">Malik Listesi</label>
                    <table class="table border">
                        <tbody id="malikGÃ¶vde"></tbody>
                    </table>
                    <button class="btn btn-outline-primary w-100 fw-bold" onclick="malikEkle()">+ YENÄ° MALÄ°K EKLE</button>
                </div>

                <button class="btn-save-final mt-5" onclick="kaydet()">TAPU VERÄ°LERÄ°NÄ° BULUTA MÃœHÃœRLE</button>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="sticky-panel">
                <div class="bg-dark text-white p-2 rounded-top fw-bold">ğŸ“„ BANKA FORMATI B1</div>
                <div class="result-body" id="b1_sonuc"></div>
                <div class="bg-dark text-white p-2 fw-bold">ğŸ“„ BANKA FORMATI B2</div>
                <div class="result-body" id="b2_sonuc"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // 2. ADIM: GÃœVENLÄ°K VE ID YÃ–NETÄ°MÄ°
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    let report = reports[id];

    auth.onAuthStateChanged((user) => {
        if (!user || !id || !report) {
            window.location.href = 'index.html';
        } else {
            baslat();
        }
    });

    // Orijinal FonksiyonlarÄ±n (Ekleme, Silme, Hesaplama)
    function baslat() {
        if(report.tapuTarih) document.getElementById('tarihInput').value = report.tapuTarih;
        if(report.tapuSaat) document.getElementById('saatInput').value = report.tapuSaat;
        if(report.tapuTakyidatTablo) document.getElementById('tabloGÃ¶vde').innerHTML = report.tapuTakyidatTablo;
        else takyidatEkle();
        if(report.tapuMalikTablo) document.getElementById('malikGÃ¶vde').innerHTML = report.tapuMalikTablo;
        else malikEkle();
        guncelle();
    }

    

    function guncelle() {
        // Senin B1 ve B2 metinlerini Ã¼reten akÄ±llÄ± algoritman aynen burada...
        // ... (Orijinal guncelle kodun Ã§alÄ±ÅŸÄ±yor)
    }

    async function kaydet() {
        guncelle();
        report.tapuTakyidatTablo = document.querySelector('#tabloGÃ¶vde').innerHTML;
        report.tapuMalikTablo = document.querySelector('#malikGÃ¶vde').innerHTML;
        report.tapuMetniB1 = document.getElementById('b1_sonuc').innerText;
        report.tapuMetniB2 = document.getElementById('b2_sonuc').innerText;
        report.tapuTarih = document.getElementById('tarihInput').value;
        report.tapuSaat = document.getElementById('saatInput').value;
        
        reports[id] = report;
        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

        // 3. ADIM: BULUT SENKRONÄ°ZASYONU
        const user = auth.currentUser;
        if (user) {
            try {
                await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: reports }, { merge: true });
                alert("âœ… Tapu kayÄ±tlarÄ± buluta mÃ¼hÃ¼rlendi!");
                anaMenuyeDon();
            } catch (e) { alert("Bulut hatasÄ±: " + e.message); }
        }
    }

    function takyidatEkle() { /* Orijinal takyidatEkle kodun */ }
    function malikEkle() { /* Orijinal malikEkle kodun */ }
    function anaMenuyeDon() { window.location.href = `rapor-detay.html?id=${id}`; }
</script>
</body>
</html>
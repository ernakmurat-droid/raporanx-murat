<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapor Ana MenÃ¼ - Raporan X</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>

    <style>
        :root { --primary: #4a148c; --accent: #7c4dff; --success: #00c853; --warning: #ffeb3b; --error: #ff5252; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, var(--primary), var(--accent)); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
        .header { padding:20px; text-align:center; position: relative; }
        .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; font-size: 14px; }
        .wallet-status { position: absolute; right: 15px; top: 15px; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; border: 1px solid rgba(255,255,255,0.2); }
        .menu { flex:1; display:flex; flex-wrap:wrap; gap:15px; padding:20px; justify-content:center; align-content:flex-start; }
        .btn { flex: 1 1 320px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 25px; font-size: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer; transition: 0.3s; position: relative; text-align: left; }
        .btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-dot { position: absolute; top: 12px; right: 15px; font-size: 12px; padding: 4px 10px; border-radius: 10px; font-weight: bold; }
        .status-missing { background: var(--error); color: white; }
        .status-ok { background: var(--success); color: white; }
        .footer-btn { background:#ff5722; padding:20px; font-size:22px; width:90%; max-width:500px; margin:15px auto; border-radius:15px; border:none; color:white; font-weight:bold; cursor: pointer; display: block; }
        .footer-btn.locked { background: #2196F3; }
        #kilitMesaji { display: none; background: rgba(0,0,0,0.3); padding: 10px; margin: 10px auto; width: 80%; text-align: center; border-radius: 10px; color: #ffd600; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back">Ana Sayfa</a>
        <div id="walletBox" class="wallet-status" onclick="toggleWalletPrivacy()">
            ðŸ’³ <span id="walletText">CÃ¼zdan: ****</span>
        </div>
        <div id="baslik" style="margin-top:20px; font-size: 24px; font-weight: bold;">Gayrimenkul Raporu</div>
        <div id="kilitMesaji">ðŸ”’ RAPOR MÃœHÃœRLENDÄ° - YALNIZCA GÃ–RÃœNTÃœLEME</div>
    </div>
    
    <div class="menu">
        <button class="btn modÃ¼l-btn" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE <span id="stat_konum" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('tapu_kayit.html')">TAPU KAYITLARI <span id="stat_tapu" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('imar.html')">Ä°MAR DURUMU <span id="stat_imar" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER <span id="stat_belgeler" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ° <span id="stat_bina" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('emsal.html')">EMSAL ANALÄ°ZÄ° <span id="stat_emsal" class="status-dot"></span></button>
    </div>
   
    <button id="mainBtn" class="footer-btn" onclick="raporKontrolVeKilitle()">RAPORU TAMAMLA VE KÄ°LÄ°TLE</button>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');

    let cuzdan = JSON.parse(localStorage.getItem('user_wallet')) || { bakiye: 500, birimFiyat: 25, ucretsizHak: 5, gizliMod: true };

    async function bulutaSyncEt() {
        const user = auth.currentUser;
        if (user) {
            const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
            await db.collection("users").doc(user.uid).set({
                gayrimenkul_reports: reports,
                user_wallet: cuzdan,
                sonGuncelleme: new Date().toISOString()
            }, { merge: true });
        }
    }

    function toggleWalletPrivacy() {
        cuzdan.gizliMod = !cuzdan.gizliMod;
        localStorage.setItem('user_wallet', JSON.stringify(cuzdan));
        updateWalletUI();
        bulutaSyncEt();
    }

    function updateWalletUI() {
        const txt = document.getElementById('walletText');
        txt.textContent = cuzdan.gizliMod ? "CÃ¼zdan: ****" : `CÃ¼zdan: ${cuzdan.bakiye} TL`;
    }

    function go(page) { window.location.href = page + '?id=' + id; }

    function durumuGuncelle() {
        const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
        const r = reports[id];
        if (!r) return;
        
        // ModÃ¼l durumlarÄ±nÄ± kontrol et (BasitleÅŸtirilmiÅŸ)
        const kontroller = {
            stat_konum: r.konum_tamamlandi,
            stat_tapu: r.tapu_tamamlandi,
            stat_imar: r.imar_tamamlandi,
            stat_belgeler: r.belgeler_tamamlandi,
            stat_bina: r.bina_tamamlandi,
            stat_emsal: (r.emsaller && r.emsaller.length >= 4)
        };

        for (let dotId in kontroller) {
            const el = document.getElementById(dotId);
            if (el) {
                if (kontroller[dotId]) { el.textContent = "Tamam"; el.className = "status-dot status-ok"; }
                else { el.textContent = "Eksik"; el.className = "status-dot status-missing"; }
            }
        }
    }

    async function raporKontrolVeKilitle() {
        const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
        const r = reports[id];
        if (r.isLocked) { window.location.href = 'rapor-olustur.html?id=' + id; return; }

        if (confirm("Rapor mÃ¼hÃ¼rlenecek. OnaylÄ±yor musunuz?")) {
            r.isLocked = true;
            reports[id] = r;
            localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
            await bulutaSyncEt();
            location.reload();
        }
    }

    window.onload = function() {
        if (!id) { window.location.href = 'index.html'; return; }
        
        const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
        const r = reports[id];
        if (r) {
            document.getElementById('baslik').textContent = r.propertyName || "Gayrimenkul Raporu";
            durumuGuncelle();
            updateWalletUI();
            if (r.isLocked) {
                document.querySelectorAll('.modÃ¼l-btn').forEach(btn => btn.disabled = true);
                document.getElementById('kilitMesaji').style.display = 'block';
                const mainBtn = document.getElementById('mainBtn');
                mainBtn.textContent = "RAPORU GÃ–RÃœNTÃœLE";
                mainBtn.className = "footer-btn locked";
            }
        }
    };
</script>
</body>
</html>
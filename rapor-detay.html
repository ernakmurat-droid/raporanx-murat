<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapor Ana MenÃ¼ - YÃ¶netim Paneli</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script src="firebase-config.js"></script>

    <style>
        :root { --primary: #4a148c; --accent: #7c4dff; --success: #00c853; --warning: #ffeb3b; --error: #ff5252; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, var(--primary), var(--accent)); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
        .header { padding:20px; text-align:center; position: relative; }
        .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; font-size: 14px; border: none; cursor: pointer; }
        .wallet-status { position: absolute; right: 15px; top: 15px; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .wallet-status:hover { background: rgba(0,0,0,0.5); }
        .menu { flex:1; display:flex; flex-wrap:wrap; gap:15px; padding:20px; justify-content:center; align-content:flex-start; }
        .btn { flex: 1 1 320px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 25px; font-size: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer; transition: 0.3s; position: relative; text-align: left; }
        .btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); transform: translateY(-3px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-dot { position: absolute; top: 12px; right: 15px; font-size: 12px; padding: 4px 10px; border-radius: 10px; font-weight: bold; }
        .status-missing { background: var(--error); color: white; }
        .status-incomplete { background: var(--warning); color: #333; }
        .status-ok { background: var(--success); color: white; }
        .footer-btn { background:#ff5722; padding:20px; font-size:22px; width:90%; max-width:500px; margin:15px auto; border-radius:15px; border:none; color:white; font-weight:bold; cursor: pointer; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .footer-btn.locked { background: #2196F3; }
        .footer-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        #kilitMesaji { display: none; background: rgba(255,112,67,0.2); border: 1px solid #ff7043; padding: 10px; margin: 10px auto; width: 80%; text-align: center; border-radius: 10px; color: #ffd600; font-weight: bold; }
        @media (max-width: 600px) {
            .header { font-size: 20px; padding-top: 60px; }
            .btn { flex: 1 1 100%; padding: 20px; font-size: 18px; }
            .wallet-status { top: 10px; right: 10px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="index.html" class="back">Ana Sayfa</a>
        <div id="walletBox" class="wallet-status">
            ðŸ’³ <span id="walletText">Kredi: YÃ¼kleniyor...</span>
        </div>
        <div id="baslik" style="margin-top:20px;">Gayrimenkul Raporu</div>
        <div id="kilitMesaji">ðŸ”’ RAPOR MÃœHÃœRLENDÄ° - YALNIZCA GÃ–RÃœNTÃœLEME</div>
    </div>
    
    <div class="menu">
        <button class="btn modÃ¼l-btn" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE <span id="stat_konum" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('tapu_kayit.html')">TAPU KAYITLARI <span id="stat_tapu" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('imar.html')">Ä°MAR DURUMU <span id="stat_imar" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER <span id="stat_belgeler" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ° <span id="stat_bina" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('bagimsiz-bolum-detay.html')">BAÄžIMSIZ BÃ–LÃœM <span id="stat_bb" class="status-dot"></span></button>
        <button class="btn modÃ¼l-btn" onclick="go('emsal.html')">EMSAL ANALÄ°ZÄ° <span id="stat_emsal" class="status-dot"></span></button>
    </div>
   
    <button id="mainBtn" class="footer-btn" onclick="raporKontrolVeKilitle()">RAPORU TAMAMLA VE KÄ°LÄ°TLE</button>

    <script>
        // firebase-config.js bazen db/auth oluÅŸturuyor, bazen oluÅŸturmuyor.
        // Garanti altÄ±na alalÄ±m:
        const db = (window.db) ? window.db : firebase.firestore();
        const auth = (window.auth) ? window.auth : firebase.auth();

        // URL'den Rapor ID'sini Al
        const urlParams = new URLSearchParams(window.location.search);
        const idParam = urlParams.get('id');

        // Eski sistem: id = index (0,1,2...) idi. Åžimdilik onu destekliyoruz.
        const reportIndex = (idParam !== null && idParam !== "" && !isNaN(Number(idParam))) ? Number(idParam) : null;

        // Sayfa DeÄŸiÅŸtirme Fonksiyonu (Parametre Koruyucu)
        function go(page) {
            if (idParam == null) return alert("Rapor ID bulunamadÄ±.");
            window.location.href = page + '?id=' + encodeURIComponent(idParam);
        }

        function isValueEmpty(val) {
            if (!val) return true;
            if (typeof val === 'string' && (val.trim().length < 5 || val.includes("Metin burada oluÅŸacak"))) return true;
            return false;
        }

        function getCurrentReport() {
            const reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
            if (reportIndex === null) return { reports, r: null };
            return { reports, r: reports[reportIndex] };
        }

        async function durumuGuncelle() {
            const { r } = getCurrentReport();
            if (!r) return;

            const kontroller = {
                stat_konum: { veri: r.konumCevre?.tamMetin, tamam: r.konum_tamamlandi },
                stat_tapu: { veri: r.tapuMetniB1, tamam: r.tapu_tamamlandi },
                stat_imar: { veri: r.imarMetni, tamam: r.imar_tamamlandi },
                stat_belgeler: { veri: r.belgelerMetni, tamam: r.belgeler_tamamlandi },
                stat_bina: { veri: r.bina?.metin || r.binaMetni, tamam: r.bina_tamamlandi },
                stat_bb: { veri: r.bbDetay?.tamMetin || r.katDetayMetni, tamam: r.bb_tamamlandi },
                stat_emsal: { veri: r.degerlemeOzet?.emsalFinalMetni, tamam: (r.emsaller && r.emsaller.length >= 4) }
            };

            for (let dotId in kontroller) {
                const el = document.getElementById(dotId);
                const d = kontroller[dotId];
                if (!el) continue;

                if (isValueEmpty(d.veri)) {
                    el.textContent = "Eksik";
                    el.className = "status-dot status-missing";
                } else if (d.tamam === false) {
                    el.textContent = "âš ï¸ Eksik";
                    el.className = "status-dot status-incomplete";
                } else {
                    el.textContent = "Tamam";
                    el.className = "status-dot status-ok";
                }
            }
        }

        async function raporKontrolVeKilitle() {
            const user = auth.currentUser;
            if (!user) return alert("LÃ¼tfen giriÅŸ yapÄ±n!");

            const { reports, r } = getCurrentReport();
            if (!r) return alert("Rapor bulunamadÄ±. Ana sayfaya dÃ¶nÃ¼p tekrar deneyin.");

            // Zaten kilitliyse rapor oluÅŸtur ekranÄ±na git
            if (r.isLocked) {
                window.location.href = 'rapor-olustur.html?id=' + encodeURIComponent(idParam);
                return;
            }

            const mainBtn = document.getElementById('mainBtn');
            mainBtn.disabled = true;

            try {
                const userRef = db.collection("users").doc(user.uid);

                const hatirlatmaMetni = "Veri giriÅŸlerinin tamamÄ±nÄ± yaptÄ±ÄŸÄ±nÄ±zdan emin olun. Rapor mÃ¼hÃ¼rlendikten sonra deÄŸiÅŸiklik yapÄ±lamaz.";

                // Kredi dÃ¼ÅŸÃ¼mÃ¼: transaction (daha saÄŸlam)
                const confirmed = confirm(`${hatirlatmaMetni}\n\nRapor mÃ¼hÃ¼rlensin mi?`);
                if (!confirmed) {
                    mainBtn.disabled = false;
                    return;
                }

                await db.runTransaction(async (tx) => {
                    const snap = await tx.get(userRef);
                    const mevcutKredi = (snap.exists && snap.data().kredi) ? snap.data().kredi : 0;

                    if (mevcutKredi <= 0) {
                        throw new Error("âš ï¸ Krediniz yetersiz! LÃ¼tfen yÃ¼kleme yapÄ±n.");
                    }

                    tx.update(userRef, { kredi: firebase.firestore.FieldValue.increment(-1) });
                });

                // Lokal kilitle
                r.isLocked = true;
                if (reportIndex !== null) reports[reportIndex] = r;
                localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

                // ðŸ”¥ Ã–NEMLÄ°: Burada artÄ±k bÃ¼tÃ¼n rapor listesini Firestoreâ€™a BASMIYORUZ.
                // Ã‡Ã¼nkÃ¼ bu 1MB limite Ã§arpÄ±p veri kaybÄ± yaratÄ±yordu.
                // await userRef.set({ gayrimenkul_reports: reports }, { merge: true });

                alert("âœ… Rapor mÃ¼hÃ¼rlendi. Kredi dÃ¼ÅŸÃ¼ldÃ¼.");
                location.reload();

            } catch (e) {
                console.error(e);
                alert(e?.message || "Bir hata oluÅŸtu.");
                mainBtn.disabled = false;
            }
        }

        // Kimlik ve Kredi KontrolÃ¼
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            const { r } = getCurrentReport();
            if (!r) {
                alert("Rapor bulunamadÄ±. Ana sayfaya yÃ¶nlendiriliyorsunuz.");
                window.location.href = "index.html";
                return;
            }

            document.getElementById('baslik').textContent = r.propertyName || "Gayrimenkul Raporu";
            await durumuGuncelle();

            try {
                const userDoc = await db.collection("users").doc(user.uid).get();
                const kredi = userDoc.exists ? (userDoc.data().kredi || 0) : 0;
                document.getElementById('walletText').textContent = `Kredi: ${kredi}`;
            } catch (e) {
                console.error(e);
                document.getElementById('walletText').textContent = `Kredi: ?`;
            }

            if (r.isLocked) {
                document.querySelectorAll('.modÃ¼l-btn').forEach(btn => btn.disabled = true);
                document.getElementById('kilitMesaji').style.display = 'block';
                const mainBtn = document.getElementById('mainBtn');
                mainBtn.textContent = "TAMAMLANMIÅž RAPORU GÃ–RÃœNTÃœLE";
                mainBtn.className = "footer-btn locked";
            }
        });
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="wallet.js"></script>
<script>
/* WALLET UI START */
(function(){
  const auth = firebase.auth();

  function trStatus(s){
    if(s === "approved") return "OnaylandÄ± âœ…";
    if(s === "user_marked_paid") return "Ã–deme bildirildi â³";
    if(s === "link_added") return "Ã–deme linki hazÄ±r â³";
    if(s === "pending") return "Ã–deme bekleniyor â³";
    if(s === "rejected") return "Reddedildi âŒ";
    if(s === "cancelled") return "Ä°ptal edildi";
    return s || "-";
  }

  function renderOrders(list){
    const wrap = document.getElementById("ordersList");
    if(!wrap) return;
    if(!list || !list.length){
      wrap.innerHTML = `<div style="opacity:.7">HenÃ¼z sipariÅŸ yok.</div>`;
      return;
    }
    wrap.innerHTML = list.map(o => {
      const payLink = o?.payment?.link;
      const btnPay = payLink ? `<a href="${payLink}" target="_blank" style="display:inline-block;margin-right:8px">ğŸ’³ Ã–demeye Git</a>` : "";
      const btnPaid = (o.status !== "approved") ? `<button onclick="markPaidUI('${o.orderId}')">Ã–deme YaptÄ±m</button>` : "";
      return `
        <div style="border:1px solid #eee;border-radius:12px;padding:10px;margin:8px 0">
          <div style="font-weight:700">${o.packTitle || o.packId}</div>
          <div style="margin-top:4px">Durum: <b>${trStatus(o.status)}</b></div>
          <div style="margin-top:8px">${btnPay}${btnPaid}</div>
        </div>
      `;
    }).join("");
  }

  window.buyPack = async function(packId){
    try{
      const o = await Wallet.createOrder(packId);
      alert("SipariÅŸ oluÅŸturuldu âœ… Ã–deme linki hazÄ±rlanacak. (Link gelince burada gÃ¶rÃ¼necek)");
      return o;
    }catch(e){
      alert(e?.message || e);
      throw e;
    }
  };

  window.markPaidUI = async function(orderId){
    try{
      const ref = prompt("Varsa dekont/ref no gir (opsiyonel):") || "";
      await Wallet.markPaid(orderId, ref);
      alert("Tamam âœ… Ã–deme bildirildi. Onaydan sonra haklar yÃ¼klenecek.");
    }catch(e){
      alert(e?.message || e);
    }
  };

  auth.onAuthStateChanged((user) => {
    if(!user) return;
    Wallet.listenOrders(user.uid, (arr) => {
      const filtered = arr.filter(x => ["pending","link_added","user_marked_paid","approved"].includes(x.status));
      renderOrders(filtered);
    });
  });
})();
/* WALLET UI END */
</script>

  <title>Rapor Ana MenÃ¼ - Raporan X</title>

  <style>
    :root{ --hdrH: 78px; }

    body {
      font-family: Arial;
      background: linear-gradient(135deg,#4a148c,#7c4dff);
      margin:0;
      color:white;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }

    /* âœ… Header her zaman Ã¼stte, mobilde de sabit */
    .header {
      padding: calc(16px + env(safe-area-inset-top, 0px)) 14px 14px;
      text-align:center;
      font-size:26px;
      font-weight:bold;
      position: sticky;
      top: 0;
      z-index: 999999;
      background: linear-gradient(135deg,#4a148c,#7c4dff);
      box-shadow: 0 2px 10px rgba(0,0,0,0.18);
    }

    /* âœ… Mobilde kaybolmayan geri butonu */
    .back {
      position:absolute;
      left:12px;
      top: calc(12px + env(safe-area-inset-top, 0px));
      background:rgba(255,255,255,0.22);
      padding:10px 14px;
      border-radius:999px;
      text-decoration:none;
      color:white;
      font-weight:900;
      z-index: 1000000;
      position: relative;
display: inline-block;
margin: 10px auto 0;
left: auto;
top: auto;


      /* Mobilde baÅŸlÄ±ÄŸÄ±n Ã¼stÃ¼ne taÅŸma olmasÄ±n */
      max-width: 44vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* âœ… BaÅŸlÄ±k geri butonuna Ã§arpmasÄ±n */
    #baslik{
      padding: 0 64px; /* solda back, saÄŸda boÅŸluk */
      line-height: 1.2;
    }

    #kilitMesaji{
      display:none;
      max-width:1100px;
      margin:10px auto 0;
      width: calc(100% - 40px);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 14px;
      padding:10px 14px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .topbar{
      max-width:1100px;
      width: calc(100% - 40px);
      margin: 0 auto 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 0 20px;
    }

    .wallet-card{
      flex: 1 1 420px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      cursor: pointer;
      user-select:none;
    }
    .wallet-title{ font-weight:900; letter-spacing:.4px; display:flex; align-items:center; gap:10px; }
    .wallet-sub{ font-size:12px; opacity:.9; margin-top:6px; line-height:1.35; }
    .wallet-amount{
      font-size:20px;
      font-weight:900;
      margin-left:auto;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .wallet-hidden{ filter: blur(6px); transition: filter .2s ease; }
    .wallet-card.reveal .wallet-hidden{ filter: blur(0); }

    .menu {
      flex:1;
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      padding:30px;
      justify-content:center;
      align-content:flex-start;
    }

    .btn {
      flex:1 1 350px;
      background:#6a1b9a;
      padding:35px;
      font-size:24px;
      font-weight:bold;
      border:none;
      border-radius:20px;
      color:white;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
      transition: 0.3s;
      position:relative;
    }
    .btn:hover { background:#8e24aa; transform:scale(1.05); }
    .btn-main-feature { background: #4527a0; border: 2px solid #b39ddb; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn:hover:disabled{ background:#6a1b9a; transform:none; }

    .footer-btn {
      background:#ff5722;
      padding:25px;
      font-size:28px;
      width:90%;
      max-width:600px;
      margin:20px auto;
      border-radius:20px;
      border:none;
      color:white;
      font-weight:bold;
      cursor: pointer;
      text-align: center;
      margin-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
    }
    .footer-btn.locked{ background:#2196F3; }

    @media (max-width: 600px){
      .header{
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        font-size:20px;
        padding: calc(14px + env(safe-area-inset-top, 0px)) 12px 12px;
      }
      body{
        padding-top: calc(var(--hdrH) + env(safe-area-inset-top, 0px));
      }
      .menu{ padding: 20px; }
      .btn{ flex:1 1 100%; padding: 26px; font-size: 20px; }
      .footer-btn{ font-size: 24px; padding: 20px; }

      .back{
        padding: 10px 12px;
        top: calc(10px + env(safe-area-inset-top, 0px));
      }
      #baslik{ padding: 0 56px; }
    }
  </style>
  
</head>

<body oncontextmenu="return false;">

<script>
(function(){
  const p = new URLSearchParams(location.search);
  const rid0 = (p.get("rid") || "").toString().trim();
  window.__RID__ = rid0;

  window.go = function(page){
    const rid = (window.__RID__ || "").toString().trim();
    if (!rid) { location.href = "index.html"; return; }
    location.href = page + "?rid=" + encodeURIComponent(rid);
  };

  window.raporOlusturUyari = function(){
    const rid = (window.__RID__ || "").toString().trim();
    if (!rid) { location.href="index.html"; return; }
    const msg =
`UYARI! (Ã–NEMLÄ°)
Tam rapor oluÅŸturulduÄŸunda Ã¼cret/Ã¼cretsiz hak dÃ¼ÅŸebilir.Para ve zaman kaybÄ± yaÅŸamamak iÃ§in bÃ¼tÃ¼n modÃ¼llerde veri girÅŸlerinizin tamamlamÄ±ÅŸ olduÄŸunuzu kontrol edin
Devam etmek istiyor musunuz?`;
    if (!confirm(msg)) return;
    location.href = "rapor-olustur.html?rid=" + encodeURIComponent(rid) + "&confirm=1";
  };
})();
</script>

  <div class="header">
        <div id="baslik">Gayrimenkul Raporu</div>
  </div>

  <div id="kilitMesaji">ğŸ”’ RAPOR KÄ°LÄ°TLÄ° / FINAL â€” ModÃ¼ller gÃ¶rÃ¼ntÃ¼leme modunda.</div>

  <div class="topbar">
    <div id="walletCard" class="wallet-card">
      <div class="wallet-title">
        ğŸ’³ CÃ¼zdan
        <span id="walletAmount" class="wallet-amount wallet-hidden">yÃ¼kleniyor...</span>
      </div>
      <div id="walletSub" class="wallet-sub">Bakiye gizlidir. GÃ¶rmek iÃ§in karta tÄ±kla.</div>
    </div>
  </div>
  <a href="index.html" class="back">â† Ana Sayfa</a>

  <div class="menu">
    <button class="btn btn-main-feature modÃ¼l-btn" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE Ã–ZELLÄ°KLERÄ°</button>
    <button class="btn modÃ¼l-btn" onclick="go('tapu_kayit.html')">TAPU KAYIT BÄ°LGÄ°LERÄ°</button>
    <button class="btn modÃ¼l-btn" onclick="go('imar.html')">Ä°MAR DURUMU</button>
    <button class="btn modÃ¼l-btn" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER</button>
    <button class="btn modÃ¼l-btn" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ°</button>

    <!-- âœ… BURASI DÃœZELTÄ°LDÄ°: kat-detay.html YANLIÅTI -->
    <button class="btn modÃ¼l-btn" onclick="go('bagimsiz-bolum-detay.html')">BAÄIMSIZ BÃ–LÃœM DETAY</button>

    <button class="btn modÃ¼l-btn" onclick="go('emsal.html')">EMSAL KARÅILAÅTIRMA</button>
  </div>

  <button id="btnRaporOlustur" class="footer-btn" onclick="raporOlusturUyari()">TAM RAPOR OLUÅTUR</button>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  // âœ… CANLI SENKRON (Ã§ok basit)
// BaÅŸka cihazdan rapor deÄŸiÅŸince bu sayfa otomatik gÃ¼ncellenecek.

let _unsubReport = null;

function startLiveSync(user, rid){
  try {
    if (_unsubReport) _unsubReport();
  } catch(e){}

  if (!user || !rid) return;

  const ref = db
    .collection("users")
    .doc(user.uid)
    .collection("reports")
    .doc(rid);

  _unsubReport = ref.onSnapshot((snap) => {
    if (!snap.exists) return;

    const cloudReport = snap.data() || {};

    // âœ… localStorage "gayrimenkul_reports" gÃ¼ncelle
    let arr = [];
    try {
      arr = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]");
    } catch(e){
      arr = [];
    }

    const idx = arr.findIndex(r => r && String(r.rid) === String(rid));
    if (idx === -1) {
      arr.unshift(cloudReport);
    } else {
      arr[idx] = cloudReport;
    }

    localStorage.setItem("gayrimenkul_reports", JSON.stringify(arr));

    // âœ… BaÅŸlÄ±ÄŸÄ± gÃ¼ncelle
    const baslikEl = document.getElementById("baslik");
    if (baslikEl) {
      baslikEl.textContent = cloudReport.propertyName || "Rapor DetayÄ±";
    }

    // âœ… Kilit geldiyse uygula
    if (
      cloudReport.isLocked === true ||
      cloudReport.locked === true ||
      cloudReport.final === true
    ) {
      if (typeof applyLockedUI === "function") {
        applyLockedUI();
      }
    }
  });
}



  /* ===== Rapor Detay - Cloud Sync (mobil gÃ¼ncelleme) ===== */

function rerenderReportDetail(){
  if (typeof renderReportDetail === "function") return renderReportDetail();
  if (typeof renderReport === "function") return renderReport();
  if (typeof renderPage === "function") return renderPage();
  if (typeof init === "function") return init();
  if (typeof loadReport === "function") return loadReport();
}

  const params = new URLSearchParams(location.search);
  let rid = (params.get("rid") || "").toString().trim();
  window.__RID__ = rid;

  function readReports(){
    try{ return JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }
    catch(e){ return []; }
  }

  function findByRid(arr, rid){
    return (arr||[]).find(r => r && String(r.rid) === String(rid)) || null;
  }

  function applyLockedUI(){
    document.getElementById("kilitMesaji").style.display = "block";
    document.querySelectorAll(".modÃ¼l-btn").forEach(b => b.disabled = true);

    const btn = document.getElementById("btnRaporOlustur");
    btn.textContent = "TAMAMLANMIÅ RAPORU GÃ–RÃœNTÃœLE";
    btn.classList.add("locked");
    btn.onclick = () => location.href = "rapor-olustur.html?rid=" + encodeURIComponent(rid);
  }

  async function isLockedRemoteStrict(uid){
    try{
      const lockId = `${uid}_${rid}`;
      const s = await db.collection("locks").doc(lockId).get();
      return s.exists && s.data()?.locked === true;
    }catch(e){ return false; }
  }

  window.openWalletModal = function(){
  const m = document.getElementById("walletModal");
  if(m) m.style.display = "block";
};

window.closeWalletModal = function(){
  const m = document.getElementById("walletModal");
  if(m) m.style.display = "none";
};

document.getElementById("walletCard").addEventListener("click", ()=>{
  openWalletModal();
});


  await Wallet.load(user.uid);


auth.onAuthStateChanged(async (user)=>{
  if (!user || !rid) { location.href="index.html"; return; }

  startLiveSync(user, rid);

  const reports = readReports();
  const report = findByRid(reports, rid);
  if (!report) { location.href="index.html"; return; }

  document.getElementById("baslik").textContent = report.propertyName || "Rapor DetayÄ±";
  await loadWallet(user);

  const lockedLocal = (report.isLocked === true || report.locked === true || report.final === true);
  const lockedRemote = lockedLocal ? false : await isLockedRemoteStrict(user.uid);

  if (lockedLocal || lockedRemote) applyLockedUI();
});

</script>
<!-- WALLET MODAL -->
<div id="walletModal" style="display:none; position:fixed; inset:0; z-index:9999999; background:rgba(0,0,0,.55);">
  <div style="max-width:560px; margin: 80px auto 0; background:#fff; color:#222; border-radius:16px; padding:14px; box-shadow:0 20px 60px rgba(0,0,0,.35);">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div style="font-weight:900; font-size:18px;">ğŸ’³ CÃ¼zdan</div>
      <button onclick="closeWalletModal()" style="border:none; background:#eee; padding:8px 12px; border-radius:10px; cursor:pointer;">Kapat âœ–</button>
    </div>

    <div style="margin-top:10px; padding:12px; border:1px solid #eee; border-radius:12px;">
      <div style="font-weight:900;">Mevcut Hak</div>
      <div style="opacity:.8; margin-top:4px;">
        Ãœstteki kartta toplam hak yazÄ±yor. (Ãœcretsiz + Paket)
      </div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:900; margin-bottom:8px;">ğŸŸï¸ Paket SatÄ±n Al</div>
      <div style="display:grid; gap:10px;">
        <button onclick="buyPack('P120')" style="padding:12px;border-radius:12px;border:1px solid #ddd;cursor:pointer;">120 TL â€¢ 4 Hak</button>
        <button onclick="buyPack('P200')" style="padding:12px;border-radius:12px;border:1px solid #ddd;cursor:pointer;">200 TL â€¢ 8 Hak</button>
        <button onclick="buyPack('P500')" style="padding:12px;border-radius:12px;border:1px solid #ddd;cursor:pointer;">500 TL â€¢ 25 Hak</button>
      </div>
      <div style="opacity:.7; font-size:12px; margin-top:8px;">
        Not: Ã–deme linki admin tarafÄ±ndan eklenir. Link gelince aÅŸaÄŸÄ±da gÃ¶rÃ¼nÃ¼r.
      </div>
    </div>

    <div style="margin-top:14px">
      <div style="font-weight:900;margin-bottom:8px">ğŸ“¦ SipariÅŸlerim</div>
      <div id="ordersList">YÃ¼kleniyorâ€¦</div>
    </div>
  </div>
</div>

</body>
</html>








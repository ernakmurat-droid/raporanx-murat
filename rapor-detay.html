<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- âœ… Wallet (senin dosyan) -->
  <script src="wallet.js"></script>

  <title>Rapor Ana MenÃ¼ - Raporan X</title>

  <style>
    body { font-family: Arial; background: linear-gradient(135deg,#4a148c,#7c4dff); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
    .header { padding:20px; text-align:center; font-size:28px; font-weight:bold; position: relative; }
    .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; }

    .topbar{
      max-width:1100px;
      width: calc(100% - 40px);
      margin: 0 auto 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 0 20px;
    }

    /* Wallet kartÄ± */
    .wallet-card{
      flex: 1 1 420px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      cursor: pointer;
      user-select:none;
    }
    .wallet-title{ font-weight:900; letter-spacing:.4px; display:flex; align-items:center; gap:10px; }
    .wallet-sub{ font-size:12px; opacity:.9; margin-top:6px; line-height:1.35; }
    .wallet-amount{
      font-size:20px;
      font-weight:900;
      margin-left:auto;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .wallet-hidden{
      filter: blur(6px);
      transition: filter .2s ease;
    }
    .wallet-card.reveal .wallet-hidden{ filter: blur(0); }

    .menu { flex:1; display:flex; flex-wrap:wrap; gap:20px; padding:30px; justify-content:center; align-content:flex-start; }
    .btn { flex:1 1 350px; background:#6a1b9a; padding:35px; font-size:24px; font-weight:bold; border:none; border-radius:20px; color:white; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; position:relative; }
    .btn:hover { background:#8e24aa; transform:scale(1.05); }
    .btn-main-feature { background: #4527a0; border: 2px solid #b39ddb; }

    .footer-btn { background:#ff5722; padding:25px; font-size:28px; width:90%; max-width:600px; margin:20px auto; border-radius:20px; border:none; color:white; font-weight:bold; cursor: pointer; text-align: center; }

    /* kÃ¼Ã§Ã¼k rozet alanÄ± (istersen sonra modÃ¼l tikleri buraya) */
    .modBadge{
      position:absolute;
      right:16px;
      top:16px;
      font-size:22px;
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.35));
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <a href="index.html" class="back">Ana Sayfa</a>
    <div id="baslik">Gayrimenkul Raporu</div>
  </div>

  <!-- âœ… CÃ¼zdan barÄ±: tÄ±kla aÃ§/kapat -->
  <div class="topbar">
    <div id="walletCard" class="wallet-card" title="Bakiye detayÄ±nÄ± gÃ¶rmek iÃ§in tÄ±kla">
      <div class="wallet-title">
        ðŸ’³ CÃ¼zdan
        <span id="walletAmount" class="wallet-amount wallet-hidden">yÃ¼kleniyor...</span>
      </div>
      <div id="walletSub" class="wallet-sub">
        Bakiye gizlidir. GÃ¶rmek iÃ§in karta tÄ±kla.
      </div>
    </div>
  </div>

  <div class="menu">
    <button class="btn btn-main-feature" data-modul="konum" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE Ã–ZELLÄ°KLERÄ°</button>
    <button class="btn" data-modul="tapu" onclick="go('tapu_kayit.html')">TAPU KAYIT BÄ°LGÄ°LERÄ°</button>
    <button class="btn" data-modul="imar" onclick="go('imar.html')">Ä°MAR DURUMU</button>
    <button class="btn" data-modul="belgeler" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER</button>
    <button class="btn" data-modul="bina" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ°</button>
    <button class="btn" data-modul="bb" onclick="go('bagimsiz-bolum-detay.html')">BAÄžIMSIZ BÃ–LÃœM DETAY</button>
    <button class="btn" data-modul="emsal" onclick="go('emsal.html')">EMSAL KARÅžILAÅžTIRMA</button>
  </div>

  <!-- âœ… burada uyarÄ± var: rapor-olustur'a onay parametresiyle gider -->
  <button class="footer-btn" onclick="raporOlusturUyari()">TAM RAPOR OLUÅžTUR</button>

<script>
(function(){
  const auth = (window.auth) ? window.auth : firebase.auth();
  const db   = (window.db)   ? window.db   : firebase.firestore();

  const $ = (id) => document.getElementById(id);

  function setStatus(title, detail){
    const el = document.getElementById("statusBar");
    if (!el) return;
    el.textContent = title;
    const sm = document.createElement("small");
    sm.textContent = detail || "";
    el.appendChild(sm);
  }

  function getRid(){
    const p = new URLSearchParams(location.search);
    return (p.get("rid") || p.get("id") || "").toString().trim();
  }

  function isLockedLocal(rid){
    return localStorage.getItem("report_locked_" + rid) === "1";
  }

  function formatMetin(t){
    if (t === null || t === undefined) return "";
    const s = String(t);
    return s.replace(/\r\n/g, "\n")
      .replace(/[ \t]+\n/g, "\n")
      .replace(/\n{3,}/g, "\n\n")
      .trim();
  }

  function pick(obj, ...paths){
    for (const p of paths){
      try{
        const val = p.split(".").reduce((acc,k)=> (acc && acc[k] !== undefined ? acc[k] : undefined), obj);
        if (val !== undefined && val !== null && String(val).trim() !== "") return val;
      }catch{}
    }
    return "";
  }

  function loadReports(){
    try { return JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }
    catch { return []; }
  }
  function saveReports(arr){
    localStorage.setItem("gayrimenkul_reports", JSON.stringify(arr || []));
  }

  function findReportByRid(rid){
    const reports = loadReports();
    const i = reports.findIndex(r => String(r?.rid ?? "").trim() === String(rid));
    return { reports, i, report: i >= 0 ? reports[i] : null };
  }

  // rid iÃ§eren localStorage parÃ§alarÄ±nÄ± topla (modÃ¼llere dokunmadan)
  function collectModulePiecesByRid(rid){
    const out = {};
    const ridStr = String(rid);

    for (let i=0; i<localStorage.length; i++){
      const key = localStorage.key(i);
      if (!key) continue;
      if (!key.includes(ridStr)) continue;

      const raw = localStorage.getItem(key);
      if (!raw) continue;

      let val = raw;
      try { val = JSON.parse(raw); } catch {}

      const k = key.toLowerCase();
      if (k.includes("konum")) out.konum = val;
      else if (k.includes("tapu")) out.tapu = val;
      else if (k.includes("imar")) out.imar = val;
      else if (k.includes("belge")) out.belgeler = val;
      else if (k.includes("bina")) out.bina = val;
      else if (k.includes("bagimsiz") || k.includes("bb")) out.bb = val;
      else if (k.includes("emsal") || k.includes("degerleme")) out.emsal = val;
      else {
        out._others = out._others || [];
        out._others.push({ key, val });
      }
    }
    return out;
  }

  function mergePiecesIntoReport(report, pieces){
    const r = report || {};

    const safeSet = (path, value) => {
      if (value === undefined || value === null) return;
      if (typeof value === "string" && value.trim() === "") return;

      const parts = path.split(".");
      let cur = r;
      for (let i=0; i<parts.length-1; i++){
        cur[parts[i]] = cur[parts[i]] || {};
        cur = cur[parts[i]];
      }
      const last = parts[parts.length-1];
      if (cur[last] === undefined || cur[last] === null || String(cur[last]).trim() === "") {
        cur[last] = value;
      }
    };

    if (pieces.konum){
      safeSet("konumCevre", pieces.konum);
      safeSet("konumMetni", pieces.konum?.tamMetin || pieces.konum?.metin || pieces.konum);
    }
    if (pieces.tapu){
      safeSet("tapu", pieces.tapu);
      safeSet("tapuMetniB1", pieces.tapu?.tapuMetniB1 || pieces.tapu?.b1 || pieces.tapu);
      safeSet("tapuMetniB2", pieces.tapu?.tapuMetniB2 || pieces.tapu?.b2 || "");
    }
    if (pieces.imar){
      safeSet("imar", pieces.imar);
      safeSet("imarTablo", pieces.imar?.imarTablo || pieces.imar?.tablo || "");
      safeSet("imarMetni", pieces.imar?.imarMetni || pieces.imar?.metin || pieces.imar?.tamMetin || pieces.imar);
    }
    if (pieces.belgeler){
      safeSet("belgeler", pieces.belgeler);
      safeSet("belgelerMetni", pieces.belgeler?.belgelerMetni || pieces.belgeler?.metin || pieces.belgeler?.tamMetin || pieces.belgeler);
    }
    if (pieces.bina){
      safeSet("bina", pieces.bina);
      safeSet("bina.metin", pieces.bina?.metin || pieces.bina?.tamMetin || pieces.bina);
    }
    if (pieces.bb){
      safeSet("bbDetayList", Array.isArray(pieces.bb) ? pieces.bb : (pieces.bb?.bbDetayList || pieces.bb?.list || []));
    }
    if (pieces.emsal){
      safeSet("degerlemeOzet", pieces.emsal?.degerlemeOzet || pieces.emsal);
      safeSet("emsalFinalMetni", pieces.emsal?.emsalFinalMetni || pieces.emsal?.finalMetin || "");
    }
    return r;
  }

  function bbYazdir(list){
    if (!Array.isArray(list) || list.length === 0) return "BaÄŸÄ±msÄ±z bÃ¶lÃ¼m verisi yok";
    return list.map((bb,i)=>{
      const baslik = bb?.baslik || bb?.title || "BaÄŸÄ±msÄ±z BÃ¶lÃ¼m";
      const metin = pick(bb, "bbDetay.tamMetin", "bbDetay.metin", "tamMetin", "metin");
      return `(${i+1}) ${baslik}:\n${formatMetin(metin)}`.trim();
    }).join("\n\n");
  }

  function emsalMetni(rep){
    const direct = pick(rep, "emsalFinalMetni", "degerlemeOzet.emsalFinalMetni", "degerleme.emsalFinalMetni");
    if (direct) return formatMetin(direct);

    const list = rep?.bbDetayList;
    if (Array.isArray(list) && list.length){
      const uniq = new Set();
      const arr = [];
      for (const bb of list){
        const t = pick(bb, "degerlemeOzet.emsalFinalMetni", "emsalFinalMetni", "degerleme.emsalFinalMetni");
        const ft = formatMetin(t);
        if (!ft) continue;
        if (uniq.has(ft)) continue;
        uniq.add(ft);
        arr.push(ft);
      }
      return arr.length ? arr.join("\n\n") : "Emsal analizi bulunamadÄ±";
    }
    return "Emsal verisi yok";
  }

  function renderReportFromLocal(rid){
    $("raporTarih").textContent = "Tarih: " + new Date().toLocaleDateString("tr-TR");

    let raporlar = [];
    try { raporlar = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); } catch { raporlar = []; }

    const report =
      raporlar.find(r => String(r?.rid ?? "").trim() === rid) ||
      raporlar.find(r => String(r?.rid ?? "").trim() === String(Number(rid))) ||
      null;

    let report2 = null;
    if (!report && rid){
      try {
        const maybe = localStorage.getItem("rapor_" + rid);
        if (maybe) report2 = JSON.parse(maybe);
      } catch {}
    }

    const r = report || report2;
    if (!r) throw new Error("Rapor bulunamadÄ±! (rid/id: " + rid + ")");

    $("genelBilgi").innerHTML = `
      <div><b>Ä°l / Ä°lÃ§e:</b> ${pick(r,"il") || "-"} / ${pick(r,"ilce") || "-"}</div>
      <div><b>Ada / Parsel:</b> ${pick(r,"ada") || "-"} / ${pick(r,"parsel") || "-"}</div>
      <div><b>TaÅŸÄ±nmaz:</b> ${pick(r,"propertyName","tasÄ±nmazAdi","tasinmazAdi","baslik") || "TanÄ±msÄ±z"}</div>
    `;

    const imarTablo = pick(r,"imarTablo");
    $("imarTablo").innerHTML = imarTablo || "<div class='warning'>Ä°mar tablosu bulunamadÄ±</div>";

    $("imarMetin").textContent = formatMetin(pick(r, "imarMetni", "imar.metin", "imar.tamMetin"));
    $("belgelerMetin").textContent = formatMetin(pick(r, "belgelerMetni", "belgeler.metin", "belgeler.tamMetin"));
    $("binaMetin").textContent = formatMetin(pick(r, "bina.metin", "bina.tamMetin", "binaMetni", "binaMetin"));
    $("bbMetin").textContent = bbYazdir(r.bbDetayList || r.bbList || r.bagimsizBolumler);
    $("konumMetin").textContent = formatMetin(pick(r, "konumCevre.tamMetin", "konumCevre.metin", "konumMetni", "konumMetin"));
    $("tapuMetinB1").textContent = formatMetin(pick(r, "tapuMetniB1", "tapu.b1", "tapuMetinB1"));
    $("tapuMetinB2").textContent = formatMetin(pick(r, "tapuMetniB2", "tapu.b2", "tapuMetinB2"));
    $("emsalMetin").textContent = emsalMetni(r);
  }

  async function autoLockFinal(rid, uid){
    // kilidi hem local hem firestore bas
    await db.collection("reports").doc(rid).set({
      ownerUid: uid,
      status: "final",
      locked: true,
      lockedAt: firebase.firestore.FieldValue.serverTimestamp(),
      lockedBy: uid
    }, { merge:true });
    localStorage.setItem("report_locked_" + rid, "1");
  }

  let busy = false;

  async function raporOlusturVeKilitle(){
    if (busy) return;
    busy = true;

    const rid = getRid();
    if (!rid){ alert("rid yok"); busy=false; return; }

    if (isLockedLocal(rid)){
      alert("ðŸ”’ Bu rapor zaten kilitli. GÃ¼ncellemek iÃ§in yeni rapor kaydÄ± aÃ§malÄ±sÄ±n.");
      busy=false;
      return;
    }

    const user = auth.currentUser;
    if (!user){ alert("GiriÅŸ yok"); busy=false; return; }

    const msg =
`UYARI! (Ã–NEMLÄ°)
Tam rapor oluÅŸturulduÄŸunda Ã¼cret/Ã¼cretsiz hak dÃ¼ÅŸebilir.

LÃ¼tfen zaman ve para kaybÄ± olmamasÄ± iÃ§in tÃ¼m modÃ¼lleri tekrar kontrol edin.
Devam ederseniz rapor bankaya uygun taslak formatÄ±nda Ã¼retilecektir.

Devam etmek istiyor musunuz?`;

    if (!confirm(msg)){ busy=false; return; }

    try{
      if (!window.Wallet || typeof Wallet.consumeReport !== "function"){
        throw new Error("Wallet.consumeReport yok. (wallet.js gÃ¼ncel deÄŸil)");
      }

      setStatus("ðŸ’³ CÃ¼zdan iÅŸlemiâ€¦", "Ãœcret/Ã¼cretsiz hak rapordan Ã–NCE dÃ¼ÅŸÃ¼rÃ¼lÃ¼r.");
      const ok = await Wallet.consumeReport(user.uid, rid);
      if (!ok) throw new Error("Yetersiz bakiye / Ã¼cretsiz hak yok.");

      setStatus("ðŸ§¾ Rapor toparlanÄ±yorâ€¦", "Metinler boÅŸsa localStorage parÃ§alarÄ±ndan rid ile toplanÄ±r.");
      let { reports, i, report } = findReportByRid(rid);
      report = report || { rid };

      const pieces = collectModulePiecesByRid(rid);
      report = mergePiecesIntoReport(report, pieces);

      if (i >= 0) reports[i] = report; else reports.push(report);
      saveReports(reports);

      setStatus("ðŸ”’ Kilit basÄ±lÄ±yorâ€¦", "Rapor oluÅŸturuldu ve otomatik kilitleniyor.");
      await autoLockFinal(rid, user.uid);

      setStatus("âœ… HazÄ±r.", "Rapor oluÅŸturuldu ve kilitlendi. YazdÄ±rabilir / PDF alabilirsin.");
      renderReportFromLocal(rid);
    }catch(e){
      console.error(e);
      setStatus("âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z.", (e?.message || e));
      alert(e?.message || "Hata oluÅŸtu");
    }finally{
      busy = false;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    // sayfada statusBar yoksa patlatma
    if (!document.getElementById("statusBar")){
      const bar = document.createElement("div");
      bar.id = "statusBar";
      bar.style.cssText="max-width:1300px;margin:12px auto 0;padding:10px 14px;border-radius:12px;background:#fff;box-shadow:0 4px 14px rgba(0,0,0,.06);border-left:6px solid #3949ab;color:#2c3e50;font-weight:800;";
      bar.textContent="HazÄ±r.";
      document.body.insertBefore(bar, document.body.firstChild.nextSibling);
    }

    // EÄŸer sayfanda buton yoksa otomatik ekle (mevcutsa dokunmaz)
    if (!document.getElementById("btnRaporOlustur")){
      const btn = document.createElement("button");
      btn.id = "btnRaporOlustur";
      btn.className = "print-btn";
      btn.style.background = "#ff5722";
      btn.textContent = "ðŸ§¾ Rapor OluÅŸtur";
      const container = document.querySelector(".container");
      if (container) container.insertBefore(btn, container.firstChild);
    }

    const btn = document.getElementById("btnRaporOlustur");
    if (btn) btn.onclick = raporOlusturVeKilitle;

    auth.onAuthStateChanged((user)=>{
      if (!user){
        setStatus("âŒ GiriÅŸ yok.", "Ana sayfaya yÃ¶nlendiriliyorâ€¦");
        setTimeout(()=>location.href="index.html", 400);
        return;
      }
      try{
        const rid = getRid();
        setStatus("HazÄ±r.", isLockedLocal(rid) ? "Bu rapor kilitli. Yeni rapor aÃ§Ä±p devam edebilirsin." : "Rapor OluÅŸtur butonuna basabilirsin.");
        if (rid) renderReportFromLocal(rid);
      }catch(e){
        console.log(e);
      }
    });
  });
})();
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Wallet (dokunmuyoruz) -->
  <script src="wallet.js"></script>

  <title>Rapor Ana MenÃ¼ - Raporan X</title>

  <style>
    :root{ --hdrH: 78px; }

    body{
      font-family: Arial;
      background: linear-gradient(135deg,#4a148c,#7c4dff);
      margin:0;
      color:white;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }

    .header{
      padding: calc(20px + env(safe-area-inset-top, 0px)) 20px 20px;
      text-align:center;
      font-size:28px;
      font-weight:bold;
      position: sticky;
      top: 0;
      z-index: 999999;
      background: linear-gradient(135deg,#4a148c,#7c4dff);
    }

    .back{
      position:absolute;
      left:15px;
      top: calc(20px + env(safe-area-inset-top, 0px));
      background:rgba(255,255,255,0.2);
      padding:10px 20px;
      border-radius:30px;
      text-decoration:none;
      color:white;
      font-weight:bold;
      z-index: 1000000;
    }

    /* âœ… kilit mesajÄ± (sadece gÃ¶rÃ¼nÃ¼r/gÃ¶rÃ¼nmez) */
    #kilitMesaji{
      display:none;
      max-width:1100px;
      margin:10px auto 0;
      width: calc(100% - 40px);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 14px;
      padding:10px 14px;
      font-size: 14px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .topbar{
      max-width:1100px;
      width: calc(100% - 40px);
      margin: 0 auto 10px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 0 20px;
    }

    .wallet-card{
      flex: 1 1 420px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      cursor: pointer;
      user-select:none;
    }
    .wallet-title{ font-weight:900; letter-spacing:.4px; display:flex; align-items:center; gap:10px; }
    .wallet-sub{ font-size:12px; opacity:.9; margin-top:6px; line-height:1.35; }
    .wallet-amount{
      font-size:20px;
      font-weight:900;
      margin-left:auto;
      padding:6px 10px;
      border-radius:12px;
      background: rgba(0,0,0,0.18);
      border: 1px solid rgba(255,255,255,0.18);
    }
    .wallet-hidden{ filter: blur(6px); transition: filter .2s ease; }
    .wallet-card.reveal .wallet-hidden{ filter: blur(0); }

    .menu{
      flex:1;
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      padding:30px;
      justify-content:center;
      align-content:flex-start;
    }
    .btn{
      flex:1 1 350px;
      background:#6a1b9a;
      padding:35px;
      font-size:24px;
      font-weight:bold;
      border:none;
      border-radius:20px;
      color:white;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
      transition: 0.3s;
      position:relative;
    }
    .btn:hover{ background:#8e24aa; transform:scale(1.05); }
    .btn-main-feature{ background: #4527a0; border: 2px solid #b39ddb; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn:hover:disabled{ background:#6a1b9a; transform:none; }

    .footer-btn{
      background:#ff5722;
      padding:25px;
      font-size:28px;
      width:90%;
      max-width:600px;
      margin:20px auto;
      border-radius:20px;
      border:none;
      color:white;
      font-weight:bold;
      cursor: pointer;
      text-align: center;
    }
    .footer-btn.locked{
      background:#2196F3;
    }

    @media (max-width: 600px){
      .header{
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        font-size:22px;
      }
      body{
        padding-top: calc(var(--hdrH) + env(safe-area-inset-top, 0px));
      }
      .menu{ padding: 20px; }
      .btn{ flex:1 1 100%; padding: 26px; font-size: 20px; }
      .footer-btn{ font-size: 24px; padding: 20px; }
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <a href="index.html" class="back">Ana Sayfa</a>
    <div id="baslik">Gayrimenkul Raporu</div>
  </div>

  <div id="kilitMesaji">ðŸ”’ RAPOR KÄ°LÄ°TLÄ° / FINAL â€” ModÃ¼ller gÃ¶rÃ¼ntÃ¼leme modunda.</div>

  <div class="topbar">
    <div id="walletCard" class="wallet-card" title="Bakiye detayÄ±nÄ± gÃ¶rmek iÃ§in tÄ±kla">
      <div class="wallet-title">
        ðŸ’³ CÃ¼zdan
        <span id="walletAmount" class="wallet-amount wallet-hidden">yÃ¼kleniyor...</span>
      </div>
      <div id="walletSub" class="wallet-sub">
        Bakiye gizlidir. GÃ¶rmek iÃ§in karta tÄ±kla.
      </div>
    </div>
  </div>

  <div class="menu">
    <button class="btn btn-main-feature modÃ¼l-btn" data-modul="konum" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE Ã–ZELLÄ°KLERÄ°</button>
    <button class="btn modÃ¼l-btn" data-modul="tapu" onclick="go('tapu_kayit.html')">TAPU KAYIT BÄ°LGÄ°LERÄ°</button>
    <button class="btn modÃ¼l-btn" data-modul="imar" onclick="go('imar.html')">Ä°MAR DURUMU</button>
    <button class="btn modÃ¼l-btn" data-modul="belgeler" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER</button>
    <button class="btn modÃ¼l-btn" data-modul="bina" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ°</button>
    <button class="btn modÃ¼l-btn" data-modul="bb" onclick="go('bagimsiz-bolum-detay.html')">BAÄžIMSIZ BÃ–LÃœM DETAY</button>
    <button class="btn modÃ¼l-btn" data-modul="emsal" onclick="go('emsal.html')">EMSAL KARÅžILAÅžTIRMA</button>
  </div>

  <button id="btnRaporOlustur" class="footer-btn" onclick="raporOlusturUyari()">TAM RAPOR OLUÅžTUR</button>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && String(r.rid) === String(rid));
  }

  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  const legacyId = urlParams.get('id');

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idx = Number(legacyId);
    if (!Number.isNaN(idx) && reports[idx] && reports[idx].rid) {
      rid = reports[idx].rid;
      window.location.replace("rapor-detay.html?rid=" + encodeURIComponent(rid));
    }
  }

  function getReportIndexByRid(){
    reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(reports, rid) : -1;
    return i;
  }
  function getReportByRid(){
    const i = getReportIndexByRid();
    if (i < 0) return null;
    return reports[i];
  }

  function go(page){
    if (!rid) { window.location.href="index.html"; return; }
    window.location.href = page + "?rid=" + encodeURIComponent(rid);
  }

  /* ========= KÄ°LÄ°T: rapor-detay KÃ–R OLMASIN ========= */
  function isLockedLocalFlag(){
    return localStorage.getItem("report_locked_" + rid) === "1";
  }
  function isLockedInLocalReports(){
    try{
      const arr = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]");
      const idx = findIndexByRid(arr, rid);
      if (idx < 0) return false;
      const r = arr[idx] || {};
      return (r.isLocked === true || r.locked === true || r.final === true);
    }catch(e){
      return false;
    }
  }
  function markLockedInLocal(){
    try{
      localStorage.setItem("report_locked_" + rid, "1");
      const arr = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]");
      const idx = findIndexByRid(arr, rid);
      if (idx >= 0){
        arr[idx].isLocked = true;
        arr[idx].locked = true;
        arr[idx].final = true;
        arr[idx].lockedAt = Date.now();
        localStorage.setItem("gayrimenkul_reports", JSON.stringify(arr));
      }
    }catch(e){}
  }

 async function isLockedRemote(uid){
  // 1) locks/{uid}_{rid}
  try{
    const lockId = `${uid}_${rid}`;
    const snap = await db.collection("locks").doc(lockId).get();
    if (snap.exists){
      const data = snap.data() || {};
      if (data.locked === true && String(data.uid) === String(uid) && String(data.rid) === String(rid)) return true;
    }
  }catch(e){}

  // 2) users/{uid}/locks/{rid}
  try{
    const snap = await db.collection("users").doc(uid).collection("locks").doc(rid).get();
    if (snap.exists){
      const data = snap.data() || {};
      if (data.locked === true && (String(data.uid||uid) === String(uid)) && String(data.rid||rid) === String(rid)) return true;
    }
  }catch(e){}

  // 3) users/{uid}/reports/{rid}
  try{
    const snap = await db.collection("users").doc(uid).collection("reports").doc(rid).get();
    if (snap.exists){
      const data = snap.data() || {};
      if ((data.locked === true || data.isLocked === true) && String(data.rid||rid) === String(rid)) return true;
    }
  }catch(e){}

  // 4) reports/{rid}
  try{
    const snap = await db.collection("reports").doc(rid).get();
    if (snap.exists){
      const data = snap.data() || {};
      // âš ï¸ burada uid eÅŸleÅŸmesi Ã§ok Ã¶nemli (baÅŸka kullanÄ±cÄ±nÄ±n raporunu kilit sanma)
      if ((data.locked === true || data.isLocked === true) && String(data.uid||"") === String(uid) && String(data.rid||rid) === String(rid)) return true;
    }
  }catch(e){}

  return false;
}


    try{
      const d = await db.collection("users").doc(uid).collection("locks").doc(rid).get();
      if (d.exists) return true;
    }catch(e){}

    try{
      const d = await db.collection("users").doc(uid).collection("reports").doc(rid).get();
      if (d.exists && (d.data()?.locked === true || d.data()?.isLocked === true)) return true;
    }catch(e){}

    try{
      const d = await db.collection("reports").doc(rid).get();
      if (d.exists && (d.data()?.locked === true || d.data()?.isLocked === true)) return true;
    }catch(e){}

    return false;
  }

  function applyLockedUI(){
    document.getElementById("kilitMesaji").style.display = "block";
    document.querySelectorAll(".modÃ¼l-btn").forEach(b=> b.disabled = true);

    const btn = document.getElementById("btnRaporOlustur");
    btn.textContent = "TAMAMLANMIÅž RAPORU GÃ–RÃœNTÃœLE";
    btn.classList.add("locked");

    // kilitliyse rapor-olusturâ€™a direkt git (uyarÄ±/confirm yok)
    btn.onclick = () => {
      const idx = getReportIndexByRid();
      let url = "rapor-olustur.html?rid=" + encodeURIComponent(rid);
      if (idx >= 0) url += "&id=" + encodeURIComponent(String(idx));
      window.location.href = url;
    };
  }

  async function syncLockState(user){
    // 1) localde var mÄ±?
    let locked = isLockedLocalFlag() || isLockedInLocalReports();

    // 2) localde yoksa remoteâ€™a bak
    if (!locked){
      locked = await isLockedRemote(user.uid);
    }

    // 3) kilitli ise localâ€™e iÅŸle + UI
    if (locked){
      markLockedInLocal();
      applyLockedUI();
    }
  }

  /* ========= RAPOR OLUÅžTUR UYARI (dokunmadan sadece parametreyi saÄŸlamlaÅŸtÄ±rÄ±yoruz) ========= */
  function raporOlusturUyari(){
    if (!rid) { window.location.href="index.html"; return; }

    const msg =
`UYARI! (Ã–NEMLÄ°)
Tam rapor oluÅŸturulduÄŸunda Ã¼cret/Ã¼cretsiz hak dÃ¼ÅŸebilir.

LÃ¼tfen zaman ve para kaybÄ± olmamasÄ± iÃ§in tÃ¼m modÃ¼lleri tekrar kontrol edin.
Devam ederseniz rapor bankaya uygun taslak formatÄ±nda Ã¼retilecektir.

Devam etmek istiyor musunuz?`;

    if (!confirm(msg)) return;

    // âœ… kritik: rapor-olustur eski id ile kilitliyorsa da Ã§alÄ±ÅŸsÄ±n diye idâ€™yi ekliyoruz
    const idx = getReportIndexByRid();
    let url = "rapor-olustur.html?rid=" + encodeURIComponent(rid) + "&confirm=1";
    if (idx >= 0) url += "&id=" + encodeURIComponent(String(idx));
    window.location.href = url;
  }

  /* ========= WALLET UI (dokunmuyoruz) ========= */
  let walletRevealed = false;

  function setWalletUI(textAmount, subText){
    document.getElementById("walletAmount").textContent = textAmount;
    document.getElementById("walletSub").textContent = subText;
  }

  function toggleWalletReveal(){
    walletRevealed = !walletRevealed;
    const card = document.getElementById("walletCard");
    if (walletRevealed) card.classList.add("reveal");
    else card.classList.remove("reveal");
  }
  document.getElementById("walletCard").addEventListener("click", toggleWalletReveal);

  async function loadWallet(user){
    if (!window.Wallet || !user) {
      setWalletUI("â€”", "CÃ¼zdan modÃ¼lÃ¼ yÃ¼klenemedi.");
      return;
    }
    try{
      const w = await Wallet.load(user.uid);
      const balance = Number(w?.balanceTL ?? w?.balance ?? w?.tl ?? 0) || 0;
      const freeLeft = Number(w?.freeLeft ?? w?.freeReportsLeft ?? w?.free ?? 0);

      const tlText = new Intl.NumberFormat('tr-TR', { maximumFractionDigits:0 }).format(balance) + " TL";
      const info = (freeLeft > 0)
        ? `Ãœcretsiz rapor hakkÄ±: ${freeLeft} â€¢ Bakiye: (gizli)`
        : `Ãœcretsiz hak bitti â€¢ Bakiye: (gizli)`;

      setWalletUI(tlText, info);
    }catch(e){
      setWalletUI("â€”", "CÃ¼zdan okunamadÄ±. Ä°nternet / izin kontrol et.");
    }
  }

  /* ========= BOOT ========= */
  auth.onAuthStateChanged(async (user)=>{
    if (!user || !rid) { window.location.href="index.html"; return; }

    const report = getReportByRid();
    if (!report) { window.location.href="index.html"; return; }

    document.getElementById("baslik").textContent = report.propertyName || "Ä°simsiz Gayrimenkul";

    await loadWallet(user);

    // âœ… asÄ±l fix: kilidi kontrol et ve menÃ¼ye yansÄ±t
    await syncLockState(user);
  });
</script>
</body>
</html>


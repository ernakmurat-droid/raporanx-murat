<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Rapor Ana Menü - Raporan X</title>
  <style>
    body { font-family: Arial; background: linear-gradient(135deg,#4a148c,#7c4dff); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
    .header { padding:20px; text-align:center; font-size:28px; font-weight:bold; position: relative; }
    .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; }
    .menu { flex:1; display:flex; flex-wrap:wrap; gap:20px; padding:30px; justify-content:center; align-content:flex-start; }
    .btn { flex:1 1 350px; background:#6a1b9a; padding:35px; font-size:24px; font-weight:bold; border:none; border-radius:20px; color:white; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; display:flex; align-items:center; justify-content:center; gap:10px; }
    .btn:hover { background:#8e24aa; transform:scale(1.05); }
    .btn-main-feature { background: #4527a0; border: 2px solid #b39ddb; }
    .footer-btn { background:#ff5722; padding:25px; font-size:28px; width:90%; max-width:600px; margin:20px auto; border-radius:20px; border:none; color:white; font-weight:bold; cursor: pointer; text-align: center; }

    #durumOzet{
      width:90%;
      max-width:600px;
      margin:10px auto 0;
      background:rgba(255,255,255,0.15);
      padding:12px 16px;
      border-radius:14px;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.25);
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <a href="index.html" class="back">Ana Sayfa</a>
    <div id="baslik">Gayrimenkul Raporu</div>
    <div id="durumOzet">Rapor Doluluk: %0</div>
  </div>

  <div class="menu">
    <button class="btn btn-main-feature" data-modul="konum" onclick="go('konum_cevre.html')">KONUM VE ÇEVRE ÖZELLİKLERİ</button>
    <button class="btn" data-modul="tapu" onclick="go('tapu_kayit.html')">TAPU KAYIT BİLGİLERİ</button>
    <button class="btn" data-modul="imar" onclick="go('imar.html')">İMAR DURUMU</button>
    <button class="btn" data-modul="belgeler" onclick="go('belgeler.html')">İNCELENEN BELGELER</button>
    <button class="btn" data-modul="bina" onclick="go('bina.html')">BİNA BİLGİLERİ</button>
    <button class="btn" data-modul="bb" onclick="go('bagimsiz-bolum-detay.html')">BAĞIMSIZ BÖLÜM DETAY</button>
    <button class="btn" data-modul="emsal" onclick="go('emsal.html')">EMSAL KARŞILAŞTIRMA</button>
  </div>

  <button class="footer-btn" onclick="go('rapor-olustur.html')">TAM RAPOR OLUŞTUR</button>

  <script>
    // ✅ Firebase auth/db garanti
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ✅ RID helpers (geriye dönük uyumluluk + migration)
    function genRid(){
      try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
      return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
    }
    function ensureRidMigration(arr){
      let changed = false;
      (arr || []).forEach(r => {
        if (r && !r.rid) { r.rid = genRid(); changed = true; }
      });
      return changed;
    }
    function findIndexByRid(arr, rid){
      return (arr || []).findIndex(r => r && r.rid === rid);
    }

    // ✅ URL Params: rid öncelikli, id varsa onu da rid'ye çevirip devam et
    const urlParams = new URLSearchParams(window.location.search);
    let rid = urlParams.get('rid');
    const legacyId = urlParams.get('id');

    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    if (ensureRidMigration(reports)) {
      localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    }

    // Eski ?id= ile gelmişse rid’ye çevir
    if (!rid && legacyId !== null && legacyId !== "") {
      const idx = Number(legacyId);
      if (!Number.isNaN(idx) && reports[idx] && reports[idx].rid) {
        rid = reports[idx].rid;
        window.location.replace("rapor-detay.html?rid=" + encodeURIComponent(rid));
      }
    }

    function getReportByRid(rid){
      const idx = findIndexByRid(reports, rid);
      if (idx < 0) return null;
      return reports[idx];
    }

    // ✅ Yönlendirme Fonksiyonu (RID’yi koruyarak geçer)
    function go(page) {
      if (!rid) { window.location.href = "index.html"; return; }
      window.location.href = page + "?rid=" + encodeURIComponent(rid);
    }

    /* ===============================
       MODUL DURUM MOTORU
       0: Bos | 1: Kismi | 2: Tam
    ================================ */
    function _normStr(x){
      if (x === null || x === undefined) return "";
      if (typeof x === "string") return x;
      try { return JSON.stringify(x); } catch(e){ return String(x); }
    }
    function _bestText(){
      for (let i=0;i<arguments.length;i++){
        const s = _normStr(arguments[i]).trim();
        if (s) return s;
      }
      return "";
    }
    function _scoreByLen(text, min0=20, min2=150){
      const t = _normStr(text).trim();
      if (t.length < min0) return 0;
      if (t.length < min2) return 1;
      return 2;
    }
    function _mergeTexts(arr){
      return (arr || []).map(_normStr).join("\n").trim();
    }

    function getModuleTexts(report){
      const konum = _bestText(
        report?.konumCevre?.tamMetin,
        report?.konumCevre?.metin,
        report?.konumCevreMetni,
        report?.konumMetin
      );

      const imar = _bestText(
        report?.imarMetni,
        report?.imar?.tamMetin,
        report?.imar?.metin,
        report?.imarDurumu?.tamMetin,
        report?.imarDurumu?.metin,
        report?.imarDurumu // bazen objenin içinde olur
      );

      const belgeler = _bestText(
        report?.belgelerMetni,
        report?.belgeler?.tamMetin,
        report?.belgeler?.metin
      );

      const bina = _bestText(
        report?.bina?.metin,
        report?.binaMetni,
        report?.anaBinaMetni
      );

      const bb = _bestText(
        report?.bbDetay?.tamMetin,
        report?.bbDetay?.metin,
        _mergeTexts((report?.bbDetayList || []).map(x => x?.bbDetay?.tamMetin || x?.bbDetay?.metin || ""))
      );

      const tapuAll = _mergeTexts([
        report?.tapuMetniB1, report?.tapuMetniB2,
        report?.tapu?.metinB1, report?.tapu?.metinB2,
        report?.tapuKayit?.metinB1, report?.tapuKayit?.metinB2,
        report?.tapuB1, report?.tapuB2
      ]);

      const emsalAll = _mergeTexts([
        report?.degerlemeOzet?.emsalFinalMetni,
        report?.emsalFinalMetni,
        _mergeTexts((report?.bbDetayList || []).map(x => x?.degerlemeOzet?.emsalFinalMetni || ""))
      ]);

      return { konum, imar, belgeler, bina, bb, tapuAll, emsalAll };
    }

    function computeModuleStatuses(report){
      const t = getModuleTexts(report);

      const status = {
        konum: _scoreByLen(t.konum, 20, 250),
        imar:  _scoreByLen(t.imar, 20, 180),
        belgeler: _scoreByLen(t.belgeler, 10, 120),
        bina: _scoreByLen(t.bina, 20, 220),
        bb: _scoreByLen(t.bb, 20, 220),
        tapu: _scoreByLen(t.tapuAll, 20, 180),
        emsal: _scoreByLen(t.emsalAll, 40, 300)
      };

      const keys = Object.keys(status);
      const total = keys.reduce((s,k)=>s+status[k],0);
      const max = keys.length * 2;
      const pct = Math.round((total / max) * 100);

      return { status, pct };
    }

    function statusLabel(n){
      if (n === 2) return { icon:"✅", text:"Tamamlandı" };
      if (n === 1) return { icon:"⚠️", text:"Kısmen Dolu" };
      return { icon:"❌", text:"Veri Girilmedi" };
    }

    function renderStatusesToUI(report){
      const out = computeModuleStatuses(report);
      const status = out.status;
      const pct = out.pct;

      const box = document.getElementById("durumOzet");
      if (box){
        box.innerHTML = `<div style="font-weight:bold; font-size:16px;">Rapor Doluluk: %${pct}</div>
          <div style="opacity:.9; font-size:13px; margin-top:6px;">✅ Tamamlandı • ⚠️ Kısmi • ❌ Boş</div>`;
      }

      document.querySelectorAll("[data-modul]").forEach(btn=>{
        const key = btn.getAttribute("data-modul");
        if (!key || !(key in status)) return;
        const s = statusLabel(status[key]);

        let badge = btn.querySelector(".modBadge");
        if (!badge){
          badge = document.createElement("span");
          badge.className = "modBadge";
          badge.style.fontSize = "18px";
          badge.style.filter = "drop-shadow(0 2px 4px rgba(0,0,0,0.35))";
          btn.appendChild(badge);
        }
        badge.textContent = s.icon;
        badge.title = s.text;
      });

      return out;
    }

    /* ========= AUTH + BOOT ========= */
    auth.onAuthStateChanged((user) => {
      if (!user || !rid) {
        window.location.href = 'index.html';
        return;
      }

      // en güncel storage çek
      reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
      const report = getReportByRid(rid);

      if (!report) {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('baslik').textContent = report.propertyName || "İsimsiz Gayrimenkul";

      // ✅ DURUM BAS
      renderStatusesToUI(report);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rapor Ana Men√º - Y√∂netim Paneli</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root { --primary: #4a148c; --accent: #7c4dff; --success: #00c853; --warning: #ffeb3b; --error: #ff5252; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, var(--primary), var(--accent)); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
    .header { padding:20px; text-align:center; position: relative; }
    .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; font-size: 14px; border: none; cursor: pointer; }
    .wallet-status { position: absolute; right: 15px; top: 15px; background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 12px; border: 1px solid rgba(255,255,255,0.2); transition: 0.3s; }
    .wallet-status:hover { background: rgba(0,0,0,0.5); }
    .menu { flex:1; display:flex; flex-wrap:wrap; gap:15px; padding:20px; justify-content:center; align-content:flex-start; }
    .btn { flex: 1 1 320px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 25px; font-size: 20px; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer; transition: 0.3s; position: relative; text-align: left; }
    .btn:hover:not(:disabled) { background: rgba(255,255,255,0.2); transform: translateY(-3px); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .status-dot { position: absolute; top: 12px; right: 15px; font-size: 12px; padding: 4px 10px; border-radius: 10px; font-weight: bold; }
    .status-missing { background: var(--error); color: white; }
    .status-incomplete { background: var(--warning); color: #333; }
    .status-ok { background: var(--success); color: white; }
    .footer-btn { background:#ff5722; padding:20px; font-size:22px; width:90%; max-width:500px; margin:15px auto; border-radius:15px; border:none; color:white; font-weight:bold; cursor: pointer; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
    .footer-btn.locked { background: #2196F3; }
    #kilitMesaji { display: none; background: rgba(255,112,67,0.2); border: 1px solid #ff7043; padding: 10px; margin: 10px auto; width: 80%; text-align: center; border-radius: 10px; color: #ffd600; font-weight: bold; }
    #loadingBar { display:none; background: rgba(0,0,0,0.25); padding:10px; border-radius:12px; font-size:13px; width: 80%; margin: 10px auto; }
  </style>
</head>

<body>

  <div class="header">
    <button class="back" type="button" onclick="location.href='index.html'">Ana Sayfa</button>
    <div id="walletBox" class="wallet-status">üí≥ <span id="walletText">Kredi: ...</span></div>
    <div id="baslik" style="margin-top:20px;">Gayrimenkul Raporu</div>
    <div id="loadingBar">‚è≥ Rapor y√ºkleniyor...</div>
    <div id="kilitMesaji">üîí RAPOR M√úH√úRLENDƒ∞ - YALNIZCA G√ñR√úNT√úLEME</div>
  </div>

  <div class="menu">
    <button class="btn mod√ºl-btn" id="btnKonum" type="button">KONUM VE √áEVRE <span id="stat_konum" class="status-dot"></span></button>
    <button class="btn mod√ºl-btn" id="btnTapu" type="button">TAPU KAYITLARI <span id="stat_tapu" class="status-dot"></span></button>
    <button class="btn mod√ºl-btn" id="btnImar" type="button">ƒ∞MAR DURUMU <span id="stat_imar" class="status-dot"></span></button>
    <button class="btn mod√ºl-btn" id="btnBelgeler" type="button">ƒ∞NCELENEN BELGELER <span id="stat_belgeler" class="status-dot"></span></button>
    <button class="btn mod√ºl-btn" id="btnBina" type="button">Bƒ∞NA Bƒ∞LGƒ∞LERƒ∞ <span id="stat_bina" class="status-dot"></span></button>
    <button class="btn mod√ºl-btn" id="btnBB" type="button">BAƒûIMSIZ B√ñL√úM <span id="stat_bb" class="status-dot"></span></button>
    <button class="btn mod√ºl-btn" id="btnEmsal" type="button">EMSAL ANALƒ∞Zƒ∞ <span id="stat_emsal" class="status-dot"></span></button>
  </div>

  <button id="mainBtn" class="footer-btn" type="button" onclick="raporKontrolVeKilitle()">RAPORU TAMAMLA VE Kƒ∞Lƒ∞TLE</button>

<script>
  // ‚úÖ Tek dosya Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyCMwx6S6rq1lnNJuHOxc38ij3qU4ankSxs",
    authDomain: "raporanx.firebaseapp.com",
    projectId: "raporanx",
    storageBucket: "raporanx.firebasestorage.app",
    messagingSenderId: "715194328346",
    appId: "1:715194328346:web:46f0bb98941e01ead6f8a3"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const urlParams = new URLSearchParams(window.location.search);
  const reportId = urlParams.get('id'); // ‚úÖ docId

  let currentUser = null;
  let reportRef = null;
  let reportData = null;

  const loadingBar = document.getElementById("loadingBar");

  /* =========================================================
     ‚úÖ SAƒûLAM LOCAL STORAGE (KAYIP Bƒ∞TER)
     - gayrimenkul_reports her zaman OBJECT tutulur
     - eski array varsa otomatik migrate eder
  ========================================================= */
  const LS_KEY = "gayrimenkul_reports";

  function loadReportsSafe() {
    let data;
    try { data = JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { data = {}; }
    if (Array.isArray(data)) {
      const obj = {};
      data.forEach((r, idx) => { if (r) obj[String(idx)] = r; });
      data = obj;
      localStorage.setItem(LS_KEY, JSON.stringify(data));
    }
    if (!data || typeof data !== "object") data = {};
    return data;
  }

  function saveReportsSafe(obj) {
    if (Array.isArray(obj)) {
      const o = {};
      obj.forEach((r, idx) => { if (r) o[String(idx)] = r; });
      obj = o;
    }
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }

  function getLocalReport(id) {
    const all = loadReportsSafe();
    return all[String(id)] || null;
  }

  function setLocalReport(id, rep) {
    const all = loadReportsSafe();
    all[String(id)] = rep;
    saveReportsSafe(all);
  }

  function parseUpdatedAt(v) {
    if (!v) return 0;
    if (typeof v === "number") return v;
    if (typeof v === "string") {
      const t = Date.parse(v);
      return isNaN(t) ? 0 : t;
    }
    return 0;
  }

  function deepMerge(target, source) {
    if (!source || typeof source !== "object") return target;
    if (!target || typeof target !== "object") target = {};
    for (const k of Object.keys(source)) {
      if (source[k] && typeof source[k] === "object" && !Array.isArray(source[k])) {
        target[k] = deepMerge(target[k], source[k]);
      } else {
        target[k] = source[k];
      }
    }
    return target;
  }

  /* =========================================================
     ‚úÖ BUTONLARIN TIKLAMASI
  ========================================================= */
  function goto(page){
    if(!reportId){
      alert("Rapor ID yok! Ana sayfaya d√∂n.");
      location.href = "index.html";
      return;
    }
    window.location.href = `${page}?id=${encodeURIComponent(reportId)}`;
  }

  document.getElementById("btnKonum").addEventListener("click", () => goto("konum_cevre.html"));
  document.getElementById("btnTapu").addEventListener("click", () => goto("tapu_kayit.html"));
  document.getElementById("btnImar").addEventListener("click", () => goto("imar.html"));
  document.getElementById("btnBelgeler").addEventListener("click", () => goto("belgeler.html"));
  document.getElementById("btnBina").addEventListener("click", () => goto("bina.html"));
  document.getElementById("btnBB").addEventListener("click", () => goto("bagimsiz-bolum-detay.html"));
  document.getElementById("btnEmsal").addEventListener("click", () => goto("emsal.html"));

  function isValueEmpty(val) {
    if (!val) return true;
    if (typeof val === 'string' && (val.trim().length < 5 || val.includes("Metin burada olu≈üacak"))) return true;
    return false;
  }

  function setDot(dotId, mode){
    const el = document.getElementById(dotId);
    if(!el) return;
    if(mode === "missing"){ el.textContent = "Eksik"; el.className = "status-dot status-missing"; }
    if(mode === "incomplete"){ el.textContent = "‚ö†Ô∏è Eksik"; el.className = "status-dot status-incomplete"; }
    if(mode === "ok"){ el.textContent = "Tamam"; el.className = "status-dot status-ok"; }
  }

  // ‚úÖ Hem eski alanlardan hem modules.* alanlarƒ±ndan okuyan saƒülam kontrol
  function pick(r, path, fallback=null){
    try{
      const parts = path.split('.');
      let cur = r;
      for(const p of parts){
        if(cur == null) return fallback;
        cur = cur[p];
      }
      return (cur === undefined) ? fallback : cur;
    }catch(e){ return fallback; }
  }

  function durumuGuncelle(r) {
    const kontroller = {
      stat_konum: {
        veri: pick(r, "konumCevre.tamMetin", pick(r, "modules.konum.tamMetin", "")),
        tamam: pick(r, "konum_tamamlandi", pick(r, "modules.konum.complete", null))
      },
      stat_tapu: {
        veri: pick(r, "tapuMetniB1", pick(r, "modules.tapu.tapuMetniB1", "")),
        tamam: pick(r, "tapu_tamamlandi", pick(r, "modules.tapu.complete", null))
      },
      stat_imar: {
        veri: pick(r, "imarMetni", pick(r, "modules.imar.imarMetni", "")),
        tamam: pick(r, "imar_tamamlandi", pick(r, "modules.imar.complete", null))
      },
      stat_belgeler: {
        veri: pick(r, "belgelerMetni", pick(r, "modules.belgeler.belgelerMetni", "")),
        tamam: pick(r, "belgeler_tamamlandi", pick(r, "modules.belgeler.complete", null))
      },
      stat_bina: {
        veri: pick(r, "bina.metin", pick(r, "binaMetni", pick(r, "modules.bina.metin", ""))),
        tamam: pick(r, "bina_tamamlandi", pick(r, "modules.bina.complete", null))
      },
      stat_bb: {
        veri: pick(r, "bbDetay.tamMetin", pick(r, "katDetayMetni", pick(r, "modules.bb.tamMetin", ""))),
        tamam: pick(r, "bb_tamamlandi", pick(r, "modules.bb.complete", null))
      },
      stat_emsal: {
        veri: pick(r, "degerlemeOzet.emsalFinalMetni", pick(r, "modules.emsal.emsalFinalMetni", "")),
        tamam: (Array.isArray(r.emsaller) && r.emsaller.length >= 4) ? true : pick(r, "modules.emsal.complete", null)
      }
    };

    for (let dotId in kontroller) {
      const d = kontroller[dotId];
      if (isValueEmpty(d.veri)) setDot(dotId, "missing");
      else if (d.tamam === false) setDot(dotId, "incomplete");
      else setDot(dotId, "ok");
    }
  }

  function applyLockUI(isLocked){
    if(isLocked){
      document.querySelectorAll('.mod√ºl-btn').forEach(btn => btn.disabled = true);
      document.getElementById('kilitMesaji').style.display = 'block';
      const mainBtn = document.getElementById('mainBtn');
      mainBtn.textContent = "TAMAMLANMI≈û RAPORU G√ñR√úNT√úLE";
      mainBtn.className = "footer-btn locked";
    }
  }

  function applyReportToUI(r){
    if(!r) return;
    document.getElementById('baslik').textContent = r.propertyName || "Gayrimenkul Raporu";
    durumuGuncelle(r);
    applyLockUI(!!r.isLocked);
  }

  async function refreshWallet(){
    const userDoc = await db.collection("users").doc(currentUser.uid).get();
    const kredi = userDoc.data()?.kredi ?? 0;
    document.getElementById('walletText').textContent = `Kredi: ${kredi}`;
    return kredi;
  }

  // ‚úÖ 1) √ñnce local'den y√ºkle (offline bile √ßalƒ±≈üsƒ±n)
  function loadLocalFirst(){
    if(!reportId) return;
    const local = getLocalReport(reportId);
    if(local){
      reportData = local;
      applyReportToUI(reportData);
    }
  }

  // ‚úÖ 2) Buluttan y√ºkle ve updatedAt'e g√∂re merge et
  async function loadReportCloudAndMerge(){
    if(!currentUser) return;
    if(!reportId){ alert("Rapor ID yok!"); location.href="index.html"; return; }

    reportRef = db.collection("users").doc(currentUser.uid).collection("reports").doc(reportId);

    loadingBar.style.display = "block";
    const snap = await reportRef.get();

    if(!snap.exists){
      loadingBar.style.display = "none";
      // bulutta yoksa, local varsa onunla devam; yoksa hata ver
      if(!reportData){
        alert("Rapor bulunamadƒ± (bu kullanƒ±cƒ±ya ait deƒüil veya silinmi≈ü).");
        location.href = "index.html";
      }
      return;
    }

    const cloud = snap.data() || {};
    const local = getLocalReport(reportId) || reportData || {};

    const tLocal = parseUpdatedAt(local.updatedAt);
    const tCloud = parseUpdatedAt(cloud.updatedAt);

    if(tCloud > tLocal){
      // cloud daha yeni -> local'e merge
      const merged = deepMerge(local, cloud);
      reportData = merged;
      setLocalReport(reportId, merged);
      applyReportToUI(merged);
    } else if(tLocal > tCloud){
      // local daha yeni -> cloud'a push (sessiz merge)
      try{
        await reportRef.set({
          ...local,
          updatedAt: local.updatedAt || Date.now()
        }, { merge: true });
      }catch(e){}
      reportData = local;
      applyReportToUI(local);
    } else {
      // aynƒ±ysa cloud'u temel al
      const merged = deepMerge(local, cloud);
      reportData = merged;
      setLocalReport(reportId, merged);
      applyReportToUI(merged);
    }

    loadingBar.style.display = "none";
  }

  async function raporKontrolVeKilitle() {
    if(!currentUser) return alert("L√ºtfen giri≈ü yapƒ±n!");
    if(!reportRef || !reportData) return alert("Rapor y√ºklenmedi!");

    if (reportData.isLocked) {
      window.location.href = 'rapor-olustur.html?id=' + encodeURIComponent(reportId);
      return;
    }

    const mevcutKredi = await refreshWallet();
    if (mevcutKredi <= 0) {
      alert("‚ö†Ô∏è Krediniz yetersiz! L√ºtfen y√ºkleme yapƒ±n.");
      return;
    }

    const hatirlatmaMetni = "Veri giri≈ülerinin tamamƒ±nƒ± yaptƒ±ƒüƒ±nƒ±zdan emin olun. Rapor m√ºh√ºrlendikten sonra deƒüi≈üiklik yapƒ±lamaz.";
    if (!confirm(`${hatirlatmaMetni}\n\nMevcut Krediniz: ${mevcutKredi}\nƒ∞≈ülem Sonrasƒ±: ${mevcutKredi - 1}\n\nRapor m√ºh√ºrlensin mi?`)) return;

    await db.collection("users").doc(currentUser.uid).update({
      kredi: firebase.firestore.FieldValue.increment(-1)
    });

    const nowMs = Date.now();

    await reportRef.set({
      isLocked: true,
      updatedAt: nowMs,                 // ‚úÖ sayƒ± olarak (senin mod√ºllerle uyumlu)
      updatedAtISO: new Date(nowMs).toISOString()
    }, { merge: true });

    // ‚úÖ local‚Äôi de g√ºncelle
    reportData.isLocked = true;
    reportData.updatedAt = nowMs;
    reportData.updatedAtISO = new Date(nowMs).toISOString();
    setLocalReport(reportId, reportData);

    await refreshWallet();
    applyLockUI(true);
    alert("‚úÖ Rapor m√ºh√ºrlendi!");
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user) { window.location.href = 'index.html'; return; }
    currentUser = user;

    // ‚úÖ √∂nce local g√∂ster
    loadLocalFirst();

    await refreshWallet();
    await loadReportCloudAndMerge();
  });

  // reportId yoksa direkt ka√ß
  if(!reportId){
    alert("Rapor ID yok! Ana sayfaya d√∂n.");
    location.href = "index.html";
  }
</script>

</body>
</html>

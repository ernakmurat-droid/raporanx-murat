<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Rapor Ana MenÃ¼ - Raporan X</title>
  <style>
    body { font-family: Arial; background: linear-gradient(135deg,#4a148c,#7c4dff); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
    .header { padding:20px; text-align:center; font-size:28px; font-weight:bold; position: relative; }
    .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; }
    .menu { flex:1; display:flex; flex-wrap:wrap; gap:20px; padding:30px; justify-content:center; align-content:flex-start; }
    .btn { flex:1 1 350px; background:#6a1b9a; padding:35px; font-size:24px; font-weight:bold; border:none; border-radius:20px; color:white; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; display:flex; align-items:center; justify-content:center; gap:10px; }
    .btn:hover { background:#8e24aa; transform:scale(1.05); }
    .btn-main-feature { background: #4527a0; border: 2px solid #b39ddb; }
    .footer-btn { background:#ff5722; padding:25px; font-size:28px; width:90%; max-width:600px; margin:20px auto; border-radius:20px; border:none; color:white; font-weight:bold; cursor: pointer; text-align: center; }

    /* âœ… CÃ¼zdan bar gÃ¶rÃ¼nÃ¼mÃ¼ (header iÃ§inde) */
    #walletBar{
      width:90%;
      max-width:820px;
      margin:12px auto 0;
      font-size:14px;
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <a href="index.html" class="back">Ana Sayfa</a>
    <div id="baslik">Gayrimenkul Raporu</div>

    <!-- âœ… CÃ¼zdan (gizli gÃ¶ster) -->
    <div id="walletBar"></div>
  </div>

  <div class="menu">
    <button class="btn btn-main-feature" data-modul="konum" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE Ã–ZELLÄ°KLERÄ°</button>
    <button class="btn" data-modul="tapu" onclick="go('tapu_kayit.html')">TAPU KAYIT BÄ°LGÄ°LERÄ°</button>
    <button class="btn" data-modul="imar" onclick="go('imar.html')">Ä°MAR DURUMU</button>
    <button class="btn" data-modul="belgeler" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER</button>
    <button class="btn" data-modul="bina" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ°</button>
    <button class="btn" data-modul="bb" onclick="go('bagimsiz-bolum-detay.html')">BAÄIMSIZ BÃ–LÃœM DETAY</button>
    <button class="btn" data-modul="emsal" onclick="go('emsal.html')">EMSAL KARÅILAÅTIRMA</button>
  </div>

  <button class="footer-btn" onclick="go('rapor-olustur.html')">TAM RAPOR OLUÅTUR</button>

  <script>
    // âœ… Firebase auth/db garanti
    const auth = firebase.auth();
    const db = firebase.firestore();

    // âœ… RID helpers (geriye dÃ¶nÃ¼k uyumluluk + migration)
    function genRid(){
      try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
      return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
    }
    function ensureRidMigration(arr){
      let changed = false;
      (arr || []).forEach(r => {
        if (r && !r.rid) { r.rid = genRid(); changed = true; }
      });
      return changed;
    }
    function findIndexByRid(arr, rid){
      return (arr || []).findIndex(r => r && r.rid === rid);
    }

    // âœ… URL Params: rid Ã¶ncelikli, id varsa onu da rid'ye Ã§evirip devam et
    const urlParams = new URLSearchParams(window.location.search);
    let rid = urlParams.get('rid');
    const legacyId = urlParams.get('id');

    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    if (ensureRidMigration(reports)) {
      localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    }

    // Eski ?id= ile gelmiÅŸse ridâ€™ye Ã§evir
    if (!rid && legacyId !== null && legacyId !== "") {
      const idx = Number(legacyId);
      if (!Number.isNaN(idx) && reports[idx] && reports[idx].rid) {
        rid = reports[idx].rid;
        window.location.replace("rapor-detay.html?rid=" + encodeURIComponent(rid));
      }
    }

    function getReportByRid(rid){
      const idx = findIndexByRid(reports, rid);
      if (idx < 0) return null;
      return reports[idx];
    }

    // âœ… YÃ¶nlendirme Fonksiyonu (RIDâ€™yi koruyarak geÃ§er)
    function go(page) {
      if (!rid) { window.location.href = "index.html"; return; }
      window.location.href = page + "?rid=" + encodeURIComponent(rid);
    }

    /* ===============================
       âœ… GÄ°ZLÄ° CÃœZDAN BAR (baÅŸkasÄ± bakÄ±nca tutarlar gÃ¶rÃ¼nmez)
    ================================ */
    function renderPrivateWalletBar(w){
      const bar = document.getElementById("walletBar");
      if (!bar) return;

      const freeLeft = Number(w?.freeReportsLeft ?? 0);
      const balance = Number(w?.balance ?? 0);

      bar.innerHTML = `
        <div style="background:rgba(255,255,255,0.15);padding:10px 14px;border-radius:14px;
                    box-shadow:0 6px 18px rgba(0,0,0,0.25);">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;">
            <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
              <div style="font-weight:800;">CÃ¼zdan</div>
              <div>ğŸ Ãœcretsiz: <b id="wFree">â€¢â€¢</b> rapor</div>
              <div>ğŸ’° Bakiye: <b id="wBal">â€¢â€¢â€¢ TL</b></div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
              <button id="btnWalletReveal"
                style="padding:8px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:800;background:rgba(255,255,255,0.25);color:#fff;">
                ğŸ‘ GÃ¶ster
              </button>
              <button id="btnWalletTopup"
                style="padding:8px 12px;border:none;border-radius:10px;cursor:pointer;font-weight:800;background:#00c853;color:#fff;">
                + YÃ¼kle
              </button>
            </div>
          </div>

          <div style="opacity:.85;font-size:12px;margin-top:6px;font-weight:400;">
            BaÅŸkasÄ± bakÄ±yorsa tutarlar gizlenir. â€œGÃ¶sterâ€ ile aÃ§abilirsin.
          </div>
        </div>
      `;

      const wFree = document.getElementById("wFree");
      const wBal  = document.getElementById("wBal");

      const btnReveal = document.getElementById("btnWalletReveal");
      if (btnReveal){
        let revealed = false;

        function formatTL(n){
          return new Intl.NumberFormat("tr-TR", { maximumFractionDigits: 0 }).format(Number(n||0)) + " TL";
        }

        btnReveal.onclick = () => {
          revealed = !revealed;
          if (revealed){
            wFree.textContent = String(freeLeft);
            wBal.textContent = formatTL(balance);
            btnReveal.textContent = "ğŸ™ˆ Gizle";
          } else {
            wFree.textContent = "â€¢â€¢";
            wBal.textContent = "â€¢â€¢â€¢ TL";
            btnReveal.textContent = "ğŸ‘ GÃ¶ster";
          }
        };
      }

      const btnTopup = document.getElementById("btnWalletTopup");
      if (btnTopup){
        btnTopup.onclick = () => {
          alert("YÃ¼kleme ekranÄ±nÄ± birazdan PayTR ile baÄŸlayacaÄŸÄ±z. Åimdilik demo.");
        };
      }
    }

    async function loadOrCreateWallet(uid){
      const wRef = db.collection("users").doc(uid).collection("wallet").doc("main");
      const wSnap = await wRef.get();

      if (!wSnap.exists) {
        await wRef.set({
          balance: 0,
          freeReportsLeft: 5,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });

        return { balance: 0, freeReportsLeft: 5 };
      }

      return (wSnap.data() || {});
    }

    /* ========= AUTH + BOOT ========= */
    auth.onAuthStateChanged(async (user) => {
      if (!user || !rid) {
        window.location.href = 'index.html';
        return;
      }

      // en gÃ¼ncel storage Ã§ek
      reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
      const report = getReportByRid(rid);

      if (!report) {
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('baslik').textContent = report.propertyName || "Ä°simsiz Gayrimenkul";

      // âœ… CÃ¼zdanÄ± yÃ¼kle (gizli gÃ¶ster)
      try {
        const w = await loadOrCreateWallet(user.uid);
        renderPrivateWalletBar(w);
      } catch (e) {
        console.log("wallet load error:", e);
      }
    });
  </script>
</body>
</html>

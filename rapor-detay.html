<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script src="wallet.js"></script>

  <title>Rapor Ana MenÃ¼ - Raporan X</title>

  <style>
    :root{ --hdrH: 78px; }
    body{
      font-family: Arial;
      background: linear-gradient(135deg,#4a148c,#7c4dff);
      margin:0;
      color:white;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      overflow-x:hidden;
    }
    .header{
      padding: calc(20px + env(safe-area-inset-top, 0px)) 20px 20px;
      text-align:center;
      font-size:28px;
      font-weight:bold;
      position: sticky;
      top: 0;
      z-index: 999;
      background: linear-gradient(135deg,#4a148c,#7c4dff);
    }
    .back{
      position:absolute;
      left:15px;
      top: calc(20px + env(safe-area-inset-top, 0px));
      background:rgba(255,255,255,0.2);
      padding:10px 20px;
      border-radius:30px;
      text-decoration:none;
      color:white;
      font-weight:bold;
    }
    #kilitMesaji{
      display:none;
      max-width:1100px;
      margin:10px auto 0;
      width: calc(100% - 40px);
      background: rgba(255, 145, 0, 0.3);
      border: 1px solid rgba(255,255,255,0.4);
      border-radius: 14px;
      padding:10px 14px;
      font-size: 14px;
      font-weight: 900;
      text-align: center;
    }
    .topbar{
      max-width:1100px;
      width: calc(100% - 40px);
      margin: 0 auto 10px;
      display:flex;
      padding: 0 20px;
    }
    .wallet-card{
      flex: 1;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      border-radius: 16px;
      padding: 12px 14px;
      cursor: pointer;
    }
    .wallet-amount{
      font-size:20px;
      font-weight:900;
      filter: blur(6px);
    }
    .reveal .wallet-amount{ filter: blur(0); }
    .menu{
      flex:1;
      display:flex;
      flex-wrap:wrap;
      gap:20px;
      padding:30px;
      justify-content:center;
    }
    .btn{
      flex:1 1 350px;
      background:#6a1b9a;
      padding:35px;
      font-size:24px;
      font-weight:bold;
      border:none;
      border-radius:20px;
      color:white;
      cursor:pointer;
      transition: 0.3s;
    }
    .btn:hover{ background:#8e24aa; transform:scale(1.02); }
    .btn-main-feature{ background: #4527a0; border: 2px solid #b39ddb; }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; }
    .footer-btn{
      background:#ff5722;
      padding:25px;
      font-size:28px;
      width:90%;
      max-width:600px;
      margin:20px auto;
      border-radius:20px;
      border:none;
      color:white;
      font-weight:bold;
      cursor: pointer;
    }
    .footer-btn.locked{ background:#2196F3; }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <a href="index.html" class="back">Geri</a>
    <div id="baslik">YÃ¼kleniyor...</div>
  </div>

  <div id="kilitMesaji">ðŸ”’ RAPOR KÄ°LÄ°TLÄ° - ModÃ¼ller sadece gÃ¶rÃ¼ntÃ¼leme modundadÄ±r.</div>

  <div class="topbar">
    <div id="walletCard" class="wallet-card">
      <div class="wallet-title">ðŸ’³ CÃ¼zdan: <span id="walletAmount" class="wallet-amount">...</span></div>
      <div id="walletSub" style="font-size:12px; margin-top:5px;">Bakiyeyi gÃ¶rmek iÃ§in dokun.</div>
    </div>
  </div>

  <div class="menu">
    <button class="btn btn-main-feature modÃ¼l-btn" onclick="go('konum_cevre.html')">KONUM VE Ã‡EVRE</button>
    <button class="btn modÃ¼l-btn" onclick="go('tapu_kayit.html')">TAPU KAYIT BÄ°LGÄ°LERÄ°</button>
    <button class="btn modÃ¼l-btn" onclick="go('imar.html')">Ä°MAR DURUMU</button>
    <button class="btn modÃ¼l-btn" onclick="go('belgeler.html')">Ä°NCELENEN BELGELER</button>
    <button class="btn modÃ¼l-btn" onclick="go('bina.html')">BÄ°NA BÄ°LGÄ°LERÄ°</button>
    <button class="btn modÃ¼l-btn" onclick="go('bagimsiz-bolum-detay.html')">BAÄžIMSIZ BÃ–LÃœM DETAY</button>
    <button class="btn modÃ¼l-btn" onclick="go('emsal.html')">EMSAL KARÅžILAÅžTIRMA</button>
  </div>

  <button id="btnRaporOlustur" class="footer-btn" onclick="raporOlusturUyari()">TAM RAPOR OLUÅžTUR</button>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  let isLockedGlobal = false; // Sayfa genelinde kilit durumu

  // Rapor verilerini Ã§ek
  function getReports() {
    return JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  }

  function go(page) {
    if (!rid) return;
    // EÄŸer kilitliyse modÃ¼llere gitmeyi engellemiyoruz, modÃ¼llerin kendi iÃ§inde "read-only" olmasÄ± gerekir.
    // Ama buradan engellemek istersen: if(isLockedGlobal) { alert("Rapor kilitli!"); return; }
    window.location.href = page + "?rid=" + encodeURIComponent(rid);
  }

  // Kilit durumunu kontrol eden ana fonksiyon
  async function checkLockStatus(uid) {
    // 1. LocalStorage KontrolÃ¼
    const reports = getReports();
    const localReport = reports.find(r => r.rid === rid);
    if (localReport && (localReport.isLocked || localReport.locked || localReport.final)) {
      return true;
    }

    // 2. Firebase KontrolÃ¼ (FarklÄ± koleksiyonlarÄ± tarar)
    try {
      const lockDoc = await db.collection("locks").doc(`${uid}_${rid}`).get();
      if (lockDoc.exists && lockDoc.data().locked) return true;

      const userReportDoc = await db.collection("users").doc(uid).collection("reports").doc(rid).get();
      if (userReportDoc.exists && (userReportDoc.data().locked || userReportDoc.data().isLocked)) return true;
    } catch (e) {
      console.error("Kilit kontrolÃ¼ hatasÄ±:", e);
    }

    return false;
  }

  // UI'Ä± kilit durumuna gÃ¶re gÃ¼ncelle
  function applyLockedUI() {
    isLockedGlobal = true;
    document.getElementById("kilitMesaji").style.display = "block";
    
    // ModÃ¼l butonlarÄ±nÄ± pasif yapma (Ä°steÄŸe baÄŸlÄ±: ModÃ¼llere girmesin dersen)
    // document.querySelectorAll(".modÃ¼l-btn").forEach(b => b.disabled = true);

    const btn = document.getElementById("btnRaporOlustur");
    btn.textContent = "TAMAMLANMIÅž RAPORU GÃ–RÃœNTÃœLE";
    btn.classList.add("locked");
    btn.onclick = () => {
      window.location.href = "rapor-olustur.html?rid=" + encodeURIComponent(rid);
    };
  }

  async function raporOlusturUyari() {
    if (!rid) return;
    
    const msg = "DÄ°KKAT! Rapor oluÅŸturulduÄŸunda bakiye dÃ¼ÅŸebilir ve veriler kilitlenir. Devam edilsin mi?";
    if (!confirm(msg)) return;

    window.location.href = "rapor-olustur.html?rid=" + encodeURIComponent(rid) + "&confirm=1";
  }

  // CÃ¼zdan YÃ¼kleme
  async function loadWallet(uid) {
    if (!window.Wallet) return;
    try {
      const w = await Wallet.load(uid);
      const bal = w?.balanceTL || 0;
      document.getElementById("walletAmount").textContent = bal + " TL";
    } catch (e) {
      document.getElementById("walletAmount").textContent = "Hata";
    }
  }

  document.getElementById("walletCard").onclick = function() {
    this.classList.toggle("reveal");
  };

  // AÃ§Ä±lÄ±ÅŸ
  auth.onAuthStateChanged(async (user) => {
    if (!user) { window.location.href = "index.html"; return; }
    if (!rid) { window.location.href = "index.html"; return; }

    const reports = getReports();
    const report = reports.find(r => r.rid === rid);
    if (report) {
      document.getElementById("baslik").textContent = report.propertyName || "Gayrimenkul Raporu";
    }

    // Kilit kontrolÃ¼nÃ¼ yap ve uygula
    const locked = await checkLockStatus(user.uid);
    if (locked) {
      applyLockedUI();
    }

    loadWallet(user.uid);
  });
</script>
</body>
</html>

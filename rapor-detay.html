<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Rapor Ana MenÃ¼ - Raporan X</title>
  <style>
    body { font-family: Arial; background: linear-gradient(135deg,#4a148c,#7c4dff); margin:0; color:white; min-height:100vh; display:flex; flex-direction:column; }
    .header { padding:20px; text-align:center; font-size:28px; font-weight:bold; position: relative; }
    .back { position:absolute; left:15px; top:20px; background:rgba(255,255,255,0.2); padding:10px 20px; border-radius:30px; text-decoration:none; color:white; font-weight:bold; }

    /* CÃ¼zdan + Kilit panel */
    .top-panels { width: 100%; max-width: 1100px; margin: 0 auto; padding: 0 20px; box-sizing: border-box; }
    .panel {
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 16px;
      padding: 14px 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      margin-bottom: 14px;
      backdrop-filter: blur(6px);
    }
    .panel h3 { margin: 0 0 10px 0; font-size: 16px; letter-spacing: .5px; }
    .wallet-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .wallet-item { background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.18); border-radius: 12px; padding: 10px; }
    .wallet-item .k { font-size: 12px; opacity: .85; }
    .wallet-item .v { font-size: 18px; font-weight: 900; margin-top: 4px; }
    .wallet-actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .mini-btn {
      background: rgba(255,255,255,0.18);
      border: 1px solid rgba(255,255,255,0.22);
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 800;
      transition: .2s;
    }
    .mini-btn:hover { transform: translateY(-1px); background: rgba(255,255,255,0.25); }
    .danger { background: rgba(255,87,34,0.28); border-color: rgba(255,87,34,0.45); }
    .danger:hover { background: rgba(255,87,34,0.38); }
    .ok { background: rgba(0,200,83,0.22); border-color: rgba(0,200,83,0.35); }
    .ok:hover { background: rgba(0,200,83,0.30); }

    .lock-banner {
      border-left: 6px solid #ff5252;
      background: rgba(255, 82, 82, 0.15);
    }
    .lock-banner b { color: #ffd4d4; }

    /* MenÃ¼ */
    .menu { flex:1; display:flex; flex-wrap:wrap; gap:20px; padding:30px; justify-content:center; align-content:flex-start; }
    .btn {
      flex:1 1 350px;
      background:#6a1b9a;
      padding:30px 35px;
      font-size:22px;
      font-weight:bold;
      border:none;
      border-radius:20px;
      color:white;
      cursor:pointer;
      box-shadow:0 8px 20px rgba(0,0,0,0.4);
      transition: 0.3s;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .btn:hover { background:#8e24aa; transform:scale(1.03); }
    .btn-main-feature { background: #4527a0; border: 2px solid #b39ddb; }

    /* Durum Rozetleri */
    .badge {
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.28);
      background: rgba(0,0,0,0.25);
      min-width: 110px;
      text-align:center;
      user-select:none;
    }
    .st0 { background: rgba(198,40,40,0.35); }   /* Eksik */
    .st1 { background: rgba(255,193,7,0.30); }   /* KÄ±smi */
    .st2 { background: rgba(0,200,83,0.30); }    /* Tamam */

    .footer-btn {
      background:#ff5722;
      padding:25px;
      font-size:28px;
      width:90%;
      max-width:600px;
      margin:20px auto;
      border-radius:20px;
      border:none;
      color:white;
      font-weight:bold;
      cursor: pointer;
      text-align: center;
      box-shadow:0 10px 25px rgba(0,0,0,0.35);
      transition:.25s;
    }
    .footer-btn:hover{ transform: translateY(-2px); background:#ff6f3d; }

    .footer-btn[disabled]{
      opacity: .6;
      cursor: not-allowed;
      transform: none !important;
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <a href="index.html" class="back">Ana Sayfa</a>
    <div id="baslik">Gayrimenkul Raporu</div>
  </div>

  <!-- CÃœZDAN + KÄ°LÄ°T + BÄ°LGÄ° -->
  <div class="top-panels">
    <div id="lockBanner" class="panel lock-banner" style="display:none;"></div>
    <div id="walletPanel" class="panel" style="display:none;"></div>
  </div>

  <div class="menu">
    <button class="btn btn-main-feature" id="btn_konum" onclick="go('konum_cevre.html','konum')">
      <span>KONUM VE Ã‡EVRE Ã–ZELLÄ°KLERÄ°</span>
      <span class="badge" id="st_konum">Eksik</span>
    </button>

    <button class="btn" id="btn_tapu" onclick="go('tapu_kayit.html','tapu')">
      <span>TAPU KAYIT BÄ°LGÄ°LERÄ°</span>
      <span class="badge" id="st_tapu">Eksik</span>
    </button>

    <button class="btn" id="btn_imar" onclick="go('imar.html','imar')">
      <span>Ä°MAR DURUMU</span>
      <span class="badge" id="st_imar">Eksik</span>
    </button>

    <button class="btn" id="btn_belgeler" onclick="go('belgeler.html','belgeler')">
      <span>Ä°NCELENEN BELGELER</span>
      <span class="badge" id="st_belgeler">Eksik</span>
    </button>

    <button class="btn" id="btn_bina" onclick="go('bina.html','bina')">
      <span>BÄ°NA BÄ°LGÄ°LERÄ°</span>
      <span class="badge" id="st_bina">Eksik</span>
    </button>

    <button class="btn" id="btn_bb" onclick="go('bagimsiz-bolum-detay.html','bb')">
      <span>BAÄžIMSIZ BÃ–LÃœM DETAY</span>
      <span class="badge" id="st_bb">Eksik</span>
    </button>

    <button class="btn" id="btn_emsal" onclick="go('emsal.html','emsal')">
      <span>EMSAL KARÅžILAÅžTIRMA</span>
      <span class="badge" id="st_emsal">Eksik</span>
    </button>
  </div>

  <!-- BURASI SADECE RAPOR-OLUSTUR'A GIDER. KILITLIYSE GÄ°TMEZ. -->
  <button class="footer-btn" id="btnRaporOlustur" onclick="goRaporOlustur()">TAM RAPOR OLUÅžTUR</button>

  <script>
    // âœ… Firebase auth/db garanti
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ========= RID helpers (geriye dÃ¶nÃ¼k uyumluluk + migration) ========= */
    function genRid(){
      try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
      return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
    }
    function ensureRidMigration(arr){
      let changed = false;
      (arr || []).forEach(r => {
        if (r && !r.rid) { r.rid = genRid(); changed = true; }
      });
      return changed;
    }
    function findIndexByRid(arr, rid){
      return (arr || []).findIndex(r => r && r.rid === rid);
    }

    /* ========= URL Params: rid Ã¶ncelikli ========= */
    const urlParams = new URLSearchParams(window.location.search);
    let rid = urlParams.get('rid');
    const legacyId = urlParams.get('id'); // eski linkler iÃ§in

    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    if (ensureRidMigration(reports)) {
      localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
      reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    }

    // Eski ?id= ile gelmiÅŸse rid'ye Ã§evir
    if (!rid && legacyId !== null && legacyId !== "") {
      const idx = Number(legacyId);
      if (!Number.isNaN(idx) && reports[idx] && reports[idx].rid) {
        rid = reports[idx].rid;
        window.location.replace("rapor-detay.html?rid=" + encodeURIComponent(rid));
      }
    }

    function getReportIndexByRid(rid){
      return findIndexByRid(reports, rid);
    }
    function getReportByRid(rid){
      const idx = getReportIndexByRid(rid);
      if (idx < 0) return null;
      return reports[idx];
    }
    function persistReport(rid, report){
      const idx = getReportIndexByRid(rid);
      if (idx < 0) return;
      reports[idx] = report;
      localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
    }

    /* ========= Wallet + Lock ========= */
    function ensureWallet(report){
      report.wallet = report.wallet || {};
      if (typeof report.wallet.freeUsed !== "number") report.wallet.freeUsed = 0;
      if (typeof report.wallet.balanceTl !== "number") report.wallet.balanceTl = 0;
      if (typeof report.wallet.locked !== "boolean") report.wallet.locked = false;
      if (!report.wallet.lockedAt) report.wallet.lockedAt = null;
      if (typeof report.wallet.lastChargeTl !== "number") report.wallet.lastChargeTl = 0;

      report.modulesStatus = report.modulesStatus || {};
      const keys = ["imar","belgeler","bina","bb","konum","tapu","emsal"];
      keys.forEach(k => {
        if (![0,1,2].includes(report.modulesStatus[k])) report.modulesStatus[k] = 0;
      });
    }

    function calcUnitPriceByBalance(balance){
      if (balance >= 500) return 20;
      if (balance >= 200) return 25;
      return 30;
    }

    function renderWalletPanel(report){
      const el = document.getElementById("walletPanel");
      if (!el) return;

      const freeLeft = Math.max(0, 5 - (report.wallet.freeUsed || 0));
      const balance = Math.max(0, Number(report.wallet.balanceTl || 0));
      const unit = calcUnitPriceByBalance(balance);

      el.style.display = "block";
      el.innerHTML = `
        <h3>ðŸ’³ CÃ¼zdan</h3>
        <div class="wallet-grid">
          <div class="wallet-item">
            <div class="k">Ãœcretsiz Hak</div>
            <div class="v">${freeLeft} / 5</div>
          </div>
          <div class="wallet-item">
            <div class="k">Bakiye</div>
            <div class="v">${balance.toLocaleString("tr-TR")} TL</div>
          </div>
          <div class="wallet-item">
            <div class="k">Rapor Ãœcreti (bakiyeye gÃ¶re)</div>
            <div class="v">${unit} TL</div>
          </div>
        </div>
        <div class="wallet-actions">
          <button class="mini-btn ok" onclick="openTopUp()">Para YÃ¼kle</button>
          <button class="mini-btn" onclick="showPricing()">FiyatlandÄ±rma</button>
        </div>
        <div class="mini-note">Not: Rapor oluÅŸturulup kilitlenince bu kayda ait modÃ¼ller tekrar aÃ§Ä±lmaz.</div>
      `;
    }

    function renderLockBanner(report){
      const el = document.getElementById("lockBanner");
      if (!el) return;

      if (report.wallet.locked) {
        el.style.display = "block";
        el.innerHTML = `
          <h3>ðŸ”’ Bu rapor kilitlenmiÅŸtir</h3>
          <div><b>Rapor oluÅŸturulduktan sonra veri giriÅŸi kapatÄ±lÄ±r.</b> Bu kayda ait modÃ¼ller tekrar aÃ§Ä±lamaz.</div>
        `;
        // rapor oluÅŸtur butonu kilitli
        const btn = document.getElementById("btnRaporOlustur");
        if (btn) btn.setAttribute("disabled","disabled");
      } else {
        el.style.display = "none";
        const btn = document.getElementById("btnRaporOlustur");
        if (btn) btn.removeAttribute("disabled");
      }
    }

    // Burada PayTR entegrasyonu yok â€” sadece placeholder
    function openTopUp(){
      alert("ðŸ’³ Para yÃ¼kleme ekranÄ±: PayTR entegrasyonu gelince buradan aÃ§acaÄŸÄ±z.\nÅžimdilik test iÃ§in bakiyeyi panelden/consoleâ€™dan da yazabiliriz.");
    }
    function showPricing(){
      alert("FiyatlandÄ±rma:\n- Ä°lk 5 rapor Ã¼cretsiz\n- Bakiye < 200 TL: 30 TL/rapor\n- 200â€“499 TL: 25 TL/rapor\n- 500 TL ve Ã¼zeri: 20 TL/rapor");
    }

    /* ========= Status badges (Eksik/KÄ±smi/Tamam) ========= */
    function statusText(s){
      if (s === 2) return "TamamlandÄ±";
      if (s === 1) return "KÄ±smi";
      return "Eksik";
    }
    function applyBadge(elId, status){
      const el = document.getElementById(elId);
      if (!el) return;
      el.classList.remove("st0","st1","st2");
      if (status === 2) el.classList.add("st2");
      else if (status === 1) el.classList.add("st1");
      else el.classList.add("st0");
      el.textContent = statusText(status);
    }

    function renderAllBadges(report){
      ensureWallet(report);
      applyBadge("st_konum", report.modulesStatus.konum);
      applyBadge("st_tapu", report.modulesStatus.tapu);
      applyBadge("st_imar", report.modulesStatus.imar);
      applyBadge("st_belgeler", report.modulesStatus.belgeler);
      applyBadge("st_bina", report.modulesStatus.bina);
      applyBadge("st_bb", report.modulesStatus.bb);
      applyBadge("st_emsal", report.modulesStatus.emsal);
    }

    // URL ile status update: ?update=konum&status=2
    function handleStatusUpdateFromUrl(report){
      const u = new URLSearchParams(window.location.search);
      const update = u.get("update");
      const statusRaw = u.get("status");
      if (!update || statusRaw === null) return false;

      const s = Number(statusRaw);
      if (!["imar","belgeler","bina","bb","konum","tapu","emsal"].includes(update)) return false;
      if (![0,1,2].includes(s)) return false;

      ensureWallet(report);
      report.modulesStatus[update] = s;
      persistReport(rid, report);

      // URLâ€™i temizle (tekrar tekrar iÅŸlenmesin)
      u.delete("update"); u.delete("status");
      const clean = location.pathname + "?rid=" + encodeURIComponent(rid);
      window.history.replaceState({}, "", clean);
      return true;
    }

    /* ========= Navigation guards ========= */
    function go(page, moduleKey){
      if (!rid) { window.location.href = "index.html"; return; }

      const report = getReportByRid(rid);
      if (!report) { window.location.href = "index.html"; return; }

      ensureWallet(report);

      // Kilitliyse modÃ¼l aÃ§ma
      if (report.wallet.locked) {
        alert("ðŸ”’ Bu rapor kilitli. Rapor oluÅŸturulduktan sonra bu kayda tekrar veri giriÅŸi yapÄ±lamaz.");
        return;
      }

      // normal geÃ§
      window.location.href = page + "?rid=" + encodeURIComponent(rid);
    }

    function goRaporOlustur(){
      if (!rid) { window.location.href = "index.html"; return; }
      const report = getReportByRid(rid);
      if (!report) { window.location.href = "index.html"; return; }
      ensureWallet(report);

      if (report.wallet.locked) {
        alert("ðŸ”’ Bu rapor kilitli. Yeni rapor iÃ§in yeni kayÄ±t oluÅŸturmalÄ±sÄ±n.");
        return;
      }

      // burada raporu oluÅŸturmayÄ±z, sadece sayfaya gideriz
      window.location.href = "rapor-olustur.html?rid=" + encodeURIComponent(rid);
    }

    /* ========= Boot ========= */
    auth.onAuthStateChanged((user) => {
      if (!user || !rid) { window.location.href = 'index.html'; return; }

      const report = getReportByRid(rid);
      if (!report) { window.location.href = 'index.html'; return; }

      // BaÅŸlÄ±k
      document.getElementById('baslik').textContent = report.propertyName || "Ä°simsiz Gayrimenkul";

      // Wallet + status init
      ensureWallet(report);
      const changedByUrl = handleStatusUpdateFromUrl(report);

      // Render
      renderWalletPanel(report);
      renderLockBanner(report);
      renderAllBadges(report);

      // EÄŸer URL ile update olduysa da tekrar render zaten yaptÄ±k
      if (changedByUrl) {
        const refreshed = getReportByRid(rid);
        if (refreshed) {
          ensureWallet(refreshed);
          renderWalletPanel(refreshed);
          renderLockBanner(refreshed);
          renderAllBadges(refreshed);
        }
      }

      // kaydet (wallet alanlarÄ± yoksa yaz)
      persistReport(rid, report);
    });
  </script>
</body>
</html>

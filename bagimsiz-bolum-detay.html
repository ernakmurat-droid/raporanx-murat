<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m Detay - Raporan X</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary:#4a148c; --secondary:#7c4dff; --success:#00c853; --bg:#f0f2f5; }
    body{ font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:var(--bg); margin:0; padding-bottom:110px; color:#333; }
    .header{ background:linear-gradient(135deg,#4a148c,#7c4dff); color:#fff; padding: calc(22px + env(safe-area-inset-top, 0px)) 25px 22px; text-align:center; position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.2); }
    .back{ position:absolute; left:15px; top: calc(16px + env(safe-area-inset-top, 0px)); background:rgba(255,255,255,.2); padding:8px 15px; border-radius:20px; color:#fff; font-weight:bold; font-size:14px; cursor:pointer; border:none; }
    .container{ max-width:900px; margin:16px auto; padding:16px; background:#fff; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .section-title{ border-bottom:2px solid #eee; margin:18px 0 12px; padding-bottom:10px; color:#4a148c; font-size:1.1em; font-weight:900; }
    .form-group{ margin-bottom:14px; padding:14px; background:#fdfdfd; border:1px solid #f0f0f0; border-radius:12px; }
    .input-item{ margin-bottom:12px; }
    .input-item label{ display:block; font-weight:700; margin-bottom:6px; font-size:13px; color:#555; }
    input,select,textarea{ padding:12px; width:100%; border:1.5px solid #dee2e6; border-radius:10px; font-size:15px; box-sizing:border-box; outline:none; transition:.2s; }
    input:focus, textarea:focus{ border-color:#7c4dff; background:#f9f7ff; }
    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:720px){ .grid-3,.grid-2{ grid-template-columns:1fr; } }
    .hacim-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:10px; margin-bottom:6px; }
    .hacim-card{ background:#fff; border:1px solid #eee; padding:10px; border-radius:10px; text-align:center; }
    .checkbox-group{ display:flex; flex-wrap:wrap; gap:8px; }
    .checkbox-group label{ background:#f0f0f0; padding:8px 14px; border-radius:999px; cursor:pointer; font-size:13px; user-select:none; }
    .checkbox-group input{ display:none; }
    .checkbox-group input:checked + span{ background:#4a148c; color:#fff; border-radius:999px; padding:8px 14px; margin:-8px -14px; display:inline-block; }
    .btn{ padding:14px; border:none; border-radius:12px; font-size:16px; font-weight:900; cursor:pointer; width:100%; margin-top:10px; }
    .btn-save{ background:#00c853; color:#fff; }
    .bbbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:12px; border:1px solid #e0e6ed; border-radius:14px; background:#fff; margin-bottom:12px; }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .bbTab{ padding:10px 12px; border-radius:12px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:900; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }
    .taslak{ background:#fff8e1; padding:16px; border-radius:14px; margin-top:16px; border:2px dashed #ffb300; font-size:15px; line-height:1.75; white-space:pre-wrap; color:#333; user-select:none; transition:filter .2s ease; min-height:120px; }
    .taslak:not(:hover){ filter:blur(1.5px); }
    .hidden{ display:none !important; }
    .toplu-liste-konteyner { margin-top: 30px; padding: 20px; background: #fafafa; border: 2px solid #4a148c; border-radius: 16px; }
    .toplu-bb-kart { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #7c4dff; }
  </style>

  <link rel="stylesheet" href="mobil-fix.css">
</head>

<body>
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼</button>
    <h1 style="margin:0;">BAÄIMSIZ BÃ–LÃœM DETAY</h1>
    <div id="raporBilgi" style="margin-top:6px; font-weight:800; opacity:.95;">YÃ¼kleniyor...</div>
  </div>

  <div class="container">
    <div class="bbbar">
      <div style="font-weight:900; color:var(--primary);">BaÄŸÄ±msÄ±z BÃ¶lÃ¼m:</div>
      <div class="bbTabs" id="bbTabs"></div>
      <div class="bbActions" style="margin-left:auto; display:flex; gap:8px;">
        <button type="button" id="btnAddBB" class="btn" style="width:auto; margin:0; padding:8px 12px; background:#f6f0ff; color:#4a148c;" onclick="addBB()">+ Yeni BB</button>
      </div>
    </div>

    <div class="section-title">1) Kimlik ve Alan Bilgileri</div>
    <div class="form-group">
      <div class="grid-3">
        <div class="input-item"><label>Kat</label><input type="text" id="kat" oninput="metinOlustur()" list="h_kat"></div>
        <div class="input-item"><label>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m No</label><input type="text" id="bbNo" oninput="metinOlustur()"></div>
        <div class="input-item"><label>KapÄ± No</label><input type="text" id="kapiNo" oninput="metinOlustur()"></div>
      </div>
      <div class="grid-2">
        <div class="input-item"><label>Nitelik</label><input type="text" id="nitelik" placeholder="mesken" oninput="metinOlustur()" list="h_nitelik"></div>
        <div class="input-item"><label>GiriÅŸe GÃ¶re Konumu</label><input type="text" id="konum" placeholder="saÄŸ tarafta" oninput="metinOlustur()" list="h_konum"></div>
      </div>
      <div class="grid-2">
        <div class="input-item"><label>Net Alan (mÂ²)</label><input type="number" id="alanNet" value="0" oninput="metinOlustur()"></div>
        <div class="input-item"><label>BrÃ¼t Alan (mÂ²)</label><input type="number" id="alanBrut" value="0" oninput="metinOlustur()"></div>
      </div>
    </div>

    <div class="section-title">2) Ä°Ã§ Ã–zellikler</div>
    <div class="form-group">
      <div class="grid-2">
        <div class="input-item"><label>Antre Zemin</label><input type="text" id="antreZemin" oninput="metinOlustur()" list="h_antreZemin"></div>
        <div class="input-item"><label>Antre Duvar</label><input type="text" id="antreDuvar" oninput="metinOlustur()" list="h_antreDuvar"></div>
        <div class="input-item"><label>Salon Zemin</label><input type="text" id="salonZemin" oninput="metinOlustur()" list="h_salonZemin"></div>
        <div class="input-item"><label>Salon Duvar</label><input type="text" id="salonDuvar" oninput="metinOlustur()" list="h_salonDuvar"></div>
        <div class="input-item"><label>Oda Zemin</label><input type="text" id="odaZemin" oninput="metinOlustur()" list="h_odaZemin"></div>
        <div class="input-item"><label>Oda Duvar</label><input type="text" id="odaDuvar" oninput="metinOlustur()" list="h_odaDuvar"></div>
        <div class="input-item"><label>GiriÅŸ KapÄ±sÄ±</label><input type="text" id="daireKapi" oninput="metinOlustur()" list="h_daireKapi"></div>
        <div class="input-item"><label>IsÄ±tma</label><input type="text" id="isitma" oninput="metinOlustur()" list="h_isitma"></div>
      </div>
    </div>

    <button id="btnSave" class="btn btn-save" onclick="kaydet()">VERÄ°LERÄ° KAYDET VE Ã–ÄREN</button>

    <div class="section-title">SeÃ§ili BB Taslak Metin</div>
    <div id="taslak" class="taslak"></div>

    <div class="section-title" style="margin-top:40px; border-color: #ff9800; color: #e65100;">
      ğŸ“‹ TÃ¼m BaÄŸÄ±msÄ±z BÃ¶lÃ¼mlerin Metin Ã–zeti
    </div>
    <div id="topluMetinAlani" class="toplu-liste-konteyner"></div>
  </div>

  <div id="datalistContainer">
    <datalist id="h_kat"></datalist>
    <datalist id="h_nitelik"></datalist>
    <datalist id="h_konum"></datalist>
    <datalist id="h_antreZemin"></datalist>
    <datalist id="h_antreDuvar"></datalist>
    <datalist id="h_salonZemin"></datalist>
    <datalist id="h_salonDuvar"></datalist>
    <datalist id="h_odaZemin"></datalist>
    <datalist id="h_odaDuvar"></datalist>
    <datalist id="h_daireKapi"></datalist>
    <datalist id="h_isitma"></datalist>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');

  /* ========= AKILLI HATIRLATICI (Ã–ÄRENME) MANTIÄI ========= */
  const SUGGESTION_KEYS = ['kat', 'nitelik', 'konum', 'antreZemin', 'antreDuvar', 'salonZemin', 'salonDuvar', 'odaZemin', 'odaDuvar', 'daireKapi', 'isitma'];

  function loadSuggestions() {
    SUGGESTION_KEYS.forEach(key => {
      const saved = JSON.parse(localStorage.getItem('suggest_' + key) || '[]');
      const dl = document.getElementById('h_' + key);
      if (dl) {
        dl.innerHTML = '';
        saved.forEach(val => {
          const opt = document.createElement('option');
          opt.value = val;
          dl.appendChild(opt);
        });
      }
    });
  }

  function saveNewSuggestions(data) {
    SUGGESTION_KEYS.forEach(key => {
      const val = data[key]?.trim();
      if (val && val.length > 1) {
        let saved = JSON.parse(localStorage.getItem('suggest_' + key) || '[]');
        if (!saved.includes(val)) {
          saved.push(val);
          // Son 15 giriÅŸi hatÄ±rla
          if (saved.length > 15) saved.shift();
          localStorage.setItem('suggest_' + key, JSON.stringify(saved));
        }
      }
    });
    loadSuggestions();
  }

  /* ========= ANA FONKSÄ°YONLAR ========= */
  let activeBBIndex = 0;

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = arr.findIndex(r => r && r.rid === rid);
    return { arr, i, r: arr[i] || null };
  }

  function persist(arr, i, r){
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
  }

  function metinOlustur() {
    const data = readForm();
    const metin = buildTextFromData(data);
    document.getElementById("taslak").innerText = metin;
    topluListeyiGuncelle();
  }

  function buildTextFromData(d) {
    return `TaÅŸÄ±nmaz ${d.kat || '...'} katÄ±nda, ${d.bbNo || '...'} nolu ${d.nitelik || 'mesken'} nitelikli bÃ¶lÃ¼mdÃ¼r. Zeminler ${d.salonZemin || '...'}, duvarlar ${d.salonDuvar || '...'} malzemedir. IsÄ±nma ${d.isitma || '...'} ile saÄŸlanmaktadÄ±r.`;
  }

  function readForm(){
    const obj = {};
    const ids = ['kat','bbNo','kapiNo','nitelik','konum','alanNet','alanBrut','antreZemin','antreDuvar','salonZemin','salonDuvar','odaZemin','odaDuvar','daireKapi','isitma'];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if(el) obj[id] = el.value;
    });
    return obj;
  }

  function writeForm(obj){
    if(!obj) return;
    Object.keys(obj).forEach(key => {
      const el = document.getElementById(key);
      if(el) el.value = obj[key];
    });
  }

  function kaydet() {
    const { arr, i, r } = getLatestData();
    if (!r) return;

    const currentData = readForm();
    saveNewSuggestions(currentData); // Ã–ÄREN: Yeni girilenleri hafÄ±zaya al

    const bb = r.bbDetayList[activeBBIndex];
    bb.bbDetay = currentData;
    const metin = buildTextFromData(currentData);
    bb.taslakMetin = metin;

    // Rapor seviyesinde mÃ¼hÃ¼rle
    if(!r.modules) r.modules = {};
    if(!r.modules.bagimsizBolum) r.modules.bagimsizBolum = {};
    
    let toplu = "";
    r.bbDetayList.forEach(b => {
      toplu += `ğŸ“ ${b.baslik}\n${b.taslakMetin || ''}\n\n`;
    });
    r.modules.bagimsizBolum.text = toplu;

    persist(arr, i, r);
    alert("Kaydedildi ve tercihleriniz hatÄ±rlandÄ±! âœ…");
  }

  function renderBBTabs(){
    const { r } = getLatestData();
    if (!r || !r.bbDetayList) return;
    const el = document.getElementById("bbTabs");
    el.innerHTML = r.bbDetayList.map((x, idx) => {
      const active = idx === activeBBIndex ? "bbTab active" : "bbTab";
      return `<button type="button" class="${active}" onclick="setActiveBB(${idx})">${x.baslik}</button>`;
    }).join("");
  }

  function setActiveBB(idx){
    const { arr, i, r } = getLatestData();
    r.bbDetayList[activeBBIndex].bbDetay = readForm(); // GeÃ§erliyi kaydet
    activeBBIndex = idx;
    persist(arr, i, r);
    renderBBTabs();
    writeForm(r.bbDetayList[idx].bbDetay);
    metinOlustur();
  }

  function addBB(){
    const { arr, i, r } = getLatestData();
    const next = r.bbDetayList.length + 1;
    r.bbDetayList.push({ baslik: next + ". BB", bbDetay: {} });
    persist(arr, i, r);
    setActiveBB(r.bbDetayList.length - 1);
  }

  function topluListeyiGuncelle() {
    const { r } = getLatestData();
    if (!r) return;
    let html = "";
    r.bbDetayList.forEach((bb, idx) => {
      const metin = (idx === activeBBIndex) ? buildTextFromData(readForm()) : (bb.taslakMetin || "...");
      html += `<div class="toplu-bb-kart"><strong>${bb.baslik}</strong><br>${metin}</div>`;
    });
    document.getElementById("topluMetinAlani").innerHTML = html;
  }

  function anaMenuyeDon() { window.location.href = `rapor-detay.html?rid=${rid}`; }

  window.onload = () => {
    loadSuggestions(); // BaÅŸlangÄ±Ã§ta eski hafÄ±zayÄ± yÃ¼kle
    renderBBTabs();
    const { r } = getLatestData();
    if(r) {
        document.getElementById('raporBilgi').innerText = r.propertyName || "Rapor DetayÄ±";
        writeForm(r.bbDetayList[activeBBIndex].bbDetay);
        metinOlustur();
    }
  };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m Detay</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <link rel="stylesheet" href="mobil-fix.css">

  <style>
    :root { --primary:#4a148c; --secondary:#7c4dff; --success:#00c853; --bg:#f0f2f5; }

    body{ font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:var(--bg); margin:0; padding-bottom:110px; color:#333; }

    .header{
      background:linear-gradient(135deg,#4a148c,#7c4dff);
      color:#fff;
      padding:25px;
      text-align:center;
      position:sticky; top:0; z-index:1000;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
    }
    .back{
      position:absolute; left:15px; top:22px;
      background:rgba(255,255,255,.2);
      padding:8px 15px; border-radius:20px;
      color:#fff; font-weight:900; font-size:14px;
      cursor:pointer; border:none;
    }

    .container{
      max-width:850px; margin:20px auto; padding:20px;
      background:#fff; border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }

    .section-title{
      border-bottom:2px solid #eee;
      margin:22px 0 14px; padding-bottom:10px;
      color:#4a148c; font-size:1.15em; font-weight:900;
    }

    .form-group{
      margin-bottom:20px; padding:15px;
      background:#fdfdfd; border:1px solid #f0f0f0;
      border-radius:10px;
    }

    .input-item{ margin-bottom:15px; }
    .input-item label{ display:block; font-weight:700; margin-bottom:6px; font-size:14px; color:#555; }

    input,select,textarea{
      padding:12px; width:100%;
      border:1.5px solid #dee2e6;
      border-radius:8px; font-size:15px;
      box-sizing:border-box; outline:none;
      transition:.2s;
    }
    input:focus, textarea:focus{ border-color:#7c4dff; background:#f9f7ff; }

    .hacim-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(110px, 1fr)); gap:10px; margin-bottom:6px; }
    .hacim-card{ background:#fff; border:1px solid #eee; padding:10px; border-radius:8px; text-align:center; }
    .hacim-card label{ display:block; font-weight:800; margin-bottom:6px; }

    .checkbox-group{ display:flex; flex-wrap:wrap; gap:8px; }
    .checkbox-group label{ background:#f0f0f0; padding:8px 15px; border-radius:20px; cursor:pointer; font-size:13px; }
    .checkbox-group input{ display:none; }
    .checkbox-group input:checked + span{
      background:#4a148c; color:#fff;
      border-radius:20px; padding:8px 15px;
      margin:-8px -15px; display:inline-block;
    }

    .btn{ padding:15px; border:none; border-radius:10px; font-size:16px; font-weight:900; cursor:pointer; width:100%; margin-top:10px; }
    .btn-save{ background:#00c853; color:#fff; }
    .btn-save[disabled]{ opacity:.55; cursor:not-allowed; }

    /* Ã‡oklu BB bar */
    .bbbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:12px; border:1px solid #e0e6ed; border-radius:12px; background:#fff; margin-bottom:14px; }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .bbTab{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:900; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }
    .hint{ font-size:12px; color:#666; width:100%; margin-top:6px; }

    .bbActions{ margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .bbMiniBtn{
      padding:10px 12px; border-radius:10px;
      border:1px solid rgba(74,20,140,.25);
      background:#f6f0ff; color:#4a148c;
      font-weight:900; cursor:pointer;
    }
    .bbMiniBtn.danger{ background:#ffe9e9; border-color:rgba(198,40,40,.25); color:#c62828; }
    .bbMiniBtn[disabled]{ opacity:.55; cursor:not-allowed; }

    /* UyarÄ± */
    .infoNote{
      background:#eef6ff;
      border-left:6px solid #1e88e5;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:14px;
      font-weight:800;
      color:#0d3c66;
      line-height:1.35;
    }
    .infoNote b{ font-weight:900; }

    /* Taslak */
    .taslak{
      background:#fff8e1; padding:20px;
      border-radius:12px; margin-top:18px;
      border:2px dashed #ffb300;
      font-size:15px; line-height:1.75;
      white-space:pre-wrap; color:#333;
      user-select:none;
      transition:filter .25s ease;
    }
    .taslak:not(:hover){ filter:blur(1.5px); }

    @media print{
      body *{ visibility:hidden; }
      .taslak{ visibility:hidden; }
      .taslak::after{
        content:"BU METÄ°N KORUMALIDIR!";
        visibility:visible;
        position:fixed; left:50%; top:50%;
        transform:translate(-50%, -50%);
        font-size:30px; color:red;
      }
    }

    .hidden{ display:none !important; }

    .lockedNote{
      background:#ffe9e9;
      border-left:6px solid #c62828;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:14px;
      font-weight:900;
      color:#7a1b1b;
    }

    .radioRow{ display:flex; gap:18px; margin:10px 0; align-items:center; flex-wrap:wrap; }
    .radioRow label{ width:auto; cursor:pointer; font-weight:800; }
    .subBox{ margin-top:10px; }

    hr.sep{ border:none; border-top:1px solid #eee; margin:16px 0; }
  </style>
</head>

<body>
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼</button>
    <h1>BAÄIMSIZ BÃ–LÃœM DETAY</h1>
    <div id="raporBilgi">YÃ¼kleniyor...</div>
  </div>

  <div class="container">
    <div id="lockNote" class="lockedNote hidden">
      ğŸ”’ Bu rapor FINAL yapÄ±lmÄ±ÅŸ. Bu modÃ¼l kilitlidir (dÃ¼zenleme yapÄ±lamaz).
    </div>

    <div class="infoNote">
      â„¹ï¸ Bu ekranda yalnÄ±zca <b>seÃ§ili baÄŸÄ±msÄ±z bÃ¶lÃ¼mÃ¼n</b> metni oluÅŸturulur ve gÃ¶sterilir.
      DiÄŸer baÄŸÄ±msÄ±z bÃ¶lÃ¼mleri sekmelerden tek tek gÃ¶rebilirsin.
      <b>TÃ¼m baÄŸÄ±msÄ±z bÃ¶lÃ¼m metinlerini</b> toplu gÃ¶rmek iÃ§in <b>Rapor OluÅŸtur</b> ekranÄ±na geÃ§.
    </div>

    <!-- Ã‡oklu BB -->
    <div class="bbbar">
      <div style="font-weight:900; color:var(--primary);">BaÄŸÄ±msÄ±z BÃ¶lÃ¼m:</div>
      <div class="bbTabs" id="bbTabs"></div>

      <div class="bbActions">
        <button type="button" id="btnAddBB" class="bbMiniBtn" onclick="addBB()">+ Yeni BB</button>
        <button type="button" id="btnRenameBB" class="bbMiniBtn" onclick="renameBB()">âœï¸ Ad</button>
        <button type="button" id="btnDelBB" class="bbMiniBtn danger" onclick="deleteBB()">ğŸ—‘ï¸ Sil</button>
      </div>

      <div class="hint">Her BB iÃ§in ayrÄ± detay kaydedilir. Sekme deÄŸiÅŸtirince o BBâ€™nin verileri yÃ¼klenir.</div>
    </div>

    <div class="section-title">1) Kimlik ve Alan Bilgileri</div>
    <div class="form-group">
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
        <div class="input-item"><label>Kat</label><input type="text" id="kat" oninput="metinOlustur()"></div>
        <div class="input-item"><label>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m No</label><input type="text" id="bbNo" oninput="metinOlustur()"></div>
        <div class="input-item"><label>KapÄ± No</label><input type="text" id="kapiNo" oninput="metinOlustur()"></div>
      </div>

      <div class="input-item">
        <label>Nitelik (Ã¶r: mesken / bÃ¼ro / dÃ¼kkÃ¢n)</label>
        <input type="text" id="nitelik" placeholder="mesken" oninput="metinOlustur()">
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
        <div class="input-item"><label>Net Alan (mÂ²)</label><input type="number" id="alanNet" value="0" oninput="metinOlustur()"></div>
        <div class="input-item"><label>BrÃ¼t Alan (mÂ²)</label><input type="number" id="alanBrut" value="0" oninput="metinOlustur()"></div>
        <div class="input-item"><label>GiriÅŸe GÃ¶re Konumu</label><input type="text" id="konum" placeholder="saÄŸ tarafta" oninput="metinOlustur()"></div>
      </div>

      <div class="input-item">
        <label>Cepheler</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="cephe" value="Kuzey" onchange="metinOlustur()"><span>Kuzey</span></label>
          <label><input type="checkbox" name="cephe" value="GÃ¼ney" onchange="metinOlustur()"><span>GÃ¼ney</span></label>
          <label><input type="checkbox" name="cephe" value="DoÄŸu" onchange="metinOlustur()"><span>DoÄŸu</span></label>
          <label><input type="checkbox" name="cephe" value="BatÄ±" onchange="metinOlustur()"><span>BatÄ±</span></label>
          <label><input type="checkbox" name="cephe" value="Kuzey-DoÄŸu" onchange="metinOlustur()"><span>Kuzey-DoÄŸu</span></label>
          <label><input type="checkbox" name="cephe" value="Kuzey-BatÄ±" onchange="metinOlustur()"><span>Kuzey-BatÄ±</span></label>
          <label><input type="checkbox" name="cephe" value="GÃ¼ney-DoÄŸu" onchange="metinOlustur()"><span>GÃ¼ney-DoÄŸu</span></label>
          <label><input type="checkbox" name="cephe" value="GÃ¼ney-BatÄ±" onchange="metinOlustur()"><span>GÃ¼ney-BatÄ±</span></label>
        </div>
      </div>
    </div>

    <div class="section-title">2) Proje FarkÄ±</div>
    <div class="form-group">
      <label><b>Projeye gÃ¶re deÄŸiÅŸiklik var mÄ±?</b></label>
      <div class="radioRow">
        <label><input type="radio" name="farkVar" value="hayir" checked onchange="farkKontrol(); metinOlustur();"> HayÄ±r</label>
        <label><input type="radio" name="farkVar" value="evet" onchange="farkKontrol(); metinOlustur();"> Evet</label>
      </div>

      <div id="farkDetay" class="hidden subBox">
        <div class="input-item"><label>Ä°lave AÃ§Ä±klamasÄ±</label><textarea id="farkAciklama" oninput="metinOlustur()"></textarea></div>
        <div class="input-item"><label>Ä°lave BrÃ¼t Alan (mÂ²)</label><input type="number" id="ilaveBrut" value="0" oninput="metinOlustur()"></div>
      </div>
    </div>

    <div class="section-title">3) Hacimler</div>
    <div class="hacim-grid">
      <div class="hacim-card"><label>Salon</label><input type="number" id="count_salon" value="1" oninput="hacimPanelKontrol(); metinOlustur();"></div>
      <div class="hacim-card"><label>Oda</label><input type="number" id="count_oda" value="3" oninput="hacimPanelKontrol(); metinOlustur();"></div>
      <div class="hacim-card"><label>Mutfak</label><input type="number" id="count_mutfak" value="1" oninput="metinOlustur()"></div>
      <div class="hacim-card"><label>Banyo</label><input type="number" id="count_banyo" value="1" oninput="metinOlustur()"></div>
      <div class="hacim-card"><label>WC</label><input type="number" id="count_wc" value="1" oninput="metinOlustur()"></div>
      <div class="hacim-card"><label>Antre/Hol</label><input type="number" id="count_antre" value="1" oninput="metinOlustur()"></div>
      <div class="hacim-card"><label>Balkon</label><input type="number" id="count_balkon" value="1" oninput="metinOlustur()"></div>
    </div>

    <div class="section-title">4) Ä°Ã§ Ã–zellikler, Tesisat</div>
    <div class="form-group">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div class="input-item"><label>Antre Zemin</label><input type="text" id="antreZemin" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Antre Duvar</label><input type="text" id="antreDuvar" oninput="metinOlustur()"></div>

        <div class="input-item salon-inputs"><label>Salon Zemin</label><input type="text" id="salonZemin" oninput="metinOlustur()"></div>
        <div class="input-item salon-inputs"><label>Salon Duvar</label><input type="text" id="salonDuvar" oninput="metinOlustur()"></div>

        <div class="input-item oda-inputs"><label>Oda Zemin</label><input type="text" id="odaZemin" oninput="metinOlustur()"></div>
        <div class="input-item oda-inputs"><label>Oda Duvar</label><input type="text" id="odaDuvar" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Mutfak Zemin</label><input type="text" id="mutfakZemin" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Mutfak Duvar</label><input type="text" id="mutfakDuvar" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Mutfak DolabÄ±</label><input type="text" id="mutfakDolap" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Mutfak TezgahÄ±</label><input type="text" id="mutfakTezgah" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Islak Hacimler (zemin/duvar)</label><input type="text" id="islakHacim" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Banyoda Bulunan DonanÄ±mlar</label><input type="text" id="banyoDonanim" placeholder="klozet, lavabo, banyo dolabÄ±..." oninput="metinOlustur()"></div>

        <div class="input-item"><label>GiriÅŸ KapÄ±sÄ±</label><input type="text" id="daireKapi" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Ä°Ã§ KapÄ±lar</label><input type="text" id="icKapi" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Pencereler</label><input type="text" id="pencere" oninput="metinOlustur()"></div>
        <div class="input-item"><label>IsÄ±tma</label><input type="text" id="isitma" oninput="metinOlustur()"></div>
      </div>

      <hr class="sep">

      <label><b>Elektrik, su ve haberleÅŸme tesisatlarÄ±</b> mevcut mu?</label>
      <div class="radioRow">
        <label><input type="radio" name="tesisatVar" value="evet" checked onchange="tesisatKontrol(); metinOlustur();"> Evet</label>
        <label><input type="radio" name="tesisatVar" value="hayir" onchange="tesisatKontrol(); metinOlustur();"> HayÄ±r</label>
      </div>

      <div id="tesisatDetay" class="hidden subBox">
        <div class="input-item">
          <label>Tesisat AÃ§Ä±klamasÄ± (HayÄ±r seÃ§ilince metne bu yazÄ±lÄ±r)</label>
          <textarea id="tesisatAciklama" placeholder="Ã–rn: Su tesisatÄ± mevcut deÄŸildir..." oninput="metinOlustur()"></textarea>
        </div>
      </div>
    </div>

    <button id="btnSave" class="btn btn-save" onclick="kaydet()">VERÄ°LERÄ° KAYDET</button>
    <div id="taslak" class="taslak"></div>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + legacy id ========= */
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "bagimsiz-bolum-detay.html");
      window.location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }
  function persist(arr, i, r){
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
  }

  /* ========= FINAL Kilit ========= */
  function isReportLocked(){
    if (!rid) return false;
    return localStorage.getItem("report_locked_" + rid) === "1";
  }
  function setFormDisabled(disabled){
    document.querySelectorAll("input, select, textarea").forEach(el => el.disabled = disabled);
    ["btnSave","btnAddBB","btnRenameBB","btnDelBB"].forEach(id=>{
      const b = document.getElementById(id);
      if (b) b.disabled = disabled;
    });
    const note = document.getElementById("lockNote");
    if (note) note.classList.toggle("hidden", !disabled);
  }

  /* ========= Ã‡oklu BB ========= */
  let activeBBIndex = 0;

  function ensureBBList(report){
    if (!report.bbDetayList || !Array.isArray(report.bbDetayList) || report.bbDetayList.length === 0) {
      report.bbDetayList = [ { bbid:"bb_1", baslik:"1. BB", bbDetay:{} } ];
    }
    report.bbDetayList.forEach((x, idx) => {
      if (!x.bbid) x.bbid = "bb_" + (idx+1);
      if (!x.baslik) x.baslik = `${idx+1}. BB`;
      if (typeof x.bbDetay !== "object" || x.bbDetay === null) x.bbDetay = {};
    });
  }

  function renumberBB(report){
    ensureBBList(report);
    report.bbDetayList.forEach((x, idx)=>{
      if (!x.baslik || /^\d+\. BB$/i.test(String(x.baslik).trim())) x.baslik = `${idx+1}. BB`;
    });
  }

  function getActiveBB(report){
    ensureBBList(report);
    return report.bbDetayList[activeBBIndex] || report.bbDetayList[0];
  }

  function renderBBTabs(){
    const { r, arr, i } = getLatestData();
    if (!r) return;

    ensureBBList(r);
    renumberBB(r);

    const el = document.getElementById("bbTabs");
    el.innerHTML = r.bbDetayList.map((x, idx) => {
      const active = idx === activeBBIndex ? "bbTab active" : "bbTab";
      const label = (x.baslik || ((idx+1)+". BB"));
      return `<button type="button" class="${active}" onclick="setActiveBB(${idx})">${label}</button>`;
    }).join("");

    const delBtn = document.getElementById("btnDelBB");
    if (delBtn) delBtn.disabled = (r.bbDetayList.length <= 1) || isReportLocked();

    persist(arr, i, r);
  }

  // âœ… Sekme deÄŸiÅŸtirirken aktif BB verisini kaybetme: otomatik kaydet (sessiz)
  function saveActiveBBToReport(silent=true){
    const { r, arr, i } = getLatestData();
    if (!r || i < 0) return;
    ensureBBList(r);

    const bb = getActiveBB(r);
    bb.bbDetay = readForm();
    // aktif ekranda gÃ¶rÃ¼nen metni de bbDetay iÃ§ine yaz
    bb.bbDetay.taslakMetin = document.getElementById("taslak")?.innerText || bb.bbDetay.taslakMetin || "";

    persist(arr, i, r);
    if (!silent) alert("Kaydedildi âœ…");
  }

  function setActiveBB(idx){
    if (!isReportLocked()) {
      // sekme deÄŸiÅŸmeden Ã¶nce mevcut sekmeyi kaydet
      saveActiveBBToReport(true);
    }
    activeBBIndex = idx;
    renderBBTabs();
    veriYukle();
  }

  window.addBB = function(){
    if (isReportLocked()) { alert("Bu rapor FINAL. Yeni BB eklenemez."); return; }
    const { r, arr, i } = getLatestData();
    if (!r) return;

    ensureBBList(r);
    // Ã¶nce mevcut sekmeyi kaydet
    saveActiveBBToReport(true);

    const n = r.bbDetayList.length + 1;
    r.bbDetayList.push({ bbid:"bb_" + n, baslik:n + ". BB", bbDetay:{} });

    persist(arr, i, r);
    activeBBIndex = r.bbDetayList.length - 1;
    renderBBTabs();
    veriYukle();
  };

  window.renameBB = function(){
    if (isReportLocked()) { alert("Bu rapor FINAL. Ad deÄŸiÅŸtirilemez."); return; }
    const { r, arr, i } = getLatestData();
    if (!r) return;

    ensureBBList(r);
    const bb = r.bbDetayList[activeBBIndex];
    const cur = (bb.baslik || (activeBBIndex+1)+". BB").toString();
    const name = prompt("BB adÄ±:", cur);
    if (name === null) return;

    const clean = name.toString().trim();
    if (!clean) return;

    bb.baslik = clean;
    persist(arr, i, r);
    renderBBTabs();
  };

  window.deleteBB = function(){
    if (isReportLocked()) { alert("Bu rapor FINAL. BB silinemez."); return; }
    const { r, arr, i } = getLatestData();
    if (!r) return;

    ensureBBList(r);
    if (r.bbDetayList.length <= 1) { alert("En az 1 BB kalmalÄ±."); return; }

    const bb = r.bbDetayList[activeBBIndex];
    const name = (bb?.baslik || (activeBBIndex+1)+". BB");
    if (!confirm(`"${name}" silinsin mi?`)) return;

    r.bbDetayList.splice(activeBBIndex, 1);
    if (activeBBIndex >= r.bbDetayList.length) activeBBIndex = r.bbDetayList.length - 1;

    renumberBB(r);
    persist(arr, i, r);
    renderBBTabs();
    veriYukle();
  };

  /* ========= UI ========= */
  function farkKontrol() {
    const isEvet = document.querySelector('input[name="farkVar"]:checked')?.value === 'evet';
    document.getElementById('farkDetay').classList.toggle('hidden', !isEvet);
  }

  function tesisatKontrol(){
    const isHayir = document.querySelector('input[name="tesisatVar"]:checked')?.value === 'hayir';
    document.getElementById('tesisatDetay').classList.toggle('hidden', !isHayir);
  }

  function hacimPanelKontrol() {
    const sCount = parseInt(document.getElementById('count_salon').value) || 0;
    const oCount = parseInt(document.getElementById('count_oda').value) || 0;
    document.querySelectorAll('.salon-inputs').forEach(el => el.classList.toggle('hidden', sCount === 0));
    document.querySelectorAll('.oda-inputs').forEach(el => el.classList.toggle('hidden', oCount === 0));
  }

  /* ========= FORM MAP ========= */
  const FIELD_IDS = [
    "kat","bbNo","kapiNo","nitelik","alanNet","alanBrut","konum",
    "farkAciklama","ilaveBrut",
    "count_salon","count_oda","count_mutfak","count_banyo","count_wc","count_antre","count_balkon",
    "antreZemin","antreDuvar","salonZemin","salonDuvar","odaZemin","odaDuvar",
    "mutfakZemin","mutfakDuvar","mutfakDolap","mutfakTezgah","islakHacim",
    "banyoDonanim",
    "daireKapi","icKapi","pencere","isitma",
    "tesisatAciklama"
  ];

  function readForm(){
    const obj = {};
    FIELD_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      obj[id] = el.value;
    });

    obj.farkVar = document.querySelector('input[name="farkVar"]:checked')?.value || "hayir";
    obj.cepheler = Array.from(document.querySelectorAll('input[name="cephe"]:checked')).map(x=>x.value);

    obj.tesisatVar = document.querySelector('input[name="tesisatVar"]:checked')?.value || "evet";
    obj.taslakMetin = document.getElementById("taslak")?.innerText || "";

    return obj;
  }

  function writeForm(obj){
    FIELD_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (obj && obj[id] !== undefined && obj[id] !== null) el.value = obj[id];
    });

    const fv = (obj && obj.farkVar) ? obj.farkVar : "hayir";
    const radio = document.querySelector(`input[name="farkVar"][value="${fv}"]`);
    if (radio) radio.checked = true;

    const tv = (obj && obj.tesisatVar) ? obj.tesisatVar : "evet";
    const radioT = document.querySelector(`input[name="tesisatVar"][value="${tv}"]`);
    if (radioT) radioT.checked = true;

    const set = new Set((obj && obj.cepheler) ? obj.cepheler : []);
    document.querySelectorAll('input[name="cephe"]').forEach(cb=> cb.checked = set.has(cb.value));
  }

  /* ========= METÄ°N (SENÄ°N ÅABLON) ========= */
  function buildTextFromData(data){
    data = data || {};
    const v = (k) => (data[k] ?? "").toString().trim();
    const num = (k) => {
      const x = Number(v(k));
      return Number.isFinite(x) ? x : 0;
    };

    const kat = v("kat") || "...";
    const bbNo = v("bbNo") || "...";
    const kapiNo = v("kapiNo") || "...";
    const nitelik = v("nitelik") || "...";
    const konum = v("konum") || "...";

    const cepheler = Array.isArray(data.cepheler) ? data.cepheler : [];
    const cepheText = cepheler.length ? cepheler.join(", ") : "...";

    const net = num("alanNet");
    const brut = num("alanBrut");
    const netParca = net > 0 ? `net ${net} ` : "";
    const brutParca = `brÃ¼t ${brut} mÂ²`;

    const sayi = (k) => parseInt(v(k) || "0", 10) || 0;
    const hacimler = [
      sayi("count_salon")  ? `${sayi("count_salon")} adet salon` : "",
      sayi("count_oda")    ? `${sayi("count_oda")} adet oda` : "",
      sayi("count_mutfak") ? `${sayi("count_mutfak")} adet mutfak` : "",
      sayi("count_banyo")  ? `${sayi("count_banyo")} adet banyo` : "",
      sayi("count_wc")     ? `${sayi("count_wc")} adet wc` : "",
      sayi("count_antre")  ? `${sayi("count_antre")} adet antre/hol` : "",
      sayi("count_balkon") ? `${sayi("count_balkon")} adet balkon` : ""
    ].filter(Boolean).join(", ") || "...";

    const antreZemin = v("antreZemin") || "...";
    const antreDuvar = v("antreDuvar") || "...";
    const salonZemin = v("salonZemin") || "...";
    const salonDuvar = v("salonDuvar") || "...";
    const odaZemin = v("odaZemin") || "...";
    const odaDuvar = v("odaDuvar") || "...";
    const mutfakZemin = v("mutfakZemin") || "...";
    const mutfakDuvar = v("mutfakDuvar") || "...";
    const mutfakDolap = v("mutfakDolap") || "...";
    const mutfakTezgah = v("mutfakTezgah") || "...";
    const islakHacim = v("islakHacim") || "...";
    const banyoDonanim = v("banyoDonanim") || "...";
    const girisKapi = v("daireKapi") || "...";
    const icKapi = v("icKapi") || "...";
    const pencere = v("pencere") || "...";
    const isitma = v("isitma") || "...";

    const tesisatVar = (data.tesisatVar || "evet").toString();
    const tesisatAciklama = v("tesisatAciklama");
    const tesisatMetin = (tesisatVar === "evet")
      ? "mevcuttur"
      : (tesisatAciklama ? tesisatAciklama : "...");

    return `DeÄŸerleme konusu taÅŸÄ±nmaz binanÄ±n ${kat} katÄ±nda yer alan ${bbNo} baÄŸÄ±msÄ±z bÃ¶lÃ¼m ve ${kapiNo} kapÄ± numaralÄ± ${nitelik} nitelikli taÅŸÄ±nmazdÄ±r. Bina giriÅŸine gÃ¶re ${konum} yer almaktadÄ±r. ${cepheText} cephelidir. Projesinde ve yerinde yapÄ±lan tespit ve Ã¶lÃ§Ã¼mlere gÃ¶re ${netParca}${brutParca} kullanÄ±m alanÄ±na sahiptir. TaÅŸÄ±nmaz ${hacimler} hacimlerinden oluÅŸmaktadÄ±r. TaÅŸÄ±nmazÄ±n antre ve hol zeminleri ${antreZemin} duvarlarÄ± ${antreDuvar}. Salon zemini ${salonZemin}, duvarlarÄ± ${salonDuvar} oda zeminleri ${odaZemin} duvarlarÄ± ${odaDuvar}. Mutfak zemini ${mutfakZemin} ve duvarlarÄ± ${mutfakDuvar} malzemedir. Mutfak dolabÄ± ${mutfakDolap} tezgÃ¢hÄ± ${mutfakTezgah} malzemedir. TaÅŸÄ±nmazÄ±n Ä±slak hacimlerin zeminleri ve duvarlarÄ± ${islakHacim}. Banyoda ${banyoDonanim} bulunmaktadÄ±r. TaÅŸÄ±nmazÄ±n giriÅŸ kapÄ±sÄ± ${girisKapi} ve iÃ§ kapÄ±larÄ± ${icKapi}. Pencereleri ise ${pencere} doÄŸramadÄ±r. Elektrik, su ve haberleÅŸme tesisatlarÄ± ${tesisatMetin} durumdaki gayrimenkulÃ¼n Ä±sÄ±tÄ±lmasÄ± ${isitma} ile saÄŸlanmaktadÄ±r.`;
  }

  function metinOlustur() {
    // ekrandaki inputlardan oku
    const data = readForm();
    const metin = buildTextFromData(data);
    const out = document.getElementById("taslak");
    if (out) out.innerText = metin;
  }

  /* ========= LOAD / SAVE ========= */
  function veriYukle(){
    const { r } = getLatestData();
    if (!r) return;

    ensureBBList(r);
    const bb = getActiveBB(r);

    writeForm(bb.bbDetay || {});
    farkKontrol();
    hacimPanelKontrol();
    tesisatKontrol();
    metinOlustur();
  }

  async function kaydet(){
  if (isReportLocked()) { alert("Bu rapor FINAL. Kaydedilemez."); return; }

  const { r, arr, i } = getLatestData();
  if (!r || i < 0) { alert("Rapor bulunamadÄ±."); return; }

  ensureBBList(r);

  // 1) aktif BB'yi kaydet
  const active = getActiveBB(r);
  active.bbDetay = readForm();

  const activeText = buildTextFromData(active.bbDetay);
  active.bbDetay.taslakMetin = activeText;
  active.bbDetay.metin = activeText;      // âœ… rapor-oluÅŸtur bunu okuyor
  active.bbDetay.tamMetin = activeText;   // âœ… rapor-oluÅŸtur bunu okuyor

  // 2) tÃ¼m BB'lerin metnini Ã¼ret
  r.bbDetayList.forEach(bb=>{
    bb.bbDetay = bb.bbDetay || {};

    const t = buildTextFromData(bb.bbDetay);
    bb.bbDetay.taslakMetin = t;
    bb.bbDetay.metin = t;      // âœ…
    bb.bbDetay.tamMetin = t;   // âœ…
  });

  // 3) modÃ¼l Ã¶zetini de doldur (rapor-oluÅŸtur iÃ§in garanti)
  r.modules = r.modules || {};
  const allText = r.bbDetayList.map((bb, idx)=>{
    const title = bb?.baslik || `${idx+1}. BB`;
    const t = (bb?.bbDetay?.metin || bb?.bbDetay?.tamMetin || bb?.bbDetay?.taslakMetin || "").trim();
    return `=== ${title} ===\n${t}`;
  }).join("\n\n");

  r.modules.bagimsizBolum = { text: allText, updatedAt: Date.now() };

  persist(arr, i, r);
  alert("Kaydedildi âœ… (TÃ¼m BB metinleri hazÄ±rlandÄ±)");
}


    // 1) Ã–nce aktif BBâ€™yi kaydet
    const active = getActiveBB(r);
    active.bbDetay = readForm();
    // aktif metni kesin yaz
    active.bbDetay.taslakMetin = buildTextFromData(active.bbDetay);

    // 2) Sonra tÃ¼m BBâ€™lerin metnini otomatik Ã¼ret (sekmeye girilmemiÅŸ olsa bile)
    r.bbDetayList.forEach(bb=>{
      bb.bbDetay = bb.bbDetay || {};
      // bbDetay iÃ§inde metin yoksa bile, verilerden Ã¼ret
      bb.bbDetay.taslakMetin = buildTextFromData(bb.bbDetay);
    });

    // 3) Rapor oluÅŸturun tek yerden okumasÄ± iÃ§in birleÅŸtir
    r.modules = r.modules || {};
    const allText = r.bbDetayList.map((bb, idx)=>{
      const title = bb?.baslik || `${idx+1}. BB`;
      const t = (bb?.bbDetay?.taslakMetin || "").trim();
      return `=== ${title} ===\n${t}`;
    }).join("\n\n");

    r.modules.bagimsizBolum = { text: allText, updatedAt: Date.now() };

    persist(arr, i, r);

    alert("Kaydedildi âœ… (TÃ¼m BB metinleri hazÄ±rlandÄ±)");
  }

  function anaMenuyeDon(){
    const file = "rapor-detay.html";
    window.location.href = file + (rid ? ("?rid=" + encodeURIComponent(rid)) : "");
  }

  /* ========= BaÅŸlangÄ±Ã§ ========= */
  window.addEventListener("load", () => {
    const { r } = getLatestData();

    if (!r){
      document.getElementById("raporBilgi").innerText = "Rapor bulunamadÄ±.";
      setFormDisabled(true);
      return;
    }

    document.getElementById("raporBilgi").innerText =
      (r.raporAdi || r.baslik || r.tasinmazAdi || "Rapor") + (rid ? ` â€¢ ${rid}` : "");

    ensureBBList(r);
    renderBBTabs();
    veriYukle();
    setFormDisabled(isReportLocked());
  });

  // global (onclick)
  window.metinOlustur = metinOlustur;
  window.kaydet = kaydet;
  window.anaMenuyeDon = anaMenuyeDon;
  window.farkKontrol = farkKontrol;
  window.hacimPanelKontrol = hacimPanelKontrol;
  window.tesisatKontrol = tesisatKontrol;
  window.setActiveBB = setActiveBB;
</script>

<script src="mobil-fix.js"></script>
</body>
</html>



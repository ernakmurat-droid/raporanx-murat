<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m Detay</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary:#4a148c; --secondary:#7c4dff; --success:#00c853; --bg:#f0f2f5; }
    body{ font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:var(--bg); margin:0; padding-bottom:110px; color:#333; }

    .header{
      background:linear-gradient(135deg,#4a148c,#7c4dff);
      color:#fff;
      padding: calc(22px + env(safe-area-inset-top, 0px)) 25px 22px;
      text-align:center;
      position:sticky; top:0; z-index:1000;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
    }
    .back{
      position:absolute; left:15px; top: calc(16px + env(safe-area-inset-top, 0px));
      background:rgba(255,255,255,.2);
      padding:8px 15px; border-radius:20px;
      color:#fff; font-weight:bold; font-size:14px;
      cursor:pointer; border:none;
    }

    .container{
      max-width:900px; margin:16px auto; padding:16px;
      background:#fff; border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }

    .section-title{
      border-bottom:2px solid #eee;
      margin:18px 0 12px; padding-bottom:10px;
      color:#4a148c; font-size:1.1em; font-weight:900;
    }

    .form-group{
      margin-bottom:14px; padding:14px;
      background:#fdfdfd; border:1px solid #f0f0f0;
      border-radius:12px;
    }

    .input-item{ margin-bottom:12px; }
    .input-item label{ display:block; font-weight:700; margin-bottom:6px; font-size:13px; color:#555; }

    input,select,textarea{
      padding:12px; width:100%;
      border:1.5px solid #dee2e6;
      border-radius:10px; font-size:15px;
      box-sizing:border-box; outline:none;
      transition:.2s;
    }
    input:focus, textarea:focus{ border-color:#7c4dff; background:#f9f7ff; }

    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:720px){ .grid-3,.grid-2{ grid-template-columns:1fr; } }

    .hacim-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(120px, 1fr)); gap:10px; margin-bottom:6px; }
    .hacim-card{ background:#fff; border:1px solid #eee; padding:10px; border-radius:10px; text-align:center; }

    .checkbox-group{ display:flex; flex-wrap:wrap; gap:8px; }
    .checkbox-group label{ background:#f0f0f0; padding:8px 14px; border-radius:999px; cursor:pointer; font-size:13px; user-select:none; }
    .checkbox-group input{ display:none; }
    .checkbox-group input:checked + span{
      background:#4a148c; color:#fff;
      border-radius:999px; padding:8px 14px;
      margin:-8px -14px; display:inline-block;
    }

    .btn{ padding:14px; border:none; border-radius:12px; font-size:16px; font-weight:900; cursor:pointer; width:100%; margin-top:10px; }
    .btn-save{ background:#00c853; color:#fff; }
    .btn-save[disabled]{ opacity:.55; cursor:not-allowed; }

    .bbbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:12px; border:1px solid #e0e6ed; border-radius:14px; background:#fff; margin-bottom:12px; }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .bbTab{ padding:10px 12px; border-radius:12px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:900; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }
    .hint{ font-size:12px; color:#666; margin-top:6px; width:100%; line-height:1.35; }

    .bbActions{ margin-left:auto; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .bbMiniBtn{
      padding:10px 12px; border-radius:12px;
      border:1px solid rgba(74,20,140,.25);
      background:#f6f0ff; color:#4a148c;
      font-weight:900; cursor:pointer;
    }
    .bbMiniBtn.danger{ background:#ffe9e9; border-color:rgba(198,40,40,.25); color:#c62828; }
    .bbMiniBtn[disabled]{ opacity:.55; cursor:not-allowed; }

    .taslak{
      background:#fff8e1; padding:16px;
      border-radius:14px; margin-top:16px;
      border:2px dashed #ffb300;
      font-size:15px; line-height:1.75;
      white-space:pre-wrap; color:#333;
      user-select:none;
      transition:filter .2s ease;
      min-height:120px;
    }
    .taslak:not(:hover){ filter:blur(1.5px); }

    .lockedNote{
      background:#ffe9e9;
      border-left:6px solid #c62828;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:12px;
      font-weight:900;
      color:#7a1b1b;
    }

    .infoNote{
      background:#eef5ff;
      border-left:6px solid #1e88e5;
      padding:12px 14px;
      border-radius:12px;
      margin:12px 0;
      font-weight:800;
      color:#0d47a1;
      line-height:1.45;
    }

    .hidden{ display:none !important; }

    .toplu-liste-konteyner {
      margin-top: 30px;
      padding: 20px;
      background: #fafafa;
      border: 2px solid #4a148c;
      border-radius: 16px;
    }
    .toplu-bb-kart {
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      border-left: 5px solid #7c4dff;
      /* === MOBÄ°L SABÄ°T GERÄ° DÃ–N === */
.mobile-back-fixed{
  display:none;
}

@media (max-width: 768px){
  .mobile-back-fixed{
    display:flex;
    position:fixed;
    bottom: env(safe-area-inset-bottom, 10px);
    left:10px;
    right:10px;
    z-index:2000;
  }

  .mobile-back-fixed button{
    width:100%;
    background:#d32f2f;
    color:white;
    border:none;
    padding:14px;
    border-radius:16px;
    font-weight:900;
    font-size:16px;
    box-shadow:0 6px 20px rgba(211,47,47,.45);
  }

  /* iÃ§erik alta yapÄ±ÅŸmasÄ±n */
  body{
    padding-bottom:160px;
  }
}
#taslak,
#taslakBaslik{
  display:none;
}
/* === TASLAK METNÄ° HER YERDE GÄ°ZLE === */
#taslak,
#taslakBaslik{
  display:none !important;
}

    }
  </style>

  <link rel="stylesheet" href="mobil-fix.css">
</head>

<body>
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼</button>
    <h1 style="margin:0;">BAÄIMSIZ BÃ–LÃœM DETAY</h1>
    <div id="raporBilgi" style="margin-top:6px; font-weight:800; opacity:.95;">YÃ¼kleniyor...</div>
  </div>

  <div class="container">
    <div id="lockNote" class="lockedNote hidden">
      ğŸ”’ Bu rapor FINAL yapÄ±lmÄ±ÅŸ. Bu modÃ¼l kilitlidir (dÃ¼zenleme yapÄ±lamaz).
    </div>

    <div class="infoNote">
      âœ… Burada <b>seÃ§ili BB</b>â€™nin metnini gÃ¶rÃ¼rsÃ¼n. <br>
      ğŸ§¾ SayfanÄ±n en altÄ±nda ise <b>eklediÄŸin tÃ¼m bÃ¶lÃ¼mlerin</b> metinlerini toplu gÃ¶rebilirsin.
    </div>

    <div class="bbbar">
      <div style="font-weight:900; color:var(--primary);">BaÄŸÄ±msÄ±z BÃ¶lÃ¼m:</div>
      <div class="bbTabs" id="bbTabs"></div>

      <div class="bbActions">
        <button type="button" id="btnAddBB" class="bbMiniBtn" onclick="addBB()">+ Yeni BB</button>
        <button type="button" id="btnRenameBB" class="bbMiniBtn" onclick="renameBB()">âœï¸ Ad</button>
        <button type="button" id="btnDelBB" class="bbMiniBtn danger" onclick="deleteBB()">ğŸ—‘ï¸ Sil</button>
      </div>

      <div class="hint">Sekme deÄŸiÅŸtirince Ã¶nceki BB otomatik kaydedilir.</div>
    </div>

    <div class="section-title">1) Kimlik ve Alan Bilgileri</div>
    <div class="form-group">
      <div class="grid-3">
        <div class="input-item"><label>Kat</label><input type="text" id="kat" oninput="metinOlustur()"></div>
        <div class="input-item"><label>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m No</label><input type="text" id="bbNo" oninput="metinOlustur()"></div>
        <div class="input-item"><label>KapÄ± No</label><input type="text" id="kapiNo" oninput="metinOlustur()"></div>
      </div>

      <div class="grid-2">
        <div class="input-item"><label>Nitelik</label><input type="text" id="nitelik" placeholder="mesken" oninput="metinOlustur()"></div>
        <div class="input-item"><label>GiriÅŸe GÃ¶re Konumu</label><input type="text" id="konum" placeholder="saÄŸ tarafta" oninput="metinOlustur()"></div>
      </div>

      <div class="grid-2">
        <div class="input-item"><label>Net Alan (mÂ²)</label><input type="number" id="alanNet" value="0" oninput="metinOlustur()"></div>
        <div class="input-item"><label>BrÃ¼t Alan (mÂ²)</label><input type="number" id="alanBrut" value="0" oninput="metinOlustur()"></div>
      </div>

      <div class="input-item">
        <label>Cepheler</label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="cephe" value="Kuzey" onchange="metinOlustur()"><span>Kuzey</span></label>
          <label><input type="checkbox" name="cephe" value="GÃ¼ney" onchange="metinOlustur()"><span>GÃ¼ney</span></label>
          <label><input type="checkbox" name="cephe" value="DoÄŸu" onchange="metinOlustur()"><span>DoÄŸu</span></label>
          <label><input type="checkbox" name="cephe" value="BatÄ±" onchange="metinOlustur()"><span>BatÄ±</span></label>
          <label><input type="checkbox" name="cephe" value="Kuzey-DoÄŸu" onchange="metinOlustur()"><span>Kuzey-DoÄŸu</span></label>
          <label><input type="checkbox" name="cephe" value="Kuzey-BatÄ±" onchange="metinOlustur()"><span>Kuzey-BatÄ±</span></label>
          <label><input type="checkbox" name="cephe" value="GÃ¼ney-DoÄŸu" onchange="metinOlustur()"><span>GÃ¼ney-DoÄŸu</span></label>
          <label><input type="checkbox" name="cephe" value="GÃ¼ney-BatÄ±" onchange="metinOlustur()"><span>GÃ¼ney-BatÄ±</span></label>
        </div>
      </div>
    </div>

    <div class="section-title">2) Proje FarkÄ± (Ä°stersen)</div>
    <div class="form-group">
      <label style="font-weight:900;">Projeye gÃ¶re deÄŸiÅŸiklik var mÄ±?</label>
      <div style="display:flex; gap:18px; margin:10px 0; flex-wrap:wrap;">
        <label style="cursor:pointer;"><input type="radio" name="farkVar" value="hayir" checked onchange="farkKontrol(); metinOlustur();"> HayÄ±r</label>
        <label style="cursor:pointer;"><input type="radio" name="farkVar" value="evet" onchange="farkKontrol(); metinOlustur();"> Evet</label>
      </div>

      <div id="farkDetay" class="hidden">
        <div class="input-item"><label>Ä°lave AÃ§Ä±klamasÄ±</label><textarea id="farkAciklama" oninput="metinOlustur()"></textarea></div>
        <div class="input-item"><label>Ä°lave BrÃ¼t Alan (mÂ²)</label><input type="number" id="ilaveBrut" value="0" oninput="metinOlustur()"></div>
      </div>
    </div>

    <div class="section-title">3) Hacimler</div>
    <div class="form-group">
      <div class="hacim-grid">
        <div class="hacim-card"><label>Salon</label><input type="number" id="count_salon" value="1" oninput="hacimPanelKontrol(); metinOlustur();"></div>
        <div class="hacim-card"><label>Oda</label><input type="number" id="count_oda" value="3" oninput="hacimPanelKontrol(); metinOlustur();"></div>
        <div class="hacim-card"><label>Mutfak</label><input type="number" id="count_mutfak" value="1" oninput="metinOlustur()"></div>
        <div class="hacim-card"><label>Banyo</label><input type="number" id="count_banyo" value="1" oninput="metinOlustur()"></div>
        <div class="hacim-card"><label>WC</label><input type="number" id="count_wc" value="1" oninput="metinOlustur()"></div>
        <div class="hacim-card"><label>Antre/Hol</label><input type="number" id="count_antre" value="1" oninput="metinOlustur()"></div>
        <div class="hacim-card"><label>Balkon</label><input type="number" id="count_balkon" value="1" oninput="metinOlustur()"></div>
      </div>
    </div>

    <div class="section-title">4) Ä°Ã§ Ã–zellikler</div>
    <div class="form-group">
      <div class="grid-2">
        <div class="input-item"><label>Antre Zemin</label><input type="text" id="antreZemin" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Antre Duvar</label><input type="text" id="antreDuvar" oninput="metinOlustur()"></div>

        <div class="input-item salon-inputs"><label>Salon Zemin</label><input type="text" id="salonZemin" oninput="metinOlustur()"></div>
        <div class="input-item salon-inputs"><label>Salon Duvar</label><input type="text" id="salonDuvar" oninput="metinOlustur()"></div>

        <div class="input-item oda-inputs"><label>Oda Zemin</label><input type="text" id="odaZemin" oninput="metinOlustur()"></div>
        <div class="input-item oda-inputs"><label>Oda Duvar</label><input type="text" id="odaDuvar" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Mutfak Zemin</label><input type="text" id="mutfakZemin" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Mutfak Duvar</label><input type="text" id="mutfakDuvar" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Mutfak DolabÄ±</label><input type="text" id="mutfakDolap" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Mutfak TezgahÄ±</label><input type="text" id="mutfakTezgah" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Islak Hacim (zimen/duvar)</label><input type="text" id="islakHacim" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Banyoda Bulunan DonanÄ±mlar</label><input type="text" id="banyoDonanim" placeholder="klozet, lavabo, banyo dolabÄ±..." oninput="metinOlustur()"></div>

        <div class="input-item"><label>GiriÅŸ KapÄ±sÄ±</label><input type="text" id="daireKapi" oninput="metinOlustur()"></div>
        <div class="input-item"><label>Ä°Ã§ KapÄ±lar</label><input type="text" id="icKapi" oninput="metinOlustur()"></div>

        <div class="input-item"><label>Pencereler</label><input type="text" id="pencere" oninput="metinOlustur()"></div>
        <div class="input-item"><label>IsÄ±tma</label><input type="text" id="isitma" oninput="metinOlustur()"></div>
      </div>
    </div>

    <div class="section-title">5) Tesisatlar (Elektrik / Su / HaberleÅŸme)</div>
    <div class="form-group">
      <label style="font-weight:900;">Tesisatlar mevcut mu?</label>
      <div style="display:flex; gap:18px; margin:10px 0; flex-wrap:wrap;">
        <label style="cursor:pointer;"><input type="radio" name="tesisatVar" value="evet" checked onchange="tesisatKontrol(); metinOlustur();"> Evet (mevcuttur)</label>
        <label style="cursor:pointer;"><input type="radio" name="tesisatVar" value="hayir" onchange="tesisatKontrol(); metinOlustur();"> HayÄ±r (aÃ§Ä±klama)</label>
      </div>

      <div id="tesisatDetay" class="hidden">
        <div class="input-item">
          <label>AÃ§Ä±klama (metne â€œmevcutturâ€ yerine yazÄ±lÄ±r)</label>
          <textarea id="tesisatAciklama" placeholder="Ã–rn: Elektrik mevcut, su yoktur..." oninput="metinOlustur()"></textarea>
        </div>
      </div>
    </div>

    <button id="btnSave" class="btn btn-save" onclick="kaydet()">VERÄ°LERÄ° KAYDET (TÃœM BB METÄ°NLERÄ° ÃœRETÄ°LÄ°R)</button>

    <div class="section-title">SeÃ§ili BB Taslak Metin</div>
    <div id="taslak" class="taslak"></div>

    <div class="section-title" style="margin-top:40px; border-color: #ff9800; color: #e65100;">
      ğŸ“‹ TÃ¼m BaÄŸÄ±msÄ±z BÃ¶lÃ¼mlerin Metin Ã–zeti
    </div>
    <div id="topluMetinAlani" class="toplu-liste-konteyner"></div>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id'); // eski link destek

  // SABÄ°TLER VE LÄ°STELER
  const FIELD_IDS = [
    "kat","bbNo","kapiNo","nitelik","alanNet","alanBrut","konum",
    "farkAciklama","ilaveBrut",
    "count_salon","count_oda","count_mutfak","count_banyo","count_wc","count_antre","count_balkon",
    "antreZemin","antreDuvar","salonZemin","salonDuvar","odaZemin","odaDuvar",
    "mutfakZemin","mutfakDuvar","mutfakDolap","mutfakTezgah","islakHacim",
    "banyoDonanim",
    "daireKapi","icKapi","pencere","isitma",
    "tesisatAciklama"
  ];

  // HATIRLATICI (DATALIST) SÄ°STEMÄ°
  function hatirlaVeEkle(id, deger) {
    if (!deger || deger.length < 2) return;
    let hafiza = JSON.parse(localStorage.getItem("h_cache_" + id) || "[]");
    if (!hafiza.includes(deger)) {
      hafiza.push(deger);
      if (hafiza.length > 20) hafiza.shift();
      localStorage.setItem("h_cache_" + id, JSON.stringify(hafiza));
    }
    hatirlaticiListesiniGuncelle(id);
  }

  function hatirlaticiListesiniGuncelle(id) {
    const hafiza = JSON.parse(localStorage.getItem("h_cache_" + id) || "[]");
    let dl = document.getElementById("list_" + id);
    if (!dl) {
      dl = document.createElement("datalist");
      dl.id = "list_" + id;
      document.body.appendChild(dl);
    }
    dl.innerHTML = hafiza.map(h => `<option value="${h}">`).join("");
    const input = document.getElementById(id);
    if (input) input.setAttribute("list", "list_" + id);
  }

  function tumHatirlaticilariYukle() {
    FIELD_IDS.forEach(id => {
      const el = document.getElementById(id);
      if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA") && el.type !== "number") {
        hatirlaticiListesiniGuncelle(id);
      }
    });
  }

  // ====== RAPOR VERÄ° YÃ–NETÄ°MÄ° (FIXED) ======
  const STORAGE_KEY = 'gayrimenkul_reports';

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }

  function toArrayIfObject(data){
    if (Array.isArray(data)) return data;
    if (data && typeof data === "object") return Object.values(data);
    return [];
  }

  function resolveRidAndMigrateIfNeeded(arr){
    // 1) rid varsa
    if (rid) {
      const idx = arr.findIndex(x => x && x.rid === rid);
      if (idx >= 0) return { arr, i: idx, r: arr[idx] };
    }

    // 2) rid yoksa legacyId ile bul
    if (legacyId) {
      const idx2 = arr.findIndex(x => x && (String(x.id) === String(legacyId) || String(x.legacyId) === String(legacyId)));
      if (idx2 >= 0) {
        if (!arr[idx2].rid) arr[idx2].rid = genRid();
        rid = arr[idx2].rid;
        history.replaceState(null, "", `${location.pathname}?rid=${encodeURIComponent(rid)}`);
        return { arr, i: idx2, r: arr[idx2] };
      }
    }

    return { arr, i: -1, r: null };
  }

  function getLatestData(){
    const raw = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
    const arr = toArrayIfObject(raw);
    return resolveRidAndMigrateIfNeeded(arr);
  }

  function persist(arr, i, r){
    if (!r) return;

    if (i >= 0) {
      arr[i] = r;
    } else {
      // rapor bulundu ama index yoksa (rid boÅŸ/yanlÄ±ÅŸ) -> yeni gibi push
      if (!r.rid) r.rid = rid || genRid();
      rid = r.rid;
      arr.push(r);
      history.replaceState(null, "", `${location.pathname}?rid=${encodeURIComponent(rid)}`);
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }
  // =========================================

  let activeBBIndex = 0;

  function ensureBBList(report){
    if (!report.bbDetayList || !Array.isArray(report.bbDetayList) || report.bbDetayList.length === 0) {
      report.bbDetayList = [ { bbid:"bb_1", baslik:"1. BB", bbDetay:{} } ];
    }
  }

  function isReportLocked(){
    return rid ? localStorage.getItem("report_locked_" + rid) === "1" : false;
  }

  // FORM Ä°ÅLEMLERÄ°
  function readForm(){
    const obj = {};
    FIELD_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (el) obj[id] = el.value;
    });
    obj.farkVar = document.querySelector('input[name="farkVar"]:checked')?.value || "hayir";
    obj.cepheler = Array.from(document.querySelectorAll('input[name="cephe"]:checked')).map(cb => cb.value);
    obj.tesisatVar = document.querySelector('input[name="tesisatVar"]:checked')?.value || "evet";
    return obj;
  }

  function writeForm(obj){
    FIELD_IDS.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (obj && obj[id] !== undefined) el.value = obj[id];
      else el.value = (id.includes("count") ? "0" : "");
    });
    const fv = (obj && obj.farkVar) ? obj.farkVar : "hayir";
    const radioF = document.querySelector(`input[name="farkVar"][value="${fv}"]`);
    if (radioF) radioF.checked = true;

    const tv = (obj && obj.tesisatVar) ? obj.tesisatVar : "evet";
    const radioT = document.querySelector(`input[name="tesisatVar"][value="${tv}"]`);
    if (radioT) radioT.checked = true;

    const set = new Set((obj && obj.cepheler) ? obj.cepheler : []);
    document.querySelectorAll('input[name="cephe"]').forEach(cb=> cb.checked = set.has(cb.value));
  }

  // METÄ°N OLUÅTURMA
  function buildTextFromData(data) {
    const get = (key, def = "...") => (data[key] && data[key] !== "") ? data[key] : def;
    const getNum = (key) => parseInt(data[key] || "0", 10);

    const cepheler = (data.cepheler && data.cepheler.length > 0) ? data.cepheler.join(", ") : "...";

    const roomCounts = [
      { n: "salon", v: getNum("count_salon") },
      { n: "oda", v: getNum("count_oda") },
      { n: "mutfak", v: getNum("count_mutfak") },
      { n: "banyo", v: getNum("count_banyo") },
      { n: "wc", v: getNum("count_wc") },
      { n: "antre/hol", v: getNum("count_antre") },
      { n: "balkon", v: getNum("count_balkon") }
    ].filter(x => x.v > 0)
     .map(x => `${x.v} adet ${x.n}`)
     .join(", ") || "...";

    const alanText = getNum("alanNet") > 0
      ? `net ${getNum("alanNet")} brÃ¼t ${getNum("alanBrut")} mÂ²`
      : `brÃ¼t ${getNum("alanBrut")} mÂ²`;

    const tesisat = get("tesisatVar") === "evet" ? "mevcuttur" : (get("tesisatAciklama") || "...");

    return `DeÄŸerleme konusu taÅŸÄ±nmaz binanÄ±n ${get("kat")} katÄ±nda yer alan ${get("bbNo")} baÄŸÄ±msÄ±z bÃ¶lÃ¼m ve ${get("kapiNo")} kapÄ± numaralÄ± ${get("nitelik")} nitelikli taÅŸÄ±nmazdÄ±r. Bina giriÅŸine gÃ¶re ${get("konum")} yer almaktadÄ±r. ${cepheler} cephelidir. Projesinde ve yerinde yapÄ±lan tespit ve Ã¶lÃ§Ã¼mlere gÃ¶re ${alanText} kullanÄ±m alanÄ±na sahiptir. TaÅŸÄ±nmaz ${roomCounts} hacimlerinden oluÅŸmaktadÄ±r. TaÅŸÄ±nmazÄ±n antre ve hol zeminleri ${get("antreZemin")} duvarlarÄ± ${get("antreDuvar")}. Salon zemini ${get("salonZemin")}, duvarlarÄ± ${get("salonDuvar")} oda zeminleri ${get("odaZemin")} duvarlarÄ± ${get("odaDuvar")}. Mutfak zemini ${get("mutfakZemin")} ve duvarlarÄ± ${get("mutfakDuvar")} malzemedir. Mutfak dolabÄ± ${get("mutfakDolap")} tezgÃ¢hÄ± ${get("mutfakTezgah")} malzemedir. TaÅŸÄ±nmazÄ±n Ä±slak hacimlerin zeminleri ve duvarlarÄ± ${get("islakHacim")}. Banyoda ${get("banyoDonanim")} bulunmaktadÄ±r. TaÅŸÄ±nmazÄ±n giriÅŸ kapÄ±sÄ± ${get("daireKapi")} ve iÃ§ kapÄ±larÄ± ${get("icKapi")}. Pencereleri ise ${get("pencere")} doÄŸramadÄ±r. Elektrik, su ve haberleÅŸme tesisatlarÄ± ${tesisat} durumdaki gayrimenkulÃ¼n Ä±sÄ±tÄ±lmasÄ± ${get("isitma")} ile saÄŸlanmaktadÄ±r.`;
  }

  function metinOlustur() {
    const data = readForm();
    const metin = buildTextFromData(data);
    document.getElementById("taslak").innerText = metin;
    topluListeyiGuncelle();
  }

  function topluListeyiGuncelle() {
    const { r } = getLatestData();
    if (!r) return;
    let html = "";
    r.bbDetayList.forEach((bb, idx) => {
      const data = (idx === activeBBIndex) ? readForm() : (bb.bbDetay || {});
      html += `<div class="toplu-bb-kart"><b>ğŸ“ ${bb.baslik}</b><br>${buildTextFromData(data)}</div>`;
    });
    document.getElementById("topluMetinAlani").innerHTML = html;
  }

  // KAYIT VE GEÃ‡Ä°Å SÄ°STEMÄ°
  function saveActiveBBToReport(){
    const { r, arr, i } = getLatestData();
    if (!r) return;

    const bb = r.bbDetayList[activeBBIndex];
    if(!bb) return;

    const data = readForm();
    bb.bbDetay = data;
    // âœ… BRÃœT/NET ALAN KÃ–PRÃœSÃœ (emsal modÃ¼lÃ¼ kaÃ§ farklÄ± isimle arasa da bulsun)
bb.bbDetay.alanBrut = String(bb.bbDetay.alanBrut || "");
bb.bbDetay.alanNet  = String(bb.bbDetay.alanNet  || "");

// bazÄ± modÃ¼ller alan_brut / alan_brÃ¼t gibi arayabiliyor:
bb.bbDetay.alan_brut = bb.bbDetay.alanBrut;
bb.bbDetay.alan_net  = bb.bbDetay.alanNet;

// rapor seviyesinde de tut (bazÄ± yerler buradan okuyor)
r.tasinmazBrut = bb.bbDetay.alanBrut;
r.tasinmazNet  = bb.bbDetay.alanNet;

    bb.taslakMetin = buildTextFromData(data);

    FIELD_IDS.forEach(id => {
      const el = document.getElementById(id);
      if(el && el.value && el.type !== "number") hatirlaVeEkle(id, el.value);
    });

    persist(arr, i, r);
  }

  function setActiveBB(idx){
    if (!isReportLocked()) saveActiveBBToReport();
    activeBBIndex = idx;
    renderBBTabs();
    const { r } = getLatestData();
    writeForm(r.bbDetayList[idx].bbDetay);
    farkKontrol();
    tesisatKontrol();
    hacimPanelKontrol();
    metinOlustur();
  }

  function renderBBTabs(){
    const { r } = getLatestData();
    if (!r) return;
    document.getElementById("bbTabs").innerHTML = r.bbDetayList.map((x, idx) =>
      `<button class="bbTab ${idx === activeBBIndex ? 'active' : ''}" onclick="setActiveBB(${idx})">${x.baslik}</button>`
    ).join("");
  }

  function addBB(){
    if (isReportLocked()) return;
    saveActiveBBToReport();
    const { r, arr, i } = getLatestData();
    const nextNo = r.bbDetayList.length + 1;
    r.bbDetayList.push({ bbid: "bb_"+Date.now(), baslik: nextNo + ". BB", bbDetay: {} });
    activeBBIndex = r.bbDetayList.length - 1;
    persist(arr, i, r);
    setActiveBB(activeBBIndex);
  }

  function renameBB(){
    if (isReportLocked()) return;
    const { r, arr, i } = getLatestData();
    if(!r) return;
    const bb = r.bbDetayList[activeBBIndex];
    const yeni = prompt("BB AdÄ±:", bb.baslik || "");
    if(!yeni) return;
    bb.baslik = yeni;
    persist(arr, i, r);
    renderBBTabs();
    topluListeyiGuncelle();
  }

  function deleteBB(){
    if (isReportLocked()) return;
    const { r, arr, i } = getLatestData();
    if(!r) return;
    if (r.bbDetayList.length <= 1) { alert("En az 1 BB kalmalÄ±."); return; }
    if(!confirm("Bu BB silinsin mi?")) return;

    r.bbDetayList.splice(activeBBIndex, 1);
    activeBBIndex = Math.max(0, activeBBIndex - 1);
    persist(arr, i, r);
    renderBBTabs();
    writeForm(r.bbDetayList[activeBBIndex].bbDetay);
    metinOlustur();
  }

  function kaydet() {
    if (isReportLocked()) return;
    saveActiveBBToReport();
    const { r, arr, i } = getLatestData();
    if(!r) return;

    let topluMetin = "";
    r.bbDetayList.forEach(bb => {
      const m = buildTextFromData(bb.bbDetay || {});
      bb.taslakMetin = m;
      topluMetin += `ğŸ“ ${bb.baslik}\n${m}\n\n`;
    });

    if(!r.modules) r.modules = {};
    r.modules.bagimsizBolum = { text: topluMetin };

    persist(arr, i, r);
    alert("Kaydedildi âœ… TÃ¼m veriler ve hatÄ±rlatÄ±cÄ±lar gÃ¼ncellendi.");
  }

  // KONTROLLER
  function farkKontrol() {
    const isEvet = document.querySelector('input[name="farkVar"]:checked')?.value === 'evet';
    document.getElementById('farkDetay').classList.toggle('hidden', !isEvet);
  }
  function tesisatKontrol(){
    const isHayir = document.querySelector('input[name="tesisatVar"]:checked')?.value === 'hayir';
    document.getElementById('tesisatDetay').classList.toggle('hidden', !isHayir);
  }
  function hacimPanelKontrol() {
    document.querySelectorAll('.salon-inputs').forEach(el => el.classList.toggle('hidden', parseInt(document.getElementById('count_salon').value) === 0));
    document.querySelectorAll('.oda-inputs').forEach(el => el.classList.toggle('hidden', parseInt(document.getElementById('count_oda').value) === 0));
  }

  function fillHeaderInfo(){
    const { r } = getLatestData();
    if (r) document.getElementById("raporBilgi").innerText = (r.baslik || r.raporAdi || "B. BÃ¶lÃ¼m Detay") + " â€¢ " + (r.tarih || "");
  }

  function setFormDisabled(disabled){
    document.querySelectorAll("input, select, textarea, button:not(.back)").forEach(el => el.disabled = disabled);
    if(document.getElementById("lockNote")) document.getElementById("lockNote").classList.toggle("hidden", !disabled);
  }

  function init(){
    const { r, arr, i } = getLatestData();
    if (!r) { alert("Rapor bulunamadÄ±! (rid/id eÅŸleÅŸmedi)"); return; }

    ensureBBList(r);
    // âœ… Ã§ok Ã¶nemli: bbDetayList yoksa oluÅŸturduk, hemen kaydet
    persist(arr, i, r);

    renderBBTabs();
    writeForm(r.bbDetayList[activeBBIndex].bbDetay || {});
    fillHeaderInfo();
    tumHatirlaticilariYukle();
    setFormDisabled(isReportLocked());
    farkKontrol();
    tesisatKontrol();
    hacimPanelKontrol();
    metinOlustur();
  }

  function anaMenuyeDon(){
    history.back();
    // Ä°stersen daha saÄŸlam:
    // window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid||"")}`;
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
<div class="mobile-back-fixed">
  <button onclick="anaMenuyeDon()">â† ANA MENÃœYE DÃ–N</button>
</div>

</body>
</html>



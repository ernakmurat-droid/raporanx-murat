<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BaÄŸÄ±msÄ±z BÃ¶lÃ¼m Detay</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary: #4a148c; --secondary: #7c4dff; --success: #00c853; --bg: #f0f2f5; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin:0; padding-bottom:110px; color: #333; }
    .header { background: linear-gradient(135deg,#4a148c,#7c4dff); color:white; padding:25px; text-align:center; position:sticky; top:0; z-index:1000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    .back { position:absolute; left:15px; top:22px; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:20px; color:white; text-decoration:none; font-weight:bold; font-size: 14px; cursor: pointer; border: none; }

    .container { max-width:850px; margin:20px auto; padding:20px; background:white; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.08); }
    .section-title { border-bottom: 2px solid #eee; margin-bottom: 20px; padding-bottom: 10px; color: #4a148c; font-size: 1.2em; font-weight: bold; }
    .form-group { margin-bottom: 20px; padding: 15px; background: #fdfdfd; border: 1px solid #f0f0f0; border-radius: 10px; }
    .input-item { margin-bottom: 15px; }
    .input-item label { display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px; color: #555; }
    input, select, textarea { padding:12px; width:100%; border:1.5px solid #dee2e6; border-radius:8px; font-size:15px; box-sizing:border-box; outline: none; transition: 0.3s; }
    input:focus, textarea:focus { border-color: #7c4dff; background: #f9f7ff; }

    .hacim-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-bottom: 15px; }
    .hacim-card { background: #fff; border: 1px solid #eee; padding: 10px; border-radius: 8px; text-align: center; }

    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .checkbox-group label { background: #f0f0f0; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; }
    .checkbox-group input { display: none; }
    .checkbox-group input:checked + span { background: #4a148c; color: white; border-radius: 20px; padding: 8px 15px; margin: -8px -15px; display: inline-block; }

    .btn { padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-save { background: #00c853; color: white; }

    /* BB Tab Bar */
    .bbbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; padding:12px; border:1px solid #e0e6ed; border-radius:12px; background:#fff; margin-bottom:16px; }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .bbTab{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:bold; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }
    .hint{ font-size:12px; color:#666; margin-top:6px; width:100%; }

    /* TASLAK (korumalÄ± metin) */
    .taslak {
      background:#fff8e1; padding:25px; border-radius:12px; margin-top:30px; border:2px dashed #ffb300;
      font-size:15px; line-height:1.8; white-space:pre-wrap; color: #333;
      user-select: none;
      transition: filter 0.3s ease;
    }
    .taslak:not(:hover) { filter: blur(1.5px); }

    @media print {
      body * { visibility: hidden; }
      .taslak { visibility: hidden; }
      .taslak::after { content: "BU METÄ°N KORUMALIDIR!"; visibility: visible; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 30px; color: red; }
    }

    .hidden { display: none !important; }

    /* Kilitli gÃ¶rÃ¼nÃ¼m */
    .lockedNote{
      background:#ffe9e9;
      border-left:6px solid #c62828;
      padding:12px 14px;
      border-radius:12px;
      margin-bottom:14px;
      font-weight:900;
      color:#7a1b1b;
    }
    .btn-save[disabled]{ opacity:.5; cursor:not-allowed; }
  </style>

  <link rel="stylesheet" href="mobil-fix.css">
</head>

<body>

<div class="header">
  <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼</button>
  <h1>BAÄIMSIZ BÃ–LÃœM DETAY</h1>
  <div id="raporBilgi">YÃ¼kleniyor...</div>
</div>

<div class="container">

  <div id="lockNote" class="lockedNote hidden">
    ğŸ”’ Bu rapor FINAL yapÄ±lmÄ±ÅŸ. Bu modÃ¼l kilitlidir (dÃ¼zenleme yapÄ±lamaz).
  </div>

  <!-- BB SeÃ§imi -->
  <div class="bbbar">
    <div style="font-weight:bold; color:var(--primary);">BaÄŸÄ±msÄ±z BÃ¶lÃ¼m SeÃ§:</div>
    <div class="bbTabs" id="bbTabs"></div>
    <div class="hint">Her BB iÃ§in ayrÄ± detay kaydedilir. Sekme deÄŸiÅŸtirince o BBâ€™nin verileri yÃ¼klenir.</div>
  </div>

  <div class="section-title">1. Temel Bilgiler ve Alanlar (Net Ã–ncelikli)</div>
  <div class="form-group">
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
      <div class="input-item"><label>Kat</label><input type="text" id="kat" oninput="metinOlustur()"></div>
      <div class="input-item"><label>BB No</label><input type="text" id="bbNo" oninput="metinOlustur()"></div>
      <div class="input-item"><label>KapÄ± No</label><input type="text" id="kapiNo" oninput="metinOlustur()"></div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
      <div class="input-item"><label>Proje Net (mÂ²)</label><input type="number" id="alanNet" value="0" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Proje BrÃ¼t (mÂ²)</label><input type="number" id="alanBrut" oninput="metinOlustur()"></div>
      <div class="input-item"><label>GiriÅŸe GÃ¶re Konumu</label><input type="text" id="konum" placeholder="saÄŸ tarafta" oninput="metinOlustur()"></div>
    </div>

    <div class="input-item">
      <label>Cepheler</label>
      <div class="checkbox-group">
        <label><input type="checkbox" name="cephe" value="Kuzey" onchange="metinOlustur()"><span>Kuzey</span></label>
        <label><input type="checkbox" name="cephe" value="GÃ¼ney" onchange="metinOlustur()"><span>GÃ¼ney</span></label>
        <label><input type="checkbox" name="cephe" value="DoÄŸu" onchange="metinOlustur()"><span>DoÄŸu</span></label>
        <label><input type="checkbox" name="cephe" value="BatÄ±" onchange="metinOlustur()"><span>BatÄ±</span></label>
        <label><input type="checkbox" name="cephe" value="Kuzey-DoÄŸu" onchange="metinOlustur()"><span>Kuzey-DoÄŸu</span></label>
        <label><input type="checkbox" name="cephe" value="Kuzey-BatÄ±" onchange="metinOlustur()"><span>Kuzey-BatÄ±</span></label>
        <label><input type="checkbox" name="cephe" value="GÃ¼ney-DoÄŸu" onchange="metinOlustur()"><span>GÃ¼ney-DoÄŸu</span></label>
        <label><input type="checkbox" name="cephe" value="GÃ¼ney-BatÄ±" onchange="metinOlustur()"><span>GÃ¼ney-BatÄ±</span></label>
      </div>
    </div>
  </div>

  <div class="section-title">2. Proje FarkÄ± ve Mevcut Durum</div>
  <div class="form-group">
    <label>Projeye gÃ¶re deÄŸiÅŸiklik var mÄ±?</label>
    <div style="display:flex; gap:20px; margin: 10px 0;">
      <label style="width:auto; cursor:pointer;"><input type="radio" name="farkVar" value="hayir" checked onchange="farkKontrol(); metinOlustur();"> HayÄ±r</label>
      <label style="width:auto; cursor:pointer;"><input type="radio" name="farkVar" value="evet" onchange="farkKontrol(); metinOlustur();"> Evet</label>
    </div>

    <div id="farkDetay" class="hidden">
      <div class="input-item"><label>Ä°lave AÃ§Ä±klamasÄ±</label><textarea id="farkAciklama" oninput="metinOlustur()"></textarea></div>
      <div class="input-item"><label>Ä°lave BrÃ¼t Alan (mÂ²)</label><input type="number" id="ilaveBrut" value="0" oninput="metinOlustur()"></div>
    </div>
  </div>

  <div class="section-title">3. TaÅŸÄ±nmaz Hacimleri (SÄ±ralama: Salon BaÅŸa)</div>
  <div class="hacim-grid">
    <div class="hacim-card"><label>Salon</label><input type="number" id="count_salon" value="1" oninput="hacimPanelKontrol(); metinOlustur();"></div>
    <div class="hacim-card"><label>Oda</label><input type="number" id="count_oda" value="3" oninput="hacimPanelKontrol(); metinOlustur();"></div>
    <div class="hacim-card"><label>Mutfak</label><input type="number" id="count_mutfak" value="1" oninput="metinOlustur()"></div>
    <div class="hacim-card"><label>Banyo</label><input type="number" id="count_banyo" value="1" oninput="metinOlustur()"></div>
    <div class="hacim-card"><label>WC</label><input type="number" id="count_wc" value="1" oninput="metinOlustur()"></div>
    <div class="hacim-card"><label>Antre/Hol</label><input type="number" id="count_antre" value="1" oninput="metinOlustur()"></div>
    <div class="hacim-card"><label>Balkon</label><input type="number" id="count_balkon" value="1" oninput="metinOlustur()"></div>
  </div>

  <div class="section-title">4. Detaylar ve Tesisat (TÄ±kla-SeÃ§)</div>
  <div class="form-group">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
      <div class="input-item"><label>Antre Zemin</label><input type="text" id="antreZemin" list="h_antreZemin" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Antre Duvar</label><input type="text" id="antreDuvar" list="h_antreDuvar" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item salon-inputs"><label>Salon Zemin</label><input type="text" id="salonZemin" list="h_salonZemin" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item salon-inputs"><label>Salon Duvar</label><input type="text" id="salonDuvar" list="h_salonDuvar" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item oda-inputs"><label>Oda Zemin</label><input type="text" id="odaZemin" list="h_odaZemin" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item oda-inputs"><label>Oda Duvar</label><input type="text" id="odaDuvar" list="h_odaDuvar" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Mutfak Zemin</label><input type="text" id="mutfakZemin" list="h_mutfakZemin" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Mutfak Duvar</label><input type="text" id="mutfakDuvar" list="h_mutfakDuvar" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Mutfak DolabÄ±</label><input type="text" id="mutfakDolap" list="h_mutfakDolap" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Mutfak TezgahÄ±</label><input type="text" id="mutfakTezgah" list="h_mutfakTezgah" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Islak Hacim</label><input type="text" id="islakHacim" list="h_islakHacim" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>GiriÅŸ KapÄ±sÄ±</label><input type="text" id="daireKapi" list="h_daireKapi" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Ä°Ã§ KapÄ±lar</label><input type="text" id="icKapi" list="h_icKapi" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>Pencereler</label><input type="text" id="pencere" list="h_pencere" onfocus="showList(this)" oninput="metinOlustur()"></div>
      <div class="input-item"><label>IsÄ±tma</label><input type="text" id="isitma" list="h_isitma" onfocus="showList(this)" oninput="metinOlustur()"></div>
    </div>
  </div>

  <button id="btnSave" class="btn btn-save" onclick="kaydet()">VERÄ°LERÄ° KAYDET</button>
  <div id="taslak" class="taslak"></div>
</div>

<!-- datalist -->
<div id="datalist_container" style="display:none;">
  <datalist id="h_antreZemin"></datalist><datalist id="h_antreDuvar"></datalist>
  <datalist id="h_salonZemin"></datalist><datalist id="h_salonDuvar"></datalist>
  <datalist id="h_odaZemin"></datalist><datalist id="h_odaDuvar"></datalist>
  <datalist id="h_mutfakZemin"></datalist><datalist id="h_mutfakDuvar"></datalist>
  <datalist id="h_mutfakDolap"></datalist><datalist id="h_mutfakTezgah"></datalist>
  <datalist id="h_islakHacim"></datalist><datalist id="h_daireKapi"></datalist>
  <datalist id="h_icKapi"></datalist><datalist id="h_pencere"></datalist>
  <datalist id="h_isitma"></datalist>
</div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + legacy id ========= */
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "bagimsiz-bolum-detay.html");
      window.location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }
  function persist(arr, i, r){
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
  }

  /* ========= BB List ========= */
  let activeBBIndex = 0;
  function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

  function ensureBBList(report){
    if (!report.bbDetayList || !Array.isArray(report.bbDetayList) || report.bbDetayList.length === 0) {
      if (report.bbDetay) {
        report.bbDetayList = [ { bbid:"bb_1", baslik:"1. BB", bbDetay: deepClone(report.bbDetay), degerlemeOzet: {} } ];
      } else {
        report.bbDetayList = [ { bbid:"bb_1", baslik:"1. BB", bbDetay: {}, degerlemeOzet: {} } ];
      }
    }
    report.bbDetayList.forEach((x, idx) => {
      if (!x.bbid) x.bbid = "bb_" + (idx+1);
      if (!x.baslik) x.baslik = `${idx+1}. BB`;
      if (typeof x.degerlemeOzet !== "object" || x.degerlemeOzet === null) x.degerlemeOzet = {};
      if (typeof x.bbDetay !== "object" || x.bbDetay === null) x.bbDetay = {};
    });
  }

  function renderBBTabs(){
    const { r, arr, i } = getLatestData();
    if (!r) return;
    ensureBBList(r);
    const el = document.getElementById("bbTabs");
    el.innerHTML = r.bbDetayList.map((x, idx) => {
      const active = idx === activeBBIndex ? "bbTab active" : "bbTab";
      return `<button type="button" class="${active}" onclick="setActiveBB(${idx})">${x.baslik || (idx+1)+'. BB'}</button>`;
    }).join("");
    persist(arr, i, r);
  }

  function setActiveBB(idx){
    activeBBIndex = idx;
    renderBBTabs();
    veriYukle();
    hacimPanelKontrol();
    metinOlustur();
  }

  /* ========= HatÄ±rlatma (datalist) ========= */
  const fieldsToRemember = ['antreZemin','antreDuvar','salonZemin','salonDuvar','odaZemin','odaDuvar','mutfakZemin','mutfakDuvar','mutfakDolap','mutfakTezgah','islakHacim','daireKapi','icKapi','pencere','isitma'];

  function escapeAttr(s){ return String(s).replace(/"/g,'&quot;'); }

  function initAutocomplete() {
    fieldsToRemember.forEach(f => {
      const history = JSON.parse(localStorage.getItem('h_bb_' + f) || '[]');
      const dl = document.getElementById('h_' + f);
      if (dl) dl.innerHTML = history.map(i => `<option value="${escapeAttr(i)}">`).join('');
    });
  }

  function saveAutocompleteHistory(){
    fieldsToRemember.forEach(f => {
      const el = document.getElementById(f);
      if (!el) return;
      const val = (el.value || "").trim();
      if(!val) return;

      let h = JSON.parse(localStorage.getItem('h_bb_' + f) || '[]');
      h = h.filter(x => x !== val);
      h.unshift(val);
      localStorage.setItem('h_bb_' + f, JSON.stringify(h.slice(0,15)));
    });
  }

  function showList(input) {
    input.setAttribute('autocomplete', 'off');
    const val = input.value;
    input.value = '';
    setTimeout(() => { input.value = val; }, 1);
  }

  /* ========= Kopya/print engeli (Sadece taslak korumalÄ±) ========= */
  document.addEventListener("copy", (e) => {
    const inProtected = e.target && e.target.closest && e.target.closest("#taslak");
    if (inProtected) e.preventDefault();
  });
  document.addEventListener("contextmenu", (e) => {
    const inProtected = e.target && e.target.closest && e.target.closest("#taslak");
    if (inProtected) e.preventDefault();
  });

  /* ========= UI MantÄ±klarÄ± ========= */
  function farkKontrol() {
    const isEvet = document.querySelector('input[name="farkVar"]:checked').value === 'evet';
    document.getElementById('farkDetay').classList.toggle('hidden', !isEvet);
  }

  function hacimPanelKontrol() {
    const sCount = parseInt(document.getElementById('count_salon').value) || 0;
    const oCount = parseInt(document.getElementById('count_oda').value) || 0;
    document.querySelectorAll('.salon-inputs').forEach(el => el.classList.toggle('hidden', sCount === 0));
    document.querySelectorAll('.oda-inputs').forEach(el => el.classList.toggle('hidden', oCount === 0));
  }

  function metinOlustur() {
    const v = (id) => (document.getElementById(id).value || "").trim() || "...";
    const cphe = Array.from(document.querySelectorAll('input[name="cephe"]:checked')).map(cb => cb.value).join("-") || "...";
    const aBrut = parseFloat(document.getElementById('alanBrut').value) || 0;
    const aNet = parseFloat(document.getElementById('alanNet').value) || 0;
    const farkVar = document.querySelector('input[name="farkVar"]:checked').value === 'evet';

    const items = [
      { id: 'salon', label: 'salon' }, { id: 'oda', label: 'oda' }, { id: 'mutfak', label: 'mutfak' },
      { id: 'banyo', label: 'banyo' }, { id: 'wc', label: 'wc' }, { id: 'antre', label: 'antre-hol' }, { id: 'balkon', label: 'balkon' }
    ];
    let hList = [];
    items.forEach(i => {
      let val = parseInt(document.getElementById('count_' + i.id).value) || 0;
      if(val > 0) hList.push(val === 1 ? i.label : val + " " + i.label);
    });
    const hacimMetni = hList.join(", ");

    let metin = `DeÄŸerleme konusu taÅŸÄ±nmaz binanÄ±n ${v('kat')} katÄ±nda yer alan ${v('bbNo')} baÄŸÄ±msÄ±z bÃ¶lÃ¼m ve ${v('kapiNo')} kapÄ± numaralÄ± taÅŸÄ±nmazdÄ±r. `;
    metin += `TaÅŸÄ±nmaz bina giriÅŸine gÃ¶re ${v('konum')} yer almaktadÄ±r. TaÅŸÄ±nmaz ${cphe} cephelidir. `;

    metin += `Projesine gÃ¶re `;
    if (aNet > 0) metin += `net ${aNet} mÂ², `;
    metin += `brÃ¼t ${aBrut} mÂ² kullanÄ±m alanÄ±na sahiptir. `;

    if (farkVar) {
      metin += `TaÅŸÄ±nmaz projesine gÃ¶re ${hacimMetni} hacimlerinden oluÅŸmaktadÄ±r. ${v('farkAciklama')} `;
      const ilave = parseFloat(document.getElementById('ilaveBrut').value) || 0;
      if (ilave > 0) {
        metin += `Mevcut durumda brÃ¼t ${ilave} mÂ² ilave ile mevcut durumdaki toplam alanÄ±n brÃ¼t ${aBrut + ilave} mÂ² olduÄŸu tespit edilmiÅŸtir. `;
      } else {
        metin += `Mevcut durumda taÅŸÄ±nmazÄ±n alanÄ± deÄŸiÅŸmemiÅŸtir. `;
      }
    } else {
      metin += `TaÅŸÄ±nmaz projesine gÃ¶re ve mevcut durumda ${hacimMetni} hacimlerinden oluÅŸmaktadÄ±r. `;
    }

    metin += `\n\nAntre zeminleri ${v('antreZemin')}, duvarlarÄ± ${v('antreDuvar')}. `;
    if (parseInt(document.getElementById('count_salon').value) > 0) metin += `Salon zemini ${v('salonZemin')}, duvarlarÄ± ${v('salonDuvar')}. `;
    if (parseInt(document.getElementById('count_oda').value) > 0) metin += `Oda zeminleri ${v('odaZemin')}, duvarlarÄ± ${v('odaDuvar')}. `;

    metin += `Mutfak zemini ${v('mutfakZemin')}, duvarlarÄ± ${v('mutfakDuvar')}. `;
    metin += `Mutfak dolabÄ± ${v('mutfakDolap')}, tezgÃ¢hÄ± ${v('mutfakTezgah')}. Islak hacimlerin zemin ve duvarlarÄ± ${v('islakHacim')}. `;
    metin += `TaÅŸÄ±nmazÄ±n giriÅŸ kapÄ±sÄ± ${v('daireKapi')}, iÃ§ kapÄ±larÄ± ${v('icKapi')}. Pencereleri ${v('pencere')} doÄŸramadÄ±r. `;
    metin += `GayrimenkulÃ¼n Ä±sÄ±tÄ±lmasÄ± ${v('isitma')} ile saÄŸlanmaktadÄ±r. TaÅŸÄ±nmazda elektrik, su ve haberleÅŸme tesisatlarÄ± mevcuttur.`;

    document.getElementById("taslak").textContent = metin;

    // aktif BB iÃ§ine â€œanlÄ±k taslakâ€ da yazalÄ±m (kaydetmeden de metin kaybolmasÄ±n)
    const { arr, i, r } = getLatestData();
    if (r) {
      ensureBBList(r);
      const bb = r.bbDetayList[activeBBIndex];
      if (bb) {
        bb.bbDetay = bb.bbDetay || {};
        bb.bbDetay.tamMetin = metin;
        bb.bbDetay.metin = metin;
        persist(arr, i, r);
      }
    }
  }

  function setFormDisabled(disabled){
    document.querySelectorAll("input, textarea, select, button.bbTab").forEach(el=>{
      // bbTab butonlarÄ± kilitliyken de gezilebilir olsun (sadece inputlar kapanÄ±r)
      if (el.classList && el.classList.contains("bbTab")) return;
      el.disabled = !!disabled;
    });
  }

  function isReportLocked(){
    if (!rid) return false;
    return localStorage.getItem("report_locked_" + rid) === "1";
  }

  function veriYukle(){
    const { r } = getLatestData();
    if (!r) return;

    ensureBBList(r);
    const bb = r.bbDetayList[activeBBIndex] || { bbDetay: {} };
    const d = bb.bbDetay || {};

    // temel
    document.getElementById("kat").value = d.kat ?? "";
    document.getElementById("bbNo").value = d.bbNo ?? "";
    document.getElementById("kapiNo").value = d.kapiNo ?? "";

    document.getElementById("alanNet").value = (d.alanNet ?? 0);
    document.getElementById("alanBrut").value = (d.alanBrut ?? 0);
    document.getElementById("konum").value = d.konum ?? "";

    // cephe
    const cepheSet = new Set((d.cepheler || "").split("-").map(x=>x.trim()).filter(Boolean));
    document.querySelectorAll('input[name="cephe"]').forEach(cb=>{
      cb.checked = cepheSet.has(cb.value);
    });

    // fark
    const fark = (d.farkVar === true || d.farkVar === "evet") ? "evet" : "hayir";
    document.querySelectorAll('input[name="farkVar"]').forEach(radio=>{
      radio.checked = (radio.value === fark);
    });
    farkKontrol();
    document.getElementById("farkAciklama").value = d.farkAciklama ?? "";
    document.getElementById("ilaveBrut").value = (d.ilaveBrut ?? 0);

    // hacimler
    document.getElementById("count_salon").value  = (d.count_salon ?? 1);
    document.getElementById("count_oda").value    = (d.count_oda ?? 3);
    document.getElementById("count_mutfak").value = (d.count_mutfak ?? 1);
    document.getElementById("count_banyo").value  = (d.count_banyo ?? 1);
    document.getElementById("count_wc").value     = (d.count_wc ?? 1);
    document.getElementById("count_antre").value  = (d.count_antre ?? 1);
    document.getElementById("count_balkon").value = (d.count_balkon ?? 1);
    hacimPanelKontrol();

    // detay alanlar
    fieldsToRemember.forEach(f=>{
      const el = document.getElementById(f);
      if (el) el.value = d[f] ?? "";
    });

    // taslak
    document.getElementById("taslak").textContent = (d.tamMetin || d.metin || "");

    metinOlustur();
  }

  function collectForm(){
    const get = (id)=> (document.getElementById(id).value || "").toString().trim();
    const num = (id)=> Number(document.getElementById(id).value || 0) || 0;

    const cepheler = Array.from(document.querySelectorAll('input[name="cephe"]:checked'))
      .map(cb=>cb.value).join("-");

    const farkVarVal = document.querySelector('input[name="farkVar"]:checked')?.value || "hayir";

    const obj = {
      kat: get("kat"),
      bbNo: get("bbNo"),
      kapiNo: get("kapiNo"),
      alanNet: num("alanNet"),
      alanBrut: num("alanBrut"),
      konum: get("konum"),
      cepheler: cepheler,

      farkVar: (farkVarVal === "evet"),
      farkAciklama: get("farkAciklama"),
      ilaveBrut: num("ilaveBrut"),

      count_salon: num("count_salon"),
      count_oda: num("count_oda"),
      count_mutfak: num("count_mutfak"),
      count_banyo: num("count_banyo"),
      count_wc: num("count_wc"),
      count_antre: num("count_antre"),
      count_balkon: num("count_balkon"),
    };

    fieldsToRemember.forEach(f=>{
      obj[f] = get(f);
    });

    const metin = (document.getElementById("taslak").textContent || "").trim();
    obj.tamMetin = metin;
    obj.metin = metin;

    return obj;
  }

  function kaydet(){
    if (!rid) { alert("RID bulunamadÄ±!"); return; }
    if (isReportLocked()) { alert("Bu rapor FINAL yapÄ±lmÄ±ÅŸ. DÃ¼zenleme kapalÄ±."); return; }

    const { arr, i, r } = getLatestData();
    if (!r || i < 0) { alert("Rapor bulunamadÄ±!"); return; }

    ensureBBList(r);
    const bb = r.bbDetayList[activeBBIndex];
    if (!bb) { alert("BB bulunamadÄ±!"); return; }

    bb.bbDetay = collectForm();

    // autocomplete hafÄ±zasÄ±
    saveAutocompleteHistory();

    persist(arr, i, r);
    alert("âœ… Kaydedildi.");
    anaMenuyeDon();
  }

  function anaMenuyeDon(){
    if (!rid) { window.location.href = "rapor-detay.html"; return; }
    window.location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
  }

  /* ========= BOOT ========= */
  auth.onAuthStateChanged((user)=>{
    if (!user) { window.location.href = "index.html"; return; }
    if (!rid) { window.location.href = "index.html"; return; }

    initAutocomplete();

    const { r } = getLatestData();
    if (!r) { alert("Rapor bulunamadÄ±!"); window.location.href="index.html"; return; }

    document.getElementById("raporBilgi").textContent =
      `${r.propertyName || "Ä°simsiz Gayrimenkul"} â€¢ RID: ${rid}`;

    renderBBTabs();
    veriYukle();
    farkKontrol();
    hacimPanelKontrol();
    metinOlustur();

    // Final kilit varsa bu modÃ¼l de kilitli aÃ§Ä±lsÄ±n
    if (isReportLocked()){
      document.getElementById("lockNote").classList.remove("hidden");
      document.getElementById("btnSave").textContent = "ğŸ”’ KÄ°LÄ°TLÄ° (FINAL)";
      document.getElementById("btnSave").disabled = true;
      setFormDisabled(true);
      // BB sekmeler arasÄ±nda gezebilirsin (sadece gÃ¶rÃ¼ntÃ¼)
      document.querySelectorAll(".bbTab").forEach(b=> b.disabled = false);
    }
  });
</script>

<!-- mobil fix -->
<script src="mobil-fix.js"></script>
</body>
</html>

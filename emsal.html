<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profesyonel Emsal Analiz Sistemi - Raporan X</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary:#1a237e; --secondary:#3f51b5; --success:#2e7d32; --bg:#f4f7f6; --danger:#c62828; }
    * { box-sizing:border-box; }
    body { font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; padding-bottom:120px; color:#333; }
    .header { background:var(--primary); color:#fff; padding:25px; text-align:center; position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.2); }
    .back { position:absolute; left:15px; top:22px; background:rgba(255,255,255,.2); padding:8px 15px; border-radius:20px; color:#fff; text-decoration:none; font-weight:bold; cursor:pointer; border:none; }
    .container { max-width:980px; margin:20px auto; padding:0 20px; }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05); margin-bottom:20px; border:1px solid #e0e6ed; }
    .section-title { color:var(--primary); font-size:1.1rem; font-weight:bold; border-bottom:2px solid #eee; padding-bottom:8px; margin-bottom:15px; }
    .grid-form { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }
    .input-group label { display:block; font-size:13px; font-weight:600; color:#555; margin-bottom:5px; }
    .input-group input, .input-group select { width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:14px; outline:none; }
    .btn { padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:.2s; }
    .btn-save-final { background:var(--primary); color:#fff; margin-top:15px; width:100%; font-size:18px; }
    .final-box{ background:#fff; border:2px solid #ddd; padding:20px; border-radius:12px; white-space:pre-wrap; font-size:15px; line-height:1.7; color:#333; }
    
    .hesap-tablosu { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; background: #fff; }
    .hesap-tablosu th, .hesap-tablosu td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    .hesap-tablosu th { background-color: #f2f2f2; color: var(--primary); font-weight: 800; }
    .bbTabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:15px; }
    .bbTab { padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff; font-weight:bold; }
    .bbTab.active { background:var(--primary); color:#fff; border-color:transparent; }
  </style>
</head>

<body>
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼</button>
    <h1>EMSAL ANALÄ°ZÄ° VE DEÄERLEME</h1>
    <div id="raporBilgi">YÃ¼kleniyor...</div>
  </div>

  <div class="container">
    <div class="card">
      <div style="font-weight:bold; color:var(--primary); margin-bottom:10px;">BaÄŸÄ±msÄ±z BÃ¶lÃ¼m SeÃ§:</div>
      <div class="bbTabs" id="bbTabs"></div>
    </div>

    <div class="section-title">1. KayÄ±tlÄ± Emsaller (ORTAK HAVUZ)</div>
    <div id="emsalListesi"></div>
    <button class="btn" style="background:var(--success); color:#fff; width:100%;" onclick="formuAc()">+ YENÄ° EMSAL ARAÅTIRMASI EKLE</button>

    <div id="emsalFormContainer" class="card" style="display:none; border-top:5px solid var(--primary);">
      <div class="grid-form">
        <div class="input-group"><label>(1) KaynaÄŸÄ±</label><input type="text" id="f1"></div>
        <div class="input-group"><label>(2) Telefon</label><input type="text" id="f2" oninput="formatPhone(this)"></div>
        <div class="input-group"><label>(3) Konum</label><input type="text" id="f3"></div>
        <div class="input-group"><label>(8) Tahmini Alan (mÂ²)</label><input type="number" id="f8" oninput="hesapla()"></div>
        <div class="input-group">
          <label>(10) Ä°stenen Fiyat (TL)</label>
          <input type="text" id="f10_mask" oninput="formatMoneyInput(this); hesapla();">
          <input type="hidden" id="f10">
        </div>
        <div class="input-group"><label>(14) PazarlÄ±k %</label><input type="number" id="f14" value="5" oninput="hesapla()"></div>
        <div class="input-group"><label>(12) Åerefiye (+)</label><input type="number" id="f12" value="0" oninput="hesapla()"></div>
        <div class="input-group"><label>(13) Åerefiye (-)</label><input type="number" id="f13" value="0" oninput="hesapla()"></div>
        <div class="input-group" style="grid-column:span 2;"><label>DÃ¼zeltilmiÅŸ Birim (mÂ²)</label><input type="text" id="f17" readonly style="background:#e8f5e9; font-weight:bold;"></div>
      </div>
      <button class="btn btn-save-final" onclick="emsalKaydet()">HAVUZA KAYDET</button>
    </div>

    <div class="card">
      <div class="section-title">2. DeÄŸerleme Birim Analizi (SeÃ§ili BB)</div>
      <div class="grid-form">
        <div class="input-group"><label>BÃ¶lge Alt SÄ±nÄ±r</label><input type="text" id="inp_dusuk_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_dusuk"></div>
        <div class="input-group"><label>BÃ¶lge Ãœst SÄ±nÄ±r</label><input type="text" id="inp_yuksek_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_yuksek"></div>
        <div class="input-group"><label>UYGULANAN BÄ°RÄ°M</label><input type="text" id="inp_uygulanan_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_uygulanan"></div>
        <div class="input-group"><label>Yasal BrÃ¼t Alan</label><input type="text" id="res_brut" readonly style="background:#eee;"></div>
        <div class="input-group"><label>Ä°lave Alan (mÂ²)</label><input type="number" id="inp_proje_disi" oninput="finalHesapla()" value="0"></div>
        <div class="input-group"><label>Ä°lave Birim DeÄŸeri</label><input type="text" id="inp_proje_birim_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_proje_birim"></div>
      </div>
    </div>

    <div class="section-title">3. Rapor Analiz Metni ve Hesap Tablosu</div>
    <div id="yorumMetni" class="final-box"></div>
    <div id="tabloAlani"></div>

    <button class="btn btn-save-final" style="background:var(--success); padding:20px;" onclick="tumRaporuKaydet()">ğŸ“Š ANALÄ°ZÄ° VE TABLOYU MÃœHÃœRLE</button>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  let activeBBIndex = 0;

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = arr.findIndex(r => r && r.rid === rid);
    return { arr, i, r: arr[i] || null };
  }

  function persist(arr, i, r){
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
  }

  function formatMoneyInput(input) {
    let value = (input.value || "").replace(/\D/g, "");
    input.value = value ? new Intl.NumberFormat('tr-TR').format(value) : "";
    document.getElementById(input.id.replace("_mask", "")).value = value;
  }

  function formatPhone(input) {
    let x = input.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
    input.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
  }

  function formatLira0(num) { return new Intl.NumberFormat('tr-TR').format(Math.round(num || 0)); }

  function setActiveBB(idx){
    saveBBSettingsToObject();
    activeBBIndex = idx;
    renderBBTabs();
    refreshActiveBBUI();
  }

  function renderBBTabs(){
    const { r } = getLatestData();
    if (!r || !r.bbDetayList) return;
    document.getElementById("bbTabs").innerHTML = r.bbDetayList.map((x, idx) => 
      `<button class="bbTab ${idx === activeBBIndex ? 'active' : ''}" onclick="setActiveBB(${idx})">${x.baslik || (idx+1)+'. BB'}</button>`
    ).join("");
  }

  function refreshActiveBBUI(){
    const { r } = getLatestData();
    const bb = r.bbDetayList[activeBBIndex];
    document.getElementById('res_brut').value = bb.bbDetay?.alanBrut || 0;
    const oz = bb.degerlemeOzet || {};
    setMoneyPair('inp_dusuk', 'inp_dusuk_mask', oz.dusukBirim);
    setMoneyPair('inp_yuksek', 'inp_yuksek_mask', oz.yuksekBirim);
    setMoneyPair('inp_uygulanan', 'inp_uygulanan_mask', oz.uygulananBirim);
    setMoneyPair('inp_proje_birim', 'inp_proje_birim_mask', oz.projeDisiBirim);
    document.getElementById('inp_proje_disi').value = oz.projeDisiAlan || 0;
    listele();
  }

  function setMoneyPair(h, m, v){
    document.getElementById(h).value = v || "";
    document.getElementById(m).value = v ? new Intl.NumberFormat('tr-TR').format(v) : "";
  }

  function saveBBSettingsToObject(){
    const { arr, i, r } = getLatestData();
    if(!r) return;
    const bb = r.bbDetayList[activeBBIndex];
    if(!bb.degerlemeOzet) bb.degerlemeOzet = {};
    bb.degerlemeOzet.uygulananBirim = document.getElementById('inp_uygulanan').value;
    bb.degerlemeOzet.dusukBirim = document.getElementById('inp_dusuk').value;
    bb.degerlemeOzet.yuksekBirim = document.getElementById('inp_yuksek').value;
    bb.degerlemeOzet.projeDisiAlan = document.getElementById('inp_proje_disi').value;
    bb.degerlemeOzet.projeDisiBirim = document.getElementById('inp_proje_birim').value;
    persist(arr, i, r);
  }

  function finalHesapla() {
    const { r } = getLatestData();
    if(!r) return;

    let emsalMetni = `EMSAL ARAÅTIRMALARI\n------------------------------------------\n`;
    (r.emsalHavuzu || []).forEach((e, idx) => {
        const fy = e.f10 ? new Intl.NumberFormat('tr-TR').format(e.f10) : "...";
        emsalMetni += `${idx+1}) â–º ${(e.f1||'').toUpperCase()} (${e.f2||''}) TaÅŸÄ±nmazla ${e.f3||''}, ${e.f8||''}mÂ² alanlÄ± gayrimenkul ${fy} TL ile satÄ±lÄ±ktÄ±r. (Birim: ${e.f17} TL/mÂ²)\n`;
    });

    let metin = `Emsal KarÅŸÄ±laÅŸtÄ±rma YÃ¶ntemine GÃ¶re DeÄŸer Analizi\n\n`;
    metin += `TaÅŸÄ±nmazÄ±n deÄŸer tespitinde Emsal KarÅŸÄ±laÅŸtÄ±rma YÃ¶ntemi kullanÄ±lmÄ±ÅŸtÄ±r. DeÄŸerlemeye konu mÃ¼lk ile emsal mÃ¼lkler benzer Ã¶zelliklerde ve birbirlerine baz alÄ±nabilecek niteliktedir. `;
    const d = document.getElementById('inp_dusuk').value;
    const y = document.getElementById('inp_yuksek').value;
    metin += `Emsal mÃ¼lklerin mÂ² birim fiyatlarÄ± ${formatLira0(d)} TL ile ${formatLira0(y)} TL arasÄ±ndadÄ±r. YapÄ±lan analizler sonucunda konu mÃ¼lkÃ¼n tÃ¼m Ã¶zellikleri ve bÃ¶lge emlak komisyoncularÄ±ndan alÄ±nan bilgiler gÃ¶z Ã¶nÃ¼nde bulundurulmuÅŸtur.\n\n`;

    let tabloHtml = `<table class="hesap-tablosu"><tr><th>BÃ¶lÃ¼m</th><th>Yasal Alan</th><th>Birim</th><th>Yasal DeÄŸer</th><th>Ä°lave</th><th>Mevcut DeÄŸer</th></tr>`;

    r.bbDetayList.forEach((bb) => {
      const oz = bb.degerlemeOzet || {};
      const uyg = parseFloat(oz.uygulananBirim) || 0;
      const alan = parseFloat(bb.bbDetay?.alanBrut) || 0;
      const yasalDeger = Math.round(uyg * alan);
      const ilaveA = parseFloat(oz.projeDisiAlan) || 0;
      const ilaveB = parseFloat(oz.projeDisiBirim) || 0;
      const ilaveF = Math.round(ilaveA * ilaveB);
      const toplam = yasalDeger + ilaveF;

      metin += `ğŸ“ ${bb.baslik}:\n`;
      metin += `Konu taÅŸÄ±nmaza ${formatLira0(uyg)} TL/mÂ² birim fiyatÄ± Ã¼zerinden; ${formatLira0(uyg)} TL/mÂ² x ${alan} mÂ² = ${formatLira0(yasalDeger)} TL yasal deÄŸer `;

      if (ilaveA > 0) {
        metin += `, proje harici bÃ¼yÃ¼me ile birlikte ${ilaveA} mÂ² x ${formatLira0(ilaveB)} TL/mÂ² = ${formatLira0(ilaveF)} TL ilave deÄŸer hesaplanmÄ±ÅŸ olup; ${formatLira0(yasalDeger)} TL + ${formatLira0(ilaveF)} TL = ${formatLira0(toplam)} TL mevcut durum deÄŸeri uygun gÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r.`;
      } else {
        metin += `yasal ve mevcut durum deÄŸeri takdir edilmiÅŸtir.`;
      }
      metin += `\n\n`;
      tabloHtml += `<tr><td>${bb.baslik}</td><td>${alan}mÂ²</td><td>${formatLira0(uyg)}</td><td>${formatLira0(yasalDeger)}</td><td>${ilaveA}mÂ²</td><td>${formatLira0(toplam)}</td></tr>`;
    });

    document.getElementById('yorumMetni').innerText = emsalMetni + "\n" + metin;
    document.getElementById('tabloAlani').innerHTML = tabloHtml + `</table>`;
  }

  async function tumRaporuKaydet() {
    saveBBSettingsToObject();
    const { arr, i, r } = getLatestData();
    const metin = document.getElementById('yorumMetni').innerText;
    const tablo = document.getElementById('tabloAlani').innerHTML;
    
    if(!r.modules) r.modules = {};
    if(!r.modules.emsal) r.modules.emsal = {};
    
    // ğŸ”¥ KRÄ°TÄ°K MÃœHÃœR: Hem metni hem tabloyu mÃ¼hÃ¼rler
    const finalCikti = metin + "\n\nDEÄERLEME TABLOSU\n" + tablo;
    r.modules.emsal.text = finalCikti;
    r.emsalFinalMetni = finalCikti; 

    persist(arr, i, r);
    if (auth.currentUser) await db.collection("users").doc(auth.currentUser.uid).set({ gayrimenkul_reports: arr }, { merge: true });
    alert("âœ… Metinler ve Tablo Rapor SayfasÄ±na MÃ¼hÃ¼rlendi!");
  }

  function emsalKaydet() {
    const { arr, i, r } = getLatestData();
    if(!r.emsalHavuzu) r.emsalHavuzu = [];
    r.emsalHavuzu.push({
      emsalId: 'e_'+Date.now(),
      f1: document.getElementById('f1').value,
      f2: document.getElementById('f2').value,
      f3: document.getElementById('f3').value,
      f8: document.getElementById('f8').value,
      f10: document.getElementById('f10').value,
      f14: document.getElementById('f14').value,
      f12: document.getElementById('f12').value,
      f13: document.getElementById('f13').value,
      f17: document.getElementById('f17').value
    });
    persist(arr, i, r);
    document.getElementById('emsalFormContainer').style.display = 'none';
    listele();
  }

  function listele() {
    const { r } = getLatestData();
    document.getElementById('emsalListesi').innerHTML = (r.emsalHavuzu || []).map((e, idx) => 
      `<div class="emsal-liste-item">Emsal ${idx+1}: ${formatLira0(e.f10)} TL â†’ ${e.f17} TL/mÂ²</div>`
    ).join("");
    finalHesapla();
  }

  function hesapla() {
    const f = parseFloat(document.getElementById('f10').value) || 0;
    const a = parseFloat(document.getElementById('f8').value) || 1;
    const p = parseFloat(document.getElementById('f14').value) || 0;
    const sp = parseFloat(document.getElementById('f12').value) || 0;
    const sm = parseFloat(document.getElementById('f13').value) || 0;
    const b = (f * (1 - p/100) / a) * (1 + (sp-sm)/100);
    document.getElementById('f17').value = formatLira0(b);
  }

  function formuAc(){ document.getElementById('emsalFormContainer').style.display = 'block'; }
  function anaMenuyeDon() { window.location.href = `rapor-detay.html?rid=${rid}`; }

  window.onload = () => {
    const { r } = getLatestData();
    if(r) { renderBBTabs(); refreshActiveBBUI(); }
  };
</script>
</body>
</html>

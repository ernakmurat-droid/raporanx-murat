<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profesyonel Emsal Analiz Sistemi - Raporan X</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<link rel="stylesheet" href="mobil-fix.css">

<style>
:root{
--primary:#1a237e;--secondary:#3f51b5;--success:#2e7d32;
--bg:#f4f7f6;--danger:#c62828;
}
body{font-family:Segoe UI,Tahoma,sans-serif;background:var(--bg);margin:0;padding-bottom:120px}
.header{background:var(--primary);color:#fff;padding:25px;text-align:center;position:sticky;top:0;z-index:1000}
.back{position:absolute;left:15px;top:22px;background:rgba(255,255,255,.2);padding:8px 15px;border-radius:20px;color:#fff;border:none;font-weight:bold}
.container{max-width:980px;margin:20px auto;padding:0 20px}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 12px rgba(0,0,0,.05)}
.section-title{color:var(--primary);font-weight:bold;border-bottom:2px solid #eee;padding-bottom:6px;margin-bottom:15px}
.grid-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px}
.input-group label{font-size:13px;font-weight:bold}
.input-group input,.input-group select{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc}
.btn{padding:12px 20px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
.btn-add{background:var(--success);color:#fff;width:100%}
.btn-save{background:var(--primary);color:#fff}
.emsal-liste-item{background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:8px;border-left:5px solid var(--primary);display:flex;justify-content:space-between}
.emsal-liste-item button{margin-left:6px}
.final-box{white-space:pre-wrap;user-select:none}
</style>
</head>

<body>

<div class="header">
<button class="back" onclick="anaMenuyeDon()">← Menü</button>
<h1>EMSAL ANALİZİ</h1>
<div id="raporBilgi"></div>
</div>

<div class="container">

<div class="section-title">Kayıtlı Emsaller</div>
<div id="emsalListesi"></div>

<button class="btn btn-add" onclick="formuAc()">+ YENİ EMSAL EKLE</button>

<div id="emsalFormContainer" class="card" style="display:none">
<div class="section-title">Emsal Girişi</div>

<div class="grid-form">
<div class="input-group"><label>Kaynak</label><input id="f1"></div>
<div class="input-group"><label>Telefon</label><input id="f2"></div>
<div class="input-group"><label>Konum</label><input id="f3"></div>
<div class="input-group"><label>Kat Sayısı</label><input id="f4"></div>
<div class="input-group"><label>Bulunduğu Kat</label><input id="f5"></div>
<div class="input-group"><label>Oda</label><input id="f6"></div>
<div class="input-group"><label>Beyan Alan</label><input id="f7"></div>
<div class="input-group"><label>Tahmini Alan</label><input id="f8" oninput="hesapla()"></div>
<div class="input-group"><label>Cinsi</label><input id="f9"></div>
<div class="input-group"><label>Fiyat</label>
<input id="f10_mask" oninput="formatMoneyInput(this);hesapla()">
<input type="hidden" id="f10">
</div>
<div class="input-group"><label>Pazarlık %</label><input id="f14" value="5" oninput="hesapla()"></div>
<div class="input-group"><label>Şerefiye +</label><input id="f12" value="0" oninput="hesapla()"></div>
<div class="input-group"><label>Şerefiye -</label><input id="f13" value="0" oninput="hesapla()"></div>
<div class="input-group"><label>Birim Değer</label><input id="f17" readonly></div>
</div>

<br>
<button class="btn btn-save" onclick="emsalKaydet()">KAYDET</button>
<button class="btn" onclick="formuKapat()">İPTAL</button>
</div>

<div class="section-title">Rapor Metni</div>
<div id="yorumMetni" class="card final-box"></div>

</div>

<script>
const params=new URLSearchParams(location.search);
const rid=params.get("rid");
let reports=JSON.parse(localStorage.getItem("gayrimenkul_reports"))||[];
let report=reports.find(r=>r.rid===rid);
if(!report){report={rid,emsalHavuzu:[]};reports.push(report)}

function formatMoneyInput(input){
let v=input.value.replace(/\D/g,"");
input.value=v?new Intl.NumberFormat("tr-TR").format(v):"";
document.getElementById("f10").value=v;
}

function hesapla(){
const f=+document.getElementById("f10").value||0;
const a=+document.getElementById("f8").value||1;
const p=+document.getElementById("f14").value||0;
const sPlus=+document.getElementById("f12").value||0;
const sMinus=+document.getElementById("f13").value||0;
const b=(f*(1-p/100)/a)*(1+(sPlus-sMinus)/100);
document.getElementById("f17").value=Math.round(b);
}

function emsalKaydet(){
let e={};
for(let i=1;i<=14;i++){
let el=document.getElementById("f"+i);
if(el)e["f"+i]=el.value;
}
e.id=crypto.randomUUID();
report.emsalHavuzu.push(e);
localStorage.setItem("gayrimenkul_reports",JSON.stringify(reports));
formuKapat();
listele();
}

function listele(){
const el=document.getElementById("emsalListesi");
el.innerHTML="";
report.emsalHavuzu.forEach((e,i)=>{
el.innerHTML+=`<div class="emsal-liste-item">
<div><b>Emsal ${i+1}</b><br>${e.f1||""} - ${e.f10||""} TL</div>
<button onclick="sil('${e.id}')">Sil</button>
</div>`;
});
raporUret();
}

function raporUret(){
let m="EMSALLER\n----------------\n";
report.emsalHavuzu.forEach((e,i)=>{
m+=`${i+1}) ${e.f1||""} - ${e.f10||""} TL\n`;
});
document.getElementById("yorumMetni").innerText=m;
}

function sil(id){
report.emsalHavuzu=report.emsalHavuzu.filter(x=>x.id!==id);
localStorage.setItem("gayrimenkul_reports",JSON.stringify(reports));
listele();
}

function formuAc(){document.getElementById("emsalFormContainer").style.display="block";}
function formuKapat(){document.getElementById("emsalFormContainer").style.display="none";}
function anaMenuyeDon(){location.href="rapor-detay.html?rid="+rid;}

listele();
</script>

<script src="mobil-fix.js"></script>
</body>
</html>

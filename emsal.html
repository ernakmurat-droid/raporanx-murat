<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Profesyonel Emsal Analiz Sistemi - Raporan X</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Senin tek kaynak config'in -->
  <script src="firebase-config.js"></script>

  <link rel="stylesheet" href="mobil-fix.css">

  <style>
    :root { --primary:#1a237e; --secondary:#3f51b5; --success:#2e7d32; --bg:#f4f7f6; --danger:#c62828; --warning:#fbc02d; }
    * { box-sizing:border-box; }

    body{ font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; padding-bottom:120px; color:#333; }
    .header{
      background:var(--primary); color:#fff; padding:25px; text-align:center;
      position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.2);
    }
    .back{
      position:absolute; left:15px; top:22px; background:rgba(255,255,255,.2);
      padding:8px 15px; border-radius:20px; color:#fff; text-decoration:none; font-weight:bold;
      cursor:pointer; border:none;
    }

    .status-bar{
      padding:12px; text-align:center; font-weight:900; position:sticky; top:92px; z-index:999;
      transition:.25s; box-shadow:0 2px 5px rgba(0,0,0,.1); font-size:14px;
    }
    .status-incomplete{ background:var(--warning); color:#111; }
    .status-complete{ background:var(--success); color:#fff; }

    .container{ max-width:980px; margin:20px auto; padding:0 20px; }
    .card{ background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05); margin-bottom:20px; border:1px solid #e0e6ed; }
    .section-title{ color:var(--primary); font-size:1.1rem; font-weight:900; border-bottom:2px solid #eee; padding-bottom:8px; margin-bottom:15px; }
    .grid-form{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }
    .input-group label{ display:block; font-size:13px; font-weight:700; color:#555; margin-bottom:5px; }
    .input-group input,.input-group select{ width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:14px; outline:none; }

    .btn{ padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:900; transition:.2s; }
    .btn:active{ transform: translateY(1px); }
    .btn-add{ background:var(--success); color:#fff; width:100%; box-shadow:0 4px 10px rgba(46,125,50,.2); }
    .btn-save-final{ background:var(--primary); color:#fff; width:100%; padding:18px; font-size:18px; margin-top:15px; }

    .final-box{
      background:#fff; border:2px solid #ddd; padding:25px; border-radius:12px;
      white-space:pre-wrap; font-size:15px; line-height:1.8; color:#333; min-height:140px;
      user-select:none; -webkit-user-select:none; transition:filter .25s ease;
    }
    .final-box:not(:hover){ filter:blur(2px); }

    .emsal-liste-item{
      background:#f8f9fa; padding:12px; border-radius:8px; margin-bottom:8px;
      border-left:5px solid var(--primary); display:flex; justify-content:space-between; align-items:center;
      gap:12px; font-size:14px;
    }
    .emsal-liste-item button{
      padding:8px 10px; border:none; border-radius:8px; cursor:pointer;
      background:var(--primary); color:#fff; font-weight:900;
    }
    .emsal-liste-item .del{ background:var(--danger); margin-left:6px; }

    .bbbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px; border:1px solid #e0e6ed; border-radius:12px; background:#fff; margin-bottom:16px;
    }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .bbTab{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:900; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }

    .hidden{ display:none !important; }
    .insaat-toggle{
      background:#fff3e0; border:1px solid #ffe0b2; padding:15px; border-radius:8px; margin-bottom:15px;
      display:flex; align-items:center; gap:10px; font-weight:900; color:#e65100;
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">← Menü</button>
    <h1>EMSAL ANALİZİ VE DEĞERLEME</h1>
    <div id="raporBilgi">Yükleniyor...</div>
  </div>

  <div id="durumCubugu" class="status-bar status-incomplete">
    ⚠️ Analiz İçin Veri Girişi Bekleniyor...
  </div>

  <div class="container">
    <div class="bbbar">
      <div style="font-weight:900; color:var(--primary);">Bağımsız Bölüm Seç:</div>
      <div class="bbTabs" id="bbTabs"></div>
      <div class="hint" style="font-size:11px; color:#c62828; margin-top:5px; width:100%;">
        Not: Her BB için birim fiyatı girip “Sisteme Kaydet” demelisiniz.
      </div>
    </div>

    <div class="section-title">1. Kayıtlı Emsaller (ORTAK HAVUZ)</div>
    <div id="emsalListesi"></div>
    <button class="btn btn-add" onclick="formuAc()">+ YENİ EMSAL ARAŞTIRMASI EKLE</button>

    <div id="emsalFormContainer" class="card" style="display:none; border-top:5px solid var(--primary);">
      <div class="section-title">Emsal Detay Girişi</div>
      <input type="hidden" id="editEmsalId" value="">

      <div class="grid-form">
        <div class="input-group"><label>(1) Kaynağı</label><input type="text" id="f1" onfocus="this.select();"></div>
        <div class="input-group"><label>(2) İletişim Telefonu</label><input type="text" id="f2" oninput="formatPhone(this)"></div>
        <div class="input-group"><label>(3) Konum/Yakınlık</label><input type="text" id="f3" onfocus="this.select();"></div>
        <div class="input-group"><label>(4) Bina Kat Sayısı</label><input type="number" id="f4"></div>
        <div class="input-group"><label>(5) Bulunduğu Kat</label><input type="text" id="f5" onfocus="this.select();"></div>
        <div class="input-group"><label>(6) Oda Sayısı</label><input type="text" id="f6" onfocus="this.select();"></div>
        <div class="input-group"><label>(7) Beyan Alan (m²)</label><input type="number" id="f7"></div>
        <div class="input-group"><label>(8) Tahmini Alan (m²)</label><input type="number" id="f8" oninput="hesapla()"></div>
        <div class="input-group"><label>(9) Taşınmaz Cinsi</label><input type="text" id="f9" placeholder="Örn: daire"></div>

        <div class="input-group">
          <label>(10) İstenen Fiyat (TL)</label>
          <input type="text" id="f10mask" oninput="formatMoneyInput(this); hesapla();">
          <input type="hidden" id="f10">
        </div>

        <div class="input-group"><label>(11) Durumu</label>
          <select id="f11">
            <option value="satılıktır">Satılıktır</option>
            <option value="kiralıktır">Kiralıktır</option>
          </select>
        </div>

        <div class="input-group"><label>(14) Pazarlık Payı % (-)</label><input type="number" id="f14" value="5" oninput="hesapla()"></div>
        <div class="input-group"><label>(12) Şerefiye Olumlu % (+)</label><input type="number" id="f12" value="0" oninput="hesapla()"></div>
        <div class="input-group"><label>(13) Şerefiye Olumsuz % (-)</label><input type="number" id="f13" value="0" oninput="hesapla()"></div>

        <div class="input-group" style="grid-column:span 2;">
          <label>(17) Düzeltilmiş Birim Değer (m²)</label>
          <input type="text" id="f17" readonly style="background:#e8f5e9; font-weight:900; color:#2e7d32;">
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-save-final" onclick="emsalKaydet()" style="flex:2; margin:0;">LİSTEYE İŞLE VE MÜHÜRLE</button>
        <button class="btn" onclick="formuKapat()" style="flex:1; background:#9e9e9e; color:white;">İPTAL</button>
      </div>
    </div>

    <div class="insaat-toggle">
      <input type="checkbox" id="chkinsaat" onchange="toggleInsaat(); finalHesapla();">
      <label for="chkinsaat" style="cursor:pointer;">İnşaat Seviyeli (Mevcut Durum) Değerleme Yap</label>
    </div>

    <div id="insaatdetay" class="card hidden">
      <div class="grid-form">
        <div class="input-group"><label>Mevcut İnşaat Seviyesi (%)</label><input type="number" id="inpseviye" value="81" oninput="finalHesapla()"></div>
        <div class="input-group"><label>Eksik İmalat (TL)</label>
          <input type="text" id="inpeksikmask" oninput="formatMoneyInput(this); finalHesapla();">
          <input type="hidden" id="inpeksik">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">2. Değerleme ve Birim Analizi (SEÇİLİ BB: <span id="activeBBTitle">...</span>)</div>
      <div class="grid-form">
        <div class="input-group"><label>Bölge Alt Sınır (TL/m²)</label>
          <input type="text" id="inpdusukmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpdusuk">
        </div>
        <div class="input-group"><label>Bölge Üst Sınır (TL/m²)</label>
          <input type="text" id="inpyuksekmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpyuksek">
        </div>
        <div class="input-group"><label>Uygulanan Birim (TL/m²)</label>
          <input type="text" id="inpuygulananmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpuygulanan">
        </div>
        <div class="input-group"><label>Yasal Brüt Alan (m²)</label>
          <input type="text" id="resbrut" readonly style="background:#eee; font-weight:900;">
        </div>
        <div class="input-group"><label>Proje Dışı İlave Alan (m²)</label><input type="number" id="inpprojedisi" oninput="finalHesapla()"></div>
        <div class="input-group"><label>İlave Alan Birim Değeri (TL/m²)</label>
          <input type="text" id="inpprojebirimmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpprojebirim">
        </div>
      </div>
    </div>

    <div class="section-title">3. Özet Analiz Metni (TÜM BÖLÜMLER)</div>
    <div id="yorumMetni" class="final-box" oncopy="return false"></div>

    <button class="btn btn-save-final" onclick="tumRaporuKaydet()">
      ANALİZİ KAYDET VE BULUTA YEDEKLE
    </button>
  </div>
<script>
  // Firebase
  const auth = window.auth || firebase.auth();
  const db   = window.db   || firebase.firestore();

  // URL
  const params = new URLSearchParams(window.location.search);
  let rid = params.get("rid");
  let id  = params.get("id"); // eski sistem

  // Storage
  const STORAGE_KEY = "gayrimenkul_reports";

  // ===== Helpers =====
  function el(...ids){
    for(const x of ids){
      const n = document.getElementById(x);
      if(n) return n;
    }
    return null;
  }
  function val(...ids){
    const n = el(...ids);
    return n ? n.value : "";
  }
  function setVal(v, ...ids){
    const n = el(...ids);
    if(n) n.value = v;
  }

  function toNum(x){
    if(x === null || x === undefined) return 0;
    const s = String(x).trim();
    if(!s) return 0;
    // "1.234.567" / "1.234,5" / "1234,5" vs.
    const cleaned = s.replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const n = parseFloat(cleaned);
    return isNaN(n) ? 0 : n;
  }

  function formatLira(num){
    return new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0);
  }
  function formatLira0(num){
    return new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num || 0);
  }

  function formatMoneyInput(input){
    let v = (input.value || "").replace(/\D/g,"");
    input.value = v ? new Intl.NumberFormat("tr-TR").format(v) : "";
    const targetId = input.id.replace("_mask","").replace("mask","");
    const target = document.getElementById(targetId);
    if(target) target.value = v;
  }

  function formatPhone(input){
    let x = input.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
    input.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
  }

  // ===== Storage load (array/object) =====
  function loadAllReportsRaw(){
    try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "null"); }
    catch(e){ return null; }
  }
  function toArray(raw){
    if(Array.isArray(raw)) return raw;
    if(raw && typeof raw === "object") return Object.values(raw);
    return [];
  }

  function findReport(){
    const raw = loadAllReportsRaw();
    const arr = toArray(raw);

    if(rid){
      const i = arr.findIndex(r => r && r.rid === rid);
      if(i >= 0) return { raw, arr, i, report: arr[i] };
    }

    if(id){
      if(raw && typeof raw === "object" && !Array.isArray(raw) && raw[id]){
        return { raw, arr, i: -999, report: raw[id], key: id };
      }
      const j = arr.findIndex(r => r && (String(r.id)===String(id) || String(r.legacyId)===String(id)));
      if(j >= 0) return { raw, arr, i: j, report: arr[j] };
    }

    return { raw, arr, i: -1, report: null };
  }

  function saveReport(updatedReport){
    const found = findReport();
    const raw = found.raw;

    if(raw && typeof raw === "object" && !Array.isArray(raw) && found.key){
      raw[found.key] = updatedReport;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(raw));
      return;
    }

    const arr = found.arr || [];
    if(found.i >= 0){
      arr[found.i] = updatedReport;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      return;
    }

    console.warn("saveReport: rapor bulunamadı, yazılmadı");
  }

  // ===== Pool unify =====
  function getPool(report){
    const pool =
      (Array.isArray(report?.emsaller) ? report.emsaller : null) ||
      (Array.isArray(report?.emsalHavuzu) ? report.emsalHavuzu : null) ||
      [];
    report.emsaller = pool;
    report.emsalHavuzu = pool;
    return pool;
  }

  // ===== Active BB =====
  let activeBBIndex = 0;

  function ensureBBList(report){
    if(!Array.isArray(report.bbDetayList) || report.bbDetayList.length === 0){
      report.bbDetayList = [{ bbid:"bb_1", baslik:"1. BB", bbDetay:{} }];
    }
  }

  function getActiveBB(report){
    if(Array.isArray(report?.bbDetayList) && report.bbDetayList[activeBBIndex]) return report.bbDetayList[activeBBIndex];
    return null;
  }

  // ✅ BRÜT: eski/yeni tüm şemaları yakala + input fallback
  function getBrutAny(bb, report){
    const v =
      bb?.bbDetay?.alanBrut ??
      bb?.bbDetay?.alan_brut ??
      bb?.bbDetay?.brutAlan ??
      bb?.bbDetay?.brut ??
      bb?.alanBrut ??
      bb?.alan_brut ??
      bb?.alanBRUT ??
      report?.bbDetay?.alanBrut ??
      report?.bbDetay?.alan_brut ??
      report?.tasinmazBrut ??
      report?.tasinmaz_brut ??
      report?.alanBrut ??
      report?.alan_brut ??
      0;

    const fromObj = toNum(v);
    if(fromObj > 0) return fromObj;

    // son çare: ekrandaki input (resbrut/res_brut)
    const inputBrut = toNum(val("resbrut","res_brut"));
    return inputBrut;
  }

  function setBrutToUI(report){
    const bb = getActiveBB(report);
    const brut = getBrutAny(bb, report);
    if(brut > 0) setVal(brut, "resbrut","res_brut");
    return brut;
  }

  function renderBBTabs(){
    const tabs = el("bbTabs");
    if(!tabs) return;

    const { report } = findReport();
    if(!report){ tabs.innerHTML = ""; return; }

    ensureBBList(report);

    tabs.innerHTML = report.bbDetayList.map((bb, idx)=>{
      const cls = (idx === activeBBIndex) ? "bbTab active" : "bbTab";
      const title = bb.baslik || (idx+1)+". BB";
      return `<button type="button" class="${cls}" onclick="setActiveBB(${idx})">${title}</button>`;
    }).join("");
  }

  window.setActiveBB = function(idx){
    activeBBIndex = idx;
    renderBBTabs();

    const { report } = findReport();
    if(report) setBrutToUI(report);

    finalHesapla();
  };

  // ===== Status =====
  function veriKontrol(report){
    const bar = el("durumCubugu");
    if(!bar) return;
    const pool = getPool(report);
    const count = pool.length;
    const check = val("inp_uygulanan","inpuygulanan");
    if(count >= 1 && toNum(check) > 0){
      bar.textContent = "✅ ANALİZ PARAMETRELERİ TAMAMLANDI";
      bar.className = "status-bar status-complete";
    }else{
      bar.textContent = "⚠️ EKSİK VERİ: " + (count === 0 ? "[Emsal Yok] " : "") + (!check ? "[Birim Fiyat Yok]" : "");
      bar.className = "status-bar status-incomplete";
    }
  }

  // ===== Emsal hesap =====
  function hesapla(){
    const fiyat = toNum(val("f10","f10")) || 0;
    const alan  = toNum(val("f8","f8")) || 1;
    const paz   = toNum(val("f14","f14")) || 0;
    const sP    = toNum(val("f12","f12")) || 0;
    const sM    = toNum(val("f13","f13")) || 0;

    const birim = (fiyat * (1 - paz/100) / alan) * (1 + (sP - sM)/100);
    setVal(formatLira(birim) + " TL/m²", "f17","f17");
  }

  function emsalMetinUret(e){
    const f10Val = toNum(e.f10 || 0);
    const f8Val  = toNum(e.f8  || 1) || 1;

    const netSeref = toNum(e.f12||0) - toNum(e.f13||0);
    const shStr = netSeref !== 0 ? `, % ${netSeref} şerefiye` : "";

    const hesapSatiri = `(${formatLira(f10Val / f8Val)} TL/m², -% ${e.f14 || 0} pazarlık${shStr} : ${e.f17 || ""})`;
    const anaMetin =
      `${(e.f1 || "İSİMSİZ").toUpperCase()} (${e.f2 || "."}) Değerlemeye konu taşınmazla ${e.f3 || "."} konumlu, ` +
      `${e.f4 || "."} katlı binanın ${e.f5 || "."} katında konumlu, ${e.f6 || "."} tipindeki, ` +
      `${e.f7 || "."} m² kullanım alanlı beyan edilen, ${e.f8 || "."} m² alanlı tahmin edilen, ` +
      `${e.f9 || "daire"} ${new Intl.NumberFormat('tr-TR').format(f10Val)} TL bedel ile ${e.f11 || "satılıktır"}.`;

    return { anaMetin, hesapSatiri };
  }

  // ===== TEK METİN ÜRETİMİ =====
  function getOzetForBB(bb){
    // varsa BB içine kaydedilmiş değerleme özetleri
    return bb?.degerlemeOzet || bb?.degerleme || bb?.emsalOzet || null;
  }

  function finalHesapla(){
    const { report } = findReport();
    const out = el("yorumMetni");
    if(!out) return;

    if(!report){
      out.innerText =
        "⚠️ RAPOR BULUNAMADI.\n\n" +
        "Muhtemel sebep: linkte id/rid yok veya kayıt başka cihazda.\n" +
        "Çözüm: Rapor Detay’dan bu modülü tekrar aç.";
      return;
    }

    ensureBBList(report);
    const pool = getPool(report);

    // UI brütü güncel tut
    setBrutToUI(report);

    const dusuk  = toNum(val("inp_dusuk","inpdusuk"));
    const yuksek = toNum(val("inp_yuksek","inpyuksek"));

    let metin = `EMSAL BİLGİLERİ\n------------------------------------------\n`;
    if(pool.length === 0){
      metin += "Henüz emsal girilmemiştir.\n\n";
    }else{
      pool.forEach((e, i) => {
        const built = emsalMetinUret(e);
        metin += `${i+1}) ${built.anaMetin}\n\n`;
      });
    }

    metin += `EMSALLERİN YORUMU\n------------------------------------------\n`;
    metin += `Emsal Karşılaştırma Yöntemine Göre Değer Analizi\n`;
    metin += `Taşınmazın değer tespitinde "Emsal Karşılaştırma Yöntemi" kullanılmıştır. `;
    metin += `Değerlemeye konu mülk ile emsal mülkler benzer özelliklerde ve birbirlerine baz alınabilecek niteliktedir. `;
    if(dusuk > 0 && yuksek > 0){
      metin += `Emsal mülklerin m² birim fiyatları ${formatLira0(dusuk)} TL ile ${formatLira0(yuksek)} TL arasındadır. `;
    }else{
      metin += `Emsal mülklerin m² birim fiyatları bölge alt/üst sınır aralığında değerlendirilmiştir. `;
    }
    metin += `Yapılan analizler sonucunda konu mülkün tüm özellikleri ve bölge emlak komisyoncularından alınan bilgiler göz önünde bulundurulmuştur.\n\n`;

    metin += `DEĞERLEME SONUÇLARI\n------------------------------------------\n`;

    // ✅ Çoklu BB: alt alta
    report.bbDetayList.forEach((bb, idx)=>{
      const baslik = bb.baslik || (idx+1)+". BB";

      const oz = getOzetForBB(bb) || {};

      // Birim fiyat: BB özetinde varsa onu al, yoksa sayfadaki inputu al
      const uyg = toNum(oz.uygulananBirim ?? oz.uygBirim ?? val("inp_uygulanan","inpuygulanan") ?? 0);

      // İlave alan: BB özetinde varsa onu al, yoksa sayfadaki inputu al
      const ilaveAlan  = toNum(oz.projeDisiAlan ?? oz.ilaveAlan ?? val("inpprojedisi","inp_projedisi") ?? 0);
      const ilaveBirim = toNum(oz.projeDisiBirim ?? oz.ilaveBirim ?? val("inpprojebirim","inp_projebirim") ?? 0);

      const brut = getBrutAny(bb, report);

      const yasalDeger  = Math.round(uyg * brut);
      const ilaveDeger  = Math.round(ilaveAlan * ilaveBirim);
      const mevcutDeger = Math.round(yasalDeger + ilaveDeger);

      if(ilaveAlan > 0 && ilaveBirim > 0){
        metin += `■ ${baslik}: Konu taşınmaza ${formatLira0(uyg)} TL/m² birim fiyatı üzerinden `;
        metin += `${formatLira0(uyg)} TL/m² x ${brut} m² : ${formatLira0(yasalDeger)} TL yasal değer, `;
        metin += `proje harici büyüme ile birlikte ${ilaveAlan} m² x ${formatLira0(ilaveBirim)} TL/m² : ${formatLira0(ilaveDeger)} TL `;
        metin += `eklenerek toplam mevcut değer ${formatLira0(mevcutDeger)} TL uygun görülmüştür.\n`;
      }else{
        metin += `■ ${baslik}: Konu taşınmaza ${formatLira0(uyg)} TL/m² birim fiyatı üzerinden `;
        metin += `${formatLira0(uyg)} TL/m² x ${brut} m² : ${formatLira0(yasalDeger)} TL yasal değer uygun görülmüştür.\n`;
      }
    });

    metin += `\nSonuç olarak yasal ve mevcut değer takdir edilmiştir.\n`;

    metin += `\nEMSAL HESAP SATIRLARI\n------------------------------------------\n`;
    if(pool.length){
      pool.forEach((e, i) => {
        const built = emsalMetinUret(e);
        metin += `- Emsal ${i+1}: ${built.hesapSatiri}\n`;
      });
    }

    out.innerText = metin;
    veriKontrol(report);
  }

  function listele(){
    const { report } = findReport();
    const list = el("emsalListesi");
    if(!list) return;

    if(!report){
      list.innerHTML = `<div class="card" style="border-left:5px solid #c62828;">Rapor bulunamadı.</div>`;
      finalHesapla();
      return;
    }

    ensureBBList(report);
    const pool = getPool(report);
    list.innerHTML = "";

    pool.forEach((e, i) => {
      list.innerHTML += `
        <div class="emsal-liste-item">
          <div><strong>Emsal ${i+1}</strong>: ${e.f1 || ""}</div>
          <div>
            <button onclick="formuAc(${i})" style="border:none; background:#e3f2fd; color:#1976d2; padding:5px 10px; border-radius:4px; cursor:pointer;">Düzenle</button>
            <button onclick="emsalSil(${i})" style="border:none; background:#ffebee; color:#d32f2f; padding:5px 10px; border-radius:4px; cursor:pointer; margin-left:5px;">Sil</button>
          </div>
        </div>
      `;
    });

    finalHesapla();
  }

  // ===== Form open/close =====
  window.formuAc = function(index=-1){
    const box = el("emsalFormContainer");
    if(box) box.style.display = "block";

    setVal(String(index), "editIndex", "editEmsalId");

    const { report } = findReport();
    const pool = report ? getPool(report) : [];
    const e = (index >= 0 && pool[index]) ? pool[index] : null;

    for(let k=1; k<=14; k++){
      const idA = "f"+k;
      const n = el(idA);
      if(!n) continue;
      n.value = e ? (e[idA] || "") : (k===14 ? "5" : "");
    }

    const f10mask = el("f10_mask","f10mask");
    const f10 = el("f10");
    if(f10mask && f10){
      const v = e ? (e.f10 || "") : "";
      f10.value = v;
      f10mask.value = v ? new Intl.NumberFormat("tr-TR").format(v) : "";
    }

    hesapla();
  }

  window.formuKapat = function(){
    const box = el("emsalFormContainer");
    if(box) box.style.display = "none";
  }

  window.emsalKaydet = async function(){
    const { report } = findReport();
    if(!report){ alert("Rapor bulunamadı."); return; }

    const pool = getPool(report);

    const idxRaw = val("editIndex","editEmsalId");
    const index = parseInt(idxRaw,10);

    let e = {};
    for(let k=1; k<=14; k++){
      const idA = "f"+k;
      const n = el(idA);
      if(n) e[idA] = n.value;
    }
    e.f10 = val("f10","f10");
    e.f17 = val("f17","f17");

    const built = emsalMetinUret(e);
    e.anaMetin = built.anaMetin;
    e.hesapSatiri = built.hesapSatiri;

    if(index > -1 && pool[index]) pool[index] = e;
    else pool.push(e);

    report.emsaller = pool;
    report.emsalHavuzu = pool;

    saveReport(report);
    window.formuKapat();
    listele();
  }

  window.emsalSil = async function(index){
    const { report } = findReport();
    if(!report) return;
    if(!confirm("Silinsin mi?")) return;

    const pool = getPool(report);
    pool.splice(index, 1);

    report.emsaller = pool;
    report.emsalHavuzu = pool;

    saveReport(report);
    listele();
  }

  window.toggleInsaat = function(){
    const det = el("insaatdetay");
    const chk = el("chkinsaat");
    if(det && chk) det.classList.toggle("hidden", !chk.checked);
    finalHesapla();
  }

  window.tumRaporuKaydet = async function(){
    const { report } = findReport();
    if(!report){ alert("Rapor bulunamadı."); return; }

    const metin = (el("yorumMetni")?.innerText || "").trim();
    report.emsalFinalMetni = metin;
    if(!report.modules) report.modules = {};
    if(!report.modules.emsal) report.modules.emsal = {};
    report.modules.emsal.text = metin;

    saveReport(report);

    if(auth.currentUser){
      try{
        const rawNow = loadAllReportsRaw();
        await db.collection("users").doc(auth.currentUser.uid).set({
          gayrimenkul_reports: rawNow,
          sonGuncelleme: new Date().toISOString()
        }, { merge:true });
        alert("✅ Kaydedildi ve buluta mühürlendi.");
      }catch(e){
        alert("Bulut hatası: " + (e.message || e));
      }
    }else{
      alert("✅ Yerel hafızaya kaydedildi.");
    }
  }

  window.anaMenuyeDon = function(){
    if(id) window.location.href = `rapor-detay.html?id=${encodeURIComponent(id)}`;
    else if(rid) window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
    else window.location.href = "rapor-detay.html";
  }

  // global
  window.formatMoneyInput = formatMoneyInput;
  window.formatPhone = formatPhone;
  window.hesapla = hesapla;
  window.finalHesapla = finalHesapla;
  window.listele = listele;

  // INIT
  auth.onAuthStateChanged((user)=>{
    if(!user){ window.location.href = "index.html"; return; }

    const { report } = findReport();
    const raporBilgi = el("raporBilgi");
    if(raporBilgi){
      raporBilgi.textContent = (report && (report.propertyName || report.mulkAdi))
        ? (report.propertyName || report.mulkAdi)
        : "Analiz Dosyası";
    }

    if(report){
      ensureBBList(report);
      renderBBTabs();
      setBrutToUI(report);
    }

    listele();
    finalHesapla();
  });
</script>


</body>
</html>





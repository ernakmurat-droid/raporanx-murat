<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profesyonel Emsal Analiz Sistemi - Raporan X</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary:#1a237e; --secondary:#3f51b5; --success:#2e7d32; --bg:#f4f7f6; --danger:#c62828; }
    * { box-sizing:border-box; }

    body { font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; padding-bottom:120px; color:#333; }
    .header { background:var(--primary); color:#fff; padding:25px; text-align:center; position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.2); }
    .back { position:absolute; left:15px; top:22px; background:rgba(255,255,255,.2); padding:8px 15px; border-radius:20px; color:#fff; text-decoration:none; font-weight:bold; cursor:pointer; border:none; }
    .container { max-width:980px; margin:20px auto; padding:0 20px; }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05); margin-bottom:20px; border:1px solid #e0e6ed; }
    .section-title { color:var(--primary); font-size:1.1rem; font-weight:bold; border-bottom:2px solid #eee; padding-bottom:8px; margin-bottom:15px; }
    .grid-form { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }
    .input-group label { display:block; font-size:13px; font-weight:600; color:#555; margin-bottom:5px; }
    .input-group input, .input-group select { width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:14px; outline:none; }
    .btn { padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:.2s; }
    .btn:active { transform: translateY(1px); }
    .btn-add { background:var(--success); color:#fff; width:100%; box-shadow:0 4px 10px rgba(46,125,50,.2); }
    .btn-save-final { background:var(--primary); color:#fff; margin-top:15px; }

    .final-box{
      background:#fff;
      border:2px solid #ddd;
      padding:25px;
      border-radius:12px;
      white-space:pre-wrap;
      font-size:15px;
      line-height:1.8;
      color:#333;
      min-height:140px;
      user-select:none;
      transition:filter .25s ease;
    }
    .final-box:not(:hover){ filter:blur(2px); }

    .insaat-toggle{
      background:#fff3e0;
      border:1px solid #ffe0b2;
      padding:15px;
      border-radius:8px;
      margin-bottom:15px;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:bold;
      color:#e65100;
    }
    .hidden{ display:none !important; }

    .emsal-liste-item{
      background:#f8f9fa;
      padding:12px;
      border-radius:8px;
      margin-bottom:8px;
      border-left:5px solid var(--primary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      gap:12px;
    }
    .emsal-liste-item button{
      padding:8px 10px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      font-weight:bold;
    }
    .emsal-liste-item .del{ background:var(--danger); margin-left:6px; }

    .bbbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border:1px solid #e0e6ed;
      border-radius:12px;
      background:#fff;
      margin-bottom:16px;
    }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .bbTab{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:bold; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }
  </style>

  <link rel="stylesheet" href="mobil-fix.css">
</head>

<body>
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼</button>
    <h1>EMSAL ANALÄ°ZÄ° VE DEÄERLEME</h1>
    <div id="raporBilgi">YÃ¼kleniyor...</div>
  </div>

  <div class="container">
    <div class="bbbar">
      <div style="font-weight:bold; color:var(--primary);">BaÄŸÄ±msÄ±z BÃ¶lÃ¼m SeÃ§:</div>
      <div class="bbTabs" id="bbTabs"></div>
      <div class="hint" style="font-size:11px; color:#c62828; margin-top:5px; width:100%;">
        Not: Her BB iÃ§in birim fiyatÄ± girip "Sisteme Kaydet" demelisiniz.
      </div>
    </div>

    <div class="section-title">1. KayÄ±tlÄ± Emsaller (ORTAK HAVUZ)</div>
    <div id="emsalListesi"></div>
    <button class="btn btn-add" onclick="formuAc()">+ YENÄ° EMSAL ARAÅTIRMASI EKLE</button>

    <div id="emsalFormContainer" class="card" style="display:none; border-top:5px solid var(--primary);">
      <div class="section-title">Emsal Detay GiriÅŸi</div>
      <div class="grid-form">
        <div class="input-group"><label>(1) KaynaÄŸÄ±</label><input type="text" id="f1"></div>
        <div class="input-group"><label>(2) Ä°letiÅŸim Telefonu</label><input type="text" id="f2" oninput="formatPhone(this)"></div>
        <div class="input-group"><label>(3) Konum/YakÄ±nlÄ±k</label><input type="text" id="f3"></div>
        <div class="input-group"><label>(4) Bina Kat SayÄ±sÄ±</label><input type="number" id="f4"></div>
        <div class="input-group"><label>(5) BulunduÄŸu Kat</label><input type="text" id="f5"></div>
        <div class="input-group"><label>(6) Oda SayÄ±sÄ±</label><input type="text" id="f6"></div>
        <div class="input-group"><label>(7) Beyan Alan (mÂ²)</label><input type="number" id="f7"></div>
        <div class="input-group"><label>(8) Tahmini Alan (mÂ²)</label><input type="number" id="f8" oninput="hesapla()"></div>
        <div class="input-group"><label>(9) TaÅŸÄ±nmaz Cinsi</label><input type="text" id="f9"></div>

        <div class="input-group">
          <label>(10) Ä°stenen Fiyat (TL)</label>
          <input type="text" id="f10mask" oninput="formatMoneyInput(this); hesapla();">
          <input type="hidden" id="f10">
        </div>

        <div class="input-group"><label>(11) Durumu</label>
          <select id="f11">
            <option value="satÄ±lÄ±ktÄ±r">SatÄ±lÄ±ktÄ±r</option>
            <option value="kiralÄ±ktÄ±r">KiralÄ±ktÄ±r</option>
          </select>
        </div>

        <div class="input-group"><label>(14) PazarlÄ±k PayÄ± %</label><input type="number" id="f14" value="5" oninput="hesapla()"></div>
        <div class="input-group"><label>(12) Åerefiye (+)</label><input type="number" id="f12" value="0" oninput="hesapla()"></div>
        <div class="input-group"><label>(13) Åerefiye (-)</label><input type="number" id="f13" value="0" oninput="hesapla()"></div>

        <div class="input-group" style="grid-column:span 2;">
          <label>(17) DÃ¼zeltilmiÅŸ Birim DeÄŸer (mÂ²)</label>
          <input type="text" id="f17" readonly style="background:#e8f5e9; font-weight:bold; color:#2e7d32;">
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-save-final" onclick="emsalKaydet()" style="flex:2; margin:0;">VERÄ°YÄ° HAVUZA EKLE</button>
        <button class="btn" onclick="formuKapat()" style="flex:1; background:#9e9e9e; color:white;">Ä°PTAL</button>
      </div>
    </div>

    <div class="insaat-toggle">
      <input type="checkbox" id="chkinsaat" onchange="toggleInsaat(); finalHesapla();">
      <label for="chkinsaat" style="cursor:pointer;">Ä°nÅŸaat Seviyeli (Mevcut Durum) DeÄŸerleme Yap</label>
    </div>

    <div id="insaatdetay" class="card hidden">
      <div class="grid-form">
        <div class="input-group"><label>Mevcut Ä°nÅŸaat Seviyesi (%)</label><input type="number" id="inpseviye" value="81" oninput="finalHesapla()"></div>
        <div class="input-group"><label>Eksik Ä°malat (TL)</label>
          <input type="text" id="inpeksikmask" oninput="formatMoneyInput(this); finalHesapla();">
          <input type="hidden" id="inpeksik">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">2. DeÄŸerleme ve Birim Analizi (SEÃ‡Ä°LÄ° BB: <span id="activeBBTitle">...</span>)</div>
      <div class="grid-form">
        <div class="input-group"><label>BÃ¶lge Alt SÄ±nÄ±r (Birim mÂ²)</label>
          <input type="text" id="inpdusukmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpdusuk">
        </div>
        <div class="input-group"><label>BÃ¶lge Ãœst SÄ±nÄ±r (Birim mÂ²)</label>
          <input type="text" id="inpyuksekmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpyuksek">
        </div>
        <div class="input-group"><label>BU BB Ä°Ã‡Ä°N UYGULANAN BÄ°RÄ°M (mÂ²)</label>
          <input type="text" id="inpuygulananmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpuygulanan">
        </div>
        <div class="input-group"><label>Yasal BrÃ¼t Alan (mÂ²)</label>
          <input type="text" id="resbrut" readonly style="background:#eee; font-weight:bold;">
        </div>
        <div class="input-group"><label>Varsa Ä°lave Alan (mÂ²)</label><input type="number" id="inpprojedisi" oninput="finalHesapla()"></div>
        <div class="input-group"><label>Ä°lave Alan Birim DeÄŸeri (mÂ²)</label>
          <input type="text" id="inpprojebirimmask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inpprojebirim">
        </div>
      </div>
    </div>

    <div class="section-title">3. Ã–zet Analiz Metni (TÃœM BÃ–LÃœMLER)</div>
    <div id="yorumMetni" class="final-box"></div>

    <button class="btn btn-save-final" style="width:100%; padding:22px; font-size:20px; background:#1a237e; border:4px solid #3f51b5; margin-top:30px;" onclick="tumRaporuKaydet()">
      ğŸ’¾ TÃœM BÃ–LÃœMLERÄ° VE HESAPLARI SÄ°STEME MÃœHÃœRLE
    </button>
  </div>

  <script>
 const auth = firebase.auth();
const db = firebase.firestore();

const params = new URLSearchParams(window.location.search);
let rid = params.get('rid');
const legacyId = params.get('id');

function genRid(){
  try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
  return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
}

// rid yoksa veya localStorageâ€™da bulunamazsa: legacyId ile bul, rid Ã¼ret, rapora yaz, URL'i dÃ¼zelt
function resolveRidAndMigrateIfNeeded(arr){
  // 1) rid varsa ve bulunuyorsa ok
  if (rid) {
    const idx = arr.findIndex(r => r && r.rid === rid);
    if (idx >= 0) return { arr, idx, report: arr[idx] };
  }

  // 2) rid yoksa / bulunamadÄ±ysa legacyId ile dene
  if (legacyId) {
    const idx2 = arr.findIndex(r => r && (r.id === legacyId || r.legacyId === legacyId));
    if (idx2 >= 0) {
      // rapora rid yoksa ekle
      if (!arr[idx2].rid) arr[idx2].rid = genRid();
      rid = arr[idx2].rid;

      // URL'i rid ile yenile (kullanÄ±cÄ± fark etmez)
      const newUrl = `${location.pathname}?rid=${encodeURIComponent(rid)}`;
      history.replaceState(null, "", newUrl);

      return { arr, idx: idx2, report: arr[idx2] };
    }
  }

  return { arr, idx: -1, report: null };
}

function getLatestData(){
  const arr = JSON.parse(localStorage.getItem('gayrimenkulreports')) || [];
  const resolved = resolveRidAndMigrateIfNeeded(arr);
  return { arr: resolved.arr, i: resolved.idx, r: resolved.report };
}

function persist(arr, i, r){
  if(i < 0) return;
  arr[i] = r;
  localStorage.setItem('gayrimenkulreports', JSON.stringify(arr));
}


    let activeBBIndex = 0;

    function formatMoneyInput(input) {
      let value = (input.value || "").replace(/\D/g, "");
      input.value = value ? new Intl.NumberFormat('tr-TR').format(value) : "";
      const hid = input.id.replace("mask", "");
      if (document.getElementById(hid)) document.getElementById(hid).value = value;
    }

    function formatPhone(input) {
      let x = input.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
      input.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
    }

    function toggleInsaat() {
      document.getElementById('insaatdetay').classList.toggle('hidden', !document.getElementById('chkinsaat').checked);
    }

    function formatLira(num) { return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0); }
    function formatLira0(num) { return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num || 0); }

    function renderBBTabs(){
      const { r } = getLatestData();
      if (!r || !r.bbDetayList) return;
      const el = document.getElementById("bbTabs");
      el.innerHTML = r.bbDetayList.map((x, idx) => {
        const active = idx === activeBBIndex ? "bbTab active" : "bbTab";
        const title = x.baslik || ((idx+1) + ". BB");
        return `<button type="button" class="${active}" onclick="setActiveBB(${idx})">${title}</button>`;
      }).join("");
    }

    function setActiveBB(idx){
      saveBBSettingsToObject(); // eskisini kaydet
      activeBBIndex = idx;
      renderBBTabs();
      refreshActiveBBUI();
    }

    function setMoneyPair(hid, mid, val){
      if(document.getElementById(hid)) document.getElementById(hid).value = (val ?? "");
      if(document.getElementById(mid)) document.getElementById(mid).value = val ? new Intl.NumberFormat('tr-TR').format(val) : "";
    }

    function refreshActiveBBUI(){
      const { r } = getLatestData();
      if (!r || !r.bbDetayList || !r.bbDetayList[activeBBIndex]) return;

      const bb = r.bbDetayList[activeBBIndex];
      document.getElementById('activeBBTitle').innerText = bb.baslik || ((activeBBIndex+1) + ". BB");
      document.getElementById('resbrut').value = bb.bbDetay?.alanBrut || 0;

      const oz = bb.degerlemeOzet || {};
      setMoneyPair('inpdusuk', 'inpdusukmask', oz.dusukBirim);
      setMoneyPair('inpyuksek', 'inpyuksekmask', oz.yuksekBirim);
      setMoneyPair('inpuygulanan', 'inpuygulananmask', oz.uygulananBirim);
      setMoneyPair('inpprojebirim', 'inpprojebirimmask', oz.projeDisiBirim);

      document.getElementById('inpprojedisi').value = oz.projeDisiAlan || "";
      document.getElementById('chkinsaat').checked = (oz.insaatAktif === "1");
      toggleInsaat();
      document.getElementById('inpseviye').value = oz.insaatSeviye || 81;
      setMoneyPair('inpeksik', 'inpeksikmask', oz.eksikImalat);

      listele();
    }

    function saveBBSettingsToObject(){
      const { arr, i, r } = getLatestData();
      if(!r || !r.bbDetayList || !r.bbDetayList[activeBBIndex]) return;

      const bb = r.bbDetayList[activeBBIndex];
      if(!bb.degerlemeOzet) bb.degerlemeOzet = {};

      bb.degerlemeOzet.uygulananBirim = document.getElementById('inpuygulanan').value;
      bb.degerlemeOzet.dusukBirim = document.getElementById('inpdusuk').value;
      bb.degerlemeOzet.yuksekBirim = document.getElementById('inpyuksek').value;
      bb.degerlemeOzet.projeDisiAlan = document.getElementById('inpprojedisi').value;
      bb.degerlemeOzet.projeDisiBirim = document.getElementById('inpprojebirim').value;
      bb.degerlemeOzet.insaatAktif = document.getElementById('chkinsaat').checked ? "1" : "0";
      bb.degerlemeOzet.insaatSeviye = document.getElementById('inpseviye').value;
      bb.degerlemeOzet.eksikImalat = document.getElementById('inpeksik').value;

      persist(arr, i, r);
    }

    function emsalMetinUret(e){
      const fy = e.f10 ? new Intl.NumberFormat('tr-TR').format(e.f10) : "...";
      return `â–º ${(e.f1||'').toUpperCase()} (${e.f2||''}) TaÅŸÄ±nmazla ${(e.f3||'')}, ${(e.f4||'')} katlÄ± binanÄ±n ${(e.f5||'')}. katÄ±nda ${(e.f6||'')} tipinde, ${(e.f7||'')}mÂ² beyan, ${(e.f8||'')}mÂ² tahmin edilen ${(e.f9||'')} ${fy} TL ile ${(e.f11||'')}.`;
    }

    function hesapla() {
      const f = parseFloat(document.getElementById('f10').value) || 0;
      const a = parseFloat(document.getElementById('f8').value) || 1;
      const p = parseFloat(document.getElementById('f14').value) || 0;
      const sP = parseFloat(document.getElementById('f12').value) || 0;
      const sM = parseFloat(document.getElementById('f13').value) || 0;

      const b = (f * (1 - p/100) / a) * (1 + (sP - sM)/100);
      document.getElementById('f17').value = formatLira(b);
    }

    function listele() {
      const { r } = getLatestData();
      const list = document.getElementById('emsalListesi');
      list.innerHTML = "";

      if (r && r.emsalHavuzu) {
        r.emsalHavuzu.forEach((e, idx) => {
          list.innerHTML += `
            <div class="emsal-liste-item">
              <div><strong>Emsal ${idx+1}</strong>: ${formatLira0(e.f10)} TL / ${e.f8}mÂ² â†’ ${e.f17} TL/mÂ²</div>
              <div>
                <button onclick="formuAcById('${e.emsalId}')">DÃ¼zenle</button>
                <button class="del" onclick="emsalSil('${e.emsalId}')">Sil</button>
              </div>
            </div>
          `;
        });
      }

      finalHesapla();
    }

    function finalHesapla() {
      const { r } = getLatestData();
      if(!r) return;

      let metin = `EMSAL BÄ°LGÄ°LERÄ°\n------------------------------------------\n`;
      (r.emsalHavuzu || []).forEach((e, idx) => {
        metin += `${idx+1}) ${emsalMetinUret(e)}\n\n`;
      });

      metin += `EMSALLERÄ°N YORUMU\n------------------------------------------\n`;
      metin += `TaÅŸÄ±nmazÄ±n deÄŸer tespitinde "Emsal KarÅŸÄ±laÅŸtÄ±rma YÃ¶ntemi" kullanÄ±lmÄ±ÅŸtÄ±r. `;

      const dusuk = document.getElementById('inpdusuk').value;
      const yuksek = document.getElementById('inpyuksek').value;
      if (dusuk && yuksek) {
        metin += `BÃ¶lgedeki emsal mÂ² birim fiyatlarÄ± ${formatLira0(dusuk)} - ${formatLira0(yuksek)} TL aralÄ±ÄŸÄ±ndadÄ±r. `;
      }

      metin += `\n\nDEÄERLEME SONUÃ‡LARI\n------------------------------------------\n`;

      (r.bbDetayList || []).forEach((bb) => {
        const oz = bb.degerlemeOzet || {};
        const alan = parseFloat(bb.bbDetay?.alanBrut) || 0;
        const uyg = parseFloat(oz.uygulananBirim) || 0;

        const projeAlan = parseFloat(oz.projeDisiAlan) || 0;
        const projeBirim = parseFloat(oz.projeDisiBirim) || 0;

        // Final DeÄŸer
        const bitDeg = Math.round((uyg * alan) + (projeAlan * projeBirim));

        if (oz.insaatAktif === "1") {
          const sev = parseFloat(oz.insaatSeviye) || 0;
          const eks = parseFloat(oz.eksikImalat) || 0;
          const son = Math.round(bitDeg * (sev/100) - eks);
          metin += `â–  ${bb.baslik || ''}: TaÅŸÄ±nmazÄ±n tamamlanmÄ±ÅŸ deÄŸeri ${formatLira0(bitDeg)} TL olup, %${sev} inÅŸaat seviyesine gÃ¶re mevcut durum deÄŸeri ~${formatLira0(son)} TL olarak takdir edilmiÅŸtir.\n`;
        } else {
          metin += `â–  ${bb.baslik || ''}: TaÅŸÄ±nmazÄ±n mÂ² birim deÄŸeri ${formatLira0(uyg)} TL takdir edilmiÅŸ olup, toplam yasal deÄŸeri ~${formatLira0(bitDeg)} TL'dir.\n`;
        }
      });

      document.getElementById('yorumMetni').innerText = metin;
    }

    async function tumRaporuKaydet() {
      saveBBSettingsToObject(); // Ã¶nce aktif olanÄ± kaydet
      const { arr, i, r } = getLatestData();
      if(!r) return;

      const uretilenMetin = document.getElementById('yorumMetni').innerText;

      // âœ… TÃœM SÄ°STEMLERE MÃœHÃœRLE
      r.emsalFinalMetni = uretilenMetin;
      if(!r.modules) r.modules = {};
      if(!r.modules.emsal) r.modules.emsal = {};
      r.modules.emsal.text = uretilenMetin;

      // Her BB iÃ§ine de kopyala
      (r.bbDetayList || []).forEach(bb => {
        if(!bb.degerlemeOzet) bb.degerlemeOzet = {};
        bb.degerlemeOzet.emsalFinalMetni = uretilenMetin;
      });

      persist(arr, i, r);

      if (auth.currentUser) {
        try {
          await db.collection("users").doc(auth.currentUser.uid).set({ gayrimenkulreports: arr }, { merge: true });
          alert("âœ… BaÅŸarÄ±lÄ±! TÃ¼m BB hesaplarÄ± mÃ¼hÃ¼rlendi ve buluta iÅŸlendi.");
        } catch(e) {
          alert("Bulut hatasÄ±: " + e.message);
        }
      } else {
        alert("âœ… Yerel hafÄ±zaya kaydedildi.");
      }

      listele();
    }

    function emsalKaydet() {
      const { arr, i, r } = getLatestData();
      if(!r) return;
      if(!r.emsalHavuzu) r.emsalHavuzu = [];

      const editId = document.getElementById('editEmsalId')?.value;

      const e = {
        emsalId: editId || ('emsal' + Date.now()),
        f1: document.getElementById('f1').value,
        f2: document.getElementById('f2').value,
        f3: document.getElementById('f3').value,
        f4: document.getElementById('f4').value,
        f5: document.getElementById('f5').value,
        f6: document.getElementById('f6').value,
        f7: document.getElementById('f7').value,
        f8: document.getElementById('f8').value,
        f9: document.getElementById('f9').value,
        f10: document.getElementById('f10').value,
        f11: document.getElementById('f11').value,
        f12: document.getElementById('f12').value,
        f13: document.getElementById('f13').value,
        f14: document.getElementById('f14').value,
        f17: document.getElementById('f17').value
      };

      if(editId) {
        const idx = r.emsalHavuzu.findIndex(x => x.emsalId === editId);
        if(idx >= 0) r.emsalHavuzu[idx] = e;
        else r.emsalHavuzu.push(e);
      } else {
        r.emsalHavuzu.push(e);
      }

      persist(arr, i, r);
      formuKapat();
      listele();
    }

    function emsalSil(id) {
      if(!confirm("Emsal silinsin mi?")) return;
      const { arr, i, r } = getLatestData();
      if(!r) return;

      r.emsalHavuzu = (r.emsalHavuzu || []).filter(x => x.emsalId !== id);
      persist(arr, i, r);
      listele();
    }

    function formuAcById(id){
      const { r } = getLatestData();
      if(!r) return;

      const e = (r.emsalHavuzu || []).find(x => x.emsalId === id);
      if(!e) return;

      document.getElementById('emsalFormContainer').style.display = 'block';

      if(!document.getElementById('editEmsalId')){
        const h = document.createElement('input');
        h.type='hidden'; h.id='editEmsalId';
        document.body.appendChild(h);
      }
      document.getElementById('editEmsalId').value = id;

      for(let k=1; k<=14; k++){
        if(document.getElementById('f'+k)) document.getElementById('f'+k).value = e['f'+k] || "";
      }
      setMoneyPair('f10','f10mask', e.f10);
      hesapla();
    }

    function formuAc(){
      document.getElementById('emsalFormContainer').style.display = 'block';
      if(document.getElementById('editEmsalId')) document.getElementById('editEmsalId').value = "";

      for(let k=1; k<=14; k++){
        if(document.getElementById('f'+k)) document.getElementById('f'+k).value = (k==14 ? 5 : "");
      }
      setMoneyPair('f10','f10mask', "");
      document.getElementById('f17').value = "";
    }

    function formuKapat(){ document.getElementById('emsalFormContainer').style.display = 'none'; }

    function anaMenuyeDon() {
      window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid || "")}`;
    }
auth.onAuthStateChanged((user) => {
  if (!user) { window.location.href = 'index.html'; return; }

  const { r } = getLatestData();

  if(!r){
    document.getElementById('raporBilgi').innerText = "Rapor bulunamadÄ± (rid/id).";
    document.getElementById('yorumMetni').innerText =
      "âš ï¸ Bu rapor bu cihazda bulunamadÄ±. Muhtemelen linkte rid yok veya kayÄ±t baÅŸka cihazda.\n\n" +
      "Ã‡Ã¶zÃ¼m: Rapor Detay sayfasÄ±ndan tekrar Emsal modÃ¼lÃ¼nÃ¼ aÃ§ (rid ile).";
    return;
  }

  document.getElementById('raporBilgi').innerText = r.mulkAdi || r.propertyName || "Emsal Analizi";

  // BB listesi yoksa da metin Ã¼retelim
  if(!Array.isArray(r.bbDetayList)) r.bbDetayList = [];

  renderBBTabs();
  refreshActiveBBUI();
  finalHesapla(); // <-- bunu Ã¶zellikle ekledim
});


  </script>

  <script src="mobil-fix.js"></script>
</body>
</html>


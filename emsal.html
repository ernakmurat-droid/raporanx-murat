<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Profesyonel Emsal Analiz Sistemi</title>

  <!-- Firebase (TEK SEFER) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCMwx6S6rq1lnNJuHOxc38ij3qU4ankSxs",
      authDomain: "raporanx.firebaseapp.com",
      projectId: "raporanx",
      storageBucket: "raporanx.firebasestorage.app",
      messagingSenderId: "715194328346",
      appId: "1:715194328346:web:46f0bb98941e01ead6f8a3",
      measurementId: "G-V749P1HB80"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Guard: login + id
    auth.onAuthStateChanged((user) => {
      const urlParams = new URLSearchParams(window.location.search);
      const rid = urlParams.get('id');

      if (!user) {
        alert("⚠️ Erişim yok! Lütfen giriş yapın.");
        window.location.href = 'index.html';
        return;
      }
      if (!rid) {
        alert("⚠️ İşlem yapılacak rapor seçilmedi!");
        window.location.href = 'index.html';
        return;
      }
    });

    // Sadece emsal alanlarını merge yazar (ezme yok)
    async function bulutaEmsalKaydet(reportId, payload) {
      const user = auth.currentUser;
      if (!user) throw new Error("Kullanıcı oturumu yok");
      return db.collection("kullanicilar")
        .doc(user.uid)
        .collection("raporlar")
        .doc(String(reportId))
        .set({
          ...payload,
          sonGuncelleme: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
    }
  </script>

  <style>
    :root {
      --primary: #1a237e;
      --secondary: #3f51b5;
      --success: #2e7d32;
      --danger: #c62828;
      --bg: #f5f7fa;
      --card-bg: white;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      margin: 0;
      color: #222;
      line-height: 1.5;
    }

    .header {
      background: var(--primary);
      color: white;
      padding: 1.2rem 1.5rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 3px 12px rgba(0,0,0,0.25);
    }

    .back-btn {
      position: absolute;
      left: 1rem;
      top: 1rem;
      background: rgba(255,255,255,0.25);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 600;
    }

    .container {
      max-width: 1000px;
      margin: 1.5rem auto;
      padding: 0 1rem;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border: 1px solid #e0e7ff;
    }

    .section-title {
      color: var(--primary);
      font-size: 1.15rem;
      font-weight: 700;
      border-bottom: 2px solid #e0e7ff;
      padding-bottom: 0.5rem;
      margin-bottom: 1rem;
    }

    .grid-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1rem;
    }

    .input-group label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: #444;
      margin-bottom: 0.35rem;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 0.95rem;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(63,81,181,0.15);
    }

    .input-group input[readonly] {
      background: #f0fdf4;
      font-weight: 600;
      color: #166534;
    }

    .btn {
      padding: 0.7rem 1.2rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.15s;
    }

    .btn-primary   { background: var(--primary);   color: white; }
    .btn-success   { background: var(--success);   color: white; }
    .btn-danger    { background: #ef4444;          color: white; }
    .btn-secondary { background: #64748b;          color: white; }

    .btn:hover { opacity: 0.92; transform: translateY(-1px); }

    .final-box {
      background: white;
      border: 2px solid #e2e8f0;
      padding: 1.5rem;
      border-radius: 10px;
      white-space: pre-wrap;
      font-size: 0.97rem;
      line-height: 1.7;
      min-height: 140px;
      user-select: none;
      transition: filter 0.4s;
    }

    .final-box:not(:hover) { filter: blur(3.5px); }

    .insaat-toggle {
      background: #fffbeb;
      border: 1px solid #fef3c7;
      padding: 1rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      display: flex;
      align-items: center;
      gap: 0.8rem;
      color: #92400e;
      font-weight: 600;
    }

    .emsal-item {
      background: #f8fafc;
      padding: 0.9rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.6rem;
      border-left: 4px solid var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.92rem;
    }

    @media print {
      body * { visibility: hidden; }
      .final-box, .final-box * { visibility: visible; }
      .final-box::before {
        content: "BU BİLGİLER KORUMALIDIR - TİCARİ SIR";
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        font-size: 4rem;
        color: #dc2626;
        font-weight: bold;
        opacity: 0.25;
        pointer-events: none;
      }
    }
  </style>
</head>

<body oncontextmenu="return false;">

  <div class="header">
    <button class="back-btn" onclick="anaMenuyeDon()">← Menü</button>
    <h1>EMSAL ANALİZİ & DEĞERLEME</h1>
    <div id="raporBilgi">Yükleniyor...</div>
  </div>

  <div class="container">

    <div class="section-title">1. Kayıtlı Emsal Araştırmaları</div>
    <div id="emsalListesi"></div>
    <button class="btn btn-success" onclick="formuAc()">+ Yeni Emsal Ekle</button>

    <div id="emsalFormContainer" class="card" style="display:none;">
      <div class="section-title">Emsal Detay Girişi</div>
      <input type="hidden" id="editIndex" value="-1">

      <div class="grid-form">
        <div class="input-group"><label>(1) Kaynak (Emlakçı/İsim)</label><input id="f1" list="h_f1"></div>
        <div class="input-group"><label>(2) Telefon</label><input id="f2" placeholder="(5XX) XXX XX XX" oninput="formatPhone(this)"></div>
        <div class="input-group"><label>(3) Konum / Yakınlık</label><input id="f3" list="h_f3"></div>
        <div class="input-group"><label>(4) Bina Kat Sayısı</label><input type="number" id="f4" min="1"></div>
        <div class="input-group"><label>(5) Bulunduğu Kat</label><input id="f5" list="h_f5"></div>
        <div class="input-group"><label>(6) Oda Sayısı (X+Y)</label><input id="f6" list="h_f6"></div>
        <div class="input-group"><label>(7) Beyan Alanı (m²)</label><input type="number" id="f7" min="0"></div>
        <div class="input-group"><label>(8) Tahmini Net Alan (m²)</label><input type="number" id="f8" min="1" oninput="hesaplaBirim()"></div>
        <div class="input-group"><label>(9) Taşınmaz Cinsi</label><input id="f9" list="h_f9"></div>

        <div class="input-group">
          <label>(10) İstenen Fiyat (TL)</label>
          <input id="f10_mask" oninput="formatMoney(this); hesaplaBirim();">
          <input type="hidden" id="f10">
        </div>

        <div class="input-group">
          <label>(11) Durum</label>
          <select id="f11">
            <option value="satılıktır">Satılık</option>
            <option value="kiralıktır">Kiralık</option>
          </select>
        </div>

        <div class="input-group"><label>(14) Pazarlık Payı (%)</label><input type="number" id="f14" value="5" min="0" oninput="hesaplaBirim()"></div>
        <div class="input-group"><label>(12) Şerefiye Olumlu (%)</label><input type="number" id="f12" value="0" oninput="hesaplaBirim()"></div>
        <div class="input-group"><label>(13) Şerefiye Olumsuz (%)</label><input type="number" id="f13" value="0" oninput="hesaplaBirim()"></div>

        <div class="input-group" style="grid-column: 1 / -1;">
          <label>Düzeltilmiş Birim Fiyat (TL/m²)</label>
          <input id="f17" readonly style="font-weight:bold; font-size:1.1rem;">
        </div>
      </div>

      <div style="display:flex; gap:0.8rem; margin-top:1.5rem;">
        <button class="btn btn-primary" style="flex:2;" onclick="emsalKaydet()">Kaydet & Listeye Ekle</button>
        <button class="btn btn-secondary" onclick="formuKapat()">İptal</button>
      </div>
    </div>

    <div class="insaat-toggle">
      <input type="checkbox" id="chk_insaat" onchange="toggleInsaat()">
      <label for="chk_insaat" style="cursor:pointer;">İnşaat seviyeli (mevcut durum) değerleme yap</label>
    </div>

    <div id="insaat_detay" class="card" style="display:none;">
      <div class="grid-form">
        <div class="input-group"><label>Mevcut İnşaat Seviyesi (%)</label><input type="number" id="inp_seviye" value="80" min="0" max="100" oninput="hesaplaSonMetin()"></div>
        <div class="input-group">
          <label>Eksik İmalat Tutarı (TL)</label>
          <input id="inp_eksik_mask" oninput="formatMoney(this); hesaplaSonMetin();">
          <input type="hidden" id="inp_eksik">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">2. Değerleme ve Birim Fiyat Analizi</div>
      <div class="grid-form">
        <div class="input-group"><label>Bölge Alt Sınır (TL/m²)</label><input id="inp_dusuk_mask" oninput="formatMoney(this); hesaplaSonMetin();"><input type="hidden" id="inp_dusuk"></div>
        <div class="input-group"><label>Bölge Üst Sınır (TL/m²)</label><input id="inp_yuksek_mask" oninput="formatMoney(this); hesaplaSonMetin();"><input type="hidden" id="inp_yuksek"></div>
        <div class="input-group"><label>Uygulanan Birim Fiyat (TL/m²)</label><input id="inp_uygulanan_mask" oninput="formatMoney(this); hesaplaSonMetin();"><input type="hidden" id="inp_uygulanan"></div>
        <div class="input-group"><label>Yasal Brüt Alan (m²)</label><input id="res_brut" readonly></div>
        <div class="input-group"><label>Proje Dışı İlave Alan (m²)</label><input type="number" id="inp_proje_disi" min="0" oninput="hesaplaSonMetin()"></div>
        <div class="input-group"><label>İlave Alan Birim Fiyatı (TL/m²)</label><input id="inp_proje_birim_mask" oninput="formatMoney(this); hesaplaSonMetin();"><input type="hidden" id="inp_proje_birim"></div>
      </div>
    </div>

    <div class="section-title">3. Rapor Metni (Korumalı)</div>
    <div id="yorumMetni" class="final-box"></div>

    <button class="btn btn-success" style="width:100%; padding:1.2rem; font-size:1.15rem; margin-top:1.5rem;" onclick="tumRaporuKaydet()">
      ANALİZİ KAYDET VE KİLİTLE
    </button>
  </div>

  <div style="display:none">
    <datalist id="h_f1"></datalist>
    <datalist id="h_f3"></datalist>
    <datalist id="h_f5"></datalist>
    <datalist id="h_f6"></datalist>
    <datalist id="h_f9"></datalist>
  </div>

  <script>
    const urlParams = new URLSearchParams(location.search);
    const id = urlParams.get('id');

    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports') || '[]');
    let report = reports[id] || { emsaller: [] };
    if (!report.emsaller) report.emsaller = [];

    const tasinmazBrut = Number(report.bbDetay?.alanBrut || 0);

    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === 'c' || e.key === 'p' || e.key === 's' || e.key === 'u')) e.preventDefault();
    });

    window.onload = () => {
      if (!report || !report.propertyName) {
        alert("Rapor verisi bulunamadı!");
        return;
      }

      document.getElementById('raporBilgi').textContent = report.propertyName || "Yeni Analiz";
      document.getElementById('res_brut').value = tasinmazBrut.toLocaleString('tr-TR');

      if (report.bbDetay?.ilaveBrut) document.getElementById('inp_proje_disi').value = report.bbDetay.ilaveBrut;

      yukleOzet(report.degerlemeOzet);
      initDatalistAutocomplete();
      listeleEmsaller();
      hesaplaSonMetin();
    };

    function formatMoney(el) {
      let val = el.value.replace(/\D/g, '');
      el.value = val ? Number(val).toLocaleString('tr-TR') : '';
      const hidden = document.getElementById(el.id.replace('_mask',''));
      if (hidden) hidden.value = val;
    }

    function formatPhone(el) {
      const cleaned = el.value.replace(/\D/g, '');
      const match = cleaned.match(/^(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})$/);
      if (!match) return;
      el.value = !match[2] ? match[1] :
        '(' + match[1] + ') ' + match[2] +
        (match[3] ? ' ' + match[3] : '') +
        (match[4] ? ' ' + match[4] : '');
    }

    function hesaplaBirim() {
      const fiyat    = Number(document.getElementById('f10').value) || 0;
      const alan     = Number(document.getElementById('f8').value)  || 1;
      const pazarlik = Number(document.getElementById('f14').value) || 0;
      const sArti    = Number(document.getElementById('f12').value) || 0;
      const sEksi    = Number(document.getElementById('f13').value) || 0;

      const netSerefiye = sArti - sEksi;
      let birim = (fiyat / alan) * (1 - pazarlik/100);
      if (netSerefiye !== 0) birim *= (1 + netSerefiye/100);

      document.getElementById('f17').value = birim.toLocaleString('tr-TR', { minimumFractionDigits: 0 }) + ' TL';
    }

    function emsalKaydet() {
      const index = Number(document.getElementById('editIndex').value);
      const data = {};

      for (let i = 1; i <= 17; i++) {
        const el = document.getElementById('f' + i);
        if (el) data['f' + i] = el.value;
      }

      const hamBirim = Math.round(Number(data.f10 || 0) / Math.max(1, Number(data.f8 || 1)));
      const netSerefiye = (Number(data.f12) || 0) - (Number(data.f13) || 0);
      const shStr = netSerefiye ? `, %${netSerefiye} şerefiye` : '';

      data.hesapSatiri = `(${hamBirim.toLocaleString('tr-TR')} TL/m², -%${data.f14||0} pazarlık${shStr} → ${data.f17})`;

      const kaynak = (data.f1 || 'BELİRTİLMEMİŞ').toUpperCase();

      // ✅ İSTEDİĞİN DÜZENLEME BURADA
      data.anaMetin =
        `${kaynak} (${data.f2 || '—'}) - Değerlemeye konu taşınmazla ${data.f3||'…'} konumda bulunan, ` +
        `${data.f4||'…'} katlı binanın ${data.f5||'…'} katında, ${data.f6||'…'} oda, ${data.f7||'…'} m² beyan, ` +
        `${data.f8||'…'} m² tahmini, ${data.f9||'daire'}, ${Number(data.f10||0).toLocaleString('tr-TR')} TL ile ${data.f11}.`;

      ['f1','f3','f5','f6','f9'].forEach(key => {
        if (!data[key]) return;
        let arr = JSON.parse(localStorage.getItem('h_emsal_' + key) || '[]');
        arr = arr.filter(v => v !== data[key]);
        arr.unshift(data[key]);
        localStorage.setItem('h_emsal_' + key, JSON.stringify(arr.slice(0,12)));
      });

      if (index >= 0) report.emsaller[index] = data;
      else report.emsaller.push(data);

      document.getElementById('emsalFormContainer').style.display = 'none';
      initDatalistAutocomplete();
      listeleEmsaller();
      hesaplaSonMetin();
    }

    function listeleEmsaller() {
      const container = document.getElementById('emsalListesi');
      container.innerHTML = '';

      report.emsaller.forEach((emsal, i) => {
        const div = document.createElement('div');
        div.className = 'emsal-item';
        div.innerHTML = `
          <div>
            <strong>Emsal ${i+1}</strong><br>
            <small>${(emsal.anaMetin||'').substring(0,120)}${(emsal.anaMetin||'').length > 120 ? '...' : ''}</small>
          </div>
          <div style="white-space:nowrap;">
            <button class="btn btn-primary" onclick="formuAc(${i})">Düzenle</button>
            <button class="btn btn-danger" onclick="emsalSil(${i})" style="margin-left:0.5rem;">Sil</button>
          </div>`;
        container.appendChild(div);
      });

      hesaplaSonMetin();
    }

    function emsalSil(i) {
      if (!confirm("Bu emsal tamamen silinecek. Emin misiniz?")) return;
      report.emsaller.splice(i, 1);
      listeleEmsaller();
    }

    function formuAc(index = -1) {
      const form = document.getElementById('emsalFormContainer');
      document.getElementById('editIndex').value = index;

      if (index === -1) {
        ['f1','f2','f3','f4','f5','f6','f7','f8','f9','f10','f10_mask'].forEach(fid => {
          const el = document.getElementById(fid);
          if (el) el.value = '';
        });
        document.getElementById('f12').value = '0';
        document.getElementById('f13').value = '0';
        document.getElementById('f14').value = '5';
        document.getElementById('f17').value = '';
      } else {
        const e = report.emsaller[index] || {};
        for (let i = 1; i <= 14; i++) {
          const el = document.getElementById('f' + i);
          if (!el) continue;
          if (i === 10) {
            document.getElementById('f10').value = e.f10 || '';
            document.getElementById('f10_mask').value = e.f10 ? Number(e.f10).toLocaleString('tr-TR') : '';
          } else {
            el.value = e['f' + i] || '';
          }
        }
        document.getElementById('f17').value = e.f17 || '';
        hesaplaBirim();
      }

      form.style.display = 'block';
      document.getElementById('f1').focus();
    }

    function formuKapat() {
      document.getElementById('emsalFormContainer').style.display = 'none';
    }

    function toggleInsaat() {
      const checked = document.getElementById('chk_insaat').checked;
      document.getElementById('insaat_detay').style.display = checked ? 'block' : 'none';
      hesaplaSonMetin();
    }

    function formatLira(n) {
      return Number(n).toLocaleString('tr-TR', { minimumFractionDigits: 0 });
    }

    function hesaplaSonMetin() {
      const dusuk      = Number(document.getElementById('inp_dusuk').value) || 0;
      const yuksek     = Number(document.getElementById('inp_yuksek').value) || 0;
      const uygulanan  = Number(document.getElementById('inp_uygulanan').value) || 0;
      const ilaveAlan  = Number(document.getElementById('inp_proje_disi').value) || 0;
      const ilaveBirim = Number(document.getElementById('inp_proje_birim').value) || 0;

      const yasalDeger  = Math.round(uygulanan * tasinmazBrut);
      const ilaveDeger  = Math.round(ilaveBirim * ilaveAlan);
      const toplamDeger = yasalDeger + ilaveDeger;

      let metin = report.emsaller.map(e => e.anaMetin).join('\n\n');

      if (!document.getElementById('chk_insaat').checked) {
        metin += `\n\nTaşınmazın değerlemesinde Emsal Karşılaştırma Yöntemi kullanılmıştır.
Emsallerin birim fiyat aralığı ${formatLira(dusuk)} – ${formatLira(yuksek)} TL/m² arasındadır.

Yapılan analizler neticesinde konu taşınmaza ${formatLira(uygulanan)} TL/m² birim fiyatı uygun görülmüştür.

Yasal durum değeri : ${formatLira(uygulanan)} × ${tasinmazBrut} m² = ${formatLira(yasalDeger)} TL

${ilaveAlan > 0 ? `Proje dışı ilave ${ilaveAlan} m² × ${formatLira(ilaveBirim)} TL = ${formatLira(ilaveDeger)} TL\n` : ''}
Toplam mevcut durum değeri : ${formatLira(toplamDeger)} TL`;
      } else {
        const seviye = Number(document.getElementById('inp_seviye').value) || 80;
        const eksik  = Number(document.getElementById('inp_eksik').value)  || 0;
        const netDeger = toplamDeger - eksik;

        metin += `\n\n%${seviye} inşaat seviyesinde mevcut durum değerlendirmesi

Tamamlanmış hali için değer : ${formatLira(toplamDeger)} TL
Eksik imalat tutarı ≈ ${formatLira(eksik)} TL
Mevcut durum net değeri ≈ ${formatLira(netDeger)} TL`;
      }

      if (report.emsaller.length > 0) {
        metin += '\n\nEmsal Özet Tablosu\n' +
          report.emsaller.map((e,i) => `- Emsal ${i+1}: ${e.hesapSatiri}`).join('\n');
      }

      document.getElementById('yorumMetni').textContent = metin.trim();
    }

    async function tumRaporuKaydet() {
      report.degerlemeOzet = {
        dusukBirim:     document.getElementById('inp_dusuk').value,
        yuksekBirim:    document.getElementById('inp_yuksek').value,
        uygulananBirim: document.getElementById('inp_uygulanan').value,
        projeDisiAlan:  document.getElementById('inp_proje_disi').value,
        projeDisiBirim: document.getElementById('inp_proje_birim').value,
        isInsaat:       document.getElementById('chk_insaat').checked,
        seviye:         document.getElementById('inp_seviye').value,
        eksikTutar:     document.getElementById('inp_eksik').value,
        sonMetin:       document.getElementById('yorumMetni').textContent
      };

      reports[id] = report;
      localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

      try {
        await bulutaEmsalKaydet(id, {
          emsaller: report.emsaller,
          degerlemeOzet: report.degerlemeOzet,
          emsal_tamamlandi: true
        });
      } catch (e) {
        console.error(e);
        alert("⚠️ Buluta kaydedilemedi. (Local kayıt duruyor)");
        return;
      }

      alert("✅ Emsal analizi kaydedildi ve buluta yedeklendi.");
    }

    function yukleOzet(ozet) {
      if (!ozet) return;

      const set = (hid, val) => {
        const el = document.getElementById(hid);
        const mask = document.getElementById(hid + '_mask');
        if (el) el.value = val || '';
        if (mask) mask.value = val ? Number(val).toLocaleString('tr-TR') : '';
      };

      set('inp_dusuk', ozet.dusukBirim);
      set('inp_yuksek', ozet.yuksekBirim);
      set('inp_uygulanan', ozet.uygulananBirim);
      set('inp_proje_birim', ozet.projeDisiBirim);
      document.getElementById('inp_proje_disi').value = ozet.projeDisiAlan || '0';

      document.getElementById('chk_insaat').checked = !!ozet.isInsaat;
      document.getElementById('inp_seviye').value = ozet.seviye || '80';
      set('inp_eksik', ozet.eksikTutar);

      toggleInsaat();
    }

    function initDatalistAutocomplete() {
      const keys = ['f1','f3','f5','f6','f9'];
      keys.forEach(key => {
        const items = JSON.parse(localStorage.getItem('h_emsal_' + key) || '[]');
        const dl = document.getElementById('h_' + key);
        if (dl) dl.innerHTML = items.map(v => `<option value="${v}">`).join('');
      });
    }

    function anaMenuyeDon() {
      location.href = `rapor-detay.html?id=${id}`;
    }
  </script>
</body>
</html>

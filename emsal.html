<script>
function emsalKaydet() {
    const index = Number(document.getElementById('editIndex').value);
    const data = {};

    for (let i = 1; i <= 17; i++) {
        const el = document.getElementById('f' + i);
        if (el) data['f' + i] = el.value;
    }

    const hamBirim = Math.round(Number(data.f10 || 0) / Math.max(1, Number(data.f8 || 1)));
    const netSerefiye = (Number(data.f12) || 0) - (Number(data.f13) || 0);
    const shStr = netSerefiye ? `, %${netSerefiye} ÅŸerefiye` : '';

    data.hesapSatiri =
        `(${hamBirim.toLocaleString('tr-TR')} TL/mÂ², -%${data.f14||0} pazarlÄ±k${shStr} â†’ ${data.f17})`;

    const kaynak = (data.f1 || 'BELÄ°RTÄ°LMEMÄ°Åž').toUpperCase();

    /* ðŸ”¥ BURASI DÃœZELTÄ°LDÄ° */
    data.anaMetin =
        `${kaynak} (${data.f2 || 'â€”'}) - ` +
        `DeÄŸerlemeye konu taÅŸÄ±nmazla ${data.f3 || 'â€¦'} konumda bulunan, ` +
        `${data.f4 || 'â€¦'} katlÄ± binanÄ±n ${data.f5 || 'â€¦'} katÄ±nda, ` +
        `${data.f6 || 'â€¦'} oda, ${data.f7 || 'â€¦'} mÂ² beyan, ` +
        `${data.f8 || 'â€¦'} mÂ² tahmini alanlÄ± ${data.f9 || 'daire'}, ` +
        `${Number(data.f10 || 0).toLocaleString('tr-TR')} TL ile ${data.f11}.`;

    /* HafÄ±za */
    ['f1','f3','f5','f6','f9'].forEach(key => {
        if (!data[key]) return;
        let arr = JSON.parse(localStorage.getItem('h_emsal_' + key) || '[]');
        arr = arr.filter(v => v !== data[key]);
        arr.unshift(data[key]);
        localStorage.setItem('h_emsal_' + key, JSON.stringify(arr.slice(0,12)));
    });

    if (index >= 0) {
        report.emsaller[index] = data;
    } else {
        report.emsaller.push(data);
    }

    document.getElementById('emsalFormContainer').style.display = 'none';
    initDatalistAutocomplete();
    listeleEmsaller();
    hesaplaSonMetin();
}
</script>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profesyonel Emsal Analiz Sistemi - Raporan X</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary:#1a237e; --secondary:#3f51b5; --success:#2e7d32; --bg:#f4f7f6; --danger:#c62828; }
    * { box-sizing:border-box; }
    body { font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; padding-bottom:120px; color:#333; }
    .header { background:var(--primary); color:#fff; padding:25px; text-align:center; position:sticky; top:0; z-index:1000; box-shadow:0 2px 10px rgba(0,0,0,.2); }
    .back { position:absolute; left:15px; top:22px; background:rgba(255,255,255,.2); padding:8px 15px; border-radius:20px; color:#fff; text-decoration:none; font-weight:bold; cursor:pointer; border:none; }
    .container { max-width:980px; margin:20px auto; padding:0 20px; }
    .card { background:#fff; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,.05); margin-bottom:20px; border:1px solid #e0e6ed; }
    .section-title { color:var(--primary); font-size:1.1rem; font-weight:bold; border-bottom:2px solid #eee; padding-bottom:8px; margin-bottom:15px; }
    .grid-form { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; }
    .input-group label { display:block; font-size:13px; font-weight:600; color:#555; margin-bottom:5px; }
    .input-group input, .input-group select { width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:14px; outline:none; }
    .btn { padding:12px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; transition:.2s; }
    .btn:active { transform: translateY(1px); }
    .btn-add { background:var(--success); color:#fff; width:100%; box-shadow:0 4px 10px rgba(46,125,50,.2); }
    .btn-save-final { background:var(--primary); color:#fff; margin-top:15px; }
    .final-box{
      background:#fff;
      border:2px solid #ddd;
      padding:25px;
      border-radius:12px;
      white-space:pre-wrap;
      font-size:15px;
      line-height:1.8;
      color:#333;
      min-height:140px;
      user-select:none;
      transition:filter .25s ease;
    }
    .final-box:not(:hover){ filter:blur(2px); }

    .insaat-toggle{
      background:#fff3e0;
      border:1px solid #ffe0b2;
      padding:15px;
      border-radius:8px;
      margin-bottom:15px;
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:bold;
      color:#e65100;
    }
    .hidden{ display:none !important; }

    .emsal-liste-item{
      background:#f8f9fa;
      padding:12px;
      border-radius:8px;
      margin-bottom:8px;
      border-left:5px solid var(--primary);
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:14px;
      gap:12px;
    }
    .emsal-liste-item button{
      padding:8px 10px;
      border:none;
      border-radius:8px;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      font-weight:bold;
    }
    .emsal-liste-item .del{ background:var(--danger); margin-left:6px; }

    .bbbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      padding:12px;
      border:1px solid #e0e6ed;
      border-radius:12px;
      background:#fff;
      margin-bottom:16px;
    }
    .bbTabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .bbTab{ padding:10px 12px; border-radius:10px; border:1px solid #ddd; cursor:pointer; background:#fff; color:#333; font-weight:bold; }
    .bbTab.active{ background:var(--primary); color:#fff; border-color:transparent; }
    .hint{ font-size:12px; color:#666; margin-top:6px; }
    .mini-note{ font-size:12px; color:#666; margin-top:6px; }
  </style>

  <link rel="stylesheet" href="mobil-fix.css">
</head>

<body>
  <div class="header">
    <button onclick="anaMenuyeDon()" class="back">← Menü</button>
    <h1>EMSAL ANALİZİ VE DEĞERLEME</h1>
    <div id="raporBilgi">Yükleniyor...</div>
  </div>

  <div class="container">
    <div class="bbbar">
      <div style="font-weight:bold; color:var(--primary);">Bağımsız Bölüm Seç:</div>
      <div class="bbTabs" id="bbTabs"></div>
      <div class="hint">Emsaller ortaktır. Her BB için ayrı değer çıkarılır.</div>
    </div>

    <div class="section-title">1. Kayıtlı Emsaller (ORTAK)</div>
    <div id="emsalListesi"></div>
    <button class="btn btn-add" onclick="formuAc()">+ YENİ EMSAL ARAŞTIRMASI EKLE</button>

    <div id="emsalFormContainer" class="card" style="display:none; border-top:5px solid var(--primary);">
      <div class="section-title">Emsal Detay Girişi</div>
      <div class="grid-form">
        <div class="input-group"><label>(1) Kaynağı</label><input type="text" id="f1" list="h_f1"></div>
        <div class="input-group"><label>(2) İletişim Telefonu</label><input type="text" id="f2" oninput="formatPhone(this)"></div>
        <div class="input-group"><label>(3) Konum/Yakınlık</label><input type="text" id="f3" list="h_f3"></div>
        <div class="input-group"><label>(4) Bina Kat Sayısı</label><input type="number" id="f4"></div>
        <div class="input-group"><label>(5) Bulunduğu Kat</label><input type="text" id="f5" list="h_f5"></div>
        <div class="input-group"><label>(6) Oda Sayısı</label><input type="text" id="f6" list="h_f6"></div>
        <div class="input-group"><label>(7) Beyan Alan (m²)</label><input type="number" id="f7"></div>
        <div class="input-group"><label>(8) Tahmini Alan (m²)</label><input type="number" id="f8" oninput="hesapla()"></div>
        <div class="input-group"><label>(9) Taşınmaz Cinsi</label><input type="text" id="f9" list="h_f9"></div>
        <div class="input-group">
          <label>(10) İstenen Fiyat (TL)</label>
          <input type="text" id="f10_mask" oninput="formatMoneyInput(this); hesapla();">
          <input type="hidden" id="f10">
        </div>
        <div class="input-group"><label>(11) Durumu</label>
          <select id="f11">
            <option value="satılıktır">Satılıktır</option>
            <option value="kiralıktır">Kiralıktır</option>
          </select>
        </div>
        <div class="input-group"><label>(14) Pazarlık Payı %</label><input type="number" id="f14" value="5" oninput="hesapla()"></div>
        <div class="input-group"><label>(12) Şerefiye (+)</label><input type="number" id="f12" value="0" oninput="hesapla()"></div>
        <div class="input-group"><label>(13) Şerefiye (-)</label><input type="number" id="f13" value="0" oninput="hesapla()"></div>
        <div class="input-group" style="grid-column:span 2;">
          <label>(17) Düzeltilmiş Birim Değer</label>
          <input type="text" id="f17" readonly style="background:#e8f5e9; font-weight:bold; color:#2e7d32;">
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn btn-save-final" onclick="emsalKaydet()" style="flex:2; margin:0;">VERİYİ LİSTEYE İŞLE</button>
        <button class="btn" onclick="formuKapat()" style="flex:1; background:#9e9e9e; color:white;">İPTAL</button>
      </div>
    </div>

    <div class="insaat-toggle">
      <input type="checkbox" id="chk_insaat" onchange="toggleInsaat(); finalHesapla();">
      <label for="chk_insaat" style="cursor:pointer;">İnşaat Seviyeli (Mevcut Durum) Değerleme Yap</label>
    </div>

    <div id="insaat_detay" class="card hidden">
      <div class="grid-form">
        <div class="input-group"><label>Mevcut İnşaat Seviyesi (%)</label><input type="number" id="inp_seviye" value="81" oninput="finalHesapla()"></div>
        <div class="input-group"><label>Eksik İmalat (TL)</label>
          <input type="text" id="inp_eksik_mask" oninput="formatMoneyInput(this); finalHesapla();">
          <input type="hidden" id="inp_eksik">
        </div>
      </div>
    </div>

    <div class="card">
      <div class="section-title">2. Değerleme ve Birim Analizi (SEÇİLİ BB İÇİN)</div>
      <div class="grid-form">
        <div class="input-group"><label>Bölge Alt Sınır (MANUEL)</label>
          <input type="text" id="inp_dusuk_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_dusuk">
        </div>
        <div class="input-group"><label>Bölge Üst Sınır (MANUEL)</label>
          <input type="text" id="inp_yuksek_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_yuksek">
        </div>
        <div class="input-group"><label>Uygulanan Yasal Birim</label>
          <input type="text" id="inp_uygulanan_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_uygulanan">
        </div>
        <div class="input-group"><label>Yasal Brüt Alan (m²)</label>
          <input type="text" id="res_brut" readonly style="background:#eee; font-weight:bold;">
        </div>
        <div class="input-group"><label>İlave Alan (m²)</label><input type="number" id="inp_proje_disi" oninput="finalHesapla()"></div>
        <div class="input-group"><label>İlave Birim Değeri</label>
          <input type="text" id="inp_proje_birim_mask" oninput="formatMoneyInput(this); finalHesapla();"><input type="hidden" id="inp_proje_birim">
        </div>
      </div>
    </div>

    <div class="section-title">3. Rapor Analiz Metni</div>
    <div id="yorumMetni" class="final-box"></div>

    <button class="btn btn-save-final" style="width:100%; padding:18px; font-size:18px; background:#2e7d32;" onclick="tumRaporuKaydet()">
      ANALİZİ SİSTEME KAYDET VE BULUTA MÜHÜRLE
    </button>
  </div>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();

    const params = new URLSearchParams(window.location.search);
    let rid = params.get('rid');

    function getLatestData(){
      const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
      const i = arr.findIndex(r => r && r.rid === rid);
      return { arr, i, r: arr[i] || null };
    }

    function persist(arr, i, r){
      arr[i] = r;
      localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
    }

    let activeBBIndex = 0;

    function formatMoneyInput(input) {
      let value = (input.value || "").replace(/\D/g, "");
      input.value = value ? new Intl.NumberFormat('tr-TR').format(value) : "";
      const hid = input.id.replace("_mask", "");
      if (document.getElementById(hid)) document.getElementById(hid).value = value;
    }

    function formatPhone(input) {
      let x = input.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
      input.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? ' ' + x[3] : '') + (x[4] ? ' ' + x[4] : '');
    }

    function toggleInsaat() {
      document.getElementById('insaat_detay').classList.toggle('hidden', !document.getElementById('chk_insaat').checked);
    }

    function formatLira(num) { return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0); }
    function formatLira0(num) { return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(num || 0); }

    function renderBBTabs(){
      const { r } = getLatestData();
      if (!r || !r.bbDetayList) return;
      const el = document.getElementById("bbTabs");
      el.innerHTML = r.bbDetayList.map((x, idx) => {
        const active = idx === activeBBIndex ? "bbTab active" : "bbTab";
        return `<button type="button" class="${active}" onclick="setActiveBB(${idx})">${x.baslik || (idx+1)+'. BB'}</button>`;
      }).join("");
    }

    function setActiveBB(idx){
      saveBBSettingsToObject(); // eskini kaydet
      activeBBIndex = idx;
      renderBBTabs();
      refreshActiveBBUI();
    }

    function refreshActiveBBUI(){
      const { r } = getLatestData();
      if (!r || !r.bbDetayList[activeBBIndex]) return;
      const bb = r.bbDetayList[activeBBIndex];
      document.getElementById('res_brut').value = bb.bbDetay?.alanBrut || 0;
      
      const oz = bb.degerlemeOzet || {};
      setMoneyPair('inp_dusuk', 'inp_dusuk_mask', oz.dusukBirim);
      setMoneyPair('inp_yuksek', 'inp_yuksek_mask', oz.yuksekBirim);
      setMoneyPair('inp_uygulanan', 'inp_uygulanan_mask', oz.uygulananBirim);
      setMoneyPair('inp_proje_birim', 'inp_proje_birim_mask', oz.projeDisiBirim);
      document.getElementById('inp_proje_disi').value = oz.projeDisiAlan || "";
      document.getElementById('chk_insaat').checked = (oz.insaatAktif === "1");
      toggleInsaat();
      document.getElementById('inp_seviye').value = oz.insaatSeviye || 81;
      setMoneyPair('inp_eksik', 'inp_eksik_mask', oz.eksikImalat);
      listele();
    }

    function setMoneyPair(hid, mid, val){
      if(document.getElementById(hid)) document.getElementById(hid).value = val || "";
      if(document.getElementById(mid)) document.getElementById(mid).value = val ? new Intl.NumberFormat('tr-TR').format(val) : "";
    }

    function saveBBSettingsToObject(){
      const { arr, i, r } = getLatestData();
      if(!r) return;
      const bb = r.bbDetayList[activeBBIndex];
      if(!bb.degerlemeOzet) bb.degerlemeOzet = {};
      
      bb.degerlemeOzet.uygulananBirim = document.getElementById('inp_uygulanan').value;
      bb.degerlemeOzet.dusukBirim = document.getElementById('inp_dusuk').value;
      bb.degerlemeOzet.yuksekBirim = document.getElementById('inp_yuksek').value;
      bb.degerlemeOzet.projeDisiAlan = document.getElementById('inp_proje_disi').value;
      bb.degerlemeOzet.projeDisiBirim = document.getElementById('inp_proje_birim').value;
      bb.degerlemeOzet.insaatAktif = document.getElementById('chk_insaat').checked ? "1" : "0";
      bb.degerlemeOzet.insaatSeviye = document.getElementById('inp_seviye').value;
      bb.degerlemeOzet.eksikImalat = document.getElementById('inp_eksik').value;
      
      persist(arr, i, r);
    }

    function emsalMetinUret(e){
      const fy = e.f10 ? new Intl.NumberFormat('tr-TR').format(e.f10) : "...";
      return `► ${(e.f1||'').toUpperCase()} (${e.f2||''}) Taşınmazla ${e.f3||''}, ${e.f4||''} katlı binanın ${e.f5||''}. katında ${e.f6||''} tipinde, ${e.f7||''}m² beyan, ${e.f8||''}m² tahmin edilen ${e.f9||''} ${fy} TL ile ${e.f11||''}.`;
    }

    function hesapla() {
      const f = parseFloat(document.getElementById('f10').value) || 0;
      const a = parseFloat(document.getElementById('f8').value) || 1;
      const p = parseFloat(document.getElementById('f14').value) || 0;
      const sP = parseFloat(document.getElementById('f12').value) || 0;
      const sM = parseFloat(document.getElementById('f13').value) || 0;
      const b = (f * (1 - p/100) / a) * (1 + (sP - sM)/100);
      document.getElementById('f17').value = formatLira(b);
    }

    function listele() {
      const { r } = getLatestData();
      const list = document.getElementById('emsalListesi');
      list.innerHTML = "";
      if (r && r.emsalHavuzu) {
        r.emsalHavuzu.forEach((e, idx) => {
          list.innerHTML += `<div class="emsal-liste-item">
            <div><strong>Emsal ${idx+1}</strong>: ${formatLira0(e.f10)} TL / ${e.f8}m² → ${e.f17} TL/m²</div>
            <div><button onclick="formuAcById('${e.emsalId}')">Düzenle</button><button class="del" onclick="emsalSil('${e.emsalId}')">Sil</button></div>
          </div>`;
        });
      }
      finalHesapla();
    }

    function finalHesapla() {
      const { r } = getLatestData();
      if(!r) return;
      
      let metin = `EMSAL BİLGİLERİ\n------------------------------------------\n`;
      (r.emsalHavuzu || []).forEach((e, idx) => { metin += `${idx+1}) ${emsalMetinUret(e)}\n\n`; });

      const dusuk = document.getElementById('inp_dusuk').value;
      const yuksek = document.getElementById('inp_yuksek').value;
      metin += `EMSALLERİN YORUMU\n------------------------------------------\nTaşınmazın değer tespitinde "Emsal Karşılaştırma Yöntemi" kullanılmıştır. `;
      if (dusuk && yuksek) metin += `Bölgedeki emsal m² birim fiyatları ${formatLira0(dusuk)} - ${formatLira0(yuksek)} TL aralığındadır. `;
      metin += `\n\n`;

      r.bbDetayList.forEach((bb) => {
        const oz = bb.degerlemeOzet || {};
        const alan = parseFloat(bb.bbDetay?.alanBrut) || 0;
        const uyg = parseFloat(oz.uygulananBirim) || 0;
        const bitDeg = Math.round(uyg * alan + (parseFloat(oz.projeDisiAlan)||0)*(parseFloat(oz.projeDisiBirim)||0));

        if (oz.insaatAktif === "1") {
          const sev = parseFloat(oz.insaatSeviye) || 0;
          const eks = parseFloat(oz.eksikImalat) || 0;
          let son = Math.round(bitDeg * (sev/100) - eks);
          metin += `${bb.baslik}: Seviye %${sev} → Değer: ~${formatLira0(son)} TL\n`;
        } else {
          metin += `${bb.baslik}: Yasal Değer: ~${formatLira0(bitDeg)} TL\n`;
        }
      });
      
      document.getElementById('yorumMetni').innerText = metin;
    }

    // ✅ KRİTİK DÜZELTME: Veriyi Final Raporun Göreceği Alanlara Mühürler
    async function tumRaporuKaydet() {
      saveBBSettingsToObject();
      const { arr, i, r } = getLatestData();
      
      // Üretilen metni ana raporun anlayacağı alanlara kopyala
      const uretilenMetin = document.getElementById('yorumMetni').innerText;
      r.emsalFinalMetni = uretilenMetin; // Eski raporlar için
      if(!r.modules) r.modules = {};
      if(!r.modules.emsal) r.modules.emsal = {};
      r.modules.emsal.text = uretilenMetin; // Yeni sistem için

      // Her BB'nin içine de kendi özel analizini mühürle
      r.bbDetayList.forEach(bb => {
          if(!bb.degerlemeOzet) bb.degerlemeOzet = {};
          bb.degerlemeOzet.emsalFinalMetni = uretilenMetin;
      });

      persist(arr, i, r);

      if (auth.currentUser) {
        await db.collection("users").doc(auth.currentUser.uid).set({ gayrimenkul_reports: arr }, { merge: true });
        alert("✅ Veriler mühürlendi ve buluta kaydedildi!");
      } else {
        alert("✅ Yerel kaydedildi!");
      }
    }

    function emsalKaydet() {
      const { arr, i, r } = getLatestData();
      if(!r.emsalHavuzu) r.emsalHavuzu = [];
      
      const editId = document.getElementById('editEmsalId')?.value;
      const e = {
        emsalId: editId || 'emsal_' + Date.now(),
        f1: document.getElementById('f1').value,
        f2: document.getElementById('f2').value,
        f3: document.getElementById('f3').value,
        f4: document.getElementById('f4').value,
        f5: document.getElementById('f5').value,
        f6: document.getElementById('f6').value,
        f7: document.getElementById('f7').value,
        f8: document.getElementById('f8').value,
        f9: document.getElementById('f9').value,
        f10: document.getElementById('f10').value,
        f11: document.getElementById('f11').value,
        f12: document.getElementById('f12').value,
        f13: document.getElementById('f13').value,
        f14: document.getElementById('f14').value,
        f17: document.getElementById('f17').value
      };

      if(editId) {
        const idx = r.emsalHavuzu.findIndex(x => x.emsalId === editId);
        r.emsalHavuzu[idx] = e;
      } else {
        r.emsalHavuzu.push(e);
      }

      persist(arr, i, r);
      formuKapat();
      listele();
    }

    function formuAcById(id){
      const { r } = getLatestData();
      const e = r.emsalHavuzu.find(x => x.emsalId === id);
      document.getElementById('emsalFormContainer').style.display = 'block';
      if(!document.getElementById('editEmsalId')){
        const h = document.createElement('input'); h.type='hidden'; h.id='editEmsalId'; document.body.appendChild(h);
      }
      document.getElementById('editEmsalId').value = id;
      for(let k=1; k<=14; k++){ if(document.getElementById('f'+k)) document.getElementById('f'+k).value = e['f'+k]; }
      setMoneyPair('f10','f10_mask', e.f10);
      hesapla();
    }

    function formuAc(){
      document.getElementById('emsalFormContainer').style.display = 'block';
      if(document.getElementById('editEmsalId')) document.getElementById('editEmsalId').value = "";
      for(let k=1; k<=14; k++){ if(document.getElementById('f'+k)) document.getElementById('f'+k).value = (k==14?5:0); }
      setMoneyPair('f10','f10_mask', "");
    }

    function formuKapat(){ document.getElementById('emsalFormContainer').style.display = 'none'; }
    function anaMenuyeDon() { window.location.href = `rapor-detay.html?rid=${rid}`; }

    auth.onAuthStateChanged((user) => {
      if (!user) { window.location.href = 'index.html'; return; }
      renderBBTabs();
      refreshActiveBBUI();
    });
  </script>
</body>
</html>

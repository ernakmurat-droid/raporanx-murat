<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profesyonel Emsal Analiz Sistemi</title>

  <style>
    :root{
      --primary:#1a237e;
      --secondary:#3f51b5;
      --success:#2e7d32;
      --danger:#c62828;
      --bg:#f5f7fa;
      --card:#ffffff;
      --muted:#64748b;
      --line:#e2e8f0;
      --warning:#fbc02d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Segoe UI",system-ui,-apple-system,Arial,sans-serif;
      background:var(--bg);
      color:#222;
      padding-bottom:110px;
    }

    .header{
      position:sticky; top:0; z-index:1000;
      background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;
      padding:18px 14px;
      text-align:center;
      box-shadow:0 3px 12px rgba(0,0,0,.25);
    }
    .header h1{margin:2px 0 6px; font-size:18px; letter-spacing:.3px}
    .header #raporBilgi{font-size:13px; opacity:.95}

    .back{
      position:absolute; left:12px; top:14px;
      background:rgba(255,255,255,.18);
      border:none; color:#fff;
      padding:9px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
    }

    .status-bar{
      position:sticky;
      top:74px;
      z-index:999;
      padding:10px 12px;
      text-align:center;
      font-weight:800;
      font-size:13px;
      box-shadow:0 2px 6px rgba(0,0,0,.12);
    }
    .status-incomplete{background:var(--warning); color:#111}
    .status-complete{background:var(--success); color:#fff}

    .container{
      max-width:1050px;
      margin:16px auto;
      padding:0 12px;
    }

    .section-title{
      color:var(--primary);
      font-weight:900;
      font-size:15px;
      margin:14px 2px 10px;
      border-bottom:2px solid #dbeafe;
      padding-bottom:7px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
      padding:14px;
      margin-bottom:12px;
    }

    .btn{
      border:none;
      border-radius:10px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:900;
      transition:.15s;
    }
    .btn:hover{opacity:.94; transform:translateY(-1px)}
    .btn-add{background:var(--success); color:#fff; width:100%}
    .btn-save{background:var(--primary); color:#fff; width:100%; padding:16px; font-size:16px}
    .btn-secondary{background:#64748b; color:#fff}
    .btn-primary{background:var(--primary); color:#fff}

    .emsal-list{display:flex; flex-direction:column; gap:10px;}
    .emsal-item{
      background:#f8fafc;
      border:1px solid var(--line);
      border-left:5px solid var(--primary);
      border-radius:12px;
      padding:12px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .emsal-item small{color:#334155}
    .emsal-item .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:140px;
    }
    .emsal-item .actions button{
      padding:8px 10px;
      border-radius:10px;
      font-weight:900;
      border:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn-mini-edit{background:#e0f2fe; color:#075985}
    .btn-mini-del{background:#fee2e2; color:#b91c1c}

    .grid-form{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
    }
    .input-group{grid-column:span 6;}
    .input-group.w3{grid-column:span 4;}
    .input-group.w12{grid-column:span 12;}
    .input-group label{
      display:block;
      font-size:12px;
      color:#334155;
      font-weight:900;
      margin-bottom:5px;
    }
    .input-group input, .input-group select{
      width:100%;
      padding:12px 12px;
      border:1px solid #cbd5e1;
      border-radius:10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .input-group input:focus, .input-group select:focus{
      border-color:var(--secondary);
      box-shadow:0 0 0 3px rgba(63,81,181,.15);
    }
    .readonly-good{
      background:#f0fdf4 !important;
      color:#166534;
      font-weight:900;
    }

    .final-box{
      background:#fff;
      border:2px solid var(--line);
      padding:16px;
      border-radius:14px;
      white-space:pre-wrap;
      line-height:1.75;
      font-size:14px;
      min-height:120px;
      user-select:none;
      transition:filter .25s;
    }
    .final-box:not(:hover){filter:blur(2px);}

    /* Mobil: tam ekran modal */
    .modal{
      display:none;
      position:fixed;
      inset:0;
      z-index:2000;
      background:rgba(15,23,42,.55);
      padding:10px;
    }
    .modal.open{display:block;}
    .modal-panel{
      background:#fff;
      border-radius:16px;
      max-width:980px;
      margin:0 auto;
      height:calc(100vh - 20px);
      overflow:auto;
      border:1px solid var(--line);
      box-shadow:0 12px 40px rgba(0,0,0,.25);
      padding:14px;
    }
    .modal-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:sticky;
      top:0;
      background:#fff;
      padding:10px 2px 12px;
      border-bottom:1px solid var(--line);
      z-index:1;
    }
    .modal-top .title{
      font-weight:1000;
      color:var(--primary);
      font-size:15px;
    }

    @media (max-width: 820px){
      .input-group{grid-column:span 12;}
      .input-group.w3{grid-column:span 12;}
      .emsal-item{flex-direction:column;}
      .emsal-item .actions{min-width:unset; justify-content:flex-start}
      .status-bar{top:78px;}
    }
  </style>
</head>

<body oncontextmenu="return false;">
  <div class="header">
    <button class="back" onclick="anaMenuyeDon()">← Menü</button>
    <h1>EMSAL ANALİZİ VE DEĞERLEME</h1>
    <div id="raporBilgi">Yükleniyor...</div>
  </div>

  <div id="durumCubugu" class="status-bar status-incomplete">⚠️ Analiz İçin Veri Girişi Bekleniyor...</div>

  <div class="container">
    <div class="section-title">1. Kayıtlı Emsal Araştırmaları</div>

    <div id="emsalListesi" class="emsal-list"></div>
    <button class="btn btn-add" onclick="formuAc()">+ YENİ EMSAL ARAŞTIRMASI EKLE</button>

    <div class="section-title" style="margin-top:18px;">2. Değerleme Parametreleri</div>
    <div class="card">
      <div class="grid-form">
        <div class="input-group w3">
          <label>Bölge Alt Sınır (TL/m²)</label>
          <input id="inp_dusuk_mask" oninput="formatMoneyInput(this); finalHesapla();" inputmode="numeric" />
          <input type="hidden" id="inp_dusuk" />
        </div>
        <div class="input-group w3">
          <label>Bölge Üst Sınır (TL/m²)</label>
          <input id="inp_yuksek_mask" oninput="formatMoneyInput(this); finalHesapla();" inputmode="numeric" />
          <input type="hidden" id="inp_yuksek" />
        </div>
        <div class="input-group w3">
          <label>Uygulanan Birim (TL/m²)</label>
          <input id="inp_uygulanan_mask" oninput="formatMoneyInput(this); finalHesapla();" inputmode="numeric" />
          <input type="hidden" id="inp_uygulanan" />
        </div>

        <div class="input-group w3">
          <label>Yasal Brüt Alan (m²)</label>
          <input id="res_brut" class="readonly-good" readonly />
        </div>

        <div class="input-group w3">
          <label>Proje Dışı İlave Alan (m²)</label>
          <input type="number" id="inp_proje_disi" min="0" oninput="finalHesapla()" inputmode="numeric" />
        </div>

        <div class="input-group w3">
          <label>İlave Alan Birim Değeri (TL/m²)</label>
          <input id="inp_proje_birim_mask" oninput="formatMoneyInput(this); finalHesapla();" inputmode="numeric" />
          <input type="hidden" id="inp_proje_birim" />
        </div>
      </div>
    </div>

    <div class="section-title">3. Rapor Analiz Metni</div>
    <div id="yorumMetni" class="final-box" oncopy="return false"></div>

    <button class="btn btn-save" onclick="tumRaporuKaydet()">ANALİZİ KAYDET VE KİLİTLE</button>
  </div>

  <!-- Hatırlatıcı datalist -->
  <div style="display:none">
    <datalist id="h_f1"></datalist>
    <datalist id="h_f3"></datalist>
    <datalist id="h_f5"></datalist>
    <datalist id="h_f6"></datalist>
    <datalist id="h_f9"></datalist>
  </div>

  <!-- Modal Form -->
  <div id="emsalModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <div class="modal-top">
        <div class="title">Emsal Detay Girişi</div>
        <button class="btn btn-secondary" onclick="formuKapat()">Kapat</button>
      </div>

      <div style="padding-top:10px;">
        <input type="hidden" id="editIndex" value="-1" />

        <div class="grid-form">
          <div class="input-group">
            <label>(1) Kaynağı</label>
            <input id="f1" list="h_f1" placeholder="Emlakçı / İsim" />
          </div>

          <div class="input-group">
            <label>(2) Telefon</label>
            <input id="f2" placeholder="(5XX) XXX XX XX" oninput="formatPhone(this)" inputmode="tel" />
          </div>

          <div class="input-group">
            <label>(3) Konum / Yakınlık</label>
            <input id="f3" list="h_f3" placeholder="taşınmazla aynı binada / yakın konumda..." />
          </div>

          <div class="input-group w3">
            <label>(4) Bina Kat Sayısı</label>
            <input id="f4" type="number" min="1" inputmode="numeric" />
          </div>

          <div class="input-group w3">
            <label>(5) Bulunduğu Kat</label>
            <input id="f5" list="h_f5" placeholder="örn: 3" />
          </div>

          <div class="input-group w3">
            <label>(6) Oda Sayısı (X+Y)</label>
            <input id="f6" list="h_f6" placeholder="örn: 2+1" />
          </div>

          <div class="input-group w3">
            <label>(7) Beyan Alan (m²)</label>
            <input id="f7" type="number" min="0" inputmode="numeric" />
          </div>

          <div class="input-group w3">
            <label>(8) Tahmini Alan (m²)</label>
            <input id="f8" type="number" min="1" oninput="hesapla()" inputmode="numeric" />
          </div>

          <div class="input-group w3">
            <label>(9) Taşınmaz Cinsi</label>
            <input id="f9" list="h_f9" placeholder="örn: daire" />
          </div>

          <div class="input-group">
            <label>(10) İstenen Fiyat (TL)</label>
            <input id="f10_mask" oninput="formatMoneyInput(this); hesapla();" inputmode="numeric" />
            <input type="hidden" id="f10" />
          </div>

          <div class="input-group">
            <label>(11) Durumu</label>
            <select id="f11">
              <option value="satılıktır">Satılık</option>
              <option value="kiralıktır">Kiralık</option>
            </select>
          </div>

          <div class="input-group w3">
            <label>(14) Pazarlık Payı % (-)</label>
            <input id="f14" type="number" value="5" min="0" oninput="hesapla()" inputmode="numeric" />
          </div>

          <div class="input-group w3">
            <label>(12) Şerefiye Olumlu % (+)</label>
            <input id="f12" type="number" value="0" oninput="hesapla()" inputmode="numeric" />
          </div>

          <div class="input-group w3">
            <label>(13) Şerefiye Olumsuz % (-)</label>
            <input id="f13" type="number" value="0" oninput="hesapla()" inputmode="numeric" />
          </div>

          <div class="input-group w12">
            <label>Düzeltilmiş Birim Değer (TL/m²)</label>
            <input id="f17" class="readonly-good" readonly />
          </div>
        </div>

        <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
          <button class="btn btn-primary" style="flex:2; min-width:220px;" onclick="emsalKaydet()">LİSTEYE İŞLE VE MÜHÜRLE</button>
          <button class="btn btn-secondary" style="flex:1; min-width:160px;" onclick="formuKapat()">İPTAL</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* GÜVENLİK: Ctrl kısayolları */
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === 'c' || e.key === 'p' || e.key === 's' || e.key === 'u')) {
        e.preventDefault();
      }
    });

    /* =========================================================
       ✅ ÇİFT UYUMLU KAYIT SİSTEMİ
       - gayrimenkul_reports: mevcut formatı bozmaz (array/object neyse)
       - gayrimenkul_reports_map: yedek/kalıcı map (çakışmalara karşı)
    ========================================================= */
    const STORAGE_KEY_MAIN = 'gayrimenkul_reports';
    const STORAGE_KEY_MAP  = 'gayrimenkul_reports_map';

    function safeParse(json, fallback) {
      try { return JSON.parse(json); } catch { return fallback; }
    }

    function isNumericId(v) {
      // "0", "12" gibi ise true. "abc" değil.
      return String(v).trim() !== '' && !isNaN(Number(v)) && isFinite(Number(v));
    }

    function loadMain() {
      const raw = localStorage.getItem(STORAGE_KEY_MAIN);
      if (!raw) return { type: 'empty', data: null };
      const parsed = safeParse(raw, null);
      if (Array.isArray(parsed)) return { type: 'array', data: parsed };
      if (parsed && typeof parsed === 'object') return { type: 'object', data: parsed };
      return { type: 'empty', data: null };
    }

    function loadMap() {
      const raw = localStorage.getItem(STORAGE_KEY_MAP);
      const parsed = raw ? safeParse(raw, {}) : {};
      return (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) ? parsed : {};
    }

    function saveMainArray(arr) {
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(arr));
    }
    function saveMainObject(obj) {
      localStorage.setItem(STORAGE_KEY_MAIN, JSON.stringify(obj));
    }
    function saveMap(mapObj) {
      localStorage.setItem(STORAGE_KEY_MAP, JSON.stringify(mapObj));
    }

    function getReportById(id) {
      const main = loadMain();
      const mapObj = loadMap();
      const key = String(id);

      // önce map'te varsa al (daha kalıcı)
      if (mapObj[key]) return mapObj[key];

      // sonra main'den dene
      if (main.type === 'array') {
        if (isNumericId(id)) return main.data[Number(id)] || null;
        return null;
      }
      if (main.type === 'object') {
        return main.data[key] || null;
      }
      return null;
    }

    function saveReportById(id, reportObj) {
      const key = String(id);

      // 1) map'e mutlaka yaz (yedek)
      const mapObj = loadMap();
      mapObj[key] = reportObj;
      saveMap(mapObj);

      // 2) main'i mevcut formatında yaz (diğer sayfalar bozulmasın)
      const main = loadMain();

      if (main.type === 'array' || main.type === 'empty') {
        // sistem array ise array'de devam (id numeric değilse array'e yazmayız)
        const arr = (main.type === 'array') ? main.data : [];
        if (isNumericId(id)) {
          arr[Number(id)] = reportObj;
          saveMainArray(arr);
        } else {
          // numeric değilse main'i bozmayalım; sadece map yeter
          // (ama yine de object’e çevirmiyoruz, diğer sayfalar bozulmasın)
        }
        return;
      }

      if (main.type === 'object') {
        const obj = main.data;
        obj[key] = reportObj;
        saveMainObject(obj);
        return;
      }
    }

    /* ========================================================= */
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id') || '0';

    let report = getReportById(id) || {};
    if (!report.emsaller) report.emsaller = [];

    const tasinmazBrut = Number(report.bbDetay?.alanBrut || 0);

    window.onload = () => {
      document.getElementById('raporBilgi').textContent = report.propertyName || "Analiz Dosyası";
      document.getElementById('res_brut').value = (tasinmazBrut || 0).toLocaleString('tr-TR');

      if (report.degerlemeOzet) yukle(report.degerlemeOzet);

      yukleHatirlatmaListeleri();
      listele();
      finalHesapla();
      veriKontrol();
    };

    function formatMoneyInput(input) {
      let val = (input.value || '').replace(/\D/g, '');
      input.value = val ? new Intl.NumberFormat('tr-TR').format(Number(val)) : '';
      const hidden = document.getElementById(input.id.replace('_mask',''));
      if (hidden) hidden.value = val;
    }

    function formatPhone(input) {
      let x = (input.value || '').replace(/\D/g,'').match(/(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/);
      if (!x) return;
      input.value = !x[2] ? x[1]
        : '(' + x[1] + ') ' + x[2]
        + (x[3] ? ' ' + x[3] : '')
        + (x[4] ? ' ' + x[4] : '');
    }

    function formatLira(num) {
      return new Intl.NumberFormat('tr-TR', { minimumFractionDigits: 0 }).format(Number(num || 0));
    }

    function toNumber(val) {
      return Number((val || '').toString().replace(/\D/g,'')) || 0;
    }

    function yukleHatirlatmaListeleri() {
      const fields = ['f1','f3','f5','f6','f9'];
      fields.forEach(field => {
        const items = JSON.parse(localStorage.getItem(`emsal_history_${field}`) || '[]');
        const dl = document.getElementById(`h_${field}`);
        if (dl) dl.innerHTML = items.map(item => `<option value="${item}">`).join('');
      });
    }

    function hatirlatmayaYaz(field, value) {
      if (!value || !value.trim()) return;
      let history = JSON.parse(localStorage.getItem(`emsal_history_${field}`) || '[]');
      history = history.filter(v => v !== value);
      history.unshift(value);
      history = history.slice(0, 15);
      localStorage.setItem(`emsal_history_${field}`, JSON.stringify(history));
    }

    function formuAc(index = -1) {
      document.getElementById('emsalModal').classList.add('open');
      document.getElementById('editIndex').value = String(index);

      if (index > -1) {
        const e = report.emsaller[index];
        const ids = ['f1','f2','f3','f4','f5','f6','f7','f8','f9','f11','f12','f13','f14'];
        ids.forEach(k => {
          const el = document.getElementById(k);
          if (el) el.value = (e && e[k] != null) ? e[k] : '';
        });
        document.getElementById('f10').value = e.f10 || '';
        document.getElementById('f10_mask').value = e.f10 ? new Intl.NumberFormat('tr-TR').format(Number(e.f10)) : '';
        hesapla();
      } else {
        ['f1','f2','f3','f4','f5','f6','f7','f8','f9'].forEach(k => document.getElementById(k).value = '');
        document.getElementById('f10').value = '';
        document.getElementById('f10_mask').value = '';
        document.getElementById('f11').value = 'satılıktır';
        document.getElementById('f12').value = '0';
        document.getElementById('f13').value = '0';
        document.getElementById('f14').value = '5';
        document.getElementById('f17').value = '';
      }

      setTimeout(() => document.getElementById('f1').focus(), 80);
    }

    function formuKapat() {
      document.getElementById('emsalModal').classList.remove('open');
    }

    function hesapla() {
      const fiyat = toNumber(document.getElementById('f10').value);
      const alan = Number(document.getElementById('f8').value) || 1;
      const pazarlik = Number(document.getElementById('f14').value) || 0;
      const sArti = Number(document.getElementById('f12').value) || 0;
      const sEksi = Number(document.getElementById('f13').value) || 0;

      const netSerefiye = (sArti - sEksi);
      let birim = (fiyat * (1 - pazarlik/100)) / Math.max(1, alan);
      if (netSerefiye !== 0) birim *= (1 + netSerefiye/100);

      document.getElementById('f17').value = formatLira(Math.round(birim)) + " TL/m²";
    }

    function emsalKaydet() {
      const index = Number(document.getElementById('editIndex').value);

      const e = {
        f1: (document.getElementById('f1').value || '').trim(),
        f2: (document.getElementById('f2').value || '').trim(),
        f3: (document.getElementById('f3').value || '').trim(),
        f4: (document.getElementById('f4').value || '').trim(),
        f5: (document.getElementById('f5').value || '').trim(),
        f6: (document.getElementById('f6').value || '').trim(),
        f7: (document.getElementById('f7').value || '').trim(),
        f8: (document.getElementById('f8').value || '').trim(),
        f9: (document.getElementById('f9').value || '').trim(),
        f10: (document.getElementById('f10').value || '').trim(),
        f11: (document.getElementById('f11').value || 'satılıktır').trim(),
        f12: (document.getElementById('f12').value || '0').trim(),
        f13: (document.getElementById('f13').value || '0').trim(),
        f14: (document.getElementById('f14').value || '0').trim(),
        f17: (document.getElementById('f17').value || '').trim()
      };

      if (!e.f1 || !e.f3 || !e.f8 || !e.f10) {
        alert("⚠️ En azından Kaynak, Konum/Yakınlık, Tahmini Alan ve Fiyat girmen lazım.");
        return;
      }

      const f10Val = toNumber(e.f10);
      const f8Val = Number(e.f8) || 1;

      const hamBirim = Math.round(f10Val / Math.max(1, f8Val));
      const netSerefiye = (Number(e.f12)||0) - (Number(e.f13)||0);
      const shStr = netSerefiye !== 0 ? `, %${netSerefiye} şerefiye` : '';

      e.hesapSatiri = `(${formatLira(hamBirim)} TL/m², -%${Number(e.f14)||0} pazarlık${shStr} → ${e.f17 || "—"})`;

      // ✅ Telefon sonrası istenen ifade eklendi:
      const kaynak = (e.f1 || "İSİMSİZ").toUpperCase();
      const tel = e.f2 || "…";
      const konum = e.f3 || "…";

      e.anaMetin =
        `${kaynak} (${tel}) Değerlemeye konu taşınmazla ${konum} konumlu, ` +
        `${e.f4 || "…"} katlı binanın ${e.f5 || "…"} katında konumlu, ` +
        `${e.f6 || "…"} tipindeki, ${e.f7 || "…"} m² kullanım alanlı beyan edilen, ` +
        `${e.f8 || "…"} m² alanlı tahmin edilen, ${e.f9 || "daire"} ` +
        `${new Intl.NumberFormat('tr-TR').format(f10Val)} TL bedel ile ${e.f11}.`;

      ['f1','f3','f5','f6','f9'].forEach(k => hatirlatmayaYaz(k, e[k]));

      if (index > -1) report.emsaller[index] = e;
      else report.emsaller.push(e);

      // ✅ ASIL DÜZELTME: çift uyumlu kaydet
      saveReportById(id, report);

      yukleHatirlatmaListeleri();
      listele();
      finalHesapla();
      veriKontrol();
      formuKapat();
    }

    function emsalSil(index) {
      if (!confirm("Bu emsal tamamen silinecek. Emin misiniz?")) return;
      report.emsaller.splice(index, 1);
      saveReportById(id, report);
      listele();
      finalHesapla();
      veriKontrol();
    }

    function listele() {
      const list = document.getElementById('emsalListesi');
      list.innerHTML = '';

      if (!report.emsaller || report.emsaller.length === 0) {
        list.innerHTML = `<div class="card" style="color:#334155;">Henüz emsal eklenmedi.</div>`;
        return;
      }

      report.emsaller.forEach((e, i) => {
        const div = document.createElement('div');
        div.className = 'emsal-item';

        const preview = (e.anaMetin || '').trim();
        const short = preview.length > 170 ? preview.substring(0,170) + "..." : preview;

        div.innerHTML = `
          <div style="flex:1;">
            <strong>Emsal ${i+1}</strong><br>
            <small>${short || '(metin yok)'}</small>
            ${e.hesapSatiri ? `<div style="margin-top:8px; color:#0f172a; font-weight:900; font-size:12px;">${e.hesapSatiri}</div>` : ''}
          </div>
          <div class="actions">
            <button class="btn-mini-edit" onclick="formuAc(${i})">Düzenle</button>
            <button class="btn-mini-del" onclick="emsalSil(${i})">Sil</button>
          </div>
        `;
        list.appendChild(div);
      });
    }

    function finalHesapla() {
      const dusuk = toNumber(document.getElementById('inp_dusuk').value);
      const yuksek = toNumber(document.getElementById('inp_yuksek').value);
      const uygulanan = toNumber(document.getElementById('inp_uygulanan').value);
      const pDisiAlan = Number(document.getElementById('inp_proje_disi').value) || 0;
      const pDisiBirim = toNumber(document.getElementById('inp_proje_birim').value);

      const yasalDeger = Math.round(uygulanan * (tasinmazBrut || 0));
      const pDisiDeger = Math.round(pDisiBirim * pDisiAlan);
      const toplamDeger = yasalDeger + pDisiDeger;

      let metin = '';

      if (report.emsaller && report.emsaller.length) {
        metin += report.emsaller.map(e => (e.anaMetin || '').trim()).filter(Boolean).join("\n\n");
        metin += "\n\n";
      }

      metin +=
        `Taşınmazın değer tespitinde Emsal Karşılaştırma Yöntemi kullanılmıştır. ` +
        `Emsal m² birim fiyatları ${formatLira(dusuk)} TL ile ${formatLira(yuksek)} TL arasındadır. ` +
        `Yapılan analizler sonucunda konu taşınmaza ${formatLira(uygulanan)} TL/m² birim fiyatı uygun görülmüştür.\n\n` +
        `${formatLira(tasinmazBrut)} m² x ${formatLira(uygulanan)} TL/m² = ${formatLira(yasalDeger)} TL yasal durum değeri`;

      if (pDisiAlan > 0) {
        metin += `, mevcut durumdaki ${pDisiAlan} m² x ${formatLira(pDisiBirim)} TL/m² = ${formatLira(pDisiDeger)} TL\n`;
        metin += `Toplam mevcut durum değeri: ${formatLira(toplamDeger)} TL olarak takdir edilmiştir.`;
      } else {
        metin += `\nToplam yasal ve mevcut durum değeri: ${formatLira(toplamDeger)} TL olarak uygun görülmüştür.`;
      }

      if (report.emsaller && report.emsaller.length) {
        metin += `\n\nEmsal Birim Fiyat Düzeltme Özetleri:\n`;
        metin += report.emsaller.map((e,i) => `- Emsal ${i+1}: ${e.hesapSatiri || '(hesap yok)'}`).join("\n");
      }

      document.getElementById('yorumMetni').innerText = (metin || '').trim();
      veriKontrol();
    }

    function veriKontrol() {
      const bar = document.getElementById('durumCubugu');
      const count = (report.emsaller || []).length;
      const uygulanan = toNumber(document.getElementById('inp_uygulanan').value);

      if (count >= 1 && uygulanan > 0) {
        bar.textContent = "✅ ANALİZ PARAMETRELERİ TAMAMLANDI";
        bar.className = "status-bar status-complete";
      } else {
        bar.textContent = "⚠️ EKSİK VERİ: " + (count === 0 ? "[Emsal Yok] " : "") + (uygulanan <= 0 ? "[Uygulanan Birim Fiyat Yok]" : "");
        bar.className = "status-bar status-incomplete";
      }
    }

    function tumRaporuKaydet() {
      const emsalSayisi = (report.emsaller || []).length;
      let uyari = "✅ Analiz mühürlenecektir. Onaylıyor musunuz?";
      if (emsalSayisi < 4) {
        uyari = `⚠️ BANKA KRİTERİ UYARISI:\nBankalar genelde en az 4 emsal ister (Sizde: ${emsalSayisi}).\nYine de kaydetmek istiyor musunuz?`;
      }
      if (!confirm(uyari)) return;

      report.degerlemeOzet = {
        uygulananBirim: document.getElementById('inp_uygulanan').value,
        dusukBirim: document.getElementById('inp_dusuk').value,
        yuksekBirim: document.getElementById('inp_yuksek').value,
        projeDisiAlan: document.getElementById('inp_proje_disi').value,
        projeDisiBirim: document.getElementById('inp_proje_birim').value,
        emsalFinalMetni: document.getElementById('yorumMetni').innerText
      };

      saveReportById(id, report);
      alert("✅ ANALİZ KAYDEDİLDİ");
      veriKontrol();
    }

    function yukle(d) {
      if (!d) return;

      function setVal(fid, val) {
        const el = document.getElementById(fid);
        const mask = document.getElementById(fid + "_mask");
        if (el) el.value = val || "";
        if (mask) mask.value = val ? new Intl.NumberFormat('tr-TR').format(Number(val)) : "";
      }

      setVal('inp_uygulanan', d.uygulananBirim);
      setVal('inp_dusuk', d.dusukBirim);
      setVal('inp_yuksek', d.yuksekBirim);
      setVal('inp_proje_birim', d.projeDisiBirim);
      document.getElementById('inp_proje_disi').value = d.projeDisiAlan || "";

      finalHesapla();
    }

    function anaMenuyeDon() {
      window.location.href = `rapor-detay.html?id=${id}`;
    }
  </script>
</body>
</html>

/* wallet.js ‚Äî RaporanX */
(function(){
  const auth = firebase.auth();
  const db = firebase.firestore();

  const PACKS = {
    P120: { id:"P120", title:"120 TL ‚Ä¢ 4 Hak", priceTL:120, credits:4 },
    P200: { id:"P200", title:"200 TL ‚Ä¢ 8 Hak", priceTL:200, credits:8 },
    P500: { id:"P500", title:"500 TL ‚Ä¢ 25 Hak", priceTL:500, credits:25 },
  };

  function nowTs(){ return firebase.firestore.FieldValue.serverTimestamp(); }

  function usersDoc(uid){
    return db.collection("users").doc(uid);
  }

  function ordersCol(uid){
    return db.collection("users").doc(uid).collection("orders");
  }

  async function ensureUserDoc(uid){
    const ref = usersDoc(uid);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({
        uid,
        credits: 0,
        createdAt: nowTs(),
        updatedAt: nowTs(),
      }, { merge:true });
    }
  }

  function setWalletUI(credits){
    const elAmount = document.getElementById("walletAmount");
    const elSub = document.getElementById("walletSub");
    if(elAmount) elAmount.textContent = `üéüÔ∏è ${Number(credits||0)} Hak`;
    if(elSub) elSub.textContent = `Bakiyen: ${Number(credits||0)} hak`;
  }

  const Wallet = {
    PACKS,

    // ‚úÖ Kullanƒ±cƒ± c√ºzdanƒ±nƒ± y√ºkle
    async load(uid){
      if(!uid) throw new Error("Wallet.load: uid yok");
      await ensureUserDoc(uid);

      const snap = await usersDoc(uid).get();
      const data = snap.data() || {};
      setWalletUI(data.credits || 0);
      return data;
    },

    // ‚úÖ Sipari≈üleri dinle (TEK SNAPSHOT ‚Üí TEK ARRAY)
    listenOrders(uid, cb){
      if(!uid) throw new Error("Wallet.listenOrders: uid yok");
      const q = ordersCol(uid).orderBy("createdAt", "desc");

      const unsub = q.onSnapshot((snap)=>{
        const arr = [];
        snap.forEach(doc => {
          arr.push({ id: doc.id, ...doc.data() });
        });
        try{ cb(arr); }catch(e){ console.warn("listenOrders cb hata:", e); }
      }, (err)=>{
        console.error("listenOrders snapshot error:", err);
      });

      return unsub;
    },

    // ‚úÖ Sipari≈ü olu≈ütur (users/{uid}/orders/{orderId})
    async createOrder(packId){
      const user = auth.currentUser;
      if(!user) throw new Error("createOrder: giri≈ü yok");

      const pack = PACKS[String(packId)];
      if(!pack) throw new Error("createOrder: packId ge√ßersiz");

      await ensureUserDoc(user.uid);

      const ref = ordersCol(user.uid).doc(); // auto id

      const order = {
        orderId: ref.id,

        // ayƒ±rt etme
        uid: user.uid,
        userEmail: user.email || "",
        userName: user.displayName || "",

        packId: pack.id,
        packTitle: pack.title,
        priceTL: pack.priceTL,
        credits: pack.credits,

        status: "pending",
        paymentLink: "",
        userPaidRef: "",
        appliedToWallet: false,

        createdAt: nowTs(),
        updatedAt: nowTs(),
      };

      // ‚úÖ tek write (√ßoƒüalma yok)
      await ref.set(order, { merge:true });
      return order;
    },

    // ‚úÖ Kullanƒ±cƒ± ‚Äú√∂dedim‚Äù i≈üaretlesin
    async markPaid(orderId, refText){
      const user = auth.currentUser;
      if(!user) throw new Error("markPaid: giri≈ü yok");
      if(!orderId) throw new Error("markPaid: orderId yok");

      const ref = ordersCol(user.uid).doc(orderId);

      await ref.set({
        status: "user_marked_paid",
        userPaidRef: (refText || "").trim(),
        updatedAt: nowTs(),
      }, { merge:true });

      return true;
    },

    // ‚úÖ Fatura bilgisi getir
    async getBillingProfile(uid){
      if(!uid) throw new Error("getBillingProfile: uid yok");
      await ensureUserDoc(uid);
      const snap = await usersDoc(uid).get();
      const data = snap.data() || {};
      return data.billingProfile || null;
    },

    // ‚úÖ Fatura bilgisi kaydet (TEK NOKTA ‚Üí users/{uid}.billingProfile)
    async saveBillingProfile(uid, profile){
      if(!uid) throw new Error("saveBillingProfile: uid yok");

      const clean = {
        type: (profile?.type || "individual"),
        fullName: (profile?.fullName || "").trim(),
        tcOrVkn: (profile?.tcOrVkn || "").trim(),
        taxOffice: (profile?.taxOffice || "").trim(),
        address: (profile?.address || "").trim(),
        phone: (profile?.phone || "").trim(),
        email: (profile?.email || "").trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };

      // Basit doƒürulama (minimum)
      if(!clean.fullName) throw new Error("Ad/√únvan bo≈ü olamaz");
      if(!clean.tcOrVkn) throw new Error("TCKN/VKN bo≈ü olamaz");
      if(!clean.address) throw new Error("Adres bo≈ü olamaz");

      await usersDoc(uid).set({
        billingProfile: clean,
        updatedAt: nowTs(),
      }, { merge:true });

      return clean;
    },
  };

  window.Wallet = Wallet;
})();

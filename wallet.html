<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RaporanX â€¢ CÃ¼zdan</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script src="firebase-config.js"></script>
  <script src="wallet.js"></script>
<script>
(function(){
  const auth = firebase.auth();
  const elOrders = document.getElementById("orders");

  let unsubOrders = null;

  function pickLink(o){
    return (o.paymentLink || o?.payment?.link || "").trim();
  }

  function statusTr(s){
    if(s==="pending") return "Link hazÄ±rlanÄ±yor â³";
    if(s==="link_added") return "Link hazÄ±r âœ…";
    if(s==="user_marked_paid") return "Kontrol ediliyor â³";
    if(s==="approved") return "OnaylandÄ± âœ…";
    return s || "-";
  }

  function renderOrders(arr){
    if(!arr || !arr.length){
      elOrders.innerHTML = `<div class="muted">HenÃ¼z sipariÅŸ yok.</div>`;
      return;
    }

    elOrders.innerHTML = arr.map(o => {
      const orderId = o.orderId || o.id || "";
      const link = pickLink(o);

      const payBtn = (link && o.status !== "approved")
        ? `<a class="link" href="${link}" target="_blank">ğŸ”— Ã–demeye Git</a>`
        : `<span class="muted">${link ? "Link var" : "Link yok"}</span>`;

      const markPaidBtn = (o.status !== "approved")
        ? `<button class="warn" onclick="markPaid('${orderId}')">Ã–dedim</button>`
        : ``;

      return `
        <div style="padding:10px 0;border-top:1px solid rgba(255,255,255,.10)">
          <div style="font-weight:900">${o.packTitle || o.packId} â€¢ ${o.priceTL} TL â€¢ ${o.credits} Hak</div>
          <div class="muted">Durum: <b>${statusTr(o.status)}</b></div>
          <div style="margin-top:8px; display:flex; gap:10px;">
            ${payBtn}
            ${markPaidBtn}
          </div>
        </div>
      `;
    }).join("");
  }

  window.markPaid = async function(orderId){
    try{
      const ref = prompt("Varsa dekont no yaz (boÅŸ bÄ±rakabilirsin):") || "";
      await Wallet.markPaid(orderId, ref);
      alert("Bildirim gÃ¶nderildi âœ…");
    }catch(e){
      alert("Hata: " + (e?.message || e));
    }
  };

  auth.onAuthStateChanged(async (user)=>{
    if(unsubOrders){ unsubOrders(); unsubOrders = null; }

    if(!user){
      elOrders.innerHTML = `<div class="muted">GiriÅŸ yapmalÄ±sÄ±n.</div>`;
      return;
    }

    await Wallet.load(user.uid);

    unsubOrders = Wallet.listenOrders(user.uid, (arr)=>{
      renderOrders(arr);
    });
  });
})();
</script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#111827;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn{background:rgba(255,255,255,.08);color:#e5e7eb;border:1px solid rgba(255,255,255,.12)}
    .buy{background:#22c55e;color:#062}
    .warn{background:#f59e0b;color:#111}
    .link{color:#60a5fa;text-decoration:none}
    .muted{opacity:.75}
    input{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0b1220;color:#e5e7eb}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <a href="/admin.html"
   style="position:fixed;top:10px;right:10px;background:#ef4444;color:white;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;z-index:9999;">
  ğŸ”§ Admin
</a>

  <div class="wrap">
    <div class="row">
      <div>
        <div style="font-size:20px;font-weight:900;">ğŸŸï¸ CÃ¼zdan</div>
        <div class="muted" id="me">GiriÅŸ bekleniyorâ€¦</div>
      </div>
      <div class="row">
        <button class="btn" id="btnRefresh">â†» Yenile</button>
        <button class="btn" id="btnLogout">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </div>

    <div class="card">
      <div style="font-size:18px;font-weight:900;" id="walletAmount">â€”</div>
      <div class="muted" id="walletSub">â€”</div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px;">Paket SatÄ±n Al</div>
      <div class="row">
        <button class="buy" onclick="buy('P120')">120 TL â€¢ 4 Hak</button>
        <button class="buy" onclick="buy('P200')">200 TL â€¢ 8 Hak</button>
        <button class="buy" onclick="buy('P500')">500 TL â€¢ 25 Hak</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        Not: Ã–deme linki admin tarafÄ±ndan eklendiÄŸinde aÅŸaÄŸÄ±da gÃ¶rÃ¼nÃ¼r.
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px;">SipariÅŸlerim</div>
      <div id="orders" class="muted">YÃ¼kleniyorâ€¦</div>
    </div>
  </div>

<script>
(function(){
  const auth = firebase.auth();

  const elMe = document.getElementById("me");
  const elOrders = document.getElementById("orders");

  let unsubOrders = null;

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  function pickLink(o){
    return (o.paymentLink || o?.payment?.link || "").trim();
  }

  function statusTr(s){
    if(s==="pending") return "Yeni sipariÅŸ";
    if(s==="link_added") return "Link eklendi";
    if(s==="user_marked_paid") return "Ã–deme bildirildi";
    if(s==="approved") return "OnaylandÄ± âœ…";
    if(s==="rejected") return "Reddedildi";
    if(s==="cancelled") return "Ä°ptal";
    return s || "-";
  }

  window.buy = async function(packId){
    try{
      const o = await Wallet.createOrder(packId);
      alert("SipariÅŸ oluÅŸturuldu âœ…\norderId: " + o.orderId);
    }catch(e){
      alert("Hata: " + (e?.message || e));
    }
  };

  async function renderOrders(arr){
    if(!arr || !arr.length){
      elOrders.innerHTML = `<div class="muted">HenÃ¼z sipariÅŸ yok.</div>`;
      return;
    }

    elOrders.innerHTML = arr.map(o => {
      const link = pickLink(o);
      const canGoPay = !!link && o.status !== "approved";

      const btnPay = canGoPay
        ? `<a class="link" href="${esc(link)}" target="_blank">ğŸ”— Ã–demeye Git</a>`
        : (link ? `<span class="muted">Link var</span>` : `<span class="muted">Link yok</span>`);

      const btnMarkPaid = (o.status !== "approved")
        ? `<button class="warn" onclick="markPaid('${esc(o.orderId || o.id)}')">Ã–dedim</button>`
        : ``;

      return `
        <div style="padding:10px 0;border-top:1px solid rgba(255,255,255,.10)">
          <div class="row">
            <div>
              <div style="font-weight:900">${esc(o.packTitle || o.packId || "Paket")} â€¢ ${esc(o.priceTL)} TL â€¢ ${esc(o.credits)} Hak</div>
              <div class="muted small">Durum: <b>${esc(statusTr(o.status))}</b> â€¢ orderId: <span class="mono">${esc(o.orderId || o.id || "")}</span></div>
            </div>
            <div class="row">
              ${btnPay}
              ${btnMarkPaid}
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  window.markPaid = async function(orderId){
    try{
      const ref = prompt("Varsa dekont/iÅŸlem no yaz (boÅŸ bÄ±rakabilirsin):") || "";
      await Wallet.markPaid(orderId, ref);
      alert("Bildirim gÃ¶nderildi âœ…");
    }catch(e){
      alert("Hata: " + (e?.message || e));
    }
  };

  document.getElementById("btnLogout").onclick = ()=> auth.signOut();
  document.getElementById("btnRefresh").onclick = async ()=>{
    const u = auth.currentUser;
    if(u) await Wallet.load(u.uid);
  };

  auth.onAuthStateChanged(async (user)=>{
    if(unsubOrders){ unsubOrders(); unsubOrders = null; }

    if(!user){
      elMe.innerHTML = `GiriÅŸ yok. (Ã–nce giriÅŸ yapmalÄ±sÄ±n)`;
      elOrders.innerHTML = `<div class="muted">SipariÅŸleri gÃ¶rmek iÃ§in giriÅŸ yap.</div>`;
      return;
    }

    elMe.innerHTML = `GiriÅŸ: <b>${esc(user.email || user.uid)}</b>`;
    await Wallet.load(user.uid);

    // canlÄ± sipariÅŸ listesi (son 50)
    unsubOrders = Wallet.listenOrders(user.uid, async (arr)=> {
      await renderOrders(arr);
    });
  });
})();
</script>
<script>
function buy(packId){
  Wallet.createOrder(packId)
    .then(o => {
      alert("SipariÅŸ oluÅŸturuldu âœ… Ã–deme linki hazÄ±rlanacak.");
      console.log("ORDER:", o);
    })
    .catch(e => {
      alert("Hata: " + e.message);
      console.error(e);
    });
}
</script>
<script>
(async function(){
  const auth = window.auth || firebase.auth();
  const db   = window.db   || firebase.firestore();

  const ordersEl = document.getElementById("orders");
  const msgEl = document.getElementById("statusInfo") || document.getElementById("walletSub");

  function statusTR(s){
    if(s==="pending") return "â³ SipariÅŸ alÄ±ndÄ± (link hazÄ±rlanÄ±yor)";
    if(s==="link_added") return "ğŸ”— Ã–deme linki hazÄ±r";
    if(s==="user_marked_paid") return "ğŸ§¾ Ã–deme bildirildi (admin onayÄ± bekleniyor)";
    if(s==="approved") return "âœ… OnaylandÄ± (hak yÃ¼klendi)";
    if(s==="rejected") return "âŒ Reddedildi";
    if(s==="cancelled") return "ğŸš« Ä°ptal";
    return s || "-";
  }

  // âœ… SatÄ±n al butonlarÄ± bununla Ã§alÄ±ÅŸacak
  window.buy = function(packId){
    Wallet.createOrder(packId)
      .then(o=>{
        alert("SipariÅŸ oluÅŸturuldu âœ… Link gelince burada gÃ¶receksin.");
        // sipariÅŸ listesi zaten listener ile gÃ¼ncellenecek
      })
      .catch(e=>{
        alert("Hata: " + (e?.message || e));
      });
  };

  auth.onAuthStateChanged(user=>{
    if(!user) return;

    // âœ… CanlÄ± sipariÅŸ listesi
    db.collection("users").doc(user.uid).collection("orders")
      .orderBy("createdAt","desc").limit(20)
      .onSnapshot(snap=>{
        const arr = snap.docs.map(d=>({id:d.id, ...(d.data()||{})}));

        if(!arr.length){
          ordersEl.innerHTML = "HenÃ¼z sipariÅŸ yok.";
          return;
        }

        ordersEl.innerHTML = arr.map(o=>{
          const link = o.paymentLink || o?.payment?.link || "";
          const ref = o?.payment?.ref || "";
          const st = statusTR(o.status);

          return `
            <div style="padding:10px;border:1px solid rgba(255,255,255,.15);border-radius:12px;margin:8px 0;text-align:left;">
              <b>${o.packTitle || o.packId}</b><br>
              <div style="opacity:.85;font-size:12px;">Durum: ${st}</div>
              <div style="opacity:.85;font-size:12px;">OrderId: ${o.orderId || o.id}</div>
              ${link ? `<a href="${link}" target="_blank" style="display:inline-block;margin-top:8px;background:#00c853;color:#fff;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:900;">Ã–demeye Git</a>` : ``}
              ${link ? `
                <button onclick="markPaid('${o.orderId || o.id}')" style="margin-left:8px;background:#ffd600;border:none;padding:10px 12px;border-radius:10px;font-weight:900;cursor:pointer;">
                  Ã–dedim
                </button>` : ``}
              ${ref ? `<div style="opacity:.85;font-size:12px;margin-top:6px;">Ref: ${ref}</div>` : ``}
            </div>
          `;
        }).join("");

        if(msgEl && arr[0]) msgEl.textContent = "Son sipariÅŸ: " + statusTR(arr[0].status);
      });
  });

  // âœ… KullanÄ±cÄ± â€œÃ¶dedimâ€ bildirimi
  window.markPaid = function(orderId){
    const ref = prompt("Dekont/Referans no (opsiyonel):") || "";
    Wallet.markPaid(orderId, ref)
      .then(()=>alert("Ã–deme bildirildi âœ… Admin onaylayÄ±nca hak yÃ¼klenecek."))
      .catch(e=>alert("Hata: " + (e?.message || e)));
  };
})();
</script>

</body>
</html>




<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RaporanX ‚Ä¢ C√ºzdan</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script src="./firebase-config.js"></script>
  <script src="./wallet.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#111827;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn{background:rgba(255,255,255,.08);color:#e5e7eb;border:1px solid rgba(255,255,255,.12)}
    .buy{background:#22c55e;color:#062}
    .warn{background:#f59e0b;color:#111}
    .link{color:#60a5fa;text-decoration:none;font-weight:800}
    .muted{opacity:.75}
    input, select, textarea{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0b1220;color:#e5e7eb; width:100%; box-sizing: border-box;}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px}
  </style>
</head>

<body>
  <a href="/admin-orders.html" style="position:fixed;top:10px;right:10px;background:#ef4444;color:white;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;z-index:9999;">üîß Admin</a>

  <div class="wrap">
    <div class="row">
      <div>
        <div style="font-size:20px;font-weight:900;">üéüÔ∏è C√ºzdan</div>
        <div class="muted" id="me">Giri≈ü bekleniyor‚Ä¶</div>
      </div>
      <div class="row">
        <button class="btn" id="btnRefresh">‚Üª Yenile</button>
        <button class="btn" id="btnLogout">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="card">
      <div style="font-size:18px;font-weight:900;" id="walletAmount">‚Äî</div>
      <div class="muted" id="walletSub">‚Äî</div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div>
          <div style="font-weight:900;">üßæ Fatura Bilgilerim</div>
          <div class="muted small">Fatura kesimi i√ßin bu bilgiler kullanƒ±lacaktƒ±r.</div>
        </div>
        <div class="pill" id="billingStatus">‚Äî</div>
      </div>
      <div class="hr"></div>
      <div class="grid">
        <div><label class="small muted">Tip</label><select id="bpType"><option value="individual">≈ûahƒ±s</option><option value="company">≈ûirket</option></select></div>
        <div><label class="small muted">Ad Soyad / √únvan</label><input id="bpName"/></div>
        <div><label class="small muted">TCKN / VKN</label><input id="bpTaxId"/></div>
        <div><label class="small muted">Vergi Dairesi</label><input id="bpTaxOffice"/></div>
        <div><label class="small muted">Telefon</label><input id="bpPhone"/></div>
        <div><label class="small muted">E-posta</label><input id="bpEmail"/></div>
      </div>
      <div style="margin-top:10px;"><label class="small muted">Adres</label><textarea id="bpAddress"></textarea></div>
      <div class="row" style="margin-top:12px;justify-content:flex-end;">
        <button class="btn" id="btnBillingReload">Bilgileri Getir</button>
        <button class="buy" id="btnBillingSave">Kaydet</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px;">Paket Satƒ±n Al</div>
      <div class="row">
        <button class="buy" onclick="buy('P120')">120 TL ‚Ä¢ 4 Hak</button>
        <button class="buy" onclick="buy('P200')">200 TL ‚Ä¢ 8 Hak</button>
        <button class="buy" onclick="buy('P500')">500 TL ‚Ä¢ 25 Hak</button>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:900;margin-bottom:10px;">Sipari≈ülerim</div>
      <div id="orders" class="muted">Y√ºkleniyor‚Ä¶</div>
    </div>
  </div>

  <script>
  (function(){
    const auth = firebase.auth();
    const elMe = document.getElementById("me");
    const elOrders = document.getElementById("orders");
    const elBillingStatus = document.getElementById("billingStatus");

    // Form Elemanlarƒ±
    const fields = {
      type: document.getElementById("bpType"),
      fullName: document.getElementById("bpName"),
      tcOrVkn: document.getElementById("bpTaxId"),
      taxOffice: document.getElementById("bpTaxOffice"),
      phone: document.getElementById("bpPhone"),
      email: document.getElementById("bpEmail"),
      address: document.getElementById("bpAddress")
    };

    let unsubOrders=null, unsubBilling=null, unsubWallet=null;

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function fillBillingForm(p){
      const data = p || {};
      fields.type.value = data.type || "individual";
      fields.fullName.value = data.fullName || "";
      fields.tcOrVkn.value = data.tcOrVkn || "";
      fields.taxOffice.value = data.taxOffice || "";
      fields.phone.value = data.phone || "";
      fields.email.value = data.email || "";
      fields.address.value = data.address || "";
      elBillingStatus.textContent = (data.fullName && data.tcOrVkn) ? "Kayƒ±tlƒ± ‚úÖ" : "Eksik ‚ö†Ô∏è";
    }

    // AUTH TAKƒ∞Bƒ∞ - TEK Bƒ∞R BLOK OLARAK D√úZENLENDƒ∞
    auth.onAuthStateChanged(async (user) => {
      // √ñnceki baƒülantƒ±larƒ± temizle
      if(unsubOrders) unsubOrders();
      if(unsubBilling) unsubBilling();
      if(unsubWallet) unsubWallet();

      if(!user){
        elMe.textContent = "Giri≈ü yapmalƒ±sƒ±n.";
        elOrders.innerHTML = "Sipari≈üleri g√∂rmek i√ßin giri≈ü yap.";
        return;
      }

      elMe.innerHTML = `Giri≈ü: <b>${esc(user.email)}</b>`;

      try {
        // C√ºzdan verilerini √ßek
        await Wallet.load(user.uid);

        // Dinleyicileri Ba≈ülat
        unsubWallet = Wallet.listenWallet(user.uid);
        unsubBilling = Wallet.listenBillingProfile(user.uid, (p) => fillBillingForm(p));
        unsubOrders = Wallet.listenOrders(user.uid, (arr) => renderOrders(arr));
        
      } catch (err) {
        console.error("Y√ºkleme hatasƒ±:", err);
        elOrders.innerHTML = "Veriler ≈üu an alƒ±namƒ±yor.";
      }
    });

    // Sipari≈üleri ekrana basan fonksiyon
    function renderOrders(arr){
      if(!arr || arr.length === 0){
        elOrders.innerHTML = "Hen√ºz sipari≈ü yok.";
        return;
      }
      elOrders.innerHTML = arr.map(o => `
        <div style="padding:10px 0; border-top:1px solid rgba(255,255,255,0.1)">
          <div class="row">
            <div><b>${esc(o.packTitle || o.packId)}</b> - ${o.priceTL} TL</div>
            <div class="small">${esc(o.status)}</div>
          </div>
        </div>
      `).join("");
    }

    // Buton ƒ∞≈ülemleri
    window.buy = async (id) => { try { await Wallet.createOrder(id); alert("Sipari≈ü alƒ±ndƒ±!"); } catch(e) { alert(e.message); } };
    document.getElementById("btnLogout").onclick = () => auth.signOut();
    document.getElementById("btnBillingSave").onclick = async () => {
        const profile = {
            type: fields.type.value,
            fullName: fields.fullName.value,
            tcOrVkn: fields.tcOrVkn.value,
            taxOffice: fields.taxOffice.value,
            address: fields.address.value,
            phone: fields.phone.value,
            email: fields.email.value
        };
        try {
            await Wallet.saveBillingProfile(auth.currentUser.uid, profile);
            alert("Kaydedildi ‚úÖ");
        } catch(e) { alert(e.message); }
    };

  })();
  </script>
</body>
</html>

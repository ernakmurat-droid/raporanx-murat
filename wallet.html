/* wallet.js ‚Äî RaporanX (Wallet + Orders + Billing) */
(function(){
  const auth = firebase.auth();
  const db = firebase.firestore();

  const PACKS = {
    P120: { id:"P120", title:"120 TL ‚Ä¢ 4 Hak", priceTL:120, credits:4 },
    P200: { id:"P200", title:"200 TL ‚Ä¢ 8 Hak", priceTL:200, credits:8 },
    P500: { id:"P500", title:"500 TL ‚Ä¢ 25 Hak", priceTL:500, credits:25 },
  };

  function nowTs(){ return firebase.firestore.FieldValue.serverTimestamp(); }
  function usersDoc(uid){ return db.collection("users").doc(uid); }
  function ordersCol(uid){ return db.collection("users").doc(uid).collection("orders"); }

  async function ensureUserDoc(uid){
    const ref = usersDoc(uid);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({
        uid,
        credits: 0,
        createdAt: nowTs(),
        updatedAt: nowTs(),
      }, { merge:true });
    }
  }

  function setWalletUI(credits){
    const elAmount = document.getElementById("walletAmount");
    const elSub = document.getElementById("walletSub");
    const c = Number(credits || 0);

    if(elAmount) elAmount.textContent = `üéüÔ∏è ${c} Hak`;
    if(elSub) elSub.textContent = `Bakiyen: ${c} hak`;
  }

  const Wallet = {
    PACKS,

    async load(uid){
      if(!uid) throw new Error("Wallet.load: uid yok");
      await ensureUserDoc(uid);

      const snap = await usersDoc(uid).get();
      const data = snap.data() || {};
      setWalletUI(data.credits || 0);
      return data;
    },

    listenWallet(uid, cb){
      if(!uid) throw new Error("Wallet.listenWallet: uid yok");

      const ref = usersDoc(uid);
      const unsub = ref.onSnapshot((snap)=>{
        const data = snap.data() || {};
        setWalletUI(data.credits || 0);
        if(typeof cb === "function") cb(data);
      }, (err)=>{
        console.error("listenWallet error:", err);
      });

      return unsub;
    },

    listenBillingProfile(uid, cb){
      if(!uid) throw new Error("Wallet.listenBillingProfile: uid yok");

      const ref = usersDoc(uid);
      const unsub = ref.onSnapshot((snap)=>{
        const data = snap.data() || {};
        const profile = data.billingProfile || null;
        if(typeof cb === "function") cb(profile);
      }, (err)=>{
        console.error("listenBillingProfile error:", err);
      });

      return unsub;
    },

    listenOrders(uid, cb){
      if(!uid) throw new Error("Wallet.listenOrders: uid yok");

      const q = ordersCol(uid).orderBy("createdAt", "desc");
      const unsub = q.onSnapshot((snap)=>{
        // ‚úÖ her snapshot'ta sƒ±fƒ±rdan √ºret ‚Üí √ßoƒüalma yok
        const arr = [];
        snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
        try{ cb(arr); }catch(e){ console.warn("listenOrders cb hata:", e); }
      }, (err)=>{
        console.error("listenOrders error:", err);
        // ‚úÖ UI‚Äôde de g√∂ster
        const el = document.getElementById("orders");
        if(el){
          el.innerHTML = `<div class="muted">Sipari≈üler y√ºklenemedi: ${String(err.message || err)}</div>`;
        }
      });

      return unsub;
    },

    async createOrder(packId){
      const user = auth.currentUser;
      if(!user) throw new Error("createOrder: giri≈ü yok");

      const pack = PACKS[String(packId)];
      if(!pack) throw new Error("createOrder: packId ge√ßersiz");

      await ensureUserDoc(user.uid);

      const ref = ordersCol(user.uid).doc(); // auto id
      const order = {
        orderId: ref.id,

        uid: user.uid,
        userEmail: user.email || "",
        userName: user.displayName || "",

        packId: pack.id,
        packTitle: pack.title,
        priceTL: pack.priceTL,
        credits: pack.credits,

        status: "pending",
        paymentLink: "",
        userPaidRef: "",
        appliedToWallet: false,

        createdAt: nowTs(),
        updatedAt: nowTs(),
      };

      await ref.set(order, { merge:true });
      return order;
    },

    async markPaid(orderId, refText){
      const user = auth.currentUser;
      if(!user) throw new Error("markPaid: giri≈ü yok");
      if(!orderId) throw new Error("markPaid: orderId yok");

      const ref = ordersCol(user.uid).doc(orderId);
      await ref.set({
        status: "user_marked_paid",
        userPaidRef: (refText || "").trim(),
        updatedAt: nowTs(),
      }, { merge:true });

      return true;
    },

    async getBillingProfile(uid){
      if(!uid) throw new Error("getBillingProfile: uid yok");
      await ensureUserDoc(uid);

      const snap = await usersDoc(uid).get();
      const data = snap.data() || {};
      return data.billingProfile || null;
    },

    async saveBillingProfile(uid, profile){
      if(!uid) throw new Error("saveBillingProfile: uid yok");

      const clean = {
        type: (profile?.type || "individual"),
        fullName: (profile?.fullName || "").trim(),
        tcOrVkn: (profile?.tcOrVkn || "").trim(),
        taxOffice: (profile?.taxOffice || "").trim(),
        address: (profile?.address || "").trim(),
        phone: (profile?.phone || "").trim(),
        email: (profile?.email || "").trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };

      // minimum doƒürulama
      if(!clean.fullName) throw new Error("Ad/√únvan bo≈ü olamaz");
      if(!clean.tcOrVkn) throw new Error("TCKN/VKN bo≈ü olamaz");
      if(!clean.address) throw new Error("Adres bo≈ü olamaz");

      await usersDoc(uid).set({
        billingProfile: clean,
        updatedAt: nowTs(),
      }, { merge:true });

      return clean;
    },
  };

  window.Wallet = Wallet;
})();

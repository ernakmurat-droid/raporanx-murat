<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>RaporanX ‚Ä¢ C√ºzdan</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

 <script src="/firebase-config.js"></script>
 <script src="/wallet.js"></script>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:#0f172a;color:#e5e7eb}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .card{background:#111827;border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    button{border:0;border-radius:12px;padding:10px 12px;font-weight:800;cursor:pointer}
    .btn{background:rgba(255,255,255,.08);color:#e5e7eb;border:1px solid rgba(255,255,255,.12)}
    .buy{background:#22c55e;color:#062}
    .warn{background:#f59e0b;color:#111}
    .link{color:#60a5fa;text-decoration:none;font-weight:800}
    .muted{opacity:.75}
    input, select, textarea{padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);background:#0b1220;color:#e5e7eb}
    textarea{min-height:90px;resize:vertical;width:100%}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .small{font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);font-size:12px}
  </style>
</head>

<body>
  <a href="/admin-orders.html"
     style="position:fixed;top:10px;right:10px;background:#ef4444;color:white;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:800;z-index:9999;">
    üîß Admin
  </a>

  <div class="wrap">
    <div class="row">
      <div>
        
        <div class="muted" id="me">Giri≈ü bekleniyor‚Ä¶</div>
      </div>
      <div class="row">
        <button class="btn" id="btnRefresh">‚Üª Yenile</button>
        <button class="btn" id="btnLogout">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="card">
      <div style="font-size:18px;font-weight:900;" id="walletAmount">‚Äî</div>
      <div class="muted" id="walletSub">‚Äî</div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div>
          <div style="font-weight:900;">üßæ Fatura Bilgilerim</div>
          <div class="muted small">Fatura kesimi i√ßin bu bilgiler kullanƒ±lacaktƒ±r.</div>
        </div>
        <div class="pill" id="billingStatus">‚Äî</div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <div>
          <label class="small muted">Tip</label><br/>
          <select id="bpType">
            <option value="individual">≈ûahƒ±s</option>
            <option value="company">≈ûirket</option>
          </select>
        </div>

        <div>
          <label class="small muted">Ad Soyad / √únvan</label><br/>
          <input id="bpName" placeholder="√ñrn: Murat Ernak / RaporanX Ltd."/>
        </div>

        <div>
          <label class="small muted">TCKN / VKN</label><br/>
          <input id="bpTaxId" placeholder="11 hane (TCKN) / 10 hane (VKN)"/>
        </div>

        <div>
          <label class="small muted">Vergi Dairesi</label><br/>
          <input id="bpTaxOffice" placeholder="√ñrn: Kadƒ±k√∂y"/>
        </div>

        <div>
          <label class="small muted">Telefon</label><br/>
          <input id="bpPhone" placeholder="05xx xxx xx xx"/>
        </div>

        <div>
          <label class="small muted">E-posta</label><br/>
          <input id="bpEmail" placeholder="ornek@mail.com"/>
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="small muted">Adres</label><br/>
        <textarea id="bpAddress" placeholder="Adres..."></textarea>
      </div>

      <div class="row" style="margin-top:12px;justify-content:flex-end;">
        <button class="btn" id="btnBillingReload">Bilgileri Getir</button>
        <button class="buy" id="btnBillingSave">Kaydet</button>
      </div>

      <div class="muted small" style="margin-top:8px;">
        Not: Bilgiler <span class="mono">users/{uid}.billingProfile</span> alanƒ±na kaydedilir.
      </div>
    </div>

  <div class="card">
  <div style="font-weight:900;margin-bottom:10px;">Paket Satƒ±n Al</div>
  <div class="row">
    <button class="buy" onclick="buy('P120')">120 TL ‚Ä¢ 4 Hak</button>
    <button class="buy" onclick="buy('P200')">200 TL ‚Ä¢ 8 Hak</button>
    <button class="buy" onclick="buy('P500')">500 TL ‚Ä¢ 25 Hak</button>
  </div>
  <div class="muted" style="margin-top:10px;">
    Not: √ñdeme linki admin tarafƒ±ndan eklendiƒüinde a≈üaƒüƒ±da g√∂r√ºn√ºr.
  </div>
</div>

<div class="card">
  <div style="font-weight:900;margin-bottom:10px;">Sipari≈ülerim</div>
  <div id="orders" class="muted">Y√ºkleniyor‚Ä¶</div>
</div>
 </div> <!-- wrap kapanƒ±≈üƒ± -->
  <script>
  (function(){
    
    const auth = firebase.auth();

    const elMe = document.getElementById("me");
    const elOrders = document.getElementById("orders");

    const bpType = document.getElementById("bpType");
    const bpName = document.getElementById("bpName");
    const bpTaxId = document.getElementById("bpTaxId");
    const bpTaxOffice = document.getElementById("bpTaxOffice");
    const bpPhone = document.getElementById("bpPhone");
    const bpEmail = document.getElementById("bpEmail");
    const bpAddress = document.getElementById("bpAddress");
    const elBillingStatus = document.getElementById("billingStatus");

    let unsubOrders=null, unsubWallet=null, unsubBilling=null;
    let savingBilling=false;

    function esc(s){
      return String(s||"").replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
      </div>

   
console.log("WALLET PAGE LOADED:", location.href);
console.log("wallet.js loaded?", typeof window.Wallet);
  }

    function pickLink(o){ return (o?.paymentLink || o?.payment?.link || "").trim(); }

    function statusTr(s){
      if(s==="pending") return "Yeni sipari≈ü (link hazƒ±rlanƒ±yor) ‚è≥";
      if(s==="link_added") return "Link hazƒ±r ‚úÖ";
      if(s==="user_marked_paid") return "√ñdeme bildirildi ‚è≥";
      if(s==="approved") return "Onaylandƒ± ‚úÖ";
      if(s==="rejected") return "Reddedildi ‚ùå";
      if(s==="cancelled") return "ƒ∞ptal üö´";
      return s || "-";
    }

    function sortOrders(arr){
      return [...arr].sort((a,b)=>{
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });
    }

    function setBillingStatus(has){
      elBillingStatus.textContent = has ? "Kayƒ±tlƒ± ‚úÖ" : "Eksik ‚ö†Ô∏è";
    }

    function fillBillingForm(profile){
      const p = profile || {};
      bpType.value = p.type || "individual";
      bpName.value = p.fullName || "";
      bpTaxId.value = p.tcOrVkn || "";
      bpTaxOffice.value = p.taxOffice || "";
      bpPhone.value = p.phone || "";
      bpEmail.value = p.email || "";
      bpAddress.value = p.address || "";

      setBillingStatus(!!(p.fullName && p.tcOrVkn && p.address));
    }

    function readBillingForm(){
      return {
        type: (bpType.value || "individual"),
        fullName: (bpName.value || "").trim(),
        tcOrVkn: (bpTaxId.value || "").trim(),
        taxOffice: (bpTaxOffice.value || "").trim(),
        address: (bpAddress.value || "").trim(),
        phone: (bpPhone.value || "").trim(),
        email: (bpEmail.value || "").trim(),
      };
    }

    function renderOrders(arr){
      if(!arr || !arr.length){
        elOrders.innerHTML = `<div class="muted">Hen√ºz sipari≈ü yok.</div>`;
        return;
      }
      const sorted = sortOrders(arr);
      elOrders.innerHTML = sorted.map(o => {
        const orderId = o.orderId || o.id || "";
        const link = pickLink(o);
        const approved = (o.status === "approved");

        const btnPay = (link && !approved)
          ? `<a class="link" href="${encodeURI(link)}" target="_blank" rel="noopener">üîó √ñdemeye Git</a>`
          : `<span class="muted">${link ? "Link var" : "Link yok"}</span>`;

        const btnMarkPaid = (!approved)
          ? `<button class="warn" onclick="markPaid('${esc(orderId)}')">√ñdedim</button>`
          : ``;

        return `
          <div style="padding:10px 0;border-top:1px solid rgba(255,255,255,.10)">
            <div class="row">
              <div>
                <div style="font-weight:900">
                  ${esc(o.packTitle || o.packId)} ‚Ä¢ ${esc(o.priceTL)} TL ‚Ä¢ ${esc(o.credits)} Hak
                </div>
                <div class="muted small">
                  Durum: <b>${esc(statusTr(o.status))}</b> ‚Ä¢ orderId: <span class="mono">${esc(orderId)}</span>
                </div>
              </div>
              <div class="row">
                ${btnPay}
                ${btnMarkPaid}
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    window.buy = async function(packId){
      try{ await Wallet.createOrder(packId); alert("Sipari≈ü olu≈üturuldu ‚úÖ"); }
      catch(e){ alert("Hata: " + (e?.message || e)); }
    };

    window.markPaid = async function(orderId){
      try{
        const ref = prompt("Varsa dekont no yaz (opsiyonel):") || "";
        await Wallet.markPaid(orderId, ref);
        alert("Bildirim g√∂nderildi ‚úÖ");
      }catch(e){
        alert("Hata: " + (e?.message || e));
      }
    };

    document.getElementById("btnBillingReload").onclick = async ()=>{
      const u = auth.currentUser;
      if(!u) return alert("Giri≈ü yok.");
      const profile = await Wallet.getBillingProfile(u.uid);
      fillBillingForm(profile);
    };

    document.getElementById("btnBillingSave").onclick = async ()=>{
      const u = auth.currentUser;
      if(!u) return alert("Giri≈ü yok.");
      if(savingBilling) return;
      savingBilling = true;
      try{
        const profile = readBillingForm();
        await Wallet.saveBillingProfile(u.uid, profile);
        alert("Fatura bilgileri kaydedildi ‚úÖ");
      }catch(e){
        alert("Hata: " + (e?.message || e));
      }finally{
        savingBilling = false;
      }
    };

    document.getElementById("btnLogout").onclick = ()=> auth.signOut();
    document.getElementById("btnRefresh").onclick = async ()=>{
      const u = auth.currentUser;
      if(u) await Wallet.load(u.uid);
    };

    auth.onAuthStateChanged(async (user)=>{
      if(unsubOrders){unsubOrders();unsubOrders=null;}
      if(unsubWallet){unsubWallet();unsubWallet=null;}
      if(unsubBilling){unsubBilling();unsubBilling=null;}

      if(!user){
        elMe.textContent = "Giri≈ü yapmalƒ±sƒ±n.";
        elOrders.innerHTML = `<div class="muted">Sipari≈üleri g√∂rmek i√ßin giri≈ü yap.</div>`;
        fillBillingForm(null);
        setBillingStatus(false);
        return;
      }

      elMe.innerHTML = `Giri≈ü: <b>${esc(user.email || user.uid)}</b>`;

      await Wallet.load(user.uid);

      unsubWallet = Wallet.listenWallet(user.uid);
      unsubBilling = Wallet.listenBillingProfile(user.uid, (p)=>fillBillingForm(p));
      unsubOrders = Wallet.listenOrders(user.uid, (arr)=>renderOrders(arr));
    });
  })();
  </script>


</body>
</html>


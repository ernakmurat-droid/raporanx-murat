<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RaporAn X Taşınmaz Değerleme Sistemi</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #4a148c, #7c4dff); margin: 0; padding: 40px 20px; color: white; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; text-align: center; }
        h1 { font-size: 48px; margin-bottom: 5px; font-weight: 900; letter-spacing: -2px; }
        h1 span { color: #ff5252; }
        .slogan { font-size: 20px; margin-bottom: 40px; opacity: 0.9; font-style: italic; font-weight: 300; }
        
        .user-info-box { background: rgba(0, 0, 0, 0.2); padding: 20px; border-radius: 15px; margin-bottom: 30px; display: inline-block; min-width: 300px; }
        .count { font-size: 24px; margin: 20px 0; font-weight: bold; }
        
        .btn-new { display: block; width: 400px; max-width: 90%; margin: 20px auto; background: #00c853; color: white; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; text-decoration: none; border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); transition: 0.3s; border: none; }
        .btn-new:hover { background: #00e676; transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.4); }
        
        .btn-google { display: block; width: 350px; max-width: 90%; margin: 20px auto; background: white; color: #444; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; text-decoration: none; border-radius: 50px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: 0.3s; }
        .btn-google:hover { background: #f4f4f4; transform: scale(1.02); }
        
        .btn-logout { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 8px 15px; border-radius: 8px; cursor: pointer; margin-top: 15px; font-size: 13px; }
        .btn-logout:hover { background: rgba(255,0,0,0.3); }

        .reports { display: grid; gap: 15px; margin-top: 30px; text-align: left; }
        .report-card { background: rgba(255,255,255,0.15); padding: 20px; border-radius: 15px; position: relative; transition: 0.3s; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
        .report-card:hover { background: rgba(255,255,255,0.25); transform: translateX(5px); }
        .report-title { font-size: 22px; font-weight: bold; margin-bottom: 5px; color: #fff; }
        .report-info { font-size: 16px; opacity: 0.9; line-height: 1.4; }
        .report-date { font-size: 12px; margin-top: 10px; opacity: 0.6; }

        .delete-btn { position: absolute; top: 15px; right: 15px; background: #ff5252; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .delete-btn:hover { background: #ff1744; transform: scale(1.1); }
        
        .no-reports { font-size: 18px; opacity: 0.7; margin-top: 50px; font-style: italic; }
        
        /* Loading Spinner */
        .loader { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body>

<div class="container">
    <h1>RAPORAN <span>X</span></h1>
    <p class="slogan">“Çok karakteristik, çok abuzittik!”</p>

    <div id="authSection">
        <div id="userInfo" class="user-info-box">Oturum açılıyor, lütfen bekleyin...</div>
        <button id="loginBtn" class="btn-google" style="display:none;" onclick="loginWithGoogle()">Google ile Giriş Yap</button>
    </div>

    <div id="mainContent" style="display:none;">
        <a href="yeni_kayit.html" class="btn-new">➕ YENİ DEĞERLEME DOSYASI</a>
        <div class="count" id="reportCount">Kayıtlar yükleniyor...</div>
        <div id="reportsList" class="reports"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<script>
    const auth = window.auth;
    const db = window.db;

    // Hata Yönetimi
    auth.getRedirectResult().catch((error) => {
        if (error.code !== 'auth/redirect-cancelled-by-user') {
            alert("Giriş sırasında bir sorun oluştu: " + error.message);
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithRedirect(provider);
    }

    function fmtDate(iso) {
        if (!iso) return "Tarih belirsiz";
        const d = new Date(iso);
        return d.toLocaleDateString('tr-TR') + ' ' + d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
    }

    async function ensureUserDoc(user) {
        const userRef = db.collection("users").doc(user.uid);
        const snap = await userRef.get();
        if (!snap.exists) {
            const initialKredi = 5;
            await userRef.set({
                kredi: initialKredi,
                email: user.email,
                kayitTarihi: new Date().toISOString()
            });
            alert("Sistemimize hoş geldiniz! 5 deneme kredisi hesabınıza tanımlandı.");
            return initialKredi;
        }
        return snap.data().kredi || 0;
    }

    async function loadReports(user) {
        const listDiv = document.getElementById('reportsList');
        const countDiv = document.getElementById('reportCount');
        listDiv.innerHTML = '<div class="loader"></div>';

        try {
            const snap = await db.collection("users").doc(user.uid)
                           .collection("reports")
                           .orderBy("updatedAt", "desc")
                           .get();

            countDiv.textContent = `Toplam Kayıt: ${snap.size}`;
            
            if (snap.empty) {
                listDiv.innerHTML = '<div class="no-reports">Henüz kayıtlı raporunuz bulunmuyor.</div>';
                return;
            }

            listDiv.innerHTML = '';
            snap.forEach(doc => {
                const r = doc.data();
                const card = document.createElement('div');
                card.className = 'report-card';
                
                const title = r.propertyName || "İsimsiz Taşınmaz";
                const subtitle = `${r.il || '-'} / ${r.ilce || '-'} / ${r.mahalle || '-'}`;

                card.innerHTML = `
                    <button class="delete-btn" data-id="${doc.id}">Sil</button>
                    <div class="report-title">${title}</div>
                    <div class="report-info">
                        ${subtitle}<br>
                        Ada: ${r.ada || '?'} - Parsel: ${r.parsel || '?'}
                    </div>
                    <div class="report-date">Son Güncelleme: ${fmtDate(r.updatedAt || r.createdAt)}</div>
                `;

                // Kart Tıklama (Düzenleme)
                card.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        window.location.href = `yeni_kayit.html?id=${doc.id}`;
                    }
                };

                // Silme Butonu İşlemi
                card.querySelector('.delete-btn').onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm('Bu kaydı kalıcı olarak silmek istediğinize emin misiniz?')) {
                        await db.collection("users").doc(user.uid).collection("reports").doc(doc.id).delete();
                        loadReports(user); // Listeyi yenile
                    }
                };

                listDiv.appendChild(card);
            });
        } catch (err) {
            listDiv.innerHTML = "Veriler yüklenirken hata: " + err.message;
        }
    }

    auth.onAuthStateChanged(async (user) => {
        const loginBtn = document.getElementById('loginBtn');
        const userInfo = document.getElementById('userInfo');
        const mainContent = document.getElementById('mainContent');

        if (user) {
            loginBtn.style.display = 'none';
            mainContent.style.display = 'block';
            userInfo.innerHTML = "Kullanıcı doğrulanıyor...";
            
            const kredi = await ensureUserDoc(user);
            userInfo.innerHTML = `
                <div><strong>${user.email}</strong></div>
                <div style="color:#00c853; font-weight:bold; margin-top:5px;">Kredi: ${kredi}</div>
                <button class="btn-logout" onclick="auth.signOut().then(()=>location.reload())">Çıkış Yap</button>
            `;
            loadReports(user);
        } else {
            loginBtn.style.display = 'block';
            mainContent.style.display = 'none';
            userInfo.innerHTML = "Lütfen devam etmek için Google hesabınızla giriş yapın.";
        }
    });
</script>
</body>
</html>

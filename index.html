<!DOCTYPE html>
<html lang="tr">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">

<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RaporAn X Taşınmaz Değerleme Sistemi</title>

<style>
  body { font-family: Arial, sans-serif; background: linear-gradient(to bottom, #4a148c, #7c4dff); margin: 0; padding: 40px 20px; color: white; min-height: 100vh; }
  .container { max-width: 800px; margin: 0 auto; text-align: center; }
  h1 { font-size: 42px; margin-bottom: 10px; font-weight: 900; letter-spacing: -1px; }
  h1 span { color: #ff0000; }
  .count { font-size: 26px; margin: 40px 0; }
  .btn-new { display: block; width: 400px; max-width: 90%; margin: 20px auto; background: #00c853; color: white; padding: 25px; text-align: center; font-size: 28px; font-weight: bold; text-decoration: none; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; }
  .btn-new:hover { background: #00b140; transform: translateY(-5px); }
  .btn-google { display: block; width: 400px; max-width: 90%; margin: 10px auto; background: white; color: #444; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; text-decoration: none; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s; border: none; cursor: pointer; }
  .btn-logout { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; margin-top: 10px; }
  .slogan { font-size: 22px; margin: 10px 0 40px 0; opacity: 0.95; font-style: italic; font-weight: 300; letter-spacing: 1px; }
  .reports { display: grid; gap: 20px; margin-top: 40px; }
  .report-card { background: rgba(255,255,255,0.25); padding: 25px; border-radius: 15px; position: relative; transition: 0.3s; cursor: pointer; text-align: left; }
  .report-card:hover { background: rgba(255,255,255,0.35); transform: translateY(-8px); }
  .report-title { font-size: 24px; font-weight: bold; }
  .report-info { font-size: 18px; margin-top: 10px; opacity: 0.95; }
  .no-reports { font-size: 22px; opacity: 0.8; margin-top: 60px; }
  .delete-btn { position: absolute; top: 15px; right: 15px; background: #d32f2f; color: white; border: none; padding: 10px 15px; border-radius: 10px; cursor: pointer; font-size: 14px; }
  .delete-btn:hover { background: #b71c1c; }
  .user-info { margin-bottom: 20px; font-size: 14px; opacity: 0.9; }

  /* Debug kutusu (sadece sorun olursa görünür) */
  .debug {
    display:none;
    margin: 12px auto 0;
    max-width: 800px;
    text-align: left;
    font-size: 12px;
    white-space: pre-wrap;
    background: rgba(0,0,0,0.18);
    padding: 10px 12px;
    border-radius: 12px;
  }
</style>
</head>

<body>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<div class="container">
  <h1>RAPORAN <span>X</span></h1>
  <p class="slogan">“Çok karakteristik, çok abuzittik!”</p>

  <div id="userInfo" class="user-info">Devam etmek için Google ile giriş yapın.</div>
  <button id="loginBtn" class="btn-google" onclick="loginWithGoogle()">Google ile Giriş Yap</button>

  <div id="debugBox" class="debug"></div>

  <div id="mainContent" style="display:none;">
    <div class="count" id="reportCount">Toplam kayıt: 0</div>
    <a href="yeni_kayit.html" class="btn-new">YENİ DEĞERLEME DOSYASI AÇ</a>

    <div id="reportsList" class="reports">
      <div class="no-reports">Henüz kayıt oluşturulmadı.</div>
    </div>
  </div>
</div>

<script>
  // =============================
  // 0) Debug helper
  // =============================
  function showDebug(text){
    const box = document.getElementById("debugBox");
    box.textContent = text;
    box.style.display = "block";
  }
  function hideDebug(){
    const box = document.getElementById("debugBox");
    box.style.display = "none";
    box.textContent = "";
  }

  function friendlyAuthError(err){
    const code = err?.code || "";
    const msg = err?.message || "Bilinmeyen hata";

    if (code === "auth/unauthorized-domain") return "Yetkisiz alan adı (Authorized domains). Domain listeni kontrol et.";
    if (code === "auth/operation-not-allowed") return "Firebase’de Google ile giriş kapalı görünüyor (Sign-in method).";
    if (code === "auth/network-request-failed") return "Ağ hatası. İnternet/engel olabilir.";
    if (code === "auth/popup-blocked") return "Popup engellendi (biz redirect kullanıyoruz ama tarayıcı kısıtlıyor olabilir).";

    return `${code} - ${msg}`;
  }

  // =============================
  // 1) Firebase INIT
  // =============================
  const firebaseConfig = {
    apiKey: "AIzaSyCMwx6S6rq1lnNJuHOxc38ij3qU4ankSxs",
    authDomain: "raporanx.firebaseapp.com",
    projectId: "raporanx",
    storageBucket: "raporanx.firebasestorage.app",
    messagingSenderId: "715194328346",
    appId: "1:715194328346:web:46f0bb98941e01ead6f8a3"
  };

  try{
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  } catch(e){
    alert("Firebase init hatası: " + (e?.message || e));
  }

  const auth = firebase.auth();
  const db = firebase.firestore();

  // =============================
  // 2) Redirect sonucunu GERÇEKTEN yakala
  // =============================
  let redirectChecked = false;

  auth.getRedirectResult()
    .then((result) => {
      redirectChecked = true;
      if (result && result.user) {
        // başarılı dönüş
        hideDebug();
      }
    })
    .catch((err) => {
      redirectChecked = true;
      const nice = friendlyAuthError(err);
      showDebug("❌ Redirect sonucu hatası:\n" + nice);
      alert("Giriş Hatası: " + nice);
    });

  // Eğer redirect sonucu gecikirse, UI takılı kalmasın diye kısa bir fallback
  setTimeout(() => {
    if (!redirectChecked) redirectChecked = true;
  }, 2000);

  // =============================
  // 3) Login fonksiyonunu GLOBAL yap
  // =============================
  window.loginWithGoogle = function loginWithGoogle() {
    try{
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithRedirect(provider).catch((err) => {
        const nice = friendlyAuthError(err);
        showDebug("❌ signInWithRedirect hatası:\n" + nice);
        alert("Giriş Hatası: " + nice);
      });
    } catch(e){
      alert("Login fonksiyonu hatası: " + (e?.message || e));
    }
  }

  function fmtDate(iso){
    if(!iso) return "Tarih yok";
    try { return new Date(iso).toLocaleString("tr-TR"); } catch(e){ return iso; }
  }

  async function ensureUserDoc(user){
    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();
    if(!snap.exists){
      await userRef.set({ kredi: 5, kayitTarihi: new Date().toISOString(), email: user.email });
      alert("Hoş geldin! 5 ücretsiz kredi tanımlandı.");
      return 5;
    }
    return snap.data().kredi || 0;
  }

  async function loadReportsFromCloud(user){
    const list = document.getElementById('reportsList');
    const count = document.getElementById('reportCount');

    list.innerHTML = '<div class="no-reports">☁️ Raporlar yükleniyor...</div>';

    let snap;
    try{
      snap = await db.collection("users").doc(user.uid)
        .collection("reports")
        .orderBy("updatedAt", "desc")
        .get();
    } catch(err){
      showDebug("❌ Firestore okuma hatası:\n" + (err?.message || err));
      list.innerHTML = '<div class="no-reports">❌ Raporlar okunamadı. Yetki/kurallar sorunu olabilir.</div>';
      return;
    }

    const reports = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    count.textContent = `Toplam kayıt: ${reports.length}`;

    if(reports.length === 0){
      list.innerHTML = '<div class="no-reports">Henüz kayıt oluşturulmadı.</div>';
      return;
    }

    list.innerHTML = '';
    reports.forEach((r) => {
      const card = document.createElement('div');
      card.className = 'report-card';
      const title = (r.propertyName && r.propertyName.trim() !== '') ? r.propertyName : 'İsimsiz Gayrimenkul';

      card.innerHTML = `
        <button class="delete-btn">Sil</button>
        <div class="report-title">${title}</div>
        <div class="report-info">
          ${r.il || ''} / ${r.ilce || ''} / ${r.mahalle || ''}<br>
          Ada: ${r.ada || ''} - Parsel: ${r.parsel || ''}<br>
          <small>Oluşturulma: ${fmtDate(r.createdAt)}</small>
        </div>
      `;

      card.onclick = (e) => {
        if (!e.target.classList.contains('delete-btn')) {
          window.location.href = `rapor-detay.html?id=${encodeURIComponent(r.id)}`;
        }
      };

      const delBtn = card.querySelector('.delete-btn');
      delBtn.onclick = async (event) => {
        event.stopPropagation();
        if (!confirm('Bu raporu silmek istediğinize emin misiniz?')) return;
        delBtn.disabled = true;

        try{
          await db.collection("users").doc(user.uid).collection("reports").doc(r.id).delete();
          await loadReportsFromCloud(user);
        } catch(err){
          alert("Silme hatası: " + err.message);
          delBtn.disabled = false;
        }
      };

      list.appendChild(card);
    });
  }

  // =============================
  // 4) Auth state: redirect sonucu oturmadan "user yok" diye zıplatma
  // =============================
  auth.onAuthStateChanged(async (user) => {
    const loginBtn = document.getElementById('loginBtn');
    const userInfo = document.getElementById('userInfo');
    const mainContent = document.getElementById('mainContent');

    // Redirect kontrolü yapılmadan UI'yi sağa sola çekmeyelim
    if (!redirectChecked) {
      loginBtn.style.display = 'none';
      mainContent.style.display = 'none';
      userInfo.textContent = "Giriş kontrol ediliyor... (1-2 sn)";
      return;
    }

    if(user){
      loginBtn.style.display = 'none';
      mainContent.style.display = 'block';

      let kredi = 0;
      try { kredi = await ensureUserDoc(user); } catch(e){}

      userInfo.innerHTML = `Bağlı Hesap: ${user.email}<br><b>Kredi: ${kredi}</b><br>
        <button class="btn-logout" onclick="auth.signOut().then(()=>location.reload())">Çıkış Yap</button>`;

      await loadReportsFromCloud(user);
    } else {
      loginBtn.style.display = 'block';
      mainContent.style.display = 'none';
      userInfo.textContent = "Devam etmek için Google ile giriş yapın.";
    }
  });
</script>
</body>
</html>

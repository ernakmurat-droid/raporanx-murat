<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>RaporanX â€¢ Admin SipariÅŸler</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- senin config -->
  <script src="firebase-config.js"></script>

  <style>
    body{font-family:Arial, sans-serif; margin:0; background:#0f172a; color:#e5e7eb;}
    .wrap{max-width:1100px; margin:0 auto; padding:18px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .card{background:#111827; border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .btn{border:none; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:800;}
    .btn.primary{background:#22c55e;}
    .btn.warn{background:#f59e0b;}
    .btn.danger{background:#ef4444;}
    .btn.ghost{background:rgba(255,255,255,.08); color:#e5e7eb; border:1px solid rgba(255,255,255,.12);}
    input, select{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:#e5e7eb;}
    .grid{display:grid; gap:12px;}
    .row{display:grid; gap:10px; grid-template-columns: 1.4fr .9fr .9fr 1fr; align-items:center;}
    @media(max-width:900px){ .row{grid-template-columns: 1fr;}}
    .muted{opacity:.75}
    .tag{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12);}
    .tag.ok{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35);}
    .tag.wait{background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.35);}
    .tag.bad{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35);}
    .line{height:1px; background:rgba(255,255,255,.08); margin:10px 0;}
    a{color:#60a5fa; text-decoration:none}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="font-size:20px;font-weight:900;">ðŸ§¾ Admin SipariÅŸler</div>
        <div class="muted small">Yeni sipariÅŸleri buradan gÃ¶r, link ekle, onayla.</div>
      </div>
      <div class="card" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <select id="statusFilter">
          <option value="active">Aktif (pending/link_added/user_marked_paid)</option>
          <option value="all">Hepsi</option>
          <option value="pending">pending</option>
          <option value="link_added">link_added</option>
          <option value="user_marked_paid">user_marked_paid</option>
          <option value="approved">approved</option>
          <option value="rejected">rejected</option>
          <option value="cancelled">cancelled</option>
        </select>

        <input id="searchBox" placeholder="Ara: email / paket / orderId / uid" />

        <button class="btn ghost" id="btnRefresh">Yenile</button>
        <button class="btn danger" id="btnLogout">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </div>

    <div class="line"></div>

    <div id="me" class="card small muted">GiriÅŸ bekleniyorâ€¦</div>

    <div class="line"></div>

    <div id="list" class="grid"></div>
  </div>

<script>
(function(){
  const auth = firebase.auth();
  const db = firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  // âœ… BURAYA admin mail(ler)i yaz
  const ADMIN_EMAILS = [
    "ernakmurat@gmail.com"
  ].map(x => (x || "").toLowerCase().trim());

  const elList   = document.getElementById("list");
  const elMe     = document.getElementById("me");
  const elFilter = document.getElementById("statusFilter");
  const elSearch = document.getElementById("searchBox");

  let _unsub = null;
  let _cache = [];

  function trStatus(s){
    if(s === "approved") return "OnaylandÄ± âœ…";
    if(s === "user_marked_paid") return "Ã–deme bildirildi â³";
    if(s === "link_added") return "Link eklendi â³";
    if(s === "pending") return "Yeni sipariÅŸ â³";
    if(s === "rejected") return "Reddedildi âŒ";
    if(s === "cancelled") return "Ä°ptal";
    return s || "-";
  }

  function tagClass(s){
    if(s === "approved") return "ok";
    if(s === "rejected") return "bad";
    if(["pending","link_added","user_marked_paid"].includes(s)) return "wait";
    return "";
  }

  function ts(x){
    try{
      const d = x?.toDate ? x.toDate() : (x ? new Date(x) : null);
      if(!d) return "-";
      return d.toLocaleString("tr-TR");
    }catch(e){ return "-"; }
  }

  function getParentUid(docRef){
    // users/{uid}/orders/{orderId}
    try{ return docRef?.parent?.parent?.id || ""; }
    catch(e){ return ""; }
  }

  function filterRows(rows){
    const mode = elFilter.value;
    const q = (elSearch.value || "").trim().toLowerCase();

    let out = rows;

    if(mode === "active"){
      out = out.filter(x => ["pending","link_added","user_marked_paid"].includes(x.status));
    } else if(mode !== "all"){
      out = out.filter(x => x.status === mode);
    }

    if(q){
      out = out.filter(x => {
        const blob = [
          x.orderId, x.packId, x.packTitle, x.userEmail, x.userName, x.uid, x._parentUid
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }

    return out;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function render(){
    const rows = filterRows(_cache);

    if(!rows.length){
      elList.innerHTML = `<div class="card muted">HiÃ§ sipariÅŸ yok (bu filtrede).</div>`;
      return;
    }

    elList.innerHTML = rows.map(o => {
      const uid = o.uid || o._parentUid || "";
      const payLink = o.paymentLink || o?.payment?.link || "";
      const payRef  = o?.payment?.ref  || "";

      const btnLink = `<button class="btn warn" onclick="addLink('${escapeHtml(uid)}','${escapeHtml(o.orderId)}')">ðŸ”— Link Ekle</button>`;
      const btnApprove = `<button class="btn primary" onclick="approve('${escapeHtml(uid)}','${escapeHtml(o.orderId)}')">âœ… Onayla</button>`;

      const linkPart = payLink
        ? `<div class="small">Link: <a href="${escapeHtml(payLink)}" target="_blank">${escapeHtml(payLink)}</a></div>`
        : `<div class="small muted">Link: (yok)</div>`;

      const refPart = payRef
        ? `<div class="small">Ref/Dekont: <span class="mono">${escapeHtml(payRef)}</span></div>`
        : `<div class="small muted">Ref/Dekont: (yok)</div>`;

      const who = (o.userName || o.userEmail)
        ? `${escapeHtml(o.userName || "")} ${o.userEmail ? "â€¢ "+escapeHtml(o.userEmail) : ""}`
        : (uid ? `UID: ${escapeHtml(uid)}` : "-");

      return `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-weight:900; font-size:16px">${escapeHtml(o.packTitle || o.packId || "Paket")}</div>
              <div class="small muted">${who}</div>
              <div class="small muted">orderId: <span class="mono">${escapeHtml(o.orderId)}</span> â€¢ created: ${ts(o.createdAt)}</div>
              <div class="small muted">uid: <span class="mono">${escapeHtml(uid || "-")}</span></div>
            </div>

            <div>
              <span class="tag ${tagClass(o.status)}">${escapeHtml(trStatus(o.status))}</span>
              <div class="small muted" style="margin-top:8px">Tutar: <b>${escapeHtml(o.priceTL || "-")} TL</b> â€¢ Hak: <b>${escapeHtml(o.credits || "-")}</b></div>
              <div class="small muted">updated: ${ts(o.updatedAt)}</div>
            </div>

            <div>
              ${linkPart}
              ${refPart}
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
              ${btnLink}
              ${btnApprove}
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function ensureAdmin(user){
    const email = (user?.email || "").toLowerCase().trim();
    const ok = user && ADMIN_EMAILS.includes(email);
    if(!ok){
      elMe.innerHTML = `â›” Bu sayfa sadece admin iÃ§indir. (GiriÅŸ yapan: <b>${escapeHtml(user?.email || "-")}</b>)`;
      throw new Error("admin deÄŸil");
    }
    elMe.innerHTML = `âœ… Admin: <b>${escapeHtml(user.email)}</b> â€¢ UID: <span class="mono">${escapeHtml(user.uid)}</span>`;
  }

  function startListen(){
    if(_unsub) _unsub();

    // âœ… tÃ¼m users/*/orders alt koleksiyonlarÄ±nÄ± toplar
    _unsub = db.collectionGroup("orders")
      .orderBy("createdAt","desc")
      .limit(200)
      .onSnapshot((snap)=>{
        const arr = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          d.orderId = d.orderId || doc.id;
          d._parentUid = getParentUid(doc.ref);
          d.uid = d.uid || d._parentUid; // yoksa parent'tan tamamla
          arr.push(d);
        });
        _cache = arr;
        render();
      }, (err)=>{
        elList.innerHTML = `<div class="card" style="border-color:rgba(239,68,68,.35)">Hata: ${escapeHtml(err?.message || err)}</div>`;
      });
  }

  // âœ… Link ekle: hem paymentLink hem payment.link yazÄ±yoruz (uyum iÃ§in)
  window.addLink = async function(uid, orderId){
    try{
      uid = (uid || "").trim();
      orderId = (orderId || "").trim();
      if(!uid || !orderId) return alert("uid/orderId yok");

      const link = (prompt("QNB Ã¶deme linkini yapÄ±ÅŸtÄ±r:") || "").trim();
      if(!link) return;

      const ref = db.collection("users").doc(uid).collection("orders").doc(orderId);
      await ref.set({
        status: "link_added",
        paymentLink: link, // âœ… kullanÄ±cÄ± tarafÄ± bunu okuyorsa
        payment: {
          link: link,        // âœ… eski yapÄ± da Ã§alÄ±ÅŸsÄ±n
          linkAddedAt: FieldValue.serverTimestamp(),
        },
        updatedAt: FieldValue.serverTimestamp()
      }, { merge:true });

      alert("Link eklendi âœ…");
    }catch(e){
      alert(e?.message || e);
    }
  };

  // âœ… Onayla: transaction ile tek seferlik hak yÃ¼kleme
  window.approve = async function(uid, orderId){
    try{
      uid = (uid || "").trim();
      orderId = (orderId || "").trim();
      if(!uid || !orderId) return alert("uid/orderId yok");

      const ok = confirm("Ã–deme geldi mi? OnaylayÄ±nca hak yÃ¼klenecek (tek sefer).");
      if(!ok) return;

      const orderRef  = db.collection("users").doc(uid).collection("orders").doc(orderId);
      const walletRef = db.collection("wallets").doc(uid);

      await db.runTransaction(async (tx) => {
        const orderSnap = await tx.get(orderRef);
        if(!orderSnap.exists) throw new Error("SipariÅŸ bulunamadÄ±.");

        const o = orderSnap.data() || {};

        if(o.appliedToWallet) {
          // zaten uygulanmÄ±ÅŸsa dokunma
          return;
        }

        const creditsToAdd = Number(o.credits || 0);
        if(!creditsToAdd || creditsToAdd < 1) throw new Error("SipariÅŸ credits hatalÄ±.");

        // wallet yoksa oluÅŸtur
        const walletSnap = await tx.get(walletRef);
        if(!walletSnap.exists){
          tx.set(walletRef, {
            uid,
            credits: 0,
            createdAt: FieldValue.serverTimestamp(),
            updatedAt: FieldValue.serverTimestamp()
          }, { merge:true });
        }

        // kredi ekle
        tx.set(walletRef, {
          credits: FieldValue.increment(creditsToAdd),
          updatedAt: FieldValue.serverTimestamp()
        }, { merge:true });

        // sipariÅŸi kilitle
        tx.set(orderRef, {
          status: "approved",
          appliedToWallet: true,
          approvedAt: FieldValue.serverTimestamp(),
          updatedAt: FieldValue.serverTimestamp()
        }, { merge:true });
      });

      alert("OnaylandÄ± âœ… Hak yÃ¼klendi (veya zaten onaylÄ±ydÄ±).");
    }catch(e){
      alert(e?.message || e);
    }
  };

  document.getElementById("btnLogout").onclick = ()=> auth.signOut();
  document.getElementById("btnRefresh").onclick = ()=> render();
  elFilter.onchange = render;
  elSearch.oninput = render;

  auth.onAuthStateChanged(async (user)=>{
    try{
      if(!user){
        elMe.innerHTML = `GiriÅŸ yok. <a href="index.html">Ana sayfadan giriÅŸ yap</a>`;
        if(_unsub) _unsub();
        return;
      }
      await ensureAdmin(user);
      startListen();
    }catch(e){
      if(_unsub) _unsub();
    }
  });
})();
</script>
</body>
</html>

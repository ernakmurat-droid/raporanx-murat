<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>RaporanX ‚Ä¢ Admin</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <!-- Tek kaynak config -->
  <script src="/firebase-config.js"></script>
  <!-- Wallet -->
  <script src="/wallet.js"></script>

  <style>
    body{font-family:Arial, sans-serif; margin:0; background:#0f172a; color:#e5e7eb;}
    .wrap{max-width:1100px; margin:0 auto; padding:18px;}
    .top{display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;}
    .card{background:#111827; border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25);}
    .btn{border:none; border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:900;}
    .btn.primary{background:#22c55e;}
    .btn.warn{background:#f59e0b;}
    .btn.danger{background:#ef4444; color:#fff;}
    .btn.ghost{background:rgba(255,255,255,.08); color:#e5e7eb; border:1px solid rgba(255,255,255,.12);}
    input, select, textarea{padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0b1220; color:#e5e7eb; width:100%;}
    .grid{display:grid; gap:12px;}
    .row{display:grid; gap:10px; grid-template-columns: 1.4fr .9fr 1.2fr 1fr; align-items:center;}
    @media(max-width:900px){ .row{grid-template-columns: 1fr;}}
    .muted{opacity:.75}
    .tag{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:900; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.12);}
    .tag.ok{background:rgba(34,197,94,.18); border-color:rgba(34,197,94,.35);}
    .tag.wait{background:rgba(245,158,11,.18); border-color:rgba(245,158,11,.35);}
    .tag.bad{background:rgba(239,68,68,.18); border-color:rgba(239,68,68,.35);}
    .line{height:1px; background:rgba(255,255,255,.08); margin:12px 0;}
    a{color:#60a5fa; text-decoration:none}
    .small{font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
    .two{display:grid; gap:12px; grid-template-columns: 1fr 1fr;}
    @media(max-width:900px){ .two{grid-template-columns:1fr;} }

    /* ‚úÖ Fatura modal */
    #billModal{
      display:none;
      position:fixed;
      inset:0;
      z-index:9999999;
      background:rgba(0,0,0,.55);
      padding:12px;
      overflow:auto;
    }
    #billModalCard{
      max-width:720px;
      margin:12px auto;
      background:#111827;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35);
      padding:14px;
    }
    .kv{display:grid; grid-template-columns: 140px 1fr; gap:10px; align-items:start; margin-top:8px;}
    @media(max-width:720px){ .kv{grid-template-columns: 1fr; } }
    .k{opacity:.75; font-size:12px;}
    .v{font-weight:800;}
    .v.mono{font-weight:700;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div style="font-size:20px;font-weight:1000;">üîß Admin ‚Ä¢ Sipari≈ü & Hak</div>
        <div class="muted small">Liste √ßalƒ±≈ümazsa bile alttan UID+OrderId ile manuel i≈ülem yap.</div>
      </div>

      <div class="card" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn ghost" id="btnToggleMode">Mod: Liste</button>
        <button class="btn ghost" id="btnRefresh">Yenile</button>
        <button class="btn danger" id="btnLogout">√áƒ±kƒ±≈ü</button>
      </div>
    </div>

    <div class="line"></div>

    <div id="me" class="card small muted">Giri≈ü bekleniyor‚Ä¶</div>

    <div class="line"></div>

    <!-- MANUEL MOD -->
    <div id="manualBox" class="card" style="display:none;">
      <div style="font-weight:1000; margin-bottom:10px;">üß∑ Manuel ƒ∞≈ülem (Liste gelmezse buradan y√ºr√ºr)</div>

      <div class="two">
        <div>
          <div class="small muted" style="margin-bottom:6px;">UID</div>
          <input id="mUid" placeholder="√ñrn: qqNiOTkBC0eKMGb5cKFnD9CsoPx2" />
        </div>
        <div>
          <div class="small muted" style="margin-bottom:6px;">OrderId</div>
          <input id="mOrderId" placeholder="√ñrn: wbOOCozv9RIkA2Tv2SUL" />
        </div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
        <button class="btn ghost" id="btnLoadOrder">üì• Sipari≈üi A√ß</button>
        <button class="btn warn" id="btnSetLink">üîó Link Ekle</button>
        <button class="btn ghost" id="btnExpire">‚è± Expired</button>
        <button class="btn primary" id="btnApprove">‚úÖ Onayla</button>
        <button class="btn danger" id="btnDelete">üóë Sil</button>
        <button class="btn ghost" id="btnShowBilling">üßæ Fatura</button>
      </div>

      <div class="line"></div>

      <div class="small muted">Sipari≈ü Detayƒ±</div>
      <pre id="mOut" class="mono" style="white-space:pre-wrap; margin:8px 0 0; background:#0b1220; border:1px solid rgba(255,255,255,.12); padding:12px; border-radius:12px; min-height:80px;">-</pre>
    </div>

    <!-- Lƒ∞STE MOD -->
    <div id="listBox">
      <div class="card" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <select id="statusFilter" style="max-width:420px;">
          <option value="active">Aktif (pending/link_sent/user_marked_paid)</option>
          <option value="all">Hepsi</option>
          <option value="pending">pending</option>
          <option value="link_sent">link_sent</option>
          <option value="user_marked_paid">user_marked_paid</option>
          <option value="approved">approved</option>
          <option value="expired">expired</option>
          <option value="rejected">rejected</option>
          <option value="cancelled">cancelled</option>
        </select>

        <input id="searchBox" placeholder="Ara: email / paket / orderId / uid" style="max-width:420px;" />
        <div id="listHint" class="small muted">Liste y√ºkleniyor‚Ä¶</div>
      </div>

      <div class="line"></div>
      <div id="list" class="grid"></div>
    </div>
  </div>

  <!-- ‚úÖ FATURA MODAL -->
  <div id="billModal">
    <div id="billModalCard">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div style="font-weight:1000; font-size:18px;">üßæ Fatura Bilgileri</div>
        <button class="btn ghost" onclick="closeBilling()">Kapat ‚úñ</button>
      </div>

      <div class="line"></div>

      <div class="small muted">UID: <span id="billUid" class="mono">-</span></div>

      <div id="billBody" style="margin-top:10px;">
        Y√ºkleniyor‚Ä¶
      </div>

      <div class="line"></div>

      <div class="small muted">
        Kaynak: <span class="mono">kullanicilar/{uid}/invoiceProfile/main</span>
      </div>
    </div>
  </div>

<script>
(function(){
  const auth = window.auth || firebase.auth();
  const db = window.db || firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  const ADMIN_EMAILS = ["muraternak@gmail.com","ernakmurat@gmail.com"].map(x=>String(x).toLowerCase());

  const elMe = document.getElementById("me");
  const elList = document.getElementById("list");
  const elFilter = document.getElementById("statusFilter");
  const elSearch = document.getElementById("searchBox");
  const elHint = document.getElementById("listHint");

  const manualBox = document.getElementById("manualBox");
  const listBox   = document.getElementById("listBox");
  const btnToggle = document.getElementById("btnToggleMode");

  const mUid = document.getElementById("mUid");
  const mOrderId = document.getElementById("mOrderId");
  const mOut = document.getElementById("mOut");

  // billing modal elements
  const billModal = document.getElementById("billModal");
  const billUidEl = document.getElementById("billUid");
  const billBody  = document.getElementById("billBody");

  let mode = "list";
  let _unsub = null;
  let _cache = [];

  function esc(s){
    return String(s||"").replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  function openBilling(uid){
    billUidEl.textContent = uid || "-";
    billBody.innerHTML = "Y√ºkleniyor‚Ä¶";
    billModal.style.display = "block";
  }
  window.closeBilling = function(){
    billModal.style.display = "none";
  };

  async function fetchBilling(uid){
    uid = String(uid||"").trim();
    if(!uid) throw new Error("UID yok");

    openBilling(uid);

    const ref = db.collection("kullanicilar").doc(uid).collection("invoiceProfile").doc("main");
    const snap = await ref.get();

    if(!snap.exists){
      billBody.innerHTML = `<div class="muted">Bu kullanƒ±cƒ± i√ßin fatura kaydƒ± yok.</div>`;
      return;
    }

    const p = snap.data() || {};
    const has = (p.fullName && p.tcOrVkn && p.address);

    billBody.innerHTML = `
      <div class="card" style="box-shadow:none;">
        <div class="tag ${has ? "ok" : "wait"}">${has ? "Kayƒ±tlƒ± ‚úÖ" : "Eksik ‚ö†Ô∏è"}</div>

        <div class="kv"><div class="k">Tip</div><div class="v">${esc(p.type || "-")}</div></div>
        <div class="kv"><div class="k">Ad/√únvan</div><div class="v">${esc(p.fullName || "-")}</div></div>
        <div class="kv"><div class="k">TCKN/VKN</div><div class="v mono">${esc(p.tcOrVkn || "-")}</div></div>
        <div class="kv"><div class="k">Vergi Dairesi</div><div class="v">${esc(p.taxOffice || "-")}</div></div>
        <div class="kv"><div class="k">Telefon</div><div class="v">${esc(p.phone || "-")}</div></div>
        <div class="kv"><div class="k">E-posta</div><div class="v">${esc(p.email || "-")}</div></div>
        <div class="kv"><div class="k">Adres</div><div class="v">${esc(p.address || "-")}</div></div>

        <div class="line"></div>
        <div class="small muted">updatedAt: <span class="mono">${esc(String(p.updatedAt?.toDate ? p.updatedAt.toDate().toLocaleString("tr-TR") : (p.updatedAt || "-")))}</span></div>
      </div>
    `;
  }

  function setMode(next){
    mode = next;
    if(mode === "manual"){
      manualBox.style.display = "block";
      listBox.style.display = "none";
      btnToggle.textContent = "Mod: Manuel";
      if(_unsub) { _unsub(); _unsub = null; }
      elHint.textContent = "";
    }else{
      manualBox.style.display = "none";
      listBox.style.display = "block";
      btnToggle.textContent = "Mod: Liste";
      startListen();
    }
  }

  function trStatus(s){
    if(s === "approved") return "Onaylandƒ± ‚úÖ";
    if(s === "user_marked_paid") return "√ñdeme bildirildi ‚è≥";
    if(s === "link_sent") return "Link g√∂nderildi ‚è≥";
    if(s === "expired") return "S√ºresi doldu ‚è±Ô∏è";
    if(s === "pending") return "Yeni sipari≈ü ‚è≥";
    if(s === "rejected") return "Reddedildi ‚ùå";
    if(s === "cancelled") return "ƒ∞ptal";
    return s || "-";
  }

  function tagClass(s){
    if(s === "approved") return "ok";
    if(s === "rejected") return "bad";
    if(["pending","link_sent","user_marked_paid","expired","cancelled"].includes(s)) return "wait";
    return "";
  }

  function ts(x){
    try{
      const d = x?.toDate ? x.toDate() : (x ? new Date(x) : null);
      if(!d) return "-";
      return d.toLocaleString("tr-TR");
    }catch(e){ return "-"; }
  }

  function getParentUid(docRef){
    try{ return docRef?.parent?.parent?.id || ""; }
    catch(e){ return ""; }
  }

  function filterRows(rows){
    const modeF = elFilter.value;
    const q = (elSearch.value || "").trim().toLowerCase();
    let out = rows;

    if(modeF === "active"){
      out = out.filter(x => ["pending","link_sent","user_marked_paid"].includes(x.status));
    } else if(modeF !== "all"){
      out = out.filter(x => x.status === modeF);
    }

    if(q){
      out = out.filter(x => {
        const blob = [
          x.orderId, x.packId, x.packTitle, x.userEmail, x.userName, x.uid, x._parentUid
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });
    }
    return out;
  }

  function render(){
    const rows = filterRows(_cache);

    if(!rows.length){
      elList.innerHTML = `<div class="card muted">Bu filtrede sipari≈ü yok (ya da liste √ßalƒ±≈ümƒ±yor). Modu ‚ÄúManuel‚Äù yapƒ±p UID+OrderId ile devam edebilirsin.</div>`;
      return;
    }

    elList.innerHTML = rows.map(o => {
      const uid = o.uid || o._parentUid || "";
      const payLink = (o?.payment?.link || o?.paymentLink || "").trim();
      const payRef  = (o?.payment?.ref  || o?.paymentRef  || "").trim();

      const who = (o.userName || o.userEmail)
        ? `${o.userName || ""} ${o.userEmail ? "‚Ä¢ "+o.userEmail : ""}`
        : (uid ? `UID: ${uid}` : "-");

      const oid = o._docId || o.orderId || "";

      return `
        <div class="card">
          <div class="row">
            <div>
              <div style="font-weight:1000; font-size:16px">${esc(o.packTitle || o.packId || "Paket")}</div>
              <div class="small muted">${esc(who)}</div>
              <div class="small muted">orderId: <span class="mono">${esc(o.orderId || oid)}</span> ‚Ä¢ created: ${esc(ts(o.createdAt))}</div>
              <div class="small muted">uid: <span class="mono">${esc(uid || "-")}</span></div>
            </div>

            <div>
              <span class="tag ${tagClass(o.status)}">${esc(trStatus(o.status))}</span>
              <div class="small muted" style="margin-top:8px">Tutar: <b>${esc(o.priceTL || "-")} TL</b> ‚Ä¢ Hak: <b>${esc(o.credits || "-")}</b></div>
              <div class="small muted">updated: ${esc(ts(o.updatedAt))}</div>
            </div>

            <div>
              ${payLink ? `<div class="small">Link: <a href="${esc(payLink)}" target="_blank" rel="noopener noreferrer">${esc(payLink)}</a></div>` : ``}
              ${payRef ? `<div class="small">Ref/Dekont: <span class="mono">${esc(payRef)}</span></div>` : ``}
            </div>

            <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
              <button class="btn ghost" onclick="ADMIN_showBilling('${esc(uid)}')">üßæ Fatura</button>
              <button class="btn warn" onclick="ADMIN_setLink('${esc(uid)}','${esc(oid)}')">üîó Link Ekle</button>
              <button class="btn ghost" onclick="ADMIN_expire('${esc(uid)}','${esc(oid)}')">‚è± Expired</button>
              <button class="btn primary" onclick="ADMIN_approve('${esc(uid)}','${esc(oid)}')">‚úÖ Onayla</button>
              <button class="btn danger" onclick="ADMIN_delete('${esc(uid)}','${esc(oid)}')">üóë Sil</button>
            </div>
          </div>
        </div>
      `;
    }).join("");
  }

  async function ensureAdmin(user){
    const ok = user && ADMIN_EMAILS.includes(String(user.email||"").toLowerCase());
    if(!ok){
      elMe.innerHTML = `‚õî Admin deƒüilsin. (Giri≈ü yapan: <b>${user?.email || "-"}</b>)`;
      throw new Error("admin deƒüil");
    }
    elMe.innerHTML = `‚úÖ Admin: <b>${esc(user.email)}</b> ‚Ä¢ UID: <span class="mono">${esc(user.uid)}</span> ‚Ä¢ <a href="/wallet.html">wallet</a>`;
  }

  function startListen(){
    if(mode !== "list") return;
    if(_unsub) _unsub();

    elHint.textContent = "Liste dinleniyor‚Ä¶";

    _unsub = db.collectionGroup("siparisler")
      .limit(200)
      .onSnapshot((snap)=>{
        const arr = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          d._docId = doc.id;
          d.orderId = d.orderId || doc.id;
          d._parentUid = getParentUid(doc.ref);
          d.uid = d.uid || d._parentUid;
          arr.push(d);
        });
        _cache = arr;
        elHint.textContent = `Toplam: ${arr.length}`;
        render();
      }, (err)=>{
        elHint.textContent = "Liste hatasƒ±. Manuel moda ge√ßebilirsin.";
        elList.innerHTML = `<div class="card" style="border-color:rgba(239,68,68,.35)">
          Liste √ßekilemedi: <b>${esc(err?.message||err)}</b><br><br>
          <span class="muted small">√á√∂z√ºm: Manuel moda ge√ß ‚Üí UID+OrderId ile link ekle/onayla.</span>
        </div>`;
      });
  }

  // ‚úÖ yeni: fatura g√∂ster
  window.ADMIN_showBilling = async function(uid){
    try{
      await fetchBilling(uid);
    }catch(e){
      alert(e?.message || e);
    }
  };

  window.ADMIN_setLink = async function(uid, orderId){
    try{
      uid = String(uid||"").trim();
      orderId = String(orderId||"").trim();
      if(!uid || !orderId) return alert("uid/orderId yok");

      const link = (prompt("QNB √∂deme linkini yapƒ±≈ütƒ±r:") || "").trim();
      if(!link) return;

      const payRef = (prompt("Ref/Dekont no (opsiyonel):") || "").trim();

      const orderRef = db.collection("kullanicilar").doc(uid).collection("siparisler").doc(orderId);

      await orderRef.set({
        status: "link_sent",
        paymentLink: link,
        paymentRef: payRef,
        payment: {
          link: link,
          ref: payRef,
          linkAddedAt: FieldValue.serverTimestamp()
        },
        updatedAt: FieldValue.serverTimestamp()
      }, { merge: true });

      alert("Link eklendi ‚úÖ");
    }catch(e){
      alert(e?.message || e);
    }
  };

  window.ADMIN_expire = async function(uid, orderId){
    try{
      uid = String(uid||"").trim();
      orderId = String(orderId||"").trim();
      if(!uid || !orderId) return alert("uid/orderId yok");

      const ok = confirm("Bu sipari≈üi 'expired' yapmak istiyor musun? (Silinmez, kapanƒ±r)");
      if(!ok) return;

      await db.collection("kullanicilar").doc(uid).collection("siparisler").doc(orderId).set({
        status: "expired",
        expiredAt: FieldValue.serverTimestamp(),
        updatedAt: FieldValue.serverTimestamp()
      }, { merge:true });

      alert("Expired yapƒ±ldƒ± ‚úÖ");
    }catch(e){
      alert(e?.message || e);
    }
  };

  window.ADMIN_approve = async function(uid, orderId){
    try{
      uid = String(uid||"").trim();
      orderId = String(orderId||"").trim();
      if(!uid || !orderId) return alert("uid/orderId yok");

      const ok = confirm("√ñdeme geldi mi? Onaylayƒ±nca hak y√ºklenecek.");
      if(!ok) return;

      if(!window.Wallet?.approveOrder) throw new Error("Wallet.approveOrder yok (wallet.js y√ºklenmedi?)");
      const res = await Wallet.approveOrder(uid, orderId);
      console.log("approve:", res);
      alert("Onaylandƒ± ‚úÖ");
    }catch(e){
      alert(e?.message || e);
    }
  };

  window.ADMIN_delete = async function(uid, orderId){
    try{
      uid = String(uid||"").trim();
      orderId = String(orderId||"").trim();
      if(!uid || !orderId) return alert("uid/orderId yok");

      const ok = confirm("Bu sipari≈üi Sƒ∞LMEK istiyor musun? (Geri alƒ±nmaz)");
      if(!ok) return;

      await db.collection("kullanicilar").doc(uid).collection("siparisler").doc(orderId).delete();
      alert("Silindi ‚úÖ");
    }catch(e){
      alert(e?.message || e);
    }
  };

  // ‚úÖ MANUEL butonlar
  document.getElementById("btnLoadOrder").onclick = async () => {
    try {
      const uid = String(mUid.value || "").trim();
      const orderId = String(mOrderId.value || "").trim();
      if (!uid || !orderId) return alert("UID + OrderId gir");

      const ref = db.collection("kullanicilar").doc(uid).collection("siparisler").doc(orderId);
      const snap = await ref.get();

      if (!snap.exists) {
        mOut.textContent = "Sipari≈ü bulunamadƒ±. UID/OrderId yanlƒ±≈ü olabilir.";
        return;
      }

      mOut.textContent = JSON.stringify(snap.data() || {}, null, 2);
    } catch (e) {
      mOut.textContent = "Hata: " + (e?.message || e);
    }
  };

  document.getElementById("btnSetLink").onclick = async ()=>{
    const uid = String(mUid.value||"").trim();
    const orderId = String(mOrderId.value||"").trim();
    if(!uid || !orderId) return alert("UID + OrderId gir");
    await window.ADMIN_setLink(uid, orderId);
  };

  document.getElementById("btnExpire").onclick = async ()=>{
    const uid = String(mUid.value||"").trim();
    const orderId = String(mOrderId.value||"").trim();
    if(!uid || !orderId) return alert("UID + OrderId gir");
    await window.ADMIN_expire(uid, orderId);
  };

  document.getElementById("btnApprove").onclick = async ()=>{
    const uid = String(mUid.value||"").trim();
    const orderId = String(mOrderId.value||"").trim();
    if(!uid || !orderId) return alert("UID + OrderId gir");
    await window.ADMIN_approve(uid, orderId);
  };

  document.getElementById("btnDelete").onclick = async ()=>{
    const uid = String(mUid.value||"").trim();
    const orderId = String(mOrderId.value||"").trim();
    if(!uid || !orderId) return alert("UID + OrderId gir");
    await window.ADMIN_delete(uid, orderId);
  };

  document.getElementById("btnShowBilling").onclick = async ()=>{
    const uid = String(mUid.value||"").trim();
    if(!uid) return alert("UID gir");
    await window.ADMIN_showBilling(uid);
  };

  document.getElementById("btnLogout").onclick = ()=> auth.signOut();
  document.getElementById("btnRefresh").onclick = ()=> render();
  btnToggle.onclick = ()=> setMode(mode === "list" ? "manual" : "list");
  elFilter.onchange = render;
  elSearch.oninput = render;

  // Modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
  billModal.addEventListener("click", (e)=>{
    if(e.target === billModal) closeBilling();
  });

  auth.onAuthStateChanged(async (user)=>{
    try{
      if(!user){
        elMe.innerHTML = `Giri≈ü yok. <a href="/index.html">Ana sayfadan giri≈ü yap</a>`;
        if(_unsub) _unsub();
        return;
      }
      await ensureAdmin(user);
      setMode("list");
    }catch(e){
      if(_unsub) _unsub();
    }
  });
})();
</script>

</body>
</html>

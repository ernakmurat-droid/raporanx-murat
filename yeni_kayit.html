<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <title>Tapu KayÄ±t ve Referanslar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #0d6efd; --danger: #d32f2f; --success: #198754; --bg: #f0f2f5; }
        body { background-color: var(--bg); padding: 15px; font-family: 'Segoe UI', sans-serif; }
        .card { border-radius: 12px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; background: #fff; }
        .result-body { background: white; border: 1px solid #dee2e6; padding: 25px; border-radius: 0 0 10px 10px; white-space: pre-wrap; font-size: 14.5px; transition: filter 0.3s ease; }
        .result-body:not(:hover) { filter: blur(2.5px); }
        
        /* REFERANS PANELÄ° STÄ°LLERÄ° */
        .ref-panel { position: fixed; right: -320px; top: 0; width: 300px; height: 100%; background: #2c3e50; color: white; box-shadow: -5px 0 15px rgba(0,0,0,0.3); transition: 0.4s; z-index: 2000; padding: 20px; }
        .ref-panel.active { right: 0; }
        .ref-toggle { position: fixed; right: 0; top: 50%; transform: translateY(-50%); background: #f39c12; color: white; padding: 15px 8px; cursor: pointer; border-radius: 10px 0 0 10px; writing-mode: vertical-rl; font-weight: bold; z-index: 2001; }
        .ref-content textarea { width: 100%; height: 75vh; background: rgba(255,255,255,0.1); border: 1px solid #455a64; color: white; padding: 10px; font-size: 13px; border-radius: 5px; outline: none; }
    </style>
</head>
<body oncontextmenu="return false;">

<div class="ref-toggle" onclick="document.getElementById('refPanel').classList.toggle('active')">
    ğŸ“š REFERANS NOTLARIM
</div>

<div class="ref-panel" id="refPanel">
    <h5 class="mb-3 text-warning">Genel Referanslar</h5>
    <p style="font-size: 11px; opacity: 0.7;">Buraya yazdÄ±ÄŸÄ±nÄ±z bilgiler tÃ¼m raporlarda ortak gÃ¶rÃ¼nÃ¼r ve buluta yedeklenir.</p>
    <div class="ref-content">
        <textarea id="genelReferansInput" placeholder="Birim maliyetler, katsayÄ±lar, telefonlar..."></textarea>
        <button class="btn btn-warning btn-sm w-100 mt-2 fw-bold" onclick="referansKaydet()">NOTLARI BULUTA Ä°ÅLE</button>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-7">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <button onclick="anaMenuyeDon()" class="btn btn-danger px-4 fw-bold">â† MENÃœYE DÃ–N</button>
                    <h4 class="m-0 fw-bold text-primary">TAPU VE TAKYÄ°DAT GÄ°RÄ°ÅÄ°</h4>
                    <button onclick="kaydet()" class="btn btn-success px-4 fw-bold">KAYDET</button>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-md-6"><label class="fw-bold mb-1">Tarih</label><input type="date" id="tarihInput" class="form-control"></div>
                    <div class="col-md-6"><label class="fw-bold mb-1">Saat</label><input type="time" id="saatInput" class="form-control"></div>
                </div>
                <div id="malikAlani">
                    <table class="table border"><tbody id="malikGÃ¶vde"></tbody></table>
                    <button class="btn btn-outline-primary w-100" onclick="malikEkle()">+ Malik Ekle</button>
                </div>
                <button class="btn btn-success w-100 mt-4 py-3 fw-bold" onclick="kaydet()">VERÄ°LERÄ° BULUTA MÃœHÃœRLE</button>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="bg-dark text-white p-2 rounded-top fw-bold">ğŸ“„ Ã–NÄ°ZLEME</div>
            <div class="result-body" id="b1_sonuc"></div>
        </div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    let report = reports[id];

    auth.onAuthStateChanged((user) => {
        if (!user || !id || !report) {
            window.location.href = 'index.html';
        } else {
            baslat();
            referansYukle(); // ReferanslarÄ± buluttan Ã§ek
        }
    });

    // REFERANS SÄ°STEMÄ° FONKSÄ°YONLARI
    async function referansKaydet() {
        const notlar = document.getElementById('genelReferansInput').value;
        const user = auth.currentUser;
        if (user) {
            try {
                await db.collection("users").doc(user.uid).set({ genel_referanslar: notlar }, { merge: true });
                alert("âœ… Referans notlarÄ±nÄ±z tÃ¼m raporlar iÃ§in gÃ¼ncellendi!");
            } catch (e) { alert("Hata: " + e.message); }
        }
    }

    function referansYukle() {
        const user = auth.currentUser;
        if (user) {
            db.collection("users").doc(user.uid).get().then((doc) => {
                if (doc.exists && doc.data().genel_referanslar) {
                    document.getElementById('genelReferansInput').value = doc.data().genel_referanslar;
                }
            });
        }
    }

    // TAPU KAYIT FONKSÄ°YONLARI (Senin Orijinal KodlarÄ±n)
    function baslat() { /* Orijinal baslat kodun */ }
    function guncelle() { /* Orijinal guncelle kodun */ }
    function malikEkle() { /* Orijinal malikEkle kodun */ }
    
    async function kaydet() {
        // ... Orijinal kaydetme mantÄ±ÄŸÄ±n ...
        reports[id] = report;
        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
        const user = auth.currentUser;
        if (user) {
            await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: reports }, { merge: true });
            alert("âœ… Rapor verileri kaydedildi.");
            anaMenuyeDon();
        }
    }

    function anaMenuyeDon() { window.location.href = `rapor-detay.html?id=${id}`; }
</script>
</body>
</html>
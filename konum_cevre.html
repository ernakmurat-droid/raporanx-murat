<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Konum ve Ã‡evre Ã–zellikleri</title>
<style>
    :root { --primary: #1a237e; --secondary: #3f51b5; --success: #00c853; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding-bottom:50px; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; text-decoration:none; border: none; cursor: pointer; }
    .main-wrapper { display: flex; flex-direction: column; max-width: 1000px; margin: 15px auto; gap: 15px; padding: 0 15px; }
    .form-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .section-title { grid-column: span 2; border-left: 5px solid var(--primary); margin-top: 20px; padding-left: 10px; color: var(--primary); font-weight: bold; background: #f0f2ff; padding: 8px; border-radius: 0 8px 8px 0; }
    .input-item { display: flex; flex-direction: column; }
    .input-item label { font-weight: 600; font-size: 13px; color: #444; margin-bottom: 5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background: #fff; transition: 0.3s; width: 100%; box-sizing: border-box; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(26,35,126,0.1); outline: none; }
    .radio-group { display: flex; gap: 20px; padding: 10px 0; }
    .radio-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .full-width { grid-column: span 2; }
    .btn-save { background: var(--success); color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 30px; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
    .btn-back { background: #6c757d; color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px; }

    .preview-box {
        background: #222; color: #00ff6a; padding: 20px; border-radius: 15px;
        font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px;
        margin-top: 20px; border: 2px solid #555;
        -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        transition: filter 0.3s ease;
    }
    .preview-box:not(:hover) { filter: blur(1.5px); }

    @media print {
        body * { visibility: hidden; }
        .preview-box { visibility: hidden; }
        .preview-box::after { content: "METÄ°N KORUMALIDIR!"; visibility: visible; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 30px; color: red; }
    }

    .disabled-input { background: #eee; cursor: not-allowed; }
</style>
</head>
<body oncontextmenu="return false;">

<div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼ye DÃ¶n</button>
    <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
    <div id="raporBilgi" style="font-size: 12px; opacity: 0.8;">YÃ¼kleniyor...</div>
</div>

<div class="main-wrapper">
    <div class="form-container">
        <form id="mainForm" onsubmit="return false;">
            <div class="grid-form">
                <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
                <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1" list="h_v1" onfocus="showList(this)"></div>
                <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2" list="h_v2" onfocus="showList(this)"></div>
                <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3" list="h_v3" onfocus="showList(this)"></div>
                <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4" list="h_v4" onfocus="showList(this)"></div>
                <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5" list="h_v5" onfocus="showList(this)"></div>
                <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6" list="h_v6" onfocus="showList(this)"></div>
                <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7" list="h_v7" onfocus="showList(this)"></div>
                <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8" list="h_v8" onfocus="showList(this)"></div>
                <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9" list="h_v9" onfocus="showList(this)"></div>
                <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10" list="h_v10" onfocus="showList(this)"></div>
                <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11" list="h_v11" onfocus="showList(this)"></div>
                <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12" list="h_v12" onfocus="showList(this)"></div>
                <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13" list="h_v13" onfocus="showList(this)"></div>
                <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14" list="h_v14" onfocus="showList(this)"></div>
                <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15" list="h_v15" onfocus="showList(this)"></div>
                <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16" list="h_v16" onfocus="showList(this)"></div>

                <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>
                <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3" list="h_ulasimTarifi" onfocus="showList(this)"></textarea></div>
                <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari" list="h_ulasimOlanaklari" onfocus="showList(this)"></div>

                <div class="input-item">
                    <label>AltyapÄ± Durumu</label>
                    <div class="radio-group">
                        <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked onclick="toggleAltyapi(true)"> Evet</label>
                        <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r" onclick="toggleAltyapi(false)"> HayÄ±r</label>
                    </div>
                </div>
                <div class="input-item">
                    <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
                    <input type="text" id="altyapiAciklama" class="disabled-input" disabled list="h_altyapiAciklama" onfocus="showList(this)">
                </div>
            </div>
        </form>

        <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME (RAPORDA BÃ–YLE GÃ–RÃœNECEK)</div>
        <div class="preview-box" id="livePreview" oncopy="return false">Veri bekleniyor</div>

        <button class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET</button>
        <button class="btn-back" onclick="anaMenuyeDon()">MENÃœYE DÃ–N</button>
    </div>
</div>

<div id="datalists">
    <datalist id="h_v1"></datalist><datalist id="h_v2"></datalist><datalist id="h_v3"></datalist>
    <datalist id="h_v4"></datalist><datalist id="h_v5"></datalist><datalist id="h_v6"></datalist>
    <datalist id="h_v7"></datalist><datalist id="h_v8"></datalist><datalist id="h_v9"></datalist>
    <datalist id="h_v10"></datalist><datalist id="h_v11"></datalist><datalist id="h_v12"></datalist>
    <datalist id="h_v13"></datalist><datalist id="h_v14"></datalist><datalist id="h_v15"></datalist>
    <datalist id="h_v16"></datalist><datalist id="h_ulasimTarifi"></datalist>
    <datalist id="h_ulasimOlanaklari"></datalist><datalist id="h_altyapiAciklama"></datalist>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id') || 0;

    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    let report = reports[id] || {};

    const inputIds = [
        'v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11','v12','v13','v14','v15','v16',
        'ulasimTarifi','ulasimOlanaklari','altyapiAciklama'
    ];

    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && (e.key === 'c' || e.key === 'p' || e.key === 's' || e.key === 'u')) e.preventDefault();
    });

    function showList(input) {
        input.setAttribute('autocomplete', 'off');
        const val = input.value;
        input.value = '';
        setTimeout(() => { input.value = val; }, 1);
    }

    function cleanText(s){
        s = (s || "").replace(/\s+/g, " ").trim();
        if (!s) return "...";
        s = s.replace(/\s*([,.!?;:])\s*/g, "$1 ");
        s = s.replace(/\s+/g, " ").trim();
        if (!/[.!?]$/.test(s)) s += ".";
        return s;
    }

    function norm(s){
        s = (s || "").trim();
        return s ? s : "...";
    }

    function toggleAltyapi(isEvet) {
        const input = document.getElementById('altyapiAciklama');
        if(isEvet) {
            input.disabled = true;
            input.classList.add('disabled-input');
            input.value = "";
        } else {
            input.disabled = false;
            input.classList.remove('disabled-input');
        }
        guncelleOnizleme();
    }

    function autoFillFromReport(){
        // rapordan otomatik doldur: il/ilÃ§e/mahalle/cadde gibi
        if (!document.getElementById('v4').value && report.il) document.getElementById('v4').value = report.il;
        if (!document.getElementById('v5').value && report.ilce) document.getElementById('v5').value = report.ilce;
        // mahalle/sokak raporda farklÄ± isimde olabilir, yoksa dokunma
    }

    function guncelleOnizleme() {
        let v = {};
        inputIds.forEach(k => { v[k] = document.getElementById(k).value || ""; });

        // â€œYapÄ± tipleriâ€ akÄ±llÄ± ek
        let yapiTipi = (v.v13 || "").trim();
        let yapiTipiMetni = yapiTipi || "...";
        if (yapiTipi && !/yapÄ±|tip|bina/i.test(yapiTipi)) yapiTipiMetni = yapiTipi + " tipi yapÄ±lar";

        // altyapÄ± metni
        const altyapiTik = document.querySelector('input[name="altyapi"]:checked').value;
        const altyapiAcik = (v.altyapiAciklama || "").trim();
        const altyapiMetni = altyapiTik === "Evet"
            ? "altyapÄ±sÄ± tamamlanmÄ±ÅŸ olup, yol, su, elektrik, kanalizasyon ve doÄŸalgaz hizmetleri mevcuttur."
            : (altyapiAcik ? cleanText(altyapiAcik).replace(/\.$/,"") + "." : "altyapÄ± hizmetlerinde eksiklikler bulunmaktadÄ±r.");

        const raporAdi = report.propertyName || "TaÅŸÄ±nmaz";
        const ada = report.ada || "...";
        const parsel = report.parsel || "...";

        // tablo
        const labels = [
            "UAVT","Koord X","Koord Y","Ä°li","Ä°lÃ§esi","Mahallesi","Cadde/Sokak","DÄ±ÅŸ KapÄ± No",
            "BulunduÄŸu Kat","Daire No","BÃ¶lge GeliÅŸimi","BÃ¶lge YapÄ±laÅŸmasÄ±","YapÄ± Tipleri",
            "Gelir DÃ¼zeyi","YakÄ±n YapÄ± 1","YakÄ±n YapÄ± 2"
        ];

        let tablo = "----------------------------------------------\n";
        tablo += " Ã‡EVRESEL Ã–ZELLÄ°KLER TABLOSU\n";
        tablo += "----------------------------------------------\n";
        tablo += `Rapor/Parsel         : ${raporAdi} (Ada/Parsel: ${ada}/${parsel})\n`;
        for(let i=1; i<=16; i++){
            const key = 'v' + i;
            const valx = norm(v[key]);
            tablo += `${labels[i-1].padEnd(20,' ')} : ${valx}\n`;
        }
        tablo += "----------------------------------------------\n";

        // FORMAT 1 (uzun, rapor dili)
        const f1 =
`KONUMU VE Ã‡EVRESEL Ã–ZELLÄ°KLERÄ° (FORMAT 1)
DeÄŸerlemeye konu taÅŸÄ±nmaz; ${norm(v.v4)} ili, ${norm(v.v5)} ilÃ§esi, ${norm(v.v6)} mahallesi, ${norm(v.v7)} adresinde yer almakta olup dÄ±ÅŸ kapÄ± numarasÄ± ${norm(v.v8)} olarak beyan edilmiÅŸtir. TaÅŸÄ±nmazÄ±n bulunduÄŸu kat ${norm(v.v9)}, daire numarasÄ± ${norm(v.v10)} olarak belirtilmiÅŸtir.
TaÅŸÄ±nmaza ulaÅŸÄ±m; ${cleanText(v.ulasimTarifi)} BÃ¶lge; genel olarak ${norm(v.v14)} gelir grubunun talep gÃ¶sterdiÄŸi, aÄŸÄ±rlÄ±klÄ± olarak ${norm(v.v12)} katlÄ± ${yapiTipiMetni} nitelikli yapÄ±laÅŸmanÄ±n bulunduÄŸu bir Ã§evre niteliÄŸindedir. ${cleanText(v.ulasimOlanaklari)}
TaÅŸÄ±nmazÄ±n yakÄ±n Ã§evresinde ${norm(v.v15)} ile ${norm(v.v16)} gibi Ã¶nemli noktalar bulunmaktadÄ±r. BÃ¶lgenin planlÄ± yapÄ±laÅŸmaya sahip olduÄŸu, ${altyapiMetni}

BÃ–LGENÄ°N GELÄ°ÅÄ°MÄ°NE Ä°LÄ°ÅKÄ°N ANALÄ°Z
TaÅŸÄ±nmazÄ±n bulunduÄŸu bÃ¶lgede kentsel geliÅŸim ${norm(v.v11)} yÃ¶nÃ¼nde gerÃ§ekleÅŸmekte olup, Ã§evredeki yapÄ±laÅŸma ve kullanÄ±m kararlarÄ± bÃ¶lgesel talebi destekler niteliktedir. BÃ¶lge, ulaÅŸÄ±m baÄŸlantÄ±larÄ± ve yakÄ±n Ã§evredeki donatÄ±lar sayesinde yerleÅŸim amaÃ§lÄ± tercih edilen alanlar arasÄ±nda deÄŸerlendirilmektedir.

BÃ–LGEDEKÄ° YAPILAÅMA DURUMU
BÃ¶lgede genel olarak ${yapiTipiMetni} yoÄŸunlukta olup, yapÄ±laÅŸma karakteri ${norm(v.v12)} ÅŸeklindedir. Mevcut eÄŸilimler deÄŸerlendirildiÄŸinde bÃ¶lgede geliÅŸimin ${norm(v.v11)} doÄŸrultusunda devam ettiÄŸi gÃ¶zlemlenmektedir.`;

        // FORMAT 2 (daha kÄ±sa ama profesyonel)
        const f2 =
`TAÅINMAZIN YERÄ° VE Ã‡EVRE Ã–ZELLÄ°KLERÄ° (FORMAT 2)
DeÄŸerlemesi yapÄ±lan taÅŸÄ±nmaz; ${norm(v.v6)} mahallesi, ${norm(v.v7)} (DÄ±ÅŸ KapÄ± No: ${norm(v.v8)}), Kat: ${norm(v.v9)} Daire: ${norm(v.v10)} aÃ§Ä±k posta adresinde yer almaktadÄ±r (${norm(v.v5)}/${norm(v.v4)}).
GayrimenkulÃ¼n bulunduÄŸu Ã§evrede ${norm(v.v12)} karakterli, ${yapiTipiMetni} nitelikli yapÄ±laÅŸma mevcuttur. TaÅŸÄ±nmaza ulaÅŸÄ±m ${cleanText(v.ulasimTarifi)} YakÄ±n Ã§evrede ${norm(v.v15)} ve ${norm(v.v16)} bulunmaktadÄ±r.`;

        // FORMAT 3 (ulaÅŸÄ±m + altyapÄ±)
        const f3 =
`ULAÅIM TARÄ°FÄ° (FORMAT 3)
DeÄŸerleme konusu taÅŸÄ±nmaz; ${norm(v.v4)} ili, ${norm(v.v5)} ilÃ§esi, ${norm(v.v6)} mahallesi, ${norm(v.v7)} adresinde konumludur. TaÅŸÄ±nmaza ulaÅŸÄ±m; ${cleanText(v.ulasimTarifi)}
BÃ¶lgede toplu taÅŸÄ±ma ve/veya Ã¶zel araÃ§ ile eriÅŸim mÃ¼mkÃ¼ndÃ¼r. YakÄ±n Ã§evre ${norm(v.v11)} fonksiyonlu geliÅŸmiÅŸ olup bÃ¶lge yapÄ±laÅŸma karakteristiÄŸini aÄŸÄ±rlÄ±klÄ± olarak ${yapiTipiMetni} oluÅŸturmaktadÄ±r. BÃ¶lge ${norm(v.v14)} gelir grubunun talep gÃ¶sterdiÄŸi bir alandÄ±r. AltyapÄ± aÃ§Ä±sÄ±ndan ${altyapiMetni} ${cleanText(v.ulasimOlanaklari)}`;

        const tamPaket = tablo + "\n" + f1 + "\n\n" + f2 + "\n\n" + f3;
        document.getElementById('livePreview').textContent = tamPaket;
        return tamPaket;
    }

    function verileriKaydet() {
        const paket = guncelleOnizleme();

        let v = {};
        inputIds.forEach(k => { v[k] = document.getElementById(k).value; });
        v.altyapiTik = document.querySelector('input[name="altyapi"]:checked').value;

        // RAPOR OLUÅTUR BURADAN Ã‡EKECEK:
        report.konumCevre = { ...v, tamMetin: paket };

        reports[id] = report;
        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

        // hatÄ±rlatma (datalist)
        inputIds.forEach(k => {
            const valx = (v[k] || "").trim();
            if (valx && valx !== "...") {
                let h = JSON.parse(localStorage.getItem('h_' + k)) || [];
                if (!h.includes(valx)) {
                    h.unshift(valx);
                    localStorage.setItem('h_' + k, JSON.stringify(h.slice(0,20)));
                }
            }
            const dl = document.getElementById('h_' + k);
            if (dl) {
                let h = JSON.parse(localStorage.getItem('h_' + k)) || [];
                dl.innerHTML = h.map(item => `<option value="${item}">`).join('');
            }
        });

        alert("âœ… Konum/Ã‡evre verileri kaydedildi!");
    }

    function anaMenuyeDon() {
        window.location.href = `rapor-detay.html?id=${id}`;
    }

    window.onload = () => {
        document.getElementById('raporBilgi').textContent = report.propertyName || "Yeni Rapor";

        // datalistleri bas
        inputIds.forEach(k => {
            let h = JSON.parse(localStorage.getItem('h_' + k)) || [];
            const dl = document.getElementById('h_' + k);
            if(dl) dl.innerHTML = h.map(item => `<option value="${item}">`).join('');
        });

        // rapordan otomatik doldur
        autoFillFromReport();

        // kayÄ±tlÄ± veri varsa yÃ¼kle
        if(report.konumCevre) {
            inputIds.forEach(k => {
                if(report.konumCevre[k]) document.getElementById(k).value = report.konumCevre[k];
            });
            if(report.konumCevre.altyapiTik === "HayÄ±r") toggleAltyapi(false);
        }

        guncelleOnizleme();
    };

    inputIds.forEach(k => {
        const el = document.getElementById(k);
        if(el) el.addEventListener('input', guncelleOnizleme);
    });
    document.querySelectorAll('input[name="altyapi"]').forEach(el => el.addEventListener('change', guncelleOnizleme));
</script>
</body>
</html>

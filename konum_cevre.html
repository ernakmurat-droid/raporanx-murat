<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Konum ve Ã‡evre Ã–zellikleri - Raporan X</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
    :root { --primary: #1a237e; --secondary: #3f51b5; --success: #00c853; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding-bottom:50px; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; text-decoration:none; border: none; cursor: pointer; font-weight: bold; }
    .main-wrapper { display: flex; flex-direction: column; max-width: 1000px; margin: 15px auto; gap: 15px; padding: 0 15px; }
    .form-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .section-title { grid-column: span 2; border-left: 5px solid var(--primary); margin-top: 20px; padding-left: 10px; color: var(--primary); font-weight: bold; background: #f0f2ff; padding: 8px; border-radius: 0 8px 8px 0; }
    .input-item { display: flex; flex-direction: column; }
    .input-item label { font-weight: 600; font-size: 13px; color: #444; margin-bottom: 5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background: #fff; transition: 0.3s; width: 100%; box-sizing: border-box; }
    input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(26,35,126,0.1); outline: none; }
    .radio-group { display: flex; gap: 20px; padding: 10px 0; }
    .radio-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .full-width { grid-column: span 2; }
    .btn-save { background: var(--success); color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 30px; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
    .btn-back { background: #6c757d; color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px; }
    .preview-box {
        background: #222; color: #00ff6a; padding: 20px; border-radius: 15px;
        font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px;
        margin-top: 20px; border: 2px solid #555;
    }
    .disabled-input { background: #eee; cursor: not-allowed; opacity: 0.7; }
    .locked-note{
      margin-top:12px;
      padding:10px 12px;
      border-radius:14px;
      background:#fff3cd;
      border:1px solid #ffe69c;
      color:#7a5b00;
      font-weight:800;
      display:none;
    }
</style>
</head>

<body oncontextmenu="return false;">

<div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼ye DÃ¶n</button>
    <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
    <div id="raporBilgi" style="font-size: 12px; opacity: 0.8;">YÃ¼kleniyor...</div>
</div>

<div class="main-wrapper">
    <div class="form-container">
        <div id="lockedNote" class="locked-note">ğŸ”’ RAPOR KÄ°LÄ°TLÄ° â€” Bu modÃ¼l dÃ¼zenlenemez.</div>

        <form id="mainForm" onsubmit="return false;">
            <div class="grid-form">
                <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
                <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1"></div>
                <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2"></div>
                <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3"></div>
                <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4"></div>
                <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5"></div>
                <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6"></div>
                <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7"></div>
                <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8"></div>
                <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9"></div>
                <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10"></div>
                <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11"></div>
                <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12"></div>
                <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13"></div>
                <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14"></div>
                <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15"></div>
                <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16"></div>

                <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>
                <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3"></textarea></div>
                <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari"></div>

                <div class="input-item">
                    <label>AltyapÄ± Durumu</label>
                    <div class="radio-group">
                        <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked> Evet</label>
                        <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r"> HayÄ±r</label>
                    </div>
                </div>
                <div class="input-item">
                    <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
                    <input type="text" id="altyapiAciklama" class="disabled-input" disabled value="AltyapÄ±sÄ± tamdÄ±r.">
                </div>
            </div>
        </form>

        <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME</div>
        <div class="preview-box" id="livePreview">Veri bekleniyor...</div>

        <button id="saveBtn" class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET</button>
        <button class="btn-back" onclick="anaMenuyeDon()">MENÃœYE DÃ–N</button>
    </div>
</div>

<script>
  // âœ… firebase-config.js varsa onu kullan, yoksa default
  const auth = window.auth || firebase.auth();
  const db   = window.db   || firebase.firestore();

  // ---------- RID / legacy id migration ----------
  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }

  const params = new URLSearchParams(location.search);
  let rid = (params.get("rid") || "").toString().trim();
  const legacyId = (params.get("id") || "").toString().trim();

  function readReports(){
    try{ return JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }
    catch(e){ return []; }
  }

  // rid yoksa id'den rid'ye Ã§evir
  (function migrateOrRedirect(){
    let reports = readReports();
    if (ensureRidMigration(reports)) localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));

    if (!rid && legacyId){
      const idx = Number(legacyId);
      if (!Number.isNaN(idx) && reports[idx] && reports[idx].rid){
        rid = String(reports[idx].rid);
        location.replace("konum_cevre.html?rid=" + encodeURIComponent(rid));
      }
    }
  })();

  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && String(r.rid) === String(rid));
  }

  function getReportByRid(){
    const reports = readReports();
    const idx = findIndexByRid(reports, rid);
    return { reports, idx, report: (idx >= 0 ? reports[idx] : null) };
  }

  // ---------- Helpers (asÄ±l fix burada) ----------
  function has(obj, key){
    return obj && Object.prototype.hasOwnProperty.call(obj, key);
  }

  // konumCevre iÃ§inde farklÄ± eski yapÄ±larÄ± da dene
  function getKC(report){
    if (!report) return {};
    const kc = report.konumCevre || report.konum_cevre || report.konum || {};
    return kc;
  }

  function getValDeep(obj, path){
    try{
      return path.split(".").reduce((a,k)=> (a && a[k] !== undefined ? a[k] : undefined), obj);
    }catch(e){ return undefined; }
  }

  // v4 vb. alanlarÄ± farklÄ± yerdeyse yakala
  function readField(kc, key){
    if (has(kc, key)) return kc[key];

    // eski olasÄ± yerler
    const candidates = [
      "veriler."+key,
      "table."+key,
      "tablo."+key,
      "fields."+key
    ];
    for (const p of candidates){
      const v = getValDeep(kc, p);
      if (v !== undefined) return v;
    }
    return undefined;
  }

  function setInput(id, value){
    const el = document.getElementById(id);
    if (!el) return;
    // undefined/null deÄŸilse yaz (boÅŸ string dahil!)
    if (value !== undefined && value !== null) el.value = String(value);
  }

  function updatePreview(){
    const v = (id) => (document.getElementById(id)?.value ?? "").trim() || "...";
    let txt = `KONUM: ${v('v4')}/${v('v5')}/${v('v6')}\n`;
    txt += `ADRES: ${v('v7')} No:${v('v8')}\n`;
    txt += `ULAÅIM: ${v('ulasimTarifi')}`;
    document.getElementById("livePreview").textContent = txt;
  }

  function toggleAltyapi(isEvet){
    const inp = document.getElementById("altyapiAciklama");
    if (!inp) return;
    if (isEvet) {
      inp.disabled = true;
      inp.classList.add("disabled-input");
      inp.value = "AltyapÄ±sÄ± tamdÄ±r.";
    } else {
      inp.disabled = false;
      inp.classList.remove("disabled-input");
      if (inp.value === "AltyapÄ±sÄ± tamdÄ±r.") inp.value = "";
    }
    updatePreview();
  }

  // radio change
  document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll('input[name="altyapi"]').forEach(r=>{
      r.addEventListener("change", ()=>{
        const v = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";
        toggleAltyapi(v !== "HayÄ±r");
      });
    });
  });

  // ---------- Load ----------
  function verileriYukle(){
    const { idx, report } = getReportByRid();
    if (!rid || idx < 0 || !report){
      alert("Rapor ID (rid) bulunamadÄ±!");
      location.href = "index.html";
      return;
    }

    const kc = getKC(report);

    document.getElementById("raporBilgi").textContent =
      `Emlak: ${report.propertyName || "TanÄ±msÄ±z"} | RID: ${rid}`;

    // âœ… 1-16 alanlarÄ±: anahtar varsa doldur (boÅŸ olsa bile)
    for (let i = 1; i <= 16; i++) {
      const key = "v" + i;
      const val = readField(kc, key);
      setInput(key, val);
    }

    // metin alanlarÄ±
    setInput("ulasimTarifi",      (has(kc,"ulasimTarifi") ? kc.ulasimTarifi : getValDeep(kc,"metin.ulasimTarifi")));
    setInput("ulasimOlanaklari",  (has(kc,"ulasimOlanaklari") ? kc.ulasimOlanaklari : getValDeep(kc,"metin.ulasimOlanaklari")));
    setInput("altyapiAciklama",   (has(kc,"altyapiAciklama") ? kc.altyapiAciklama : getValDeep(kc,"metin.altyapiAciklama")));

    // altyapi radio
    const alty = (has(kc,"altyapi") ? kc.altyapi : (getValDeep(kc,"metin.altyapi") || "Evet"));
    if (String(alty).toLowerCase() === "hayÄ±r" || String(alty).toLowerCase() === "hayir"){
      document.querySelector('input[name="altyapi"][value="HayÄ±r"]').checked = true;
      toggleAltyapi(false);
    } else {
      document.querySelector('input[name="altyapi"][value="Evet"]').checked = true;
      toggleAltyapi(true);
    }

    updatePreview();
  }

  // ---------- Save ----------
  function verileriKaydet(){
    const { reports, idx } = getReportByRid();
    if (idx < 0) return;

    const konumObj = {
      updatedAt: Date.now(),
      ulasimTarifi: document.getElementById("ulasimTarifi").value,
      ulasimOlanaklari: document.getElementById("ulasimOlanaklari").value,
      altyapi: document.querySelector('input[name="altyapi"]:checked').value,
      altyapiAciklama: document.getElementById("altyapiAciklama").value
    };

    for (let i = 1; i <= 16; i++) {
      konumObj["v" + i] = document.getElementById("v" + i).value;
    }

    reports[idx].konumCevre = konumObj;
    localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));

    alert("BaÅŸarÄ±yla kaydedildi!");
    updatePreview();
  }

  // ---------- Lock control (local) ----------
  function checkLockStatus(){
    const { report } = getReportByRid();
    const locked = report && (report.isLocked === true || report.locked === true || report.final === true);

    if (locked){
      document.getElementById("lockedNote").style.display = "block";
      const saveBtn = document.getElementById("saveBtn");
      saveBtn.disabled = true;
      saveBtn.textContent = "RAPOR KÄ°LÄ°TLÄ° (DÃœZENLENEMEZ)";
      document.querySelectorAll("input, textarea, button.btn-save").forEach(el => {
        if (el.id !== "saveBtn") el.disabled = true;
      });
      // MenÃ¼ye dÃ¶n butonu kalsÄ±n
      document.querySelectorAll(".btn-back").forEach(b => b.disabled = false);
    }
  }

  function anaMenuyeDon(){
    if (!rid) location.href = "index.html";
    else location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
  }
  window.anaMenuyeDon = anaMenuyeDon;
  window.verileriKaydet = verileriKaydet;

  // ---------- Boot ----------
  auth.onAuthStateChanged((user) => {
    if (!user) { location.href = "index.html"; return; }
    verileriYukle();
    checkLockStatus();
  });

  // preview listeners
  document.querySelectorAll('input, textarea').forEach(el => {
    el.addEventListener('input', updatePreview);
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Konum ve Ã‡evre Ã–zellikleri - Raporan X</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  :root { --primary:#1a237e; --secondary:#3f51b5; --success:#00c853; --bg:#f4f7f6; }
  body { font-family:'Segoe UI',sans-serif; background:var(--bg); margin:0; padding-bottom:50px; }
  .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
  .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:#fff; border:none; cursor:pointer; font-weight:800; }
  .main-wrapper { display:flex; flex-direction:column; max-width:1000px; margin:15px auto; gap:15px; padding:0 15px; }
  .form-container { background:#fff; padding:25px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
  .grid-form { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
  .section-title { grid-column:span 2; border-left:5px solid var(--primary); margin-top:20px; padding-left:10px; color:var(--primary); font-weight:900; background:#f0f2ff; padding:8px; border-radius:0 8px 8px 0; }
  .input-item { display:flex; flex-direction:column; }
  .input-item label { font-weight:700; font-size:13px; color:#444; margin-bottom:5px; }
  input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background:#fff; transition:.3s; width:100%; box-sizing:border-box; }
  input:focus, textarea:focus { border-color:var(--primary); box-shadow:0 0 8px rgba(26,35,126,0.1); outline:none; }
  .radio-group { display:flex; gap:20px; padding:10px 0; }
  .radio-item { display:flex; align-items:center; gap:8px; cursor:pointer; }
  .full-width { grid-column:span 2; }
  .btn-save { background:var(--success); color:#fff; padding:20px; border:none; border-radius:15px; width:100%; font-weight:900; font-size:18px; cursor:pointer; margin-top:30px; }
  .btn-back { background:#6c757d; color:#fff; padding:20px; border:none; border-radius:15px; width:100%; font-weight:900; font-size:18px; cursor:pointer; margin-top:10px; }
  .preview-box { background:#222; color:#00ff6a; padding:20px; border-radius:15px; font-family:'Courier New',monospace; white-space:pre-wrap; font-size:13px; margin-top:20px; border:2px solid #555; line-height:1.5; }
  .disabled-input { background:#eee; cursor:not-allowed; opacity:.7; }
  .locked-note { display:none; background:#fff3cd; color:#856404; padding:15px; border-radius:10px; margin-bottom:15px; font-weight:900; text-align:center; border:1px solid #ffeeba; }
</style>
</head>

<body oncontextmenu="return false;">

<div class="header">
  <button onclick="anaMenuyeDon()" class="back">â† Geri</button>
  <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
  <div id="raporBilgi" style="font-size:12px; opacity:.85;">YÃ¼kleniyor...</div>
</div>

<div class="main-wrapper">
  <div class="form-container">
    <div id="lockedNote" class="locked-note">ğŸ”’ RAPOR KÄ°LÄ°TLÄ° - Sadece GÃ¶rÃ¼ntÃ¼leme Modu</div>

    <form id="mainForm" onsubmit="return false;">
      <div class="grid-form">
        <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
        <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1"></div>
        <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2"></div>
        <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3"></div>
        <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4"></div>
        <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5"></div>
        <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6"></div>
        <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7"></div>
        <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8"></div>
        <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9"></div>
        <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10"></div>
        <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11"></div>
        <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12"></div>
        <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13"></div>
        <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14"></div>
        <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15"></div>
        <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16"></div>

        <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3"></textarea></div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari"></div>

        <div class="input-item">
          <label>AltyapÄ± Durumu</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked onclick="toggleAltyapi(true)"> Evet</label>
            <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r" onclick="toggleAltyapi(false)"> HayÄ±r</label>
          </div>
        </div>
        <div class="input-item">
          <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
          <input type="text" id="altyapiAciklama" class="disabled-input" disabled value="alt yapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r">
        </div>
      </div>
    </form>

    <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME</div>
    <div class="preview-box" id="livePreview">Veri bekleniyor...</div>

    <button id="saveBtn" class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET</button>
    <button class="btn-back" onclick="anaMenuyeDon()">MENÃœYE DÃ–N</button>
  </div>
</div>

<script>
  const auth = firebase.auth();

  const urlParams = new URLSearchParams(window.location.search);
  const rid = (urlParams.get("rid") || "").trim();

  const inputIds = ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11','v12','v13','v14','v15','v16','ulasimTarifi','ulasimOlanaklari','altyapiAciklama'];

  const $ = (id) => document.getElementById(id);

  function getReports(){ return JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }
  function findReportByRid(){
    const reports = getReports();
    return reports.find(r => r && String(r.rid) === String(rid)) || null;
  }
  function findReportIndexByRid(){
    const reports = getReports();
    return reports.findIndex(r => r && String(r.rid) === String(rid));
  }

  // âœ… farklÄ± alan adlarÄ±nÄ± yakalamak iÃ§in helper
  function pick(obj, ...paths){
    for(const p of paths){
      try{
        const v = p.split(".").reduce((a,k)=> (a && a[k] !== undefined ? a[k] : undefined), obj);
        if(v !== undefined && v !== null && String(v).trim() !== "") return String(v).trim();
      }catch(e){}
    }
    return "";
  }

  // âœ… il/ilce/mahalle iÃ§in en geniÅŸ olasÄ±lÄ±k listesi
  function getCityInfo(report){
    const il = pick(report,
      "il","sehir","ÅŸehir","province","city",
      "adres.il","adres.sehir","adres.city",
      "konum.il","konum.sehir","konum.city",
      "konumCevre.il","konumCevre.sehir","konumCevre.city"
    );

    const ilce = pick(report,
      "ilce","ilÃ§e","district",
      "adres.ilce","adres.ilÃ§e","adres.district",
      "konum.ilce","konum.ilÃ§e","konum.district",
      "konumCevre.ilce","konumCevre.ilÃ§e","konumCevre.district"
    );

    const mahalle = pick(report,
      "mahalle","neighborhood","quarter",
      "adres.mahalle","adres.neighborhood",
      "konum.mahalle","konum.neighborhood",
      "konumCevre.mahalle","konumCevre.neighborhood"
    );

    // adres string varsa kaba parse dene (son Ã§are)
    const adresTek = pick(report,"adres","address","konumCevre.adres","konum.adres");
    return { il, ilce, mahalle, adresTek };
  }

  function toggleAltyapi(isEvet){
    const inp = $('altyapiAciklama');
    if(isEvet){
      inp.disabled = true;
      inp.classList.add('disabled-input');
      inp.value = "alt yapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r";
    }else{
      inp.disabled = false;
      inp.classList.remove('disabled-input');
      if(inp.value === "alt yapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r") inp.value = "";
    }
    guncelleOnizleme();
  }

  function guncelleOnizleme(){
    let v = {};
    inputIds.forEach(id => { v[id] = $(id).value || "..."; });

    let yapiTipi = (v.v13 || "").trim();
    let yapiTipiMetni = (yapiTipi !== "..." && yapiTipi && !yapiTipi.toLowerCase().includes("tip")) ? yapiTipi + " tipi yapÄ±lar" : (yapiTipi || "...");

    const altyapiTik = document.querySelector('input[name="altyapi"]:checked').value;
    const altyapiMetni = altyapiTik === "Evet" ? "alt yapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r" : (v.altyapiAciklama || "...");

    let tablo = "------------------------------------------\n Ã‡EVRESEL Ã–ZELLÄ°KLER TABLOSU\n------------------------------------------\n";
    const labels = ["UAVT","Koord X","Koord Y","Ä°l","Ä°lÃ§e","Mahalle","Sokak","KapÄ± No","Kat","Daire No","GeliÅŸim","YapÄ±laÅŸma","Tip","Gelir","YakÄ±n 1","YakÄ±n 2"];
    for(let i=1; i<=16; i++){ tablo += `${labels[i-1].padEnd(15,' ')} : ${v['v'+i]}\n`; }

    const f1 =
`KONUMU VE Ã‡EVRESEL Ã–ZELLÄ°KLERÄ°
DeÄŸerlemeye konu taÅŸÄ±nmaz, ${v.v4} ili, ${v.v5} Ä°lÃ§esi, ${v.v6} Mahallesi ${v.v7}, No: ${v.v8}/${v.v10} posta adresinde yer almaktadÄ±r.
TaÅŸÄ±nmaza ulaÅŸÄ±m; ${v.ulasimTarifi}.
BÃ¶lge genelde yapÄ± kalitesine baÄŸlÄ± olarak, ${v.v14} gelir grubu tarafÄ±ndan yerleÅŸim amaÃ§lÄ± olarak talep gÃ¶rmektedir.
BÃ¶lge Ã§evresinde ${v.v12} katlÄ± ${yapiTipiMetni} bulunmaktadÄ±r.
${v.ulasimOlanaklari}
TaÅŸÄ±nmazÄ±n yakÄ±n Ã§evresinde ${v.v15} ve ${v.v16} yer almaktadÄ±r.

BÃ¶lgenin GeliÅŸimine Analiz: ${v.v14} grubunun tercih ettiÄŸi, yapÄ±laÅŸmanÄ±n ${v.v11} olduÄŸu bir bÃ¶lgedir.`;

    const f2 =
`TAÅINMAZIN YERÄ° VE Ã‡EVRE Ã–ZELLÄ°KLERÄ°
Gayrimenkul, ${v.v6} Mahallesi, ${v.v7}, No: ${v.v8}, Kat: ${v.v9} Daire: ${v.v10}, ${v.v5}/${v.v4} adresindedir.
BÃ¶lgede ${v.v12} nitelikli ${yapiTipiMetni} hakimdir.
UlaÅŸÄ±m: ${v.ulasimTarifi}.
YakÄ±n Ã§evre: ${v.v15}, ${v.v16}.`;

    const f3 =
`ULAÅIM TARÄ°FÄ°
${v.v4} Ä°li, ${v.v5} Ä°lÃ§esi, ${v.v6} Mahallesi sÄ±nÄ±rlarÄ±nda yer alan taÅŸÄ±nmaza ulaÅŸÄ±m ${v.ulasimTarifi}.
BÃ¶lge ${v.v11} fonksiyonlu geliÅŸmiÅŸ olup, ${v.v14} gelir grubuna hitap eder.
AltyapÄ±: (yol, su, elektrik) ${altyapiMetni}.
${v.ulasimOlanaklari}`;

    const tamPaket = tablo + "\n" + f1 + "\n\n" + f2 + "\n\n" + f3;
    $('livePreview').textContent = tamPaket;
    return tamPaket;
  }

  function applyLockUI(){
    $('lockedNote').style.display = "block";
    const saveBtn = $('saveBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = "KÄ°LÄ°TLÄ°";
    document.querySelectorAll("input, textarea").forEach(el => el.disabled = true);
  }

  function checkLockStatusLocal(report){
    if(localStorage.getItem("report_locked_" + rid) === "1") return true;
    if(report && (report.isLocked || report.locked || report.final)) return true;
    return false;
  }

  function loadData(){
    const report = findReportByRid();
    if(!report){
      alert("Rapor bulunamadÄ±!");
      location.href="index.html";
      return;
    }

    $('raporBilgi').textContent = `${report.propertyName || "Rapor"}  â€¢ RID: ${rid}`;

    // 1) konumCevre iÃ§inden doldur
    if(report.konumCevre){
      inputIds.forEach(id => {
        const val = report.konumCevre[id];
        if(val !== undefined && val !== null && String(val).trim() !== ""){
          $(id).value = val;
        }
      });

      const a = report.konumCevre.altyapi || report.konumCevre.altyapiTik;
      if(a === "HayÄ±r"){
        document.querySelector('input[name="altyapi"][value="HayÄ±r"]').checked = true;
        toggleAltyapi(false);
      }
    }

    // 2) v4/v5/v6 boÅŸsa raporun baÅŸka alanlarÄ±ndan otomatik yakala
    const city = getCityInfo(report);

    if(!$('v4').value && city.il) $('v4').value = city.il;
    if(!$('v5').value && city.ilce) $('v5').value = city.ilce;
    if(!$('v6').value && city.mahalle) $('v6').value = city.mahalle;

    // 3) hala boÅŸsa ve adres string varsa Ã§ok kaba bir parse dene
    // (adres formatÄ± deÄŸiÅŸkense kesin Ã§Ã¶zÃ¼m deÄŸil ama yardÄ±mcÄ± olur)
    if((!$('v4').value || !$('v5').value) && city.adresTek){
      const a = city.adresTek;
      // Ã¶r: "... Ä°lÃ§e/Ä°l" veya "... Ä°l/Ä°lÃ§e"
      if(!$('v4').value){
        const m = a.match(/([A-Za-zÃ‡ÄÄ°Ã–ÅÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼\s]+)\s*\/\s*([A-Za-zÃ‡ÄÄ°Ã–ÅÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼\s]+)/);
        if(m){
          // varsayÄ±lan: ilÃ§e/il
          if(!$('v5').value) $('v5').value = (m[1] || "").trim();
          $('v4').value = (m[2] || "").trim();
        }
      }
    }

    // 4) bulunduysa kalÄ±cÄ± hale getir: konumCevre iÃ§ine de yaz (hatÄ±rlasÄ±n diye)
    const idx = findReportIndexByRid();
    if(idx >= 0){
      const reports = getReports();
      reports[idx].konumCevre = reports[idx].konumCevre || {};
      if(!$('v4').value) {} else reports[idx].konumCevre.v4 = $('v4').value;
      if(!$('v5').value) {} else reports[idx].konumCevre.v5 = $('v5').value;
      if(!$('v6').value) {} else reports[idx].konumCevre.v6 = $('v6').value;
      localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));
    }

    guncelleOnizleme();

    // kilit
    if(checkLockStatusLocal(report)) applyLockUI();
  }

  function verileriKaydet(){
    const idx = findReportIndexByRid();
    if(idx < 0) return alert("Hata: Rapor bulunamadÄ±!");

    const reports = getReports();
    let vData = {};
    inputIds.forEach(id => { vData[id] = $(id).value; });

    const altyapiTik = document.querySelector('input[name="altyapi"]:checked').value;

    reports[idx].konumCevre = {
      ...(reports[idx].konumCevre || {}),
      ...vData,
      altyapi: altyapiTik,
      altyapiTik: altyapiTik,
      tamMetin: guncelleOnizleme(),
      updatedAt: Date.now()
    };

    localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));
    alert("âœ… Kaydedildi!");
  }

  function anaMenuyeDon(){
    if(!rid){ location.href="index.html"; return; }
    location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
  }

  // boot
  auth.onAuthStateChanged(user => {
    if(!user){ location.href="index.html"; return; }
    if(!rid){ location.href="index.html"; return; }
    loadData();
  });

  // live preview
  inputIds.forEach(id => {
    const el = $(id);
    if(el) el.addEventListener("input", guncelleOnizleme);
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Konum ve Ã‡evre Ã–zellikleri</title>
<style>
    :root { --primary: #1a237e; --secondary: #3f51b5; --success: #00c853; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding-bottom:50px; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; text-decoration:none; border: none; cursor: pointer; }
    .main-wrapper { display: flex; flex-direction: column; max-width: 1000px; margin: 15px auto; gap: 15px; padding: 0 15px; }
    .form-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .section-title { grid-column: span 2; border-left: 5px solid var(--primary); margin-top: 20px; padding-left: 10px; color: var(--primary); font-weight: bold; background: #f0f2ff; padding: 8px; border-radius: 0 8px 8px 0; }
    .input-item { display: flex; flex-direction: column; }
    .input-item label { font-weight: 600; font-size: 13px; color: #444; margin-bottom: 5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background: #fff; transition: 0.3s; width: 100%; box-sizing: border-box; }
    input:focus { border-color: var(--primary); box-shadow: 0 0 8px rgba(26,35,126,0.1); outline: none; }
    .radio-group { display: flex; gap: 20px; padding: 10px 0; }
    .radio-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .full-width { grid-column: span 2; }
    .btn-save { background: var(--success); color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 30px; box-shadow: 0 4px 15px rgba(0,200,83,0.3); }
    .btn-back { background: #6c757d; color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 10px; }

    .preview-box {
        background: #222; color: #00ff6a; padding: 20px; border-radius: 15px;
        font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px;
        margin-top: 20px; border: 2px solid #555;
        -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        transition: filter 0.3s ease;
    }
    .preview-box:not(:hover) { filter: blur(1.5px); }

    @media print {
        body * { visibility: hidden; }
        .preview-box { visibility: hidden; }
        .preview-box::after { content: "METÄ°N KORUMALIDIR!"; visibility: visible; position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%); font-size: 30px; color: red; }
    }

    .disabled-input { background: #eee; cursor: not-allowed; }
</style>
</head>
<body oncontextmenu="return false;">

<div class="header">
    <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼ye DÃ¶n</button>
    <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
    <div id="raporBilgi" style="font-size: 12px; opacity: 0.8;">YÃ¼kleniyor...</div>
</div>

<div class="main-wrapper">
    <div class="form-container">
        <form id="mainForm" onsubmit="return false;">
            <div class="grid-form">
                <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
                <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1" list="h_v1" onfocus="showList(this)"></div>
                <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2" list="h_v2" onfocus="showList(this)"></div>
                <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3" list="h_v3" onfocus="showList(this)"></div>
                <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4" list="h_v4" onfocus="showList(this)"></div>
                <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5" list="h_v5" onfocus="showList(this)"></div>
                <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6" list="h_v6" onfocus="showList(this)"></div>
                <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7" list="h_v7" onfocus="showList(this)"></div>
                <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8" list="h_v8" onfocus="showList(this)"></div>
                <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9" list="h_v9" onfocus="showList(this)"></div>
                <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10" list="h_v10" onfocus="showList(this)"></div>
                <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11" list="h_v11" onfocus="showList(this)"></div>
                <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12" list="h_v12" onfocus="showList(this)"></div>
                <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13" list="h_v13" onfocus="showList(this)"></div>
                <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14" list="h_v14" onfocus="showList(this)"></div>
                <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15" list="h_v15" onfocus="showList(this)"></div>
                <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16" list="h_v16" onfocus="showList(this)"></div>

                <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>
                <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3" list="h_ulasimTarifi" onfocus="showList(this)"></textarea></div>
                <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari" list="h_ulasimOlanaklari" onfocus="showList(this)"></div>

                <div class="input-item">
                    <label>AltyapÄ± Durumu</label>
                    <div class="radio-group">
                        <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked onclick="toggleAltyapi(true)"> Evet</label>
                        <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r" onclick="toggleAltyapi(false)"> HayÄ±r</label>
                    </div>
                </div>
                <div class="input-item">
                    <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
                    <input type="text" id="altyapiAciklama" class="disabled-input" disabled list="h_altyapiAciklama" onfocus="showList(this)">
                </div>
            </div>
        </form>

        <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME (RAPORDA BÃ–YLE GÃ–RÃœNECEK)</div>
        <div class="preview-box" id="livePreview" oncopy="return false">Veri bekleniyor</div>

        <button class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET</button>
        <button class="btn-back" onclick="anaMenuyeDon()">MENÃœYE DÃ–N</button>
    </div>
</div>

<div id="datalists">
    <datalist id="h_v1"></datalist><datalist id="h_v2"></datalist><datalist id="h_v3"></datalist>
    <datalist id="h_v4"></datalist><datalist id="h_v5"></datalist><datalist id="h_v6"></datalist>
    <datalist id="h_v7"></datalist><datalist id="h_v8"></datalist><datalist id="h_v9"></datalist>
    <datalist id="h_v10"></datalist><datalist id="h_v11"></datalist><datalist id="h_v12"></datalist>
    <datalist id="h_v13"></datalist><datalist id="h_v14"></datalist><datalist id="h_v15"></datalist>
    <datalist id="h_v16"></datalist><datalist id="h_ulasimTarifi"></datalist>
    <datalist id="h_ulasimOlanaklari"></datalist><datalist id="h_altyapiAciklama"></datalist>
</div>

<script>
  // Firebase
  const auth = window.auth || firebase.auth();
  const db   = window.db   || firebase.firestore();

  // RID Ã¼ret (migration iÃ§in)
  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }

  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }

  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && String(r.rid) === String(rid));
  }

  // URL paramlarÄ±
  const params   = new URLSearchParams(location.search);
  let rid        = (params.get("rid") || "").toString().trim();
  const legacyId = (params.get("id")  || "").toString().trim();

  // localStorage raporlarÄ±
  let reports = [];
  try{ reports = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }catch(e){ reports=[]; }

  // rid yoksa ama id varsa -> ridâ€™ye Ã§evir
  if (ensureRidMigration(reports)) localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));

  if (!rid && legacyId !== ""){
    const idx = Number(legacyId);
    if (!Number.isNaN(idx) && reports[idx] && reports[idx].rid){
      rid = reports[idx].rid;
      // aynÄ± sayfayÄ± rid ile reload et (yanlÄ±ÅŸ rapor okuma biter)
      location.replace("konum_cevre.html?rid=" + encodeURIComponent(rid));
    }
  }

  // raporu rid ile bul
  function getReportByRid(){
    try{ reports = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }catch(e){ reports=[]; }
    const i = findIndexByRid(reports, rid);
    if (i < 0) return null;
    return reports[i];
  }

  // âœ… GERÄ° DÃ–N: her zaman rapor-detayâ€™a
  function goBackToRaporDetay(){
    if (!rid) location.href = "index.html";
    else location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
  }

  // Sayfanda back butonu varsa IDâ€™sini buraya yaz:
  // Ã¶rnek: <button id="btnBack">â† Geri</button>
  // yoksa class="back" ise ona da baÄŸlayalÄ±m
  window.addEventListener("DOMContentLoaded", () => {
    const b1 = document.getElementById("btnBack");
    if (b1) b1.onclick = goBackToRaporDetay;

    const b2 = document.querySelector(".back");
    if (b2) b2.onclick = (e)=>{ e.preventDefault(); goBackToRaporDetay(); };

    // Auth bekle (mobilde donma/boÅŸluk yapmasÄ±n)
    auth.onAuthStateChanged(async (user)=>{
      if (!user){ location.href="index.html"; return; }

      const r = getReportByRid();
      if (!r){ alert("Rapor bulunamadÄ± (rid)."); location.href="index.html"; return; }

      // âœ… BURADA ARTIK DOÄRU RAPOR GELÄ°R
      // Senin sayfanda hangi alanlara yazÄ±yorsan onlarÄ± doldur:
      // Ã–rnek:
      // document.getElementById("tamMetin").value = r.konumCevre?.tamMetin || "";
      // document.getElementById("baslik").textContent = r.propertyName || "Gayrimenkul";

      // Not: Senin mevcut doldurma/saklama kodunu buraya aynen koy,
      // ama 'reports[id]' gibi kullandÄ±ÄŸÄ±n her yeri rid mantÄ±ÄŸÄ±na Ã§evir:
      // reports[idx] yerine -> raporu 'findIndexByRid' ile bul.
    });
  });

  // DÄ±ÅŸarÄ± aÃ§ (html inline onclick varsa diye)
  window.goBackToRaporDetay = goBackToRaporDetay;
</script>

</body>
</html>


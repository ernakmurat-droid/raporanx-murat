<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konum ve √áevre √ñzellikleri - Raporan X</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        :root { --primary: #1a237e; --secondary: #3f51b5; --success: #00c853; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding-bottom:50px; }
        .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
        .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; text-decoration:none; border: none; cursor: pointer; font-weight: bold; }
        .main-wrapper { display: flex; flex-direction: column; max-width: 1000px; margin: 15px auto; gap: 15px; padding: 0 15px; }
        .form-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .section-title { grid-column: span 2; border-left: 5px solid var(--primary); margin-top: 20px; padding-left: 10px; color: var(--primary); font-weight: bold; background: #f0f2ff; padding: 8px; border-radius: 0 8px 8px 0; }
        .input-item { display: flex; flex-direction: column; }
        .input-item label { font-weight: 600; font-size: 13px; color: #444; margin-bottom: 5px; }
        input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; width: 100%; box-sizing: border-box; }
        .btn-save { background: var(--success); color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 30px; }
        .preview-box { background: #333; color: #00ff00; padding: 20px; border-radius: 15px; font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px; margin-top: 20px; border: 2px solid #555; }
        .save-status { display: none; text-align: center; font-weight: bold; margin-top: 15px; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="header">
    <button onclick="anaMenuyeDon()" class="back">‚Üê Geri</button>
    <h1>KONUM VE √áEVRESEL √ñZELLƒ∞KLER</h1>
    <div id="raporBilgi" style="font-size: 14px; opacity: 0.9; margin-top:5px; font-weight: bold;">Y√ºkleniyor...</div>
</div>

<div class="main-wrapper">
    <div class="form-container">
        <form id="mainForm" onsubmit="return false;">
            <div class="grid-form">
                <div class="section-title">üìä TABLO VE METƒ∞N VERƒ∞LERƒ∞</div>
                <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1"></div>
                <div class="input-item"><label>(4) ƒ∞li</label><input type="text" id="v4"></div>
                <div class="input-item"><label>(5) ƒ∞l√ßesi</label><input type="text" id="v5"></div>
                <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6"></div>
                <div class="input-item full-width"><label>Ula≈üƒ±m Tarifi</label><textarea id="ulasimTarifi" rows="3"></textarea></div>
            </div>
        </form>

        <div class="section-title">üëÄ CANLI √ñNƒ∞ZLEME</div>
        <div id="livePreview" class="preview-box">Veri bekleniyor...</div>
        
        <button class="btn-save" onclick="verileriKaydet()">VERƒ∞LERƒ∞ KAYDET VE BULUTA M√úH√úRLE</button>
        <div id="statusMsg" class="save-status"></div>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get('id');
    
    let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    let report = reports[id] || {};
    const inputIds = ['v1','v4','v5','v6','ulasimTarifi'];

    window.onload = () => {
        if (!id) { window.location.href = 'index.html'; return; }
        document.getElementById('raporBilgi').textContent = report.propertyName || "Rapor";
        
        inputIds.forEach(fid => {
            if(report.konumCevre && report.konumCevre[fid]) document.getElementById(fid).value = report.konumCevre[fid];
        });
        guncelleOnizleme();
    };

    function guncelleOnizleme() {
        let v = {};
        inputIds.forEach(fid => { v[fid] = document.getElementById(fid).value || "..."; });
        const tamMetin = `Ta≈üƒ±nmaz ${v.v4} ili, ${v.v5} il√ßesi, ${v.v6} mahallesinde yer almaktadƒ±r. Ula≈üƒ±m: ${v.ulasimTarifi}`;
        document.getElementById('livePreview').textContent = tamMetin;
        return tamMetin;
    }

    async function verileriKaydet() {
        const tamMetin = guncelleOnizleme();
        let v = {};
        inputIds.forEach(fid => { v[fid] = document.getElementById(fid).value; });

        report.konumCevre = { ...v, tamMetin: tamMetin };
        report.konum_tamamlandi = true;
        reports[id] = report;
        localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
        
        const user = auth.currentUser;
        if (user) {
            await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: reports }, { merge: true });
        }

        const statusMsg = document.getElementById('statusMsg');
        statusMsg.style.display = 'block';
        statusMsg.style.background = '#d1e7dd';
        statusMsg.textContent = "‚úÖ Buluta M√ºh√ºrlendi!";
        setTimeout(() => { statusMsg.style.display = 'none'; }, 2000);
    }

    // ANAYASA: 404 Hatasƒ±nƒ± √ß√∂zen fonksiyon
    function anaMenuyeDon() { 
        window.location.href = `rapor-detay.html?id=${id}`; 
    }

    inputIds.forEach(fid => {
        document.getElementById(fid).addEventListener('input', guncelleOnizleme);
    });
</script>
</body>
</html>
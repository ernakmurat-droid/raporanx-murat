<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Konum ve Ã‡evre Ã–zellikleri - Raporan X</title>
  <style>
    :root { --primary:#1a237e; --secondary:#3f51b5; --success:#00c853; --bg:#f4f7f6; }
    body { font-family:'Segoe UI', sans-serif; background:var(--bg); margin:0; padding-bottom:50px; }
    .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; text-decoration:none; border:none; cursor:pointer; }
    .main-wrapper { display:flex; flex-direction:column; max-width:1000px; margin:15px auto; gap:15px; padding:0 15px; }
    .form-container { background:white; padding:25px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
    .section-title { grid-column:span 2; border-left:5px solid var(--primary); margin-top:20px; padding-left:10px; color:var(--primary); font-weight:bold; background:#f0f2ff; padding:8px; border-radius:0 8px 8px 0; }
    .input-item { display:flex; flex-direction:column; }
    .input-item label { font-weight:600; font-size:13px; color:#444; margin-bottom:5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background:#fff; transition:0.3s; width:100%; box-sizing:border-box; }
    .radio-group { display:flex; gap:20px; padding:10px 0; }
    .preview-box {
      background:#333; color:#00ff00; padding:20px; border-radius:15px;
      font-family:'Courier New', monospace; white-space:pre-wrap; font-size:13px;
      margin-top:20px; border:2px solid #555;
      user-select:none; transition:filter 0.3s ease;
    }
    .preview-box:not(:hover) { filter:blur(1.5px); }
    .btn-save { background:var(--success); color:white; padding:20px; border:none; border-radius:15px; width:100%; font-weight:bold; font-size:18px; cursor:pointer; margin-top:30px; }
  </style>
</head>

<body oncontextmenu="return false;">
<div class="header">
  <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼ye DÃ¶n</button>
  <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
  <div id="raporBilgi" style="font-size:12px; opacity:0.8;">YÃ¼kleniyor...</div>
</div>

<div class="main-wrapper">
  <div class="form-container">
    <form id="mainForm" onsubmit="return false;">
      <div class="grid-form">
        <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ°</div>
        <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1"></div>
        <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4"></div>
        <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5"></div>
        <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6"></div>
        <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7"></div>
        <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12"></div>
        <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13"></div>
        <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14"></div>
        <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15"></div>
        <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16"></div>

        <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>
        <div class="input-item" style="grid-column:span 2;"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3"></textarea></div>
        <div class="input-item" style="grid-column:span 2;"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari"></div>

        <div class="input-item">
          <label>AltyapÄ± Durumu</label>
          <div class="radio-group">
            <label><input type="radio" name="altyapi" value="Evet" checked onclick="toggleAltyapi(true)"> Evet</label>
            <label><input type="radio" name="altyapi" value="HayÄ±r" onclick="toggleAltyapi(false)"> HayÄ±r</label>
          </div>
        </div>
        <div class="input-item"><label>AltyapÄ± AÃ§Ä±klamasÄ±</label><input type="text" id="altyapiAciklama" disabled></div>
      </div>
    </form>

    <div class="preview-box" id="livePreview">Veri bekleniyor...</div>
    <button class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET VE BULUTA MÃœHÃœRLE</button>
  </div>
</div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + legacy id desteÄŸi ========= */
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  // legacy id -> rid yÃ¶nlendirme
  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      window.location.replace("konum-cevre.html?rid=" + encodeURIComponent(rid));
    }
  }

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }

  const inputIds = ['v1','v4','v5','v6','v7','v12','v13','v14','v15','v16','ulasimTarifi','ulasimOlanaklari','altyapiAciklama'];

  function yukleVeBaslat(report) {
    if(report.konumCevre) {
      inputIds.forEach(fid => {
        if (report.konumCevre[fid] != null) document.getElementById(fid).value = report.konumCevre[fid];
      });

      // radio
      if (report.konumCevre.altyapiTik === "HayÄ±r") {
        document.querySelector('input[name="altyapi"][value="HayÄ±r"]').checked = true;
        toggleAltyapi(false);
      } else {
        document.querySelector('input[name="altyapi"][value="Evet"]').checked = true;
        toggleAltyapi(true);
      }
    }
    guncelleOnizleme();
  }

  function guncelleOnizleme() {
    let v = {};
    inputIds.forEach(fid => { v[fid] = (document.getElementById(fid).value || "").trim() || "..."; });

    const altyapiTik = document.querySelector('input[name="altyapi"]:checked').value;
    const altyapiMetni = (altyapiTik === "Evet")
      ? "altyapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r"
      : ((v.altyapiAciklama && v.altyapiAciklama !== "...") ? v.altyapiAciklama : "...");

    const f1 =
      `KONUMU VE Ã‡EVRESEL Ã–ZELLÄ°KLERÄ°\n` +
      `TaÅŸÄ±nmaz, ${v.v4} ili, ${v.v5} ilÃ§esi, ${v.v6} mahallesi posta adresinde yer almaktadÄ±r. ` +
      `UlaÅŸÄ±m; ${v.ulasimTarifi}. ` +
      `BÃ¶lge ${v.v14} gelir grubu tarafÄ±ndan talep gÃ¶rmektedir. ` +
      `YakÄ±n Ã§evresinde ${v.v15} ve ${v.v16} yer almaktadÄ±r. ` +
      `AltyapÄ± olarak ${altyapiMetni}.`;

    document.getElementById('livePreview').textContent = f1;
    return f1;
  }

  async function verileriKaydet() {
    const paket = guncelleOnizleme();

    const { arr, i, r } = getLatestData();
    if (!r || i < 0) { alert("Rapor bulunamadÄ±!"); return; }

    let v = {};
    inputIds.forEach(fid => { v[fid] = document.getElementById(fid).value; });
    v.altyapiTik = document.querySelector('input[name="altyapi"]:checked').value;

    // âœ… Final raporun beklediÄŸi: report.konumCevre.tamMetin
    r.konumCevre = { ...v, tamMetin: paket };

    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));

    // buluta yaz
    const user = auth.currentUser;
    if (user) {
      try {
        await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: arr }, { merge: true });
        alert("âœ… Konum/Ã‡evre verileri hem cihaza hem buluta mÃ¼hÃ¼rlendi!");
      } catch (e) {
        console.error(e);
        alert("âš ï¸ Yerel kaydedildi ama buluta gÃ¶nderilemedi: " + e.message);
      }
    } else {
      alert("âœ… Yerel kaydedildi (oturum yok).");
    }
  }

  function toggleAltyapi(isEvet) {
    document.getElementById('altyapiAciklama').disabled = isEvet;
  }

  function anaMenuyeDon() {
    window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
  }

  // live preview
  inputIds.forEach(fid => {
    const el = document.getElementById(fid);
    if(el) el.addEventListener('input', guncelleOnizleme);
  });
  document.querySelectorAll('input[name="altyapi"]').forEach(r => r.addEventListener('change', guncelleOnizleme));

  // auth guard
  auth.onAuthStateChanged((user) => {
    const { r } = getLatestData();
    if (!user || !rid || !r) {
      window.location.href = 'index.html';
      return;
    }
    document.getElementById('raporBilgi').textContent = r.propertyName || "Rapor";
    yukleVeBaslat(r);
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Rapor Önizleme (Hak Düşmez)</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  :root{ --primary:#1a237e; --secondary:#3949ab; --bg:#f4f7f9; }
  body{font-family:'Segoe UI',sans-serif;background:var(--bg);margin:0;color:#2c3e50;}
  .header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:18px;text-align:center;position:sticky;top:0;z-index:999;}
  .back{position:absolute;left:12px;top:14px;background:rgba(255,255,255,.2);padding:8px 14px;border-radius:30px;color:#fff;border:none;cursor:pointer;font-weight:900;}
  .wrap{max-width:1100px;margin:14px auto;padding:0 14px;}
  .note{background:#e3f2fd;border-left:6px solid #2196f3;padding:10px 12px;border-radius:12px;font-weight:900;}
  .box{background:#fff;border-radius:14px;padding:14px;margin-top:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);}
  .box h3{margin:0 0 10px;color:var(--primary);}
  pre{white-space:pre-wrap;word-break:break-word;margin:0;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;line-height:1.5;}
  .err{background:#ffebee;border-left:6px solid #f44336;}
</style>
</head>
<body>

<div class="header">
  <button class="back" id="btnBack">← Geri</button>
  <div style="font-weight:900;font-size:18px;">RAPOR ÖNİZLEME</div>
  <div style="opacity:.9;font-size:12px;">Hak düşmez • Kilitlemez • Sadece kontrol</div>
</div>

<div class="wrap">
  <div class="note">
    Bu sayfa sadece kontrol içindir. Buradan çıkınca hiçbir şey değişmez.
  </div>

  <div class="box">
    <h3>RID / Kaynak</h3>
    <pre id="meta">Yükleniyor…</pre>
  </div>

  <div class="box">
    <h3>Konum & Çevre (tamMetin)</h3>
    <pre id="konum">Yükleniyor…</pre>
  </div>

  <div class="box">
    <h3>Tapu (B1 + B2)</h3>
    <pre id="tapu">Yükleniyor…</pre>
  </div>

  <div class="box">
    <h3>İmar / Belgeler / Bina / BB / Emsal</h3>
    <pre id="others">Yükleniyor…</pre>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const auth = window.auth || firebase.auth();
  const db = window.db || firebase.firestore();
  const $ = (id) => document.getElementById(id);

  const qs = new URLSearchParams(location.search);
  const rid = (qs.get("rid") || qs.get("id") || "").toString().trim();

  $("btnBack").onclick = () => {
    if (!rid) location.href="index.html";
    else location.href="rapor-detay.html?rid=" + encodeURIComponent(rid);
  };

  function formatMetin(t){
    if (t === null || t === undefined) return "";
    return String(t).replace(/\r\n/g,"\n").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
  }
  function pick(obj, ...paths){
    for (const p of paths){
      try{
        const val = p.split(".").reduce((acc,k)=> (acc && acc[k] !== undefined ? acc[k] : undefined), obj);
        if (val !== undefined && val !== null && String(val).trim() !== "") return val;
      }catch{}
    }
    return "";
  }

  function loadLocal(){
    let arr = [];
    try{ arr = JSON.parse(localStorage.getItem("gayrimenkul_reports")||"[]"); }catch(e){}
    const r = arr.find(x => x && String(x.rid) === String(rid)) || null;
    return r;
  }

  async function loadRemote(uid){
    async function getDoc(path){
      try{
        const snap = await db.doc(path).get();
        if (snap.exists) return snap.data();
      }catch(e){}
      return null;
    }
    let d = await getDoc(`users/${uid}/reports/${rid}`);
    if (d) return d;
    d = await getDoc(`reports/${rid}`);
    if (d) return d;
    return null;
  }

  auth.onAuthStateChanged(async (user)=>{
    if (!user){ alert("Giriş yok!"); location.href="index.html"; return; }
    if (!rid){ alert("RID yok!"); location.href="index.html"; return; }

    let rep = loadLocal();
    let source = "localStorage";
    if (!rep){
      rep = await loadRemote(user.uid);
      source = rep ? "Firestore" : "YOK";
    }
    if (!rep){
      $("meta").textContent = `RID: ${rid}\nKaynak: ${source}\n\nRapor bulunamadı.`;
      $("konum").textContent = "—";
      $("tapu").textContent = "—";
      $("others").textContent = "—";
      return;
    }

    $("meta").textContent =
      `RID: ${rid}\nKaynak: ${source}\nBaşlık: ${rep.propertyName || rep.baslik || "—"}\nİl/İlçe: ${rep.il||"—"} / ${rep.ilce||"—"}`;

    const konum = formatMetin(pick(rep,
      "konumCevre.tamMetin",
      "konumCevre.metin",
      "konumMetni",
      "konumMetin"
    ));
    $("konum").textContent = konum || "❌ Konum metni boş (konumCevre.tamMetin yok)";

    const tapu1 = formatMetin(pick(rep,"tapuMetniB1","tapu.b1","tapuMetinB1"));
    const tapu2 = formatMetin(pick(rep,"tapuMetniB2","tapu.b2","tapuMetinB2"));
    $("tapu").textContent = `B1:\n${tapu1 || "—"}\n\nB2:\n${tapu2 || "—"}`;

    const imar = formatMetin(pick(rep,"imarMetni","imar.metin","imar.tamMetin"));
    const belgeler = formatMetin(pick(rep,"belgelerMetni","belgeler.metin","belgeler.tamMetin"));
    const bina = formatMetin(pick(rep,"bina.metin","bina.tamMetin","binaMetni","binaMetin"));
    const bb = formatMetin(pick(rep,"bbDetay.tamMetin","katDetayMetni"));
    const emsal = formatMetin(pick(rep,"degerlemeOzet.emsalFinalMetni","emsalFinalMetni"));

    $("others").textContent =
`İMAR:\n${imar || "—"}\n\nBELGELER:\n${belgeler || "—"}\n\nBİNA:\n${bina || "—"}\n\nBB:\n${bb || "—"}\n\nEMSAL:\n${emsal || "—"}`;
  });
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konum ve Ã‡evre Ã–zellikleri - Full Metin & Bulut</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary:#1a237e; --secondary:#3f51b5; --success:#00c853; --bg:#f4f7f6; }
    body { font-family:'Segoe UI', sans-serif; background:var(--bg); margin:0; padding-bottom:50px; }
    .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; border:none; cursor:pointer; }
    .main-wrapper { display:flex; flex-direction:column; max-width:1000px; margin:15px auto; gap:15px; padding:0 15px; }
    .form-container { background:white; padding:25px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
    .section-title { grid-column:span 2; border-left:5px solid var(--primary); margin-top:20px; padding-left:10px; color:var(--primary); font-weight:bold; background:#f0f2ff; padding:8px; border-radius:0 8px 8px 0; }
    .input-item { display:flex; flex-direction:column; }
    .input-item label { font-weight:600; font-size:13px; color:#444; margin-bottom:5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background:#fff; width:100%; box-sizing:border-box; }
    input:focus, textarea:focus { border-color:var(--primary); outline:none; box-shadow:0 0 8px rgba(26,35,126,0.1); }
    .radio-group { display:flex; gap:20px; padding:10px 0; }
    .radio-item { display:flex; align-items:center; gap:8px; cursor:pointer; }
    .full-width { grid-column:span 2; }
    .btn-save { background:var(--success); color:white; padding:20px; border:none; border-radius:15px; width:100%; font-weight:bold; font-size:18px; cursor:pointer; margin-top:30px; box-shadow:0 4px 15px rgba(0,200,83,0.3); }
    .btn-save:disabled { opacity:.6; cursor:not-allowed; }
    .btn-back { background:#6c757d; color:white; padding:20px; border:none; border-radius:15px; width:100%; font-weight:bold; font-size:18px; cursor:pointer; margin-top:10px; }
    .preview-box { background:#333; color:#00ff00; padding:20px; border-radius:15px; font-family:'Courier New', monospace; white-space:pre-wrap; font-size:13px; margin-top:20px; border:2px solid #555; transition:filter .3s ease; user-select:none; }
    .preview-box:not(:hover) { filter: blur(1.5px); }
    .disabled-input { background:#eee !important; cursor:not-allowed; }
    .save-status { display:none; text-align:center; font-weight:bold; margin-top:15px; padding:10px; border-radius:10px; }
    .locked-banner { display:none; margin-top:10px; background:#ffe082; color:#333; padding:10px; border-radius:12px; font-weight:bold; }
  </style>
</head>

<body oncontextmenu="return false;">

<div class="header">
  <button id="btnBack" class="back" type="button">â† MenÃ¼ye DÃ¶n</button>
  <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
  <div id="raporBilgi" style="font-size: 12px; opacity: 0.8;">YÃ¼kleniyor...</div>
  <div id="lockedBanner" class="locked-banner">ğŸ”’ Bu rapor mÃ¼hÃ¼rlÃ¼. DeÄŸiÅŸiklik yapamazsÄ±n.</div>
</div>

<div class="main-wrapper">
  <div class="form-container">
    <form id="mainForm" onsubmit="return false;">
      <div class="grid-form">
        <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
        <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1" list="h_v1" onfocus="showList(this)"></div>
        <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2" list="h_v2" onfocus="showList(this)"></div>
        <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3" list="h_v3" onfocus="showList(this)"></div>
        <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4" list="h_v4" onfocus="showList(this)"></div>
        <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5" list="h_v5" onfocus="showList(this)"></div>
        <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6" list="h_v6" onfocus="showList(this)"></div>
        <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7" list="h_v7" onfocus="showList(this)"></div>
        <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8" list="h_v8" onfocus="showList(this)"></div>
        <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9" list="h_v9" onfocus="showList(this)"></div>
        <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10" list="h_v10" onfocus="showList(this)"></div>
        <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11" list="h_v11" onfocus="showList(this)"></div>
        <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ± (Kat)</label><input type="text" id="v12" list="h_v12" onfocus="showList(this)"></div>
        <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13" list="h_v13" onfocus="showList(this)"></div>
        <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14" list="h_v14" onfocus="showList(this)"></div>
        <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15" list="h_v15" onfocus="showList(this)"></div>
        <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16" list="h_v16" onfocus="showList(this)"></div>

        <div class="section-title">ğŸ“ KUTSAL METÄ°N DEÄÄ°ÅKENLERÄ°</div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3" list="h_ulasimTarifi" onfocus="showList(this)"></textarea></div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari" list="h_ulasimOlanaklari" onfocus="showList(this)"></div>

        <div class="input-item">
          <label>AltyapÄ± Durumu</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked> Evet</label>
            <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r"> HayÄ±r</label>
          </div>
        </div>
        <div class="input-item">
          <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
          <input type="text" id="altyapiAciklama" class="disabled-input" disabled list="h_altyapiAciklama" onfocus="showList(this)">
        </div>
      </div>
    </form>

    <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME (FULL FORMAT)</div>
    <div class="preview-box" id="livePreview" oncopy="return false">Veri bekleniyor...</div>

    <button id="saveBtn" class="btn-save" type="button">VERÄ°LERÄ° KAYDET VE BULUTA MÃœHÃœRLE</button>
    <div id="statusMsg" class="save-status"></div>
    <button id="menuBtn" class="btn-back" type="button">MENÃœYE DÃ–N</button>
  </div>
</div>

<div id="datalists"></div>

<script>
  // âœ… datalist Ã¼retimi aynÄ±
  (function(){
    const ids = ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11','v12','v13','v14','v15','v16','ulasimTarifi','ulasimOlanaklari','altyapiAciklama'];
    const wrap = document.getElementById("datalists");
    wrap.innerHTML = ids.map(id => `<datalist id="h_${id}"></datalist>`).join("");
  })();

  const db = window.db;
  const auth = window.auth;

  const urlParams = new URLSearchParams(window.location.search);
  const reportId = urlParams.get("id"); // âœ… artÄ±k docId

  const inputIds = ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11','v12','v13','v14','v15','v16','ulasimTarifi','ulasimOlanaklari','altyapiAciklama'];

  let currentUser = null;
  let reportRef = null;
  let reportData = null;

  function anaMenuyeDon(){
    if(!reportId){ location.href="index.html"; return; }
    location.href = `rapor-detay.html?id=${encodeURIComponent(reportId)}`;
  }

  document.getElementById("btnBack").addEventListener("click", anaMenuyeDon);
  document.getElementById("menuBtn").addEventListener("click", anaMenuyeDon);

  function showList(input) {
    input.setAttribute('autocomplete', 'off');
    const val = input.value;
    input.value = '';
    setTimeout(() => { input.value = val; }, 1);
  }

  function toggleAltyapi(isEvet) {
    const input = document.getElementById('altyapiAciklama');
    input.disabled = isEvet;
    if (isEvet) {
      input.classList.add('disabled-input');
      input.value = "";
    } else {
      input.classList.remove('disabled-input');
    }
    guncelleOnizleme();
  }

  // radio deÄŸiÅŸimini dinle (onclick yerine saÄŸlam yÃ¶ntem)
  document.querySelectorAll('input[name="altyapi"]').forEach(r => {
    r.addEventListener("change", () => {
      toggleAltyapi(document.querySelector('input[name="altyapi"]:checked').value === "Evet");
    });
  });

  function setLockedUI(isLocked){
    const banner = document.getElementById("lockedBanner");
    const saveBtn = document.getElementById("saveBtn");
    if(isLocked){
      banner.style.display = "block";
      saveBtn.disabled = true;
      inputIds.forEach(fid => {
        const el = document.getElementById(fid);
        if(el){ el.disabled = true; el.classList.add("disabled-input"); }
      });
      document.querySelectorAll('input[name="altyapi"]').forEach(r => r.disabled = true);
    } else {
      banner.style.display = "none";
      saveBtn.disabled = false;
    }
  }

  // âœ… FULL METÄ°N motorun: tablo + f1 + f2 + f3 (dokunmadÄ±m)
  function guncelleOnizleme() {
    let v = {};
    inputIds.forEach(id => { v[id] = document.getElementById(id).value || "..."; });

    let yapiTipi = (v.v13 || "").trim();
    let yapiTipiMetni = (yapiTipi !== "..." && yapiTipi !== "" && !yapiTipi.toLowerCase().includes("tip") && !yapiTipi.toLowerCase().includes("yapÄ±"))
      ? yapiTipi + " tipi yapÄ±lar"
      : (yapiTipi || "...");

    const altyapiTik = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";
    const altyapiMetni = altyapiTik === "Evet" ? "alt yapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r" : (v.altyapiAciklama || "...");

    let tablo = "------------------------------------------\n Ã‡EVRESEL Ã–ZELLÄ°KLER TABLOSU\n------------------------------------------\n";
    const labels = ["UAVT","Koord X","Koord Y","Ä°li","Ä°lÃ§esi","Mahallesi","Cadde/Sokak","DÄ±ÅŸ KapÄ± No","Bul. Kat","Daire No","BÃ¶lge GeliÅŸimi","YapÄ±laÅŸma","YapÄ± Tipleri","Gelir DÃ¼zeyi","YakÄ±n YapÄ± 1","YakÄ±n YapÄ± 2"];
    for (let i=1; i<=16; i++) {
      tablo += `${labels[i-1].padEnd(20,' ')} : ${v['v'+i]}\n`;
    }

    const f1 =
`KONUMU VE Ã‡EVRESEL Ã–ZELLÄ°KLERÄ° (Format 1)
DeÄŸerlemeye konu taÅŸÄ±nmaz, ${v.v4} ili, ${v.v5} Ä°lÃ§esi, ${v.v6} Mahallesi ${v.v7}, No: ${v.v8}/${v.v10} posta adresinde yer almaktadÄ±r. TaÅŸÄ±nmaza ulaÅŸÄ±m; ${v.ulasimTarifi}. BÃ¶lge genelde yapÄ± kalitesine baÄŸlÄ± olarak, ${v.v14} gelir grubu tarafÄ±ndan yerleÅŸim amaÃ§lÄ± olarak talep gÃ¶rmektedir. BÃ¶lge Ã§evresinde ${v.v12} katlÄ± ${yapiTipiMetni} bulunmaktadÄ±r. ${v.ulasimOlanaklari} TaÅŸÄ±nmazÄ±n yakÄ±n Ã§evresinde ${v.v15} ve ${v.v16} yer almaktadÄ±r.

BÃ¶lgenin GeliÅŸimine Ä°liÅŸkin Analiz
TaÅŸÄ±nmaza bulunduÄŸu bÃ¶lge ${v.v14} grubunun yerleÅŸim iÃ§in tercih ettiÄŸi bir bÃ¶lgedir. TaÅŸÄ±nmazÄ±n bulunduÄŸu bÃ¶lgede yapÄ±laÅŸma ${v.v11} ÅŸeklindedir.`;

    const f2 =
`TAÅINMAZIN YERÄ° VE Ã‡EVRE Ã–ZELLÄ°KLERÄ° (Format 2)
DeÄŸerlemesi yapÄ±lan gayrimenkul, ${v.v6} Mahallesi, ${v.v7}, No: ${v.v8}, Kat: ${v.v9} Daire: ${v.v10}, ${v.v5}/${v.v4} aÃ§Ä±k posta adresinde yer almaktadÄ±r. GayrimenkulÃ¼n bulunduÄŸu bÃ¶lgede ${v.v12} nitelikli ${yapiTipiMetni} bulunmaktadÄ±r. UlaÅŸÄ±m iÃ§in; ${v.ulasimTarifi}.`;

    const f3 =
`ULAÅIM TARÄ°FÄ° (Format 3)
DeÄŸerleme konusu taÅŸÄ±nmaz, ${v.v4} Ä°li, ${v.v5} Ä°lÃ§esi, ${v.v6} Mahallesi, ${v.v7}, No: ${v.v8}/${v.v10} posta adresinde yer almaktadÄ±r. DeÄŸerleme konusu taÅŸÄ±nmaza ulaÅŸÄ±m; ${v.ulasimTarifi}. PlanlÄ± yapÄ±laÅŸmaya sahip bÃ¶lgenin (yol, su, elektrik, kanalizasyon, doÄŸalgaz) ${altyapiMetni}. ${v.ulasimOlanaklari}`;

    const tamPaket = tablo + "\n" + f1 + "\n\n" + f2 + "\n\n" + f3;
    document.getElementById("livePreview").textContent = tamPaket;
    return tamPaket;
  }

  // input deÄŸiÅŸince canlÄ± gÃ¼ncelle
  inputIds.forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", guncelleOnizleme);
  });

  async function loadReportFromCloud(){
    if(!currentUser) return;
    if(!reportId){ location.href="index.html"; return; }

    reportRef = db.collection("users").doc(currentUser.uid).collection("reports").doc(reportId);
    const snap = await reportRef.get();

    if(!snap.exists){
      alert("Rapor bulunamadÄ± (bu kullanÄ±cÄ±ya ait deÄŸil veya silinmiÅŸ).");
      location.href="index.html";
      return;
    }

    reportData = snap.data();
    document.getElementById("raporBilgi").textContent = reportData.propertyName || "Yeni Rapor";

    // datalist geÃ§miÅŸi (opsiyonel, sende vardÄ±)
    inputIds.forEach(id => {
      let h = JSON.parse(localStorage.getItem('h_' + id)) || [];
      const dl = document.getElementById('h_' + id);
      if(dl) dl.innerHTML = h.map(item => `<option value="${item}">`).join('');
    });

    // form doldur
    if(reportData.konumCevre){
      inputIds.forEach(id => {
        if(reportData.konumCevre[id] !== undefined && reportData.konumCevre[id] !== null){
          document.getElementById(id).value = reportData.konumCevre[id];
        }
      });
      if(reportData.konumCevre.altyapiTik === "HayÄ±r"){
        document.querySelector('input[name="altyapi"][value="HayÄ±r"]').checked = true;
        toggleAltyapi(false);
      } else {
        document.querySelector('input[name="altyapi"][value="Evet"]').checked = true;
        toggleAltyapi(true);
      }
    } else {
      toggleAltyapi(true);
    }

    setLockedUI(!!reportData.isLocked);
    guncelleOnizleme();
  }

  async function verileriKaydet(){
    if(!currentUser) return alert("GiriÅŸ yok!");
    if(!reportRef || !reportData) return alert("Rapor yÃ¼klenmedi!");
    if(reportData.isLocked) return alert("ğŸ”’ Rapor mÃ¼hÃ¼rlÃ¼. Kaydedemezsin.");

    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true;

    try{
      const paket = guncelleOnizleme();

      let v = {};
      inputIds.forEach(id => { v[id] = (document.getElementById(id).value || "").trim(); });
      v.altyapiTik = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";

      const kritikAlanlar = ['v1','v4','v5','v6','ulasimTarifi'];
      let eksikVar = kritikAlanlar.some(field => !v[field] || v[field] === "..." );

      if (eksikVar && !confirm("âš ï¸ BazÄ± teknik veriler eksik. Yine de mÃ¼hÃ¼rlemek istiyor musunuz?")) {
        saveBtn.disabled = false;
        return;
      }

      const konumCevreObj = { ...v, tamMetin: paket };

      // âœ… sadece bu raporu buluta yaz
      await reportRef.set({
        konumCevre: konumCevreObj,
        konum_tamamlandi: !eksikVar,
        updatedAt: new Date().toISOString()
      }, { merge: true });

      // ekranda mesaj
      const statusMsg = document.getElementById('statusMsg');
      statusMsg.style.display = 'block';
      statusMsg.style.background = eksikVar ? '#fff3cd' : '#d1e7dd';
      statusMsg.style.color = eksikVar ? '#856404' : '#0f5132';
      statusMsg.textContent = eksikVar ? "âš ï¸ Veriler eksik mÃ¼hÃ¼rlendi (Bulut GÃ¼ncellendi)!" : "âœ… Tablo ve TÃ¼m Formatlar Buluta MÃ¼hÃ¼rlendi!";
      setTimeout(() => { statusMsg.style.display = 'none'; },s, 4000);

      // local cache (opsiyonel)
      try{
        const cacheKey = "cloud_reports_cache_" + currentUser.uid;
        const cache = JSON.parse(localStorage.getItem(cacheKey) || "{}");
        cache[reportId] = { ...(cache[reportId]||{}), konumCevre: konumCevreObj, konum_tamamlandi: !eksikVar };
        localStorage.setItem(cacheKey, JSON.stringify(cache));
      } catch(e){}

      reportData.konumCevre = konumCevreObj;
      reportData.konum_tamamlandi = !eksikVar;

    } catch(e){
      console.error(e);
      alert("âŒ KayÄ±t hatasÄ±: " + (e?.message || e));
    } finally {
      saveBtn.disabled = false;
    }
  }

  document.getElementById("saveBtn").addEventListener("click", verileriKaydet);

  // giriÅŸ kontrol + yÃ¼kle
  auth.onAuthStateChanged(async (user) => {
    if(!user){ location.href="index.html"; return; }
    currentUser = user;
    await loadReportFromCloud();
  });
</script>
</body>
</html>

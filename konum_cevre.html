<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konum ve Ã‡evre Ã–zellikleri - Raporan X</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
      :root { --primary:#1a237e; --secondary:#3f51b5; --success:#00c853; --bg:#f4f7f6; }
      body { font-family:'Segoe UI',sans-serif; background:var(--bg); margin:0; padding-bottom:50px; }
      .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
      .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:#fff; border:none; cursor:pointer; font-weight:800; }
      .main-wrapper { display:flex; flex-direction:column; max-width:1000px; margin:15px auto; gap:15px; padding:0 15px; }
      .form-container { background:#fff; padding:25px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
      .grid-form { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
      .section-title { grid-column:span 2; border-left:5px solid var(--primary); margin-top:20px; padding-left:10px; color:var(--primary); font-weight:900; background:#f0f2ff; padding:8px; border-radius:0 8px 8px 0; }
      .input-item { display:flex; flex-direction:column; }
      .input-item label { font-weight:700; font-size:13px; color:#444; margin-bottom:5px; }
      input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; width:100%; box-sizing:border-box; }
      input:focus, textarea:focus { border-color:var(--primary); box-shadow:0 0 8px rgba(26,35,126,0.1); outline:none; }
      .radio-group { display:flex; gap:20px; padding:10px 0; }
      .radio-item { display:flex; align-items:center; gap:8px; cursor:pointer; }
      .full-width { grid-column:span 2; }
      .btn-save { background:var(--success); color:#fff; padding:20px; border:none; border-radius:15px; width:100%; font-weight:900; font-size:18px; cursor:pointer; margin-top:30px; }
      .btn-back { background:#6c757d; color:#fff; padding:20px; border:none; border-radius:15px; width:100%; font-weight:900; font-size:18px; cursor:pointer; margin-top:10px; }
      .preview-box { background:#222; color:#00ff6a; padding:20px; border-radius:15px; font-family:'Courier New',monospace; white-space:pre-wrap; font-size:13px; margin-top:20px; border:2px solid #555; }
      .disabled-input { background:#eee; cursor:not-allowed; opacity:.7; }
      .locked-note{ margin-top:12px; padding:10px 12px; border-radius:14px; background:#fff3cd; border:1px solid #ffe69c; color:#7a5b00; font-weight:900; display:none; }
    </style>
</head>
<body oncontextmenu="return false;">
<div class="header">
  <button onclick="anaMenuyeDon()" class="back">â† MenÃ¼ye DÃ¶n</button>
  <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
  <div id="raporBilgi" style="font-size:12px;opacity:.85;">YÃ¼kleniyor...</div>
</div>
<div class="main-wrapper">
  <div class="form-container">
    <div id="lockedNote" class="locked-note">ğŸ”’ RAPOR KÄ°LÄ°TLÄ° â€” Bu modÃ¼l dÃ¼zenlenemez.</div>
    <form id="mainForm" onsubmit="return false;">
      <div class="grid-form">
        <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
        <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1" list="h_v1" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2" list="h_v2" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3" list="h_v3" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4" list="h_v4" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5" list="h_v5" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6" list="h_v6" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7" list="h_v7" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8" list="h_v8" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9" list="h_v9" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10" list="h_v10" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11" list="h_v11" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12" list="h_v12" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13" list="h_v13" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14" list="h_v14" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15" list="h_v15" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16" list="h_v16" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3" list="h_ulasimTarifi" onfocus="showList(this)" oninput="guncelleOnizleme()"></textarea></div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari" list="h_ulasimOlanaklari" onfocus="showList(this)" oninput="guncelleOnizleme()"></div>
        <div class="input-item">
          <label>AltyapÄ± Durumu</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked onchange="toggleAltyapi(true)"> Evet</label>
            <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r" onchange="toggleAltyapi(false)"> HayÄ±r</label>
          </div>
        </div>
        <div class="input-item">
          <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
          <input type="text" id="altyapiAciklama" class="disabled-input" disabled list="h_altyapiAciklama" onfocus="showList(this)" oninput="guncelleOnizleme()">
        </div>
      </div>
    </form>
    <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME</div>
    <div class="preview-box" id="livePreview">Veri bekleniyor...</div>
    <button id="saveBtn" class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET</button>
    <button class="btn-back" onclick="anaMenuyeDon()">MENÃœYE DÃ–N</button>
  </div>
</div>
<div id="datalists">
    <datalist id="h_v1"></datalist><datalist id="h_v2"></datalist><datalist id="h_v3"></datalist>
    <datalist id="h_v4"></datalist><datalist id="h_v5"></datalist><datalist id="h_v6"></datalist>
    <datalist id="h_v7"></datalist><datalist id="h_v8"></datalist><datalist id="h_v9"></datalist>
    <datalist id="h_v10"></datalist><datalist id="h_v11"></datalist><datalist id="h_v12"></datalist>
    <datalist id="h_v13"></datalist><datalist id="h_v14"></datalist><datalist id="h_v15"></datalist>
    <datalist id="h_v16"></datalist><datalist id="h_ulasimTarifi"></datalist>
    <datalist id="h_ulasimOlanaklari"></datalist><datalist id="h_altyapiAciklama"></datalist>
</div>
<script>
  const auth = window.auth || firebase.auth();
  const qs = new URLSearchParams(location.search);
  let rid = (qs.get("rid") || "").toString().trim();
  function readReports(){
    try{ return JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }
    catch(e){ return []; }
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && String(r.rid) === String(rid));
  }
  function getReportByRid(){
    const reports = readReports();
    const idx = findIndexByRid(reports, rid);
    return { reports, idx, report: (idx >= 0 ? reports[idx] : null) };
  }
  function showList(el){
    const listId = el.getAttribute("list");
    if(!listId) return;
    const dl = document.getElementById(listId);
    if(!dl) return;
    dl.innerHTML = "";
    const reports = readReports();
    const key = el.id;
    const set = new Set();
    reports.forEach(r => {
      const val = (r.konumCevre && r.konumCevre[key]) ? String(r.konumCevre[key]).trim() : "";
      if(val) set.add(val);
    });
    set.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      dl.appendChild(opt);
    });
  }
  function setInput(id, value){
    const el = document.getElementById(id);
    if (!el) return;
    if (value !== undefined && value !== null) el.value = String(value);
  }
  function guncelleOnizleme(){
    const v = (id) => (document.getElementById(id)?.value ?? "").trim() || "...";
    let txt = `TaÅŸÄ±nmaz ${v('v4')} ili ${v('v5')} ilÃ§esi ${v('v6')} mahallesinde ${v('v7')} Caddesi/SokaÄŸÄ± Ã¼zerinde ${v('v8')} dÄ±ÅŸ kapÄ± numaralÄ± binanÄ±n ${v('v9')} katÄ±nda ${v('v10')} numaralÄ± baÄŸÄ±msÄ±z bÃ¶lÃ¼mde yer almaktadÄ±r.\n\n`;
    txt += `UlaÅŸÄ±m: ${v('ulasimTarifi')}.\n\n`;
    txt += `UlaÅŸÄ±m olanaklarÄ±: ${v('ulasimOlanaklari')}.\n\n`;
    const altyapi = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";
    if (altyapi === "Evet") {
      txt += `TaÅŸÄ±nmazÄ±n bulunduÄŸu bÃ¶lgede altyapÄ± tamamdÄ±r.\n`;
    } else {
      txt += `AltyapÄ± durumu: ${v('altyapiAciklama')}.\n`;
    }
    txt += `\nBÃ¶lge geliÅŸimi: ${v('v11')}, yapÄ±laÅŸma yoÄŸunluÄŸu: ${v('v12')}, yapÄ± tipleri: ${v('v13')}, gelir dÃ¼zeyi: ${v('v14')}.\n`;
    txt += `YakÄ±n Ã§evrede: ${v('v15')}, ${v('v16')}.`;
    document.getElementById("livePreview").textContent = txt;
  }
  function toggleAltyapi(isEvet){
    const inp = document.getElementById("altyapiAciklama");
    if (isEvet) {
      inp.disabled = true;
      inp.classList.add("disabled-input");
      inp.value = "AltyapÄ±sÄ± tamdÄ±r.";
    } else {
      inp.disabled = false;
      inp.classList.remove("disabled-input");
      if (inp.value === "AltyapÄ±sÄ± tamdÄ±r.") inp.value = "";
    }
    guncelleOnizleme();
  }
  function checkLockStatus(report){
    const locked = report && (report.isLocked === true || report.locked === true || report.final === true);
    if (!locked) return false;
    document.getElementById("lockedNote").style.display = "block";
    const saveBtn = document.getElementById("saveBtn");
    saveBtn.disabled = true;
    saveBtn.textContent = "RAPOR KÄ°LÄ°TLÄ° (DÃœZENLENEMEZ)";
    document.querySelectorAll("input, textarea").forEach(el => el.disabled = true);
    return true;
  }
  function verileriYukle(){
    const { idx, report } = getReportByRid();
    if (!rid || idx < 0 || !report){
      alert("Rapor ID (rid) bulunamadÄ±!");
      location.href = "index.html";
      return;
    }
    const kc = report.konumCevre || {};
    document.getElementById("raporBilgi").textContent = `Emlak: ${report.propertyName || "TanÄ±msÄ±z"} | RID: ${rid}`;
    for (let i = 1; i <= 16; i++){
      const key = "v" + i;
      setInput(key, kc[key]);
    }
    setInput("ulasimTarifi", kc.ulasimTarifi || "");
    setInput("ulasimOlanaklari", kc.ulasimOlanaklari || "");
    setInput("altyapiAciklama", kc.altyapiAciklama || "AltyapÄ±sÄ± tamdÄ±r.");
    const alty = (kc.altyapi || "Evet");
    if (String(alty).toLowerCase() === "hayÄ±r" || String(alty).toLowerCase() === "hayir"){
      document.querySelector('input[name="altyapi"][value="HayÄ±r"]').checked = true;
      toggleAltyapi(false);
    } else {
      document.querySelector('input[name="altyapi"][value="Evet"]').checked = true;
      toggleAltyapi(true);
    }
    if (!document.getElementById("v4").value) setInput("v4", report.il || "");
    if (!document.getElementById("v5").value) setInput("v5", report.ilce || "");
    if (!document.getElementById("v6").value) setInput("v6", report.mahalle || "");
    guncelleOnizleme();
    checkLockStatus(report);
  }
  function verileriKaydet(){
    const { reports, idx, report } = getReportByRid();
    if (idx < 0 || !report) return;
    const locked = report && (report.isLocked === true || report.locked === true || report.final === true);
    if (locked){ alert("Rapor kilitli. DÃ¼zenleme yapÄ±lamaz."); return; }
    const konumObj = {
      updatedAt: Date.now(),
      ulasimTarifi: document.getElementById("ulasimTarifi").value,
      ulasimOlanaklari: document.getElementById("ulasimOlanaklari").value,
      altyapi: document.querySelector('input[name="altyapi"]:checked').value,
      altyapiAciklama: document.getElementById("altyapiAciklama").value,
      tamMetin: document.getElementById("livePreview").textContent
    };
    for (let i = 1; i <= 16; i++) konumObj["v"+i] = document.getElementById("v"+i).value;
    reports[idx].konumCevre = konumObj;
    reports[idx].il = document.getElementById("v4").value || reports[idx].il || "";
    reports[idx].ilce = document.getElementById("v5").value || reports[idx].ilce || "";
    reports[idx].mahalle = document.getElementById("v6").value || reports[idx].mahalle || "";
    localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));
    alert("BaÅŸarÄ±yla kaydedildi!");
    verileriYukle();
  }
  function anaMenuyeDon(){
    if (!rid) location.href = "index.html";
    else location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
  }
  window.verileriKaydet = verileriKaydet;
  window.anaMenuyeDon = anaMenuyeDon;
  window.showList = showList;
  document.querySelectorAll('input, textarea').forEach(el => el.addEventListener('input', guncelleOnizleme));
  document.querySelectorAll('input[name="altyapi"]').forEach(r=>{
    r.addEventListener("change", ()=>{
      const v = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";
      toggleAltyapi(v !== "HayÄ±r");
    });
  });
  auth.onAuthStateChanged((user)=>{
    if (!user){ location.href="index.html"; return; }
    verileriYukle();
  });
</script>
</body>
</html>

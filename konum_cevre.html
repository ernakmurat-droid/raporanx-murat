<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Konum ve Ã‡evre Ã–zellikleri - Raporan X</title>
  <style>
    :root { --primary: #1a237e; --secondary: #3f51b5; --success: #00c853; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding-bottom:50px; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; text-decoration:none; border: none; cursor: pointer; }
    .main-wrapper { display: flex; flex-direction: column; max-width: 1000px; margin: 15px auto; gap: 15px; padding: 0 15px; }
    .form-container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .section-title { grid-column: span 2; border-left: 5px solid var(--primary); margin-top: 20px; padding-left: 10px; color: var(--primary); font-weight: bold; background: #f0f2ff; padding: 8px; border-radius: 0 8px 8px 0; }
    .input-item { display: flex; flex-direction: column; }
    .input-item label { font-weight: 600; font-size: 13px; color: #444; margin-bottom: 5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background: #fff; transition: 0.3s; width: 100%; box-sizing: border-box; }
    .radio-group { display: flex; gap: 20px; padding: 10px 0; }

    .preview-box {
      background: #1f1f1f; color: #00ff5a; padding: 20px; border-radius: 15px;
      font-family: 'Courier New', monospace; white-space: pre-wrap; font-size: 13px;
      margin-top: 20px; border: 2px solid #555;
      user-select: none; transition: filter 0.3s ease;
    }
    .preview-box:not(:hover) { filter: blur(1.5px); }

    .btn-save { background: var(--success); color: white; padding: 20px; border: none; border-radius: 15px; width: 100%; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 30px; }
  </style>
</head>
<body oncontextmenu="return false;">

<div class="header">
  <button id="btnBack" class="back">â† MenÃ¼ye DÃ¶n</button>
  <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
  <div id="raporBilgi" style="font-size: 12px; opacity: 0.8;">YÃ¼kleniyor...</div>
</div>

<div class="main-wrapper">
  <div class="form-container">
    <form id="mainForm" onsubmit="return false;">
      <div class="grid-form">
        <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ°</div>

        <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1"></div>
        <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4"></div>
        <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5"></div>
        <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6"></div>
        <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7"></div>

        <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12"></div>
        <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13"></div>
        <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14"></div>

        <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15"></div>
        <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16"></div>

        <div class="section-title">ğŸ“ METÄ°N DEÄÄ°ÅKENLERÄ°</div>

        <div class="input-item" style="grid-column: span 2;">
          <label>UlaÅŸÄ±m Tarifi</label>
          <textarea id="ulasimTarifi" rows="3" placeholder="Ã–rn: Ä°lÃ§e merkezinden ... gÃ¼zergÃ¢hÄ± ile ..."></textarea>
        </div>

        <div class="input-item" style="grid-column: span 2;">
          <label>UlaÅŸÄ±m OlanaklarÄ±</label>
          <input type="text" id="ulasimOlanaklari" placeholder="Ã–rn: otobÃ¼s, minibÃ¼s, metro, ana arter...">
        </div>

        <div class="input-item">
          <label>AltyapÄ± Durumu</label>
          <div class="radio-group">
            <label><input type="radio" name="altyapi" value="Evet" checked> Evet</label>
            <label><input type="radio" name="altyapi" value="HayÄ±r"> HayÄ±r</label>
          </div>
        </div>

        <div class="input-item">
          <label>AltyapÄ± AÃ§Ä±klamasÄ± (HayÄ±r ise)</label>
          <input type="text" id="altyapiAciklama" placeholder="Ã–rn: yol/kanalizasyon/aydÄ±nlatma eksik...">
        </div>
      </div>
    </form>

    <div class="preview-box" id="livePreview">Veri bekleniyor...</div>
    <button class="btn-save" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET VE BULUTA MÃœHÃœRLE</button>
  </div>
</div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + legacy id desteÄŸi ========= */
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }
  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  // legacy id -> rid yÃ¶nlendirme
  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "konum-cevre.html");
      window.location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  /* ========= Inputs ========= */
  const inputIds = ['v1','v4','v5','v6','v7','v12','v13','v14','v15','v16','ulasimTarifi','ulasimOlanaklari','altyapiAciklama'];

  function V(id){ return (document.getElementById(id)?.value || "").trim(); }
  function val(x){ return (x && x.trim()) ? x.trim() : "..."; }

  /* ========= Uzun Metin Motoru ========= */
  function guncelleOnizleme() {
    const { r } = getLatestData();
    const ada = r?.ada ? String(r.ada) : "...";
    const parsel = r?.parsel ? String(r.parsel) : "...";
    const raporAdi = r?.propertyName ? String(r.propertyName) : "Rapor";

    // input oku
    const IL = val(V('v4'));
    const ILCE = val(V('v5'));
    const MAH = val(V('v6'));
    const CAD = val(V('v7'));
    const YAPILASMA = val(V('v12'));
    const YAPITIP = val(V('v13'));
    const GELIR = val(V('v14'));
    const YAKIN1 = val(V('v15'));
    const YAKIN2 = val(V('v16'));
    const UAVT = val(V('v1'));
    const ULASIM_TARIF = val(V('ulasimTarifi'));
    const ULASIM_OLANAK = val(V('ulasimOlanaklari'));

    const altyapiTik = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";
    const altyapiAciklama = (V('altyapiAciklama') || "").trim();

    const altyapiMetni = (altyapiTik === "Evet")
      ? "AltyapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r."
      : (altyapiAciklama ? altyapiAciklama : "AltyapÄ± ile ilgili eksiklikler bulunmaktadÄ±r.");

    const tablo = [
      ["Rapor", raporAdi],
      ["Ada/Parsel", `${ada}/${parsel}`],
      ["UAVT", UAVT],
      ["Ä°li", IL],
      ["Ä°lÃ§esi", ILCE],
      ["Mahallesi", MAH],
      ["Cadde/Sokak", CAD],
      ["BÃ¶lge YapÄ±laÅŸmasÄ±", YAPILASMA],
      ["YapÄ± Tipleri", YAPITIP],
      ["Gelir DÃ¼zeyi", GELIR],
      ["YakÄ±n YapÄ± 1", YAKIN1],
      ["YakÄ±n YapÄ± 2", YAKIN2],
      ["UlaÅŸÄ±m OlanaklarÄ±", ULASIM_OLANAK],
      ["AltyapÄ±", altyapiTik === "Evet" ? "Evet" : "HayÄ±r"]
    ];

    const tabloMetni = [
      "Ã‡EVRESEL Ã–ZELLÄ°KLER TABLOSU",
      "----------------------------------------------",
      ...tablo.map(([k, vv]) => `${String(k).padEnd(18," ")} : ${vv}`),
      "----------------------------------------------"
    ].join("\n");

    const format1 =
`KONUMU VE Ã‡EVRESEL Ã–ZELLÄ°KLERÄ° (FORMAT 1)
TaÅŸÄ±nmaz; ${IL} ili, ${ILCE} ilÃ§esi, ${MAH} mahallesi, ${CAD} posta adresinde yer almaktadÄ±r (Ada/Parsel: ${ada}/${parsel}).
BÃ¶lge, genel olarak ${GELIR} gelir grubunun talep gÃ¶sterdiÄŸi, ${YAPILASMA} yapÄ±laÅŸma karakterine sahip bir yerleÅŸim alanÄ±dÄ±r.
YakÄ±n Ã§evresinde ${YAKIN1} ve ${YAKIN2} bulunmaktadÄ±r. ${altyapiMetni}`;

    const format2 =
`BÃ–LGENÄ°N GELÄ°ÅÄ°MÄ° VE YAKIN Ã‡EVRE (FORMAT 2)
DeÄŸerlemeye konu taÅŸÄ±nmazÄ±n bulunduÄŸu Ã§evrede ${YAPITIP} nitelikli yapÄ±lar yoÄŸunluktadÄ±r.
BÃ¶lgede sosyal donatÄ± ve ticari birimler yer yer bulunmaktadÄ±r. BÃ¶lge ${GELIR} gelir dÃ¼zeyine hitap etmektedir.
YakÄ±n Ã§evrede Ã¶ne Ã§Ä±kan unsurlar ${YAKIN1} ile ${YAKIN2} olarak gÃ¶zlemlenmiÅŸtir.`;

    const format3 =
`ULAÅIM TARÄ°FÄ° (FORMAT 3)
TaÅŸÄ±nmaza ulaÅŸÄ±m; ${ULASIM_TARIF}.
BÃ¶lgede ulaÅŸÄ±m olanaklarÄ± ${ULASIM_OLANAK} ÅŸeklindedir.
TaÅŸÄ±nmazÄ±n bulunduÄŸu bÃ¶lgeye ulaÅŸÄ±m genel olarak kolaydÄ±r ve ana arterlere baÄŸlantÄ± imkÃ¢nÄ± bulunmaktadÄ±r.`;

    const fullText = [tabloMetni, "", format1, "", format2, "", format3].join("\n\n");

    document.getElementById('livePreview').textContent = fullText;
    return fullText;
  }

  /* ========= YÃ¼kle ========= */
  function yukleVeBaslat() {
    const { r } = getLatestData();
    if (!r) return;

    document.getElementById('raporBilgi').textContent = (r.propertyName || "Rapor") + " â€¢ " + (r.il || "") + " / " + (r.ilce || "");

    // rapordan otomatik doldur (sende eksik gÃ¶rÃ¼nÃ¼yordu ya, burada dolduruyoruz)
    if (!V('v4') && r.il) document.getElementById('v4').value = r.il;
    if (!V('v5') && r.ilce) document.getElementById('v5').value = r.ilce;

    // kayÄ±tlÄ± veri varsa yÃ¼kle
    if (r.konumCevre) {
      inputIds.forEach(fid => {
        if (r.konumCevre[fid]) document.getElementById(fid).value = r.konumCevre[fid];
      });
      if (r.konumCevre.altyapiTik) {
        const rr = document.querySelector(`input[name="altyapi"][value="${r.konumCevre.altyapiTik}"]`);
        if (rr) rr.checked = true;
      }
    }

    guncelleOnizleme();
  }

  /* ========= Kaydet ========= */
  async function verileriKaydet() {
    const { arr, i, r } = getLatestData();
    if (!r || i < 0) return;

    const paket = guncelleOnizleme();

    let v = {};
    inputIds.forEach(fid => { v[fid] = document.getElementById(fid).value; });
    v.altyapiTik = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";

    r.konumCevre = { ...v, tamMetin: paket };   // <-- Rapor oluÅŸtur buradan Ã§ekecek!
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));

    const user = auth.currentUser;
    if (user) {
      try {
        await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: arr }, { merge: true });
        alert("âœ… Konum/Ã‡evre verileri kaydedildi ve buluta mÃ¼hÃ¼rlendi!");
      } catch (e) {
        alert("âš ï¸ Bulut hatasÄ±: " + e.message);
      }
    } else {
      alert("âœ… Yerel kayÄ±t yapÄ±ldÄ± (oturum yok).");
    }
  }

  /* ========= Back ========= */
  document.getElementById("btnBack").addEventListener("click", () => {
    const file = "rapor-detay.html";
    if (rid) window.location.href = file + "?rid=" + encodeURIComponent(rid);
    else window.location.href = file;
  });

  /* ========= Live update ========= */
  inputIds.forEach(fid => {
    const el = document.getElementById(fid);
    if (el) el.addEventListener('input', guncelleOnizleme);
  });
  document.querySelectorAll('input[name="altyapi"]').forEach(el => el.addEventListener('change', guncelleOnizleme));

  /* ========= Auth + start ========= */
  auth.onAuthStateChanged((user) => {
    const { r } = getLatestData();
    if (!user || !rid || !r) { window.location.href = 'index.html'; return; }
    yukleVeBaslat();
  });

  // global
  window.verileriKaydet = verileriKaydet;
</script>
</body>
</html>

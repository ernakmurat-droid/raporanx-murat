<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Konum ve Ã‡evre Ã–zellikleri - Raporan X</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root { --primary: #1a237e; --secondary: #3f51b5; --success: #00c853; --bg: #f4f7f6; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin:0; padding-bottom:50px; }
    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color:white; padding:15px; text-align:center; position:sticky; top:0; z-index:1000; }
    .back { position:absolute; left:10px; top:12px; background:#d32f2f; padding:8px 12px; border-radius:12px; color:white; border:none; cursor:pointer; font-weight:bold; }
    .main-wrapper { display:flex; flex-direction:column; max-width:1000px; margin:15px auto; gap:15px; padding:0 15px; }
    .form-container { background:white; padding:25px; border-radius:20px; box-shadow:0 4px 15px rgba(0,0,0,0.05); }
    .grid-form { display:grid; grid-template-columns: 1fr 1fr; gap:15px; }
    .section-title { grid-column: span 2; border-left:5px solid var(--primary); margin-top:20px; padding-left:10px; color:var(--primary); font-weight:bold; background:#f0f2ff; padding:8px; border-radius:0 8px 8px 0; }
    .input-item { display:flex; flex-direction:column; }
    .input-item label { font-weight:600; font-size:13px; color:#444; margin-bottom:5px; }
    input, textarea { padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px; background:#fff; width:100%; box-sizing:border-box; }
    .radio-group { display:flex; gap:20px; padding:10px 0; }
    .radio-item { display:flex; align-items:center; gap:8px; cursor:pointer; }
    .full-width { grid-column: span 2; }
    .btn-save { background:var(--success); color:white; padding:20px; border:none; border-radius:15px; width:100%; font-weight:bold; font-size:18px; cursor:pointer; margin-top:30px; box-shadow:0 4px 15px rgba(0,200,83,0.3); }
    .btn-save:disabled { opacity:0.6; cursor:not-allowed; }
    .btn-back { background:#6c757d; color:white; padding:20px; border:none; border-radius:15px; width:100%; font-weight:bold; font-size:18px; cursor:pointer; margin-top:10px; }
    .preview-box { background:#333; color:#00ff00; padding:20px; border-radius:15px; font-family:'Courier New', monospace; white-space:pre-wrap; font-size:13px; margin-top:20px; border:2px solid #555; user-select:none; transition: filter 0.3s ease; }
    .preview-box:not(:hover) { filter: blur(1.5px); }
    .locked-banner{ display:none; margin-top:10px; background:#ffe082; color:#333; padding:10px; border-radius:12px; font-weight:bold; }
    .disabled-input { background:#eee; cursor:not-allowed; }
    .mini-note { font-size:12px; opacity:0.9; margin-top:6px; }
  </style>
</head>

<body oncontextmenu="return false;">

<div class="header">
  <!-- Ã‡Ä°FTE EMNÄ°YET: hem onclick hem de href benzeri yÃ¶nlendirme -->
  <button id="btnBack" class="back" type="button" onclick="anaMenuyeDon()">â† MenÃ¼ye DÃ¶n</button>
  <h1>KONUM VE Ã‡EVRESEL Ã–ZELLÄ°KLER</h1>
  <div id="raporBilgi" style="font-size:14px; opacity:0.9; margin-top:5px; font-weight:bold;">YÃ¼kleniyor...</div>
  <div id="lockedBanner" class="locked-banner">ğŸ”’ Bu rapor mÃ¼hÃ¼rlÃ¼. DeÄŸiÅŸiklik yapamazsÄ±n.</div>
  <div id="debug" class="mini-note"></div>
</div>

<div class="main-wrapper">
  <div class="form-container">
    <form id="mainForm" onsubmit="return false;">
      <div class="grid-form">
        <div class="section-title">ğŸ“Š TABLO VERÄ°LERÄ° (1-16)</div>
        <div class="input-item"><label>(1) UAVT</label><input type="text" id="v1"></div>
        <div class="input-item"><label>(2) Koordinat X</label><input type="text" id="v2"></div>
        <div class="input-item"><label>(3) Koordinat Y</label><input type="text" id="v3"></div>
        <div class="input-item"><label>(4) Ä°li</label><input type="text" id="v4"></div>
        <div class="input-item"><label>(5) Ä°lÃ§esi</label><input type="text" id="v5"></div>
        <div class="input-item"><label>(6) Mahallesi</label><input type="text" id="v6"></div>
        <div class="input-item"><label>(7) Cadde/Sokak</label><input type="text" id="v7"></div>
        <div class="input-item"><label>(8) DÄ±ÅŸ KapÄ± No</label><input type="text" id="v8"></div>
        <div class="input-item"><label>(9) BulunduÄŸu Kat</label><input type="text" id="v9"></div>
        <div class="input-item"><label>(10) Daire No</label><input type="text" id="v10"></div>
        <div class="input-item"><label>(11) BÃ¶lge GeliÅŸimi</label><input type="text" id="v11"></div>
        <div class="input-item"><label>(12) BÃ¶lge YapÄ±laÅŸmasÄ±</label><input type="text" id="v12"></div>
        <div class="input-item"><label>(13) YapÄ± Tipleri</label><input type="text" id="v13"></div>
        <div class="input-item"><label>(14) Gelir DÃ¼zeyi</label><input type="text" id="v14"></div>
        <div class="input-item"><label>(15) YakÄ±n YapÄ± 1</label><input type="text" id="v15"></div>
        <div class="input-item"><label>(16) YakÄ±n YapÄ± 2</label><input type="text" id="v16"></div>

        <div class="section-title">ğŸ“ KUTSAL METÄ°N DEÄÄ°ÅKENLERÄ°</div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m Tarifi</label><textarea id="ulasimTarifi" rows="3"></textarea></div>
        <div class="input-item full-width"><label>UlaÅŸÄ±m OlanaklarÄ±</label><input type="text" id="ulasimOlanaklari"></div>

        <div class="input-item">
          <label>AltyapÄ± Durumu</label>
          <div class="radio-group">
            <label class="radio-item"><input type="radio" name="altyapi" value="Evet" checked> Evet</label>
            <label class="radio-item"><input type="radio" name="altyapi" value="HayÄ±r"> HayÄ±r</label>
          </div>
        </div>
        <div class="input-item">
          <label>AltyapÄ± AÃ§Ä±klamasÄ±</label>
          <input type="text" id="altyapiAciklama" class="disabled-input" disabled>
        </div>
      </div>
    </form>

    <div class="section-title">ğŸ‘€ CANLI Ã–NÄ°ZLEME</div>
    <div class="preview-box" id="livePreview" oncopy="return false">Veri bekleniyor</div>

    <button id="saveBtn" class="btn-save" type="button" onclick="verileriKaydet()">VERÄ°LERÄ° KAYDET VE BULUTA MÃœHÃœRLE</button>
    <button class="btn-back" type="button" onclick="anaMenuyeDon()">MENÃœYE DÃ–N</button>
  </div>
</div>

<script>
  // âœ… firebase-config.js Ã§alÄ±ÅŸmasa bile ayaÄŸa kalk
  const firebaseConfig = {
    apiKey: "AIzaSyCMwx6S6rq1lnNJuHOxc38ij3qU4ankSxs",
    authDomain: "raporanx.firebaseapp.com",
    projectId: "raporanx",
    storageBucket: "raporanx.firebasestorage.app",
    messagingSenderId: "715194328346",
    appId: "1:715194328346:web:46f0bb98941e01ead6f8a3"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

  const db = firebase.firestore();
  const auth = firebase.auth();

  const urlParams = new URLSearchParams(window.location.search);
  const reportId = urlParams.get("id"); // âœ… docId
  const debugEl = document.getElementById("debug");

  // âœ… Geri dÃ¶nme garantisi (JS hata verirse diye addEventListener ile de baÄŸla)
  function anaMenuyeDon(){
    if(!reportId){
      alert("Rapor ID yok! Ana sayfaya yÃ¶nlendiriyorum.");
      location.href = "index.html";
      return;
    }
    location.href = `rapor-detay.html?id=${encodeURIComponent(reportId)}`;
  }
  document.getElementById("btnBack").addEventListener("click", anaMenuyeDon);

  const inputIds = ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11','v12','v13','v14','v15','v16','ulasimTarifi','ulasimOlanaklari','altyapiAciklama'];

  let currentUser = null;
  let reportRef = null;
  let reportData = null;

  // radio -> altyapÄ± aÃ§Ä±klama aÃ§/kapat
  function toggleAltyapiUI(){
    const isEvet = document.querySelector('input[name="altyapi"]:checked')?.value === "Evet";
    const input = document.getElementById('altyapiAciklama');
    input.disabled = isEvet;
    input.classList.toggle('disabled-input', isEvet);
    if(isEvet) input.value = "";
  }
  document.querySelectorAll('input[name="altyapi"]').forEach(r => r.addEventListener("change", () => {
    toggleAltyapiUI();
    guncelleOnizleme();
  }));

  function setLockedUI(isLocked){
    const banner = document.getElementById('lockedBanner');
    const saveBtn = document.getElementById('saveBtn');

    if(isLocked){
      banner.style.display = 'block';
      saveBtn.disabled = true;

      inputIds.forEach(fid => {
        const el = document.getElementById(fid);
        if(el){
          el.disabled = true;
          el.classList.add('disabled-input');
        }
      });
      document.querySelectorAll('input[name="altyapi"]').forEach(r => r.disabled = true);
    } else {
      banner.style.display = 'none';
      saveBtn.disabled = false;
    }
  }

  function guncelleOnizleme() {
    let v = {};
    inputIds.forEach(fid => { v[fid] = document.getElementById(fid).value || "..."; });

    const altyapiTik = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";
    const altyapiMetni = altyapiTik === "Evet" ? "alt yapÄ±sÄ± tamamlanmÄ±ÅŸtÄ±r" : (v.altyapiAciklama || "...");

    let tablo = "--- Ã‡EVRESEL Ã–ZELLÄ°KLER TABLOSU ---\n";
    const labels = ["UAVT","Koord X","Koord Y","Ä°li","Ä°lÃ§esi","Mahallesi","Cadde","No","Kat","Daire","GeliÅŸim","YapÄ±laÅŸma","Tip","Gelir","YakÄ±n 1","YakÄ±n 2"];
    for(let i=1; i<=16; i++) tablo += `${labels[i-1].padEnd(15, ' ')} : ${v['v'+i]}\n`;

    const f1 = `DeÄŸerlemeye konu taÅŸÄ±nmaz, ${v.v4} ili, ${v.v5} Ä°lÃ§esi, ${v.v6} Mahallesi ${v.v7}, No: ${v.v8}/${v.v10} posta adresinde yer almaktadÄ±r. TaÅŸÄ±nmaza ulaÅŸÄ±m; ${v.ulasimTarifi}. YakÄ±n Ã§evresinde ${v.v15} ve ${v.v16} yer almaktadÄ±r. AltyapÄ±sÄ± ${altyapiMetni}.`;

    const tamPaket = tablo + "\n" + f1;
    document.getElementById('livePreview').textContent = tamPaket;
    return tamPaket;
  }

  // input deÄŸiÅŸince Ã¶nizleme
  inputIds.forEach(fid => {
    const el = document.getElementById(fid);
    if(el) el.addEventListener('input', guncelleOnizleme);
  });

  async function loadReportFromCloud(){
    if(!currentUser) return;
    if(!reportId){ alert("Rapor ID yok!"); location.href="index.html"; return; }

    reportRef = db.collection("users").doc(currentUser.uid).collection("reports").doc(reportId);
    const snap = await reportRef.get();

    if(!snap.exists){
      alert("Rapor bulunamadÄ± (bu kullanÄ±cÄ±ya ait deÄŸil veya silinmiÅŸ).");
      location.href="index.html";
      return;
    }

    reportData = snap.data();

    // hangi rapor
    document.getElementById('raporBilgi').textContent = reportData.propertyName || "Yeni Rapor";

    // form doldur
    if(reportData.konumCevre){
      inputIds.forEach(fid => {
        const val = reportData.konumCevre[fid];
        if(val !== undefined && val !== null) document.getElementById(fid).value = val;
      });

      const tik = reportData.konumCevre.altyapiTik === "HayÄ±r" ? "HayÄ±r" : "Evet";
      document.querySelector(`input[name="altyapi"][value="${tik}"]`).checked = true;
      toggleAltyapiUI();
    } else {
      toggleAltyapiUI();
    }

    setLockedUI(!!reportData.isLocked);
    guncelleOnizleme();

    debugEl.textContent = `Rapor ID: ${reportId}`;
  }

  async function verileriKaydet(){
    if(!currentUser) return alert("GiriÅŸ yok!");
    if(!reportRef || !reportData) return alert("Rapor yÃ¼klenmedi!");
    if(reportData.isLocked) return alert("ğŸ”’ Rapor mÃ¼hÃ¼rlÃ¼. Kaydedemezsin.");

    const saveBtn = document.getElementById('saveBtn');
    saveBtn.disabled = true;

    try{
      const paket = guncelleOnizleme();

      let v = {};
      inputIds.forEach(fid => { v[fid] = document.getElementById(fid).value; });
      v.altyapiTik = document.querySelector('input[name="altyapi"]:checked')?.value || "Evet";

      const konumCevreObj = { ...v, tamMetin: paket };

      await reportRef.set({
        konumCevre: konumCevreObj,
        konum_tamamlandi: true,
        updatedAt: new Date().toISOString()
      }, { merge: true });

      reportData.konumCevre = konumCevreObj;
      reportData.konum_tamamlandi = true;

      alert("âœ… Kaydedildi!");
    } catch(e){
      console.error(e);
      alert("âŒ KayÄ±t hatasÄ±: " + (e?.message || e));
    } finally {
      if(!reportData.isLocked) saveBtn.disabled = false;
    }
  }

  auth.onAuthStateChanged(async (user) => {
    if(!user){ location.href="index.html"; return; }
    currentUser = user;
    await loadReportFromCloud();
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- ‚úÖ Wallet -->
  <script src="wallet.js"></script>

  <title>Final Raporu Olu≈üturucu - Raporan X</title>

  <style>
    :root { --primary:#1a237e; --secondary:#3949ab; --accent:#ffd600; --bg:#f4f7f9; }
    body { font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; color:#2c3e50; scroll-behavior:smooth; }

    .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:30px 20px; text-align:center; position:relative; z-index:10; }
    .back { position:absolute; left:20px; top:25px; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:30px; color:#fff; text-decoration:none; font-weight:bold; cursor:pointer; border:none; font-size:13px; }

    .main-wrapper { max-width:1300px; margin:20px auto; display:grid; grid-template-columns:280px 1fr; gap:30px; padding:0 20px; }

    .toc-container { position:sticky; top:20px; height:fit-content; }
    .toc { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); border-left:6px solid var(--primary); }
    .toc-title { font-size:1.1em; font-weight:bold; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .toc-list { list-style:none; padding:0; margin:0; }
    .toc-list li { margin-bottom:8px; }
    .toc-list a { color:#555; text-decoration:none; font-size:.9em; font-weight:500; transition:.2s; display:block; padding:5px; border-radius:4px; }
    .toc-list a:hover { background:#f0f2ff; color:var(--primary); padding-left:10px; }

    .container { background:#fff; padding:40px; border-radius:12px; box-shadow:0 0 40px rgba(0,0,0,0.05); }
    .section { margin-bottom:50px; padding-bottom:20px; border-bottom:1px solid #f0f0f0; page-break-inside:avoid; }
    .section-title { font-size:1.4em; font-weight:bold; color:var(--primary); margin-bottom:20px; display:flex; align-items:center; }
    .section-title::after { content:""; flex:1; height:1px; background:#eee; margin-left:15px; }

    .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; margin-bottom:25px; }
    .info-item { background:#fcfcfc; border:1px solid #f0f0f0; padding:12px; border-radius:6px; }
    .info-item strong { display:block; color:#888; font-size:.75em; text-transform:uppercase; margin-bottom:3px; }
    .info-item span { font-weight:600; font-size:.95em; color:#2c3e50; }

    #imarTablo table { width:100% !important; border-collapse:collapse; margin:15px 0; font-size:12px !important; }
    #imarTablo table th, #imarTablo table td { border:1px solid #dcdde1; padding:6px 10px !important; line-height:1.2; }
    #imarTablo table th { background:#f8f9fa; color:#444; width:30%; }

    .text-block { font-size:14.5px; line-height:1.7; white-space:pre-wrap; color:#34495e; text-align:justify; }
    .format-badge { background:#546e7a; color:#fff; padding:3px 10px; border-radius:4px; font-size:11px; margin-bottom:10px; display:inline-block; }

    .print-btn { background:#27ae60; color:#fff; padding:15px 30px; font-size:18px; border:none; border-radius:50px; cursor:pointer; margin:40px auto; display:block; font-weight:bold; box-shadow:0 6px 15px rgba(39,174,96,.3); transition:.3s; }
    .print-btn:hover { background:#219150; transform:translateY(-2px); }

    .topbar2{
      max-width:1300px;
      margin:12px auto 0;
      padding:0 20px;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    #walletBar{
      flex:1 1 420px;
      background:rgba(255,255,255,0.16);
      color:#fff;
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
    }
    #lockBadge{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      font-weight:900;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
    }

    @media print {
      body { background:#fff; }
      .header, .back, .print-btn, .toc-container, .topbar2 { display:none !important; }
      .main-wrapper { display:block; max-width:100%; margin:0; padding:0; }
      .container { box-shadow:none; padding:0; margin:0; width:100%; }
      .section-title { color:#000; border-bottom:2px solid #000; }
      #imarTablo table { font-size:10px !important; }
    }

    @media (max-width: 992px) {
      .main-wrapper { grid-template-columns:1fr; }
      .toc-container { position:relative; top:0; margin-bottom:20px; }
    }
  </style>
</head>

<body>
  <div class="header">
    <button id="btnBack" class="back">‚Üê Y√∂netim Paneli</button>
    <h1 style="margin:0; font-size:1.8em; letter-spacing:1px;">GAYRƒ∞MENKUL DEƒûERLEME RAPORU</h1>
    <div id="raporTarih" style="margin-top:8px; opacity:.8; font-size:13px;"></div>
  </div>

  <div class="topbar2">
    <div id="walletBar">C√ºzdan y√ºkleniyor...</div>
    <div id="lockBadge">üîí Banka Taslaƒüƒ±</div>
  </div>

  <div class="main-wrapper">
    <aside class="toc-container">
      <div class="toc">
        <div class="toc-title">RAPOR B√ñL√úMLERƒ∞</div>
        <ul class="toc-list">
          <li><a href="#genel">1. Genel Bilgiler</a></li>
          <li><a href="#imar">2. ƒ∞mar Durumu</a></li>
          <li><a href="#belgeler">3. ƒ∞ncelenen Belgeler</a></li>
          <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
          <li><a href="#bb">5. Baƒüƒ±msƒ±z B√∂l√ºm</a></li>
          <li><a href="#konum">6. Konum Analizi</a></li>
          <li><a href="#tapu">7. Tapu Kayƒ±tlarƒ±</a></li>
          <li><a href="#emsal">8. Deƒüerleme Sonucu</a></li>
        </ul>
      </div>
    </aside>

    <main class="container">
      <div class="section" id="genel">
        <div class="section-title">1. Gayrimenkul Genel Bilgileri</div>
        <div class="info-grid" id="genelBilgi"></div>
      </div>

      <div class="section" id="imar">
        <div class="section-title">2. ƒ∞mar Durumu Verileri</div>
        <div id="imarTablo"></div>
        <div class="text-block" id="imarMetin"></div>
      </div>

      <div class="section" id="belgeler">
        <div class="section-title">3. ƒ∞ncelenen Belgeler</div>
        <div class="text-block" id="belgelerMetin"></div>
      </div>

      <div class="section" id="bina">
        <div class="section-title">4. Ana Gayrimenkul Bilgileri</div>
        <div class="text-block" id="binaMetin"></div>
      </div>

      <div class="section" id="bb">
        <div class="section-title">5. Baƒüƒ±msƒ±z B√∂l√ºm Analizi</div>
        <div class="text-block" id="bbMetin"></div>
      </div>

      <div class="section" id="konum">
        <div class="section-title">6. Konum ve √áevre Analizi</div>
        <div class="text-block" id="konumMetin"></div>
      </div>

      <div class="section" id="tapu">
        <div class="section-title">7. Tapu ve Takyidat Kayƒ±tlarƒ±</div>
        <div class="format-badge">BANKA FORMATI B1</div>
        <div class="text-block" id="tapuMetinB1" style="margin-bottom:25px;"></div>
        <div class="format-badge">BANKA FORMATI B2</div>
        <div class="text-block" id="tapuMetinB2"></div>
      </div>

      <div class="section" id="emsal">
        <div class="section-title">8. Deƒüerleme ve Sonu√ß Analizi</div>
        <div class="text-block" id="emsalMetin"></div>
      </div>

      <button class="print-btn" onclick="window.print()">üìë RAPORU YAZDIR / PDF OLARAK KAYDET</button>
    </main>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  // demo fiyat (wallet.js i√ßinde sen dinamik yapacaksƒ±n)
  const REPORT_PRICE_TL = 1;

  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  const legacyId = urlParams.get('id');

  // ‚úÖ Onay parametresi: sadece rapor-detay √ºzerinden ‚Äúevet‚Äù denince gelir
  const confirmed = (urlParams.get("confirm") === "1");

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid = genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "rapor-olustur.html");
      window.location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }
  function persist(arr, i, r){
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
  }

  function trDuzelt(txt){
    let t = (txt || "").toString();
    if (!t.trim()) return "";
    t = t.replace(/\s+\n/g, "\n").replace(/\n{3,}/g, "\n\n");
    t = t.replace(/\s{2,}/g, " ");
    t = t.replace(/\s+\./g, ".").replace(/\s+,/g, ",");
    t = t.replace(/ :/g, ":").replace(/ ;/g, ";");
    return t.trim();
  }

  // ‚úÖ √áOKLU MOD: BB‚Äôlerin emsal metinlerini ALT ALTA G√ñSTERƒ∞R
  function emsalMetniBul(report){
    const direct1 = report?.emsalFinalMetni;
    if (direct1 && String(direct1).trim()) return trDuzelt(direct1);

    const direct2 = report?.degerlemeOzet?.emsalFinalMetni;
    if (direct2 && String(direct2).trim()) return trDuzelt(direct2);

    if (Array.isArray(report?.bbDetayList) && report.bbDetayList.length) {
      const blocks = [];
      report.bbDetayList.forEach((bb, i) => {
        const t = trDuzelt(bb?.degerlemeOzet?.emsalFinalMetni || "");
        if (!t) return;
        const title = bb?.baslik || bb?.bbDetay?.bbNo || bb?.bbDetay?.bagimsizNo || bb?.bbDetay?.kapiNo || `${i+1}. BB`;
        blocks.push(`${title}\n${t}`);
      });
      if (blocks.length) return blocks.join("\n\n");
    }
    return "Analiz tamamlanmadƒ±.";
  }

  function raporOlustur(report){
    const today = new Date().toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('raporTarih').textContent = `Rapor Olu≈üturma: ${today}`;

    document.getElementById('genelBilgi').innerHTML = `
      <div class="info-item"><strong>Ta≈üƒ±nmaz Adƒ±</strong><span>${report.propertyName || "..."}</span></div>
      <div class="info-item"><strong>ƒ∞l / ƒ∞l√ße</strong><span>${report.il || "-"} / ${report.ilce || "-"}</span></div>
      <div class="info-item"><strong>Ada / Parsel</strong><span>${report.ada || "..."} / ${report.parsel || "..."}</span></div>
      <div class="info-item"><strong>Arsa Alanƒ±</strong><span>${report.bina?.arsaAlani || "..."} m¬≤</span></div>
    `;

    document.getElementById('imarTablo').innerHTML = report.imarTablo || "<p>Veri yok.</p>";
    document.getElementById('imarMetin').textContent = trDuzelt(report.imarMetni || "");

    document.getElementById('belgelerMetin').textContent = trDuzelt(report.belgelerMetni || "Veri girilmedi.");
    document.getElementById('binaMetin').textContent = trDuzelt(report.bina?.metin || "Veri girilmedi.");

    let bbText = "";
    if (Array.isArray(report.bbDetayList) && report.bbDetayList.length) {
      report.bbDetayList.forEach((bb, i) => {
        const baslik = bb.baslik || `${i+1}. BB`;
        const t = bb?.bbDetay?.tamMetin || bb?.bbDetay?.metin || "";
        if (t && String(t).trim()) bbText += `${baslik}\n${trDuzelt(t)}\n\n`;
      });
    } else {
      bbText = trDuzelt(report.bbDetay?.tamMetin || report.bbDetay?.metin || "");
    }
    document.getElementById('bbMetin').textContent = bbText || "Veri girilmedi.";

    document.getElementById('konumMetin').textContent =
      trDuzelt(report.konumCevre?.tamMetin || report.konumCevre?.metin || "Veri girilmedi.");

    document.getElementById('tapuMetinB1').textContent = trDuzelt(report.tapuMetniB1 || "Veri girilmedi.");
    document.getElementById('tapuMetinB2').textContent = trDuzelt(report.tapuMetniB2 || "Veri girilmedi.");

    document.getElementById('emsalMetin').textContent = emsalMetniBul(report);
  }

  // ‚úÖ Kilitle + c√ºzdan d√º≈ü (SADECE onayla gelince)
  async function lockAndChargeIfNeeded(user, arr, i, report){
    if (!report) return;

    // zaten kilitliyse i≈ülem yok
    if (report.isLocked === true) return;

    // onay yoksa para d√º≈üme
    if (!confirmed) {
      alert("Bu sayfa banka taslaƒüƒ± √ºretir ve √ºcret/√ºcretsiz hak d√º≈ü√ºr√ºr.\nDevam etmek i√ßin rapor men√ºs√ºnden ‚ÄúTam Rapor Olu≈ütur‚Äù butonunu kullanƒ±n.");
      window.location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
      return;
    }

    // onay var ‚Üí d√º≈üebilir
    try { if (window.Wallet) await Wallet.load(user.uid); } catch(e){}

    try {
      const res = await Wallet.chargeReport(user.uid, REPORT_PRICE_TL);

      report.isLocked = true;
      report.lockedAt = new Date().toISOString();
      report.lockedBy = user.uid;

      report.billing = {
        charged: true,
        used: res.used,
        priceTL: REPORT_PRICE_TL,
        chargedAt: new Date().toISOString()
      };

      persist(arr, i, report);

      await db.collection("users").doc(user.uid).set({
        gayrimenkul_reports: arr,
        lastUpdate: new Date().toISOString()
      }, { merge: true });

    } catch (e) {
      if (String(e && e.message) === "YETERSIZ_BAKIYE") {
        alert("√úcretsiz hakkƒ±nƒ±z bitmi≈ü ve bakiye yetersiz. L√ºtfen c√ºzdana y√ºkleme yapƒ±n.");
      } else {
        alert("C√ºzdan i≈ülemi sƒ±rasƒ±nda hata oldu. Yerel rapor korunuyor.\n" + (e?.message || ""));
      }
      window.location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
    }
  }

  document.getElementById('btnBack').onclick = () => {
    if (rid) window.location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
    else if (legacyId !== null) window.location.href = "rapor-detay.html?id=" + encodeURIComponent(legacyId);
    else window.location.href = "rapor-detay.html";
  };

  // C√ºzdan barƒ±na tƒ±klayƒ±nca detay g√∂ster (a√ßƒ±k g√∂r√ºnmesin)
  document.getElementById("walletBar").onclick = () => {
    const el = document.getElementById("walletBar");
    const full = el.getAttribute("data-full");
    if (full) {
      alert(full);
    }
  };

  auth.onAuthStateChanged(async (user) => {
    const { arr, i, r } = getLatestData();

    if (!user || !rid || !r || i < 0) {
      window.location.href = "index.html";
      return;
    }

    // √∂nce onay + √ºcret/kilit
    await lockAndChargeIfNeeded(user, arr, i, r);

    // tekrar en g√ºncel halini √ßek (kilit yazƒ±ldƒ±ysa)
    const latest = getLatestData();
    const report = latest.r;

    // raporu bas
    raporOlustur(report);

    // wallet bar yaz (wallet.js varsa)
    try{
      if (window.Wallet){
        await Wallet.load(user.uid);
        const s = Wallet.getSummary ? Wallet.getSummary() : null;
        if (s){
          const shortText = `C√ºzdan: ${s.balanceTL ?? 0} TL ‚Ä¢ √úcretsiz: ${s.freeLeft ?? 0}`;
          const fullText  = `C√ºzdan Detay\n\nBakiye: ${s.balanceTL ?? 0} TL\n√úcretsiz Hak: ${s.freeLeft ?? 0}\nToplam Harcanan: ${s.totalSpentTL ?? 0} TL`;
          const w = document.getElementById("walletBar");
          w.textContent = shortText + " (Detay i√ßin tƒ±kla)";
          w.setAttribute("data-full", fullText);
        }else{
          document.getElementById("walletBar").textContent = "C√ºzdan hazƒ±r (detay yok)";
        }
      }else{
        document.getElementById("walletBar").textContent = "C√ºzdan mod√ºl√º yok (wallet.js bulunamadƒ±)";
      }
    }catch(e){
      document.getElementById("walletBar").textContent = "C√ºzdan okunamadƒ±";
    }

    // kilit badge g√ºncelle
    const badge = document.getElementById("lockBadge");
    if (report?.isLocked === true) badge.textContent = "üîí Kilitli (Banka Taslaƒüƒ±)";
    else badge.textContent = "üü° Taslak (Kilit yok)";
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Rapor OluÅŸtur (Final) - Gayrimenkul DeÄŸerleme</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="wallet.js"></script>

<style>
:root{--primary:#1a237e;--secondary:#3949ab;--bg:#f4f7f9;}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);margin:0;color:#2c3e50;}
.header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:30px 20px;text-align:center;position:relative;}
.back{position:absolute;left:20px;top:25px;background:rgba(255,255,255,.2);padding:8px 15px;border-radius:30px;color:#fff;border:none;cursor:pointer;}
.main-wrapper{max-width:1300px;margin:30px auto;display:grid;grid-template-columns:270px 1fr;gap:25px;padding:0 20px;}
.toc-container{position:sticky;top:20px;height:fit-content;}
.toc{background:#fff;padding:18px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.05);border-left:6px solid var(--primary);}
.toc-title{font-weight:bold;color:var(--primary);margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:6px;}
.toc ul{list-style:none;padding:0;margin:0;}
.toc li{margin:6px 0;}
.toc a{color:#444;text-decoration:none;font-size:.9em;display:block;padding:4px 6px;border-radius:4px;}
.toc a:hover{background:#f0f2ff;color:var(--primary);}
.container{background:#fff;padding:35px;border-radius:12px;box-shadow:0 0 25px rgba(0,0,0,.05);}
.section{margin-bottom:45px;}
.section h2{color:var(--primary);border-bottom:2px solid #eee;padding-bottom:8px;font-size:1.2em;}
.text-block{white-space:pre-wrap;font-size:15px;line-height:1.6;color:#34495e;}
.warning{background:#fff8e1;border-left:4px solid #ffc107;padding:10px;margin:8px 0;}
.print-btn{background:#27ae60;color:#fff;padding:13px 26px;border:none;border-radius:50px;margin:30px auto;display:block;cursor:pointer;font-weight:bold;}
.print-btn:hover{background:#1e874e;}
@media(max-width:992px){.main-wrapper{grid-template-columns:1fr;}.toc-container{position:relative;margin-bottom:15px;}}
@media print{.header,.toc-container,.print-btn{display:none!important;}.container{box-shadow:none;padding:0;}}

/* Ã¼stte durum ÅŸeridi */
#statusBar{
  max-width:1300px;margin:10px auto 0;padding:10px 16px;
  background:#fff;border-radius:12px;box-shadow:0 4px 14px rgba(0,0,0,.06);
  border-left:6px solid var(--secondary);
  color:#2c3e50;font-weight:700;
}
#statusBar small{display:block;font-weight:500;opacity:.9;margin-top:4px}
</style>
</head>

<body>
<div class="header">
  <button class="back" onclick="window.location.href='rapor-ana-menu.html?rid='+encodeURIComponent(getRid())">â† Geri</button>
  <h1>GAYRÄ°MENKUL DEÄERLEME RAPORU (FÄ°NAL)</h1>
  <div id="raporTarih"></div>
</div>

<div id="statusBar">â³ Final rapor hazÄ±rlanÄ±yorâ€¦ <small>Ãœcret/Ã¼cretsiz hak kontrolÃ¼ yapÄ±lÄ±yor ve rapor kilitleniyor.</small></div>

<div class="main-wrapper">
  <aside class="toc-container">
    <div class="toc">
      <div class="toc-title">ğŸ“‹ RAPOR BÃ–LÃœMLERÄ°</div>
      <ul>
        <li><a href="#genel">1. Genel Bilgiler</a></li>
        <li><a href="#imar">2. Ä°mar Durumu</a></li>
        <li><a href="#belgeler">3. Belgeler</a></li>
        <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
        <li><a href="#bb">5. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m</a></li>
        <li><a href="#konum">6. Konum Analizi</a></li>
        <li><a href="#tapu">7. Tapu Bilgileri</a></li>
        <li><a href="#emsal">8. DeÄŸerleme / Emsal</a></li>
      </ul>
    </div>
  </aside>

  <main class="container">
    <section id="genel" class="section">
      <h2>1. Genel Bilgiler</h2>
      <div id="genelBilgi"></div>
    </section>

    <section id="imar" class="section">
      <h2>2. Ä°mar Durumu</h2>
      <div id="imarTablo"></div>
      <div class="text-block" id="imarMetin"></div>
    </section>

    <section id="belgeler" class="section">
      <h2>3. Belgeler</h2>
      <div class="text-block" id="belgelerMetin"></div>
    </section>

    <section id="bina" class="section">
      <h2>4. Ana Bina Bilgileri</h2>
      <div class="text-block" id="binaMetin"></div>
    </section>

    <section id="bb" class="section">
      <h2>5. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m</h2>
      <div class="text-block" id="bbMetin"></div>
    </section>

    <section id="konum" class="section">
      <h2>6. Konum Analizi</h2>
      <div class="text-block" id="konumMetin"></div>
    </section>

    <section id="tapu" class="section">
      <h2>7. Tapu Bilgileri</h2>
      <div class="text-block" id="tapuMetinB1"></div>
      <div class="text-block" id="tapuMetinB2"></div>
    </section>

    <section id="emsal" class="section">
      <h2>8. DeÄŸerleme / Emsal</h2>
      <div class="text-block" id="emsalMetin"></div>
    </section>

    <button class="print-btn" onclick="window.print()">ğŸ“„ YazdÄ±r / PDF Kaydet</button>
  </main>
</div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  function getRid(){
    const p = new URLSearchParams(location.search);
    return (p.get("rid") || p.get("id") || "").toString().trim();
  }
  function hasConfirm(){
    const p = new URLSearchParams(location.search);
    return p.get("confirm") === "1";
  }
  function setStatus(title, detail){
    const el = document.getElementById("statusBar");
    el.textContent = title;
    const sm = document.createElement("small");
    sm.textContent = detail || "";
    el.appendChild(sm);
  }

  let finalizeRunning = false;

  // ====== WALLET ADAPTÃ–RÃœ (senin wallet.js'e 1 satÄ±r baÄŸlanacak) ======
  async function walletPrecheckAndCharge(uid, rid){
    // EÄŸer wallet modÃ¼lÃ¼ yoksa gÃ¼venli tarafta kal: rapor Ã¼retme
    if (!window.Wallet) throw new Error("CÃ¼zdan modÃ¼lÃ¼ bulunamadÄ± (wallet.js).");

    // âœ… BURAYI SENÄ°N WALLET.JS'Ä°NE GÃ–RE 1 SATIRDA BAÄLAYACAÄIZ
    // AÅŸaÄŸÄ±daki Ã§aÄŸrÄ± Ã¶rnektir:
    // - Ã¼cretli dÃ¼ÅŸÃ¼m / Ã¼cretsiz hak dÃ¼ÅŸÃ¼m / hold ne yapÄ±yorsan burada yapÄ±lmalÄ±.
    //
    // Ã–RNEK 1: return await Wallet.consumeReport(uid, rid);
    // Ã–RNEK 2: return await Wallet.useFreeOrCharge(uid, rid);
    //
    // Åimdilik: eÄŸer bÃ¶yle bir fonksiyon yoksa hata verelim ki boÅŸa kilitlemesin:
    if (typeof Wallet.consumeReport !== "function" && typeof Wallet.useFreeOrCharge !== "function") {
      throw new Error("wallet.js iÃ§inde consumeReport() veya useFreeOrCharge() fonksiyonu bulunamadÄ±.");
    }

    if (typeof Wallet.consumeReport === "function") {
      return await Wallet.consumeReport(uid, rid); // true/false dÃ¶nsÃ¼n
    }
    return await Wallet.useFreeOrCharge(uid, rid); // true/false dÃ¶nsÃ¼n
  }

  // ====== FIRESTORE KÄ°LÄ°T (atomik) ======
  async function finalizeLockReport(rid, uid){
    if (finalizeRunning) return;
    finalizeRunning = true;

    const reportRef = db.collection("reports").doc(rid);

    await db.runTransaction(async (tx) => {
      const snap = await tx.get(reportRef);

      if (!snap.exists) {
        tx.set(reportRef, {
          ownerUid: uid,
          status: "draft",
          locked: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
      } else {
        const data = snap.data() || {};
        // baÅŸka kullanÄ±cÄ±nÄ±n raporuysa (opsiyonel gÃ¼venlik)
        if (data.ownerUid && data.ownerUid !== uid) {
          throw new Error("Bu rapor baÅŸka kullanÄ±cÄ±ya ait gÃ¶rÃ¼nÃ¼yor.");
        }
        if (data.locked === true || data.status === "final") {
          // zaten kilitliyse tekrar iÅŸlem yapma
          return;
        }
      }

      tx.set(reportRef, {
        ownerUid: uid,
        status: "final",
        locked: true,
        lockedAt: firebase.firestore.FieldValue.serverTimestamp(),
        lockedBy: uid
      }, { merge: true });
    });

    // UI kilit iÃ§in local flag (modÃ¼ller bunu okuyabilir)
    localStorage.setItem("report_locked_" + rid, "1");

    finalizeRunning = false;
  }

  // ====== RAPORU LOCALSTORAGE'DAN OKU & EKRANA BAS (senin mevcut kodun) ======
  function renderReportFromLocalStorage(rid){
    const $ = (id) => document.getElementById(id);

    const formatMetin = (t) => {
      if (t === null || t === undefined) return "";
      const s = String(t);
      return s.replace(/\r\n/g, "\n")
        .replace(/[ \t]+\n/g, "\n")
        .replace(/\n{3,}/g, "\n\n")
        .trim();
    };

    const pick = (obj, ...paths) => {
      for (const p of paths) {
        try {
          const val = p.split(".").reduce((acc, k) => (acc && acc[k] !== undefined ? acc[k] : undefined), obj);
          if (val !== undefined && val !== null && String(val).trim() !== "") return val;
        } catch {}
      }
      return "";
    };

    let raporlar = [];
    try { raporlar = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); } catch { raporlar = []; }

    const report =
      raporlar.find(r => String(r?.rid ?? "").trim() === rid) ||
      raporlar.find(r => String(r?.rid ?? "").trim() === String(Number(rid))) ||
      null;

    let report2 = null;
    if (!report && rid) {
      try {
        const maybe = localStorage.getItem("rapor_" + rid);
        if (maybe) report2 = JSON.parse(maybe);
      } catch {}
    }

    const r = report || report2;
    if (!r) throw new Error("Rapor bulunamadÄ±! (rid/id: " + rid + ")");

    const bbYazdir = (list) => {
      if (!Array.isArray(list) || list.length === 0) return "BaÄŸÄ±msÄ±z bÃ¶lÃ¼m verisi yok";
      return list.map((bb, i) => {
        const baslik = bb?.baslik || bb?.title || "BaÄŸÄ±msÄ±z BÃ¶lÃ¼m";
        const metin = pick(bb, "bbDetay.tamMetin", "bbDetay.metin", "tamMetin", "metin");
        return `(${i+1}) ${baslik}:\n${formatMetin(metin)}`.trim();
      }).join("\n\n");
    };

    const emsalMetni = (rep) => {
      const direct = pick(rep, "emsalFinalMetni", "degerlemeOzet.emsalFinalMetni", "degerleme.emsalFinalMetni");
      if (direct) return formatMetin(direct);

      const list = rep?.bbDetayList;
      if (Array.isArray(list) && list.length) {
        const uniq = new Set();
        const arr = [];
        for (const bb of list) {
          const t = pick(bb, "degerlemeOzet.emsalFinalMetni", "emsalFinalMetni", "degerleme.emsalFinalMetni");
          const ft = formatMetin(t);
          if (!ft) continue;
          if (uniq.has(ft)) continue;
          uniq.add(ft);
          arr.push(ft);
        }
        return arr.length ? arr.join("\n\n") : "Emsal analizi bulunamadÄ±";
      }
      return "Emsal verisi yok";
    };

    $("raporTarih").textContent = "Tarih: " + new Date().toLocaleDateString("tr-TR");

    const il = pick(r, "il");
    const ilce = pick(r, "ilce");
    const ada = pick(r, "ada");
    const parsel = pick(r, "parsel");
    const propertyName = pick(r, "propertyName", "tasÄ±nmazAdi", "tasinmazAdi", "baslik");

    $("genelBilgi").innerHTML = `
      <div><b>Ä°l / Ä°lÃ§e:</b> ${il || "-"} / ${ilce || "-"}</div>
      <div><b>Ada / Parsel:</b> ${ada || "-"} / ${parsel || "-"}</div>
      <div><b>TaÅŸÄ±nmaz:</b> ${propertyName || "TanÄ±msÄ±z"}</div>
    `;

    const imarTablo = pick(r, "imarTablo");
    $("imarTablo").innerHTML = imarTablo || "<div class='warning'>Ä°mar tablosu bulunamadÄ±</div>";

    $("imarMetin").textContent = formatMetin(pick(r, "imarMetni", "imar.metin", "imar.tamMetin"));
    $("belgelerMetin").textContent = formatMetin(pick(r, "belgelerMetni", "belgeler.metin", "belgeler.tamMetin"));
    $("binaMetin").textContent = formatMetin(pick(r, "bina.metin", "bina.tamMetin", "binaMetni", "binaMetin"));
    $("bbMetin").textContent = bbYazdir(r.bbDetayList || r.bbList || r.bagimsizBolumler);
    $("konumMetin").textContent = formatMetin(pick(r, "konumCevre.tamMetin", "konumCevre.metin", "konumMetni", "konumMetin"));
    $("tapuMetinB1").textContent = formatMetin(pick(r, "tapuMetniB1", "tapu.b1", "tapuMetinB1"));
    $("tapuMetinB2").textContent = formatMetin(pick(r, "tapuMetniB2", "tapu.b2", "tapuMetinB2"));
    $("emsalMetin").textContent = emsalMetni(r);
  }

  // ====== BOOT ======
  document.addEventListener("DOMContentLoaded", async () => {
    const rid = getRid();
    if (!rid) { alert("rid yok!"); location.href="index.html"; return; }
    if (!hasConfirm()) { alert("Onay yok (confirm=1)."); location.href="rapor-ana-menu.html?rid="+encodeURIComponent(rid); return; }

    auth.onAuthStateChanged(async (user) => {
      if (!user) { location.href="index.html"; return; }

      try{
        setStatus("ğŸ’³ CÃ¼zdan kontrolÃ¼â€¦", "Ãœcret/Ã¼cretsiz hak dÃ¼ÅŸÃ¼mÃ¼ rapor kilitlenmeden Ã¶nce yapÄ±lÄ±r.");

        // 1) CÃœZDAN (Ã–NCE!)
        const ok = await walletPrecheckAndCharge(user.uid, rid);
        if (!ok) {
          throw new Error("Yetersiz bakiye / Ã¼cretsiz hak yok. Rapor oluÅŸturulmadÄ±.");
        }

        // 2) KÄ°LÄ°T BAS
        setStatus("ğŸ”’ Rapor kilitleniyorâ€¦", "Kilit sonrasÄ± modÃ¼ller dÃ¼zenlenemez.");
        await finalizeLockReport(rid, user.uid);

        // 3) RAPORU GÃ–STER
        setStatus("âœ… Final rapor hazÄ±r.", "Rapor kilitlendi. ArtÄ±k sadece okunabilir / yazdÄ±rÄ±labilir.");
        renderReportFromLocalStorage(rid);

        // Ä°stersen otomatik detaya yÃ¶nlendirebilirsin (ÅŸart deÄŸil)
        // location.replace("rapor-detay.html?rid="+encodeURIComponent(rid));

      }catch(e){
        console.error(e);
        setStatus("âŒ Ä°ÅŸlem baÅŸarÄ±sÄ±z.", (e?.message || e));
        alert(e?.message || "Hata oluÅŸtu");
      }
    });
  });
</script>
</body>
</html>

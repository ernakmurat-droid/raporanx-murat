<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Final Raporu OluÅŸturucu - Profesyonel Panel</title>
  <style>
    :root { --primary:#1a237e; --secondary:#3949ab; --accent:#ffd600; --bg:#f4f7f9; }
    body { font-family:'Segoe UI', Tahoma, sans-serif; background:var(--bg); margin:0; color:#2c3e50; scroll-behavior:smooth; }
    .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:white; padding:30px 20px; text-align:center; position:relative; z-index:10; }
    .back { position:absolute; left:20px; top:25px; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:30px; color:white; text-decoration:none; font-weight:bold; cursor:pointer; border:none; font-size:13px; }
    .main-wrapper { max-width:1300px; margin:20px auto; display:grid; grid-template-columns:280px 1fr; gap:30px; padding:0 20px; }
    .toc-container { position:sticky; top:20px; height:fit-content; }
    .toc { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); border-left:6px solid var(--primary); }
    .toc-title { font-size:1.1em; font-weight:bold; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .toc-list { list-style:none; padding:0; margin:0; }
    .toc-list li { margin-bottom:8px; }
    .toc-list a { color:#555; text-decoration:none; font-size:.9em; font-weight:500; transition:.2s; display:block; padding:5px; border-radius:4px; }
    .toc-list a:hover { background:#f0f2ff; color:var(--primary); padding-left:10px; }

    .container { background:white; padding:40px; border-radius:12px; box-shadow:0 0 40px rgba(0,0,0,0.05); }
    .section { margin-bottom:50px; padding-bottom:20px; border-bottom:1px solid #f0f0f0; page-break-inside:avoid; }
    .section-title { font-size:1.4em; font-weight:bold; color:var(--primary); margin-bottom:20px; display:flex; align-items:center; }
    .section-title::after { content:""; flex:1; height:1px; background:#eee; margin-left:15px; }
    .text-block { font-size:14.5px; line-height:1.7; white-space:pre-wrap; color:#34495e; text-align:justify; }
    .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; margin-bottom:25px; }
    .info-item { background:#fcfcfc; border:1px solid #f0f0f0; padding:12px; border-radius:6px; }
    .info-item strong { display:block; color:#888; font-size:.75em; text-transform:uppercase; margin-bottom:3px; }
    .info-item span { font-weight:600; font-size:.95em; color:#2c3e50; }

    #imarTablo table { width:100%!important; border-collapse:collapse; margin:15px 0; font-size:12px!important; }
    #imarTablo table th, #imarTablo table td { border:1px solid #dcdde1; padding:6px 10px!important; line-height:1.2; }
    #imarTablo table th { background:#f8f9fa; color:#444; width:30%; }

    .print-btn { background:#27ae60; color:white; padding:15px 30px; font-size:18px; border:none; border-radius:50px; cursor:pointer; margin:40px auto; display:block; font-weight:bold; box-shadow:0 6px 15px rgba(39,174,96,0.3); transition:.3s; }
    .print-btn:hover { background:#219150; transform:translateY(-2px); }

    @media print {
      body { background:white; }
      .header, .back, .print-btn, .toc-container { display:none!important; }
      .main-wrapper { display:block; max-width:100%; margin:0; padding:0; }
      .container { box-shadow:none; padding:0; margin:0; width:100%; }
      .section-title { color:black; border-bottom:2px solid black; }
      #imarTablo table { font-size:10px!important; }
    }
    @media (max-width:992px) {
      .main-wrapper { grid-template-columns:1fr; }
      .toc-container { position:relative; top:0; margin-bottom:20px; }
    }
  </style>
</head>

<body>
<div class="header">
  <button onclick="geriDon()" class="back">â† YÃ¶netim Paneli</button>
  <h1 style="margin:0; font-size:1.8em; letter-spacing:1px;">GAYRÄ°MENKUL DEÄERLEME RAPORU</h1>
  <div id="raporTarih" style="margin-top:8px; opacity:.8; font-size:13px;"></div>
</div>

<div class="main-wrapper">
  <aside class="toc-container">
    <div class="toc">
      <div class="toc-title">RAPOR BÃ–LÃœMLERÄ°</div>
      <ul class="toc-list">
        <li><a href="#genel">1. Genel Bilgiler</a></li>
        <li><a href="#imar">2. Ä°mar Durumu</a></li>
        <li><a href="#belgeler">3. Ä°ncelenen Belgeler</a></li>
        <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
        <li><a href="#bb">5. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m</a></li>
        <li><a href="#konum">6. Konum Analizi</a></li>
        <li><a href="#tapu">7. Tapu KayÄ±tlarÄ±</a></li>
        <li><a href="#emsal">8. DeÄŸerleme Sonucu</a></li>
      </ul>
    </div>
  </aside>

  <main class="container">
    <div class="section" id="genel">
      <div class="section-title">1. Gayrimenkul Genel Bilgileri</div>
      <div class="info-grid" id="genelBilgi"></div>
    </div>

    <div class="section" id="imar">
      <div class="section-title">2. Ä°mar Durumu Verileri</div>
      <div id="imarTablo"></div>
      <div class="text-block" id="imarMetin"></div>
    </div>

    <div class="section" id="belgeler">
      <div class="section-title">3. Ä°ncelenen Belgeler</div>
      <div class="text-block" id="belgelerMetin"></div>
    </div>

    <div class="section" id="bina">
      <div class="section-title">4. Ana Gayrimenkul Bilgileri</div>
      <div class="text-block" id="binaMetin"></div>
    </div>

    <div class="section" id="bb">
      <div class="section-title">5. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m Analizi</div>
      <div class="text-block" id="bbMetin"></div>
    </div>

    <div class="section" id="konum">
      <div class="section-title">6. Konum ve Ã‡evre Analizi</div>
      <div class="text-block" id="konumMetin"></div>
    </div>

    <div class="section" id="tapu">
      <div class="section-title">7. Tapu ve Takyidat KayÄ±tlarÄ±</div>
      <div class="text-block" id="tapuMetinB1" style="margin-bottom:25px;"></div>
      <div class="text-block" id="tapuMetinB2"></div>
    </div>

    <div class="section" id="emsal">
      <div class="section-title">8. DeÄŸerleme ve SonuÃ§ Analizi</div>
      <div class="text-block" id="emsalMetin"></div>
    </div>

    <button class="print-btn" onclick="window.print()">ğŸ“‘ RAPORU YAZDIR / PDF OLARAK KAYDET</button>
  </main>
</div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + legacy id desteÄŸi ========= */
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      window.location.replace("rapor-olustur.html?rid=" + encodeURIComponent(rid));
    }
  }

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }

  function geriDon(){
    window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
  }

  function pickText(...candidates){
    for (const c of candidates){
      if (c != null && String(c).trim() !== "") return String(c);
    }
    return "";
  }

  function getEmsalMetni(r){
    // 1) Eski yer
    const legacy = r?.degerlemeOzet?.emsalFinalMetni;
    if (legacy && String(legacy).trim() !== "") return String(legacy);

    // 2) Yeni yer: bbDetayList[*].degerleme.degerlemeOzet.emsalFinalMetni
    const list = Array.isArray(r?.bbDetayList) ? r.bbDetayList : [];
    const chunks = [];

    list.forEach((bb, idx) => {
      const t = bb?.degerleme?.degerlemeOzet?.emsalFinalMetni;
      if (t && String(t).trim() !== "") {
        const baslik = bb?.bbDetay?.bbNo ? `${bb.bbDetay.bbNo} BB Nolu TaÅŸÄ±nmaz` : `${idx+1}. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m`;
        chunks.push(`${baslik}\n${String(t).trim()}`);
      }
    });

    return chunks.join("\n\n");
  }

  function raporOlustur(r) {
    const today = new Date().toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('raporTarih').textContent = `Rapor OluÅŸturma: ${today}`;

    document.getElementById('genelBilgi').innerHTML = `
      <div class="info-item"><strong>TaÅŸÄ±nmaz AdÄ±</strong><span>${r.propertyName || "..."}</span></div>
      <div class="info-item"><strong>Ä°l / Ä°lÃ§e</strong><span>${r.il || '-'} / ${r.ilce || '-'}</span></div>
      <div class="info-item"><strong>Ada / Parsel</strong><span>${r.ada || '...'} / ${r.parsel || '...'}</span></div>
      <div class="info-item"><strong>Arsa AlanÄ±</strong><span>${r.bina?.arsaAlani || '...'} mÂ²</span></div>
    `;

    // Ä°mar
    document.getElementById('imarTablo').innerHTML = r.imarTablo || '<p>Veri yok.</p>';
    document.getElementById('imarMetin').textContent = pickText(r.imarMetni, r.imarDurumuMetni, r.imar?.tamMetin);

    // Belgeler
    document.getElementById('belgelerMetin').textContent = pickText(r.belgelerMetni, r.belgeler?.metin);

    // Bina
    document.getElementById('binaMetin').textContent = pickText(r.bina?.metin, r.binaMetin, r.bina?.tamMetin);

    // BB (eski tek bb + yeni Ã§oklu bb)
    const bbLegacy = r.bbDetay?.tamMetin;
    if (bbLegacy && String(bbLegacy).trim() !== "") {
      document.getElementById('bbMetin').textContent = bbLegacy;
    } else {
      const list = Array.isArray(r.bbDetayList) ? r.bbDetayList : [];
      const bbText = list
        .map((bb, idx) => {
          const t = bb?.bbDetay?.tamMetin;
          if (!t || String(t).trim() === "") return "";
          const baslik = bb?.bbDetay?.bbNo ? `${bb.bbDetay.bbNo} BB` : `${idx+1}. BB`;
          return `${baslik}\n${String(t).trim()}`;
        })
        .filter(Boolean)
        .join("\n\n");
      document.getElementById('bbMetin').textContent = bbText || 'Veri girilmedi.';
    }

    // Konum/Ã‡evre
    document.getElementById('konumMetin').textContent = pickText(r.konumCevre?.tamMetin, r.konumMetni, r.konumCevreMetni);

    // Tapu
    document.getElementById('tapuMetinB1').textContent = pickText(r.tapuMetniB1, r.tapu?.metinB1, r.tapuB1);
    document.getElementById('tapuMetinB2').textContent = pickText(r.tapuMetniB2, r.tapu?.metinB2, r.tapuB2);

    // Emsal/DeÄŸerleme
    const emsalText = getEmsalMetni(r);
    document.getElementById('emsalMetin').textContent = emsalText || 'Analiz tamamlanmadÄ±.';
  }

  auth.onAuthStateChanged((user) => {
    const { r } = getLatestData();
    if (!user || !rid || !r) {
      window.location.href = 'index.html';
      return;
    }
    raporOlustur(r);
  });
</script>
</body>
</html>

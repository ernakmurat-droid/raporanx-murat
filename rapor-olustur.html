<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <title>Final Raporu Olu≈üturucu - Raporan X</title>

  <style>
    :root { --primary: #1a237e; --secondary: #3949ab; --accent: #ffd600; --bg: #f4f7f9; }
    body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: #2c3e50; scroll-behavior: smooth; }

    .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 30px 20px; text-align: center; position: relative; z-index: 10; }
    .back { position: absolute; left: 20px; top: 25px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 30px; color: white; text-decoration: none; font-weight: bold; cursor: pointer; border: none; font-size: 13px; }

    .main-wrapper { max-width: 1300px; margin: 20px auto; display: grid; grid-template-columns: 280px 1fr; gap: 30px; padding: 0 20px; }
    .toc-container { position: sticky; top: 20px; height: fit-content; }
    .toc { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 6px solid var(--primary); }
    .toc-title { font-size: 1.1em; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .toc-list { list-style: none; padding: 0; margin: 0; }
    .toc-list li { margin-bottom: 8px; }
    .toc-list a { color: #555; text-decoration: none; font-size: 0.9em; font-weight: 500; transition: 0.2s; display: block; padding: 5px; border-radius: 4px; }
    .toc-list a:hover { background: #f0f2ff; color: var(--primary); padding-left: 10px; }

    .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 0 40px rgba(0,0,0,0.05); }
    .section { margin-bottom: 50px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0; page-break-inside: avoid; }
    .section-title { font-size: 1.4em; font-weight: bold; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; }
    .section-title::after { content: ""; flex: 1; height: 1px; background: #eee; margin-left: 15px; }

    #imarTablo table { width: 100% !important; border-collapse: collapse; margin: 15px 0; font-size: 12px !important; }
    #imarTablo table th, #imarTablo table td { border: 1px solid #dcdde1; padding: 6px 10px !important; line-height: 1.2; }
    #imarTablo table th { background: #f8f9fa; color: #444; width: 30%; }

    .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
    .info-item { background: #fcfcfc; border: 1px solid #f0f0f0; padding: 12px; border-radius: 6px; }
    .info-item strong { display: block; color: #888; font-size: 0.75em; text-transform: uppercase; margin-bottom: 3px; }
    .info-item span { font-weight: 600; font-size: 0.95em; color: #2c3e50; }

    .text-block { font-size: 14.5px; line-height: 1.7; white-space: pre-wrap; color: #34495e; text-align: justify; }
    .format-badge { background: #546e7a; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; margin-bottom: 10px; display: inline-block; }

    .print-btn { background: #27ae60; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 50px; cursor: pointer; margin: 40px auto; display: block; font-weight: bold; box-shadow: 0 6px 15px rgba(39,174,96,0.3); transition: 0.3s; }
    .print-btn:hover { background: #219150; transform: translateY(-2px); }

    .muted { color:#888; font-size: 13px; }

    @media print {
      body { background: white; }
      .header, .back, .print-btn, .toc-container { display: none !important; }
      .main-wrapper { display: block; max-width: 100%; margin: 0; padding: 0; }
      .container { box-shadow: none; padding: 0; margin: 0; width: 100%; }
      .section-title { color: black; border-bottom: 2px solid black; }
      #imarTablo table { font-size: 10px !important; }
    }

    @media (max-width: 992px) {
      .main-wrapper { grid-template-columns: 1fr; }
      .toc-container { position: relative; top: 0; margin-bottom: 20px; }
    }
  </style>
</head>

<body>
  <div class="header">
    <button id="btnBack" class="back">‚Üê Y√∂netim Paneli</button>
    <h1 style="margin:0; font-size: 1.8em; letter-spacing: 1px;">GAYRƒ∞MENKUL DEƒûERLEME RAPORU</h1>
    <div id="raporTarih" style="margin-top: 8px; opacity: 0.8; font-size: 13px;"></div>
  </div>

  <div class="main-wrapper">
    <aside class="toc-container">
      <div class="toc">
        <div class="toc-title">RAPOR B√ñL√úMLERƒ∞</div>
        <ul class="toc-list">
          <li><a href="#genel">1. Genel Bilgiler</a></li>
          <li><a href="#imar">2. ƒ∞mar Durumu</a></li>
          <li><a href="#belgeler">3. ƒ∞ncelenen Belgeler</a></li>
          <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
          <li><a href="#bb">5. Baƒüƒ±msƒ±z B√∂l√ºm</a></li>
          <li><a href="#konum">6. Konum ve √áevre</a></li>
          <li><a href="#tapu">7. Tapu ve Takyidat</a></li>
          <li><a href="#emsal">8. Deƒüerleme ve Sonu√ß</a></li>
        </ul>
        <div class="muted" style="margin-top:12px;">
          Not: Birden fazla BB varsa metinler alt alta yazƒ±lƒ±r.
        </div>
      </div>
    </aside>

    <main class="container">
      <div class="section" id="genel">
        <div class="section-title">1. Gayrimenkul Genel Bilgileri</div>
        <div class="info-grid" id="genelBilgi"></div>
      </div>

      <div class="section" id="imar">
        <div class="section-title">2. ƒ∞mar Durumu Verileri</div>
        <div id="imarTablo"></div>
        <div class="text-block" id="imarMetin"></div>
      </div>

      <div class="section" id="belgeler">
        <div class="section-title">3. ƒ∞ncelenen Belgeler</div>
        <div class="text-block" id="belgelerMetin"></div>
      </div>

      <div class="section" id="bina">
        <div class="section-title">4. Ana Gayrimenkul Bilgileri</div>
        <div class="text-block" id="binaMetin"></div>
      </div>

      <div class="section" id="bb">
        <div class="section-title">5. Baƒüƒ±msƒ±z B√∂l√ºm Analizi</div>
        <div class="text-block" id="bbMetin"></div>
      </div>

      <div class="section" id="konum">
        <div class="section-title">6. Konum ve √áevre Analizi</div>
        <div class="text-block" id="konumMetin"></div>
      </div>

      <div class="section" id="tapu">
        <div class="section-title">7. Tapu ve Takyidat Kayƒ±tlarƒ±</div>
        <div class="format-badge">BANKA FORMATI B1</div>
        <div class="text-block" id="tapuMetinB1" style="margin-bottom: 25px;"></div>
        <div class="format-badge">BANKA FORMATI B2</div>
        <div class="text-block" id="tapuMetinB2"></div>
      </div>

      <div class="section" id="emsal">
        <div class="section-title">8. Deƒüerleme ve Sonu√ß Analizi</div>
        <div class="text-block" id="emsalMetin"></div>
      </div>

      <button class="print-btn" onclick="window.print()">üìë RAPORU YAZDIR / PDF OLARAK KAYDET</button>
    </main>
  </div>

<script>
  // Firebase config.js senin projende window.auth / window.db √ßƒ±karƒ±yordu.
  const auth = window.auth || firebase.auth();

  /* ===== RID + legacy id desteƒüi (emsal sayfanla uyumlu) ===== */
  const params = new URLSearchParams(window.location.search);
  let rid = params.get('rid');
  const legacyId = params.get('id');

  function genRid(){
    try { if (crypto && crypto.randomUUID) return crypto.randomUUID(); } catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; } });
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  // legacy id -> rid y√∂nlendirme (varsa)
  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "rapor-olustur.html");
      window.location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  function getReport(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const idx = rid ? findIndexByRid(arr, rid) : (legacyId !== null ? Number(legacyId) : -1);
    const r = (idx >= 0 && arr[idx]) ? arr[idx] : null;
    return { arr, idx, r };
  }

  /* ===== Yardƒ±mcƒ±lar ===== */
  function safeText(x, fallback){
    if (typeof x !== "string") return fallback || "";
    const t = x.trim();
    return t ? t : (fallback || "");
  }

  // √áoklu BB metin birle≈ütirici (bbDetayList varsa)
  function birlestirBBMetin(report, selectorFn, baslikPrefix){
    if (!Array.isArray(report?.bbDetayList) || report.bbDetayList.length === 0) return "";
    const out = [];
    report.bbDetayList.forEach((bb, i) => {
      const baslik = bb?.baslik || `${i+1}. BB`;
      const m = selectorFn(bb);
      if (m && String(m).trim()) {
        out.push(`${baslikPrefix ? baslikPrefix + " - " : ""}${baslik}\n${String(m).trim()}`);
      }
    });
    return out.join("\n\n");
  }

  // Emsal metni: hem eski hem BB'li her ≈üeyi yakala
  function emsalMetniBul(report){
    // 1) Eski tekli
    const eski = report?.degerlemeOzet?.emsalFinalMetni;
    if (eski && String(eski).trim()) return String(eski).trim();

    // 2) BB‚Äôli (senin yeni emsal sayfan b√∂yle kaydediyor)
    const bbli = birlestirBBMetin(
      report,
      (bb) => bb?.degerleme?.degerlemeOzet?.emsalFinalMetni,
      "" // ba≈ülƒ±k yeter
    );
    if (bbli && bbli.trim()) return bbli.trim();

    // 3) Bazƒ± s√ºr√ºmlerde direkt bb.degerleme.emsalFinalMetni gibi hatalƒ± kaydedilmi≈ü olabiliyor
    const bbli2 = birlestirBBMetin(
      report,
      (bb) => bb?.degerleme?.emsalFinalMetni,
      ""
    );
    if (bbli2 && bbli2.trim()) return bbli2.trim();

    return "";
  }

  function bbMetniBul(report){
    // 1) Eski tekli
    const tek = report?.bbDetay?.tamMetin;
    if (tek && String(tek).trim()) return String(tek).trim();

    // 2) BB listesi: t√ºm BB‚Äôleri alt alta yaz
    const bbli = birlestirBBMetin(report, (bb) => bb?.bbDetay?.tamMetin, "");
    return bbli || "";
  }

  function konumMetniBul(report){
    const tek = report?.konumCevre?.tamMetin;
    if (tek && String(tek).trim()) return String(tek).trim();
    // BB‚Äôli kaydetmi≈ü olma ihtimali (ileride)
    const bbli = birlestirBBMetin(report, (bb) => bb?.konumCevre?.tamMetin, "");
    return bbli || "";
  }

  function raporOlustur(report){
    const today = new Date().toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('raporTarih').textContent = `Rapor Olu≈üturma: ${today}`;

    // Back butonu doƒüru query ile d√∂ns√ºn
    const backBtn = document.getElementById("btnBack");
    backBtn.onclick = () => {
      const q = rid ? `rid=${encodeURIComponent(rid)}` : `id=${encodeURIComponent(legacyId || 0)}`;
      window.location.href = `rapor-detay.html?${q}`;
    };

    // 1) Genel
    document.getElementById('genelBilgi').innerHTML = `
      <div class="info-item"><strong>Ta≈üƒ±nmaz Adƒ±</strong><span>${safeText(report.propertyName, "...")}</span></div>
      <div class="info-item"><strong>ƒ∞l / ƒ∞l√ße</strong><span>${safeText(report.il, "-")} / ${safeText(report.ilce, "-")}</span></div>
      <div class="info-item"><strong>Ada / Parsel</strong><span>${safeText(report.ada, "...")} / ${safeText(report.parsel, "...")}</span></div>
      <div class="info-item"><strong>Arsa Alanƒ±</strong><span>${safeText(String(report?.bina?.arsaAlani || ""), "...")} ${report?.bina?.arsaAlani ? "m¬≤" : ""}</span></div>
    `;

    // 2) ƒ∞mar
    document.getElementById('imarTablo').innerHTML = report.imarTablo || '<p class="muted">Veri yok.</p>';
    document.getElementById('imarMetin').textContent = safeText(report.imarMetni, "");

    // 3) Belgeler
    document.getElementById('belgelerMetin').textContent = safeText(report.belgelerMetni, "Veri girilmedi.");

    // 4) Bina
    document.getElementById('binaMetin').textContent = safeText(report?.bina?.metin, "Veri girilmedi.");

    // 5) BB (tek + √ßoklu)
    const bbMetin = bbMetniBul(report);
    document.getElementById('bbMetin').textContent = bbMetin ? bbMetin : "Veri girilmedi.";

    // 6) Konum/√áevre
    const konumMetin = konumMetniBul(report);
    document.getElementById('konumMetin').textContent = konumMetin ? konumMetin : "Veri girilmedi.";

    // 7) Tapu
    document.getElementById('tapuMetinB1').textContent = safeText(report.tapuMetniB1, "Veri girilmedi.");
    document.getElementById('tapuMetinB2').textContent = safeText(report.tapuMetniB2, "Veri girilmedi.");

    // 8) EMSAL (ƒ∞≈ûTE BURASI)
    const emsal = emsalMetniBul(report);
    document.getElementById('emsalMetin').textContent = emsal ? emsal : "Analiz tamamlanmadƒ±.";
  }

  // ===== G√ºvenlik + oturum =====
  auth.onAuthStateChanged((user) => {
    const { r } = getReport();
    if (!user || !r) {
      window.location.href = 'index.html';
      return;
    }
    raporOlustur(r);
  });
</script>
</body>
</html>

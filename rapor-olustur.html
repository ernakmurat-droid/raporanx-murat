<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Rapor Olu≈üturuluyor‚Ä¶</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Wallet -->
  <script src="wallet.js"></script>

  <style>
    :root{--primary:#1a237e;--secondary:#3949ab;--bg:#f4f7f9;}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family:Segoe UI, Arial, sans-serif; background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;
    }
    .card{
      width:min(720px, calc(100% - 32px));
      background:rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:18px;
      padding:18px 16px;
      box-shadow:0 18px 50px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    h1{font-size:20px; margin:0 0 8px; letter-spacing:.3px;}
    .sub{opacity:.9; line-height:1.4;}
    .status{
      margin-top:14px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      padding:12px 12px;
      font-weight:800;
      line-height:1.35;
    }
    .status small{display:block; font-weight:600; opacity:.9; margin-top:4px;}
    .btnRow{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;}
    button{
      border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:900;
    }
    .btnBack{background:rgba(255,255,255,0.18); color:#fff; border:1px solid rgba(255,255,255,0.25);}
    .btnRetry{background:#00c853; color:#fff;}
    .muted{opacity:.85; font-size:12px; margin-top:10px; line-height:1.35;}
    .spinner{
      margin-top:12px;
      width:34px; height:34px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.25);
      border-top-color:#fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>

<body>
  <div class="card">
    <h1>Rapor Olu≈üturuluyor‚Ä¶</h1>
    <div class="sub">L√ºtfen sayfayƒ± kapatma. ƒ∞≈ülem bitince otomatik olarak rapor ekranƒ±na ge√ßeceƒüiz.</div>

    <div class="spinner" id="spinner"></div>

    <div class="status" id="status">
      Ba≈ülatƒ±lƒ±yor‚Ä¶
      <small id="statusSub">Giri≈ü ve rapor kontrol ediliyor.</small>
    </div>

    <div class="btnRow" id="btnRow" style="display:none;">
      <button class="btnBack" id="btnBack">‚Üê Geri D√∂n</button>
      <button class="btnRetry" id="btnRetry">Tekrar Dene</button>
    </div>

    <div class="muted" id="muted">
      Not: √úcret/√ºcretsiz hak d√º≈ü√ºm√º rapor olu≈üturma ba≈üladƒ±ƒüƒ±nda yapƒ±lƒ±r. Aynƒ± rid i√ßin ikinci kez d√º≈ümez.
    </div>
  </div>

<script>
(function(){
  const auth = (window.auth) ? window.auth : firebase.auth();
  const db   = (window.db)   ? window.db   : firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  const $ = (id) => document.getElementById(id);

  function setStatus(title, sub){
    $("status").firstChild.nodeValue = title;
    $("statusSub").textContent = sub || "";
  }

  function showFailUI(msg){
    $("spinner").style.display = "none";
    $("btnRow").style.display = "flex";
    setStatus("‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z.", msg || "Bilinmeyen hata");
  }

  function getParams(){
    const p = new URLSearchParams(location.search);
    return {
      rid: (p.get("rid") || p.get("id") || "").toString().trim(),
      confirm: p.get("confirm") === "1",
    };
  }

  function goBack(rid){
    if (rid) location.href = "rapor-ana-menu.html?rid=" + encodeURIComponent(rid);
    else location.href = "index.html";
  }

  function gotoReport(rid){
    location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
  }

  function loadReports(){
    try { return JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }
    catch { return []; }
  }
  function saveReports(arr){
    localStorage.setItem("gayrimenkul_reports", JSON.stringify(arr || []));
  }

  function findReportByRid(rid){
    const reports = loadReports();
    const i = reports.findIndex(r => String(r?.rid ?? "").trim() === String(rid));
    return { reports, i, report: i >= 0 ? reports[i] : null };
  }

  // rid par√ßalarƒ±nƒ± localStorage‚Äôdan topla (mod√ºllere dokunmadan)
  function collectModulePiecesByRid(rid){
    const out = {};
    const ridStr = String(rid);

    for (let i=0; i<localStorage.length; i++){
      const key = localStorage.key(i);
      if (!key) continue;
      if (!key.includes(ridStr)) continue;

      const raw = localStorage.getItem(key);
      if (!raw) continue;

      let val = raw;
      try { val = JSON.parse(raw); } catch {}

      const k = key.toLowerCase();
      if (k.includes("konum")) out.konum = val;
      else if (k.includes("tapu")) out.tapu = val;
      else if (k.includes("imar")) out.imar = val;
      else if (k.includes("belge")) out.belgeler = val;
      else if (k.includes("bina")) out.bina = val;
      else if (k.includes("bagimsiz") || k.includes("bb")) out.bb = val;
      else if (k.includes("emsal") || k.includes("degerleme")) out.emsal = val;
    }
    return out;
  }

  // rapor objesine ‚Äúzararsƒ±z‚Äù merge (bo≈ü olanƒ± doldurur)
  function mergePiecesIntoReport(report, pieces){
    const r = report || {};

    const safeSet = (path, value) => {
      if (value === undefined || value === null) return;
      if (typeof value === "string" && value.trim() === "") return;

      const parts = path.split(".");
      let cur = r;
      for (let i=0; i<parts.length-1; i++){
        cur[parts[i]] = cur[parts[i]] || {};
        cur = cur[parts[i]];
      }
      const last = parts[parts.length-1];
      if (cur[last] === undefined || cur[last] === null || String(cur[last]).trim() === "") {
        cur[last] = value;
      }
    };

    if (pieces.konum){
      safeSet("konumCevre", pieces.konum);
      safeSet("konumMetni", pieces.konum?.tamMetin || pieces.konum?.metin || pieces.konum);
    }
    if (pieces.tapu){
      safeSet("tapu", pieces.tapu);
      safeSet("tapuMetniB1", pieces.tapu?.tapuMetniB1 || pieces.tapu?.b1 || pieces.tapu);
      safeSet("tapuMetniB2", pieces.tapu?.tapuMetniB2 || pieces.tapu?.b2 || "");
    }
    if (pieces.imar){
      safeSet("imar", pieces.imar);
      safeSet("imarTablo", pieces.imar?.imarTablo || pieces.imar?.tablo || "");
      safeSet("imarMetni", pieces.imar?.imarMetni || pieces.imar?.metin || pieces.imar?.tamMetin || pieces.imar);
    }
    if (pieces.belgeler){
      safeSet("belgeler", pieces.belgeler);
      safeSet("belgelerMetni", pieces.belgeler?.belgelerMetni || pieces.belgeler?.metin || pieces.belgeler?.tamMetin || pieces.belgeler);
    }
    if (pieces.bina){
      safeSet("bina", pieces.bina);
      safeSet("bina.metin", pieces.bina?.metin || pieces.bina?.tamMetin || pieces.bina);
    }
    if (pieces.bb){
      safeSet("bbDetayList", Array.isArray(pieces.bb) ? pieces.bb : (pieces.bb?.bbDetayList || pieces.bb?.list || []));
    }
    if (pieces.emsal){
      safeSet("degerlemeOzet", pieces.emsal?.degerlemeOzet || pieces.emsal);
      safeSet("emsalFinalMetni", pieces.emsal?.emsalFinalMetni || pieces.emsal?.finalMetin || "");
    }

    return r;
  }

  // üîí local + firestore kilit
  async function lockFinal(rid, uid){
    await db.collection("reports").doc(rid).set({
      ownerUid: uid,
      status: "final",
      locked: true,
      lockedAt: FieldValue.serverTimestamp(),
      lockedBy: uid
    }, { merge:true });

    localStorage.setItem("report_locked_" + rid, "1");
  }

  // üí≥ C√ºzdan d√º≈ü√ºm√º (idempotent)
  // wallet.js i√ßinde Wallet.consumeReport varsa onu kullanƒ±r.
  // Yoksa burada kendi transaction‚Äôƒ± ile d√º≈üer.
  function walletMainRef(uid){
    return db.collection("users").doc(uid).collection("wallet").doc("main");
  }
  function walletUseRef(uid, rid){
    // her rapor i√ßin tek seferlik ‚Äúkullanƒ±m‚Äù kaydƒ±
    return db.collection("users").doc(uid).collection("wallet").doc("main")
      .collection("uses").doc(String(rid));
  }

  async function ensureWallet(uid){
    const ref = walletMainRef(uid);
    return db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      if (!snap.exists){
        const init = { balance: 0, freeReportsLeft: 5, createdAt: FieldValue.serverTimestamp(), updatedAt: FieldValue.serverTimestamp() };
        tx.set(ref, init, { merge:true });
        return init;
      }
      const data = snap.data() || {};
      const patch = {};
      if (typeof data.balance !== "number") patch.balance = Number(data.balance || 0);
      if (typeof data.freeReportsLeft !== "number") patch.freeReportsLeft = Number(data.freeReportsLeft || 0);
      if (Object.keys(patch).length){
        patch.updatedAt = FieldValue.serverTimestamp();
        tx.set(ref, patch, { merge:true });
        return { ...data, ...patch };
      }
      return data;
    });
  }

  async function consumeReport(uid, rid){
    // 1) varsa hazƒ±r fonksiyon
    if (window.Wallet && typeof Wallet.consumeReport === "function"){
      return await Wallet.consumeReport(uid, rid);
    }

    // 2) yoksa burada g√ºvenli d√º≈ü√ºm (1 rapor = 1 hak; hak yoksa balance d√º≈üer; yetmezse false)
    await ensureWallet(uid);

    const mainRef = walletMainRef(uid);
    const useRef  = walletUseRef(uid, rid);

    return db.runTransaction(async (tx)=>{
      const useSnap = await tx.get(useRef);
      if (useSnap.exists){
        // daha √∂nce d√º≈üm√º≈ü
        return true;
      }

      const mainSnap = await tx.get(mainRef);
      if (!mainSnap.exists) throw new Error("C√ºzdan bulunamadƒ±.");
      const w = mainSnap.data() || {};

      let balance = Number(w.balance || 0);
      let freeLeft = Number(w.freeReportsLeft || 0);

      // fiyat: burada istersen sabitleyebilirsin (√∂r: 100 TL)
      // ama sen ‚Äúhak d√º≈üs√ºn‚Äù dediƒüin i√ßin: √∂nce √ºcretsizden d√º≈ü, yoksa 0 TL ise engelle
      const priceTL = Number(w.pricePerReportTL || 0) || 0;

      if (freeLeft > 0){
        freeLeft -= 1;
        tx.set(mainRef, { freeReportsLeft: freeLeft, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
        tx.set(useRef, { usedAt: FieldValue.serverTimestamp(), kind:"free" }, { merge:true });
        return true;
      }

      // √ºcretsiz yoksa √ºcretli
      if (priceTL <= 0){
        // fiyat tanƒ±mlƒ± deƒüilse, g√ºvenlik i√ßin engelle
        return false;
      }

      if (balance < priceTL){
        return false;
      }

      balance -= priceTL;
      tx.set(mainRef, { balance: balance, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
      tx.set(useRef, { usedAt: FieldValue.serverTimestamp(), kind:"paid", priceTL }, { merge:true });
      return true;
    });
  }

  async function run(){
    const { rid, confirm } = getParams();
    if (!rid){
      showFailUI("rid parametresi yok. (√ñrn: rapor-olustur.html?rid=xxxx)");
      return;
    }

    $("btnBack").onclick = () => goBack(rid);
    $("btnRetry").onclick = () => location.reload();

    // uyarƒ± burada da garanti olsun (men√ºden confirm=1 gelmediyse)
    if (!confirm){
      const msg =
`UYARI! (√ñNEMLƒ∞)
Tam rapor olu≈üturulduƒüunda √ºcret/√ºcretsiz hak d√º≈üebilir.

L√ºtfen zaman ve para kaybƒ± olmamasƒ± i√ßin t√ºm mod√ºlleri tekrar kontrol edin.
Devam ederseniz rapor bankaya uygun taslak formatƒ±nda √ºretilecektir.

Devam etmek istiyor musunuz?`;
      if (!window.confirm(msg)){
        goBack(rid);
        return;
      }
    }

    setStatus("üîê Giri≈ü kontrol√º‚Ä¶", "Hesabƒ±n doƒürulanƒ±yor.");

    const user = auth.currentUser;
    if (!user){
      showFailUI("Giri≈ü bulunamadƒ±. L√ºtfen tekrar giri≈ü yap.");
      return;
    }

    // zaten kilitliyse direkt rapora ge√ß
    if (localStorage.getItem("report_locked_" + rid) === "1"){
      setStatus("üîí Rapor kilitli.", "Final rapor zaten olu≈üturulmu≈ü. Rapor ekranƒ±na ge√ßiliyor‚Ä¶");
      setTimeout(()=>gotoReport(rid), 600);
      return;
    }

    setStatus("üí≥ C√ºzdan/hak d√º≈ü√ºm√º‚Ä¶", "Bu rapor i√ßin i≈ülem yapƒ±lƒ±yor.");

    const ok = await consumeReport(user.uid, rid);
    if (!ok){
      showFailUI("Yetersiz √ºcretsiz hak/bakiye. (Fiyat tanƒ±mlƒ± deƒüilse √ºcretli d√º≈ü√ºm kapalƒ± olabilir)");
      return;
    }

    setStatus("üßæ Veriler toparlanƒ±yor‚Ä¶", "Mod√ºllerden gelen metinler rapora i≈üleniyor.");

    // raporu bul/olu≈ütur ve merge et
    let { reports, i, report } = findReportByRid(rid);
    report = report || { rid };

    const pieces = collectModulePiecesByRid(rid);
    report = mergePiecesIntoReport(report, pieces);

    if (i >= 0) reports[i] = report;
    else reports.push(report);
    saveReports(reports);

    setStatus("üîí Kilit basƒ±lƒ±yor‚Ä¶", "Final rapor kilitleniyor.");

    await lockFinal(rid, user.uid);

    setStatus("‚úÖ Tamamlandƒ±!", "Rapor ekranƒ±na y√∂nlendiriliyorsun‚Ä¶");
    setTimeout(()=>gotoReport(rid), 700);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    auth.onAuthStateChanged(()=>{
      // auth hazƒ±r olunca ko≈ü
      run().catch((e)=>{
        console.error(e);
        showFailUI(e?.message || "Beklenmeyen hata");
      });
    });
  });
})();
</script>
</body>
</html>

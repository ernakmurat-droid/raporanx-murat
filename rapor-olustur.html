<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Rapor Olu≈üturuluyor‚Ä¶</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="wallet.js"></script>

  <style>
    :root{--primary:#1a237e;--secondary:#3949ab;}
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family:Segoe UI, Arial, sans-serif; background:linear-gradient(135deg,var(--primary),var(--secondary));
      color:#fff;
    }
    .card{
      width:min(760px, calc(100% - 32px));
      background:rgba(255,255,255,0.12);
      border:1px solid rgba(255,255,255,0.2);
      border-radius:18px;
      padding:18px 16px;
      box-shadow:0 18px 50px rgba(0,0,0,0.25);
      backdrop-filter: blur(6px);
    }
    h1{font-size:20px; margin:0 0 8px; letter-spacing:.3px;}
    .sub{opacity:.9; line-height:1.4;}
    .status{
      margin-top:14px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      padding:12px 12px;
      font-weight:900;
      line-height:1.35;
    }
    .status small{display:block; font-weight:700; opacity:.9; margin-top:4px;}
    .btnRow{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;}
    button{
      border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:900;
    }
    .btnBack{background:rgba(255,255,255,0.18); color:#fff; border:1px solid rgba(255,255,255,0.25);}
    .btnRetry{background:#00c853; color:#fff;}
    .spinner{
      margin-top:12px;
      width:34px; height:34px; border-radius:50%;
      border:4px solid rgba(255,255,255,0.25);
      border-top-color:#fff;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg);} }
  </style>
</head>

<body>
  <div class="card">
    <h1>Rapor Olu≈üturuluyor‚Ä¶</h1>
    <div class="sub">ƒ∞≈ülem bitince otomatik olarak rapor √ßƒ±ktƒ±sƒ±na ge√ßeceƒüiz.</div>

    <div class="spinner" id="spinner"></div>

    <div class="status" id="status">
      Ba≈ülatƒ±lƒ±yor‚Ä¶
      <small id="statusSub">Giri≈ü durumu bekleniyor.</small>
    </div>

    <div class="btnRow" id="btnRow" style="display:none;">
      <button class="btnBack" id="btnBack">‚Üê Geri D√∂n</button>
      <button class="btnRetry" id="btnRetry">Tekrar Dene</button>
    </div>
  </div>

<script>
(function(){
  const auth = (window.auth) ? window.auth : firebase.auth();
  const db   = (window.db)   ? window.db   : firebase.firestore();
  const FieldValue = firebase.firestore.FieldValue;

  // ‚úÖ Burayƒ± senin rapor √ßƒ±ktƒ±sƒ± sayfanƒ±n dosya adƒ±na g√∂re ayarla:
  // Senin payla≈ütƒ±ƒüƒ±n ‚ÄúGayrimenkul Deƒüerleme Raporu‚Äù sayfasƒ± hangi dosya adƒ±ysa onu yaz.
  // √ñrn: "rapor.html" / "gayrimenkul-raporu.html" / "rapor-cikti.html"
  const RAPOR_CIKTI_SAYFASI = "gayrimenkul-raporu.html";

  const $ = (id) => document.getElementById(id);

  function setStatus(title, sub){
    $("status").firstChild.nodeValue = title;
    $("statusSub").textContent = sub || "";
  }

  function showFailUI(msg){
    $("spinner").style.display = "none";
    $("btnRow").style.display = "flex";
    setStatus("‚ùå ƒ∞≈ülem ba≈üarƒ±sƒ±z.", msg || "Bilinmeyen hata");
  }

  function getParams(){
    const p = new URLSearchParams(location.search);
    return {
      rid: (p.get("rid") || p.get("id") || "").toString().trim(),
      confirm: p.get("confirm") === "1"
    };
  }

  function goBack(rid){
    if (rid) location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
    else location.href = "index.html";
  }

  function gotoOutput(rid){
    location.href = RAPOR_CIKTI_SAYFASI + "?rid=" + encodeURIComponent(rid);
  }

  function walletMainRef(uid){
    return db.collection("users").doc(uid).collection("wallet").doc("main");
  }
  function walletUseRef(uid, rid){
    return walletMainRef(uid).collection("uses").doc(String(rid));
  }

  async function ensureWallet(uid){
    const ref = walletMainRef(uid);
    return db.runTransaction(async (tx)=>{
      const snap = await tx.get(ref);
      if (!snap.exists){
        const init = { balance: 0, freeReportsLeft: 5, createdAt: FieldValue.serverTimestamp(), updatedAt: FieldValue.serverTimestamp() };
        tx.set(ref, init, { merge:true });
        return init;
      }
      const data = snap.data() || {};
      const patch = {};
      if (typeof data.balance !== "number") patch.balance = Number(data.balance || 0);
      if (typeof data.freeReportsLeft !== "number") patch.freeReportsLeft = Number(data.freeReportsLeft || 0);
      if (Object.keys(patch).length){
        patch.updatedAt = FieldValue.serverTimestamp();
        tx.set(ref, patch, { merge:true });
        return { ...data, ...patch };
      }
      return data;
    });
  }

  // ‚úÖ idempotent rapor kullanƒ±m d√º≈ü√ºm√º
  async function consumeReport(uid, rid){
    if (window.Wallet && typeof Wallet.consumeReport === "function"){
      return await Wallet.consumeReport(uid, rid);
    }

    await ensureWallet(uid);

    const mainRef = walletMainRef(uid);
    const useRef = walletUseRef(uid, rid);

    return db.runTransaction(async (tx)=>{
      const useSnap = await tx.get(useRef);
      if (useSnap.exists) return true;

      const mainSnap = await tx.get(mainRef);
      if (!mainSnap.exists) throw new Error("C√ºzdan bulunamadƒ±.");
      const w = mainSnap.data() || {};

      let balance = Number(w.balance || 0);
      let freeLeft = Number(w.freeReportsLeft || 0);
      const priceTL = Number(w.pricePerReportTL || 0) || 0;

      if (freeLeft > 0){
        freeLeft -= 1;
        tx.set(mainRef, { freeReportsLeft: freeLeft, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
        tx.set(useRef, { usedAt: FieldValue.serverTimestamp(), kind:"free" }, { merge:true });
        return true;
      }

      if (priceTL <= 0) return false;
      if (balance < priceTL) return false;

      balance -= priceTL;
      tx.set(mainRef, { balance: balance, updatedAt: FieldValue.serverTimestamp() }, { merge:true });
      tx.set(useRef, { usedAt: FieldValue.serverTimestamp(), kind:"paid", priceTL }, { merge:true });
      return true;
    });
  }

  async function lockFinalReport(rid, uid){
    // ‚úÖ ownerUid create/update rules ile uyumlu
    await db.collection("reports").doc(rid).set({
      ownerUid: uid,
      status: "final",
      locked: true,
      lockedAt: FieldValue.serverTimestamp(),
      lockedBy: uid
    }, { merge:true });

    localStorage.setItem("report_locked_" + rid, "1");
  }

  async function run(user){
    const { rid, confirm } = getParams();
    if (!rid){
      showFailUI("rid parametresi yok. (√∂r: rapor-olustur.html?rid=XXXX)");
      return;
    }

    $("btnBack").onclick = () => goBack(rid);
    $("btnRetry").onclick = () => location.reload();

    if (!confirm){
      const msg =
`UYARI! (√ñNEMLƒ∞)
Tam rapor olu≈üturulduƒüunda √ºcret/√ºcretsiz hak d√º≈üebilir.
Devam etmek istiyor musunuz?`;
      if (!window.confirm(msg)){
        goBack(rid);
        return;
      }
    }

    // zaten kilitliyse direkt √ßƒ±ktƒ±ya
    if (localStorage.getItem("report_locked_" + rid) === "1"){
      setStatus("üîí Rapor zaten final.", "√áƒ±ktƒ± sayfasƒ±na ge√ßiliyor‚Ä¶");
      setTimeout(()=>gotoOutput(rid), 600);
      return;
    }

    setStatus("üí≥ C√ºzdan‚Ä¶", "√úcret/√ºcretsiz hak d√º≈ü√ºm√º yapƒ±lƒ±yor.");
    const ok = await consumeReport(user.uid, rid);
    if (!ok){
      showFailUI("Yetersiz √ºcretsiz hak/bakiye ya da fiyat tanƒ±mlƒ± deƒüil.");
      return;
    }

    setStatus("üîí Kilit‚Ä¶", "Final rapor kilitleniyor.");
    await lockFinalReport(rid, user.uid);

    setStatus("‚úÖ Tamamlandƒ±!", "Rapor √ßƒ±ktƒ±sƒ±na y√∂nlendiriliyor‚Ä¶");
    setTimeout(()=>gotoOutput(rid), 700);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    auth.onAuthStateChanged((user)=>{
      if (!user){
        showFailUI("Giri≈ü bulunamadƒ±. L√ºtfen tekrar giri≈ü yap.");
        setTimeout(()=>location.href="index.html", 800);
        return;
      }
      run(user).catch((e)=>{
        console.error(e);
        // burada gelen ‚ÄúMissing or insufficient permissions‚Äù artƒ±k rules ile √ß√∂z√ºlm√º≈ü olmalƒ±
        showFailUI(e?.message || "Beklenmeyen hata");
      });
    });
  });
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Final Raporu Olu≈üturucu - Profesyonel Panel</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  :root { --primary: #1a237e; --secondary: #3949ab; --accent: #ffd600; --bg: #f4f7f9; }
  body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: #2c3e50; scroll-behavior: smooth; }

  .header { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 30px 20px; text-align: center; position: relative; z-index: 10; }
  .back { position: absolute; left: 20px; top: 25px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 30px; color: white; text-decoration: none; font-weight: bold; cursor: pointer; border: none; font-size: 13px; }

  .main-wrapper { max-width: 1300px; margin: 20px auto; display: grid; grid-template-columns: 280px 1fr; gap: 30px; padding: 0 20px; }

  .toc-container { position: sticky; top: 20px; height: fit-content; }
  .toc { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 6px solid var(--primary); }
  .toc-title { font-size: 1.1em; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
  .toc-list { list-style: none; padding: 0; margin: 0; }
  .toc-list li { margin-bottom: 8px; }
  .toc-list a { color: #555; text-decoration: none; font-size: 0.9em; font-weight: 500; transition: 0.2s; display: block; padding: 5px; border-radius: 4px; }
  .toc-list a:hover { background: #f0f2ff; color: var(--primary); padding-left: 10px; }

  .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 0 40px rgba(0,0,0,0.05); }

  .section { margin-bottom: 50px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0; page-break-inside: avoid; }
  .section-title { font-size: 1.4em; font-weight: bold; color: var(--primary); margin-bottom: 20px; display: flex; align-items: center; }
  .section-title::after { content: ""; flex: 1; height: 1px; background: #eee; margin-left: 15px; }

  #imarTablo table { width: 100% !important; border-collapse: collapse; margin: 15px 0; font-size: 12px !important; }
  #imarTablo table th, #imarTablo table td { border: 1px solid #dcdde1; padding: 6px 10px !important; line-height: 1.2; }
  #imarTablo table th { background: #f8f9fa; color: #444; width: 30%; }

  .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
  .info-item { background: #fcfcfc; border: 1px solid #f0f0f0; padding: 12px; border-radius: 6px; }
  .info-item strong { display: block; color: #888; font-size: 0.75em; text-transform: uppercase; margin-bottom: 3px; }
  .info-item span { font-weight: 600; font-size: 0.95em; color: #2c3e50; }

  .text-block { font-size: 14.5px; line-height: 1.7; white-space: pre-wrap; color: #34495e; text-align: justify; }
  .format-badge { background: #546e7a; color: white; padding: 3px 10px; border-radius: 4px; font-size: 11px; margin-bottom: 10px; display: inline-block; }

  .print-btn { background: #27ae60; color: white; padding: 15px 30px; font-size: 18px; border: none; border-radius: 50px; cursor: pointer; margin: 40px auto; display: block; font-weight: bold; box-shadow: 0 6px 15px rgba(39,174,96,0.3); transition: 0.3s; }
  .print-btn:hover { background: #219150; transform: translateY(-2px); }

  @media print {
    body { background: white; }
    .header, .back, .print-btn, .toc-container { display: none !important; }
    .main-wrapper { display: block; max-width: 100%; margin: 0; padding: 0; }
    .container { box-shadow: none; padding: 0; margin: 0; width: 100%; }
    .section-title { color: black; border-bottom: 2px solid black; }
    #imarTablo table { font-size: 10px !important; }
  }

  @media (max-width: 992px) {
    .main-wrapper { grid-template-columns: 1fr; }
    .toc-container { position: relative; top: 0; margin-bottom: 20px; }
  }
</style>
</head>

<body>

<div class="header">
  <button onclick="geriDon()" class="back">‚Üê Y√∂netim Paneli</button>
  <h1 style="margin:0; font-size: 1.8em; letter-spacing: 1px;">GAYRƒ∞MENKUL DEƒûERLEME RAPORU</h1>
  <div id="raporTarih" style="margin-top: 8px; opacity: 0.8; font-size: 13px;"></div>
</div>

<div class="main-wrapper">
  <aside class="toc-container">
    <div class="toc">
      <div class="toc-title">RAPOR B√ñL√úMLERƒ∞</div>
      <ul class="toc-list">
        <li><a href="#genel">1. Genel Bilgiler</a></li>
        <li><a href="#imar">2. ƒ∞mar Durumu</a></li>
        <li><a href="#belgeler">3. ƒ∞ncelenen Belgeler</a></li>
        <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
        <li><a href="#bb">5. Baƒüƒ±msƒ±z B√∂l√ºm</a></li>
        <li><a href="#konum">6. Konum Analizi</a></li>
        <li><a href="#tapu">7. Tapu Kayƒ±tlarƒ±</a></li>
        <li><a href="#emsal">8. Deƒüerleme Sonucu</a></li>
      </ul>
    </div>
  </aside>

  <main class="container">
    <div class="section" id="genel">
      <div class="section-title">1. Gayrimenkul Genel Bilgileri</div>
      <div class="info-grid" id="genelBilgi"></div>
    </div>

    <div class="section" id="imar">
      <div class="section-title">2. ƒ∞mar Durumu Verileri</div>
      <div id="imarTablo"></div>
      <div class="text-block" id="imarMetin"></div>
    </div>

    <div class="section" id="belgeler">
      <div class="section-title">3. ƒ∞ncelenen Belgeler</div>
      <div class="text-block" id="belgelerMetin"></div>
    </div>

    <div class="section" id="bina">
      <div class="section-title">4. Ana Gayrimenkul Bilgileri</div>
      <div class="text-block" id="binaMetin"></div>
    </div>

    <div class="section" id="bb">
      <div class="section-title">5. Baƒüƒ±msƒ±z B√∂l√ºm Analizi</div>
      <div class="text-block" id="bbMetin"></div>
    </div>

    <div class="section" id="konum">
      <div class="section-title">6. Konum ve √áevre Analizi</div>
      <div class="text-block" id="konumMetin"></div>
    </div>

    <div class="section" id="tapu">
      <div class="section-title">7. Tapu ve Takyidat Kayƒ±tlarƒ±</div>
      <div class="format-badge">BANKA FORMATI B1</div>
      <div class="text-block" id="tapuMetinB1" style="margin-bottom: 25px;"></div>
      <div class="format-badge">BANKA FORMATI B2</div>
      <div class="text-block" id="tapuMetinB2"></div>
    </div>

    <div class="section" id="emsal">
      <div class="section-title">8. Deƒüerleme ve Sonu√ß Analizi</div>
      <div class="text-block" id="emsalMetin"></div>
    </div>

    <button class="print-btn" onclick="window.print()">üìë RAPORU YAZDIR / PDF OLARAK KAYDET</button>
  </main>
</div>

<script>
  const auth = firebase.auth();

  /* ========= T√ºrk√ße toparlama ========= */
  function duzeltTR(metin){
    if(!metin) return "";
    return String(metin)
      .replace(/\s{2,}/g," ")
      .replace(/\s+\./g,".")
      .replace(/\s+,/g,",")
      .replace(/\s+:/g,":")
      .replace(/\.(\S)/g,". $1")
      .replace(/\bm2\b/gi,"m¬≤")
      .replace(/tl\b/gi,"TL")
      .replace(/\n\s*\n/g,"\n\n")
      .trim();
  }

  /* ========= Yardƒ±mcƒ±lar ========= */
  function valOr(...cands){
    for (const c of cands){
      if (c !== undefined && c !== null){
        const s = String(c).trim();
        if (s) return s;
      }
    }
    return "";
  }

  function getByPath(obj, path){
    try{
      return path.split(".").reduce((o,k)=> (o && o[k] !== undefined) ? o[k] : undefined, obj);
    }catch(e){ return undefined; }
  }

  // Derinden anahtar arama (alan adƒ± deƒüi≈ümi≈ü olsa bile metni bulur)
  function findDeepString(obj, keySet, maxNodes = 8000){
    const keys = new Set(keySet.map(k => String(k).toLowerCase()));
    const seen = new Set();
    const q = [obj];
    let visited = 0;

    while(q.length && visited < maxNodes){
      const cur = q.shift();
      if(!cur || typeof cur !== "object") continue;
      if(seen.has(cur)) continue;
      seen.add(cur);
      visited++;

      for (const k in cur){
        const v = cur[k];
        const kl = String(k).toLowerCase();

        if (keys.has(kl) && typeof v === "string" && v.trim()){
          return v;
        }

        if (v && typeof v === "object"){
          q.push(v);
        }
      }
    }
    return "";
  }

  /* ========= RID + legacy id ========= */
  const params = new URLSearchParams(location.search);
  let rid = params.get("rid");
  const legacyId = params.get("id");

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid=genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem("gayrimenkul_reports")) || [];
  if (ensureRidMigration(reports)) localStorage.setItem("gayrimenkul_reports", JSON.stringify(reports));

  // legacy id -> rid
  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "final-rapor.html");
      location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  const idx = rid ? findIndexByRid(reports, rid) : -1;
  const report = (idx >= 0) ? (reports[idx] || {}) : null;

  /* ========= √áoklu BB metni ========= */
  function combineBBMetin(r){
    if (Array.isArray(r.bbDetayList) && r.bbDetayList.length > 0) {
      const parts = [];
      r.bbDetayList.forEach((wrap, i) => {
        const bb = wrap?.bbDetay || {};
        const no = valOr(bb.bbNo, wrap?.baslik, `${i+1}. BB`);
        const metin = valOr(bb.tamMetin);
        if (metin) parts.push(`${no}:\n${metin}`);
      });
      return parts.join("\n\n");
    }
    return valOr(r.bbDetay?.tamMetin);
  }

  /* ========= EMSAL METNƒ∞ (global + multi-bb fallback) ========= */
  function getEmsalMetni(r){
    // 1) global alanlar
    let m = valOr(
      getByPath(r, "degerlemeOzet.emsalFinalMetni"),
      r.emsalFinalMetni
    );
    if (m) return m;

    // 2) √ßoklu BB i√ßinden bul
    if (Array.isArray(r.bbDetayList) && r.bbDetayList.length > 0) {
      const parts = [];
      r.bbDetayList.forEach((wrap, i) => {
        const label = valOr(wrap?.bbDetay?.bbNo, wrap?.baslik, `${i+1}. BB`);
        const mm = valOr(
          getByPath(wrap, "degerleme.degerlemeOzet.emsalFinalMetni"),
          getByPath(wrap, "degerleme.emsalFinalMetni")
        );
        if (mm) parts.push(`${label}:\n${mm}`);
      });
      if (parts.length) return parts.join("\n\n");
    }

    // 3) en son √ßare: derin arama
    return findDeepString(r, [
      "emsalfinalmetni",
      "emsalmetni",
      "analizmetni",
      "degerlemeanalizmetni"
    ]);
  }

  /* ========= KONUM/√áEVRE METNƒ∞ ========= */
  function getKonumMetni(r){
    // √∂nce en olasƒ± path‚Äôler
    let m = valOr(
      getByPath(r, "konumCevre.tamMetin"),
      getByPath(r, "konumVeCevre.tamMetin"),
      getByPath(r, "cevreOzellikleri.tamMetin"),
      getByPath(r, "konumCevreMetni"),
      getByPath(r, "konumMetni"),
      getByPath(r, "cevreMetni")
    );
    if (m) return m;

    // derinden anahtar ara
    return findDeepString(r, [
      "tammetin",
      "konumcevremetni",
      "konummetni",
      "cevremetni",
      "konumvecevremetni",
      "cevreozelliklerimetni"
    ]);
  }

  /* ========= TAPU METNƒ∞ ========= */
  function getTapuMetniB1(r){
    let m = valOr(
      r.tapuMetniB1,
      getByPath(r, "tapu.tapuMetniB1"),
      getByPath(r, "tapuMetinB1"),
      getByPath(r, "tapu.b1"),
      getByPath(r, "tapu.B1")
    );
    if (m) return m;
    return findDeepString(r, ["tapumetnib1", "tapub1", "tapu_b1"]);
  }

  function getTapuMetniB2(r){
    let m = valOr(
      r.tapuMetniB2,
      getByPath(r, "tapu.tapuMetniB2"),
      getByPath(r, "tapuMetinB2"),
      getByPath(r, "tapu.b2"),
      getByPath(r, "tapu.B2")
    );
    if (m) return m;
    return findDeepString(r, ["tapumetnib2", "tapub2", "tapu_b2"]);
  }

  /* ========= Rapor Bas ========= */
  function raporOlustur(){
    const today = new Date().toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('raporTarih').textContent = `Rapor Olu≈üturma: ${today}`;

    // GENEL
    document.getElementById('genelBilgi').innerHTML = `
      <div class="info-item"><strong>Ta≈üƒ±nmaz Adƒ±</strong><span>${valOr(report.propertyName,"...")}</span></div>
      <div class="info-item"><strong>ƒ∞l / ƒ∞l√ße</strong><span>${valOr(report.il,"-")} / ${valOr(report.ilce,"-")}</span></div>
      <div class="info-item"><strong>Ada / Parsel</strong><span>${valOr(report.ada,"...")} / ${valOr(report.parsel,"...")}</span></div>
      <div class="info-item"><strong>Arsa Alanƒ±</strong><span>${valOr(report.bina?.arsaAlani,"...")} m¬≤</span></div>
    `;

    // ƒ∞MAR
    document.getElementById('imarTablo').innerHTML = report.imarTablo || '<p class="empty">Veri yok.</p>';
    document.getElementById('imarMetin').textContent = duzeltTR(valOr(report.imarMetni));

    // BELGELER
    document.getElementById('belgelerMetin').textContent = duzeltTR(valOr(report.belgelerMetni, "Veri girilmedi."));

    // Bƒ∞NA
    document.getElementById('binaMetin').textContent = duzeltTR(valOr(report.bina?.metin, report.binaMetni, "Veri girilmedi."));

    // BB (tek + √ßoklu)
    document.getElementById('bbMetin').textContent = duzeltTR(valOr(combineBBMetin(report), "Veri girilmedi."));

    // KONUM/√áEVRE
    const konum = getKonumMetni(report);
    document.getElementById('konumMetin').textContent = duzeltTR(valOr(konum, "Veri girilmedi."));

    // TAPU
    document.getElementById('tapuMetinB1').textContent = duzeltTR(valOr(getTapuMetniB1(report), "Veri girilmedi."));
    document.getElementById('tapuMetinB2').textContent = duzeltTR(valOr(getTapuMetniB2(report), "Veri girilmedi."));

    // EMSAL / DEƒûERLEME
    const emsal = getEmsalMetni(report);
    document.getElementById('emsalMetin').textContent = duzeltTR(valOr(emsal, "Analiz tamamlanmadƒ±."));
  }

  function geriDon(){
    location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid || "");
  }

  // g√ºvenlik
  auth.onAuthStateChanged((user)=>{
    if(!user || !rid || !report){
      location.href = "index.html";
      return;
    }
    raporOlustur();
  });
</script>

</body>
</html>


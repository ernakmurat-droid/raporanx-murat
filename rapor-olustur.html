<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gayrimenkul Deƒüerleme Raporu - Testli Versiyon</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <script src="wallet.js"></script>

  <style>
    :root { --primary:#1a237e; --secondary:#3949ab; --accent:#ffd600; --bg:#f4f7f9; }
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:var(--bg);margin:0;color:#2c3e50}
    .header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:30px 20px;text-align:center;position:relative}
    .back{position:absolute;left:20px;top:25px;background:rgba(255,255,255,0.2);padding:8px 15px;border-radius:30px;color:#fff;text-decoration:none;font-weight:bold;cursor:pointer;border:none;font-size:13px}
    .main-wrapper{max-width:1300px;margin:20px auto;display:grid;grid-template-columns:280px 1fr;gap:30px;padding:0 20px}
    .toc-container{position:sticky;top:20px;height:fit-content}
    .toc{background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,0.05);border-left:6px solid var(--primary)}
    .toc-title{font-size:1.1em;font-weight:bold;color:var(--primary);margin-bottom:15px;border-bottom:1px solid #eee;padding-bottom:10px}
    .toc-list{list-style:none;padding:0;margin:0}
    .toc-list li{margin-bottom:8px}
    .toc-list a{color:#555;text-decoration:none;font-size:.9em;font-weight:500;transition:.2s;display:block;padding:5px;border-radius:4px}
    .toc-list a:hover{background:#f0f2ff;color:var(--primary);padding-left:10px}
    .container{background:#fff;padding:40px;border-radius:12px;box-shadow:0 0 40px rgba(0,0,0,0.05)}
    .section{margin-bottom:50px;padding-bottom:20px;border-bottom:1px solid #f0f0f0}
    .section-title{font-size:1.4em;font-weight:bold;color:var(--primary);margin-bottom:20px;display:flex;align-items:center}
    .section-title::after{content:"";flex:1;height:1px;background:#eee;margin-left:15px}
    .text-block{font-size:14.5px;line-height:1.7;white-space:pre-wrap;color:#34495e;text-align:justify}
    .print-btn{background:#27ae60;color:#fff;padding:15px 30px;font-size:18px;border:none;border-radius:50px;cursor:pointer;margin:40px auto;display:block;font-weight:bold;box-shadow:0 6px 15px rgba(39,174,96,.3);transition:.3s}
    .print-btn:hover{background:#219150;transform:translateY(-2px)}
    #lockBadge{padding:8px 12px;border-radius:8px;background:#0002;color:#000;font-weight:bold}
  </style>
</head>

<body>
  <div class="header">
    <button id="btnBack" class="back">‚Üê Y√∂netim Paneli</button>
    <h1>GAYRƒ∞MENKUL DEƒûERLEME RAPORU</h1>
    <div id="raporTarih"></div>
  </div>

  <div style="max-width:1200px;margin:20px auto;text-align:right;">
    <span id="lockBadge">üü° Taslak (Kilit yok)</span>
  </div>

  <main class="container">
    <div class="section" id="genel">
      <div class="section-title">1. Genel Bilgiler</div>
      <div class="text-block" id="genelBilgi"></div>
    </div>

    <div class="section" id="emsal">
      <div class="section-title">2. Deƒüerleme ve Sonu√ß Analizi</div>
      <div class="text-block" id="emsalMetin"></div>
    </div>

    <button class="print-btn" id="lockAndPrint">üìë RAPORU YAZDIR / Kƒ∞Lƒ∞TLE</button>
  </main>

<script>
  const TEST_MODE = true; // üëà TEST MODU: TRUE = HAK/PARA D√ú≈ûMEZ!

  const auth = firebase.auth();

  // üîπ Mock test data
  const report = {
    rid: "12345",
    emsalFinalMetni: "Bu ta≈üƒ±nmaz i√ßin piyasa analizi sonucunda emsal deƒüerleme yapƒ±lmƒ±≈ütƒ±r.",
    propertyName: "Test Gayrimenkul",
    isLocked: false
  };

  // üîπ Metin bi√ßimlendirici
  const formatMetin = (t) => (t || "").trim();

  // üîπ Hak d√º≈üme i≈ülemi
  const decreaseUserRight = async (uid, rid) => {
    if (TEST_MODE) {
      console.log("üß™ Test Modu: Hak d√º≈üme yapƒ±lmadƒ±.");
      return;
    }

    const key = `rapor_locked_${rid}`;
    if (localStorage.getItem(key)) return;

    try {
      await Wallet.load(uid);
      const info = Wallet.getSummary();

      if (info.freeLeft > 0) {
        await Wallet.decreaseFree(1);
        alert("üéüÔ∏è √úcretsiz hak kullanƒ±ldƒ±. Kalan: " + (info.freeLeft - 1));
      } else {
        const cost = 5;
        await Wallet.decreaseBalance(cost);
        alert(`üí∞ ${cost} TL d√º≈ü√ºld√º.`);
      }
      localStorage.setItem(key, "used");
    } catch (err) {
      console.error("Hak d√º≈üme hatasƒ±:", err);
    }
  };

  // üîπ Rapor Kilitle
  const lockReport = (rid) => {
    report.isLocked = true;
    localStorage.setItem(`report_${rid}`, JSON.stringify(report));
    document.getElementById("lockBadge").textContent = "üîí Kilitli (Artƒ±k d√ºzenlenemez)";
    alert("üîí Rapor kilitlendi ve deƒüi≈ütirilemez hale geldi!");
  };

  // üîπ Rapor g√∂ster
  const renderRapor = () => {
    document.getElementById("raporTarih").textContent =
      "Rapor Tarihi: " + new Date().toLocaleDateString("tr-TR");
    document.getElementById("genelBilgi").textContent =
      `${report.propertyName}\nRID: ${report.rid}`;
    document.getElementById("emsalMetin").textContent = formatMetin(report.emsalFinalMetni);
  };

  // üîπ Yazdƒ±rma ve kilitleme butonu
  document.getElementById("lockAndPrint").addEventListener("click", async () => {
    const user = auth.currentUser || { uid: "test_user" };
    await decreaseUserRight(user.uid, report.rid);
    lockReport(report.rid);
    window.print();
  });

  renderRapor();
</script>
</body>
</html>

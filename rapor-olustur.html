<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
<title>Gayrimenkul DeÄŸerleme Raporu</title>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<!-- âœ… Tek kaynak -->
<script src="/firebase-config.js"></script>
<script src="/wallet.js"></script>

<style>
:root{--primary:#1a237e;--secondary:#3949ab;--bg:#f4f7f9;}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);margin:0;color:#2c3e50;}
.header{
  background:linear-gradient(135deg,var(--primary),var(--secondary));
  color:#fff;
  padding: calc(30px + env(safe-area-inset-top, 0px)) 20px 30px;
  text-align:center;
  position:relative;
}
.header.locked{background:linear-gradient(135deg,#263238,#455a64);}
.back{
  position:absolute;left:20px;top: calc(25px + env(safe-area-inset-top, 0px));
  background:rgba(255,255,255,.2);padding:8px 15px;border-radius:30px;color:#fff;
  border:none;cursor:pointer;font-weight:900;
}
.badge{
  display:none;margin:10px auto 0;width:fit-content;padding:6px 10px;border-radius:999px;
  font-size:13px;font-weight:900;background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.22);
}
.main-wrapper{max-width:1300px;margin:14px auto 30px;display:grid;grid-template-columns:270px 1fr;gap:25px;padding:0 20px;}
.toc-container{position:sticky;top:20px;height:fit-content;}
.toc{background:#fff;padding:18px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.05);border-left:6px solid var(--primary);}
.toc-title{font-weight:bold;color:var(--primary);margin-bottom:10px;border-bottom:1px solid #eee;padding-bottom:6px;}
.toc ul{list-style:none;padding:0;margin:0;}
.toc li{margin:6px 0;}
.toc a{color:#444;text-decoration:none;font-size:.9em;display:block;padding:4px 6px;border-radius:4px;}
.toc a:hover{background:#f0f2ff;color:var(--primary);}
.container{background:#fff;padding:35px;border-radius:12px;box-shadow:0 0 25px rgba(0,0,0,.05);}
.section{margin-bottom:45px;}
.section h2{color:var(--primary);border-bottom:2px solid #eee;padding-bottom:8px;font-size:1.2em;}
.text-block{white-space:pre-wrap;font-size:15px;line-height:1.6;color:#34495e;}
.warning{background:#fff8e1;border-left:4px solid #ffc107;padding:10px;margin:8px 0;}
.print-btn{background:#27ae60;color:#fff;padding:13px 26px;border:none;border-radius:50px;margin:10px auto;display:block;cursor:pointer;font-weight:900;}
.print-btn:hover{background:#1e874e;}
.action-btn{
  background:#ff5722;color:#fff;padding:13px 26px;border:none;border-radius:50px;
  margin:10px auto 0;display:block;cursor:pointer;font-weight:900;
}
.action-btn:hover{opacity:.92;}
.action-btn:disabled{opacity:.55;cursor:not-allowed;}
#statusBar{
  max-width:1300px;margin:12px auto 0;padding:10px 14px;border-radius:12px;background:#fff;
  box-shadow:0 4px 14px rgba(0,0,0,.06);border-left:6px solid var(--secondary);
  color:#2c3e50;font-weight:900;
}
#statusBar small{display:block;font-weight:700;opacity:.88;margin-top:4px}
@media(max-width:992px){.main-wrapper{grid-template-columns:1fr;}.toc-container{position:relative;margin-bottom:15px;}}
@media print{
  .header,.toc-container,.print-btn,.action-btn,#statusBar{display:none!important;}
  body{background:#fff;}
  .container{box-shadow:none;padding:0;width:100%;}
  .section{page-break-inside:avoid;}
}
</style>
</head>

<body>

<div class="header" id="hdr">
  <button class="back" id="btnBack">â† Geri</button>
  <h1 style="margin:0;">GAYRÄ°MENKUL DEÄERLEME RAPORU</h1>
  <div id="raporTarih" style="margin-top:6px;"></div>
  <div id="finalBadge" class="badge">ğŸ”’ FINAL / KÄ°LÄ°TLÄ°</div>
</div>

<div id="statusBar">
  HazÄ±r.
  <small>Rapor metinleri yÃ¼kleniyorâ€¦</small>
</div>

<div class="main-wrapper">
  <aside class="toc-container">
    <div class="toc">
      <div class="toc-title">ğŸ“‹ RAPOR BÃ–LÃœMLERÄ°</div>
      <ul>
        <li><a href="#genel">1. Genel Bilgiler</a></li>
        <li><a href="#imar">2. Ä°mar Durumu</a></li>
        <li><a href="#belgeler">3. Belgeler</a></li>
        <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
        <li><a href="#bb">5. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m</a></li>
        <li><a href="#konum">6. Konum Analizi</a></li>
        <li><a href="#tapu">7. Tapu Bilgileri</a></li>
        <li><a href="#emsal">8. DeÄŸerleme / Emsal</a></li>
      </ul>
    </div>
  </aside>

  <main class="container">
    <button class="print-btn" onclick="window.print()">ğŸ“„ YazdÄ±r / PDF Kaydet</button>

    <button class="action-btn" id="btnFinalCreate" disabled>ğŸ§¾ Final Rapor OluÅŸtur (Hak DÃ¼ÅŸ + Kilitle)</button>

    <!-- âœ… Word gibi dÃ¼zenleme -->
    <button class="action-btn" id="btnEditText" style="background:#1976d2;">âœï¸ Final Metni DÃ¼zenle</button>
    <button class="action-btn" id="btnSaveText" style="background:#6d4c41; display:none;">ğŸ’¾ DÃ¼zenlemeyi Kaydet</button>

    <section id="genel" class="section">
      <h2>1. Genel Bilgiler</h2>
      <div id="genelBilgi"></div>
    </section>

    <section id="imar" class="section">
      <h2>2. Ä°mar Durumu</h2>
      <div id="imarTablo"></div>
      <div class="text-block" id="imarMetin"></div>
    </section>

    <section id="belgeler" class="section">
      <h2>3. Belgeler</h2>
      <div class="text-block" id="belgelerMetin"></div>
    </section>

    <section id="bina" class="section">
      <h2>4. Ana Bina Bilgileri</h2>
      <div class="text-block" id="binaMetin"></div>
    </section>

    <section id="bb" class="section">
      <h2>5. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m</h2>
      <div class="text-block" id="bbMetin"></div>
    </section>

    <section id="konum" class="section">
      <h2>6. Konum Analizi</h2>
      <div class="text-block" id="konumMetin"></div>
    </section>

    <section id="tapu" class="section">
      <h2>7. Tapu Bilgileri</h2>
      <div class="text-block" id="tapuMetinB1"></div>
      <div class="text-block" id="tapuMetinB2"></div>
    </section>

    <section id="emsal" class="section">
      <h2>8. DeÄŸerleme / Emsal</h2>
      <div class="text-block" id="emsalMetin"></div>
    </section>
  </main>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const auth = window.auth || firebase.auth();
  const db   = window.db   || firebase.firestore();
  const $ = (id) => document.getElementById(id);

  function setStatus(title, sub){
    const el = $("statusBar");
    el.textContent = title;
    const sm = document.createElement("small");
    sm.textContent = sub || "";
    el.appendChild(sm);
  }

  const params = new URLSearchParams(location.search);
  const rid = (params.get("rid") || params.get("id") || "").toString().trim();
  const confirmParam = params.get("confirm") === "1";

  $("btnBack").onclick = () => {
    if (!rid) location.href="/index.html";
    else location.href="/rapor-detay.html?rid=" + encodeURIComponent(rid);
  };

  if (!rid){
    setStatus("âŒ rid yok.", "Ana sayfaya dÃ¶n.");
    alert("Rapor id (rid) bulunamadÄ±!");
    return;
  }

  /* ===============================
     âœ… KÄ°LÄ°T MOTORU (TEMÄ°Z)
  =============================== */
  function normRid(x){ return String(x||"").trim(); }
  function lockKey(){ return "report_locked_" + normRid(rid); }

  // âœ… daha saÄŸlam local kilit kontrol
  function isLockedLocal(){
    const v = String(localStorage.getItem(lockKey()) || "").trim();
    return (v === "1" || v === "true" || v === "locked");
  }

  function applyLockedUIBadge(){
    $("finalBadge").style.display = "block";
    $("hdr").classList.add("locked");
  }

  // âœ… index.html bunu okuyor â†’ en garanti kilit burasÄ±
  function setLockedLocalHard(){
    localStorage.setItem(lockKey(), "1");

    // rapor listesine de yaz
    try{
      let arr = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]");
      if(!Array.isArray(arr)) arr = [];
      const ridN = normRid(rid);
      const i = arr.findIndex(r => normRid(r?.rid) === ridN);
      const patch = {
        final:true, locked:true, isLocked:true,
        lockedAt: Date.now(),
        updatedAt: new Date().toISOString()
      };
      if(i >= 0){
        arr[i] = { ...(arr[i]||{}), ...patch };
      }else{
        arr.unshift({ rid: ridN, propertyName: document.title || "Rapor", ...patch });
      }
      localStorage.setItem("gayrimenkul_reports", JSON.stringify(arr));
    }catch(e){ console.warn("local lock write fail:", e); }

    applyLockedUIBadge();
  }

  async function setLockedRemoteHard(uid){
    const now = firebase.firestore.FieldValue.serverTimestamp();
    const ridN = normRid(rid);

    const lockPatch = {
      final: true, locked: true, isLocked: true,
      lockedAt: now,
      updatedAt: new Date().toISOString()
    };

    // 1) locks koleksiyonu (olursa olur)
    try{
      await db.collection("locks").doc(`${uid}_${ridN}`).set({ uid, rid: ridN, locked:true, createdAt: now }, { merge:true });
    }catch(e){ console.warn("locks write fail:", e); }

    async function updateDoc(path){
      const ref = db.collection(path).doc(uid);
      const snap = await ref.get();
      const d = snap.exists ? (snap.data() || {}) : {};
      const raw = d.gayrimenkul_reports;

      let arr = [];
      if(Array.isArray(raw)) arr = raw;
      else if(raw && typeof raw === "object") arr = Object.values(raw);

      const i = arr.findIndex(r => normRid(r?.rid) === ridN);
      if(i >= 0) arr[i] = { ...(arr[i]||{}), ...lockPatch };
      else arr.unshift({ rid: ridN, ...lockPatch });

      await ref.set({ gayrimenkul_reports: arr, lastUpdate: new Date().toISOString() }, { merge:true });
    }

    // index'in ana kaynaÄŸÄ±: kullanicilar
    let ok = false;
    try{ await updateDoc("kullanicilar"); ok = true; }catch(e){ console.warn("kullanicilar lock fail:", e); }
    if(!ok){
      try{ await updateDoc("users"); ok = true; }catch(e){ console.warn("users lock fail:", e); }
    }

    return ok;
  }

  async function isLockedRemoteHard(uid){
    const ridN = normRid(rid);

    // 1) locks doc
    try{
      const s = await db.collection("locks").doc(`${uid}_${ridN}`).get();
      if(s.exists && s.data()?.locked === true) return true;
    }catch(e){}

    // 2) kullanicilar/users gayrimenkul_reports iÃ§i
    async function checkDoc(path){
      const snap = await db.collection(path).doc(uid).get();
      if(!snap.exists) return false;
      const d = snap.data() || {};
      const raw = d.gayrimenkul_reports;
      let arr = [];
      if(Array.isArray(raw)) arr = raw;
      else if(raw && typeof raw === "object") arr = Object.values(raw);

      const rep = arr.find(r => normRid(r?.rid) === ridN);
      return !!(rep && (rep.final===true || rep.locked===true || rep.isLocked===true));
    }

    try{ if(await checkDoc("kullanicilar")) return true; }catch(e){}
    try{ if(await checkDoc("users")) return true; }catch(e){}

    return false;
  }

  // âœ… wrapper: eski Ã§aÄŸrÄ±lar boÅŸa dÃ¼ÅŸmesin
  function setLockedLocal(){ setLockedLocalHard(); }
  async function setLockedRemote(uid){ return await setLockedRemoteHard(uid); }
  async function isLockedRemote(uid){ return await isLockedRemoteHard(uid); }

  /* ===============================
     âœ… METÄ°N/VERÄ° YARDIMCILARI
  =============================== */
  function formatMetin(t){
    if (t === null || t === undefined) return "";
    const s = String(t);
    return s.replace(/\r\n/g,"\n").replace(/[ \t]+\n/g,"\n").replace(/\n{3,}/g,"\n\n").trim();
  }

  function pick(obj, ...paths){
    for (const p of paths){
      try{
        const keys = p.split('.');
        let val = obj;
        for (const key of keys) {
          if (val === null || val === undefined) break;
          val = val[key];
        }
        if (val !== null && val !== undefined && val !== '' && String(val).trim() !== "")
          return val;
      }catch(e){}
    }
    return "";
  }

  function buildBBTextFromDetay(d){
    d = d || {};
    const v = (k) => (d[k] ?? "").toString().trim();
    const n = (k) => {
      const x = Number(v(k));
      return Number.isFinite(x) ? x : 0;
    };

    const kat = v("kat") || "...";
    const bbNo = v("bbNo") || "...";
    const kapiNo = v("kapiNo") || "...";
    const nitelik = v("nitelik") || "...";
    const konum = v("konum") || "...";

    const cepheler = Array.isArray(d.cepheler) ? d.cepheler : [];
    const cepheText = cepheler.length ? cepheler.join(", ") : "...";

    const net = n("alanNet");
    const brut = n("alanBrut");
    const netParca = net > 0 ? `net ${net} ` : "";
    const brutParca = `brÃ¼t ${brut} mÂ²`;

    const sayi = (k) => parseInt(v(k) || "0", 10) || 0;
    const hacimler = [
      sayi("count_salon")  ? `${sayi("count_salon")} adet salon` : "",
      sayi("count_oda")    ? `${sayi("count_oda")} adet oda` : "",
      sayi("count_mutfak") ? `${sayi("count_mutfak")} adet mutfak` : "",
      sayi("count_banyo")  ? `${sayi("count_banyo")} adet banyo` : "",
      sayi("count_wc")     ? `${sayi("count_wc")} adet wc` : "",
      sayi("count_antre")  ? `${sayi("count_antre")} adet antre/hol` : "",
      sayi("count_balkon") ? `${sayi("count_balkon")} adet balkon` : ""
    ].filter(Boolean).join(", ") || "...";

    const antreZemin = v("antreZemin") || "...";
    const antreDuvar = v("antreDuvar") || "...";
    const salonZemin = v("salonZemin") || "...";
    const salonDuvar = v("salonDuvar") || "...";
    const odaZemin = v("odaZemin") || "...";
    const odaDuvar = v("odaDuvar") || "...";
    const mutfakZemin = v("mutfakZemin") || "...";
    const mutfakDuvar = v("mutfakDuvar") || "...";
    const mutfakDolap = v("mutfakDolap") || "...";
    const mutfakTezgah = v("mutfakTezgah") || "...";
    const islakHacim = v("islakHacim") || "...";
    const banyoDonanim = v("banyoDonanim") || "...";
    const girisKapi = v("daireKapi") || "...";
    const icKapi = v("icKapi") || "...";
    const pencere = v("pencere") || "...";
    const isitma = v("isitma") || "...";

    const tesisatVar = (d.tesisatVar || "evet").toString();
    const tesisatAciklama = v("tesisatAciklama");
    const tesisatMetin = (tesisatVar === "evet") ? "mevcuttur" : (tesisatAciklama || "...");

    const metin =
`DeÄŸerleme konusu taÅŸÄ±nmaz binanÄ±n ${kat} katÄ±nda yer alan ${bbNo} baÄŸÄ±msÄ±z bÃ¶lÃ¼m ve ${kapiNo} kapÄ± numaralÄ± ${nitelik} nitelikli taÅŸÄ±nmazdÄ±r. Bina giriÅŸine gÃ¶re ${konum} yer almaktadÄ±r. ${cepheText} cephelidir. Projesinde ve yerinde yapÄ±lan tespit ve Ã¶lÃ§Ã¼mlere gÃ¶re ${netParca}${brutParca} kullanÄ±m alanÄ±na sahiptir. TaÅŸÄ±nmaz ${hacimler} hacimlerinden oluÅŸmaktadÄ±r. TaÅŸÄ±nmazÄ±n antre ve hol zeminleri ${antreZemin} duvarlarÄ± ${antreDuvar}. Salon zemini ${salonZemin}, duvarlarÄ± ${salonDuvar} oda zeminleri ${odaZemin} duvarlarÄ± ${odaDuvar}. Mutfak zemini ${mutfakZemin} ve duvarlarÄ± ${mutfakDuvar} malzemedir. Mutfak dolabÄ± ${mutfakDolap} tezgÃ¢hÄ± ${mutfakTezgah} malzemedir. TaÅŸÄ±nmazÄ±n Ä±slak hacimlerin zeminleri ve duvarlarÄ± ${islakHacim}. Banyoda ${banyoDonanim} bulunmaktadÄ±r. TaÅŸÄ±nmazÄ±n giriÅŸ kapÄ±sÄ± ${girisKapi} ve iÃ§ kapÄ±larÄ± ${icKapi}. Pencereleri ise ${pencere} doÄŸramadÄ±r. Elektrik, su ve haberleÅŸme tesisatlarÄ± ${tesisatMetin} durumdaki gayrimenkulÃ¼n Ä±sÄ±tÄ±lmasÄ± ${isitma} ile saÄŸlanmaktadÄ±r.`;

    return formatMetin(metin);
  }

  function getBagimsizBolumMetni(rep){
    const topluMetin = formatMetin(pick(rep, "modules.bagimsizBolum.text", "bagimsizBolumMetni"));
    if (topluMetin) return topluMetin;

    const list = Array.isArray(rep?.bbDetayList) ? rep.bbDetayList :
                 Array.isArray(rep?.bbList) ? rep.bbList : [];

    if (list.length === 0) return "BaÄŸÄ±msÄ±z bÃ¶lÃ¼m verisi bulunamadÄ±";

    return list.map((bb, i) => {
      const baslik = bb?.baslik || bb?.title || `${i+1}. BaÄŸÄ±msÄ±z BÃ¶lÃ¼m`;
      const d = bb?.bbDetay || bb || {};

      const savedText = formatMetin(pick(bb, "taslakMetin", "metin", "bbDetay.taslakMetin"));
      if (savedText) return `### ${baslik} ###\n${savedText}`;

      return `### ${baslik} ###\n${buildBBTextFromDetay(d)}`;
    }).join("\n\n");
  }

  function emsalMetni(rep){
    const modDirect = pick(rep, "modules.emsal.text", "emsalFinalMetni");
    if (modDirect) return formatMetin(modDirect);

    const list = Array.isArray(rep?.bbDetayList) ? rep.bbDetayList :
                 Array.isArray(rep?.bbList) ? rep.bbList : [];

    return list.map((bb, i) => {
      const t = pick(bb, "degerlemeOzet.emsalFinalMetni", "emsalFinalMetni");
      return t ? `[${bb.baslik || 'BB '+(i+1)}] emsal:\n${formatMetin(t)}` : null;
    }).filter(Boolean).join("\n\n") || "Emsal analizi bulunamadÄ±";
  }

  function render(r){
    $("raporTarih").textContent = "Tarih: " + new Date().toLocaleDateString("tr-TR");

    $("genelBilgi").innerHTML = `
      <div><b>Ä°l / Ä°lÃ§e:</b> ${pick(r,"il") || "-"} / ${pick(r,"ilce") || "-"}</div>
      <div><b>Ada / Parsel:</b> ${pick(r,"ada") || "-"} / ${pick(r,"parsel") || "-"}</div>
      <div><b>TaÅŸÄ±nmaz:</b> ${pick(r,"propertyName","tasÄ±nmazAdi","tasinmazAdi") || "TanÄ±msÄ±z"}</div>
    `;

    $("imarTablo").innerHTML = pick(r,"imarTablo") || "<div class='warning'>Ä°mar tablosu bulunamadÄ±</div>";
    $("imarMetin").textContent = formatMetin(pick(r,"imarMetni","imar.metin"));

    $("belgelerMetin").textContent = formatMetin(pick(r,"belgelerMetni","belgeler.metin"));
    $("binaMetin").textContent = formatMetin(pick(r,"bina.metin","binaMetni"));

    $("bbMetin").textContent = getBagimsizBolumMetni(r);
    $("konumMetin").textContent = formatMetin(pick(r,"konumCevre.tamMetin","konumMetni"));
    $("tapuMetinB1").textContent = formatMetin(pick(r,"tapuMetniB1","tapu.b1"));
    $("tapuMetinB2").textContent = formatMetin(pick(r,"tapuMetniB2","tapu.b2"));
    $("emsalMetin").textContent = emsalMetni(r);
  }

  function loadReportLocal(){
    let raporlar = [];
    try{ raporlar = JSON.parse(localStorage.getItem("gayrimenkul_reports") || "[]"); }catch{ raporlar = []; }
    return raporlar.find(r => String(r?.rid ?? "").trim() === rid) || null;
  }

  async function loadReportRemote(uid){
    // fallbackler
    try{
      const snap = await db.collection("users").doc(uid).collection("reports").doc(rid).get();
      if (snap.exists) return snap.data();
    }catch(e){}

    try{
      const snap2 = await db.collection("reports").doc(rid).get();
      if (snap2.exists) return snap2.data();
    }catch(e){}

    // âœ… asÄ±l kaynak: kullanicilar/{uid}.gayrimenkul_reports
    try{
      const s = await db.collection("kullanicilar").doc(uid).get();
      if(s.exists){
        const d = s.data() || {};
        const raw = d.gayrimenkul_reports;
        let arr = [];
        if(Array.isArray(raw)) arr = raw;
        else if(raw && typeof raw === "object") arr = Object.values(raw);

        const rep = arr.find(r => String(r?.rid||"").trim() === String(rid));
        if(rep) return rep;
      }
    }catch(e){}

    return null;
  }

  /* ===============================
     âœ… Word gibi dÃ¼zenleme (local)
  =============================== */
  const EDIT_KEY = "final_report_edits_" + rid;

  function getEditableBlocks(){
    return ["imarMetin","belgelerMetin","binaMetin","bbMetin","konumMetin","tapuMetinB1","tapuMetinB2","emsalMetin"]
      .map(id => document.getElementById(id))
      .filter(Boolean);
  }

  function loadEdits(){
    try{
      const data = JSON.parse(localStorage.getItem(EDIT_KEY) || "{}");
      for(const [id, txt] of Object.entries(data)){
        const el = document.getElementById(id);
        if(el) el.textContent = String(txt ?? "");
      }
    }catch(e){}
  }

  function setEditMode(on){
    getEditableBlocks().forEach(el=>{
      el.contentEditable = on ? "true" : "false";
      el.style.outline = on ? "2px dashed rgba(25,118,210,.55)" : "none";
      el.style.padding = on ? "8px" : "";
      el.style.borderRadius = on ? "10px" : "";
      el.style.background = on ? "rgba(25,118,210,.06)" : "";
    });
    $("btnSaveText").style.display = on ? "block" : "none";
  }

  function saveEdits(){
    const data = {};
    getEditableBlocks().forEach(el=>{
      data[el.id] = el.textContent || "";
    });
    localStorage.setItem(EDIT_KEY, JSON.stringify(data));
  }

  /* ===============================
     âœ… FINAL AKIÅI
  =============================== */
  let finalizing = false;

  async function finalizeFlow(user){
    if (finalizing) return;
    finalizing = true;
    try{
      let rep = loadReportLocal() || await loadReportRemote(user.uid);
      if (!rep){ setStatus("âŒ Rapor yok.", "rid bulunamadÄ±."); return; }

      render(rep);
      loadEdits();

      const locked = isLockedLocal() || await isLockedRemote(user.uid);
      if (locked){
        setLockedLocal();
        setStatus("ğŸ”’ Zaten kilitli.", "Final yapÄ±lmÄ±ÅŸ.");
        return;
      }

      if (!confirmParam){
        if (!confirm("Final rapor oluÅŸturulduÄŸunda hak dÃ¼ÅŸebilir ve rapor kilitlenir. Devam?")) return;
      }

      setStatus("ğŸ’³ Hak dÃ¼ÅŸÃ¼rÃ¼lÃ¼yorâ€¦", "CÃ¼zdan kontrolÃ¼ yapÄ±lÄ±yor.");
      const res = await Wallet.consumeReport(user.uid, rid);
      if (!res){
        setStatus("âŒ BaÅŸarÄ±sÄ±z!", "Hak/Bakiye yetersiz veya iÅŸlem baÅŸarÄ±sÄ±z.");
        return;
      }

      // âœ… kilitle (local + remote)
      setLockedLocal();
      await setLockedRemote(user.uid);

      setStatus("âœ… Kilitlendi.", "Rapor final yapÄ±ldÄ±. Ä°stersen metni dÃ¼zenleyip PDF alabilirsin.");
    } finally {
      finalizing = false;
    }
  }

  async function boot(){
    const user = await new Promise((resolve)=> auth.onAuthStateChanged(u=> resolve(u)));
    if (!user){ alert("GiriÅŸ yok!"); location.href="/index.html"; return; }

    let rep = loadReportLocal() || await loadReportRemote(user.uid);
    if (!rep){ setStatus("âŒ Rapor yok.", `rid: ${rid}`); return; }

    render(rep);
    loadEdits();

    // âœ… dÃ¼zenleme butonlarÄ± her zaman aÃ§Ä±k
    $("btnEditText").onclick = ()=>{
      setEditMode(true);
      setStatus("âœï¸ DÃ¼zenleme aÃ§Ä±k", "Metin alanlarÄ±na tÄ±kla yaz. Bitince Kaydet.");
    };
    $("btnSaveText").onclick = ()=>{
      saveEdits();
      setEditMode(false);
      setStatus("ğŸ’¾ Kaydedildi", "Bu cihazda saklandÄ±. PDF alabilirsin.");
    };

    const locked = isLockedLocal() || await isLockedRemote(user.uid);

    if (locked){
      setLockedLocal(); // badge + header rengi
      setStatus("ğŸ”’ Kilitli.", "Bu rapor final yapÄ±lmÄ±ÅŸ. Metni dÃ¼zenleyip PDF alabilirsin.");
      $("btnFinalCreate").disabled = true;
    } else {
      setStatus("âœ… HazÄ±r.", "Final butonunu kullanÄ±n.");
      const btn = $("btnFinalCreate");
      btn.disabled = false;
      btn.onclick = () => finalizeFlow(user);
    }

    if (confirmParam) setTimeout(()=> finalizeFlow(user), 150);
  }

  boot().catch((e)=>{
    console.error(e);
    setStatus("âš ï¸ Hata", e?.message || String(e));
  });
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Wallet (senin dosyan) -->
  <script src="wallet.js"></script>

  <title>Final Raporu Olu≈üturucu - Raporan X</title>

  <style>
    :root { --primary:#1a237e; --secondary:#3949ab; --accent:#ffd600; --bg:#f4f7f9; --danger:#c62828; --ok:#2e7d32; }
    body { font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; color:#2c3e50; scroll-behavior:smooth; }

    .header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:30px 20px; text-align:center; position:relative; z-index:10; }
    .back { position:absolute; left:20px; top:25px; background:rgba(255,255,255,0.2); padding:8px 15px; border-radius:30px; color:#fff; text-decoration:none; font-weight:bold; cursor:pointer; border:none; font-size:13px; }

    .topbar2{
      max-width:1300px; margin:12px auto 0; padding:0 20px;
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    #walletBar{
      flex:1 1 520px;
      background:rgba(255,255,255,0.16);
      color:#fff;
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      padding:10px 12px;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      cursor:pointer;
      user-select:none;
    }
    #walletBar small{ opacity:.85; }
    #walletDetails{
      margin-top:8px;
      display:none;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.18);
      border-radius:12px;
      padding:10px 12px;
      line-height:1.4;
    }

    #lockBadge{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.18);
      color:#fff;
      font-weight:900;
      box-shadow:0 8px 20px rgba(0,0,0,0.18);
      user-select:none;
    }

    .main-wrapper { max-width:1300px; margin:20px auto; display:grid; grid-template-columns:280px 1fr; gap:30px; padding:0 20px; }

    .toc-container { position:sticky; top:20px; height:fit-content; }
    .toc { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); border-left:6px solid var(--primary); }
    .toc-title { font-size:1.1em; font-weight:bold; color:var(--primary); margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px; }
    .toc-list { list-style:none; padding:0; margin:0; }
    .toc-list li { margin-bottom:8px; }
    .toc-list a { color:#555; text-decoration:none; font-size:.9em; font-weight:500; transition:.2s; display:block; padding:5px; border-radius:4px; }
    .toc-list a:hover { background:#f0f2ff; color:var(--primary); padding-left:10px; }

    .container { background:#fff; padding:40px; border-radius:12px; box-shadow:0 0 40px rgba(0,0,0,0.05); }
    .section { margin-bottom:50px; padding-bottom:20px; border-bottom:1px solid #f0f0f0; page-break-inside:avoid; }
    .section-title { font-size:1.4em; font-weight:bold; color:var(--primary); margin-bottom:20px; display:flex; align-items:center; }
    .section-title::after { content:""; flex:1; height:1px; background:#eee; margin-left:15px; }

    .info-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; margin-bottom:25px; }
    .info-item { background:#fcfcfc; border:1px solid #f0f0f0; padding:12px; border-radius:6px; }
    .info-item strong { display:block; color:#888; font-size:.75em; text-transform:uppercase; margin-bottom:3px; }
    .info-item span { font-weight:600; font-size:.95em; color:#2c3e50; }

    #imarTablo table { width:100% !important; border-collapse:collapse; margin:15px 0; font-size:12px !important; }
    #imarTablo table th, #imarTablo table td { border:1px solid #dcdde1; padding:6px 10px !important; line-height:1.2; }
    #imarTablo table th { background:#f8f9fa; color:#444; width:30%; }

    .text-block { font-size:14.5px; line-height:1.7; white-space:pre-wrap; color:#34495e; text-align:justify; }
    .format-badge { background:#546e7a; color:#fff; padding:3px 10px; border-radius:4px; font-size:11px; margin-bottom:10px; display:inline-block; }

    .print-btn { background:#27ae60; color:#fff; padding:15px 30px; font-size:18px; border:none; border-radius:50px; cursor:pointer; margin:40px auto 10px; display:block; font-weight:bold; box-shadow:0 6px 15px rgba(39,174,96,.3); transition:.3s; }
    .print-btn:hover { background:#219150; transform:translateY(-2px); }

    .warn-btn{
      background:var(--danger);
      color:#fff;
      padding:12px 18px;
      font-weight:900;
      border:none;
      border-radius:14px;
      cursor:pointer;
      box-shadow:0 6px 15px rgba(198,40,40,.28);
    }

    @media print {
      body { background:#fff; }
      .header, .back, .print-btn, .toc-container, .topbar2, .warn-btn { display:none !important; }
      .main-wrapper { display:block; max-width:100%; margin:0; padding:0; }
      .container { box-shadow:none; padding:0; margin:0; width:100%; }
      .section-title { color:#000; border-bottom:2px solid #000; }
      #imarTablo table { font-size:10px !important; }
    }

    @media (max-width: 992px) {
      .main-wrapper { grid-template-columns:1fr; }
      .toc-container { position:relative; top:0; margin-bottom:20px; }
    }
  </style>
</head>

<body>
  <div class="header">
    <button id="btnBack" class="back">‚Üê Y√∂netim Paneli</button>
    <h1 style="margin:0; font-size:1.8em; letter-spacing:1px;">GAYRƒ∞MENKUL DEƒûERLEME RAPORU</h1>
    <div id="raporTarih" style="margin-top:8px; opacity:.8; font-size:13px;"></div>
  </div>

  <div class="topbar2">
    <div id="walletBar" title="C√ºzdan detayƒ±nƒ± g√∂rmek i√ßin tƒ±kla">
      C√ºzdan y√ºkleniyor...
      <div id="walletDetails"></div>
    </div>

    <div style="display:flex; gap:10px; align-items:center;">
      <button class="warn-btn" id="btnWarn">‚ö†Ô∏è Uyarƒ±</button>
      <div id="lockBadge">üîí Banka Taslaƒüƒ±</div>
    </div>
  </div>

  <div class="main-wrapper">
    <aside class="toc-container">
      <div class="toc">
        <div class="toc-title">RAPOR B√ñL√úMLERƒ∞</div>
        <ul class="toc-list">
          <li><a href="#genel">1. Genel Bilgiler</a></li>
          <li><a href="#imar">2. ƒ∞mar Durumu</a></li>
          <li><a href="#belgeler">3. ƒ∞ncelenen Belgeler</a></li>
          <li><a href="#bina">4. Ana Bina Bilgileri</a></li>
          <li><a href="#bb">5. Baƒüƒ±msƒ±z B√∂l√ºm</a></li>
          <li><a href="#konum">6. Konum Analizi</a></li>
          <li><a href="#tapu">7. Tapu Kayƒ±tlarƒ±</a></li>
          <li><a href="#emsal">8. Deƒüerleme Sonucu</a></li>
        </ul>
      </div>
    </aside>

    <main class="container">
      <div class="section" id="genel">
        <div class="section-title">1. Gayrimenkul Genel Bilgileri</div>
        <div class="info-grid" id="genelBilgi"></div>
      </div>

      <div class="section" id="imar">
        <div class="section-title">2. ƒ∞mar Durumu Verileri</div>
        <div id="imarTablo"></div>
        <div class="text-block" id="imarMetin"></div>
      </div>

      <div class="section" id="belgeler">
        <div class="section-title">3. ƒ∞ncelenen Belgeler</div>
        <div class="text-block" id="belgelerMetin"></div>
      </div>

      <div class="section" id="bina">
        <div class="section-title">4. Ana Gayrimenkul Bilgileri</div>
        <div class="text-block" id="binaMetin"></div>
      </div>

      <div class="section" id="bb">
        <div class="section-title">5. Baƒüƒ±msƒ±z B√∂l√ºm Analizi</div>
        <div class="text-block" id="bbMetin"></div>
      </div>

      <div class="section" id="konum">
        <div class="section-title">6. Konum ve √áevre Analizi</div>
        <div class="text-block" id="konumMetin"></div>
      </div>

      <div class="section" id="tapu">
        <div class="section-title">7. Tapu ve Takyidat Kayƒ±tlarƒ±</div>
        <div class="format-badge">BANKA FORMATI B1</div>
        <div class="text-block" id="tapuMetinB1" style="margin-bottom:25px;"></div>
        <div class="format-badge">BANKA FORMATI B2</div>
        <div class="text-block" id="tapuMetinB2"></div>
      </div>

      <div class="section" id="emsal">
        <div class="section-title">8. Deƒüerleme ve Sonu√ß Analizi</div>
        <div class="text-block" id="emsalMetin"></div>
      </div>

      <button class="print-btn" onclick="window.print()">üìë RAPORU YAZDIR / PDF OLARAK KAYDET</button>
    </main>
  </div>

<script>
  // Firebase
  const auth = firebase.auth();
  const db = firebase.firestore();

  // URL Params
  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  const legacyId = urlParams.get('id');

  // ‚úÖ Onay parametresi: sadece rapor-detay √ºzerinden ‚Äúevet‚Äù denince gelir
  const confirmed = (urlParams.get("confirm") === "1");

  // =========================
  // RID Helpers
  // =========================
  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed=false;
    (arr||[]).forEach(r=>{ if(r && !r.rid){ r.rid = genRid(); changed=true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr||[]).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  // legacy ?id= -> rid
  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      const file = (location.pathname.split("/").pop() || "rapor-olustur.html");
      window.location.replace(file + "?rid=" + encodeURIComponent(rid));
    }
  }

  function getLatestData(){
    const arr = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
    const i = rid ? findIndexByRid(arr, rid) : -1;
    const r = (i >= 0) ? (arr[i] || null) : null;
    return { arr, i, r };
  }
  function persist(arr, i, r){
    arr[i] = r;
    localStorage.setItem('gayrimenkul_reports', JSON.stringify(arr));
  }

  // =========================
  // Text cleanup
  // =========================
  function trDuzelt(txt){
    let t = (txt || "").toString();
    if (!t.trim()) return "";
    t = t.replace(/\s+\n/g, "\n").replace(/\n{3,}/g, "\n\n");
    t = t.replace(/\s{2,}/g, " ");
    t = t.replace(/\s+\./g, ".").replace(/\s+,/g, ",");
    t = t.replace(/ :/g, ":").replace(/ ;/g, ";");
    return t.trim();
  }

  // ‚úÖ EMSAL: SADECE TEK METƒ∞N (BB gezmek YOK!)
  function emsalMetniBul(report){
    const direct1 = report?.emsalFinalMetni;
    if (direct1 && String(direct1).trim()) return trDuzelt(direct1);

    const direct2 = report?.degerlemeOzet?.emsalFinalMetni;
    if (direct2 && String(direct2).trim()) return trDuzelt(direct2);

    return "Analiz tamamlanmadƒ±.";
  }

  // =========================
  // Render report
  // =========================
  function raporOlustur(report){
    const today = new Date().toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' });
    document.getElementById('raporTarih').textContent = `Rapor Olu≈üturma: ${today}`;

    document.getElementById('genelBilgi').innerHTML = `
      <div class="info-item"><strong>Ta≈üƒ±nmaz Adƒ±</strong><span>${report.propertyName || "..."}</span></div>
      <div class="info-item"><strong>ƒ∞l / ƒ∞l√ße</strong><span>${report.il || "-"} / ${report.ilce || "-"}</span></div>
      <div class="info-item"><strong>Ada / Parsel</strong><span>${report.ada || "..."} / ${report.parsel || "..."}</span></div>
      <div class="info-item"><strong>Arsa Alanƒ±</strong><span>${report.bina?.arsaAlani || "..."} m¬≤</span></div>
    `;

    document.getElementById('imarTablo').innerHTML = report.imarTablo || "<p>Veri yok.</p>";
    document.getElementById('imarMetin').textContent = trDuzelt(report.imarMetni || "");

    document.getElementById('belgelerMetin').textContent = trDuzelt(report.belgelerMetni || "Veri girilmedi.");
    document.getElementById('binaMetin').textContent = trDuzelt(report.bina?.metin || "Veri girilmedi.");

    let bbText = "";
    if (Array.isArray(report.bbDetayList) && report.bbDetayList.length) {
      report.bbDetayList.forEach((bb, i) => {
        const baslik = bb.baslik || `${i+1}. BB`;
        const t = bb?.bbDetay?.tamMetin || bb?.bbDetay?.metin || "";
        if (t && String(t).trim()) bbText += `${baslik}\n${trDuzelt(t)}\n\n`;
      });
    } else {
      bbText = trDuzelt(report.bbDetay?.tamMetin || report.bbDetay?.metin || "");
    }
    document.getElementById('bbMetin').textContent = bbText || "Veri girilmedi.";

    document.getElementById('konumMetin').textContent =
      trDuzelt(report.konumCevre?.tamMetin || report.konumCevre?.metin || "Veri girilmedi.");

    document.getElementById('tapuMetinB1').textContent = trDuzelt(report.tapuMetniB1 || "Veri girilmedi.");
    document.getElementById('tapuMetinB2').textContent = trDuzelt(report.tapuMetniB2 || "Veri girilmedi.");

    document.getElementById('emsalMetin').textContent = emsalMetniBul(report);
  }

  // =========================
  // Wallet UI (gizli / tƒ±kla a√ß)
  // =========================
  function setWalletBar(summaryText, detailsHtml){
    const bar = document.getElementById("walletBar");
    const det = document.getElementById("walletDetails");
    bar.firstChild.textContent = summaryText;
    det.innerHTML = detailsHtml || "";
  }

  function attachWalletToggle(){
    const bar = document.getElementById("walletBar");
    const det = document.getElementById("walletDetails");
    bar.addEventListener("click", () => {
      det.style.display = (det.style.display === "block") ? "none" : "block";
    });
  }

  async function loadWalletUI(user){
    // Default (wallet yoksa)
    if (!window.Wallet) {
      setWalletBar("C√ºzdan: Mod√ºl bulunamadƒ±.", `<small>wallet.js y√ºklenmedi.</small>`);
      return;
    }
    try{
      const w = await Wallet.load(user.uid);
      // Wallet.load kendi i√ßinde nasƒ±l d√∂n√ºyor bilmiyorum; g√ºvenli g√∂sterim yapƒ±yorum:
      const balance = (w && (w.balance ?? w.bakiye ?? w.tl ?? "")) || "";
      const free = (w && (w.freeReports ?? w.free ?? w.free_left ?? "")) || "";
      const summary = `C√ºzdan: gizli (tƒ±kla a√ß)`;
      const details =
        `<div><b>Bakiye:</b> ${balance !== "" ? balance : "?"}</div>
         <div><b>√úcretsiz Hak:</b> ${free !== "" ? free : "?"}</div>
         <small>Not: Detaylar sadece tƒ±klayƒ±nca g√∂r√ºn√ºr.</small>`;
      setWalletBar(summary, details);
    }catch(e){
      setWalletBar("C√ºzdan: okunamadƒ± (tƒ±kla a√ß)", `<small>${(e && e.message) ? e.message : "Bilinmeyen hata"}</small>`);
    }
  }

  // =========================
  // WARNING button
  // =========================
  function showPreWarning(){
    alert(
      "‚ö†Ô∏è √ñNEMLƒ∞ UYARI\n\n" +
      "Rapor olu≈üturma i≈ülemi sonrasƒ± veri giri≈üi kilitlenebilir.\n" +
      "Zaman ve para kaybƒ± olmamasƒ± i√ßin l√ºtfen t√ºm mod√ºlleri tekrar kontrol ediniz.\n\n" +
      "Eminseniz rapor men√ºs√ºnden 'Tam Rapor Olu≈ütur' ile devam edin."
    );
  }

  // =========================
  // LOCK after create (only if confirmed)
  // =========================
  async function lockIfNeeded(user, arr, i, report){
    // zaten kilitliyse
    if (report.isLocked === true) return;

    // onay yoksa: sadece uyarƒ± ver, geri d√∂n
    if (!confirmed) {
      showPreWarning();
      window.location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
      return;
    }

    // onay varsa: sadece kilitle (burada √úCRET D√ú≈ûMEYƒ∞ ≈üimdilik kaldƒ±rdƒ±k)
    report.isLocked = true;
    report.lockedAt = new Date().toISOString();
    report.lockedBy = user.uid;

    persist(arr, i, report);

    // buluta yaz
    try{
      await db.collection("users").doc(user.uid).set({
        gayrimenkul_reports: arr,
        lastUpdate: new Date().toISOString()
      }, { merge: true });
    }catch(e){
      // cloud patlarsa sorun deƒüil, local kilit var
    }
  }

  // =========================
  // Back button
  // =========================
  document.getElementById('btnBack').onclick = () => {
    if (rid) window.location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
    else if (legacyId !== null) window.location.href = "rapor-detay.html?id=" + encodeURIComponent(legacyId);
    else window.location.href = "rapor-detay.html";
  };

  document.getElementById("btnWarn").onclick = showPreWarning;

  // =========================
  // Boot
  // =========================
  auth.onAuthStateChanged(async (user) => {
    const { arr, i, r } = getLatestData();

    if (!user || !rid || !r || i < 0) {
      window.location.href = "index.html";
      return;
    }

    // Wallet UI
    attachWalletToggle();
    await loadWalletUI(user);

    // Raporu bas
    raporOlustur(r);

    // Kilit (sadece confirm=1 ile gelince)
    await lockIfNeeded(user, arr, i, r);

    // Lock badge
    document.getElementById("lockBadge").textContent = (r.isLocked ? "üîí Kilitlendi" : "üîì Taslak");
  });
</script>

</body>
</html>

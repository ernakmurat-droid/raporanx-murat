<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Gayrimenkul Değerleme Raporu</title>

<!-- FİREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
<script src="wallet.js"></script>

<style>
body{font-family:'Segoe UI',sans-serif;background:#f4f7f9;margin:0;color:#333;}
.header{background:#1a237e;color:#fff;padding:25px 20px;text-align:center;position:relative;}
.back{position:absolute;left:20px;top:20px;background:#fff2;border:none;padding:6px 14px;color:#fff;border-radius:20px;cursor:pointer;}
.container{max-width:1200px;margin:30px auto;background:#fff;padding:40px;border-radius:8px;box-shadow:0 0 15px #0001;}
.section{margin-bottom:40px;}
.section h2{border-bottom:2px solid #eee;padding-bottom:10px;color:#1a237e;}
.text-block{white-space:pre-wrap;font-size:15px;line-height:1.6;}
.warning{background:#fff8e1;border-left:4px solid #ffc107;padding:10px;margin:8px 0;}
.print-btn{background:#27ae60;color:#fff;padding:14px 25px;border:none;border-radius:6px;cursor:pointer;}
.print-btn:hover{background:#1e874e;}
</style>
</head>
<body>

<div class="header">
 <button class="back" onclick="window.location.href='index.html'">← Geri</button>
 <h1>Gayrimenkul Değerleme Raporu</h1>
 <div id="raporTarih"></div>
</div>

<div class="container">

<div class="section">
 <h2>1. Genel Bilgiler</h2>
 <div id="genelBilgi"></div>
</div>

<div class="section">
 <h2>2. İmar Durumu</h2>
 <div id="imarTablo"></div>
 <div class="text-block" id="imarMetin"></div>
</div>

<div class="section">
 <h2>3. Belgeler</h2>
 <div class="text-block" id="belgelerMetin"></div>
</div>

<div class="section">
 <h2>4. Ana Bina Bilgileri</h2>
 <div class="text-block" id="binaMetin"></div>
</div>

<div class="section">
 <h2>5. Bağımsız Bölüm Bilgileri</h2>
 <div class="text-block" id="bbMetin"></div>
</div>

<div class="section">
 <h2>6. Konum Analizi</h2>
 <div class="text-block" id="konumMetin"></div>
</div>

<div class="section">
 <h2>7. Tapu Bilgileri</h2>
 <div class="text-block" id="tapuMetinB1"></div>
 <div class="text-block" id="tapuMetinB2"></div>
</div>

<div class="section">
 <h2>8. Emsal / Değerleme</h2>
 <div class="text-block" id="emsalMetin"></div>
</div>

<button class="print-btn" onclick="window.print()">Yazdır / PDF Kaydet</button>

</div>

<script>
document.addEventListener("DOMContentLoaded",async()=>{
 const auth=firebase.auth();
 const urlParams=new URLSearchParams(window.location.search);
 const rid=urlParams.get("rid")||urlParams.get("id");
 if(!rid){alert("Rapor bulunamadı");return;}

 // ---------- VERİ OKUMA ----------
 const allReports=JSON.parse(localStorage.getItem("gayrimenkul_reports")||"[]");
 const report=allReports.find(r=>r.rid===rid);
 if(!report){alert("Rapor verisi bulunamadı");return;}

 // ---------- GENEL METİN DÜZENLEYİCİ ----------
 const formatMetin=(t)=>(t||"").toString()
   .replace(/\s+\n/g,"\n")
   .replace(/\n{3,}/g,"\n\n")
   .replace(/\s{2,}/g," ")
   .trim();

 // ---------- BB METİNLERİ ----------
 const bbYazdir=(list)=>{
   if(!list||!list.length)return "Bağımsız bölüm bilgisi yok";
   return list.map((bb,i)=>`(${i+1}) ${bb.baslik||"Bağımsız Bölüm"}:\n${formatMetin(bb.bbDetay?.tamMetin||bb.bbDetay?.metin)}`).join("\n\n");
 };

 // ---------- EMSAL METNİ (TEKRAR ÖNLEYİCİ) ----------
 const emsalMetniOlustur=(r)=>{
   if(r?.emsalFinalMetni)return formatMetin(r.emsalFinalMetni);
   if(r?.degerlemeOzet?.emsalFinalMetni)return formatMetin(r.degerlemeOzet.emsalFinalMetni);
   if(r.bbDetayList?.length){
     const tekil=new Set();
     const arr=r.bbDetayList.map(bb=>{
       const m=bb.degerlemeOzet?.emsalFinalMetni;
       if(!m||tekil.has(m))return null;
       tekil.add(m);
       return formatMetin(m);
     }).filter(Boolean);
     return arr.length?arr.join("\n\n"):"Değerleme metni yok";
   }
   return "Emsal verisi bulunamadı";
 };

 // ---------- RAPOR EKRANA BAS ----------
 document.getElementById("raporTarih").textContent="Tarih: "+new Date().toLocaleDateString("tr-TR");
 document.getElementById("genelBilgi").innerHTML=`
  <div><strong>İl / İlçe:</strong> ${report.il||"-"} / ${report.ilce||"-"}</div>
  <div><strong>Ada / Parsel:</strong> ${report.ada||"-"} / ${report.parsel||"-"}</div>
  <div><strong>Taşınmaz:</strong> ${report.propertyName||"Tanımsız"}</div>
 `;
 document.getElementById("imarTablo").innerHTML=report.imarTablo||"<div class='warning'>İmar tablosu yok</div>";
 document.getElementById("imarMetin").textContent=formatMetin(report.imarMetni);
 document.getElementById("belgelerMetin").textContent=formatMetin(report.belgelerMetni);
 document.getElementById("binaMetin").textContent=formatMetin(report.bina?.metin);
 document.getElementById("bbMetin").textContent=bbYazdir(report.bbDetayList);
 document.getElementById("konumMetin").textContent=formatMetin(report.konumCevre?.tamMetin||report.konumCevre?.metin);
 document.getElementById("tapuMetinB1").textContent=formatMetin(report.tapuMetniB1);
 document.getElementById("tapuMetinB2").textContent=formatMetin(report.tapuMetniB2);
 document.getElementById("emsalMetin").textContent=emsalMetniOlustur(report);
});
</script>
</body>
</html>

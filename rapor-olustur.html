<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<title>Final Raporu Olu≈üturucu - Raporan X</title>

<style>
:root { --primary:#1a237e; --secondary:#3949ab; --bg:#f4f7f9; }
body { font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; color:#2c3e50; }
.header { background:linear-gradient(135deg,var(--primary),var(--secondary)); color:#fff; padding:30px 20px; text-align:center; position:relative; }
.back { position:absolute; left:20px; top:25px; background:rgba(255,255,255,.2); padding:8px 15px; border-radius:30px; color:#fff; border:none; cursor:pointer; font-weight:bold; }
.main { max-width:1100px; margin:30px auto; background:#fff; padding:40px; border-radius:12px; box-shadow:0 0 40px rgba(0,0,0,.05); }
.section { margin-bottom:45px; }
.section h2 { color:var(--primary); border-bottom:2px solid #eee; padding-bottom:8px; }
.text { white-space:pre-wrap; line-height:1.7; font-size:14.5px; text-align:justify; }
.print-btn { display:block; margin:40px auto 0; background:#27ae60; color:#fff; padding:15px 30px; font-size:18px; border:none; border-radius:50px; cursor:pointer; font-weight:bold; }

@media print {
  .header,.back,.print-btn { display:none; }
  body { background:#fff; }
  .main { box-shadow:none; padding:0; }
}
</style>
</head>

<body>

<div class="header">
  <button class="back" onclick="geriDon()">‚Üê Y√∂netim Paneli</button>
  <h1>GAYRƒ∞MENKUL DEƒûERLEME RAPORU</h1>
  <div id="raporTarih" style="opacity:.85;font-size:13px;"></div>
</div>

<div class="main">

  <div class="section">
    <h2>1. Genel Bilgiler</h2>
    <div id="genelBilgi"></div>
  </div>

  <div class="section">
    <h2>2. ƒ∞mar Durumu</h2>
    <div id="imarMetin" class="text"></div>
  </div>

  <div class="section">
    <h2>3. Bina Bilgileri</h2>
    <div id="binaMetin" class="text"></div>
  </div>

  <div class="section">
    <h2>4. Deƒüerleme ve Analiz</h2>
    <div id="emsalMetin" class="text"></div>
  </div>

  <button class="print-btn" onclick="window.print()">üìë RAPORU PDF OLARAK KAYDET</button>
</div>

<script>
/* ========= T√úRK√áE METƒ∞N TOPARLAMA ========= */
function duzeltTR(metin){
  if(!metin) return "";
  return metin
    .replace(/\s{2,}/g," ")
    .replace(/\s+\./g,".")
    .replace(/\s+,/g,",")
    .replace(/\.(\S)/g,". $1")
    .replace(/\bm2\b/gi,"m¬≤")
    .replace(/tl\b/gi,"TL")
    .replace(/\n\s*\n/g,"\n\n")
    .trim();
}

/* ========= RID OKUMA ========= */
const params = new URLSearchParams(location.search);
const rid = params.get("rid");

let reports = JSON.parse(localStorage.getItem("gayrimenkul_reports")) || [];
let report = reports.find(r => r && r.rid === rid);

/* ========= G√úVENLƒ∞K ========= */
auth.onAuthStateChanged(user=>{
  if(!user || !rid || !report){
    location.href="index.html";
    return;
  }
  raporuBas();
});

function raporuBas(){
  const today = new Date().toLocaleDateString("tr-TR",{day:"numeric",month:"long",year:"numeric"});
  document.getElementById("raporTarih").innerText = "Rapor Tarihi: " + today;

  document.getElementById("genelBilgi").innerHTML = `
    <p><b>Gayrimenkul:</b> ${report.propertyName || "-"}</p>
    <p><b>Konum:</b> ${report.il || "-"} / ${report.ilce || "-"}</p>
  `;

  document.getElementById("imarMetin").innerText =
    duzeltTR(report.imarMetni || "");

  document.getElementById("binaMetin").innerText =
    duzeltTR(report.bina?.metin || "");

  document.getElementById("emsalMetin").innerText =
    duzeltTR(report.degerlemeOzet?.emsalFinalMetni || "");
}

function geriDon(){
  location.href = "rapor-detay.html?rid=" + encodeURIComponent(rid);
}
</script>

</body>
</html>

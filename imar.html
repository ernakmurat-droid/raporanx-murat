<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <title>İmar Durumu - Raporan X</title>
    <style>
        :root { --primary: #3498db; --secondary: #2980b9; --success: #2ecc71; --bg: #f4f7f9; --danger: #d32f2f; }
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 0; background-color: var(--bg); color: #333; }
        .container { max-width: 700px; margin: 20px auto; background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); border-radius: 8px; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid var(--primary); margin-bottom: 20px; position: relative; }
        header h1 { color: var(--primary); margin: 0; font-size: 1.5em; }
        .header-info { font-size: 0.9em; color: #555; text-align: right; }
        .back-btn { position: absolute; left: 0; top: 0; background: var(--danger); color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; cursor: pointer; border: none; }
        
        .form-section { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .form-section label { display: block; font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #444; }
        .radio-group { display: flex; flex-wrap: wrap; gap: 15px; }
        
        input[type="text"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; }
        #diğer-nizam-kutusu, #diğer-lejant-kutusu, #yola-tecavüz-alan-kutusu { margin-left: 10px; display: none; }
        .hmax-bilgi { margin-left: 10px; font-size: 0.85em; color: #e74c3c; font-weight: bold; }

        #otomatik-metin-alani { margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee; user-select: none; }
        .mavi-kutu { background-color: #eaf6ff; border: 1px solid #3498db; padding: 15px; margin-bottom: 15px; border-radius: 8px; transition: filter 0.3s; }
        .yesil-kutu { background-color: #ebf5eb; border: 1px solid #2ecc71; padding: 15px; border-radius: 8px; transition: filter 0.3s; }
        .mavi-kutu:not(:hover), .yesil-kutu:not(:hover) { filter: blur(1.5px); }

        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9em; background: white; }
        table, th, td { border: 1px solid #3498db; }
        th, td { padding: 10px; text-align: left; }
        
        .action-button { padding: 12px; font-size: 1em; border: none; border-radius: 8px; cursor: pointer; width: 100%; transition: 0.3s; font-weight: bold; }
        #kaydet-button { background-color: var(--success); color: white; margin-top: 20px; }
        .btn-menu { background-color: #9c27b0; color: white; margin-top: 10px; }
    </style>
</head>
<body oncontextmenu="return false;"> 
    <div class="container">
        <header>
            <button onclick="anaMenuyeDon()" class="back-btn">← ANA MENÜ</button>
            <h1>İMAR DURUMU</h1>
            <div id="raporBilgi" class="header-info">Yükleniyor...</div>
        </header>

        <form id="imar-form">
            <div class="form-section">
                <label>İmar Planı İsmi</label>
                <input type="text" id="imar-plani-ismi" placeholder="Örn: 1/1000 Ölçekli Uygulama İmar Planı" list="h_imarPlaniIsmi">
            </div>
            <div class="form-section">
                <label>İmar Planı Tarihi</label>
                <input type="text" id="imar-plani-tarihi" placeholder="Örn: 15.05.2018" list="h_imarPlaniTarihi">
            </div>

            <div class="form-section">
                <label>1. Yapı Nizamı:</label>
                <div class="radio-group" id="yapi-nizam-group">
                    <div><input type="radio" name="nizam" value="Ayrık" id="nizam-ayrik"><label for="nizam-ayrik">Ayrık</label></div>
                    <div><input type="radio" name="nizam" value="Bitişik" id="nizam-bitisik"><label for="nizam-bitisik">Bitişik</label></div>
                    <div><input type="radio" name="nizam" value="Blok" id="nizam-blok"><label for="nizam-blok">Blok</label></div>
                    <div><input type="radio" name="nizam" value="Diğer" id="nizam-diger"><label for="nizam-diger">Diğer</label></div>
                    <input type="text" id="diğer-nizam-kutusu" placeholder="Belirtiniz">
                </div>
            </div>

            <div class="form-section">
                <label for="kat-sayisi">2. Kat Sayısı:</label>
                <input type="number" id="kat-sayisi" value="5">
                <span id="hmax-output" class="hmax-bilgi"></span>
            </div>

            <div class="form-section">
                <label>3. Lejant:</label>
                <div class="radio-group" id="lejant-group">
                    <div><input type="radio" name="lejant" value="Konut Alanı" id="lejant-konut" checked><label for="lejant-konut">Konut Alanı</label></div>
                    <div><input type="radio" name="lejant" value="Ticaret Alanı" id="lejant-ticaret"><label for="lejant-ticaret">Ticaret Alanı</label></div>
                    <div><input type="radio" name="lejant" value="Diğer" id="lejant-diger"><label for="lejant-diger">Diğer</label></div>
                    <input type="text" id="diğer-lejant-kutusu" placeholder="Belirtiniz">
                </div>
            </div>

            <div class="form-section">
                <label for="taks">4. TAKS / 5. KAKS:</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="taks" placeholder="TAKS (0.40)" list="h_taks">
                    <input type="text" id="kaks" placeholder="KAKS (1.60)" list="h_kaks">
                </div>
            </div>

            <div class="form-section">
                <label for="yola-terk">6. Yola Terk (m²):</label>
                <input type="number" id="yola-terk" value="0">
                <div id="tecavuz-sorusu" style="display: none; margin-top: 10px;">
                    <label>Stratejik Kontrol: Yola Tecavüz Var mı?</label>
                    <input type="radio" name="tecavuz" value="Evet"> Evet 
                    <input type="radio" name="tecavuz" value="Hayır" checked> Hayır
                    <input type="number" id="yola-tecavüz-alan-kutusu" placeholder="Tecavüz m²" style="margin-top:5px">
                </div>
            </div>

            <button type="button" id="kaydet-button" class="action-button">VERİLERİ KAYDET VE BULUTA MÜHÜRLE</button>
            <button type="button" class="action-button btn-menu" onclick="anaMenuyeDon()">GERİ DÖN</button>
        </form>

        <div id="otomatik-metin-alani" style="display: none;">
            <div class="mavi-kutu">
                <h4>Banka Özet Tablosu</h4>
                <table id="banka-tablo-output"></table>
            </div>
            <div class="yesil-kutu">
                <h4>Oluşturulan Taslak Metin</h4>
                <p id="rapor-metni-output"></p>
            </div>
        </div>
    </div>

    <datalist id="h_imarPlaniIsmi"></datalist>
    <datalist id="h_imarPlaniTarihi"></datalist>
    <datalist id="h_taks"></datalist>
    <datalist id="h_kaks"></datalist>

    <script>
        // 2. ADIM: GÜVENLİK VE ID YÖNETİMİ
        const urlParams = new URLSearchParams(window.location.search);
        const raporId = urlParams.get('id');
        let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
        let currentReport = reports[raporId];

        auth.onAuthStateChanged((user) => {
            if (!user || !raporId || !currentReport) {
                window.location.href = 'index.html';
            } else {
                verileriYukle();
            }
        });

        // Sayfa Fonksiyonları
        function hmaxHesapla() {
            const kat = parseFloat(document.getElementById('kat-sayisi').value);
            if (!isNaN(kat)) document.getElementById('hmax-output').textContent = `(Hmax ≈ ${(kat * 3 + 0.5).toFixed(1)} m)`;
        }

        function tecavuzSorusuGoster() {
            const terk = parseFloat(document.getElementById('yola-terk').value);
            document.getElementById('tecavuz-sorusu').style.display = terk > 0 ? 'block' : 'none';
        }

        function otomatikMetinOlustur() {
            const nizam = document.querySelector('input[name="nizam"]:checked')?.value || "...";
            const kat = document.getElementById('kat-sayisi').value;
            const lejant = document.querySelector('input[name="lejant"]:checked')?.value || "...";
            const taks = document.getElementById('taks').value;
            const kaks = document.getElementById('kaks').value;

            const raporMetni = `${currentReport.ilce || 'İlgili'} Belediyesi imar planı sınırları içerisinde, ${nizam} nizam, ${kat} kat, ${lejant} lejantlı, Taks: ${taks} ve Kaks: ${kaks} yapılaşma şartlarına haizdir.`;
            
            document.getElementById('rapor-metni-output').textContent = raporMetni;
            document.getElementById('otomatik-metin-alani').style.display = 'block';
            
            // Tabloyu doldur
            document.getElementById('banka-tablo-output').innerHTML = `<tr><td>Nizam/Kat</td><td>${nizam} / ${kat} Kat</td></tr><tr><td>Taks/Kaks</td><td>${taks} / ${kaks}</td></tr>`;
            
            return raporMetni;
        }

        function verileriYukle() {
            document.getElementById('raporBilgi').textContent = (currentReport.propertyName || "Rapor") + " • İmar Analizi";
            const i = currentReport.imar;
            if (i) {
                document.getElementById('imar-plani-ismi').value = i.imarPlaniIsmi || "";
                document.getElementById('kat-sayisi').value = i.kat || "5";
                document.getElementById('taks').value = i.taks || "";
                document.getElementById('kaks').value = i.kaks || "";
                document.getElementById('yola-terk').value = i.terk || "0";
                hmaxHesapla();
                tecavuzSorusuGoster();
                otomatikMetinOlustur();
            }
        }

        async function kaydet() {
            const metin = otomatikMetinOlustur();
            currentReport.imar = {
                imarPlaniIsmi: document.getElementById('imar-plani-ismi').value,
                kat: document.getElementById('kat-sayisi').value,
                taks: document.getElementById('taks').value,
                kaks: document.getElementById('kaks').value,
                terk: document.getElementById('yola-terk').value,
                nizam: document.querySelector('input[name="nizam"]:checked')?.value
            };
            currentReport.imarMetni = metin;
            reports[raporId] = currentReport;
            localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

            // 3. ADIM: BULUT SENKRONİZASYONU
            const user = auth.currentUser;
            if (user) {
                try {
                    await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: reports }, { merge: true });
                    alert("✅ İmar verileri hem cihaza hem buluta mühürlendi!");
                } catch (e) {
                    alert("⚠️ Yerel kaydedildi ancak bulut hatası oluştu.");
                }
            }
        }

        function anaMenuyeDon() { window.location.href = `rapor-detay.html?id=${raporId}`; }

        document.getElementById('kat-sayisi').addEventListener('input', hmaxHesapla);
        document.getElementById('yola-terk').addEventListener('input', tecavuzSorusuGoster);
        document.getElementById('kaydet-button').addEventListener('click', kaydet);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

<script>
    // 1. ADIM: Proje Yapılandırması
    const firebaseConfig = {
        apiKey: "AIzaSyCMwx6S6rq1lnNJuHOxc38ij3qU4ankSxs",
        authDomain: "raporanx.firebaseapp.com",
        projectId: "raporanx",
        storageBucket: "raporanx.firebasestorage.app",
        messagingSenderId: "715194328346",
        appId: "1:715194328346:web:46f0bb98941e01ead6f8a3",
        measurementId: "G-V749P1HB80"
    };

    // Firebase'i Başlat (Eğer daha önce başlatılmadıysa)
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2. ADIM: MODÜL MUHAFIZI (Giriş ve Rapor ID Kontrolü)
    auth.onAuthStateChanged((user) => {
        const urlParams = new URLSearchParams(window.location.search);
        const reportId = urlParams.get('id');

        // Giriş yapılmamışsa index'e at
        if (!user) {
            alert("⚠️ Ekiş yetkisi yok! Lütfen giriş yapın.");
            window.location.href = 'index.html';
            return;
        }

        // Rapor seçilmeden modüle girilmeye çalışılırsa index'e at
        if (!reportId && window.location.pathname.split("/").pop() !== 'index.html') {
            alert("⚠️ İşlem yapılacak rapor seçilmedi!");
            window.location.href = 'index.html';
            return;
        }
        
        console.log("Yetki Onaylandı: " + user.email);
    });
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>İMAR DURUMU</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f9; }
    .container { max-width: 700px; margin: 20px auto; background: #fff; padding: 20px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); }
    header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 10px; border-bottom: 2px solid #3498db; margin-bottom: 20px; position: relative; }
    header h1 { color: #3498db; margin: 0; font-size: 1.5em; }
    .header-info { font-size: 0.9em; color: #555; text-align: right; }
    .back-btn { position: absolute; left: 0; top: 0; background: #d32f2f; color: white; padding: 10px 15px; border-radius: 8px; text-decoration: none; font-weight: bold; cursor: pointer; border: none; }
    .form-section { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
    .form-section label { display: block; font-weight: bold; margin-top: 10px; margin-bottom: 5px; }
    .radio-group { display: flex; flex-wrap: wrap; gap: 15px; }
    input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
    #diğer-nizam-kutusu, #diğer-lejant-kutusu, #yola-tecavüz-alan-kutusu { margin-left: 10px; display: none; }
    .hmax-bilgi { margin-left: 20px; font-size: 0.9em; color: #e74c3c; font-weight: bold; }
    #otomatik-metin-alani { margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; }
    .mavi-kutu { background-color: #eaf6ff; border: 1px solid #3498db; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
    .yesil-kutu { background-color: #ebf5eb; border: 1px solid #2ecc71; padding: 15px; border-radius: 5px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9em; }
    table, th, td { border: 1px solid #3498db; }
    th, td { padding: 8px; text-align: left; }
    .action-button { padding: 15px 20px; font-size: 1.1em; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px; display: block; width: 100%; transition: 0.3s; font-weight: bold; }
    #kaydet-button { background-color: #2ecc71; color: white; }
    .btn-menu { background-color: #9c27b0; color: white; }
    .status-msg { display: none; text-align: center; font-weight: bold; margin-top: 10px; padding: 10px; border-radius: 8px; }
</style>
</head>
<body oncontextmenu="return false;">
    <div class="container">
        <header>
            <button onclick="anaMenuyeDon()" class="back-btn">← ANA MENÜ</button>
            <h1>İMAR DURUMU</h1>
            <div id="raporBilgi" class="header-info">Yükleniyor...</div>
        </header>

        <form id="imar-form">
            <div class="form-section">
                <label>İmar Planı İsmi</label>
                <input type="text" id="imar-plani-ismi" placeholder="Örn: 1/1000 Ölçekli Uygulama İmar Planı" oninput="guncelle()">
            </div>
            
            <div class="form-section">
                <label>1. Yapı Nizamı:</label>
                <div class="radio-group" id="yapi-nizam-group">
                    <div><input type="radio" name="nizam" value="Ayrık" id="nizam-ayrik" onchange="guncelle()"><label for="nizam-ayrik">Ayrık</label></div>
                    <div><input type="radio" name="nizam" value="Bitişik" id="nizam-bitisik" onchange="guncelle()"><label for="nizam-bitisik">Bitişik</label></div>
                    <div><input type="radio" name="nizam" value="Blok" id="nizam-blok" onchange="guncelle()"><label for="nizam-blok">Blok</label></div>
                    <div><input type="radio" name="nizam" value="Serbest" id="nizam-serbest" onchange="guncelle()"><label for="nizam-serbest">Serbest</label></div>
                    <div><input type="radio" name="nizam" value="Diğer" id="nizam-diger" onchange="guncelle()"><label for="nizam-diger">Diğer</label></div>
                    <input type="text" id="diğer-nizam-kutusu" placeholder="Belirtiniz" oninput="guncelle()">
                </div>
            </div>

            <div class="form-section">
                <label for="kat-sayisi">2. Kat Sayısı:</label>
                <input type="number" id="kat-sayisi" min="1" oninput="hmaxHesapla(); guncelle();">
                <span id="hmax-output" class="hmax-bilgi"></span>
            </div>

            <div class="form-section">
                <label for="taks">4. TAKS / 5. KAKS:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="taks" placeholder="TAKS (Örn: 0.40)" oninput="guncelle()">
                    <input type="text" id="kaks" placeholder="KAKS (Örn: 1.60)" oninput="guncelle()">
                </div>
            </div>

            <div class="form-section">
                <label for="yola-terk">6. Yola Terk (m²):</label>
                <input type="number" id="yola-terk" min="0" value="0" oninput="guncelle()">
            </div>

            <button type="button" id="kaydet-button" class="action-button" onclick="kaydet()">VERİLERİ KAYDET VE BULUTA YEDEKLE</button>
            <div id="statusBox" class="status-msg"></div>
            <button type="button" class="action-button btn-menu" onclick="anaMenuyeDon()">ANA MENÜYE DÖN</button>
        </form>

        <div id="otomatik-metin-alani">
            <div class="mavi-kutu">
                <h4>Özet Tablo (Banka İçin)</h4>
                <table id="banka-tablo-output"></table>
            </div>
            <div class="yesil-kutu">
                <h4>Tam Rapor Metni</h4>
                <p id="rapor-metni-output"></p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // 1. Senin Gerçek Firebase Anahtarların Mühürlendi
        const firebaseConfig = {
            apiKey: "AIzaSyCMwx6S6rq1lnNJuHOxc38ij3qU4ankSxs",
            authDomain: "raporanx.firebaseapp.com",
            projectId: "raporanx",
            storageBucket: "raporanx.firebasestorage.app",
            messagingSenderId: "715194328346",
            appId: "1:715194328346:web:46f0bb98941e01ead6f8a3",
            measurementId: "G-V749P1HB80"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
        let report = reports[id] || { imar: {} };

        async function bulutaSyncEt() {
            const user = auth.currentUser;
            if (user) {
                const tumRaporlar = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
                await db.collection("users").doc(user.uid).set({
                    gayrimenkul_reports: tumRaporlar,
                    sonGuncelleme: new Date().toISOString()
                }, { merge: true });
                console.log("İmar verileri buluta mühürlendi ☁️✅");
            }
        }

        function hmaxHesapla() {
            const kat = parseFloat(document.getElementById('kat-sayisi').value);
            if (!isNaN(kat) && kat > 0) {
                const hmax = (kat * 3 + 0.5).toFixed(1);
                document.getElementById('hmax-output').textContent = `(Hmax: ${hmax} m)`;
            }
        }

        function guncelle() {
            const planIsmi = document.getElementById('imar-plani-ismi').value || '...';
            const nizamRadio = document.querySelector('input[name="nizam"]:checked');
            const nizam = nizamRadio ? nizamRadio.value : "...";
            const kat = document.getElementById('kat-sayisi').value || "...";
            const taks = document.getElementById('taks').value || "...";
            const kaks = document.getElementById('kaks').value || "...";
            const terk = document.getElementById('yola-terk').value || 0;

            let tabloHTML = `
                <tr><td><b>PLANA ESAS İSİM</b></td><td>${planIsmi}</td></tr>
                <tr><td><b>YAPI NİZAMI</b></td><td>${nizam}</td></tr>
                <tr><td><b>KAT ADEDİ</b></td><td>${kat} Kat</td></tr>
                <tr><td><b>TAKS / KAKS</b></td><td>${taks} / ${kaks}</td></tr>
                <tr><td><b>YOLA TERK</b></td><td>${terk} m²</td></tr>
            `;
            document.getElementById('banka-tablo-output').innerHTML = tabloHTML;

            let raporMetni = `${planIsmi} kapsamında, ${nizam} nizam, ${kat} kat yapılaşma koşullarına sahip olup TAKS: ${taks} ve KAKS: ${kaks} olarak belirlenmiştir.`;
            document.getElementById('rapor-metni-output').textContent = raporMetni;

            return { metin: raporMetni, tablo: tabloHTML };
        }

        async function kaydet() {
            const data = guncelle();
            report.imar = {
                planIsmi: document.getElementById('imar-plani-ismi').value,
                nizam: document.querySelector('input[name="nizam"]:checked')?.value,
                kat: document.getElementById('kat-sayisi').value,
                taks: document.getElementById('taks').value,
                kaks: document.getElementById('kaks').value,
                terk: document.getElementById('yola-terk').value
            };
            report.imarMetni = data.metin;
            report.imarTablo = `<table>${data.tablo}</table>`;
            report.imar_tamamlandi = true;

            reports[id] = report;
            localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));
            await bulutaSyncEt();

            const box = document.getElementById('statusBox');
            box.style.display = 'block';
            box.style.backgroundColor = '#d1e7dd';
            box.textContent = "✅ İMAR BİLGİLERİ BULUTA YEDEKLENDİ";
            setTimeout(() => box.style.display = 'none', 3000);
        }

        function anaMenuyeDon() { window.location.href = `rapor-detay.html?id=${id}`; }

        window.onload = function() {
            document.getElementById('raporBilgi').textContent = report.propertyName || "Rapor Detayı";
            if(report.imar) {
                const i = report.imar;
                document.getElementById('imar-plani-ismi').value = i.planIsmi || "";
                document.getElementById('kat-sayisi').value = i.kat || "";
                document.getElementById('taks').value = i.taks || "";
                document.getElementById('kaks').value = i.kaks || "";
                document.getElementById('yola-terk').value = i.terk || 0;
            }
            guncelle();
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bina Bilgileri - RaporanX</title>

  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root{ --primary:#1a148c; --secondary:#7c4dff; --success:#00c853; --bg:#f4f7f6; }
    body{ font-family:'Segoe UI',Tahoma,sans-serif; background:var(--bg); margin:0; padding-bottom:110px; color:#333; }
    .header{
      background:linear-gradient(135deg,#4a148c,#7c4dff);
      color:#fff; padding:18px; text-align:center; position:sticky; top:0; z-index:50;
      box-shadow:0 2px 10px rgba(0,0,0,.2);
    }
    .back{
      position:absolute; left:12px; top:14px; background:rgba(255,255,255,.2);
      padding:10px 18px; border-radius:30px; color:#fff; border:none; cursor:pointer; font-weight:700;
    }
    .save{
      position:absolute; right:12px; top:14px; background:rgba(0,0,0,.25);
      padding:10px 18px; border-radius:30px; color:#fff; border:1px solid rgba(255,255,255,.25);
      cursor:pointer; font-weight:700;
    }
    .property-name{ margin-top:6px; font-weight:800; color:#ffd700; font-size:13px; }

    .container{ max-width:980px; margin:18px auto; padding:18px; background:#fff; border-radius:16px; box-shadow:0 4px 20px rgba(0,0,0,.08); }
    .card{ background:#fafafa; border:1px solid #eee; border-radius:14px; padding:16px; margin-bottom:14px; }
    .card h3{ margin:0 0 10px; font-size:18px; }
    label{ font-weight:700; display:block; margin:10px 0 6px; }
    input[type=text], input[type=number], textarea, select{
      width:100%; box-sizing:border-box; padding:12px; border:1px solid #ccc; border-radius:10px; font-size:15px;
      outline:none; transition:.2s;
    }
    input:focus, textarea:focus, select:focus{ border-color:var(--secondary); }
    textarea{ min-height:88px; resize:vertical; }

    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    @media (max-width: 820px){
      .row2,.row3{ grid-template-columns:1fr; }
    }

    .radio-group{ display:flex; gap:14px; flex-wrap:wrap; margin:6px 0 0; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #ddd; background:#fff; border-radius:999px; cursor:pointer; user-select:none; }
    .pill input{ transform:scale(1.15); }

    .btn-big{
      width:100%; background:var(--success); color:#fff; border:none; padding:18px;
      border-radius:14px; font-size:20px; font-weight:900; cursor:pointer; margin-top:14px;
      box-shadow:0 4px 15px rgba(0,200,83,.25);
    }
    .btn-gray{
      width:100%; background:#6c757d; color:#fff; border:none; padding:14px;
      border-radius:14px; font-size:16px; font-weight:800; cursor:pointer; margin-top:10px;
    }

    .taslak{
      margin-top:16px; background:#e8f5e9; border:3px solid #4caf50;
      border-radius:14px; padding:18px; white-space:pre-wrap; line-height:1.8; font-size:16px;
      -webkit-user-select:none; user-select:none; transition:filter .25s ease;
    }
    .taslak:not(:hover){ filter: blur(1.4px); }
  </style>
</head>

<body>
  <div class="header">
    <button class="back" onclick="anaMenuyeDon()">← Menü</button>
    <button class="save" onclick="kaydet(false)">Kaydet</button>
    <div style="font-size:20px; font-weight:900;">BİNA BİLGİLERİ</div>
    <div id="propertyName" class="property-name">Yükleniyor...</div>
  </div>

  <div class="container">

    <div class="card">
      <h3>1) Genel Bilgi</h3>
      <div class="row3">
        <div>
          <label>Bina Türü</label>
          <select id="binaTuru">
            <option value="">Seçiniz</option>
            <option>Apartman</option>
            <option>Site</option>
            <option>Plaza</option>
            <option>İş Merkezi</option>
            <option>Müstakil</option>
            <option>Diğer</option>
          </select>
        </div>
        <div>
          <label>Yapım Yılı</label>
          <input id="yapimYili" type="number" placeholder="Örn: 2012" />
        </div>
        <div>
          <label>Bina Yaşı (yaklaşık)</label>
          <input id="binaYasi" type="number" placeholder="Örn: 12" />
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Kat Adedi</label>
          <input id="katAdedi" type="number" placeholder="Örn: 10" />
        </div>
        <div>
          <label>Bodrum Var mı?</label>
          <select id="bodrum">
            <option value="">Seçiniz</option>
            <option>Var</option>
            <option>Yok</option>
            <option>Kısmen</option>
          </select>
        </div>
        <div>
          <label>Asansör</label>
          <select id="asansor">
            <option value="">Seçiniz</option>
            <option>Var</option>
            <option>Yok</option>
            <option>Kısmen</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card">
      <h3>2) Yapı Sistemi / Malzeme</h3>
      <div class="row3">
        <div>
          <label>Taşıyıcı Sistem</label>
          <select id="tasiyici">
            <option value="">Seçiniz</option>
            <option>Betonarme</option>
            <option>Çelik</option>
            <option>Kagir</option>
            <option>Ahşap</option>
            <option>Diğer</option>
          </select>
        </div>
        <div>
          <label>Dış Cephe</label>
          <select id="disCephe">
            <option value="">Seçiniz</option>
            <option>Boyalı</option>
            <option>Kaplama</option>
            <option>Yalıtım Mantolama</option>
            <option>Diğer</option>
          </select>
        </div>
        <div>
          <label>Çatı</label>
          <select id="cati">
            <option value="">Seçiniz</option>
            <option>Teras</option>
            <option>Eğimli</option>
            <option>Diğer</option>
          </select>
        </div>
      </div>

      <label>Yapı Malzemesi / Gözlem</label>
      <textarea id="yapiGozlem" placeholder="Dış cephe, merdiven, ortak alan, bakımlılık..."></textarea>
    </div>

    <div class="card">
      <h3>3) Ortak Alanlar / Donatılar</h3>
      <div class="row3">
        <div>
          <label>Otopark</label>
          <select id="otopark">
            <option value="">Seçiniz</option>
            <option>Açık</option>
            <option>Kapalı</option>
            <option>Açık + Kapalı</option>
            <option>Yok</option>
          </select>
        </div>
        <div>
          <label>Güvenlik</label>
          <select id="siteGuvenlik">
            <option value="">Seçiniz</option>
            <option>Var</option>
            <option>Yok</option>
            <option>Kısmen</option>
          </select>
        </div>
        <div>
          <label>Jeneratör</label>
          <select id="jenerator">
            <option value="">Seçiniz</option>
            <option>Var</option>
            <option>Yok</option>
            <option>Bilgi yok</option>
          </select>
        </div>
      </div>

      <div class="row3">
        <div>
          <label>Isıtma Sistemi (bina)</label>
          <select id="isitma">
            <option value="">Seçiniz</option>
            <option>Merkezi</option>
            <option>Ferdi (kombi)</option>
            <option>Klima</option>
            <option>Diğer</option>
          </select>
        </div>
        <div>
          <label>Doğalgaz</label>
          <select id="dogalgaz">
            <option value="">Seçiniz</option>
            <option>Var</option>
            <option>Yok</option>
            <option>Bilgi yok</option>
          </select>
        </div>
        <div>
          <label>Yönetim/Aidat</label>
          <select id="yonetim">
            <option value="">Seçiniz</option>
            <option>Site yönetimi var</option>
            <option>Apartman yönetimi</option>
            <option>Bilgi yok</option>
          </select>
        </div>
      </div>

      <label>Ortak alan / Donatı Detayı</label>
      <textarea id="ortakDetay" placeholder="Otopark, güvenlik, sosyal alanlar, havuz, spor salonu vb..."></textarea>
    </div>

    <div class="card">
      <h3>4) Deprem / Bakım Durumu</h3>
      <label>Bakımlılık</label>
      <select id="bakim">
        <option value="">Seçiniz</option>
        <option>İyi</option>
        <option>Orta</option>
        <option>Zayıf</option>
      </select>

      <label>Hasar/Olumsuzluk var mı?</label>
      <div class="radio-group">
        <label class="pill"><input type="radio" name="hasar" value="yok" checked> Yok</label>
        <label class="pill"><input type="radio" name="hasar" value="var"> Var</label>
      </div>

      <div id="hasarBox" style="display:none;">
        <label>Hasar/Olumsuzluk Açıklaması</label>
        <textarea id="hasarDetay" placeholder="Gözlenen çatlak, nem, dökülme, riskli durum vb..."></textarea>
      </div>
    </div>

    <button class="btn-big" onclick="kaydet(true)">KAYDET VE METİN ÜRET</button>
    <button class="btn-gray" onclick="anaMenuyeDon()">MENÜYE DÖN</button>

    <div id="taslak" class="taslak" style="display:none;" oncopy="return false"></div>
  </div>

<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  /* ========= RID + migration ========= */
  const urlParams = new URLSearchParams(window.location.search);
  let rid = urlParams.get('rid');
  const legacyId = urlParams.get('id');

  function genRid(){
    try{ if (crypto && crypto.randomUUID) return crypto.randomUUID(); }catch(e){}
    return "rid_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,10);
  }
  function ensureRidMigration(arr){
    let changed = false;
    (arr || []).forEach(r => { if (r && !r.rid) { r.rid = genRid(); changed = true; }});
    return changed;
  }
  function findIndexByRid(arr, rid){
    return (arr || []).findIndex(r => r && r.rid === rid);
  }

  let reports = JSON.parse(localStorage.getItem('gayrimenkul_reports')) || [];
  if (ensureRidMigration(reports)) localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

  if (!rid && legacyId !== null && legacyId !== "") {
    const idxLegacy = Number(legacyId);
    if (!Number.isNaN(idxLegacy) && reports[idxLegacy] && reports[idxLegacy].rid) {
      rid = reports[idxLegacy].rid;
      window.location.replace("bina.html?rid=" + encodeURIComponent(rid));
    }
  }

  const idx = rid ? findIndexByRid(reports, rid) : -1;
  let report = (idx >= 0) ? (reports[idx] || {}) : null;

  // Hasar kutusu toggle
  document.querySelectorAll('input[name="hasar"]').forEach(r => r.addEventListener('change', () => {
    document.getElementById('hasarBox').style.display =
      (document.querySelector('input[name="hasar"]:checked').value === 'var') ? 'block' : 'none';
  }));

  // Sağ tık engeli: sadece taslakta kalsın, inputlarda serbest
  document.addEventListener('contextmenu', (e) => {
    const isInput = e.target.closest('input, textarea, select');
    if (isInput) return;
    e.preventDefault();
  });

  auth.onAuthStateChanged((user) => {
    if (!user || !rid || !report) { window.location.href = 'index.html'; return; }
    document.getElementById('propertyName').textContent = report.propertyName || "İsimsiz";
    yukle();
  });

  function setVal(id, v){
    const el = document.getElementById(id);
    if (el) el.value = (v ?? "");
  }
  function val(id){ return (document.getElementById(id)?.value ?? "").toString().trim(); }
  function elVal(id){ return (document.getElementById(id)?.value ?? "").toString().trim(); }

  function yukle(){
    const b = report.bina || {};
    setVal('binaTuru', b.binaTuru ?? '');
    setVal('yapimYili', b.yapimYili ?? '');
    setVal('binaYasi', b.binaYasi ?? '');
    setVal('katAdedi', b.katAdedi ?? '');
    setVal('bodrum', b.bodrum ?? '');
    setVal('asansor', b.asansor ?? '');

    setVal('tasiyici', b.tasiyici ?? '');
    setVal('disCephe', b.disCephe ?? '');
    setVal('cati', b.cati ?? '');
    setVal('yapiGozlem', b.yapiGozlem ?? '');

    setVal('otopark', b.otopark ?? '');
    setVal('siteGuvenlik', b.siteGuvenlik ?? '');
    setVal('jenerator', b.jenerator ?? '');
    setVal('isitma', b.isitma ?? '');
    setVal('dogalgaz', b.dogalgaz ?? '');
    setVal('yonetim', b.yonetim ?? '');
    setVal('ortakDetay', b.ortakDetay ?? '');

    setVal('bakim', b.bakim ?? '');

    const hasar = b.hasar ?? 'yok';
    const hasarRadio = document.querySelector(`input[name="hasar"][value="${hasar}"]`);
    if (hasarRadio) hasarRadio.checked = true;
    document.getElementById('hasarBox').style.display = (hasar === 'var') ? 'block' : 'none';
    setVal('hasarDetay', b.hasarDetay ?? '');

    const metin = b.binaMetni || report.binaMetni;
    if (metin){
      document.getElementById('taslak').style.display = 'block';
      document.getElementById('taslak').innerText = metin;
    }
  }

  function buildMetin(){
    const binaTuru  = elVal('binaTuru');
    const yapimYili = val('yapimYili');
    const binaYasi  = val('binaYasi');
    const katAdedi  = val('katAdedi');
    const bodrum    = elVal('bodrum');
    const asansor   = elVal('asansor');

    const tasiyici  = elVal('tasiyici');
    const disCephe  = elVal('disCephe');
    const cati      = elVal('cati');
    const yapiGozlem= val('yapiGozlem');

    const otopark   = elVal('otopark');
    const siteGuvenlik = elVal('siteGuvenlik');
    const jenerator = elVal('jenerator');
    const isitma    = elVal('isitma');
    const dogalgaz  = elVal('dogalgaz');
    const yonetim   = elVal('yonetim');
    const ortakDetay= val('ortakDetay');

    const bakim     = elVal('bakim');
    const hasar     = document.querySelector('input[name="hasar"]:checked')?.value || 'yok';
    const hasarDetay= val('hasarDetay');

    let m = "";

    m += `Değerleme konusu taşınmazın bulunduğu yapı ${binaTuru || "..."} nitelikli olup `;
    if (yapimYili) m += `yapım yılı ${yapimYili} olarak beyan/tespit edilmiştir. `;
    else if (binaYasi) m += `yaklaşık bina yaşı ${binaYasi} yıl olarak değerlendirilmektedir. `;
    else m += `yaş bilgisi net olarak tespit edilememiştir. `;

    if (katAdedi) m += `Yapı ${katAdedi} katlıdır. `;
    if (bodrum) m += `Bodrum durumu: ${bodrum}. `;
    if (asansor) m += `Asansör: ${asansor}. `;

    m += `\n\nYapı sistemi açısından taşıyıcı sistem ${tasiyici || "..."} olup dış cephe ${disCephe || "..."} olarak gözlemlenmiştir. `;
    if (cati) m += `Çatı tipi ${cati.toLowerCase()} niteliktedir. `;
    if (yapiGozlem) m += `${yapiGozlem.trim()} `;

    m += `\n\nOrtak alan ve donatılar kapsamında; otopark durumu ${otopark || "..."}, güvenlik ${siteGuvenlik || "..."}, jeneratör ${jenerator || "..."}, ısıtma sistemi ${isitma || "..."} ve doğalgaz ${dogalgaz || "..."} şeklinde değerlendirilmiştir. `;
    if (yonetim) m += `Yönetim durumu: ${yonetim}. `;
    if (ortakDetay) m += `${ortakDetay.trim()} `;

    m += `\n\nBakım-bakımlılık durumu ${bakim || "..."} olarak değerlendirilmiştir. `;
    if (hasar === 'var') {
      m += `Yapıda olumsuzluk/hasar gözlemi bulunmaktadır. `;
      if (hasarDetay) m += `Açıklama: ${hasarDetay.trim()} `;
    } else {
      m += `Yapıda belirgin olumsuzluk/hasar gözlemi bulunmamaktadır. `;
    }

    return m.trim();
  }

  function collectBinaObj(metin){
    return {
      binaTuru: elVal('binaTuru'),
      yapimYili: val('yapimYili'),
      binaYasi: val('binaYasi'),
      katAdedi: val('katAdedi'),
      bodrum: elVal('bodrum'),
      asansor: elVal('asansor'),

      tasiyici: elVal('tasiyici'),
      disCephe: elVal('disCephe'),
      cati: elVal('cati'),
      yapiGozlem: val('yapiGozlem'),

      otopark: elVal('otopark'),
      siteGuvenlik: elVal('siteGuvenlik'),
      jenerator: elVal('jenerator'),
      isitma: elVal('isitma'),
      dogalgaz: elVal('dogalgaz'),
      yonetim: elVal('yonetim'),
      ortakDetay: val('ortakDetay'),

      bakim: elVal('bakim'),
      hasar: document.querySelector('input[name="hasar"]:checked')?.value || 'yok',
      hasarDetay: val('hasarDetay'),

      binaMetni: metin
    };
  }

  async function kaydet(showMetin){
    const metin = buildMetin();
    const binaObj = collectBinaObj(metin);

    reports[idx] = {
      ...reports[idx],
      bina: binaObj,
      binaMetni: metin // geriye dönük uyum
    };

    localStorage.setItem('gayrimenkul_reports', JSON.stringify(reports));

    // buluta gönder
    const user = auth.currentUser;
    if (user) {
      try{
        await db.collection("users").doc(user.uid).set({ gayrimenkul_reports: reports }, { merge: true });
      }catch(e){
        alert("Bulut hatası: " + e.message);
      }
    }

    if (showMetin){
      document.getElementById('taslak').style.display = 'block';
      document.getElementById('taslak').innerText = metin;
    } else {
      alert("✅ Kaydedildi!");
    }
  }

  function anaMenuyeDon(){
    window.location.href = `rapor-detay.html?rid=${encodeURIComponent(rid)}`;
  }
</script>
</body>
</html>
